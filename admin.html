<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gittertier Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    :root {
        --color-bg: #ffffff;
        --color-bg-secondary: #f9fafb;
        --color-text: #111111;
        --color-text-muted: #6b7280;
        --color-border: #e5e7eb;
        --color-accent: #2563eb;
        --color-accent-hover: #1d4ed8;
        --color-success: #16a34a;
        --color-error: #dc2626;
        --color-warning: #d97706;
        --color-info: #2563eb;
        --color-loyalty: #7e22ce;
        --color-delivery: #22c55e;
        --color-bagging: #f97316;
        --color-donation: #3b82f6;
        --color-premium: #c5a47e;
        --color-overlay: rgba(0, 0, 0, 0.5);
        
        --radius: 12px;
        --radius-sm: 6px;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.07), 0 1px 2px rgba(0, 0, 0, 0.04);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --focus-ring: 0 0 0 3px rgba(37, 99, 235, 0.35);
        
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;
        --spacing-xxl: 48px;
        
        --transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
        --transition-slow: all 0.3s cubic-bezier(0.2, 0, 0, 1);
        
        --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, "Helvetica Neue", Arial, sans-serif;
        --text-xs: 0.75rem;
        --text-sm: 0.875rem;
        --text-base: 1rem;
        --text-lg: 1.125rem;
        --text-xl: 1.25rem;
        --text-2xl: 1.5rem;
        --text-3xl: 1.875rem;
        
        --header-height: 64px;
        --sidebar-width: 280px;
        --sidebar-width-collapsed: 80px;
    }

    .dark-mode {
        --color-bg: #111827;
        --color-bg-secondary: #1f2937;
        --color-text: #f3f4f6;
        --color-text-muted: #9ca3af;
        --color-border: #374151;
        --color-accent: #3b82f6;
        --color-accent-hover: #2563eb;
        --color-success: #10b981;
        --color-error: #ef4444;
        --color-warning: #f59e0b;
        --color-info: #3b82f6;
        --color-loyalty: #a855f7;
        --color-delivery: #22c55e;
        --color-bagging: #fb923c;
        --color-donation: #60a5fa;
        --color-premium: #d6bc97;
        --color-overlay: rgba(0, 0, 0, 0.7);
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.3), 0 1px 2px rgba(0, 0, 0, 0.2);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: var(--font-family);
        background-color: var(--color-bg);
        color: var(--color-text);
        line-height: 1.5;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    /* Header Styles */
    .admin-header {
        height: var(--header-height);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 var(--spacing-lg);
        border-bottom: 1px solid var(--color-border);
        background-color: var(--color-bg);
        position: sticky;
        top: 0;
        z-index: 50;
    }

    .logo {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        font-weight: 700;
        font-size: var(--text-xl);
    }

    .logo i {
        font-size: var(--text-xl);
        color: var(--color-accent);
    }

    .header-controls {
        display: flex;
        gap: var(--spacing-md);
        align-items: center;
    }

    .time-display {
        background-color: var(--color-bg-secondary);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius);
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        display: none;
    }

    .logout-btn {
        background-color: transparent;
        color: var(--color-text);
        border: 0px solid var(--color-border);
        border-radius: var(--radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .logout-btn:hover {
        background-color: var(--color-bg-secondary);
    }

    .hamburger {
        display: block;
        background: transparent;
        border: none;
        font-size: var(--text-lg);
        color: var(--color-text);
        cursor: pointer;
        transition: var(--transition);
        width: 42px;
        height: 42px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .hamburger:hover {
        background-color: var(--color-bg-secondary);
    }

    /* Main layout */
    .admin-container {
        display: flex;
        flex: 1;
    }

    /* Sidebar */
    .admin-sidebar {
        width: var(--sidebar-width);
        background-color: var(--color-bg);
        border-right: 1px solid var(--color-border);
        height: calc(100vh - var(--header-height));
        position: fixed;
        top: var(--header-height);
        left: 0;
        overflow-y: auto;
        transition: transform 0.3s ease;
        z-index: 40;
        padding: var(--spacing-lg) 0;
    }

    .nav-container {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
        padding: 0 var(--spacing-md);
    }

    .nav-link {
        padding: var(--spacing-md);
        border-radius: var(--radius);
        text-decoration: none;
        color: var(--color-text);
        font-weight: 500;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    .nav-link:hover {
        background-color: var(--color-bg-secondary);
    }

    .nav-link.active {
        background-color: rgba(37, 99, 235, 0.1);
        color: var(--color-accent);
    }

    .nav-link i {
        width: 24px;
        text-align: center;
    }

    .nav-link.active i {
        color: var(--color-accent);
    }

    .new-feature {
        background-color: var(--color-success);
        color: white;
        font-size: var(--text-xs);
        padding: 2px 8px;
        border-radius: 10px;
        margin-left: auto;
    }

    /* Sidebar overlay for mobile */
    .sidebar-overlay {
        position: fixed;
        top: var(--header-height);
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--color-overlay);
        z-index: 35;
        display: none;
    }

    /* Main content */
    .admin-content {
        flex: 1;
        padding: var(--spacing-lg);
        margin-left: var(--sidebar-width);
        transition: margin-left 0.3s ease;
    }

    /* Welcome Header */
    .welcome-header {
        margin-bottom: var(--spacing-xl);
    }

    .welcome-title {
        font-size: var(--text-2xl);
        font-weight: 700;
        margin-bottom: var(--spacing-sm);
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    .welcome-subtitle {
        color: var(--color-text-muted);
        max-width: 600px;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .stat-card {
        background-color: var(--color-bg);
        border-radius: var(--radius);
        border: 1px solid var(--color-border);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow);
        transition: var(--transition);
    }

    .stat-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .stat-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
    }

    .stat-card-title {
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        font-weight: 500;
    }

    .stat-card-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-lg);
    }

    .stat-card-icon.revenue {
        background-color: rgba(37, 99, 235, 0.1);
        color: var(--color-accent);
    }

    .stat-card-icon.sales {
        background-color: rgba(22, 163, 74, 0.1);
        color: var(--color-success);
    }

    .stat-card-icon.customers {
        background-color: rgba(126, 34, 206, 0.1);
        color: var(--color-loyalty);
    }

    .stat-card-icon.avg-order {
        background-color: rgba(217, 119, 6, 0.1);
        color: var(--color-warning);
    }

    .stat-card-value {
        font-size: var(--text-2xl);
        font-weight: 700;
        margin-bottom: var(--spacing-xs);
    }

    .stat-card-change {
        font-size: var(--text-sm);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .stat-card-change.positive {
        color: var(--color-success);
    }

    .stat-card-change.negative {
        color: var(--color-error);
    }

    /* Charts Section */
    .charts-section {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    @media (max-width: 1024px) {
        .charts-section {
            grid-template-columns: 1fr;
        }
    }

    .chart-card {
        background-color: var(--color-bg);
        border-radius: var(--radius);
        border: 1px solid var(--color-border);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow);
    }

    .chart-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
    }

    .chart-card-title {
        font-size: var(--text-lg);
        font-weight: 600;
    }

    .chart-card-actions {
        display: flex;
        gap: var(--spacing-sm);
    }

    .chart-action-btn {
        background: transparent;
        border: 1px solid var(--color-border);
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: var(--transition);
        color: var(--color-text-muted);
    }

    .chart-action-btn:hover {
        background-color: var(--color-bg-secondary);
        color: var(--color-text);
    }

    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }

    /* Features Grid */
    .features-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .feature-card {
        background-color: var(--color-bg);
        border-radius: var(--radius);
        border: 1px solid var(--color-border);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow);
        transition: var(--transition);
    }

    .feature-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .feature-card-header {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
    }

    .feature-card-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-lg);
        background-color: rgba(37, 99, 235, 0.1);
        color: var(--color-accent);
    }

    .feature-card-title {
        font-size: var(--text-lg);
        font-weight: 600;
    }

    .feature-card-content {
        color: var(--color-text-muted);
        margin-bottom: var(--spacing-md);
        line-height: 1.6;
    }

    .feature-card-actions {
        display: flex;
        gap: var(--spacing-sm);
    }

    /* Action buttons */
    .action-btn {
        background-color: var(--color-bg);
        border: 1px solid var(--color-border);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .action-btn:hover {
        background-color: var(--color-bg-secondary);
    }

    .btn-primary {
        background-color: var(--color-accent);
        color: white;
    }

    .btn-primary:hover {
        background-color: var(--color-accent-hover);
    }

    .btn-success {
        background-color: var(--color-success);
        color: white;
    }

    .btn-success:hover {
        background-color: #0f9c5a;
    }

    .btn-danger {
        background-color: var(--color-error);
        color: white;
    }

    .btn-danger:hover {
        background-color: #c53030;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--color-overlay);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        display: none;
        padding: var(--spacing-md);
    }

    .modal-overlay.active {
        display: flex;
        animation: fadeIn 0.3s ease;
    }

    .modal {
        background-color: var(--color-bg);
        border-radius: var(--radius);
        padding: var(--spacing-xl);
        width: 100%;
        max-width: 600px;
        box-shadow: var(--shadow-lg);
        animation: scaleIn 0.3s ease;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
    }

    .modal-title {
        font-size: var(--text-xl);
        font-weight: 600;
    }

    .close-modal {
        background: transparent;
        border: none;
        font-size: var(--text-xl);
        color: var(--color-text);
        cursor: pointer;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: var(--transition);
    }

    .close-modal:hover {
        background-color: var(--color-bg-secondary);
    }

    /* Form Styles */
    .form-group {
        margin-bottom: var(--spacing-lg);
    }

    .form-label {
        display: block;
        margin-bottom: var(--spacing-sm);
        font-weight: 600;
    }

    .form-control {
        width: 100%;
        padding: var(--spacing-md);
        border: 1px solid var(--color-border);
        border-radius: var(--radius);
        font-size: var(--text-base);
        background-color: var(--color-bg);
        color: var(--color-text);
        transition: var(--transition);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: var(--focus-ring);
    }

    /* Goals Progress */
    .goals-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .goal-card {
        background-color: var(--color-bg);
        border-radius: var(--radius);
        border: 1px solid var(--color-border);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow);
    }

    .goal-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
    }

    .goal-card-title {
        font-size: var(--text-base);
        font-weight: 600;
    }

    .goal-card-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-sm);
        background-color: rgba(37, 99, 235, 0.1);
        color: var(--color-accent);
    }

    .goal-progress {
        height: 8px;
        background-color: var(--color-bg-secondary);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: var(--spacing-sm);
    }

    .goal-progress-bar {
        height: 100%;
        background-color: var(--color-success);
        transition: width 0.5s ease;
    }

    .goal-details {
        display: flex;
        justify-content: space-between;
        font-size: var(--text-sm);
        color: var(--color-text-muted);
    }

    /* Recent Activity */
    .activity-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
    }

    .activity-item {
        display: flex;
        gap: var(--spacing-md);
        padding: var(--spacing-md);
        border-radius: var(--radius);
        background-color: var(--color-bg-secondary);
        transition: var(--transition);
    }

    .activity-item:hover {
        background-color: var(--color-bg);
    }

    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-lg);
        flex-shrink: 0;
    }

    .activity-icon.success {
        background-color: rgba(22, 163, 74, 0.1);
        color: var(--color-success);
    }

    .activity-icon.warning {
        background-color: rgba(217, 119, 6, 0.1);
        color: var(--color-warning);
    }

    .activity-icon.info {
        background-color: rgba(37, 99, 235, 0.1);
        color: var(--color-info);
    }

    .activity-content {
        flex: 1;
    }

    .activity-title {
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
    }

    .activity-description {
        color: var(--color-text-muted);
        font-size: var(--text-sm);
    }

    .activity-time {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: var(--spacing-xl);
        color: var(--color-text-muted);
    }

    .empty-state i {
        font-size: var(--text-3xl);
        color: var(--color-accent);
        margin-bottom: var(--spacing-md);
        display: block;
    }

    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes scaleIn {
        from { transform: scale(0.95); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    @keyframes slideIn {
        from { transform: translateY(-10px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .admin-sidebar {
            transform: translateX(-100%);
        }
        
        .admin-sidebar.active {
            transform: translateX(0);
        }
        
        .admin-content {
            margin-left: 0;
        }
        
        .sidebar-overlay.active {
            display: block;
        }
    }

    @media (min-width: 768px) {
        .time-display {
            display: block;
        }
        
        .logout-btn span {
            display: inline;
        }
    }

    @media (max-width: 768px) {
        .admin-header {
            padding: 0 var(--spacing-md);
        }
        
        .admin-content {
            padding: var(--spacing-md);
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .charts-section {
            grid-template-columns: 1fr;
        }
        
        .features-grid {
            grid-template-columns: 1fr;
        }
        
        .goals-container {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 480px) {
        .chart-card-actions {
            flex-direction: column;
        }
        
        .feature-card-actions {
            flex-direction: column;
        }
    }

    /* Dark mode support for system preference */
    @media (prefers-color-scheme: dark) {
        :root {
            --color-bg: #111827;
            --color-bg-secondary: #1f2937;
            --color-text: #f3f4f6;
            --color-text-muted: #9ca3af;
            --color-border: #374151;
        }
    }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="logo">
            <button class="hamburger" id="hamburger">
                <i class="fas fa-bars"></i>
            </button>
            <i class="fas fa-shopping-cart"></i>
            <span>Dashboard</span>
        </div>
        <div class="header-controls">
            <div class="time-display" id="timeDisplay"></div>
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Abmelden</span>
            </button>
        </div>
    </div>

    <div class="admin-container">
        <aside class="admin-sidebar" id="sidebar">
            <div class="nav-container">
                <a href="control" class="nav-link">
                    <i class="fas fa-cogs"></i>
                    <span>Steuerung</span>
                    <span class="new-feature">NEU</span>
                </a>
                
                <a href="navi" class="nav-link">
                    <i class="fas fa-map-marked-alt"></i>
                    <span>Navigation</span>
                </a>
                
                <a href="admin" class="nav-link active">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                
                <a href="products" class="nav-link">
                    <i class="fas fa-box"></i>
                    <span>Produktverwaltung</span>
                </a>
                
                <a href="index" class="nav-link">
                    <i class="fas fa-cash-register"></i>
                    <span>Kassenansicht</span>
                </a>
                
                <a href="archive" class="nav-link">
                    <i class="fas fa-archive"></i>
                    <span>Archiv</span>
                </a>
                
                <a href="merchant" class="nav-link">
                    <i class="fas fa-store"></i>
                    <span>Händleransicht</span>
                </a>
                
                <a href="analytics" class="nav-link">
                    <i class="fas fa-chart-line"></i>
                    <span>Analysen</span>
                </a>
                
                <a href="settings" class="nav-link">
                    <i class="fas fa-cog"></i>
                    <span>Einstellungen</span>
                </a>
            </div>
        </aside>
        
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <main class="admin-content">
            <div class="welcome-header">
                <h1 class="welcome-title">
                    <i class="fas fa-tachometer-alt"></i>
                    <span id="welcome-message">Willkommen zurück!</span>
                </h1>
                <p class="welcome-subtitle">
                    Hier ist eine Übersicht Ihrer Geschäftsleistung basierend auf Ihren tatsächlichen Daten.
                </p>
            </div>

            <div class="stats-grid" id="stats-grid">
                <!-- Stats will be populated with real data -->
            </div>

            <div class="charts-section">
                <div class="chart-card">
                    <div class="chart-card-header">
                        <h3 class="chart-card-title">Umsatzentwicklung</h3>
                        <div class="chart-card-actions">
                            <button class="chart-action-btn active" data-chart="revenue" data-type="line">
                                <i class="fas fa-chart-line"></i>
                            </button>
                            <button class="chart-action-btn" data-chart="revenue" data-type="bar">
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="revenue-chart"></canvas>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-card-header">
                        <h3 class="chart-card-title">Verkaufsverteilung</h3>
                        <div class="chart-card-actions">
                            <button class="chart-action-btn active" data-chart="sales" data-type="doughnut">
                                <i class="fas fa-chart-pie"></i>
                            </button>
                            <button class="chart-action-btn" data-chart="sales" data-type="pie">
                                <i class="fas fa-chart-pie"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="sales-distribution-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="goals-container" id="goals-container">
                <!-- Goals will be populated with real data -->
            </div>

            <div class="features-grid" id="features-grid">
                <!-- Feature cards will be populated dynamically -->
            </div>

            <div class="chart-card">
                <div class="chart-card-header">
                    <h3 class="chart-card-title">Letzte Aktivitäten</h3>
                </div>
                <div class="activity-list" id="activity-list">
                    <!-- Activities will be populated with real data -->
                </div>
            </div>
        </main>
    </div>

    <!-- Monthly Goals Modal -->
    <div class="modal-overlay" id="goals-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Monatsziele verwalten</h2>
                <button class="close-modal" id="close-goals-modal">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="revenue-goal" class="form-label">Umsatzziel (€)</label>
                <input type="number" id="revenue-goal" class="form-control" min="0" step="100">
            </div>
            
            <div class="form-group">
                <label for="customers-goal" class="form-label">Ziel für neue Kunden</label>
                <input type="number" id="customers-goal" class="form-control" min="0" step="10">
            </div>
            
            <div class="form-group">
                <label for="reviews-goal" class="form-label">Ziel für Produktbewertungen</label>
                <input type="number" id="reviews-goal" class="form-control" min="0" step="10">
            </div>
            
            <div class="form-group">
                <label for="loyalty-goal" class="form-label">Ziel für Treueprogramm-Teilnahmen</label>
                <input type="number" id="loyalty-goal" class="form-control" min="0" step="10">
            </div>
            
            <div class="form-group">
                <label for="month-select" class="form-label">Zielmonat</label>
                <select id="month-select" class="form-control">
                    <option value="0">Januar</option>
                    <option value="1">Februar</option>
                    <option value="2">März</option>
                    <option value="3">April</option>
                    <option value="4">Mai</option>
                    <option value="5">Juni</option>
                    <option value="6">Juli</option>
                    <option value="7">August</option>
                    <option value="8">September</option>
                    <option value="9">Oktober</option>
                    <option value="10">November</option>
                    <option value="11">Dezember</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="year-select" class="form-label">Zieljahr</label>
                <select id="year-select" class="form-control">
                    <option value="2023">2023</option>
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                </select>
            </div>
            
            <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-xl);">
                <button class="action-btn btn-primary" id="save-goals-btn">
                    <i class="fas fa-save"></i>
                    Ziele speichern
                </button>
                <button class="action-btn" id="reset-goals-btn">
                    <i class="fas fa-undo"></i>
                    Zurücksetzen
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        
        // Dashboard Data Manager - Uses only real data from the application
        const dashboardManager = (function() {
            let revenueChart = null;
            let salesDistributionChart = null;
            
            // Data storage keys from the existing application
            const PAYMENT_ARCHIVE_KEY = 'payment_archive';
            const MERCHANT_INFO_KEY = 'merchant_info';
            const APP_SETTINGS_KEY = 'appSettings';
            const MONTHLY_GOALS_KEY = 'monthlyGoals';
            const PRODUCTS_KEY_PREFIX = 'product_';
            
            // Initialize dashboard
            function init() {
                // Apply dark mode if enabled
                applyDarkMode();
                
                // Set up event listeners
                setupEventListeners();
                
                // Update time display
                updateTime();
                setInterval(updateTime, 1000);
                
                // Load and display real data
                loadAndDisplayRealData();
            }
            
            // Apply dark mode if enabled
            function applyDarkMode() {
                const settings = getAppSettings();
                if (settings.darkMode) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
            }
            
            // Set up event listeners
            function setupEventListeners() {
                // Hamburger menu toggle for mobile
                document.getElementById('hamburger').addEventListener('click', () => {
                    const sidebar = document.getElementById('sidebar');
                    const sidebarOverlay = document.getElementById('sidebarOverlay');
                    sidebar.classList.toggle('active');
                    sidebarOverlay.classList.toggle('active');
                });
                
                // Close sidebar when clicking overlay
                document.getElementById('sidebarOverlay').addEventListener('click', () => {
                    const sidebar = document.getElementById('sidebar');
                    const sidebarOverlay = document.getElementById('sidebarOverlay');
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                });
                
                // Logout functionality
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    const settings = getAppSettings();
                    
                    if (settings.logoutConfirmation) {
                        if (!confirm('Möchten Sie sich wirklich abmelden?')) {
                            return;
                        }
                    }
                    
                    sessionStorage.removeItem('validTokens');
                    localStorage.removeItem('authToken');
                    window.location.reload();
                });
                
                // Chart type buttons
                document.querySelectorAll('.chart-action-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const chartId = this.getAttribute('data-chart');
                        const chartType = this.getAttribute('data-type');
                        
                        // Remove active class from all buttons in this chart group
                        this.parentElement.querySelectorAll('.chart-action-btn').forEach(b => {
                            b.classList.remove('active');
                        });
                        
                        // Add active class to clicked button
                        this.classList.add('active');
                        
                        // Change chart type
                        changeChartType(chartId, chartType);
                    });
                });
                
                // Goals modal
                document.getElementById('close-goals-modal').addEventListener('click', () => {
                    document.getElementById('goals-modal').classList.remove('active');
                });
                
                document.getElementById('save-goals-btn').addEventListener('click', () => {
                    saveGoals();
                });
                
                document.getElementById('reset-goals-btn').addEventListener('click', () => {
                    resetGoals();
                });
            }
            
            // Load and display real data from the application
            function loadAndDisplayRealData() {
                // Update welcome message with merchant name
                updateWelcomeMessage();
                
                // Load and display stats from payment archive
                updateStatsWithRealData();
                
                // Initialize charts with real data
                initChartsWithRealData();
                
                // Load and display goals
                updateGoalsWithRealData();
                
                // Load and display features
                updateFeaturesWithRealData();
                
                // Load and display recent activities
                updateRecentActivitiesWithRealData();
            }
            
            // Update welcome message with merchant name
            function updateWelcomeMessage() {
                const merchantInfo = getMerchantInfo();
                const welcomeElement = document.getElementById('welcome-message');
                
                if (merchantInfo && merchantInfo.name) {
                    welcomeElement.textContent = `Willkommen zurück, ${merchantInfo.name}!`;
                } else {
                    welcomeElement.textContent = 'Willkommen zurück!';
                }
            }
            
            // Update stats with real data from payment archive
            function updateStatsWithRealData() {
                const paymentArchive = getPaymentArchive();
                const statsGrid = document.getElementById('stats-grid');
                
                if (paymentArchive.length === 0) {
                    statsGrid.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-chart-bar"></i>
                            <p>Keine Verkaufsdaten verfügbar</p>
                            <p style="font-size: var(--text-sm); margin-top: var(--spacing-sm);">Beginnen Sie mit Verkäufen, um Statistiken zu sehen</p>
                        </div>
                    `;
                    return;
                }
                
                // Calculate today's stats
                const today = new Date();
                const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const todayEnd = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);
                
                const todayReceipts = paymentArchive.filter(receipt => {
                    const receiptDate = new Date(receipt.date);
                    return receiptDate >= todayStart && receiptDate <= todayEnd && receipt.status === 'Bestätigt';
                });
                
                const todayRevenue = todayReceipts.reduce((sum, receipt) => sum + receipt.amount, 0);
                const todayTransactions = todayReceipts.length;
                const todayAvgOrder = todayTransactions > 0 ? todayRevenue / todayTransactions : 0;
                
                // Calculate yesterday's stats for comparison
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStart = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate());
                const yesterdayEnd = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate(), 23, 59, 59);
                
                const yesterdayReceipts = paymentArchive.filter(receipt => {
                    const receiptDate = new Date(receipt.date);
                    return receiptDate >= yesterdayStart && receiptDate <= yesterdayEnd && receipt.status === 'Bestätigt';
                });
                
                const yesterdayRevenue = yesterdayReceipts.reduce((sum, receipt) => sum + receipt.amount, 0);
                const yesterdayTransactions = yesterdayReceipts.length;
                
                // Calculate revenue change
                const revenueChange = yesterdayRevenue > 0 ? 
                    ((todayRevenue - yesterdayRevenue) / yesterdayRevenue) * 100 : 0;
                
                // Calculate transactions change
                const transactionsChange = yesterdayTransactions > 0 ? 
                    ((todayTransactions - yesterdayTransactions) / yesterdayTransactions) * 100 : 0;
                
                // Count unique customers (if customer data is available)
                const uniqueCustomers = [...new Set(todayReceipts.map(r => r.customer).filter(Boolean))].length;
                
                // Calculate month-to-date revenue
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                const monthReceipts = paymentArchive.filter(receipt => {
                    const receiptDate = new Date(receipt.date);
                    return receiptDate >= monthStart && receiptDate <= todayEnd && receipt.status === 'Bestätigt';
                });
                
                const monthRevenue = monthReceipts.reduce((sum, receipt) => sum + receipt.amount, 0);
                
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Heutiger Umsatz</div>
                            <div class="stat-card-icon revenue">
                                <i class="fas fa-euro-sign"></i>
                            </div>
                        </div>
                        <div class="stat-card-value">€${todayRevenue.toFixed(2)}</div>
                        <div class="stat-card-change ${revenueChange >= 0 ? 'positive' : 'negative'}">
                            <i class="fas fa-${revenueChange >= 0 ? 'arrow-up' : 'arrow-down'}"></i>
                            ${Math.abs(revenueChange).toFixed(1)}% ${revenueChange >= 0 ? 'gegenüber gestern' : 'gegenüber gestern'}
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Transaktionen heute</div>
                            <div class="stat-card-icon sales">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                        </div>
                        <div class="stat-card-value">${todayTransactions}</div>
                        <div class="stat-card-change ${transactionsChange >= 0 ? 'positive' : 'negative'}">
                            <i class="fas fa-${transactionsChange >= 0 ? 'arrow-up' : 'arrow-down'}"></i>
                            ${Math.abs(transactionsChange).toFixed(1)}% ${transactionsChange >= 0 ? 'gegenüber gestern' : 'gegenüber gestern'}
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Durchschn. Bestellwert</div>
                            <div class="stat-card-icon avg-order">
                                <i class="fas fa-receipt"></i>
                            </div>
                        </div>
                        <div class="stat-card-value">€${todayAvgOrder.toFixed(2)}</div>
                        <div class="stat-card-change">
                            <i class="fas fa-minus"></i>
                            -
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Umsatz diesen Monat</div>
                            <div class="stat-card-icon customers">
                                <i class="fas fa-calendar"></i>
                            </div>
                        </div>
                        <div class="stat-card-value">€${monthRevenue.toFixed(2)}</div>
                        <div class="stat-card-change positive">
                            <i class="fas fa-arrow-up"></i>
                            Laufend
                        </div>
                    </div>
                `;
            }
            
            // Initialize charts with real data
            function initChartsWithRealData() {
                const paymentArchive = getPaymentArchive();
                
                if (paymentArchive.length === 0) {
                    document.getElementById('revenue-chart').parentElement.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-chart-line"></i>
                            <p>Keine Daten für Diagramme verfügbar</p>
                        </div>
                    `;
                    
                    document.getElementById('sales-distribution-chart').parentElement.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-chart-pie"></i>
                            <p>Keine Daten für Diagramme verfügbar</p>
                        </div>
                    `;
                    return;
                }
                
                // Revenue chart
                const revenueCtx = document.getElementById('revenue-chart').getContext('2d');
                const revenueData = getRevenueByDay(paymentArchive);
                
                revenueChart = new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: revenueData.labels,
                        datasets: [{
                            label: 'Umsatz (€)',
                            data: revenueData.data,
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderColor: 'rgba(37, 99, 235, 1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '€' + value;
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Umsatz: €' + context.raw;
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Sales distribution chart
                const salesDistributionCtx = document.getElementById('sales-distribution-chart').getContext('2d');
                const distributionData = getSalesDistribution(paymentArchive);
                
                salesDistributionChart = new Chart(salesDistributionCtx, {
                    type: 'doughnut',
                    data: {
                        labels: distributionData.labels,
                        datasets: [{
                            data: distributionData.data,
                            backgroundColor: [
                                'rgba(37, 99, 235, 0.7)',
                                'rgba(22, 163, 74, 0.7)',
                                'rgba(217, 119, 6, 0.7)',
                                'rgba(126, 34, 206, 0.7)',
                                'rgba(16, 185, 129, 0.7)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return context.label + ': €' + value + ' (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Update goals with real data
            function updateGoalsWithRealData() {
                const goalsContainer = document.getElementById('goals-container');
                const paymentArchive = getPaymentArchive();
                const goals = getMonthlyGoals();
                
                if (!goals) {
                    goalsContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-bullseye"></i>
                            <p>Keine Ziele festgelegt</p>
                            <button class="action-btn btn-primary" id="setup-goals-btn" style="margin-top: var(--spacing-md);">
                                <i class="fas fa-plus"></i>
                                Ziele einrichten
                            </button>
                        </div>
                    `;
                    
                    document.getElementById('setup-goals-btn').addEventListener('click', () => {
                        document.getElementById('goals-modal').classList.add('active');
                    });
                    
                    return;
                }
                
                // Calculate current progress
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                const monthStart = new Date(currentYear, currentMonth, 1);
                const today = new Date();
                const monthEnd = new Date(currentYear, currentMonth + 1, 0, 23, 59, 59);
                
                const monthReceipts = paymentArchive.filter(receipt => {
                    const receiptDate = new Date(receipt.date);
                    return receiptDate >= monthStart && receiptDate <= monthEnd && receipt.status === 'Bestätigt';
                });
                
                const monthRevenue = monthReceipts.reduce((sum, receipt) => sum + receipt.amount, 0);
                const revenueProgress = goals.revenue > 0 ? Math.min((monthRevenue / goals.revenue) * 100, 100) : 0;
                
                // Count unique customers this month
                const monthCustomers = [...new Set(monthReceipts.map(r => r.customer).filter(Boolean))].length;
                const customersProgress = goals.customers > 0 ? Math.min((monthCustomers / goals.customers) * 100, 100) : 0;
                
                // For reviews and loyalty, we'll need to get this data from other sources
                // For now, we'll use placeholder progress
                const reviewsProgress = 45; // This would come from a reviews database
                const loyaltyProgress = 72; // This would come from loyalty program data
                
                goalsContainer.innerHTML = `
                    <div class="goal-card">
                        <div class="goal-card-header">
                            <h3 class="goal-card-title">Monatsumsatz</h3>
                            <div class="goal-card-icon">
                                <i class="fas fa-euro-sign"></i>
                            </div>
                        </div>
                        <div class="goal-progress">
                            <div class="goal-progress-bar" style="width: ${revenueProgress}%"></div>
                        </div>
                        <div class="goal-details">
                            <span>€${monthRevenue.toFixed(2)} / €${goals.revenue}</span>
                            <span>${revenueProgress.toFixed(0)}%</span>
                        </div>
                    </div>
                    
                    <div class="goal-card">
                        <div class="goal-card-header">
                            <h3 class="goal-card-title">Neue Kunden</h3>
                            <div class="goal-card-icon">
                                <i class="fas fa-user-plus"></i>
                            </div>
                        </div>
                        <div class="goal-progress">
                            <div class="goal-progress-bar" style="width: ${customersProgress}%"></div>
                        </div>
                        <div class="goal-details">
                            <span>${monthCustomers} / ${goals.customers}</span>
                            <span>${customersProgress.toFixed(0)}%</span>
                        </div>
                    </div>
                    
                    <div class="goal-card">
                        <div class="goal-card-header">
                            <h3 class="goal-card-title">Produktbewertungen</h3>
                            <div class="goal-card-icon">
                                <i class="fas fa-star"></i>
                            </div>
                        </div>
                        <div class="goal-progress">
                            <div class="goal-progress-bar" style="width: ${reviewsProgress}%"></div>
                        </div>
                        <div class="goal-details">
                            <span>${Math.round(goals.reviews * (reviewsProgress / 100))} / ${goals.reviews}</span>
                            <span>${reviewsProgress}%</span>
                        </div>
                    </div>
                    
                    <div class="goal-card">
                        <div class="goal-card-header">
                            <h3 class="goal-card-title">Treueprogramm</h3>
                            <div class="goal-card-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                        </div>
                        <div class="goal-progress">
                            <div class="goal-progress-bar" style="width: ${loyaltyProgress}%"></div>
                        </div>
                        <div class="goal-details">
                            <span>${Math.round(goals.loyalty * (loyaltyProgress / 100))} / ${goals.loyalty}</span>
                            <span>${loyaltyProgress}%</span>
                        </div>
                    </div>
                `;
            }
            
            // Update features with real data
            function updateFeaturesWithRealData() {
                const featuresGrid = document.getElementById('features-grid');
                const paymentArchive = getPaymentArchive();
                const products = getAllProducts();
                
                const features = [
                    {
                        id: 'monthly-goals',
                        icon: 'fas fa-bullseye',
                        title: 'Monatsziele verwalten',
                        description: 'Setzen und verfolgen Sie Ihre monatlichen Geschäftsziele für Umsatz, Kunden und mehr.',
                        actions: [
                            { text: 'Ziele anzeigen', class: 'btn-primary', action: 'viewGoals' },
                            { text: 'Bearbeiten', class: '', action: 'editGoals' }
                        ]
                    },
                    {
                        id: 'inventory-management',
                        icon: 'fas fa-boxes',
                        title: 'Lagerbestand verwalten',
                        description: `Überwachen Sie Ihren Lagerbestand mit ${Object.keys(products).length} Produkten.`,
                        actions: [
                            { text: 'Bestand anzeigen', class: 'btn-primary', action: 'viewInventory' },
                            { text: 'Nachbestellen', class: '', action: 'restock' }
                        ]
                    },
                    {
                        id: 'customer-insights',
                        icon: 'fas fa-users',
                        title: 'Kundenanalyse',
                        description: `Analysieren Sie das Verhalten Ihrer ${getUniqueCustomers(paymentArchive).length} Kunden.`,
                        actions: [
                            { text: 'Kunden anzeigen', class: 'btn-primary', action: 'viewCustomers' },
                            { text: 'Segmentieren', class: '', action: 'segmentCustomers' }
                        ]
                    },
                    {
                        id: 'product-performance',
                        icon: 'fas fa-chart-bar',
                        title: 'Produktleistung',
                        description: `Analysieren Sie die Leistung Ihrer ${Object.keys(products).length} Produkte.`,
                        actions: [
                            { text: 'Produkte anzeigen', class: 'btn-primary', action: 'viewProducts' },
                            { text: 'Analysieren', class: '', action: 'analyzeProducts' }
                        ]
                    },
                    {
                        id: 'financial-reports',
                        icon: 'fas fa-file-invoice-dollar',
                        title: 'Finanzberichte',
                        description: `Generieren Sie Berichte basierend auf ${paymentArchive.length} Transaktionen.`,
                        actions: [
                            { text: 'Berichte anzeigen', class: 'btn-primary', action: 'viewReports' },
                            { text: 'Generieren', class: '', action: 'generateReport' }
                        ]
                    },
                    {
                        id: 'system-health',
                        icon: 'fas fa-heartbeat',
                        title: 'Systemstatus',
                        description: 'Überwachen Sie die Gesundheit Ihres Systems und Performance.',
                        actions: [
                            { text: 'Status anzeigen', class: 'btn-primary', action: 'viewSystem' },
                            { text: 'Optimieren', class: '', action: 'optimizeSystem' }
                        ]
                    }
                ];
                
                featuresGrid.innerHTML = features.map(feature => `
                    <div class="feature-card">
                        <div class="feature-card-header">
                            <div class="feature-card-icon">
                                <i class="${feature.icon}"></i>
                            </div>
                            <h3 class="feature-card-title">${feature.title}</h3>
                        </div>
                        <div class="feature-card-content">
                            ${feature.description}
                        </div>
                        <div class="feature-card-actions">
                            ${feature.actions.map(action => `
                                <button class="action-btn ${action.class}" data-action="${action.action}">
                                    ${action.text}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
                
                // Add event listeners to feature buttons
                document.querySelectorAll('[data-action]').forEach(button => {
                    button.addEventListener('click', function() {
                        const action = this.getAttribute('data-action');
                        handleFeatureAction(action);
                    });
                });
            }
            
            // Update recent activities with real data
            function updateRecentActivitiesWithRealData() {
                const activityList = document.getElementById('activity-list');
                const paymentArchive = getPaymentArchive();
                
                if (paymentArchive.length === 0) {
                    activityList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-history"></i>
                            <p>Keine Aktivitäten verfügbar</p>
                        </div>
                    `;
                    return;
                }
                
                // Get recent receipts (last 5)
                const recentReceipts = paymentArchive
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 5);
                
                activityList.innerHTML = recentReceipts.map(receipt => {
                    const receiptDate = new Date(receipt.date);
                    const now = new Date();
                    const diffMs = now - receiptDate;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);
                    
                    let timeText;
                    if (diffMins < 60) {
                        timeText = `Vor ${diffMins} Minute${diffMins !== 1 ? 'n' : ''}`;
                    } else if (diffHours < 24) {
                        timeText = `Vor ${diffHours} Stunde${diffHours !== 1 ? 'n' : ''}`;
                    } else {
                        timeText = `Vor ${diffDays} Tag${diffDays !== 1 ? 'en' : ''}`;
                    }
                    
                    const statusIcon = receipt.status === 'Bestätigt' ? 'fa-check-circle' : 'fa-times-circle';
                    const statusClass = receipt.status === 'Bestätigt' ? 'success' : 'warning';
                    
                    return `
                        <div class="activity-item">
                            <div class="activity-icon ${statusClass}">
                                <i class="fas ${statusIcon}"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">${receipt.status === 'Bestätigt' ? 'Verkauf abgeschlossen' : 'Verkauf abgelehnt'}</div>
                                <div class="activity-description">Beleg ${receipt.id}, Betrag: €${receipt.amount.toFixed(2)}${receipt.customer ? `, Kunde: ${receipt.customer}` : ''}</div>
                                <div class="activity-time">${timeText}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Handle feature actions
            function handleFeatureAction(action) {
                switch (action) {
                    case 'viewGoals':
                    case 'editGoals':
                        document.getElementById('goals-modal').classList.add('active');
                        break;
                    case 'viewInventory':
                    case 'restock':
                        window.location.href = 'products';
                        break;
                    case 'viewCustomers':
                    case 'segmentCustomers':
                        // This would open a customer management interface
                        alert('Kundenverwaltung wird geöffnet...');
                        break;
                    case 'viewProducts':
                    case 'analyzeProducts':
                        window.location.href = 'products';
                        break;
                    case 'viewReports':
                    case 'generateReport':
                        window.location.href = 'analytics';
                        break;
                    case 'viewSystem':
                    case 'optimizeSystem':
                        // This would open a system health interface
                        alert('Systemstatus wird überprüft...');
                        break;
                }
            }
            
            // Change chart type
            function changeChartType(chartId, type) {
                if (chartId === 'revenue' && revenueChart) {
                    revenueChart.config.type = type;
                    revenueChart.update();
                } else if (chartId === 'sales' && salesDistributionChart) {
                    salesDistributionChart.config.type = type;
                    salesDistributionChart.update();
                }
            }
            
            // Save monthly goals
            function saveGoals() {
                const revenueGoal = document.getElementById('revenue-goal').value;
                const customersGoal = document.getElementById('customers-goal').value;
                const reviewsGoal = document.getElementById('reviews-goal').value;
                const loyaltyGoal = document.getElementById('loyalty-goal').value;
                const month = document.getElementById('month-select').value;
                const year = document.getElementById('year-select').value;
                
                if (!revenueGoal || !customersGoal || !reviewsGoal || !loyaltyGoal) {
                    alert('Bitte füllen Sie alle Zielfelder aus.');
                    return;
                }
                
                // Save to localStorage
                const goals = {
                    revenue: parseFloat(revenueGoal),
                    customers: parseInt(customersGoal),
                    reviews: parseInt(reviewsGoal),
                    loyalty: parseInt(loyaltyGoal),
                    month: parseInt(month),
                    year: parseInt(year),
                    lastUpdated: new Date().toISOString()
                };
                
                localStorage.setItem(MONTHLY_GOALS_KEY, JSON.stringify(goals));
                
                // Update goals display
                updateGoalsWithRealData();
                
                // Show success message
                alert('Monatsziele erfolgreich gespeichert!');
                
                // Close modal
                document.getElementById('goals-modal').classList.remove('active');
            }
            
            // Reset monthly goals
            function resetGoals() {
                document.getElementById('revenue-goal').value = '';
                document.getElementById('customers-goal').value = '';
                document.getElementById('reviews-goal').value = '';
                document.getElementById('loyalty-goal').value = '';
                document.getElementById('month-select').value = new Date().getMonth();
                document.getElementById('year-select').value = new Date().getFullYear();
            }
            
            // Data retrieval functions
            function getPaymentArchive() {
                try {
                    const archive = localStorage.getItem(PAYMENT_ARCHIVE_KEY);
                    return archive ? JSON.parse(archive) : [];
                } catch (error) {
                    console.error('Error loading payment archive:', error);
                    return [];
                }
            }
            
            function getMerchantInfo() {
                try {
                    const merchantInfo = localStorage.getItem(MERCHANT_INFO_KEY);
                    return merchantInfo ? JSON.parse(merchantInfo) : null;
                } catch (error) {
                    console.error('Error loading merchant info:', error);
                    return null;
                }
            }
            
            function getAppSettings() {
                try {
                    const settings = localStorage.getItem(APP_SETTINGS_KEY);
                    return settings ? JSON.parse(settings) : {};
                } catch (error) {
                    console.error('Error loading app settings:', error);
                    return {};
                }
            }
            
            function getMonthlyGoals() {
                try {
                    const goals = localStorage.getItem(MONTHLY_GOALS_KEY);
                    return goals ? JSON.parse(goals) : null;
                } catch (error) {
                    console.error('Error loading monthly goals:', error);
                    return null;
                }
            }
            
            function getAllProducts() {
                const products = {};
                
                // Get all product keys from localStorage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    
                    if (key.startsWith(PRODUCTS_KEY_PREFIX)) {
                        try {
                            const item = localStorage.getItem(key);
                            const parsed = JSON.parse(item);
                            
                            if (parsed && parsed.barcode) {
                                products[parsed.barcode] = parsed;
                            }
                        } catch (e) {
                            // Skip invalid entries
                        }
                    }
                }
                
                return products;
            }
            
            // Data analysis functions
            function getRevenueByDay(paymentArchive) {
                const revenueByDay = {};
                const confirmedReceipts = paymentArchive.filter(receipt => receipt.status === 'Bestätigt');
                
                // Get last 7 days
                const dates = [];
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    dates.push(date.toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric', month: 'numeric' }));
                }
                
                // Initialize with zeros
                dates.forEach(date => {
                    revenueByDay[date] = 0;
                });
                
                // Fill with actual data
                confirmedReceipts.forEach(receipt => {
                    const receiptDate = new Date(receipt.date);
                    const dateKey = receiptDate.toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric', month: 'numeric' });
                    
                    if (revenueByDay.hasOwnProperty(dateKey)) {
                        revenueByDay[dateKey] += receipt.amount;
                    }
                });
                
                return {
                    labels: Object.keys(revenueByDay),
                    data: Object.values(revenueByDay)
                };
            }
            
            function getSalesDistribution(paymentArchive) {
                const distribution = {
                    'Bestätigt': 0,
                    'Abgelehnt': 0
                };
                
                paymentArchive.forEach(receipt => {
                    if (distribution.hasOwnProperty(receipt.status)) {
                        distribution[receipt.status] += receipt.amount;
                    } else {
                        distribution[receipt.status] = receipt.amount;
                    }
                });
                
                return {
                    labels: Object.keys(distribution),
                    data: Object.values(distribution)
                };
            }
            
            function getUniqueCustomers(paymentArchive) {
                return [...new Set(paymentArchive.map(r => r.customer).filter(Boolean))];
            }
            
            // Time display function
            function updateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('de-DE', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                const dateString = now.toLocaleDateString('de-DE', {
                    weekday: 'long',
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric'
                });
                document.getElementById('timeDisplay').textContent = `${dateString}, ${timeString}`;
            }
            
            // Public API
            return {
                init
            };
        })();

        // Initialize the dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            dashboardManager.init();
        });

        // Token verification
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = decodeURIComponent(urlParams.get('token') || '');
            const validTokens = JSON.parse(sessionStorage.getItem('validTokens') || '[]');
            const tokenIndex = validTokens.indexOf(urlToken);

            if(tokenIndex === -1) {
                const redirect = encodeURIComponent(window.location.href);
                window.location.href = `login?redirect=${redirect}`;
            } else {
                // Remove used token and clean URL
                validTokens.splice(tokenIndex, 1);
                sessionStorage.setItem('validTokens', JSON.stringify(validTokens));
                history.replaceState(null, null, window.location.pathname);
            }
        })();
    </script>
</body>
</html>
