<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Gittertier Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <style>
    :root {
        --color-bg: #ffffff;
        --color-text: #111111;
        --color-text-muted: #6b7280;
        --color-border: #e5e7eb;
        --color-accent: #2563eb;
        --color-accent-hover: #1d4ed8;
        --color-success: #16a34a;
        --color-error: #dc2626;
        --color-overlay: rgba(0, 0, 0, 0.5);
        
        --radius: 12px;
        --radius-sm: 6px;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.07), 0 1px 2px rgba(0, 0, 0, 0.04);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --focus-ring: 0 0 0 3px rgba(37, 99, 235, 0.35);
        
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;
        --spacing-xxl: 48px;
        
        --transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
        --transition-slow: all 0.3s cubic-bezier(0.2, 0, 0, 1);
        
        --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, "Helvetica Neue", Arial, sans-serif;
        --text-xs: 0.75rem;
        --text-sm: 0.875rem;
        --text-base: 1rem;
        --text-lg: 1.125rem;
        --text-xl: 1.25rem;
        --text-2xl: 1.5rem;
        --text-3xl: 1.875rem;
        
        --header-height: 64px;
    }

    .dark-mode {
        --color-bg: #111827;
        --color-text: #f3f4f6;
        --color-text-muted: #9ca3af;
        --color-border: #374151;
        --color-overlay: rgba(255, 255, 255, 0.1);
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: var(--font-family);
        background-color: var(--color-bg);
        color: var(--color-text);
        line-height: 1.5;
        min-height: 100vh;
        transition: var(--transition-slow);
    }

    /* Header Styles */
    header {
        height: var(--header-height);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 var(--spacing-lg);
        border-bottom: 1px solid var(--color-border);
        background-color: var(--color-bg);
        position: sticky;
        top: 0;
        z-index: 50;
    }

    .logo {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        font-weight: 700;
        font-size: var(--text-xl);
    }

    .logo i {
        font-size: var(--text-xl);
        color: var(--color-accent);
    }

    .header-controls {
        display: flex;
        gap: var(--spacing-md);
        align-items: center;
    }

    /* Main Content */
    main {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--spacing-xl) var(--spacing-lg);
    }

    .section {
        margin-bottom: var(--spacing-xl);
    }

    .section-title {
        font-size: var(--text-lg);
        font-weight: 600;
        margin-bottom: var(--spacing-md);
        color: var(--color-text);
    }

    /* Dashboard Grid */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    /* Card Styles */
    .card {
        background: var(--color-bg);
        border-radius: var(--radius);
        border: 1px solid var(--color-border);
        box-shadow: var(--shadow);
        padding: var(--spacing-lg);
        transition: var(--transition);
    }

    .card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
    }

    .card-title {
        font-size: var(--text-base);
        font-weight: 600;
        color: var(--color-text);
    }

    .card-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: rgba(37, 99, 235, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--color-accent);
    }

    .card-value {
        font-size: var(--text-2xl);
        font-weight: 700;
        color: var(--color-text);
        margin-bottom: var(--spacing-xs);
    }

    .card-label {
        font-size: var(--text-sm);
        color: var(--color-text-muted);
    }

    /* Table Styles */
    .table-container {
        background: var(--color-bg);
        border-radius: var(--radius);
        border: 1px solid var(--color-border);
        box-shadow: var(--shadow);
        overflow: hidden;
        margin-bottom: var(--spacing-xl);
    }

    .table-header {
        padding: var(--spacing-md) var(--spacing-lg);
        border-bottom: 1px solid var(--color-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .table-title {
        font-weight: 600;
        font-size: var(--text-base);
    }

    .table-actions {
        display: flex;
        gap: var(--spacing-sm);
    }

    .table {
        width: 100%;
        border-collapse: collapse;
    }

    .table th {
        text-align: left;
        padding: var(--spacing-md) var(--spacing-lg);
        font-weight: 600;
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        background-color: var(--color-bg);
        border-bottom: 1px solid var(--color-border);
    }

    .table td {
        padding: var(--spacing-md) var(--spacing-lg);
        border-bottom: 1px solid var(--color-border);
        font-size: var(--text-sm);
    }

    .table tr:last-child td {
        border-bottom: none;
    }

    .table tr:hover {
        background-color: var(--color-overlay);
    }

    /* Button Styles */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius);
        font-weight: 500;
        font-size: var(--text-sm);
        cursor: pointer;
        transition: var(--transition);
        border: 1px solid var(--color-border);
        background-color: var(--color-bg);
        color: var(--color-text);
    }

    .btn:hover {
        background-color: #f9fafb;
    }

    .btn:focus {
        outline: none;
        box-shadow: var(--focus-ring);
    }

    .btn-primary {
        background-color: var(--color-accent);
        color: white;
        border: none;
    }

    .btn-primary:hover {
        background-color: var(--color-accent-hover);
    }

    .btn-sm {
        padding: var(--spacing-xs) var(--spacing-sm);
        font-size: var(--text-xs);
    }

    /* Toggle Switch */
    .toggle-container {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .toggle-label {
        font-size: var(--text-sm);
        color: var(--color-text-muted);
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: var(--transition);
        border-radius: 34px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: var(--transition);
        border-radius: 50%;
    }

    input:checked + .toggle-slider {
        background-color: var(--color-accent);
    }

    input:checked + .toggle-slider:before {
        transform: translateX(20px);
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--color-overlay);
        z-index: 100;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-lg);
    }

    .modal-content {
        background-color: var(--color-bg);
        border-radius: var(--radius);
        padding: var(--spacing-xl);
        width: 100%;
        max-width: 500px;
        box-shadow: var(--shadow-md);
        animation: scaleIn 0.3s cubic-bezier(0.2, 0, 0, 1);
    }

    .modal-header {
        margin-bottom: var(--spacing-lg);
    }

    .modal-title {
        font-weight: 600;
        font-size: var(--text-xl);
        margin-bottom: var(--spacing-xs);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .modal-input {
        width: 100%;
        padding: var(--spacing-md);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-sm);
        margin-bottom: var(--spacing-md);
        font-size: var(--text-base);
        transition: var(--transition);
        background-color: var(--color-bg);
        color: var(--color-text);
    }

    .modal-input:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: var(--focus-ring);
    }

    .modal-actions {
        display: flex;
        gap: var(--spacing-md);
        margin-top: var(--spacing-lg);
    }

    .modal-btn {
        flex: 1;
        padding: var(--spacing-md);
        border-radius: var(--radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
    }

    .modal-btn.primary {
        background-color: var(--color-accent);
        color: white;
        border: none;
    }

    .modal-btn.primary:hover {
        background-color: var(--color-accent-hover);
    }

    .modal-btn.secondary {
        background-color: transparent;
        border: 1px solid var(--color-border);
        color: var(--color-text-muted);
    }

    .modal-btn.secondary:hover {
        background-color: #f9fafb;
        color: var(--color-text);
    }

    /* Notification */
    .notification {
        position: fixed;
        bottom: var(--spacing-xl);
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--color-text);
        color: white;
        padding: var(--spacing-md) var(--spacing-lg);
        border-radius: var(--radius);
        z-index: 60;
        display: none;
        animation: slideUp 0.3s ease-out;
        font-weight: 500;
    }

    .notification.success {
        background-color: var(--color-success);
    }

    .notification.error {
        background-color: var(--color-error);
    }

    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from { transform: translateY(20px) translateX(-50%); opacity: 0; }
        to { transform: translateY(0) translateX(-50%); opacity: 1; }
    }

    @keyframes scaleIn {
        from { transform: scale(0.95); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        :root {
            --spacing-lg: 20px;
            --spacing-xl: 24px;
        }
        
        main {
            padding: var(--spacing-lg) var(--spacing-md);
        }
        
        .dashboard-grid {
            grid-template-columns: 1fr;
        }
        
        .table-header {
            flex-direction: column;
            align-items: flex-start;
            gap: var(--spacing-md);
        }
        
        .table-actions {
            width: 100%;
            justify-content: space-between;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        .table {
            min-width: 600px;
        }
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
        :root {
            --color-bg: #111827;
            --color-text: #f3f4f6;
            --color-text-muted: #9ca3af;
            --color-border: #374151;
        }
    }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <i class="fas fa-shopping-cart"></i>
            <span>Gittertier Pro Admin</span>
        </div>
        <div class="header-controls">
            <div class="toggle-container">
                <span class="toggle-label">Dark Mode</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="dark-mode-toggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <button class="btn" onclick="location.href='index'">
                <i class="fas fa-arrow-left"></i>
                Zur Kasse
            </button>
        </div>
    </header>

    <main>
        <section class="section">
            <h2 class="section-title">Dashboard</h2>
            <div class="dashboard-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Umsatz heute</div>
                        <div class="card-icon">
                            <i class="fas fa-euro-sign"></i>
                        </div>
                    </div>
                    <div class="card-value" id="revenue-today">€0.00</div>
                    <div class="card-label">Gesamtumsatz heute</div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Transaktionen</div>
                        <div class="card-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                    </div>
                    <div class="card-value" id="transaction-count">0</div>
                    <div class="card-label">Anzahl heute</div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Durchschnitt</div>
                        <div class="card-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <div class="card-value" id="average-order">€0.00</div>
                    <div class="card-label">Durchschnittlicher Einkauf</div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Produkte</div>
                        <div class="card-icon">
                            <i class="fas fa-box"></i>
                        </div>
                    </div>
                    <div class="card-value" id="product-count">0</div>
                    <div class="card-label">Im System</div>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="table-container">
                <div class="table-header">
                    <h3 class="table-title">Aktuelle Transaktionen</h3>
                    <div class="table-actions">
                        <button class="btn btn-sm" id="refresh-transactions">
                            <i class="fas fa-sync-alt"></i>
                            Aktualisieren
                        </button>
                        <button class="btn btn-primary btn-sm" id="add-product-btn">
                            <i class="fas fa-plus"></i>
                            Produkt hinzufügen
                        </button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Datum</th>
                                <th>Betrag</th>
                                <th>Status</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-body">
                            <!-- Transactions will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="table-container">
                <div class="table-header">
                    <h3 class="table-title">Produktverwaltung</h3>
                    <div class="table-actions">
                        <input type="text" class="modal-input" id="product-search" placeholder="Produkte suchen..." style="margin-bottom: 0;">
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Barcode</th>
                                <th>Name</th>
                                <th>Preis</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="products-body">
                            <!-- Products will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Add Product Modal -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-plus-circle"></i>
                    Produkt hinzufügen
                </h3>
                <p class="text-muted">Bitte geben Sie die Produktdetails ein</p>
            </div>
            <input type="text" id="product-name-input" class="modal-input" placeholder="Produktname">
            <input type="number" id="product-price-input" class="modal-input" placeholder="Preis (€)" step="0.01">
            <input type="text" id="product-barcode-input" class="modal-input" placeholder="Barcode">
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeModal()">Abbrechen</button>
                <button class="modal-btn primary" onclick="saveProduct()">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="edit-product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-edit"></i>
                    Produkt bearbeiten
                </h3>
                <p class="text-muted">Bearbeiten Sie die Produktdetails</p>
            </div>
            <input type="hidden" id="edit-product-barcode">
            <input type="text" id="edit-product-name-input" class="modal-input" placeholder="Produktname">
            <input type="number" id="edit-product-price-input" class="modal-input" placeholder="Preis (€)" step="0.01">
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeEditModal()">Abbrechen</button>
                <button class="modal-btn primary" onclick="updateProduct()">Aktualisieren</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // Apply dark mode if enabled in localStorage
        function applyDarkMode() {
            const darkModeEnabled = localStorage.getItem('darkMode') === 'true';
            document.getElementById('dark-mode-toggle').checked = darkModeEnabled;
            
            if (darkModeEnabled) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }

        // Toggle dark mode
        document.getElementById('dark-mode-toggle').addEventListener('change', function() {
            if (this.checked) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('darkMode', 'true');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('darkMode', 'false');
            }
        });

        // Token verification (existing functionality)
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = decodeURIComponent(urlParams.get('token') || '');
            const validTokens = JSON.parse(sessionStorage.getItem('validTokens') || '[]');
            const tokenIndex = validTokens.indexOf(urlToken);

            if(tokenIndex === -1) {
                const redirect = encodeURIComponent(window.location.href);
                window.location.href = `login?redirect=${redirect}`;
            } else {
                // Remove used token and clean URL
                validTokens.splice(tokenIndex, 1);
                sessionStorage.setItem('validTokens', JSON.stringify(validTokens));
                history.replaceState(null, null, window.location.pathname);
            }
        })();

        // Load transactions and products
        function loadData() {
            loadTransactions();
            loadProducts();
            updateStats();
        }

        // Load transactions from localStorage
        function loadTransactions() {
            const transactions = [];
            for(let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if(key.startsWith('receipt_')) {
                    try {
                        const storedValue = localStorage.getItem(key);
                        if (!storedValue) continue;
                        
                        const stored = JSON.parse(storedValue);
                        let originalData = null;
                        let transactionDate = stored.date;
                        
                        // Attempt decompression
                        if (stored.data) {
                            const decompressed = LZString.decompressFromBase64(stored.data);
                            
                            if (decompressed) {
                                try {
                                    originalData = JSON.parse(decompressed);
                                    transactionDate = originalData.date;
                                } catch (parseError) {
                                    console.error('Error parsing decompressed data:', parseError);
                                }
                            }
                        }
                        
                        transactions.push({
                            id: key.replace('receipt_', ''),
                            date: transactionDate,
                            total: stored.total,
                            status: stored.status || 'Bestätigt'
                        });
                    } catch (e) {
                        console.error('Error processing receipt:', e);
                    }
                }
            }
            
            // Sort by date (newest first)
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Display transactions
            const transactionsBody = document.getElementById('transactions-body');
            transactionsBody.innerHTML = '';
            
            if (transactions.length === 0) {
                transactionsBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: var(--spacing-xl); color: var(--color-text-muted);">
                            <i class="fas fa-receipt" style="font-size: 2rem; margin-bottom: var(--spacing-sm); display: block;"></i>
                            Keine Transaktionen gefunden
                        </td>
                    </tr>
                `;
                return;
            }
            
            transactions.forEach(transaction => {
                const date = new Date(transaction.date);
                const dateStr = `${date.toLocaleDateString('de-DE')} ${date.toLocaleTimeString('de-DE', {hour: '2-digit', minute:'2-digit'})}`;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${transaction.id}</td>
                    <td>${dateStr}</td>
                    <td>€${transaction.total.toFixed(2)}</td>
                    <td><span class="status-badge">${transaction.status}</span></td>
                    <td>
                        <button class="btn btn-sm" onclick="viewTransaction('${transaction.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                transactionsBody.appendChild(row);
            });
        }

        // Load products from localStorage
        function loadProducts() {
            const products = JSON.parse(localStorage.getItem('products')) || {};
            const productsBody = document.getElementById('products-body');
            productsBody.innerHTML = '';
            
            if (Object.keys(products).length === 0) {
                productsBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: var(--spacing-xl); color: var(--color-text-muted);">
                            <i class="fas fa-box" style="font-size: 2rem; margin-bottom: var(--spacing-sm); display: block;"></i>
                            Keine Produkte gefunden
                        </td>
                    </tr>
                `;
                return;
            }
            
            Object.keys(products).forEach(barcode => {
                const product = products[barcode];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${barcode}</td>
                    <td>${product.name}</td>
                    <td>€${product.price.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm" onclick="editProduct('${barcode}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm" onclick="deleteProduct('${barcode}')" style="color: var(--color-error);">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                productsBody.appendChild(row);
            });
        }

        // Update dashboard statistics
        function updateStats() {
            // Calculate total revenue and transactions
            const transactions = [];
            for(let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if(key.startsWith('receipt_')) {
                    try {
                        const stored = JSON.parse(localStorage.getItem(key));
                        if (stored && stored.status === 'Bestätigt') {
                            transactions.push({
                                total: parseFloat(stored.total),
                                date: stored.date
                            });
                        }
                    } catch (e) {
                        console.error('Error processing receipt:', e);
                    }
                }
            }
            
            // Today's date for filtering
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            // Filter today's transactions
            const todayTransactions = transactions.filter(t => {
                const transactionDate = new Date(t.date).toISOString().split('T')[0];
                return transactionDate === todayStr;
            });
            
            // Calculate stats
            const totalRevenue = todayTransactions.reduce((sum, t) => sum + t.total, 0);
            const transactionCount = todayTransactions.length;
            const avgOrder = transactionCount > 0 ? totalRevenue / transactionCount : 0;
            
            // Get products count
            const products = JSON.parse(localStorage.getItem('products')) || {};
            const productCount = Object.keys(products).length;
            
            // Update UI
            document.getElementById('revenue-today').textContent = `€${totalRevenue.toFixed(2)}`;
            document.getElementById('transaction-count').textContent = transactionCount;
            document.getElementById('average-order').textContent = `€${avgOrder.toFixed(2)}`;
            document.getElementById('product-count').textContent = productCount;
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification';
            notification.classList.add(type);
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Modal functions
        function openProductModal() {
            document.getElementById('product-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('product-modal').style.display = 'none';
            document.getElementById('product-name-input').value = '';
            document.getElementById('product-price-input').value = '';
            document.getElementById('product-barcode-input').value = '';
        }

        function openEditModal() {
            document.getElementById('edit-product-modal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('edit-product-modal').style.display = 'none';
        }

        // Save new product
        function saveProduct() {
            const name = document.getElementById('product-name-input').value.trim();
            const price = parseFloat(document.getElementById('product-price-input').value);
            const barcode = document.getElementById('product-barcode-input').value.trim();
            
            if (!name || isNaN(price) || !barcode) {
                showNotification('Bitte füllen Sie alle Felder aus', 'error');
                return;
            }
            
            if (price <= 0) {
                showNotification('Preis muss größer als 0 sein', 'error');
                return;
            }
            
            // Get existing products
            const products = JSON.parse(localStorage.getItem('products')) || {};
            
            // Check if barcode already exists
            if (products[barcode]) {
                showNotification('Produkt mit diesem Barcode existiert bereits', 'error');
                return;
            }
            
            // Add new product
            products[barcode] = {
                name: name,
                price: price,
                barcode: barcode
            };
            
            // Save to localStorage
            localStorage.setItem('products', JSON.stringify(products));
            
            // Update UI
            loadProducts();
            updateStats();
            closeModal();
            
            showNotification('Produkt erfolgreich hinzugefügt');
        }

        // Edit product
        function editProduct(barcode) {
            const products = JSON.parse(localStorage.getItem('products')) || {};
            const product = products[barcode];
            
            if (!product) {
                showNotification('Produkt nicht gefunden', 'error');
                return;
            }
            
            // Fill edit form
            document.getElementById('edit-product-barcode').value = barcode;
            document.getElementById('edit-product-name-input').value = product.name;
            document.getElementById('edit-product-price-input').value = product.price;
            
            // Show edit modal
            openEditModal();
        }

        // Update product
        function updateProduct() {
            const barcode = document.getElementById('edit-product-barcode').value;
            const name = document.getElementById('edit-product-name-input').value.trim();
            const price = parseFloat(document.getElementById('edit-product-price-input').value);
            
            if (!name || isNaN(price)) {
                showNotification('Bitte füllen Sie alle Felder aus', 'error');
                return;
            }
            
            if (price <= 0) {
                showNotification('Preis muss größer als 0 sein', 'error');
                return;
            }
            
            // Get existing products
            const products = JSON.parse(localStorage.getItem('products')) || {};
            
            // Check if product exists
            if (!products[barcode]) {
                showNotification('Produkt nicht gefunden', 'error');
                return;
            }
            
            // Update product
            products[barcode] = {
                name: name,
                price: price,
                barcode: barcode
            };
            
            // Save to localStorage
            localStorage.setItem('products', JSON.stringify(products));
            
            // Update UI
            loadProducts();
            closeEditModal();
            
            showNotification('Produkt erfolgreich aktualisiert');
        }

        // Delete product
        function deleteProduct(barcode) {
            if (!confirm('Möchten Sie dieses Produkt wirklich löschen?')) {
                return;
            }
            
            // Get existing products
            const products = JSON.parse(localStorage.getItem('products')) || {};
            
            // Check if product exists
            if (!products[barcode]) {
                showNotification('Produkt nicht gefunden', 'error');
                return;
            }
            
            // Delete product
            delete products[barcode];
            
            // Save to localStorage
            localStorage.setItem('products', JSON.stringify(products));
            
            // Update UI
            loadProducts();
            updateStats();
            
            showNotification('Produkt erfolgreich gelöscht');
        }

        // View transaction details
        function viewTransaction(id) {
            const receipt = localStorage.getItem(`receipt_${id}`);
            if (!receipt) {
                showNotification('Transaktion nicht gefunden', 'error');
                return;
            }
            
            try {
                const receiptData = JSON.parse(receipt);
                alert(`Transaktionsdetails:\n\nID: ${id}\nDatum: ${receiptData.date}\nBetrag: €${receiptData.total}\nStatus: ${receiptData.status || 'Bestätigt'}`);
            } catch (e) {
                showNotification('Fehler beim Laden der Transaktion', 'error');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            applyDarkMode();
            loadData();
            
            // Add event listeners
            document.getElementById('add-product-btn').addEventListener('click', openProductModal);
            document.getElementById('refresh-transactions').addEventListener('click', loadData);
            
            // Product search functionality
            document.getElementById('product-search').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.getElementById('products-body').getElementsByTagName('tr');
                
                for (let row of rows) {
                    const name = row.cells[1].textContent.toLowerCase();
                    const barcode = row.cells[0].textContent.toLowerCase();
                    
                    if (name.includes(searchTerm) || barcode.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
        });
    </script>
</body>
</html>