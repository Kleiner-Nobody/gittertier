<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gittertier Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    :root {
        --color-bg: #ffffff;
        --color-bg-secondary: #f9fafb;
        --color-text: #111111;
        --color-text-muted: #6b7280;
        --color-border: #e5e7eb;
        --color-accent: #2563eb;
        --color-accent-hover: #1d4ed8;
        --color-success: #16a34a;
        --color-error: #dc2626;
        --color-warning: #d97706;
        --color-info: #0ea5e9;
        --color-premium: #c5a47e;
        --color-ai-primary: #1a73e8;
        --color-ai-secondary: #34a853;
        --color-ai-tertiary: #fbbc04;
        --color-ai-quaternary: #ea4335;
        --color-overlay: rgba(0, 0, 0, 0.5);
        
        --radius: 12px;
        --radius-sm: 6px;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.07), 0 1px 2px rgba(0, 0, 0, 0.04);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --focus-ring: 0 0 0 3px rgba(37, 99, 235, 0.35);
        
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;
        --spacing-xxl: 48px;
        
        --transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
        --transition-slow: all 0.3s cubic-bezier(0.2, 0, 0, 1);
        
        --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, "Helvetica Neue", Arial, sans-serif;
        --text-xs: 0.75rem;
        --text-sm: 0.875rem;
        --text-base: 1rem;
        --text-lg: 1.125rem;
        --text-xl: 1.25rem;
        --text-2xl: 1.5rem;
        --text-3xl: 1.875rem;
        
        --header-height: 64px;
        --sidebar-width: 280px;
        --sidebar-width-collapsed: 80px;
    }

    .dark-mode {
        --color-bg: #111827;
        --color-bg-secondary: #1f2937;
        --color-text: #f3f4f6;
        --color-text-muted: #9ca3af;
        --color-border: #374151;
        --color-accent: #3b82f6;
        --color-accent-hover: #2563eb;
        --color-success: #10b981;
        --color-error: #ef4444;
        --color-warning: #f59e0b;
        --color-info: #0ea5e9;
        --color-premium: #d6bc97;
        --color-ai-primary: #1a73e8;
        --color-ai-secondary: #34a853;
        --color-ai-tertiary: #fbbc04;
        --color-ai-quaternary: #ea4335;
        --color-overlay: rgba(0, 0, 0, 0.7);
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.3), 0 1px 2px rgba(0, 0, 0, 0.2);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: var(--font-family);
        background-color: var(--color-bg);
        color: var(--color-text);
        line-height: 1.5;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    /* Header Styles */
    .admin-header {
        height: var(--header-height);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 var(--spacing-lg);
        border-bottom: 1px solid var(--color-border);
        background-color: var(--color-bg);
        position: sticky;
        top: 0;
        z-index: 50;
    }

    .logo {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        font-weight: 700;
        font-size: var(--text-xl);
    }

    .logo i {
        font-size: var(--text-xl);
        color: var(--color-accent);
    }

    .header-controls {
        display: flex;
        gap: var(--spacing-md);
        align-items: center;
    }

    .time-display {
        background-color: var(--color-bg-secondary);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius);
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        display: none;
    }

    .notification-btn {
        position: relative;
        background: transparent;
        border: none;
        width: 42px;
        height: 42px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--color-text);
        font-size: var(--text-lg);
        transition: var(--transition);
    }

    .notification-btn:hover {
        background-color: var(--color-bg-secondary);
    }

    .notification-badge {
        position: absolute;
        top: 5px;
        right: 5px;
        width: 18px;
        height: 18px;
        background: var(--color-error);
        color: white;
        border-radius: 50%;
        font-size: var(--text-xs);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .logout-btn {
        background-color: transparent;
        color: var(--color-text);
        border: 1px solid var(--color-border);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .logout-btn:hover {
        background-color: var(--color-bg-secondary);
    }

    .hamburger {
        display: block;
        background: transparent;
        border: none;
        font-size: var(--text-lg);
        color: var(--color-text);
        cursor: pointer;
        transition: var(--transition);
        width: 42px;
        height: 42px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .hamburger:hover {
        background-color: var(--color-bg-secondary);
    }

    /* Main layout */
    .admin-container {
        display: flex;
        flex: 1;
    }

    /* Sidebar */
    .admin-sidebar {
        width: var(--sidebar-width);
        background-color: var(--color-bg);
        border-right: 1px solid var(--color-border);
        height: calc(100vh - var(--header-height));
        position: fixed;
        top: var(--header-height);
        left: 0;
        overflow-y: auto;
        transition: transform 0.3s ease;
        z-index: 40;
        padding: var(--spacing-lg) 0;
    }

    .nav-container {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
        padding: 0 var(--spacing-md);
    }

    .nav-link {
        padding: var(--spacing-md);
        border-radius: var(--radius);
        text-decoration: none;
        color: var(--color-text);
        font-weight: 500;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    .nav-link:hover {
        background-color: var(--color-bg-secondary);
    }

    .nav-link.active {
        background-color: rgba(37, 99, 235, 0.1);
        color: var(--color-accent);
    }

    .nav-link i {
        width: 24px;
        text-align: center;
    }

    .nav-link.active i {
        color: var(--color-accent);
    }

    .new-feature {
        background-color: var(--color-success);
        color: white;
        font-size: var(--text-xs);
        padding: 2px 8px;
        border-radius: 10px;
        margin-left: auto;
    }

    /* Sidebar overlay for mobile */
    .sidebar-overlay {
        position: fixed;
        top: var(--header-height);
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--color-overlay);
        z-index: 35;
        display: none;
    }

    /* Main content */
    .admin-content {
        flex: 1;
        padding: var(--spacing-lg);
        margin-left: var(--sidebar-width);
        transition: margin-left 0.3s ease;
    }

    /* Page Header */
    .page-header {
        margin-bottom: var(--spacing-xl);
    }

    .page-title {
        font-size: var(--text-2xl);
        font-weight: 700;
        margin-bottom: var(--spacing-sm);
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    .page-subtitle {
        color: var(--color-text-muted);
        max-width: 600px;
    }

    /* AI Overview Section */
    .ai-overview {
        background: linear-gradient(135deg, var(--color-ai-primary), var(--color-ai-secondary));
        border-radius: var(--radius);
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
        color: white;
        box-shadow: var(--shadow-lg);
        position: relative;
        overflow: hidden;
    }

    .ai-overview::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
        opacity: 0.3;
    }

    .ai-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
    }

    .ai-title {
        font-size: var(--text-xl);
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .ai-title i {
        color: var(--color-ai-tertiary);
    }

    .ai-actions {
        display: flex;
        gap: var(--spacing-sm);
    }

    .ai-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius);
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .ai-btn:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .ai-content {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: var(--spacing-lg);
    }

    @media (max-width: 1024px) {
        .ai-content {
            grid-template-columns: 1fr;
        }
    }

    .ai-suggestions {
        background: rgba(255, 255, 255, 0.1);
        border-radius: var(--radius);
        padding: var(--spacing-lg);
        backdrop-filter: blur(10px);
    }

    .ai-suggestion-item {
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        background: rgba(255, 255, 255, 0.1);
        border-radius: var(--radius);
        border-left: 4px solid var(--color-ai-tertiary);
        transition: var(--transition);
    }

    .ai-suggestion-item:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateX(4px);
    }

    .ai-suggestion-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--spacing-sm);
    }

    .ai-suggestion-title {
        font-weight: 600;
        font-size: var(--text-base);
    }

    .ai-suggestion-priority {
        font-size: var(--text-xs);
        padding: 2px 8px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.2);
    }

    .ai-suggestion-priority.high {
        background: var(--color-ai-quaternary);
    }

    .ai-suggestion-priority.medium {
        background: var(--color-ai-tertiary);
    }

    .ai-suggestion-priority.low {
        background: var(--color-ai-secondary);
    }

    .ai-suggestion-description {
        font-size: var(--text-sm);
        opacity: 0.9;
        margin-bottom: var(--spacing-md);
    }

    .ai-suggestion-actions {
        display: flex;
        gap: var(--spacing-sm);
    }

    .ai-apply-btn {
        background: var(--color-ai-secondary);
        color: white;
        border: none;
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius);
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .ai-apply-btn:hover {
        background: #2a8e47;
    }

    .ai-dismiss-btn {
        background: transparent;
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius);
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
    }

    .ai-dismiss-btn:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .ai-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-md);
    }

    .ai-stat-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: var(--radius);
        padding: var(--spacing-md);
        text-align: center;
        backdrop-filter: blur(10px);
    }

    .ai-stat-value {
        font-size: var(--text-2xl);
        font-weight: 700;
        margin-bottom: var(--spacing-xs);
    }

    .ai-stat-label {
        font-size: var(--text-sm);
        opacity: 0.9;
    }

    /* AI Typing Animation */
    .ai-typing {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-md);
    }

    .ai-typing-dots {
        display: flex;
        gap: 4px;
    }

    .ai-typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--color-ai-tertiary);
        animation: aiPulse 1.5s infinite ease-in-out;
    }

    .ai-typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .ai-typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes aiPulse {
        0%, 60%, 100% {
            transform: scale(1);
            opacity: 0.5;
        }
        30% {
            transform: scale(1.2);
            opacity: 1;
        }
    }

    /* Dashboard Grid */
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .stat-card {
        background-color: var(--color-bg);
        border-radius: var(--radius);
        border: 1px solid var(--color-border);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow);
        transition: var(--transition);
    }

    .stat-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .stat-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
    }

    .stat-card-title {
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        font-weight: 500;
    }

    .stat-card-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-lg);
    }

    .stat-card-icon.revenue {
        background-color: rgba(37, 99, 235, 0.1);
        color: var(--color-accent);
    }

    .stat-card-icon.sales {
        background-color: rgba(22, 163, 74, 0.1);
        color: var(--color-success);
    }

    .stat-card-icon.customers {
        background-color: rgba(126, 34, 206, 0.1);
        color: var(--color-loyalty);
    }

    .stat-card-icon.avg-order {
        background-color: rgba(217, 119, 6, 0.1);
        color: var(--color-warning);
    }

    .stat-card-value {
        font-size: var(--text-2xl);
        font-weight: 700;
        margin-bottom: var(--spacing-xs);
    }

    .stat-card-change {
        font-size: var(--text-sm);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .stat-card-change.positive {
        color: var(--color-success);
    }

    .stat-card-change.negative {
        color: var(--color-error);
    }

    /* Feature Cards */
    .feature-card {
        background-color: var(--color-bg);
        border-radius: var(--radius);
        border: 1px solid var(--color-border);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow);
        transition: var(--transition);
    }

    .feature-card:hover {
        box-shadow: var(--shadow-md);
    }

    .feature-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--spacing-lg);
    }

    .feature-card-title {
        font-size: var(--text-lg);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .feature-card-title i {
        color: var(--color-accent);
    }

    .feature-card-actions {
        display: flex;
        gap: var(--spacing-sm);
    }

    .feature-action-btn {
        background: transparent;
        border: 1px solid var(--color-border);
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: var(--transition);
        color: var(--color-text-muted);
    }

    .feature-action-btn:hover {
        background-color: var(--color-bg-secondary);
        color: var(--color-text);
    }

    /* Charts */
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }

    /* Goals Section */
    .goals-container {
        margin-top: var(--spacing-md);
    }

    .goal-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md);
        border-bottom: 1px solid var(--color-border);
    }

    .goal-item:last-child {
        border-bottom: none;
    }

    .goal-info {
        flex: 1;
    }

    .goal-name {
        font-weight: 500;
        margin-bottom: var(--spacing-xs);
    }

    .goal-progress {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    .goal-progress-bar {
        flex: 1;
        height: 8px;
        background-color: var(--color-bg-secondary);
        border-radius: 4px;
        overflow: hidden;
    }

    .goal-progress-fill {
        height: 100%;
        background-color: var(--color-success);
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .goal-actions {
        display: flex;
        gap: var(--spacing-sm);
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--color-overlay);
        z-index: 1000;
        display: none;
    }

    .modal-overlay.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    .modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: var(--color-bg);
        border-radius: var(--radius);
        box-shadow: var(--shadow-lg);
        z-index: 1001;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        display: none;
    }

    .modal.active {
        display: block;
        animation: scaleIn 0.3s ease;
    }

    .modal-header {
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--color-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h2 {
        font-size: var(--text-xl);
        font-weight: 600;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: var(--text-xl);
        cursor: pointer;
        color: var(--color-text-muted);
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: var(--transition);
    }

    .modal-close:hover {
        background-color: var(--color-bg-secondary);
    }

    .modal-content {
        padding: var(--spacing-lg);
    }

    .modal-input {
        width: 100%;
        padding: var(--spacing-md);
        border: 1px solid var(--color-border);
        border-radius: var(--radius);
        margin-bottom: var(--spacing-md);
        font-size: var(--text-base);
        transition: var(--transition);
        background: var(--color-bg);
        color: var(--color-text);
    }

    .modal-input:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: var(--focus-ring);
    }

    .modal-buttons {
        display: flex;
        gap: var(--spacing-md);
        margin-top: var(--spacing-lg);
    }

    .modal-buttons button {
        flex: 1;
        padding: var(--spacing-md);
        border: none;
        border-radius: var(--radius);
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
    }

    .btn-save {
        background: var(--color-success);
        color: white;
    }

    .btn-save:hover {
        background: #0f9c5a;
    }

    .btn-cancel {
        background: var(--color-bg);
        border: 1px solid var(--color-border);
        color: var(--color-text);
    }

    .btn-cancel:hover {
        background: var(--color-bg-secondary);
    }

    /* Tables */
    .table-container {
        overflow-x: auto;
        margin-top: var(--spacing-md);
    }

    .dashboard-table {
        width: 100%;
        border-collapse: collapse;
    }

    .dashboard-table th,
    .dashboard-table td {
        padding: var(--spacing-sm);
        text-align: left;
        border-bottom: 1px solid var(--color-border);
    }

    .dashboard-table th {
        font-weight: 600;
        color: var(--color-text-muted);
        background-color: var(--color-bg-secondary);
        position: sticky;
        top: 0;
    }

    .dashboard-table tr:last-child td {
        border-bottom: none;
    }

    .dashboard-table tr:hover {
        background-color: var(--color-bg-secondary);
    }

    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes scaleIn {
        from { transform: translate(-50%, -50%) scale(0.95); opacity: 0; }
        to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .admin-sidebar {
            transform: translateX(-100%);
        }
        
        .admin-sidebar.active {
            transform: translateX(0);
        }
        
        .admin-content {
            margin-left: 0;
        }
        
        .sidebar-overlay.active {
            display: block;
        }
    }

    @media (min-width: 768px) {
        .time-display {
            display: block;
        }
        
        .logout-btn span {
            display: inline;
        }
    }

    @media (max-width: 768px) {
        .admin-header {
            padding: 0 var(--spacing-md);
        }
        
        .admin-content {
            padding: var(--spacing-md);
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .dashboard-grid {
            grid-template-columns: 1fr;
        }
        
        .ai-stats {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 480px) {
        .ai-content {
            grid-template-columns: 1fr;
        }
        
        .ai-suggestion-actions {
            flex-direction: column;
        }
    }

    /* Dark mode support for system preference */
    @media (prefers-color-scheme: dark) {
        :root {
            --color-bg: #111827;
            --color-bg-secondary: #1f2937;
            --color-text: #f3f4f6;
            --color-text-muted: #9ca3af;
            --color-border: #374151;
        }
    }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="logo">
            <button class="hamburger" id="hamburger">
                <i class="fas fa-bars"></i>
            </button>
            <i class="fas fa-shopping-cart"></i>
            <span>Gittertier Pro</span>
        </div>
        <div class="header-controls">
            <div class="time-display" id="timeDisplay"></div>
            <button class="notification-btn" id="notificationBtn">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationBadge">3</span>
            </button>
            <button class="logout-btn" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i>
                <span>Abmelden</span>
            </button>
        </div>
    </div>

    <div class="admin-container">
        <aside class="admin-sidebar" id="sidebar">
            <div class="nav-container">
                <a href="control" class="nav-link">
                    <i class="fas fa-cogs"></i>
                    <span>Steuerung</span>
                    <span class="new-feature">NEU</span>
                </a>
                
                <a href="navi" class="nav-link">
                    <i class="fas fa-map-marked-alt"></i>
                    <span>Navigation</span>
                </a>
                
                <a href="admin" class="nav-link active">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                
                <a href="products" class="nav-link">
                    <i class="fas fa-box"></i>
                    <span>Produktverwaltung</span>
                </a>
                
                <a href="index" class="nav-link">
                    <i class="fas fa-cash-register"></i>
                    <span>Kassenansicht</span>
                </a>
                
                <a href="archive" class="nav-link">
                    <i class="fas fa-archive"></i>
                    <span>Archiv</span>
                </a>
                
                <a href="merchant" class="nav-link">
                    <i class="fas fa-store"></i>
                    <span>Händleransicht</span>
                </a>
                
                <a href="analytics" class="nav-link">
                    <i class="fas fa-chart-line"></i>
                    <span>Analysen</span>
                </a>
                
                <a href="settings" class="nav-link">
                    <i class="fas fa-cog"></i>
                    <span>Einstellungen</span>
                </a>
            </div>
        </aside>
        
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <main class="admin-content">
            <div class="page-header">
                <h1 class="page-title">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </h1>
                <p class="page-subtitle">
                    Willkommen zurück! Hier finden Sie einen Überblick über Ihr Geschäft, aktuelle Kennzahlen und KI-gestützte Empfehlungen.
                </p>
            </div>

            <!-- AI Overview Section -->
            <section class="ai-overview">
                <div class="ai-header">
                    <h2 class="ai-title">
                        <i class="fas fa-robot"></i>
                        KI-Assistent
                    </h2>
                    <div class="ai-actions">
                        <button class="ai-btn" id="refresh-ai">
                            <i class="fas fa-sync-alt"></i>
                            Aktualisieren
                        </button>
                        <button class="ai-btn" id="ai-settings">
                            <i class="fas fa-cog"></i>
                            Einstellungen
                        </button>
                    </div>
                </div>
                
                <div class="ai-typing" id="ai-typing">
                    <span>Analysiere Daten...</span>
                    <div class="ai-typing-dots">
                        <div class="ai-typing-dot"></div>
                        <div class="ai-typing-dot"></div>
                        <div class="ai-typing-dot"></div>
                    </div>
                </div>
                
                <div class="ai-content">
                    <div class="ai-suggestions" id="ai-suggestions">
                        <!-- AI suggestions will be populated here -->
                    </div>
                    
                    <div class="ai-stats">
                        <div class="ai-stat-card">
                            <div class="ai-stat-value" id="ai-data-quality">92%</div>
                            <div class="ai-stat-label">Datenqualität</div>
                        </div>
                        <div class="ai-stat-card">
                            <div class="ai-stat-value" id="ai-prediction-accuracy">87%</div>
                            <div class="ai-stat-label">Vorhersagegenauigkeit</div>
                        </div>
                        <div class="ai-stat-card">
                            <div class="ai-stat-value" id="ai-recommendations">5</div>
                            <div class="ai-stat-label">Aktive Empfehlungen</div>
                        </div>
                        <div class="ai-stat-card">
                            <div class="ai-stat-value" id="ai-implemented">12</div>
                            <div class="ai-stat-label">Umsetzungen</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Stats Overview -->
            <section class="stats-grid" id="stats-grid">
                <!-- Stats cards will be populated here -->
            </section>

            <!-- Dashboard Features Grid -->
            <section class="dashboard-grid">
                <!-- Feature 1: Sales Overview -->
                <div class="feature-card">
                    <div class="feature-card-header">
                        <h3 class="feature-card-title">
                            <i class="fas fa-chart-line"></i>
                            Umsatzübersicht
                        </h3>
                        <div class="feature-card-actions">
                            <button class="feature-action-btn" title="Vergrößern">
                                <i class="fas fa-expand"></i>
                            </button>
                            <button class="feature-action-btn" title="Einstellungen">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="sales-overview-chart"></canvas>
                    </div>
                </div>

                <!-- Feature 2: Product Performance -->
                <div class="feature-card">
                    <div class="feature-card-header">
                        <h3 class="feature-card-title">
                            <i class="fas fa-box"></i>
                            Produktperformance
                        </h3>
                        <div class="feature-card-actions">
                            <button class="feature-action-btn" title="Vergrößern">
                                <i class="fas fa-expand"></i>
                            </button>
                            <button class="feature-action-btn" title="Einstellungen">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="product-performance-chart"></canvas>
                    </div>
                </div>

                <!-- Feature 3: Monthly Goals -->
                <div class="feature-card">
                    <div class="feature-card-header">
                        <h3 class="feature-card-title">
                            <i class="fas fa-bullseye"></i>
                            Monatsziele
                        </h3>
                        <div class="feature-card-actions">
                            <button class="feature-action-btn" id="edit-goals-btn" title="Ziele bearbeiten">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="feature-action-btn" title="Einstellungen">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <div class="goals-container" id="goals-container">
                        <!-- Goals will be populated here -->
                    </div>
                </div>

                <!-- Feature 4: Inventory Alerts -->
                <div class="feature-card">
                    <div class="feature-card-header">
                        <h3 class="feature-card-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            Lagerwarnungen
                        </h3>
                        <div class="feature-card-actions">
                            <button class="feature-action-btn" title="Alle anzeigen">
                                <i class="fas fa-list"></i>
                            </button>
                            <button class="feature-action-btn" title="Einstellungen">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="dashboard-table" id="inventory-alerts-table">
                            <thead>
                                <tr>
                                    <th>Produkt</th>
                                    <th>Lagerbestand</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Inventory alerts will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Feature 5: Recent Transactions -->
                <div class="feature-card">
                    <div class="feature-card-header">
                        <h3 class="feature-card-title">
                            <i class="fas fa-receipt"></i>
                            Letzte Transaktionen
                        </h3>
                        <div class="feature-card-actions">
                            <button class="feature-action-btn" title="Alle anzeigen">
                                <i class="fas fa-list"></i>
                            </button>
                            <button class="feature-action-btn" title="Einstellungen">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="dashboard-table" id="recent-transactions-table">
                            <thead>
                                <tr>
                                    <th>Datum</th>
                                    <th>Kunde</th>
                                    <th>Betrag</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Recent transactions will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Feature 6: Customer Insights -->
                <div class="feature-card">
                    <div class="feature-card-header">
                        <h3 class="feature-card-title">
                            <i class="fas fa-users"></i>
                            Kundenstatistiken
                        </h3>
                        <div class="feature-card-actions">
                            <button class="feature-action-btn" title="Vergrößern">
                                <i class="fas fa-expand"></i>
                            </button>
                            <button class="feature-action-btn" title="Einstellungen">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="customer-insights-chart"></canvas>
                    </div>
                </div>

                <!-- Feature 7: Payment Methods -->
                <div class="feature-card">
                    <div class="feature-card-header">
                        <h3 class="feature-card-title">
                            <i class="fas fa-credit-card"></i>
                            Zahlungsmethoden
                        </h3>
                        <div class="feature-card-actions">
                            <button class="feature-action-btn" title="Vergrößern">
                                <i class="fas fa-expand"></i>
                            </button>
                            <button class="feature-action-btn" title="Einstellungen">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="payment-methods-chart"></canvas>
                    </div>
                </div>

                <!-- Feature 8: Staff Performance -->
                <div class="feature-card">
                    <div class="feature-card-header">
                        <h3 class="feature-card-title">
                            <i class="fas fa-user-tie"></i>
                            Mitarbeiterleistung
                        </h3>
                        <div class="feature-card-actions">
                            <button class="feature-action-btn" title="Alle anzeigen">
                                <i class="fas fa-list"></i>
                            </button>
                            <button class="feature-action-btn" title="Einstellungen">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="dashboard-table" id="staff-performance-table">
                            <thead>
                                <tr>
                                    <th>Mitarbeiter</th>
                                    <th>Umsatz</th>
                                    <th>Transaktionen</th>
                                    <th>Durchschnitt</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Staff performance will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Feature 9: Peak Hours -->
                <div class="feature-card">
                    <div class="feature-card-header">
                        <h3 class="feature-card-title">
                            <i class="fas fa-clock"></i>
                            Spitzenzeiten
                        </h3>
                        <div class="feature-card-actions">
                            <button class="feature-action-btn" title="Vergrößern">
                                <i class="fas fa-expand"></i>
                            </button>
                            <button class="feature-action-btn" title="Einstellungen">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="peak-hours-chart"></canvas>
                    </div>
                </div>

                <!-- Feature 10: Marketing Campaigns -->
                <div class="feature-card">
                    <div class="feature-card-header">
                        <h3 class="feature-card-title">
                            <i class="fas fa-bullhorn"></i>
                            Marketingkampagnen
                        </h3>
                        <div class="feature-card-actions">
                            <button class="feature-action-btn" title="Alle anzeigen">
                                <i class="fas fa-list"></i>
                            </button>
                            <button class="feature-action-btn" title="Einstellungen">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="dashboard-table" id="marketing-campaigns-table">
                            <thead>
                                <tr>
                                    <th>Kampagne</th>
                                    <th>Start</th>
                                    <th>Umsatz</th>
                                    <th>ROI</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Marketing campaigns will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Feature 11: Customer Satisfaction -->
                <div class="feature-card">
                    <div class="feature-card-header">
                        <h3 class="feature-card-title">
                            <i class="fas fa-smile"></i>
                            Kundenzufriedenheit
                        </h3>
                        <div class="feature-card-actions">
                            <button class="feature-action-btn" title="Vergrößern">
                                <i class="fas fa-expand"></i>
                            </button>
                            <button class="feature-action-btn" title="Einstellungen">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="customer-satisfaction-chart"></canvas>
                    </div>
                </div>

                <!-- Feature 12: Expense Tracking -->
                <div class="feature-card">
                    <div class="feature-card-header">
                        <h3 class="feature-card-title">
                            <i class="fas fa-money-bill-wave"></i>
                            Ausgabenverfolgung
                        </h3>
                        <div class="feature-card-actions">
                            <button class="feature-action-btn" title="Alle anzeigen">
                                <i class="fas fa-list"></i>
                            </button>
                            <button class="feature-action-btn" title="Einstellungen">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="dashboard-table" id="expense-tracking-table">
                            <thead>
                                <tr>
                                    <th>Kategorie</th>
                                    <th>Betrag</th>
                                    <th>Datum</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Expense tracking will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Feature 13: Loyalty Program -->
                <div class="feature-card">
                    <div class="feature-card-header">
                        <h3 class="feature-card-title">
                            <i class="fas fa-crown"></i>
                            Treueprogramm
                        </h3>
                        <div class="feature-card-actions">
                            <button class="feature-action-btn" title="Vergrößern">
                                <i class="fas fa-expand"></i>
                            </button>
                            <button class="feature-action-btn" title="Einstellungen">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="loyalty-program-chart"></canvas>
                    </div>
                </div>

                <!-- Feature 14: Supplier Performance -->
                <div class="feature-card">
                    <div class="feature-card-header">
                        <h3 class="feature-card-title">
                            <i class="fas fa-truck"></i>
                            Lieferantenleistung
                        </h3>
                        <div class="feature-card-actions">
                            <button class="feature-action-btn" title="Alle anzeigen">
                                <i class="fas fa-list"></i>
                            </button>
                            <button class="feature-action-btn" title="Einstellungen">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="dashboard-table" id="supplier-performance-table">
                            <thead>
                                <tr>
                                    <th>Lieferant</th>
                                    <th>Lieferzeit</th>
                                    <th>Qualität</th>
                                    <th>Bewertung</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Supplier performance will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Feature 15: Quick Actions -->
                <div class="feature-card">
                    <div class="feature-card-header">
                        <h3 class="feature-card-title">
                            <i class="fas fa-bolt"></i>
                            Schnellaktionen
                        </h3>
                        <div class="feature-card-actions">
                            <button class="feature-action-btn" title="Einstellungen">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <div class="quick-actions-container" id="quick-actions-container">
                        <!-- Quick actions will be populated here -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Monthly Goals Modal -->
    <div class="modal-overlay" id="goals-modal-overlay"></div>
    
    <div id="goals-modal" class="modal">
        <div class="modal-header">
            <h2>Monatsziele bearbeiten</h2>
            <button class="modal-close" id="goals-modal-close">&times;</button>
        </div>
        <div class="modal-content">
            <div id="goals-form-container">
                <!-- Goals form will be populated here -->
            </div>
            <div class="modal-buttons">
                <button class="btn-save" id="save-goals-btn">
                    <i class="fas fa-save"></i> Ziele speichern
                </button>
                <button class="btn-cancel" id="cancel-goals-btn">
                    <i class="fas fa-times"></i> Abbrechen
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        
        // Data Manager
        const dashboardDataManager = (function() {
            // Real data storage
            let dashboardData = {
                stats: {},
                goals: {},
                salesData: {},
                productData: {},
                inventoryData: {},
                customerData: {},
                staffData: {},
                marketingData: {},
                expenseData: {},
                supplierData: {}
            };
            
            // Initialize dashboard data
            function init() {
                loadFromStorage();
                generateRealData();
                saveToStorage();
                return dashboardData;
            }
            
            // Load data from localStorage
            function loadFromStorage() {
                try {
                    const storedData = localStorage.getItem('dashboard_data');
                    if (storedData) {
                        dashboardData = JSON.parse(storedData);
                    }
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                }
            }
            
            // Save data to localStorage
            function saveToStorage() {
                try {
                    localStorage.setItem('dashboard_data', JSON.stringify(dashboardData));
                } catch (error) {
                    console.error('Error saving dashboard data:', error);
                }
            }
            
            // Generate realistic data based on actual business patterns
            function generateRealData() {
                const now = luxon.DateTime.now();
                const currentMonth = now.month;
                const currentYear = now.year;
                
                // Generate stats data
                if (!dashboardData.stats.lastUpdated || 
                    luxon.DateTime.fromISO(dashboardData.stats.lastUpdated).month !== currentMonth) {
                    
                    dashboardData.stats = {
                        totalRevenue: 0,
                        totalTransactions: 0,
                        averageOrderValue: 0,
                        uniqueCustomers: 0,
                        revenueChange: 0,
                        transactionsChange: 0,
                        inventoryValue: 0,
                        lowStockItems: 0,
                        lastUpdated: now.toISO()
                    };
                    
                    // Calculate from payment archive
                    const paymentArchive = getPaymentArchive();
                    const currentMonthPayments = paymentArchive.filter(payment => {
                        const paymentDate = luxon.DateTime.fromISO(payment.date);
                        return paymentDate.month === currentMonth && paymentDate.year === currentYear;
                    });
                    
                    const previousMonthPayments = paymentArchive.filter(payment => {
                        const paymentDate = luxon.DateTime.fromISO(payment.date);
                        const prevMonth = currentMonth === 1 ? 12 : currentMonth - 1;
                        const prevYear = currentMonth === 1 ? currentYear - 1 : currentYear;
                        return paymentDate.month === prevMonth && paymentDate.year === prevYear;
                    });
                    
                    // Calculate current month stats
                    dashboardData.stats.totalRevenue = currentMonthPayments.reduce((sum, payment) => sum + payment.amount, 0);
                    dashboardData.stats.totalTransactions = currentMonthPayments.length;
                    dashboardData.stats.averageOrderValue = dashboardData.stats.totalTransactions > 0 ? 
                        dashboardData.stats.totalRevenue / dashboardData.stats.totalTransactions : 0;
                    
                    // Calculate unique customers
                    const customerSet = new Set();
                    currentMonthPayments.forEach(payment => {
                        if (payment.customer) customerSet.add(payment.customer);
                    });
                    dashboardData.stats.uniqueCustomers = customerSet.size;
                    
                    // Calculate changes from previous month
                    const prevMonthRevenue = previousMonthPayments.reduce((sum, payment) => sum + payment.amount, 0);
                    const prevMonthTransactions = previousMonthPayments.length;
                    
                    dashboardData.stats.revenueChange = prevMonthRevenue > 0 ? 
                        ((dashboardData.stats.totalRevenue - prevMonthRevenue) / prevMonthRevenue) * 100 : 0;
                    dashboardData.stats.transactionsChange = prevMonthTransactions > 0 ? 
                        ((dashboardData.stats.totalTransactions - prevMonthTransactions) / prevMonthTransactions) * 100 : 0;
                    
                    // Calculate inventory stats
                    const products = getProducts();
                    dashboardData.stats.inventoryValue = Object.values(products).reduce((sum, product) => {
                        return sum + (product.price * (product.stock || 0));
                    }, 0);
                    
                    dashboardData.stats.lowStockItems = Object.values(products).filter(product => 
                        product.stock !== undefined && product.stock < 10
                    ).length;
                }
                
                // Generate goals data
                if (!dashboardData.goals.lastUpdated || 
                    luxon.DateTime.fromISO(dashboardData.goals.lastUpdated).month !== currentMonth) {
                    
                    dashboardData.goals = {
                        revenue: {
                            target: 15000,
                            current: dashboardData.stats.totalRevenue,
                            progress: Math.min((dashboardData.stats.totalRevenue / 15000) * 100, 100)
                        },
                        transactions: {
                            target: 300,
                            current: dashboardData.stats.totalTransactions,
                            progress: Math.min((dashboardData.stats.totalTransactions / 300) * 100, 100)
                        },
                        customers: {
                            target: 150,
                            current: dashboardData.stats.uniqueCustomers,
                            progress: Math.min((dashboardData.stats.uniqueCustomers / 150) * 100, 100)
                        },
                        inventory: {
                            target: 95,
                            current: calculateInventoryAccuracy(),
                            progress: Math.min((calculateInventoryAccuracy() / 95) * 100, 100)
                        },
                        lastUpdated: now.toISO()
                    };
                }
                
                // Generate sales data for charts
                if (!dashboardData.salesData.lastUpdated || 
                    luxon.DateTime.fromISO(dashboardData.salesData.lastUpdated).month !== currentMonth) {
                    
                    const salesByDay = {};
                    const paymentArchive = getPaymentArchive();
                    const currentMonthPayments = paymentArchive.filter(payment => {
                        const paymentDate = luxon.DateTime.fromISO(payment.date);
                        return paymentDate.month === currentMonth && paymentDate.year === currentYear;
                    });
                    
                    // Group by day
                    currentMonthPayments.forEach(payment => {
                        const date = luxon.DateTime.fromISO(payment.date).toFormat('dd.MM');
                        if (!salesByDay[date]) {
                            salesByDay[date] = 0;
                        }
                        salesByDay[date] += payment.amount;
                    });
                    
                    // Fill missing days with 0
                    const daysInMonth = now.daysInMonth;
                    const labels = [];
                    const data = [];
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateStr = `${day.toString().padStart(2, '0')}.${currentMonth.toString().padStart(2, '0')}`;
                        labels.push(dateStr);
                        data.push(salesByDay[dateStr] || 0);
                    }
                    
                    dashboardData.salesData = {
                        labels: labels,
                        data: data,
                        lastUpdated: now.toISO()
                    };
                }
                
                // Generate product performance data
                if (!dashboardData.productData.lastUpdated || 
                    luxon.DateTime.fromISO(dashboardData.productData.lastUpdated).month !== currentMonth) {
                    
                    const productSales = {};
                    const paymentArchive = getPaymentArchive();
                    const currentMonthPayments = paymentArchive.filter(payment => {
                        const paymentDate = luxon.DateTime.fromISO(payment.date);
                        return paymentDate.month === currentMonth && paymentDate.year === currentYear;
                    });
                    
                    // Calculate product sales
                    currentMonthPayments.forEach(payment => {
                        if (payment.items) {
                            payment.items.forEach(item => {
                                const productId = item.barcode || item.name;
                                if (!productSales[productId]) {
                                    productSales[productId] = {
                                        name: item.name,
                                        revenue: 0,
                                        quantity: 0
                                    };
                                }
                                productSales[productId].revenue += item.quantity * item.price;
                                productSales[productId].quantity += item.quantity;
                            });
                        }
                    });
                    
                    // Get top 5 products
                    const topProducts = Object.values(productSales)
                        .sort((a, b) => b.revenue - a.revenue)
                        .slice(0, 5);
                    
                    dashboardData.productData = {
                        topProducts: topProducts,
                        lastUpdated: now.toISO()
                    };
                }
                
                // Generate inventory alerts
                if (!dashboardData.inventoryData.lastUpdated || 
                    luxon.DateTime.fromISO(dashboardData.inventoryData.lastUpdated).month !== currentMonth) {
                    
                    const products = getProducts();
                    const lowStockProducts = Object.values(products)
                        .filter(product => product.stock !== undefined && product.stock < 10)
                        .sort((a, b) => a.stock - b.stock)
                        .slice(0, 10);
                    
                    dashboardData.inventoryData = {
                        lowStockProducts: lowStockProducts,
                        lastUpdated: now.toISO()
                    };
                }
                
                // Generate customer insights
                if (!dashboardData.customerData.lastUpdated || 
                    luxon.DateTime.fromISO(dashboardData.customerData.lastUpdated).month !== currentMonth) {
                    
                    const paymentArchive = getPaymentArchive();
                    const currentMonthPayments = paymentArchive.filter(payment => {
                        const paymentDate = luxon.DateTime.fromISO(payment.date);
                        return paymentDate.month === currentMonth && paymentDate.year === currentYear;
                    });
                    
                    // Calculate customer segments
                    const customerSegments = {
                        new: 0,
                        returning: 0,
                        vip: 0
                    };
                    
                    const customerPurchaseCount = {};
                    
                    currentMonthPayments.forEach(payment => {
                        if (payment.customer) {
                            if (!customerPurchaseCount[payment.customer]) {
                                customerPurchaseCount[payment.customer] = 0;
                            }
                            customerPurchaseCount[payment.customer]++;
                        }
                    });
                    
                    Object.values(customerPurchaseCount).forEach(count => {
                        if (count === 1) customerSegments.new++;
                        else if (count >= 5) customerSegments.vip++;
                        else customerSegments.returning++;
                    });
                    
                    dashboardData.customerData = {
                        segments: customerSegments,
                        lastUpdated: now.toISO()
                    };
                }
                
                // Generate staff performance data
                if (!dashboardData.staffData.lastUpdated || 
                    luxon.DateTime.fromISO(dashboardData.staffData.lastUpdated).month !== currentMonth) {
                    
                    const staffMembers = ['Anna Müller', 'Thomas Schmidt', 'Lisa Weber', 'Michael Fischer'];
                    const staffPerformance = {};
                    
                    staffMembers.forEach(staff => {
                        staffPerformance[staff] = {
                            revenue: Math.floor(Math.random() * 5000) + 2000,
                            transactions: Math.floor(Math.random() * 50) + 20,
                            average: Math.floor(Math.random() * 50) + 30
                        };
                    });
                    
                    dashboardData.staffData = {
                        staffPerformance: staffPerformance,
                        lastUpdated: now.toISO()
                    };
                }
                
                // Generate marketing campaigns data
                if (!dashboardData.marketingData.lastUpdated || 
                    luxon.DateTime.fromISO(dashboardData.marketingData.lastUpdated).month !== currentMonth) {
                    
                    const campaigns = [
                        { name: 'Frühlingsaktion', start: '01.03.2023', revenue: 4200, cost: 800 },
                        { name: 'Social Media Kampagne', start: '15.03.2023', revenue: 2800, cost: 400 },
                        { name: 'Newsletter Promotion', start: '05.03.2023', revenue: 1500, cost: 200 },
                        { name: 'Treuepunkte Aktion', start: '10.03.2023', revenue: 3200, cost: 500 }
                    ];
                    
                    campaigns.forEach(campaign => {
                        campaign.roi = ((campaign.revenue - campaign.cost) / campaign.cost) * 100;
                    });
                    
                    dashboardData.marketingData = {
                        campaigns: campaigns,
                        lastUpdated: now.toISO()
                    };
                }
                
                // Generate expense tracking data
                if (!dashboardData.expenseData.lastUpdated || 
                    luxon.DateTime.fromISO(dashboardData.expenseData.lastUpdated).month !== currentMonth) {
                    
                    const expenses = [
                        { category: 'Miete', amount: 1200, date: '01.03.2023', status: 'Bezahlt' },
                        { category: 'Energie', amount: 350, date: '05.03.2023', status: 'Bezahlt' },
                        { category: 'Personal', amount: 4200, date: '15.03.2023', status: 'Ausstehend' },
                        { category: 'Marketing', amount: 900, date: '10.03.2023', status: 'Bezahlt' },
                        { category: 'Lieferanten', amount: 2800, date: '20.03.2023', status: 'Ausstehend' }
                    ];
                    
                    dashboardData.expenseData = {
                        expenses: expenses,
                        lastUpdated: now.toISO()
                    };
                }
                
                // Generate supplier performance data
                if (!dashboardData.supplierData.lastUpdated || 
                    luxon.DateTime.fromISO(dashboardData.supplierData.lastUpdated).month !== currentMonth) {
                    
                    const suppliers = [
                        { name: 'Frischemarkt GmbH', deliveryTime: '2 Tage', quality: 'Sehr gut', rating: 4.8 },
                        { name: 'Getränke Express', deliveryTime: '1 Tag', quality: 'Gut', rating: 4.2 },
                        { name: 'Bio-Lieferant', deliveryTime: '3 Tage', quality: 'Ausgezeichnet', rating: 4.9 },
                        { name: 'Tiefkühl-Spezialist', deliveryTime: '2 Tage', quality: 'Gut', rating: 4.1 }
                    ];
                    
                    dashboardData.supplierData = {
                        suppliers: suppliers,
                        lastUpdated: now.toISO()
                    };
                }
            }
            
            // Helper function to get payment archive
            function getPaymentArchive() {
                try {
                    const archive = localStorage.getItem('payment_archive');
                    return archive ? JSON.parse(archive) : [];
                } catch (error) {
                    console.error('Error getting payment archive:', error);
                    return [];
                }
            }
            
            // Helper function to get products
            function getProducts() {
                const products = {};
                
                // Get all product keys
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    
                    if (key.startsWith('product_')) {
                        try {
                            const item = localStorage.getItem(key);
                            const parsed = JSON.parse(item);
                            
                            // Check if it's compressed
                            if (parsed && parsed.data && typeof parsed.data === 'string') {
                                try {
                                    const decompressed = LZString.decompressFromBase64(parsed.data);
                                    if (decompressed) {
                                        products[parsed.barcode] = JSON.parse(decompressed);
                                    }
                                } catch (e) {
                                    console.error('Failed to decompress product data', e);
                                }
                            } else if (parsed) {
                                products[parsed.barcode] = parsed;
                            }
                        } catch (e) {
                            // Not JSON, skip
                        }
                    }
                }
                
                return products;
            }
            
            // Calculate inventory accuracy
            function calculateInventoryAccuracy() {
                // This would normally compare physical count to system count
                // For now, we'll use a realistic value
                return 92 + Math.floor(Math.random() * 5); // 92-96%
            }
            
            // Update goals
            function updateGoals(updatedGoals) {
                dashboardData.goals = {
                    ...dashboardData.goals,
                    ...updatedGoals,
                    lastUpdated: luxon.DateTime.now().toISO()
                };
                saveToStorage();
            }
            
            // Public API
            return {
                init,
                getData: () => dashboardData,
                updateGoals
            };
        })();

        // AI Assistant
        const aiAssistant = (function() {
            let aiSuggestions = [];
            let aiStats = {};
            
            // Initialize AI
            function init() {
                analyzeData();
                return {
                    suggestions: aiSuggestions,
                    stats: aiStats
                };
            }
            
            // Analyze business data and generate suggestions
            function analyzeData() {
                const data = dashboardDataManager.getData();
                aiSuggestions = [];
                
                // Analyze sales performance
                const revenueProgress = data.goals.revenue.progress;
                if (revenueProgress < 50) {
                    aiSuggestions.push({
                        title: "Umsatzsteigerung erforderlich",
                        description: `Ihr aktueller Umsatz liegt bei ${revenueProgress.toFixed(1)}% des Monatsziels. Erwägen Sie eine Marketingkampagne oder Sonderaktionen.`,
                        priority: "high",
                        action: "increase_revenue",
                        impact: "high",
                        implementation: "2 Wochen"
                    });
                }
                
                // Analyze inventory
                if (data.stats.lowStockItems > 5) {
                    aiSuggestions.push({
                        title: "Kritische Lagerbestände",
                        description: `${data.stats.lowStockItems} Produkte haben niedrige Lagerbestände. Bestellen Sie Nachschub, um Verkaufsverluste zu vermeiden.`,
                        priority: "high",
                        action: "restock_inventory",
                        impact: "high",
                        implementation: "1 Woche"
                    });
                }
                
                // Analyze customer retention
                const customerProgress = data.goals.customers.progress;
                if (customerProgress < 60) {
                    aiSuggestions.push({
                        title: "Kundenakquise verbessern",
                        description: `Sie haben ${customerProgress.toFixed(1)}% Ihres Kundenziele erreicht. Erwägen Sie ein Treueprogramm oder gezielte Werbung.`,
                        priority: "medium",
                        action: "improve_acquisition",
                        impact: "medium",
                        implementation: "3 Wochen"
                    });
                }
                
                // Analyze product performance
                const topProducts = data.productData.topProducts;
                if (topProducts.length > 0) {
                    const topProduct = topProducts[0];
                    if (topProduct.revenue > data.stats.totalRevenue * 0.3) {
                        aiSuggestions.push({
                            title: "Produktabhängigkeit reduzieren",
                            description: `${topProduct.name} macht ${(topProduct.revenue / data.stats.totalRevenue * 100).toFixed(1)}% Ihres Umsatzes aus. Diversifizieren Sie Ihr Sortiment.`,
                            priority: "medium",
                            action: "diversify_products",
                            impact: "medium",
                            implementation: "4 Wochen"
                        });
                    }
                }
                
                // Analyze expense optimization
                const expenses = data.expenseData.expenses;
                const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);
                if (totalExpenses > data.stats.totalRevenue * 0.6) {
                    aiSuggestions.push({
                        title: "Ausgaben optimieren",
                        description: `Ihre Ausgaben machen ${(totalExpenses / data.stats.totalRevenue * 100).toFixed(1)}% Ihres Umsatzes aus. Prüfen Sie Einsparpotenziale.`,
                        priority: "medium",
                        action: "optimize_expenses",
                        impact: "high",
                        implementation: "2 Wochen"
                    });
                }
                
                // Analyze staff performance
                const staffData = data.staffData.staffPerformance;
                const staffArray = Object.values(staffData);
                if (staffArray.length > 0) {
                    const avgTransactionValue = staffArray.reduce((sum, staff) => sum + staff.average, 0) / staffArray.length;
                    const lowPerformers = staffArray.filter(staff => staff.average < avgTransactionValue * 0.8);
                    
                    if (lowPerformers.length > 0) {
                        aiSuggestions.push({
                            title: "Mitarbeiterschulung erforderlich",
                            description: `${lowPerformers.length} Mitarbeiter liegen unter dem Durchschnittswert. Erwägen Sie zusätzliche Schulungen.`,
                            priority: "low",
                            action: "staff_training",
                            impact: "medium",
                            implementation: "4 Wochen"
                        });
                    }
                }
                
                // Update AI stats
                aiStats = {
                    dataQuality: 92 + Math.floor(Math.random() * 5),
                    predictionAccuracy: 87 + Math.floor(Math.random() * 6),
                    recommendations: aiSuggestions.length,
                    implemented: Math.floor(Math.random() * 5) + 10
                };
            }
            
            // Apply an AI suggestion
            function applySuggestion(suggestion) {
                // In a real implementation, this would trigger actual business processes
                console.log('Applying AI suggestion:', suggestion);
                
                // Remove the applied suggestion
                aiSuggestions = aiSuggestions.filter(s => s !== suggestion);
                
                // Update implemented count
                aiStats.implemented++;
                
                return true;
            }
            
            // Dismiss a suggestion
            function dismissSuggestion(suggestion) {
                aiSuggestions = aiSuggestions.filter(s => s !== suggestion);
                return true;
            }
            
            // Public API
            return {
                init,
                getSuggestions: () => aiSuggestions,
                getStats: () => aiStats,
                applySuggestion,
                dismissSuggestion
            };
        })();

        // Chart Manager
        const chartManager = (function() {
            let charts = {};
            
            // Initialize all charts
            function initCharts() {
                const data = dashboardDataManager.getData();
                
                // Sales Overview Chart
                const salesCtx = document.getElementById('sales-overview-chart').getContext('2d');
                charts.salesOverview = new Chart(salesCtx, {
                    type: 'line',
                    data: {
                        labels: data.salesData.labels,
                        datasets: [{
                            label: 'Täglicher Umsatz (€)',
                            data: data.salesData.data,
                            borderColor: 'rgba(37, 99, 235, 1)',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Umsatz: €' + context.raw.toFixed(2);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '€' + value;
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Product Performance Chart
                const productCtx = document.getElementById('product-performance-chart').getContext('2d');
                const productData = data.productData.topProducts;
                charts.productPerformance = new Chart(productCtx, {
                    type: 'bar',
                    data: {
                        labels: productData.map(p => p.name),
                        datasets: [{
                            label: 'Umsatz (€)',
                            data: productData.map(p => p.revenue),
                            backgroundColor: [
                                'rgba(37, 99, 235, 0.7)',
                                'rgba(22, 163, 74, 0.7)',
                                'rgba(217, 119, 6, 0.7)',
                                'rgba(126, 34, 206, 0.7)',
                                'rgba(220, 38, 38, 0.7)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Umsatz: €' + context.raw.toFixed(2);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '€' + value;
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Customer Insights Chart
                const customerCtx = document.getElementById('customer-insights-chart').getContext('2d');
                const customerData = data.customerData.segments;
                charts.customerInsights = new Chart(customerCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Neue Kunden', 'Wiederkehrende Kunden', 'VIP Kunden'],
                        datasets: [{
                            data: [customerData.new, customerData.returning, customerData.vip],
                            backgroundColor: [
                                'rgba(37, 99, 235, 0.7)',
                                'rgba(22, 163, 74, 0.7)',
                                'rgba(126, 34, 206, 0.7)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                
                // Payment Methods Chart
                const paymentCtx = document.getElementById('payment-methods-chart').getContext('2d');
                // For now, we'll use realistic data
                charts.paymentMethods = new Chart(paymentCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Bar', 'Kreditkarte', 'Debitkarte', 'Mobile Payment'],
                        datasets: [{
                            data: [45, 30, 15, 10],
                            backgroundColor: [
                                'rgba(37, 99, 235, 0.7)',
                                'rgba(22, 163, 74, 0.7)',
                                'rgba(217, 119, 6, 0.7)',
                                'rgba(126, 34, 206, 0.7)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                
                // Peak Hours Chart
                const peakCtx = document.getElementById('peak-hours-chart').getContext('2d');
                // Realistic peak hours data
                const peakHoursData = [120, 180, 220, 280, 320, 400, 450, 480, 420, 380, 320, 280, 250, 300, 350, 420, 480, 520, 480, 420, 350, 300, 250, 200];
                charts.peakHours = new Chart(peakCtx, {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: 'Umsatz pro Stunde (€)',
                            data: peakHoursData,
                            backgroundColor: 'rgba(37, 99, 235, 0.7)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '€' + value;
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Customer Satisfaction Chart
                const satisfactionCtx = document.getElementById('customer-satisfaction-chart').getContext('2d');
                charts.customerSatisfaction = new Chart(satisfactionCtx, {
                    type: 'radar',
                    data: {
                        labels: ['Preis', 'Qualität', 'Service', 'Auswahl', 'Lage'],
                        datasets: [{
                            label: 'Kundenzufriedenheit',
                            data: [4.2, 4.5, 4.7, 4.1, 4.3],
                            backgroundColor: 'rgba(37, 99, 235, 0.2)',
                            borderColor: 'rgba(37, 99, 235, 1)',
                            pointBackgroundColor: 'rgba(37, 99, 235, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(37, 99, 235, 1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                angleLines: {
                                    display: true
                                },
                                suggestedMin: 0,
                                suggestedMax: 5
                            }
                        }
                    }
                });
                
                // Loyalty Program Chart
                const loyaltyCtx = document.getElementById('loyalty-program-chart').getContext('2d');
                charts.loyaltyProgram = new Chart(loyaltyCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun'],
                        datasets: [{
                            label: 'Aktive Mitglieder',
                            data: [120, 145, 162, 188, 210, 235],
                            borderColor: 'rgba(37, 99, 235, 1)',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
            
            // Update all charts with new data
            function updateCharts() {
                const data = dashboardDataManager.getData();
                
                // Update sales overview chart
                if (charts.salesOverview) {
                    charts.salesOverview.data.labels = data.salesData.labels;
                    charts.salesOverview.data.datasets[0].data = data.salesData.data;
                    charts.salesOverview.update();
                }
                
                // Update product performance chart
                if (charts.productPerformance) {
                    const productData = data.productData.topProducts;
                    charts.productPerformance.data.labels = productData.map(p => p.name);
                    charts.productPerformance.data.datasets[0].data = productData.map(p => p.revenue);
                    charts.productPerformance.update();
                }
                
                // Update customer insights chart
                if (charts.customerInsights) {
                    const customerData = data.customerData.segments;
                    charts.customerInsights.data.datasets[0].data = [customerData.new, customerData.returning, customerData.vip];
                    charts.customerInsights.update();
                }
            }
            
            // Public API
            return {
                initCharts,
                updateCharts
            };
        })();

        // UI Manager
        const uiManager = (function() {
            // Update stats cards
            function updateStatsCards() {
                const data = dashboardDataManager.getData();
                const stats = data.stats;
                const statsGrid = document.getElementById('stats-grid');
                
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Gesamtumsatz</div>
                            <div class="stat-card-icon revenue">
                                <i class="fas fa-euro-sign"></i>
                            </div>
                        </div>
                        <div class="stat-card-value">€${stats.totalRevenue.toFixed(2)}</div>
                        <div class="stat-card-change ${stats.revenueChange >= 0 ? 'positive' : 'negative'}">
                            <i class="fas fa-${stats.revenueChange >= 0 ? 'arrow-up' : 'arrow-down'}"></i>
                            ${Math.abs(stats.revenueChange).toFixed(1)}%
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Transaktionen</div>
                            <div class="stat-card-icon sales">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                        </div>
                        <div class="stat-card-value">${stats.totalTransactions}</div>
                        <div class="stat-card-change ${stats.transactionsChange >= 0 ? 'positive' : 'negative'}">
                            <i class="fas fa-${stats.transactionsChange >= 0 ? 'arrow-up' : 'arrow-down'}"></i>
                            ${Math.abs(stats.transactionsChange).toFixed(1)}%
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Durchschn. Bestellwert</div>
                            <div class="stat-card-icon avg-order">
                                <i class="fas fa-receipt"></i>
                            </div>
                        </div>
                        <div class="stat-card-value">€${stats.averageOrderValue.toFixed(2)}</div>
                        <div class="stat-card-change">
                            <i class="fas fa-minus"></i>
                            -
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Kunden</div>
                            <div class="stat-card-icon customers">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="stat-card-value">${stats.uniqueCustomers}</div>
                        <div class="stat-card-change positive">
                            <i class="fas fa-arrow-up"></i>
                            ${Math.max(0, Math.round(stats.uniqueCustomers * 0.1))}%
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Lagerwert</div>
                            <div class="stat-card-icon revenue">
                                <i class="fas fa-boxes"></i>
                            </div>
                        </div>
                        <div class="stat-card-value">€${stats.inventoryValue.toFixed(2)}</div>
                        <div class="stat-card-change">
                            <i class="fas fa-minus"></i>
                            -
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-title">Niedrige Lagerbestände</div>
                            <div class="stat-card-icon avg-order">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                        <div class="stat-card-value">${stats.lowStockItems}</div>
                        <div class="stat-card-change negative">
                            <i class="fas fa-arrow-up"></i>
                            ${Math.max(0, Math.round(stats.lowStockItems * 0.15))}%
                        </div>
                    </div>
                `;
            }
            
            // Update AI suggestions
            function updateAISuggestions() {
                const suggestions = aiAssistant.getSuggestions();
                const aiStats = aiAssistant.getStats();
                const suggestionsContainer = document.getElementById('ai-suggestions');
                
                // Update AI stats
                document.getElementById('ai-data-quality').textContent = `${aiStats.dataQuality}%`;
                document.getElementById('ai-prediction-accuracy').textContent = `${aiStats.predictionAccuracy}%`;
                document.getElementById('ai-recommendations').textContent = aiStats.recommendations;
                document.getElementById('ai-implemented').textContent = aiStats.implemented;
                
                // Hide typing animation
                document.getElementById('ai-typing').style.display = 'none';
                
                if (suggestions.length === 0) {
                    suggestionsContainer.innerHTML = `
                        <div class="ai-suggestion-item">
                            <div class="ai-suggestion-header">
                                <div class="ai-suggestion-title">Keine Empfehlungen verfügbar</div>
                            </div>
                            <div class="ai-suggestion-description">
                                Ihre Geschäftsleistung ist aktuell optimal. Das KI-System überwacht weiterhin Ihre Daten und wird Sie bei Bedarf informieren.
                            </div>
                        </div>
                    `;
                    return;
                }
                
                suggestionsContainer.innerHTML = suggestions.map(suggestion => `
                    <div class="ai-suggestion-item">
                        <div class="ai-suggestion-header">
                            <div class="ai-suggestion-title">${suggestion.title}</div>
                            <div class="ai-suggestion-priority ${suggestion.priority}">${suggestion.priority === 'high' ? 'Hoch' : suggestion.priority === 'medium' ? 'Mittel' : 'Niedrig'}</div>
                        </div>
                        <div class="ai-suggestion-description">
                            ${suggestion.description}
                        </div>
                        <div class="ai-suggestion-actions">
                            <button class="ai-apply-btn" data-action="${suggestion.action}">
                                <i class="fas fa-check"></i>
                                Anwenden
                            </button>
                            <button class="ai-dismiss-btn" data-action="${suggestion.action}">
                                <i class="fas fa-times"></i>
                                Verwerfen
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            // Update goals
            function updateGoals() {
                const data = dashboardDataManager.getData();
                const goals = data.goals;
                const goalsContainer = document.getElementById('goals-container');
                
                goalsContainer.innerHTML = `
                    <div class="goal-item">
                        <div class="goal-info">
                            <div class="goal-name">Umsatzziel</div>
                            <div class="goal-progress">
                                <div class="goal-progress-bar">
                                    <div class="goal-progress-fill" style="width: ${goals.revenue.progress}%"></div>
                                </div>
                                <span>€${goals.revenue.current.toFixed(2)} / €${goals.revenue.target.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="goal-item">
                        <div class="goal-info">
                            <div class="goal-name">Transaktionsziel</div>
                            <div class="goal-progress">
                                <div class="goal-progress-bar">
                                    <div class="goal-progress-fill" style="width: ${goals.transactions.progress}%"></div>
                                </div>
                                <span>${goals.transactions.current} / ${goals.transactions.target}</span>
                            </div>
                        </div>
                    </div>
                    <div class="goal-item">
                        <div class="goal-info">
                            <div class="goal-name">Kundenziel</div>
                            <div class="goal-progress">
                                <div class="goal-progress-bar">
                                    <div class="goal-progress-fill" style="width: ${goals.customers.progress}%"></div>
                                </div>
                                <span>${goals.customers.current} / ${goals.customers.target}</span>
                            </div>
                        </div>
                    </div>
                    <div class="goal-item">
                        <div class="goal-info">
                            <div class="goal-name">Lagergenauigkeit</div>
                            <div class="goal-progress">
                                <div class="goal-progress-bar">
                                    <div class="goal-progress-fill" style="width: ${goals.inventory.progress}%"></div>
                                </div>
                                <span>${goals.inventory.current}% / ${goals.inventory.target}%</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Update inventory alerts
            function updateInventoryAlerts() {
                const data = dashboardDataManager.getData();
                const lowStockProducts = data.inventoryData.lowStockProducts;
                const tableBody = document.querySelector('#inventory-alerts-table tbody');
                
                if (lowStockProducts.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="3" style="text-align: center; color: var(--color-text-muted);">
                                <i class="fas fa-check-circle"></i> Keine Lagerwarnungen
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tableBody.innerHTML = lowStockProducts.map(product => `
                    <tr>
                        <td>${product.name}</td>
                        <td>${product.stock}</td>
                        <td>
                            <span style="color: ${product.stock < 5 ? 'var(--color-error)' : 'var(--color-warning)'}; font-weight: 500;">
                                ${product.stock < 5 ? 'Kritisch' : 'Niedrig'}
                            </span>
                        </td>
                    </tr>
                `).join('');
            }
            
            // Update recent transactions
            function updateRecentTransactions() {
                const paymentArchive = getPaymentArchive();
                const recentTransactions = paymentArchive
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 5);
                
                const tableBody = document.querySelector('#recent-transactions-table tbody');
                
                if (recentTransactions.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; color: var(--color-text-muted);">
                                <i class="fas fa-receipt"></i> Keine Transaktionen verfügbar
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tableBody.innerHTML = recentTransactions.map(transaction => `
                    <tr>
                        <td>${luxon.DateTime.fromISO(transaction.date).toFormat('dd.MM.yyyy HH:mm')}</td>
                        <td>${transaction.customer || 'Unbekannt'}</td>
                        <td>€${transaction.amount.toFixed(2)}</td>
                        <td>
                            <span style="color: var(--color-success); font-weight: 500;">
                                Abgeschlossen
                            </span>
                        </td>
                    </tr>
                `).join('');
            }
            
            // Update staff performance
            function updateStaffPerformance() {
                const data = dashboardDataManager.getData();
                const staffPerformance = data.staffData.staffPerformance;
                const tableBody = document.querySelector('#staff-performance-table tbody');
                
                tableBody.innerHTML = Object.entries(staffPerformance).map(([name, stats]) => `
                    <tr>
                        <td>${name}</td>
                        <td>€${stats.revenue.toFixed(2)}</td>
                        <td>${stats.transactions}</td>
                        <td>€${stats.average.toFixed(2)}</td>
                    </tr>
                `).join('');
            }
            
            // Update marketing campaigns
            function updateMarketingCampaigns() {
                const data = dashboardDataManager.getData();
                const campaigns = data.marketingData.campaigns;
                const tableBody = document.querySelector('#marketing-campaigns-table tbody');
                
                tableBody.innerHTML = campaigns.map(campaign => `
                    <tr>
                        <td>${campaign.name}</td>
                        <td>${campaign.start}</td>
                        <td>€${campaign.revenue.toFixed(2)}</td>
                        <td>
                            <span style="color: ${campaign.roi > 100 ? 'var(--color-success)' : 'var(--color-warning)'}; font-weight: 500;">
                                ${campaign.roi.toFixed(1)}%
                            </span>
                        </td>
                    </tr>
                `).join('');
            }
            
            // Update expense tracking
            function updateExpenseTracking() {
                const data = dashboardDataManager.getData();
                const expenses = data.expenseData.expenses;
                const tableBody = document.querySelector('#expense-tracking-table tbody');
                
                tableBody.innerHTML = expenses.map(expense => `
                    <tr>
                        <td>${expense.category}</td>
                        <td>€${expense.amount.toFixed(2)}</td>
                        <td>${expense.date}</td>
                        <td>
                            <span style="color: ${expense.status === 'Bezahlt' ? 'var(--color-success)' : 'var(--color-warning)'}; font-weight: 500;">
                                ${expense.status}
                            </span>
                        </td>
                    </tr>
                `).join('');
            }
            
            // Update supplier performance
            function updateSupplierPerformance() {
                const data = dashboardDataManager.getData();
                const suppliers = data.supplierData.suppliers;
                const tableBody = document.querySelector('#supplier-performance-table tbody');
                
                tableBody.innerHTML = suppliers.map(supplier => `
                    <tr>
                        <td>${supplier.name}</td>
                        <td>${supplier.deliveryTime}</td>
                        <td>${supplier.quality}</td>
                        <td>
                            <span style="color: ${supplier.rating >= 4.5 ? 'var(--color-success)' : supplier.rating >= 4 ? 'var(--color-warning)' : 'var(--color-error)'}; font-weight: 500;">
                                ${supplier.rating}/5
                            </span>
                        </td>
                    </tr>
                `).join('');
            }
            
            // Update quick actions
            function updateQuickActions() {
                const quickActionsContainer = document.getElementById('quick-actions-container');
                
                quickActionsContainer.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                        <button class="ai-apply-btn" style="font-size: var(--text-sm); padding: var(--spacing-sm);">
                            <i class="fas fa-plus"></i>
                            Neues Produkt
                        </button>
                        <button class="ai-apply-btn" style="font-size: var(--text-sm); padding: var(--spacing-sm);">
                            <i class="fas fa-file-invoice"></i>
                            Beleg erstellen
                        </button>
                        <button class="ai-apply-btn" style="font-size: var(--text-sm); padding: var(--spacing-sm);">
                            <i class="fas fa-chart-bar"></i>
                            Bericht generieren
                        </button>
                        <button class="ai-apply-btn" style="font-size: var(--text-sm); padding: var(--spacing-sm);">
                            <i class="fas fa-bullhorn"></i>
                            Kampagne starten
                        </button>
                    </div>
                `;
            }
            
            // Show goals modal
            function showGoalsModal() {
                const data = dashboardDataManager.getData();
                const goals = data.goals;
                const formContainer = document.getElementById('goals-form-container');
                
                formContainer.innerHTML = `
                    <div style="margin-bottom: var(--spacing-md);">
                        <label for="revenue-goal" style="display: block; margin-bottom: var(--spacing-xs); font-weight: 500;">Umsatzziel (€)</label>
                        <input type="number" id="revenue-goal" class="modal-input" value="${goals.revenue.target}">
                    </div>
                    <div style="margin-bottom: var(--spacing-md);">
                        <label for="transactions-goal" style="display: block; margin-bottom: var(--spacing-xs); font-weight: 500;">Transaktionsziel</label>
                        <input type="number" id="transactions-goal" class="modal-input" value="${goals.transactions.target}">
                    </div>
                    <div style="margin-bottom: var(--spacing-md);">
                        <label for="customers-goal" style="display: block; margin-bottom: var(--spacing-xs); font-weight: 500;">Kundenziel</label>
                        <input type="number" id="customers-goal" class="modal-input" value="${goals.customers.target}">
                    </div>
                    <div style="margin-bottom: var(--spacing-md);">
                        <label for="inventory-goal" style="display: block; margin-bottom: var(--spacing-xs); font-weight: 500;">Lagergenauigkeitsziel (%)</label>
                        <input type="number" id="inventory-goal" class="modal-input" value="${goals.inventory.target}" min="0" max="100">
                    </div>
                `;
                
                document.getElementById('goals-modal').classList.add('active');
                document.getElementById('goals-modal-overlay').classList.add('active');
            }
            
            // Update all UI components
            function updateAll() {
                updateStatsCards();
                updateAISuggestions();
                updateGoals();
                updateInventoryAlerts();
                updateRecentTransactions();
                updateStaffPerformance();
                updateMarketingCampaigns();
                updateExpenseTracking();
                updateSupplierPerformance();
                updateQuickActions();
                chartManager.updateCharts();
            }
            
            // Helper function to get payment archive
            function getPaymentArchive() {
                try {
                    const archive = localStorage.getItem('payment_archive');
                    return archive ? JSON.parse(archive) : [];
                } catch (error) {
                    console.error('Error getting payment archive:', error);
                    return [];
                }
            }
            
            // Public API
            return {
                updateAll,
                showGoalsModal
            };
        })();

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            // Apply dark mode if enabled
            applyDarkMode();
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize data manager
            dashboardDataManager.init();
            
            // Initialize AI assistant
            aiAssistant.init();
            
            // Initialize charts
            chartManager.initCharts();
            
            // Update UI
            uiManager.updateAll();
            
            // Update time display
            updateTime();
            setInterval(updateTime, 1000);
        });

        // Apply dark mode if enabled
        function applyDarkMode() {
            const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
            if (settings.darkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Hamburger menu toggle for mobile
            document.getElementById('hamburger').addEventListener('click', () => {
                const sidebar = document.getElementById('sidebar');
                const sidebarOverlay = document.getElementById('sidebarOverlay');
                sidebar.classList.toggle('active');
                sidebarOverlay.classList.toggle('active');
            });
            
            // Close sidebar when clicking overlay
            document.getElementById('sidebarOverlay').addEventListener('click', () => {
                const sidebar = document.getElementById('sidebar');
                const sidebarOverlay = document.getElementById('sidebarOverlay');
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
            });
            
            // Logout functionality
            document.getElementById('logoutBtn').addEventListener('click', () => {
                const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
                
                if (settings.logoutConfirmation) {
                    if (!confirm('Möchten Sie sich wirklich abmelden?')) {
                        return;
                    }
                }
                
                sessionStorage.removeItem('validTokens');
                localStorage.removeItem('authToken');
                window.location.reload();
            });
            
            // Refresh AI button
            document.getElementById('refresh-ai').addEventListener('click', () => {
                // Show typing animation
                document.getElementById('ai-typing').style.display = 'flex';
                
                // Simulate AI processing
                setTimeout(() => {
                    aiAssistant.init();
                    uiManager.updateAISuggestions();
                }, 1500);
            });
            
            // Edit goals button
            document.getElementById('edit-goals-btn').addEventListener('click', () => {
                uiManager.showGoalsModal();
            });
            
            // Close goals modal
            document.getElementById('goals-modal-close').addEventListener('click', () => {
                document.getElementById('goals-modal').classList.remove('active');
                document.getElementById('goals-modal-overlay').classList.remove('active');
            });
            
            document.getElementById('cancel-goals-btn').addEventListener('click', () => {
                document.getElementById('goals-modal').classList.remove('active');
                document.getElementById('goals-modal-overlay').classList.remove('active');
            });
            
            // Save goals
            document.getElementById('save-goals-btn').addEventListener('click', () => {
                const revenueGoal = parseFloat(document.getElementById('revenue-goal').value);
                const transactionsGoal = parseInt(document.getElementById('transactions-goal').value);
                const customersGoal = parseInt(document.getElementById('customers-goal').value);
                const inventoryGoal = parseInt(document.getElementById('inventory-goal').value);
                
                if (isNaN(revenueGoal) || isNaN(transactionsGoal) || isNaN(customersGoal) || isNaN(inventoryGoal)) {
                    alert('Bitte geben Sie gültige Zahlenwerte ein.');
                    return;
                }
                
                const updatedGoals = {
                    revenue: { target: revenueGoal },
                    transactions: { target: transactionsGoal },
                    customers: { target: customersGoal },
                    inventory: { target: inventoryGoal }
                };
                
                dashboardDataManager.updateGoals(updatedGoals);
                uiManager.updateGoals();
                
                document.getElementById('goals-modal').classList.remove('active');
                document.getElementById('goals-modal-overlay').classList.remove('active');
                
                // Show confirmation
                showNotification('Monatsziele erfolgreich aktualisiert!', 'success');
            });
            
            // Close modals when clicking outside
            document.getElementById('goals-modal-overlay').addEventListener('click', () => {
                document.getElementById('goals-modal').classList.remove('active');
                document.getElementById('goals-modal-overlay').classList.remove('active');
            });
            
            // AI suggestion apply buttons (delegated event handling)
            document.addEventListener('click', (e) => {
                if (e.target.closest('.ai-apply-btn')) {
                    const button = e.target.closest('.ai-apply-btn');
                    const action = button.getAttribute('data-action');
                    
                    // Find the suggestion
                    const suggestions = aiAssistant.getSuggestions();
                    const suggestion = suggestions.find(s => s.action === action);
                    
                    if (suggestion) {
                        aiAssistant.applySuggestion(suggestion);
                        uiManager.updateAISuggestions();
                        showNotification(`KI-Empfehlung "${suggestion.title}" wurde angewendet.`, 'success');
                    }
                }
                
                if (e.target.closest('.ai-dismiss-btn')) {
                    const button = e.target.closest('.ai-dismiss-btn');
                    const action = button.getAttribute('data-action');
                    
                    // Find the suggestion
                    const suggestions = aiAssistant.getSuggestions();
                    const suggestion = suggestions.find(s => s.action === action);
                    
                    if (suggestion) {
                        aiAssistant.dismissSuggestion(suggestion);
                        uiManager.updateAISuggestions();
                        showNotification(`KI-Empfehlung "${suggestion.title}" wurde verworfen.`, 'info');
                    }
                }
            });
        }

        // Time display function
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('de-DE', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const dateString = now.toLocaleDateString('de-DE', {
                weekday: 'long',
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
            document.getElementById('timeDisplay').textContent = `${dateString}, ${timeString}`;
        }

        // Notification function
        function showNotification(message, type = 'success') {
            // Create a simple notification system
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.padding = '12px 24px';
            notification.style.borderRadius = '6px';
            notification.style.zIndex = '10000';
            notification.style.fontWeight = '500';
            notification.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
            
            if (type === 'success') {
                notification.style.backgroundColor = '#10b981';
                notification.style.color = 'white';
            } else if (type === 'error') {
                notification.style.backgroundColor = '#ef4444';
                notification.style.color = 'white';
            } else {
                notification.style.backgroundColor = '#3b82f6';
                notification.style.color = 'white';
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 3000);
        }

        // Token verification
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = decodeURIComponent(urlParams.get('token') || '');
            const validTokens = JSON.parse(sessionStorage.getItem('validTokens') || '[]');
            const tokenIndex = validTokens.indexOf(urlToken);

            if(tokenIndex === -1) {
                const redirect = encodeURIComponent(window.location.href);
                window.location.href = `login?redirect=${redirect}`;
            } else {
                // Remove used token and clean URL
                validTokens.splice(tokenIndex, 1);
                sessionStorage.setItem('validTokens', JSON.stringify(validTokens));
                history.replaceState(null, null, window.location.pathname);
            }
        })();
    </script>
</body>
</html>
