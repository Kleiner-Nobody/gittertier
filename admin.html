<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Dashboard - Gittertier Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    :root {
        --color-bg: #ffffff;
        --color-bg-secondary: #f9fafb;
        --color-text: #111111;
        --color-text-muted: #6b7280;
        --color-border: #e5e7eb;
        --color-accent: #2563eb;
        --color-accent-hover: #1d4ed8;
        --color-success: #16a34a;
        --color-success-light: #dcfce7;
        --color-success-dark: #15803d;
        --color-error: #dc2626;
        --color-warning: #d97706;
        --color-info: #2563eb;
        --color-loyalty: #7e22ce;
        --color-delivery: #22c55e;
        --color-bagging: #f97316;
        --color-donation: #3b82f6;
        --color-premium: #c5a47e;
        --color-overlay: rgba(0, 0, 0, 0.5);
        --color-ai-primary: #10b981;
        --color-ai-secondary: #a7f3d0;
        --color-ai-light: #ecfdf5;
        
        --radius: 12px;
        --radius-sm: 6px;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.07), 0 1px 2px rgba(0, 0, 0, 0.04);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --focus-ring: 0 0 0 3px rgba(37, 99, 235, 0.35);
        
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;
        --spacing-xxl: 48px;
        
        --transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
        --transition-slow: all 0.3s cubic-bezier(0.2, 0, 0, 1);
        
        --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, "Helvetica Neue", Arial, sans-serif;
        --text-xs: 0.75rem;
        --text-sm: 0.875rem;
        --text-base: 1rem;
        --text-lg: 1.125rem;
        --text-xl: 1.25rem;
        --text-2xl: 1.5rem;
        --text-3xl: 1.875rem;
        
        --header-height: 64px;
        --sidebar-width: 280px;
        --sidebar-width-collapsed: 80px;
        --touch-target: 44px;
    }

    .dark-mode {
        --color-bg: #111827;
        --color-bg-secondary: #1f2937;
        --color-text: #f3f4f6;
        --color-text-muted: #9ca3af;
        --color-border: #374151;
        --color-accent: #3b82f6;
        --color-accent-hover: #2563eb;
        --color-success: #10b981;
        --color-success-light: #064e3b;
        --color-success-dark: #047857;
        --color-error: #ef4444;
        --color-warning: #f59e0b;
        --color-info: #3b82f6;
        --color-loyalty: #a855f7;
        --color-delivery: #22c55e;
        --color-bagging: #fb923c;
        --color-donation: #60a5fa;
        --color-premium: #d6bc97;
        --color-ai-primary: #10b981;
        --color-ai-secondary: #065f46;
        --color-ai-light: #064e3b;
        --color-overlay: rgba(0, 0, 0, 0.7);
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.3), 0 1px 2px rgba(0, 0, 0, 0.2);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        -webkit-tap-highlight-color: transparent;
    }

    body {
        font-family: var(--font-family);
        background-color: var(--color-bg);
        color: var(--color-text);
        line-height: 1.5;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    /* Header Styles - Enhanced for mobile */
    .admin-header {
        height: var(--header-height);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 var(--spacing-md);
        border-bottom: 1px solid var(--color-border);
        background-color: var(--color-bg);
        position: sticky;
        top: 0;
        z-index: 50;
        min-height: var(--touch-target);
    }

    @media (max-width: 480px) {
        .admin-header {
            padding: 0 var(--spacing-sm);
        }
    }

    .logo {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        font-weight: 700;
        font-size: var(--text-xl);
        min-height: var(--touch-target);
    }

    .logo i {
        font-size: var(--text-xl);
        color: var(--color-accent);
    }

    .header-controls {
        display: flex;
        gap: var(--spacing-sm);
        align-items: center;
    }

    .time-display {
        background-color: var(--color-bg-secondary);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius);
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        min-height: var(--touch-target);
        display: flex;
        align-items: center;
    }

    .logout-btn {
        background-color: transparent;
        color: var(--color-text);
        border: 1px solid var(--color-border);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        min-height: var(--touch-target);
        min-width: var(--touch-target);
    }

    .logout-btn:hover, .logout-btn:active, .logout-btn:focus {
        background-color: var(--color-bg-secondary);
        outline: none;
    }

    .hamburger {
        display: block;
        background: transparent;
        border: none;
        font-size: var(--text-lg);
        color: var(--color-text);
        cursor: pointer;
        transition: var(--transition);
        width: var(--touch-target);
        height: var(--touch-target);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        touch-action: manipulation;
    }

    .hamburger:hover, .hamburger:active, .hamburger:focus {
        background-color: var(--color-bg-secondary);
        outline: none;
    }

    /* Main layout */
    .admin-container {
        display: flex;
        flex: 1;
    }

    /* Sidebar - Enhanced for mobile touch */
    .admin-sidebar {
        width: var(--sidebar-width);
        background-color: var(--color-bg);
        border-right: 1px solid var(--color-border);
        height: calc(100vh - var(--header-height));
        position: fixed;
        top: var(--header-height);
        left: 0;
        overflow-y: auto;
        transition: transform 0.3s ease;
        z-index: 40;
        padding: var(--spacing-lg) 0;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
    }

    .nav-container {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
        padding: 0 var(--spacing-md);
    }

    .nav-link {
        padding: var(--spacing-md);
        border-radius: var(--radius);
        text-decoration: none;
        color: var(--color-text);
        font-weight: 500;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        min-height: var(--touch-target);
        touch-action: manipulation;
    }

    .nav-link:hover, .nav-link:active, .nav-link:focus {
        background-color: var(--color-bg-secondary);
        outline: none;
    }

    .nav-link.active {
        background-color: rgba(37, 99, 235, 0.1);
        color: var(--color-accent);
    }

    .nav-link i {
        width: 24px;
        text-align: center;
        font-size: var(--text-lg);
    }

    .nav-link.active i {
        color: var(--color-accent);
    }

    .new-feature {
        background-color: var(--color-success);
        color: white;
        font-size: var(--text-xs);
        padding: 2px 8px;
        border-radius: 10px;
        margin-left: auto;
    }

    /* Sidebar overlay for mobile */
    .sidebar-overlay {
        position: fixed;
        top: var(--header-height);
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--color-overlay);
        z-index: 35;
        display: none;
        touch-action: none;
    }

    /* Main content */
    .admin-content {
        flex: 1;
        padding: var(--spacing-lg);
        margin-left: var(--sidebar-width);
        transition: margin-left 0.3s ease;
        overflow-x: hidden;
    }

    @media (max-width: 768px) {
        .admin-content {
            padding: var(--spacing-md);
        }
    }

    /* Page Header */
    .page-header {
        margin-bottom: var(--spacing-xl);
    }

    .page-title {
        font-size: var(--text-2xl);
        font-weight: 700;
        margin-bottom: var(--spacing-sm);
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        line-height: 1.2;
    }

    .page-subtitle {
        color: var(--color-text-muted);
        max-width: 600px;
        line-height: 1.4;
    }

    /* Welcome Card - Enhanced for mobile */
    .welcome-card {
        background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-hover) 100%);
        color: white;
        border-radius: var(--radius);
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-lg);
        box-shadow: var(--shadow-lg);
        position: relative;
        overflow: hidden;
    }

    .welcome-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 200%;
        background: rgba(255, 255, 255, 0.1);
        transform: rotate(30deg);
    }

    .welcome-content {
        position: relative;
        z-index: 1;
    }

    .welcome-title {
        font-size: var(--text-2xl);
        font-weight: 700;
        margin-bottom: var(--spacing-sm);
        line-height: 1.2;
    }

    .welcome-subtitle {
        opacity: 0.9;
        margin-bottom: var(--spacing-md);
        line-height: 1.4;
    }

    .welcome-actions {
        display: flex;
        gap: var(--spacing-md);
        flex-wrap: wrap;
    }

    .welcome-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: var(--spacing-md);
        border-radius: var(--radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        min-height: var(--touch-target);
        min-width: min-content;
        flex: 1;
        touch-action: manipulation;
        justify-content: center;
        text-align: center;
    }

    .welcome-btn:hover, .welcome-btn:active, .welcome-btn:focus {
        background: rgba(255, 255, 255, 0.3);
        outline: none;
        transform: translateY(-1px);
    }

    /* Stats Grid - Enhanced for mobile */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .stat-card {
        background-color: var(--color-bg);
        border-radius: var(--radius);
        border: 1px solid var(--color-border);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow);
        transition: var(--transition);
        min-height: 140px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .stat-card:hover, .stat-card:active {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .stat-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
    }

    .stat-card-title {
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        font-weight: 500;
    }

    .stat-card-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-lg);
    }

    .stat-card-icon.revenue {
        background-color: rgba(37, 99, 235, 0.1);
        color: var(--color-accent);
    }

    .stat-card-icon.sales {
        background-color: rgba(22, 163, 74, 0.1);
        color: var(--color-success);
    }

    .stat-card-icon.customers {
        background-color: rgba(126, 34, 206, 0.1);
        color: var(--color-loyalty);
    }

    .stat-card-icon.avg-order {
        background-color: rgba(217, 119, 6, 0.1);
        color: var(--color-warning);
    }

    .stat-card-value {
        font-size: var(--text-2xl);
        font-weight: 700;
        margin-bottom: var(--spacing-xs);
        line-height: 1.2;
    }

    .stat-card-change {
        font-size: var(--text-sm);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .stat-card-change.positive {
        color: var(--color-success);
    }

    .stat-card-change.negative {
        color: var(--color-error);
    }

    /* Dashboard Grid - Enhanced for mobile */
    .dashboard-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    /* Cards */
    .dashboard-card {
        background-color: var(--color-bg);
        border-radius: var(--radius);
        border: 1px solid var(--color-border);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow);
        margin-bottom: var(--spacing-lg);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
        flex-wrap: wrap;
        gap: var(--spacing-sm);
    }

    .card-title {
        font-size: var(--text-lg);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        line-height: 1.2;
    }

    .card-title i {
        color: var(--color-accent);
        font-size: var(--text-xl);
    }

    .card-actions {
        display: flex;
        gap: var(--spacing-sm);
    }

    .card-action-btn {
        background: transparent;
        border: 1px solid var(--color-border);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: var(--transition);
        color: var(--color-text-muted);
        min-height: var(--touch-target);
        min-width: var(--touch-target);
        display: flex;
        align-items: center;
        justify-content: center;
        touch-action: manipulation;
    }

    .card-action-btn:hover, .card-action-btn:active, .card-action-btn:focus {
        background-color: var(--color-bg-secondary);
        color: var(--color-text);
        outline: none;
    }

    .card-action-btn.active {
        background-color: var(--color-accent);
        color: white;
        border-color: var(--color-accent);
    }

    /* Charts */
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
        touch-action: pinch-zoom;
    }

    /* Recent Activity - Enhanced for mobile */
    .activity-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
    }

    .activity-item {
        display: flex;
        gap: var(--spacing-md);
        padding: var(--spacing-md);
        border-radius: var(--radius);
        transition: var(--transition);
        align-items: flex-start;
    }

    .activity-item:hover, .activity-item:active {
        background-color: var(--color-bg-secondary);
    }

    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-lg);
        flex-shrink: 0;
        min-width: 40px;
    }

    .activity-icon.success {
        background-color: rgba(22, 163, 74, 0.1);
        color: var(--color-success);
    }

    .activity-icon.warning {
        background-color: rgba(217, 119, 6, 0.1);
        color: var(--color-warning);
    }

    .activity-icon.info {
        background-color: rgba(37, 99, 235, 0.1);
        color: var(--color-accent);
    }

    .activity-content {
        flex: 1;
        min-width: 0;
    }

    .activity-title {
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
        line-height: 1.2;
    }

    .activity-description {
        color: var(--color-text-muted);
        font-size: var(--text-sm);
        line-height: 1.4;
    }

    .activity-time {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        margin-top: var(--spacing-xs);
    }

    /* Goals Section */
    .goals-section {
        margin-bottom: var(--spacing-xl);
    }

    .goals-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: var(--spacing-lg);
    }

    .goal-card {
        background-color: var(--color-bg);
        border-radius: var(--radius);
        border: 1px solid var(--color-border);
        padding: var(--spacing-lg);
        box-shadow: var(--shadow);
        transition: var(--transition);
        min-height: 180px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .goal-card:hover, .goal-card:active {
        box-shadow: var(--shadow-md);
    }

    .goal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
    }

    .goal-title {
        font-size: var(--text-lg);
        font-weight: 600;
        line-height: 1.2;
    }

    .goal-progress {
        height: 8px;
        background-color: var(--color-bg-secondary);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: var(--spacing-md);
        position: relative;
    }

    .goal-progress-bar {
        height: 100%;
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .goal-progress-bar.revenue {
        background-color: var(--color-accent);
    }

    .goal-progress-bar.sales {
        background-color: var(--color-success);
    }

    .goal-progress-bar.customers {
        background-color: var(--color-loyalty);
    }

    .goal-details {
        display: flex;
        justify-content: space-between;
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        flex-wrap: wrap;
        gap: var(--spacing-xs);
    }

    .goal-actions {
        display: flex;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-md);
    }

    .goal-btn {
        flex: 1;
        padding: var(--spacing-sm);
        border: none;
        border-radius: var(--radius-sm);
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        font-size: var(--text-sm);
        min-height: var(--touch-target);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-xs);
        touch-action: manipulation;
    }

    .goal-btn.edit {
        background-color: var(--color-bg-secondary);
        color: var(--color-text);
    }

    .goal-btn.edit:hover, .goal-btn.edit:active, .goal-btn.edit:focus {
        background-color: var(--color-border);
        outline: none;
    }

    .goal-btn.delete {
        background-color: rgba(220, 38, 38, 0.1);
        color: var(--color-error);
    }

    .goal-btn.delete:hover, .goal-btn.delete:active, .goal-btn.delete:focus {
        background-color: rgba(220, 38, 38, 0.2);
        outline: none;
    }

    /* Quick Actions - Enhanced for mobile touch */
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-xl);
    }

    .quick-action-btn {
        background-color: var(--color-bg);
        border: 1px solid var(--color-border);
        border-radius: var(--radius);
        padding: var(--spacing-lg);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--spacing-sm);
        cursor: pointer;
        transition: var(--transition);
        text-decoration: none;
        color: var(--color-text);
        min-height: 120px;
        touch-action: manipulation;
        justify-content: center;
    }

    .quick-action-btn:hover, .quick-action-btn:active, .quick-action-btn:focus {
        background-color: var(--color-bg-secondary);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        outline: none;
    }

    .quick-action-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-xl);
        background-color: rgba(37, 99, 235, 0.1);
        color: var(--color-accent);
    }

    .quick-action-text {
        font-weight: 600;
        text-align: center;
        line-height: 1.2;
    }

    /* AI Assistant - Enhanced for mobile */
    .ai-assistant {
        position: fixed;
        bottom: var(--spacing-lg);
        right: var(--spacing-lg);
        width: 350px;
        max-height: 500px;
        background-color: var(--color-ai-light);
        border-radius: var(--radius);
        border: 1px solid var(--color-ai-primary);
        box-shadow: var(--shadow-lg);
        z-index: 100;
        overflow: hidden;
        display: none;
        flex-direction: column;
    }

    .ai-assistant.active {
        display: flex;
        animation: slideUp 0.3s ease;
    }

    .ai-header {
        background-color: var(--color-ai-primary);
        color: white;
        padding: var(--spacing-md);
        display: flex;
        justify-content: space-between;
        align-items: center;
        min-height: var(--touch-target);
        flex-shrink: 0;
    }

    .ai-title {
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        line-height: 1.2;
    }

    .ai-close {
        background: transparent;
        border: none;
        color: white;
        cursor: pointer;
        width: var(--touch-target);
        height: var(--touch-target);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: var(--transition);
        touch-action: manipulation;
        flex-shrink: 0;
    }

    .ai-close:hover, .ai-close:active, .ai-close:focus {
        background-color: rgba(255, 255, 255, 0.2);
        outline: none;
    }

    .ai-body {
        padding: var(--spacing-md);
        overflow-y: auto;
        flex: 1;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
    }

    .ai-message {
        margin-bottom: var(--spacing-md);
        padding: var(--spacing-md);
        border-radius: var(--radius);
        font-size: var(--text-sm);
        line-height: 1.4;
        word-break: break-word;
        max-width: 85%;
    }

    .ai-message.user {
        background-color: var(--color-bg);
        margin-left: auto;
        border: 1px solid var(--color-border);
    }

    .ai-message.assistant {
        background-color: var(--color-ai-secondary);
        margin-right: auto;
    }

    .ai-typing {
        display: flex;
        gap: 4px;
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-md);
    }

    .ai-typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: var(--color-ai-primary);
        animation: typingBounce 1.4s infinite ease-in-out;
    }

    .ai-typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .ai-typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    .ai-input-container {
        display: flex;
        padding: var(--spacing-md);
        border-top: 1px solid var(--color-border);
        background-color: var(--color-bg);
        gap: var(--spacing-sm);
        flex-shrink: 0;
    }

    .ai-input {
        flex: 1;
        padding: var(--spacing-sm) var(--spacing-md);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-sm);
        font-size: var(--text-sm);
        background-color: var(--color-bg);
        color: var(--color-text);
        min-height: var(--touch-target);
        line-height: 1.4;
    }

    .ai-input:focus {
        outline: none;
        border-color: var(--color-ai-primary);
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
    }

    .ai-send {
        background-color: var(--color-ai-primary);
        color: white;
        border: none;
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: var(--transition);
        min-width: var(--touch-target);
        min-height: var(--touch-target);
        display: flex;
        align-items: center;
        justify-content: center;
        touch-action: manipulation;
        flex-shrink: 0;
    }

    .ai-send:hover, .ai-send:active, .ai-send:focus {
        background-color: var(--color-success-dark);
        outline: none;
        transform: scale(1.05);
    }

    .ai-send:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .ai-toggle {
        position: fixed;
        bottom: var(--spacing-lg);
        right: var(--spacing-lg);
        width: 60px;
        height: 60px;
        background-color: var(--color-ai-primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-xl);
        cursor: pointer;
        box-shadow: var(--shadow-lg);
        z-index: 99;
        transition: var(--transition);
        animation: pulse 2s infinite;
        touch-action: manipulation;
    }

    .ai-toggle:hover, .ai-toggle:active, .ai-toggle:focus {
        transform: scale(1.1);
        outline: none;
    }

    /* AI Quick Commands */
    .ai-quick-commands {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-xs);
        padding: var(--spacing-md);
        border-top: 1px solid var(--color-border);
        background-color: var(--color-bg-secondary);
    }

    .ai-command-btn {
        background-color: var(--color-bg);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-sm);
        padding: var(--spacing-xs) var(--spacing-sm);
        font-size: var(--text-xs);
        color: var(--color-text);
        cursor: pointer;
        transition: var(--transition);
        white-space: nowrap;
        touch-action: manipulation;
        min-height: 32px;
        display: flex;
        align-items: center;
    }

    .ai-command-btn:hover, .ai-command-btn:active, .ai-command-btn:focus {
        background-color: var(--color-bg-secondary);
        outline: none;
    }

    /* Product Performance */
    .product-performance {
        margin-bottom: var(--spacing-xl);
    }

    .product-table-container {
        overflow-x: auto;
        border-radius: var(--radius);
        border: 1px solid var(--color-border);
        -webkit-overflow-scrolling: touch;
    }

    .product-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
    }

    .product-table th,
    .product-table td {
        padding: var(--spacing-sm);
        text-align: left;
        border-bottom: 1px solid var(--color-border);
        vertical-align: middle;
    }

    .product-table th {
        font-weight: 600;
        color: var(--color-text-muted);
        background-color: var(--color-bg-secondary);
        position: sticky;
        top: 0;
        white-space: nowrap;
        min-height: var(--touch-target);
    }

    .product-table tr:last-child td {
        border-bottom: none;
    }

    .product-table tr:hover, .product-table tr:active {
        background-color: var(--color-bg-secondary);
    }

    /* Inventory Alerts */
    .inventory-alerts {
        margin-bottom: var(--spacing-xl);
    }

    .alert-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
    }

    .alert-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-md);
        border-radius: var(--radius);
        background-color: rgba(217, 119, 6, 0.1);
        border-left: 4px solid var(--color-warning);
        flex-wrap: wrap;
    }

    .alert-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-lg);
        background-color: rgba(217, 119, 6, 0.2);
        color: var(--color-warning);
        flex-shrink: 0;
    }

    .alert-content {
        flex: 1;
        min-width: 0;
    }

    .alert-title {
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
        line-height: 1.2;
    }

    .alert-description {
        color: var(--color-text-muted);
        font-size: var(--text-sm);
        line-height: 1.4;
    }

    .alert-action {
        background-color: var(--color-warning);
        color: white;
        border: none;
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-sm);
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        flex-shrink: 0;
        min-height: var(--touch-target);
        touch-action: manipulation;
    }

    .alert-action:hover, .alert-action:active, .alert-action:focus {
        background-color: #b45309;
        outline: none;
        transform: translateY(-1px);
    }

    /* Weather Widget */
    .weather-widget {
        background: linear-gradient(135deg, #67b7f7 0%, #3a8fd8 100%);
        color: white;
        border-radius: var(--radius);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
        box-shadow: var(--shadow);
    }

    .weather-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
    }

    .weather-location {
        font-weight: 600;
        line-height: 1.2;
    }

    .weather-icon {
        font-size: var(--text-2xl);
    }

    .weather-temp {
        font-size: var(--text-3xl);
        font-weight: 700;
        margin-bottom: var(--spacing-xs);
        line-height: 1;
    }

    .weather-desc {
        opacity: 0.9;
        margin-bottom: var(--spacing-md);
        line-height: 1.4;
    }

    .weather-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-sm);
        font-size: var(--text-sm);
    }

    .weather-detail {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    /* Modal Styles - Enhanced for mobile */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--color-overlay);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        display: none;
        padding: var(--spacing-md);
        -webkit-overflow-scrolling: touch;
        overflow-y: auto;
    }

    .modal-overlay.active {
        display: flex;
        animation: fadeIn 0.3s ease;
    }

    .modal {
        background-color: var(--color-bg);
        border-radius: var(--radius);
        padding: var(--spacing-xl);
        width: 100%;
        max-width: 500px;
        box-shadow: var(--shadow-lg);
        animation: scaleIn 0.3s ease;
        max-height: 90vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
    }

    .modal-title {
        font-size: var(--text-xl);
        font-weight: 600;
        line-height: 1.2;
    }

    .close-modal {
        background: transparent;
        border: none;
        font-size: var(--text-xl);
        color: var(--color-text);
        cursor: pointer;
        width: var(--touch-target);
        height: var(--touch-target);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: var(--transition);
        touch-action: manipulation;
        flex-shrink: 0;
    }

    .close-modal:hover, .close-modal:active, .close-modal:focus {
        background-color: var(--color-bg-secondary);
        outline: none;
    }

    .modal-body {
        margin-bottom: var(--spacing-lg);
    }

    .form-group {
        margin-bottom: var(--spacing-md);
    }

    .form-label {
        display: block;
        margin-bottom: var(--spacing-sm);
        font-weight: 500;
        line-height: 1.4;
    }

    .form-input {
        width: 100%;
        padding: var(--spacing-md);
        border: 1px solid var(--color-border);
        border-radius: var(--radius);
        font-size: var(--text-base);
        background-color: var(--color-bg);
        color: var(--color-text);
        transition: var(--transition);
        min-height: var(--touch-target);
        line-height: 1.4;
        -webkit-appearance: none;
        appearance: none;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: var(--focus-ring);
    }

    .form-select {
        width: 100%;
        padding: var(--spacing-md);
        border: 1px solid var(--color-border);
        border-radius: var(--radius);
        font-size: var(--text-base);
        background-color: var(--color-bg);
        color: var(--color-text);
        transition: var(--transition);
        min-height: var(--touch-target);
        line-height: 1.4;
        -webkit-appearance: none;
        appearance: none;
    }

    .form-select:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: var(--focus-ring);
    }

    .modal-footer {
        display: flex;
        gap: var(--spacing-md);
        justify-content: flex-end;
        flex-wrap: wrap;
    }

    .btn {
        padding: var(--spacing-md) var(--spacing-lg);
        border: none;
        border-radius: var(--radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        min-height: var(--touch-target);
        touch-action: manipulation;
        flex: 1;
        justify-content: center;
        text-align: center;
    }

    .btn-primary {
        background-color: var(--color-accent);
        color: white;
    }

    .btn-primary:hover, .btn-primary:active, .btn-primary:focus {
        background-color: var(--color-accent-hover);
        outline: none;
        transform: translateY(-1px);
    }

    .btn-secondary {
        background-color: var(--color-bg-secondary);
        color: var(--color-text);
        border: 1px solid var(--color-border);
    }

    .btn-secondary:hover, .btn-secondary:active, .btn-secondary:focus {
        background-color: var(--color-border);
        outline: none;
        transform: translateY(-1px);
    }

    /* Empty States */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-xl);
        text-align: center;
        color: var(--color-text-muted);
    }

    .empty-state i {
        font-size: var(--text-3xl);
        margin-bottom: var(--spacing-md);
        opacity: 0.5;
    }

    .empty-state p {
        font-size: var(--text-sm);
        line-height: 1.4;
    }

    /* Swipe to refresh indicator */
    .refresh-indicator {
        position: fixed;
        top: var(--header-height);
        left: 0;
        right: 0;
        height: 4px;
        background-color: var(--color-accent);
        transform: translateY(-100%);
        transition: transform 0.3s ease;
        z-index: 100;
    }

    .refresh-indicator.active {
        transform: translateY(0);
    }

    /* Mobile gestures */
    .mobile-gesture-area {
        position: relative;
        overflow: hidden;
    }

    /* Animations */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes scaleIn {
        from { transform: scale(0.95); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    @keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
    }

    @keyframes typingBounce {
        0%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-6px); }
    }

    /* Responsive Design - Mobile First Approach */
    @media (max-width: 1024px) {
        .admin-sidebar {
            transform: translateX(-100%);
            width: 280px;
            max-width: 85vw;
        }
        
        .admin-sidebar.active {
            transform: translateX(0);
        }
        
        .admin-content {
            margin-left: 0;
        }
        
        .sidebar-overlay.active {
            display: block;
        }

        .ai-assistant {
            width: calc(100% - var(--spacing-lg) * 2);
            right: var(--spacing-lg);
            left: var(--spacing-lg);
            bottom: 80px;
            max-height: 60vh;
        }
    }

    @media (max-width: 768px) {
        .admin-header {
            padding: 0 var(--spacing-sm);
        }
        
        .admin-content {
            padding: var(--spacing-md);
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
            gap: var(--spacing-md);
        }
        
        .dashboard-grid {
            grid-template-columns: 1fr;
            gap: var(--spacing-md);
        }
        
        .quick-actions {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--spacing-sm);
        }
        
        .goals-grid {
            grid-template-columns: 1fr;
            gap: var(--spacing-md);
        }
        
        .welcome-actions {
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        
        .welcome-btn {
            width: 100%;
            justify-content: center;
        }
        
        .ai-toggle {
            bottom: var(--spacing-md);
            right: var(--spacing-md);
            width: 56px;
            height: 56px;
        }
        
        .ai-assistant {
            bottom: 80px;
            right: var(--spacing-md);
            left: var(--spacing-md);
            width: auto;
            max-height: 70vh;
        }
        
        .time-display {
            display: none;
        }
        
        .logout-btn span {
            display: none;
        }
        
        .logout-btn {
            width: var(--touch-target);
            padding: var(--spacing-sm);
            justify-content: center;
        }
        
        .card-actions {
            width: 100%;
            justify-content: flex-start;
        }
        
        .modal {
            padding: var(--spacing-lg);
            max-height: 85vh;
        }
        
        .modal-footer {
            flex-direction: column;
        }
        
        .btn {
            width: 100%;
        }
        
        .activity-item {
            flex-direction: column;
            align-items: flex-start;
            gap: var(--spacing-sm);
        }
        
        .alert-item {
            flex-direction: column;
            align-items: flex-start;
            gap: var(--spacing-sm);
        }
        
        .alert-action {
            align-self: stretch;
            margin-top: var(--spacing-sm);
            text-align: center;
        }
        
        .welcome-card {
            padding: var(--spacing-lg);
        }
        
        .page-title {
            font-size: var(--text-xl);
        }
        
        .card-title {
            font-size: var(--text-base);
        }
    }

    @media (max-width: 480px) {
        .quick-actions {
            grid-template-columns: 1fr 1fr;
        }
        
        .ai-assistant {
            max-height: 80vh;
            bottom: 70px;
        }
        
        .ai-toggle {
            width: 50px;
            height: 50px;
            font-size: var(--text-lg);
        }
        
        .stat-card {
            padding: var(--spacing-md);
        }
        
        .dashboard-card {
            padding: var(--spacing-md);
        }
        
        .goal-card {
            padding: var(--spacing-md);
        }
        
        .welcome-title {
            font-size: var(--text-xl);
        }
        
        .weather-widget {
            padding: var(--spacing-md);
        }
    }

    /* Landscape orientation */
    @media (max-height: 600px) and (orientation: landscape) {
        .admin-sidebar {
            height: calc(100vh - var(--header-height));
            overflow-y: auto;
        }
        
        .ai-assistant {
            max-height: 50vh;
        }
        
        .welcome-card {
            padding: var(--spacing-lg);
        }
    }

    /* High-resolution displays */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
        .stat-card,
        .dashboard-card,
        .goal-card {
            border-width: 0.5px;
        }
    }

    /* Reduced motion preference */
    @media (prefers-reduced-motion: reduce) {
        * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
        
        .ai-toggle {
            animation: none;
        }
    }

    /* Dark mode support for system preference */
    @media (prefers-color-scheme: dark) {
        :root {
            --color-bg: #111827;
            --color-bg-secondary: #1f2937;
            --color-text: #f3f4f6;
            --color-text-muted: #9ca3af;
            --color-border: #374151;
        }
    }

    /* iOS specific styles */
    @supports (-webkit-touch-callout: none) {
        .admin-sidebar,
        .ai-body {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .ai-toggle {
            bottom: calc(var(--spacing-lg) + env(safe-area-inset-bottom));
        }
        
        .ai-assistant {
            bottom: calc(80px + env(safe-area-inset-bottom));
        }
    }

    /* Enhanced mobile accessibility */
    @media (hover: none) and (pointer: coarse) {
        .nav-link,
        .card-action-btn,
        .goal-btn,
        .quick-action-btn,
        .alert-action,
        .btn,
        .logout-btn,
        .hamburger,
        .ai-close,
        .ai-send,
        .ai-toggle,
        .close-modal {
            min-height: 48px;
            padding: var(--spacing-md);
        }
        
        .form-input,
        .form-select,
        .ai-input {
            font-size: 16px; /* Prevents iOS zoom */
        }
        
        .stat-card,
        .dashboard-card,
        .goal-card {
            padding: var(--spacing-md);
        }
    }

    /* Improved touch feedback */
    .touch-feedback:active {
        transform: scale(0.97);
        transition: transform 0.1s ease;
    }

    /* Better focus styles for accessibility */
    *:focus-visible {
        outline: 2px solid var(--color-accent);
        outline-offset: 2px;
    }

    /* Loading states */
    .loading {
        opacity: 0.7;
        pointer-events: none;
        position: relative;
    }

    .loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 24px;
        height: 24px;
        border: 2px solid var(--color-border);
        border-top-color: var(--color-accent);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-top: -12px;
        margin-left: -12px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Improved scrollbars */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--color-bg-secondary);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: var(--color-border);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--color-text-muted);
    }
    </style>
</head>
<body>
    <div class="refresh-indicator" id="refresh-indicator"></div>
    
    <div class="admin-header">
        <div class="logo">
            <button class="hamburger" id="hamburger" aria-label="Menü öffnen">
                <i class="fas fa-bars"></i>
            </button>
            <i class="fas fa-shopping-cart"></i>
            <span>Dashboard</span>
        </div>
        <div class="header-controls">
            <div class="time-display" id="timeDisplay"></div>
            <button class="logout-btn" id="logoutBtn" aria-label="Abmelden">
                <i class="fas fa-sign-out-alt"></i>
                <span>Abmelden</span>
            </button>
        </div>
    </div>

    <div class="admin-container">
        <aside class="admin-sidebar" id="sidebar">
            <div class="nav-container">
                <a href="control" class="nav-link">
                    <i class="fas fa-cogs"></i>
                    <span>Steuerung</span>
                    <span class="new-feature">NEU</span>
                </a>
                
                <a href="navi" class="nav-link">
                    <i class="fas fa-map-marked-alt"></i>
                    <span>Navigation</span>
                </a>
                
                <a href="admin" class="nav-link active">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                
                <a href="products" class="nav-link">
                    <i class="fas fa-box"></i>
                    <span>Produktverwaltung</span>
                </a>
                
                <a href="index" class="nav-link">
                    <i class="fas fa-cash-register"></i>
                    <span>Kassenansicht</span>
                </a>
                
                <a href="archive" class="nav-link">
                    <i class="fas fa-archive"></i>
                    <span>Archiv</span>
                </a>
                
                <a href="merchant" class="nav-link">
                    <i class="fas fa-store"></i>
                    <span>Händleransicht</span>
                </a>
                
                <a href="analytics" class="nav-link">
                    <i class="fas fa-chart-line"></i>
                    <span>Analysen</span>
                </a>
                
                <a href="settings" class="nav-link">
                    <i class="fas fa-cog"></i>
                    <span>Einstellungen</span>
                </a>
            </div>
        </aside>
        
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <main class="admin-content mobile-gesture-area" id="main-content">
            <div class="page-header">
                <h1 class="page-title">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </h1>
                <p class="page-subtitle" id="page-subtitle">
                    Willkommen zurück! Hier finden Sie einen Überblick über Ihr Geschäft und wichtige Kennzahlen.
                </p>
            </div>

            <!-- Welcome Card -->
            <div class="welcome-card">
                <div class="welcome-content">
                    <h2 class="welcome-title" id="welcome-title">Willkommen bei Gittertier Pro!</h2>
                    <p class="welcome-subtitle" id="welcome-subtitle">Heute ist ein guter Tag für Ihr Geschäft. Hier ist Ihr aktueller Status:</p>
                    <div class="welcome-actions">
                        <button class="welcome-btn touch-feedback" id="quick-sale-btn" aria-label="Schnellverkauf starten">
                            <i class="fas fa-cash-register"></i>
                            Schnellverkauf
                        </button>
                        <button class="welcome-btn touch-feedback" id="add-product-btn" aria-label="Neues Produkt hinzufügen">
                            <i class="fas fa-plus"></i>
                            Produkt hinzufügen
                        </button>
                        <button class="welcome-btn touch-feedback" id="view-reports-btn" aria-label="Berichte anzeigen">
                            <i class="fas fa-chart-bar"></i>
                            Berichte anzeigen
                        </button>
                        <button class="welcome-btn touch-feedback" id="ai-help-btn" aria-label="KI-Assistent fragen">
                            <i class="fas fa-robot"></i>
                            KI-Assistent
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid" id="stats-grid">
                <!-- Stats will be populated by JavaScript -->
            </div>

            <!-- Dashboard Grid -->
            <div class="dashboard-grid">
                <!-- Left Column -->
                <div>
                    <!-- Revenue Chart -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-chart-line"></i>
                                Umsatzentwicklung
                            </h2>
                            <div class="card-actions">
                                <button class="card-action-btn touch-feedback" id="revenue-week" aria-label="Wochenansicht">
                                    Woche
                                </button>
                                <button class="card-action-btn active touch-feedback" id="revenue-month" aria-label="Monatsansicht">
                                    Monat
                                </button>
                                <button class="card-action-btn touch-feedback" id="revenue-year" aria-label="Jahresansicht">
                                    Jahr
                                </button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="revenue-chart" role="img" aria-label="Umsatzentwicklung Diagramm"></canvas>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-clock"></i>
                                Letzte Aktivitäten
                            </h2>
                            <div class="card-actions">
                                <button class="card-action-btn touch-feedback" id="refresh-activities" aria-label="Aktivitäten aktualisieren">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                        </div>
                        <div class="activity-list" id="activity-list">
                            <!-- Activities will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Product Performance -->
                    <div class="dashboard-card product-performance">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-star"></i>
                                Produktperformance
                            </h2>
                            <div class="card-actions">
                                <button class="card-action-btn touch-feedback" id="export-products" aria-label="Produktdaten exportieren">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="card-action-btn touch-feedback" id="ai-analyze-products" aria-label="KI-Analyse der Produkte">
                                    <i class="fas fa-robot"></i>
                                </button>
                            </div>
                        </div>
                        <div class="product-table-container">
                            <table class="product-table" id="product-performance-table" role="grid" aria-label="Produktperformance Tabelle">
                                <thead>
                                    <tr>
                                        <th scope="col">Produkt</th>
                                        <th scope="col">Umsatz</th>
                                        <th scope="col">Verkäufe</th>
                                        <th scope="col">Trend</th>
                                    </tr>
                                </thead>
                                <tbody id="product-performance-body">
                                    <!-- Products will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div>
                    <!-- Goals -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-bullseye"></i>
                                Meine Ziele
                            </h2>
                            <div class="card-actions">
                                <button class="card-action-btn touch-feedback" id="add-goal-btn" aria-label="Neues Ziel hinzufügen">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="card-action-btn touch-feedback" id="ai-suggest-goals" aria-label="KI-Zielvorschläge">
                                    <i class="fas fa-lightbulb"></i>
                                </button>
                            </div>
                        </div>
                        <div class="goals-list" id="goals-list">
                            <!-- Goals will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-bolt"></i>
                                Schnellaktionen
                            </h2>
                        </div>
                        <div class="quick-actions">
                            <a href="products" class="quick-action-btn touch-feedback" aria-label="Produkte verwalten">
                                <div class="quick-action-icon">
                                    <i class="fas fa-box"></i>
                                </div>
                                <div class="quick-action-text">Produkte verwalten</div>
                            </a>
                            <a href="index" class="quick-action-btn touch-feedback" aria-label="Kasse öffnen">
                                <div class="quick-action-icon">
                                    <i class="fas fa-cash-register"></i>
                                </div>
                                <div class="quick-action-text">Kasse öffnen</div>
                            </a>
                            <a href="analytics" class="quick-action-btn touch-feedback" aria-label="Analysen anzeigen">
                                <div class="quick-action-icon">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                                <div class="quick-action-text">Analysen</div>
                            </a>
                            <button class="quick-action-btn touch-feedback" id="backup-data-btn" aria-label="Backup erstellen">
                                <div class="quick-action-icon">
                                    <i class="fas fa-download"></i>
                                </div>
                                <div class="quick-action-text">Backup erstellen</div>
                            </button>
                            <button class="quick-action-btn touch-feedback" id="ai-quick-help" aria-label="KI-Schnellhilfe">
                                <div class="quick-action-icon">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div class="quick-action-text">KI-Hilfe</div>
                            </button>
                            <button class="quick-action-btn touch-feedback" id="mobile-refresh" aria-label="Dashboard aktualisieren">
                                <div class="quick-action-icon">
                                    <i class="fas fa-sync"></i>
                                </div>
                                <div class="quick-action-text">Aktualisieren</div>
                            </button>
                        </div>
                    </div>

                    <!-- Inventory Alerts -->
                    <div class="dashboard-card inventory-alerts">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-exclamation-triangle"></i>
                                Lagerwarnungen
                            </h2>
                            <div class="card-actions">
                                <button class="card-action-btn touch-feedback" id="refresh-alerts" aria-label="Warnungen aktualisieren">
                                    <i class="fas fa-sync"></i>
                                </button>
                                <button class="card-action-btn touch-feedback" id="ai-restock-suggestions" aria-label="KI-Nachbestellvorschläge">
                                    <i class="fas fa-robot"></i>
                                </button>
                            </div>
                        </div>
                        <div class="alert-list" id="alert-list">
                            <!-- Alerts will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Weather Widget -->
                    <div class="weather-widget">
                        <div class="weather-header">
                            <div class="weather-location" id="weather-location">München</div>
                            <div class="weather-icon" id="weather-icon">
                                <i class="fas fa-sun"></i>
                            </div>
                        </div>
                        <div class="weather-temp" id="weather-temp">22°C</div>
                        <div class="weather-desc" id="weather-desc">Sonnig</div>
                        <div class="weather-details">
                            <div class="weather-detail">
                                <i class="fas fa-wind"></i>
                                <span id="weather-wind">5 km/h</span>
                            </div>
                            <div class="weather-detail">
                                <i class="fas fa-tint"></i>
                                <span id="weather-humidity">45%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Goals Section -->
            <div class="goals-section">
                <h2 style="margin-bottom: var(--spacing-lg);">Monatsziele</h2>
                <div class="goals-grid" id="goals-grid">
                    <!-- Monthly goals will be populated by JavaScript -->
                </div>
            </div>
        </main>
    </div>

    <!-- AI Assistant -->
    <div class="ai-assistant" id="ai-assistant" role="dialog" aria-label="KI-Assistent">
        <div class="ai-header">
            <div class="ai-title">
                <i class="fas fa-robot"></i>
                Gittertier Assistant
            </div>
            <button class="ai-close touch-feedback" id="ai-close" aria-label="KI-Assistent schließen">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="ai-body" id="ai-body">
            <div class="ai-message assistant">
                Hallo! Ich bin Ihr Gittertier Assistant. Ich kann Ihnen bei folgenden Aufgaben helfen:
                <br><br>
                • Umsatzanalyse und Prognosen<br>
                • Produktoptimierungsvorschläge<br>
                • Zielsetzung und Tracking<br>
                • Lagerbestandsmanagement<br>
                • Schnelle Aktionen ausführen<br>
                <br>
                Fragen Sie mich einfach!
            </div>
        </div>
        <div class="ai-quick-commands" id="ai-quick-commands">
            <button class="ai-command-btn touch-feedback" data-command="Wie ist mein aktueller Umsatz?">Umsatz anzeigen</button>
            <button class="ai-command-btn touch-feedback" data-command="Welche Produkte verkaufen sich am besten?">Top-Produkte</button>
            <button class="ai-command-btn touch-feedback" data-command="Wie kann ich meinen Umsatz steigern?">Umsatz steigern</button>
            <button class="ai-command-btn touch-feedback" data-command="Zeige mir Lagerwarnungen">Lagerwarnungen</button>
        </div>
        <div class="ai-input-container">
            <input type="text" class="ai-input" id="ai-input" placeholder="Fragen Sie mich etwas..." aria-label="KI-Assistent Eingabe">
            <button class="ai-send touch-feedback" id="ai-send" aria-label="Nachricht senden">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <div class="ai-toggle touch-feedback" id="ai-toggle" aria-label="KI-Assistent öffnen">
        <i class="fas fa-robot"></i>
    </div>

    <!-- Goal Modal -->
    <div class="modal-overlay" id="goal-modal" role="dialog" aria-labelledby="goal-modal-title" aria-hidden="true">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="goal-modal-title">Ziel hinzufügen</h2>
                <button class="close-modal touch-feedback" id="close-goal-modal" aria-label="Modal schließen">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="goal-title">Zielname</label>
                    <input type="text" class="form-input" id="goal-title" placeholder="z.B. Monatsumsatz" aria-required="true">
                </div>
                <div class="form-group">
                    <label class="form-label" for="goal-type">Zieltyp</label>
                    <select class="form-select" id="goal-type" aria-required="true">
                        <option value="revenue">Umsatz</option>
                        <option value="sales">Verkäufe</option>
                        <option value="customers">Kunden</option>
                        <option value="products">Produkte</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="goal-target">Zielwert</label>
                    <input type="number" class="form-input" id="goal-target" placeholder="z.B. 5000" aria-required="true" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label" for="goal-deadline">Frist</label>
                    <input type="date" class="form-input" id="goal-deadline" aria-required="true">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary touch-feedback" id="cancel-goal">Abbrechen</button>
                <button class="btn btn-primary touch-feedback" id="save-goal">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Quick Sale Modal -->
    <div class="modal-overlay" id="quick-sale-modal" role="dialog" aria-labelledby="quick-sale-title" aria-hidden="true">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="quick-sale-title">Schnellverkauf</h2>
                <button class="close-modal touch-feedback" id="close-quick-sale-modal" aria-label="Modal schließen">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="sale-product">Produkt</label>
                    <select class="form-select" id="sale-product" aria-required="true">
                        <!-- Products will be populated by JavaScript -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="sale-quantity">Menge</label>
                    <input type="number" class="form-input" id="sale-quantity" value="1" min="1" aria-required="true">
                </div>
                <div class="form-group">
                    <label class="form-label" for="sale-price">Preis (€)</label>
                    <input type="number" class="form-input" id="sale-price" step="0.01" placeholder="0.00" aria-required="true">
                </div>
                <div class="form-group">
                    <label class="form-label" for="sale-customer">Kunde (optional)</label>
                    <input type="text" class="form-input" id="sale-customer" placeholder="Kundenname">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary touch-feedback" id="cancel-quick-sale">Abbrechen</button>
                <button class="btn btn-primary touch-feedback" id="complete-quick-sale">Verkauf abschließen</button>
            </div>
        </div>
    </div>

    <!-- AI Analysis Modal -->
    <div class="modal-overlay" id="ai-analysis-modal" role="dialog" aria-labelledby="ai-analysis-title" aria-hidden="true">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="ai-analysis-title">KI-Analyse</h2>
                <button class="close-modal touch-feedback" id="close-ai-analysis-modal" aria-label="Modal schließen">&times;</button>
            </div>
            <div class="modal-body">
                <div id="ai-analysis-content">
                    <!-- AI Analysis content will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary touch-feedback" id="close-analysis-btn">Schließen</button>
                <button class="btn btn-primary touch-feedback" id="apply-analysis-btn" style="display: none;">Vorschlag anwenden</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize jsPDF
        const { jsPDF } = window.jspdf;

        // Enhanced Dashboard Manager with complete functionality
        const dashboardManager = (function() {
            let receipts = [];
            let products = {};
            let merchantInfo = {};
            let goals = [];
            let activities = [];
            let currentEditingGoal = null;
            let aiContext = [];
            let mobileGestureState = { startY: 0, isRefreshing: false, startX: 0, isSwiping: false };

            // Initialize dashboard
            async function init() {
                try {
                    // Load data from localStorage
                    receipts = getReceipts();
                    products = getProducts();
                    merchantInfo = getMerchantInfo();
                    goals = getGoals();
                    activities = getActivities();
                    aiContext = getAIContext();

                    // Initialize default goals if none exist
                    if (goals.length === 0) {
                        initDefaultGoals();
                    }

                    // Initialize default activities if none exist
                    if (activities.length === 0) {
                        initDefaultActivities();
                    }

                    // Initialize AI context if empty
                    if (aiContext.length === 0) {
                        aiContext.push({
                            role: 'system',
                            content: 'Du bist ein hilfreicher KI-Assistent für das Gittertier Pro Dashboard. Du hilfst bei der Analyse von Umsatzdaten, Produktperformance, Zielsetzung und Lagerbestandsmanagement. Du kannst auch schnelle Aktionen auslösen.'
                        });
                        saveAIContext(aiContext);
                    }

                    // Initialize mobile gesture detection
                    initMobileGestures();

                    // Initialize goal progress
                    updateGoalProgress();

                    return {
                        receipts,
                        products,
                        merchantInfo,
                        goals,
                        activities,
                        aiContext
                    };
                } catch (error) {
                    console.error('Dashboard initialization failed:', error);
                    showNotification('Fehler beim Initialisieren des Dashboards', 'error');
                    return {
                        receipts: [],
                        products: {},
                        merchantInfo: {},
                        goals: [],
                        activities: [],
                        aiContext: []
                    };
                }
            }

            // Initialize mobile gesture detection
            function initMobileGestures() {
                const mainContent = document.getElementById('main-content');
                if (!mainContent) return;

                // Pull to refresh
                mainContent.addEventListener('touchstart', function(e) {
                    if (window.innerWidth <= 768 && e.touches.length === 1 && !mobileGestureState.isRefreshing) {
                        const touch = e.touches[0];
                        mobileGestureState.startY = touch.clientY;
                        mobileGestureState.startX = touch.clientX;
                        mobileGestureState.isRefreshing = false;
                        mobileGestureState.isSwiping = false;
                    }
                }, { passive: true });

                mainContent.addEventListener('touchmove', function(e) {
                    if (window.innerWidth <= 768 && e.touches.length === 1 && !mobileGestureState.isRefreshing) {
                        const touch = e.touches[0];
                        const deltaY = touch.clientY - mobileGestureState.startY;
                        const deltaX = touch.clientX - mobileGestureState.startX;
                        
                        // Check if it's mostly vertical swipe (pull to refresh)
                        if (Math.abs(deltaY) > Math.abs(deltaX) && deltaY > 50 && window.scrollY === 0) {
                            e.preventDefault();
                            mobileGestureState.isRefreshing = true;
                            triggerRefresh();
                        }
                    }
                }, { passive: false });

                mainContent.addEventListener('touchend', function() {
                    mobileGestureState.startY = 0;
                    mobileGestureState.startX = 0;
                }, { passive: true });

                // Swipe to open sidebar
                document.addEventListener('touchstart', function(e) {
                    if (window.innerWidth <= 768 && e.touches.length === 1) {
                        mobileGestureState.startX = e.touches[0].clientX;
                        mobileGestureState.startY = e.touches[0].clientY;
                    }
                }, { passive: true });

                document.addEventListener('touchend', function(e) {
                    if (window.innerWidth <= 768 && e.changedTouches.length === 1) {
                        const endX = e.changedTouches[0].clientX;
                        const endY = e.changedTouches[0].clientY;
                        const deltaX = endX - mobileGestureState.startX;
                        const deltaY = endY - mobileGestureState.startY;
                        
                        // Check for horizontal swipe (not vertical)
                        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
                            // Swipe right from left edge to open sidebar
                            if (deltaX > 0 && mobileGestureState.startX < 50) {
                                document.getElementById('sidebar').classList.add('active');
                                document.getElementById('sidebarOverlay').classList.add('active');
                            }
                            // Swipe left to close sidebar
                            else if (deltaX < 0 && mobileGestureState.startX > 50) {
                                document.getElementById('sidebar').classList.remove('active');
                                document.getElementById('sidebarOverlay').classList.remove('active');
                            }
                        }
                    }
                }, { passive: true });
            }

            // Trigger refresh with visual feedback
            function triggerRefresh() {
                const refreshIndicator = document.getElementById('refresh-indicator');
                if (refreshIndicator) {
                    refreshIndicator.classList.add('active');
                    
                    // Simulate refresh delay
                    setTimeout(() => {
                        refreshIndicator.classList.remove('active');
                        updateAllData();
                        addActivity({
                            type: 'info',
                            title: 'Dashboard aktualisiert',
                            description: 'Alle Daten wurden aktualisiert.'
                        });
                        showNotification('Dashboard aktualisiert', 'success');
                    }, 1000);
                }
            }

            // Update all data
            function updateAllData() {
                try {
                    receipts = getReceipts();
                    products = getProducts();
                    goals = getGoals();
                    activities = getActivities();
                    
                    // Update goal progress
                    updateGoalProgress();
                    
                    return true;
                } catch (error) {
                    console.error('Error updating data:', error);
                    showNotification('Fehler beim Aktualisieren der Daten', 'error');
                    return false;
                }
            }

            // Get receipts from localStorage
            function getReceipts() {
                try {
                    const archive = localStorage.getItem('payment_archive');
                    if (!archive) return [];
                    
                    const parsed = JSON.parse(archive);
                    if (!Array.isArray(parsed)) return [];
                    
                    return parsed.map(receipt => ({
                        ...receipt,
                        date: receipt.date || new Date().toISOString(),
                        amount: parseFloat(receipt.amount) || 0,
                        items: Array.isArray(receipt.items) ? receipt.items.map(item => ({
                            ...item,
                            quantity: parseInt(item.quantity) || 1,
                            price: parseFloat(item.price) || 0
                        })) : []
                    }));
                } catch (error) {
                    console.error('Failed to get payment archive:', error);
                    return [];
                }
            }

            // Get products from localStorage
            function getProducts() {
                const products = {};
                
                try {
                    // Get all product keys
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        
                        if (key.startsWith('product_')) {
                            try {
                                const item = localStorage.getItem(key);
                                if (!item) continue;
                                
                                const parsed = JSON.parse(item);
                                
                                // Check if it's compressed
                                if (parsed && parsed.data && typeof parsed.data === 'string') {
                                    try {
                                        const decompressed = LZString.decompressFromBase64(parsed.data);
                                        if (decompressed) {
                                            const productData = JSON.parse(decompressed);
                                            if (productData.barcode) {
                                                products[productData.barcode] = productData;
                                            }
                                        }
                                    } catch (e) {
                                        console.error('Failed to decompress product data', e);
                                        // Try to use as regular product if possible
                                        if (parsed.barcode) {
                                            products[parsed.barcode] = parsed;
                                        }
                                    }
                                } else if (parsed && parsed.barcode) {
                                    products[parsed.barcode] = parsed;
                                }
                            } catch (e) {
                                console.error('Error parsing product data:', e);
                                continue;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error getting products:', error);
                }
                
                return products;
            }

            // Get merchant info from localStorage
            function getMerchantInfo() {
                try {
                    const merchantInfo = localStorage.getItem('merchant_info');
                    return merchantInfo ? JSON.parse(merchantInfo) : { name: 'Ihr Geschäft' };
                } catch (e) {
                    console.error('Error getting merchant info:', e);
                    return { name: 'Ihr Geschäft' };
                }
            }

            // Get goals from localStorage
            function getGoals() {
                try {
                    const goals = localStorage.getItem('dashboard_goals');
                    if (!goals) return [];
                    
                    const parsed = JSON.parse(goals);
                    if (!Array.isArray(parsed)) return [];
                    
                    return parsed.map(goal => ({
                        ...goal,
                        target: parseFloat(goal.target) || 0,
                        current: parseFloat(goal.current) || 0,
                        deadline: goal.deadline || new Date().toISOString().split('T')[0]
                    }));
                } catch (e) {
                    console.error('Error getting goals:', e);
                    return [];
                }
            }

            // Save goals to localStorage
            function saveGoals(goals) {
                try {
                    localStorage.setItem('dashboard_goals', JSON.stringify(goals));
                    return true;
                } catch (e) {
                    console.error('Error saving goals:', e);
                    showNotification('Fehler beim Speichern der Ziele', 'error');
                    return false;
                }
            }

            // Get activities from localStorage
            function getActivities() {
                try {
                    const activities = localStorage.getItem('dashboard_activities');
                    if (!activities) return [];
                    
                    const parsed = JSON.parse(activities);
                    if (!Array.isArray(parsed)) return [];
                    
                    return parsed.map(activity => ({
                        ...activity,
                        time: activity.time || new Date().toISOString(),
                        read: activity.read || false
                    }));
                } catch (e) {
                    console.error('Error getting activities:', e);
                    return [];
                }
            }

            // Save activities to localStorage
            function saveActivities(activities) {
                try {
                    localStorage.setItem('dashboard_activities', JSON.stringify(activities));
                    return true;
                } catch (e) {
                    console.error('Error saving activities:', e);
                    return false;
                }
            }

            // Get AI context from localStorage
            function getAIContext() {
                try {
                    const context = localStorage.getItem('ai_context');
                    return context ? JSON.parse(context) : [];
                } catch (e) {
                    console.error('Error getting AI context:', e);
                    return [];
                }
            }

            // Save AI context to localStorage
            function saveAIContext(context) {
                try {
                    // Keep only last 20 messages to prevent localStorage overflow
                    if (context.length > 20) {
                        context = context.slice(-20);
                    }
                    localStorage.setItem('ai_context', JSON.stringify(context));
                    return true;
                } catch (e) {
                    console.error('Error saving AI context:', e);
                    return false;
                }
            }

            // Initialize default goals
            function initDefaultGoals() {
                try {
                    const currentDate = new Date();
                    const currentMonth = currentDate.getMonth();
                    const currentYear = currentDate.getFullYear();
                    const lastDay = new Date(currentYear, currentMonth + 1, 0).getDate();
                    
                    goals = [
                        {
                            id: 'goal-' + Date.now(),
                            title: 'Monatsumsatz',
                            type: 'revenue',
                            target: 5000,
                            current: 0,
                            deadline: `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${lastDay}`,
                            createdAt: new Date().toISOString(),
                            aiSuggested: false
                        },
                        {
                            id: 'goal-' + (Date.now() + 1),
                            title: 'Verkäufe diesen Monat',
                            type: 'sales',
                            target: 100,
                            current: 0,
                            deadline: `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${lastDay}`,
                            createdAt: new Date().toISOString(),
                            aiSuggested: false
                        },
                        {
                            id: 'goal-' + (Date.now() + 2),
                            title: 'Neue Kunden',
                            type: 'customers',
                            target: 25,
                            current: 0,
                            deadline: `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${lastDay}`,
                            createdAt: new Date().toISOString(),
                            aiSuggested: false
                        }
                    ];
                    
                    saveGoals(goals);
                    return goals;
                } catch (error) {
                    console.error('Error initializing default goals:', error);
                    return [];
                }
            }

            // Initialize default activities
            function initDefaultActivities() {
                try {
                    const currentDate = new Date();
                    
                    activities = [
                        {
                            id: 'activity-' + Date.now(),
                            type: 'info',
                            title: 'Willkommen bei Gittertier Pro!',
                            description: 'Ihr Dashboard wurde eingerichtet. Beginnen Sie mit dem Hinzufügen von Produkten.',
                            time: currentDate.toISOString(),
                            read: false
                        },
                        {
                            id: 'activity-' + (Date.now() + 1),
                            type: 'success',
                            title: 'Erstes Ziel festgelegt',
                            description: 'Sie haben Ihr erstes Umsatzziel für diesen Monat festgelegt.',
                            time: new Date(currentDate.getTime() - 10 * 60 * 1000).toISOString(),
                            read: false
                        }
                    ];
                    
                    saveActivities(activities);
                    return activities;
                } catch (error) {
                    console.error('Error initializing default activities:', error);
                    return [];
                }
            }

            // Get sales statistics
            function getSalesStats() {
                try {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    const thisWeek = new Date(today);
                    thisWeek.setDate(thisWeek.getDate() - today.getDay());
                    
                    const thisMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    
                    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    
                    // Filter receipts by date
                    const todayReceipts = receipts.filter(receipt => {
                        try {
                            const receiptDate = new Date(receipt.date);
                            return receiptDate >= today;
                        } catch (e) {
                            return false;
                        }
                    });
                    
                    const yesterdayReceipts = receipts.filter(receipt => {
                        try {
                            const receiptDate = new Date(receipt.date);
                            return receiptDate >= yesterday && receiptDate < today;
                        } catch (e) {
                            return false;
                        }
                    });
                    
                    const thisWeekReceipts = receipts.filter(receipt => {
                        try {
                            const receiptDate = new Date(receipt.date);
                            return receiptDate >= thisWeek;
                        } catch (e) {
                            return false;
                        }
                    });
                    
                    const thisMonthReceipts = receipts.filter(receipt => {
                        try {
                            const receiptDate = new Date(receipt.date);
                            return receiptDate >= thisMonth;
                        } catch (e) {
                            return false;
                        }
                    });
                    
                    const lastMonthReceipts = receipts.filter(receipt => {
                        try {
                            const receiptDate = new Date(receipt.date);
                            return receiptDate >= lastMonth && receiptDate < thisMonth;
                        } catch (e) {
                            return false;
                        }
                    });
                    
                    // Calculate totals
                    const todayRevenue = todayReceipts.reduce((sum, receipt) => sum + (receipt.amount || 0), 0);
                    const yesterdayRevenue = yesterdayReceipts.reduce((sum, receipt) => sum + (receipt.amount || 0), 0);
                    const thisWeekRevenue = thisWeekReceipts.reduce((sum, receipt) => sum + (receipt.amount || 0), 0);
                    const thisMonthRevenue = thisMonthReceipts.reduce((sum, receipt) => sum + (receipt.amount || 0), 0);
                    const lastMonthRevenue = lastMonthReceipts.reduce((sum, receipt) => sum + (receipt.amount || 0), 0);
                    
                    const todayTransactions = todayReceipts.length;
                    const yesterdayTransactions = yesterdayReceipts.length;
                    const thisWeekTransactions = thisWeekReceipts.length;
                    const thisMonthTransactions = thisMonthReceipts.length;
                    const lastMonthTransactions = lastMonthReceipts.length;
                    
                    // Calculate unique customers
                    const todayCustomers = [...new Set(todayReceipts.map(r => r.customer).filter(Boolean))].length;
                    const yesterdayCustomers = [...new Set(yesterdayReceipts.map(r => r.customer).filter(Boolean))].length;
                    const thisWeekCustomers = [...new Set(thisWeekReceipts.map(r => r.customer).filter(Boolean))].length;
                    const thisMonthCustomers = [...new Set(thisMonthReceipts.map(r => r.customer).filter(Boolean))].length;
                    const lastMonthCustomers = [...new Set(lastMonthReceipts.map(r => r.customer).filter(Boolean))].length;
                    
                    // Calculate average order values
                    const todayAvgOrder = todayTransactions > 0 ? todayRevenue / todayTransactions : 0;
                    const yesterdayAvgOrder = yesterdayTransactions > 0 ? yesterdayRevenue / yesterdayTransactions : 0;
                    const thisWeekAvgOrder = thisWeekTransactions > 0 ? thisWeekRevenue / thisWeekTransactions : 0;
                    const thisMonthAvgOrder = thisMonthTransactions > 0 ? thisMonthRevenue / thisMonthTransactions : 0;
                    const lastMonthAvgOrder = lastMonthTransactions > 0 ? lastMonthRevenue / lastMonthTransactions : 0;
                    
                    // Calculate changes
                    const revenueChange = yesterdayRevenue > 0 ? ((todayRevenue - yesterdayRevenue) / yesterdayRevenue) * 100 : todayRevenue > 0 ? 100 : 0;
                    const transactionsChange = yesterdayTransactions > 0 ? ((todayTransactions - yesterdayTransactions) / yesterdayTransactions) * 100 : todayTransactions > 0 ? 100 : 0;
                    const customersChange = yesterdayCustomers > 0 ? ((todayCustomers - yesterdayCustomers) / yesterdayCustomers) * 100 : todayCustomers > 0 ? 100 : 0;
                    const avgOrderChange = yesterdayAvgOrder > 0 ? ((todayAvgOrder - yesterdayAvgOrder) / yesterdayAvgOrder) * 100 : todayAvgOrder > 0 ? 100 : 0;
                    
                    // Monthly comparison
                    const monthlyRevenueChange = lastMonthRevenue > 0 ? ((thisMonthRevenue - lastMonthRevenue) / lastMonthRevenue) * 100 : thisMonthRevenue > 0 ? 100 : 0;
                    const monthlyTransactionsChange = lastMonthTransactions > 0 ? ((thisMonthTransactions - lastMonthTransactions) / lastMonthTransactions) * 100 : thisMonthTransactions > 0 ? 100 : 0;
                    
                    return {
                        today: {
                            revenue: todayRevenue,
                            transactions: todayTransactions,
                            customers: todayCustomers,
                            avgOrder: todayAvgOrder
                        },
                        yesterday: {
                            revenue: yesterdayRevenue,
                            transactions: yesterdayTransactions,
                            customers: yesterdayCustomers,
                            avgOrder: yesterdayAvgOrder
                        },
                        thisWeek: {
                            revenue: thisWeekRevenue,
                            transactions: thisWeekTransactions,
                            customers: thisWeekCustomers,
                            avgOrder: thisWeekAvgOrder
                        },
                        thisMonth: {
                            revenue: thisMonthRevenue,
                            transactions: thisMonthTransactions,
                            customers: thisMonthCustomers,
                            avgOrder: thisMonthAvgOrder
                        },
                        changes: {
                            revenue: revenueChange,
                            transactions: transactionsChange,
                            customers: customersChange,
                            avgOrder: avgOrderChange,
                            monthlyRevenue: monthlyRevenueChange,
                            monthlyTransactions: monthlyTransactionsChange
                        }
                    };
                } catch (error) {
                    console.error('Error calculating sales stats:', error);
                    return {
                        today: { revenue: 0, transactions: 0, customers: 0, avgOrder: 0 },
                        yesterday: { revenue: 0, transactions: 0, customers: 0, avgOrder: 0 },
                        thisWeek: { revenue: 0, transactions: 0, customers: 0, avgOrder: 0 },
                        thisMonth: { revenue: 0, transactions: 0, customers: 0, avgOrder: 0 },
                        changes: { revenue: 0, transactions: 0, customers: 0, avgOrder: 0, monthlyRevenue: 0, monthlyTransactions: 0 }
                    };
                }
            }

            // Get revenue by day for chart
            function getRevenueByDay(days = 30) {
                try {
                    const revenueByDay = {};
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    
                    // Initialize last X days with 0 revenue
                    for (let i = days - 1; i >= 0; i--) {
                        const date = new Date(today);
                        date.setDate(date.getDate() - i);
                        const dateString = date.toISOString().split('T')[0];
                        revenueByDay[dateString] = 0;
                    }
                    
                    // Fill with actual revenue data
                    receipts.forEach(receipt => {
                        try {
                            const receiptDate = new Date(receipt.date);
                            const dateString = receiptDate.toISOString().split('T')[0];
                            
                            if (revenueByDay.hasOwnProperty(dateString)) {
                                revenueByDay[dateString] += (receipt.amount || 0);
                            }
                        } catch (e) {
                            console.error('Error processing receipt date:', e);
                        }
                    });
                    
                    // Convert to arrays for chart
                    const labels = Object.keys(revenueByDay).map(date => {
                        try {
                            const d = new Date(date);
                            return `${d.getDate()}.${d.getMonth() + 1}.`;
                        } catch (e) {
                            return date;
                        }
                    });
                    
                    const data = Object.values(revenueByDay);
                    
                    return {
                        labels,
                        data
                    };
                } catch (error) {
                    console.error('Error getting revenue by day:', error);
                    return { labels: [], data: [] };
                }
            }

            // Get product performance
            function getProductPerformance(limit = 10) {
                try {
                    const productSales = {};
                    
                    receipts.forEach(receipt => {
                        if (receipt.items && Array.isArray(receipt.items)) {
                            receipt.items.forEach(item => {
                                const productId = item.barcode || item.name;
                                if (!productSales[productId]) {
                                    productSales[productId] = {
                                        name: item.name || 'Unbekanntes Produkt',
                                        revenue: 0,
                                        quantity: 0,
                                        price: item.price || 0,
                                        barcode: item.barcode
                                    };
                                }
                                productSales[productId].revenue += (item.quantity || 1) * (item.price || 0);
                                productSales[productId].quantity += (item.quantity || 1);
                            });
                        }
                    });
                    
                    // Convert to array and sort by revenue
                    return Object.values(productSales)
                        .sort((a, b) => b.revenue - a.revenue)
                        .slice(0, limit);
                } catch (error) {
                    console.error('Error getting product performance:', error);
                    return [];
                }
            }

            // Get inventory alerts
            function getInventoryAlerts() {
                try {
                    const alerts = [];
                    const lowStockThreshold = 10;
                    const criticalStockThreshold = 3;
                    
                    Object.values(products).forEach(product => {
                        if (product && product.stock !== undefined && product.stock !== null) {
                            const stock = parseInt(product.stock);
                            if (isNaN(stock)) return;
                            
                            if (stock <= criticalStockThreshold) {
                                alerts.push({
                                    id: `alert-critical-${product.barcode || product.name}`,
                                    title: 'Kritischer Lagerbestand',
                                    description: `${product.name || 'Unbekanntes Produkt'} hat nur noch ${stock} Einheiten auf Lager.`,
                                    product: product,
                                    severity: 'critical'
                                });
                            } else if (stock <= lowStockThreshold) {
                                alerts.push({
                                    id: `alert-low-${product.barcode || product.name}`,
                                    title: 'Niedriger Lagerbestand',
                                    description: `${product.name || 'Unbekanntes Produkt'} hat nur noch ${stock} Einheiten auf Lager.`,
                                    product: product,
                                    severity: 'warning'
                                });
                            }
                        }
                    });
                    
                    // Sort by severity (critical first)
                    return alerts.sort((a, b) => {
                        if (a.severity === 'critical' && b.severity !== 'critical') return -1;
                        if (b.severity === 'critical' && a.severity !== 'critical') return 1;
                        return 0;
                    });
                } catch (error) {
                    console.error('Error getting inventory alerts:', error);
                    return [];
                }
            }

            // Add a new goal
            function addGoal(goal) {
                try {
                    goal.id = `goal-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    goal.createdAt = new Date().toISOString();
                    goal.current = goal.current || 0;
                    goal.aiSuggested = goal.aiSuggested || false;
                    
                    goals.push(goal);
                    const success = saveGoals(goals);
                    
                    if (success) {
                        // Add activity
                        addActivity({
                            type: 'success',
                            title: 'Neues Ziel hinzugefügt',
                            description: `Ziel "${goal.title}" wurde hinzugefügt.`
                        });
                        
                        return goal;
                    }
                    return null;
                } catch (error) {
                    console.error('Error adding goal:', error);
                    showNotification('Fehler beim Hinzufügen des Ziels', 'error');
                    return null;
                }
            }

            // Update a goal
            function updateGoal(goalId, updates) {
                try {
                    const goalIndex = goals.findIndex(g => g.id === goalId);
                    
                    if (goalIndex !== -1) {
                        goals[goalIndex] = { ...goals[goalIndex], ...updates };
                        const success = saveGoals(goals);
                        
                        if (success) {
                            // Add activity
                            addActivity({
                                type: 'info',
                                title: 'Ziel aktualisiert',
                                description: `Ziel "${goals[goalIndex].title}" wurde aktualisiert.`
                            });
                            
                            return goals[goalIndex];
                        }
                    }
                    
                    return null;
                } catch (error) {
                    console.error('Error updating goal:', error);
                    showNotification('Fehler beim Aktualisieren des Ziels', 'error');
                    return null;
                }
            }

            // Delete a goal
            function deleteGoal(goalId) {
                try {
                    const goalIndex = goals.findIndex(g => g.id === goalId);
                    
                    if (goalIndex !== -1) {
                        const deletedGoal = goals[goalIndex];
                        goals.splice(goalIndex, 1);
                        const success = saveGoals(goals);
                        
                        if (success) {
                            // Add activity
                            addActivity({
                                type: 'warning',
                                title: 'Ziel gelöscht',
                                description: `Ziel "${deletedGoal.title}" wurde gelöscht.`
                            });
                            
                            return true;
                        }
                    }
                    
                    return false;
                } catch (error) {
                    console.error('Error deleting goal:', error);
                    showNotification('Fehler beim Löschen des Ziels', 'error');
                    return false;
                }
            }

            // Add an activity
            function addActivity(activity) {
                try {
                    activity.id = `activity-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    activity.time = new Date().toISOString();
                    activity.read = false;
                    
                    activities.unshift(activity);
                    
                    // Keep only the last 50 activities
                    if (activities.length > 50) {
                        activities = activities.slice(0, 50);
                    }
                    
                    saveActivities(activities);
                    
                    return activity;
                } catch (error) {
                    console.error('Error adding activity:', error);
                    return null;
                }
            }

            // Process quick sale
            function processQuickSale(saleData) {
                try {
                    const { productId, quantity, price, customer } = saleData;
                    const product = products[productId];
                    
                    if (!product) {
                        return {
                            success: false,
                            message: 'Produkt nicht gefunden'
                        };
                    }
                    
                    // Validate inputs
                    const validQuantity = parseInt(quantity);
                    const validPrice = parseFloat(price);
                    
                    if (isNaN(validQuantity) || validQuantity <= 0) {
                        return {
                            success: false,
                            message: 'Ungültige Menge'
                        };
                    }
                    
                    if (isNaN(validPrice) || validPrice <= 0) {
                        return {
                            success: false,
                            message: 'Ungültiger Preis'
                        };
                    }
                    
                    // Check stock if available
                    if (product.stock !== undefined && product.stock !== null) {
                        const currentStock = parseInt(product.stock);
                        if (!isNaN(currentStock) && currentStock < validQuantity) {
                            return {
                                success: false,
                                message: `Nicht genügend Lagerbestand. Verfügbar: ${currentStock}`
                            };
                        }
                    }
                    
                    // Create a receipt
                    const receipt = {
                        id: `receipt-${Date.now()}`,
                        date: new Date().toISOString(),
                        amount: validQuantity * validPrice,
                        status: 'Bestätigt',
                        items: [
                            {
                                name: product.name || 'Unbekanntes Produkt',
                                quantity: validQuantity,
                                price: validPrice,
                                barcode: productId
                            }
                        ],
                        customer: customer || null,
                        paymentMethod: 'cash',
                        timestamp: Date.now()
                    };
                    
                    // Add to receipts
                    receipts.push(receipt);
                    
                    // Update localStorage
                    try {
                        localStorage.setItem('payment_archive', JSON.stringify(receipts));
                    } catch (e) {
                        console.error('Error saving receipt:', e);
                        return {
                            success: false,
                            message: 'Fehler beim Speichern des Verkaufs'
                        };
                    }
                    
                    // Update product stock if product exists and has stock
                    if (product.stock !== undefined && product.stock !== null) {
                        const currentStock = parseInt(product.stock);
                        if (!isNaN(currentStock)) {
                            product.stock = currentStock - validQuantity;
                            
                            // Update product in localStorage
                            try {
                                const productKey = `product_${productId}`;
                                localStorage.setItem(productKey, JSON.stringify(product));
                                
                                // Update local products object
                                products[productId] = product;
                            } catch (e) {
                                console.error('Error updating product stock:', e);
                                // Continue even if stock update fails
                            }
                        }
                    }
                    
                    // Add activity
                    addActivity({
                        type: 'success',
                        title: 'Schnellverkauf abgeschlossen',
                        description: `${validQuantity}x ${product.name} für €${(validQuantity * validPrice).toFixed(2)} verkauft.`
                    });
                    
                    return {
                        success: true,
                        message: `Verkauf erfolgreich: €${(validQuantity * validPrice).toFixed(2)}`,
                        receipt: receipt
                    };
                } catch (error) {
                    console.error('Error processing quick sale:', error);
                    return {
                        success: false,
                        message: 'Fehler beim Verarbeiten des Verkaufs'
                    };
                }
            }

            // Update goal progress
            function updateGoalProgress() {
                try {
                    const stats = getSalesStats();
                    
                    goals.forEach(goal => {
                        switch (goal.type) {
                            case 'revenue':
                                goal.current = stats.thisMonth.revenue;
                                break;
                            case 'sales':
                                goal.current = stats.thisMonth.transactions;
                                break;
                            case 'customers':
                                goal.current = stats.thisMonth.customers;
                                break;
                            case 'products':
                                // Count unique products sold this month
                                const productSet = new Set();
                                const thisMonthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                                
                                receipts.forEach(receipt => {
                                    try {
                                        const receiptDate = new Date(receipt.date);
                                        if (receiptDate >= thisMonthStart) {
                                            if (receipt.items && Array.isArray(receipt.items)) {
                                                receipt.items.forEach(item => {
                                                    if (item.barcode) productSet.add(item.barcode);
                                                });
                                            }
                                        }
                                    } catch (e) {
                                        console.error('Error processing receipt for goal:', e);
                                    }
                                });
                                goal.current = productSet.size;
                                break;
                        }
                    });
                    
                    saveGoals(goals);
                    return true;
                } catch (error) {
                    console.error('Error updating goal progress:', error);
                    return false;
                }
            }

            // Get AI response with enhanced capabilities
            function getAIResponse(message) {
                try {
                    const lowerMessage = message.toLowerCase();
                    
                    // Add user message to context
                    aiContext.push({
                        role: 'user',
                        content: message,
                        timestamp: new Date().toISOString()
                    });
                    
                    let response = '';
                    
                    // Enhanced response logic with real actions
                    if (lowerMessage.includes('hallo') || lowerMessage.includes('hi') || lowerMessage.includes('guten tag')) {
                        response = 'Hallo! Wie kann ich Ihnen helfen? Ich kann Ihnen bei Umsatzanalysen, Produktoptimierung, Zielsetzung und Lagerbestandsmanagement helfen.';
                    } else if (lowerMessage.includes('umsatz') || lowerMessage.includes('einnahmen') || lowerMessage.includes('umsätze')) {
                        const stats = getSalesStats();
                        response = `Ihr heutiger Umsatz beträgt €${stats.today.revenue.toFixed(2)}. Der Umsatz diesen Monat liegt bei €${stats.thisMonth.revenue.toFixed(2)}. Das ist eine Veränderung von ${stats.changes.revenue >= 0 ? '+' : ''}${stats.changes.revenue.toFixed(1)}% gegenüber gestern.`;
                    } else if (lowerMessage.includes('verkäufe') || lowerMessage.includes('transaktionen') || lowerMessage.includes('verkauf')) {
                        const stats = getSalesStats();
                        response = `Sie hatten heute ${stats.today.transactions} Verkäufe. Dieser Monat sind es bereits ${stats.thisMonth.transactions} Transaktionen. Das entspricht €${stats.today.avgOrder.toFixed(2)} durchschnittlichem Bestellwert.`;
                    } else if (lowerMessage.includes('kunden') || lowerMessage.includes('kundschaft')) {
                        const stats = getSalesStats();
                        response = `Heute hatten Sie ${stats.today.customers} Kunden. Insgesamt diesen Monat waren es ${stats.thisMonth.customers} verschiedene Kunden.`;
                    } else if (lowerMessage.includes('ziel') || lowerMessage.includes('ziele')) {
                        const goalStats = goals.map(goal => {
                            const progress = Math.min(100, (goal.current / goal.target) * 100);
                            return `${goal.title}: ${progress.toFixed(1)}% erreicht (${goal.current}/${goal.target})`;
                        }).join('\n');
                        
                        response = `Sie haben ${goals.length} aktive Ziele:\n${goalStats}\n\nMöchten Sie ein neues Ziel hinzufügen oder ein bestehendes bearbeiten?`;
                    } else if (lowerMessage.includes('produkt') || lowerMessage.includes('produkte') || lowerMessage.includes('top produkte')) {
                        const topProducts = getProductPerformance(5);
                        if (topProducts.length > 0) {
                            const productList = topProducts.map((p, i) => `${i + 1}. ${p.name}: €${p.revenue.toFixed(2)} (${p.quantity} verkauft)`).join('\n');
                            response = `Ihre Top-Produkte:\n${productList}\n\nMöchten Sie eine detaillierte Analyse oder Optimierungsvorschläge?`;
                        } else {
                            response = 'Noch keine Produktverkäufe vorhanden. Beginnen Sie mit dem Verkauf von Produkten!';
                        }
                    } else if (lowerMessage.includes('lager') || lowerMessage.includes('inventar') || lowerMessage.includes('bestand') || lowerMessage.includes('warnungen')) {
                        const alerts = getInventoryAlerts();
                        if (alerts.length > 0) {
                            const alertList = alerts.slice(0, 3).map(alert => `• ${alert.description}`).join('\n');
                            response = `Sie haben ${alerts.length} Lagerwarnungen:\n${alertList}\n\nMöchten Sie Nachbestellungen vornehmen?`;
                        } else {
                            response = 'Ihr Lagerbestand sieht gut aus. Keine kritischen Warnungen.';
                        }
                    } else if (lowerMessage.includes('hilfe') || lowerMessage.includes('unterstützung') || lowerMessage.includes('was kannst du')) {
                        response = `Ich kann Ihnen bei folgenden Aufgaben helfen:

1. **Umsatzanalyse**: Aktuelle Umsätze, Trends, Prognosen
2. **Produktoptimierung**: Top-Produkte identifizieren, Schwachstellen finden
3. **Zielmanagement**: Ziele setzen, Fortschritt tracken, Vorschläge machen
4. **Lagerbestand**: Warnungen, Nachbestellungsvorschläge
5. **Schnellaktionen**: Verkäufe, Berichte, Backups

Fragen Sie mich konkret oder nutzen Sie die Quick-Commands!`;
                    } else if (lowerMessage.includes('analyse') || lowerMessage.includes('auswertung') || lowerMessage.includes('bericht')) {
                        const stats = getSalesStats();
                        const topProducts = getProductPerformance(3);
                        const alerts = getInventoryAlerts();
                        
                        response = `**Zusammenfassung Ihrer Geschäftsdaten:**

📊 **Umsatz**: €${stats.thisMonth.revenue.toFixed(2)} diesen Monat
🛒 **Verkäufe**: ${stats.thisMonth.transactions} Transaktionen
👥 **Kunden**: ${stats.thisMonth.customers} verschiedene Kunden
📈 **Trend**: ${stats.changes.revenue >= 0 ? 'Positiv' : 'Negativ'} (${stats.changes.revenue.toFixed(1)}%)

${topProducts.length > 0 ? `🏆 **Top 3 Produkte**:\n${topProducts.map((p, i) => `${i + 1}. ${p.name}: €${p.revenue.toFixed(2)}`).join('\n')}\n\n` : ''}
${alerts.length > 0 ? `⚠️ **Lagerwarnungen**: ${alerts.length} aktive Warnungen\n\n` : ''}
Möchten Sie detaillierte Empfehlungen?`;
                    } else if (lowerMessage.includes('empfehlung') || lowerMessage.includes('vorschlag') || lowerMessage.includes('tipp')) {
                        const stats = getSalesStats();
                        const topProducts = getProductPerformance(5);
                        const alerts = getInventoryAlerts();
                        
                        let recommendations = [];
                        
                        if (stats.changes.revenue < -10) {
                            recommendations.push("• Umsatzrückgang erkannt. Prüfen Sie Ihre Preise und Marketingaktionen.");
                        }
                        
                        if (stats.today.avgOrder < 20) {
                            recommendations.push("• Niedriger durchschnittlicher Bestellwert. Bieten Sie Upselling-Optionen an.");
                        }
                        
                        if (alerts.length > 0) {
                            recommendations.push("• Kritische Lagerbestände. Bitte nachbestellen.");
                        }
                        
                        if (topProducts.length > 0) {
                            recommendations.push(`• Fokussieren Sie auf Ihr Top-Produkt: ${topProducts[0].name}`);
                        }
                        
                        if (recommendations.length === 0) {
                            recommendations.push("• Alles sieht gut aus! Konzentrieren Sie sich auf Kundenbindung.");
                        }
                        
                        response = `**Meine Empfehlungen für Sie:**\n${recommendations.join('\n')}`;
                    } else {
                        response = 'Entschuldigung, ich verstehe Ihre Frage nicht ganz. Könnten Sie sie anders formulieren? Sie können mich nach Umsätzen, Verkäufen, Produkten, Zielen oder Lagerbeständen fragen. Oder sagen Sie "Hilfe" für eine Liste meiner Fähigkeiten.';
                    }
                    
                    // Add assistant response to context
                    aiContext.push({
                        role: 'assistant',
                        content: response,
                        timestamp: new Date().toISOString()
                    });
                    
                    saveAIContext(aiContext);
                    return response;
                } catch (error) {
                    console.error('Error getting AI response:', error);
                    return 'Entschuldigung, es ist ein Fehler aufgetreten. Bitte versuchen Sie es erneut.';
                }
            }

            // Generate AI-suggested goals based on data
            function generateAISuggestedGoals() {
                try {
                    const stats = getSalesStats();
                    const suggestions = [];
                    const currentDate = new Date();
                    const currentMonth = currentDate.getMonth();
                    const currentYear = currentDate.getFullYear();
                    const lastDay = new Date(currentYear, currentMonth + 1, 0).getDate();
                    
                    // Revenue goal suggestion
                    if (stats.thisMonth.revenue > 0) {
                        const suggestedRevenue = Math.round(stats.thisMonth.revenue * 1.2); // 20% increase
                        suggestions.push({
                            title: 'Umsatzsteigerung nächster Monat',
                            type: 'revenue',
                            target: suggestedRevenue,
                            current: 0,
                            deadline: `${currentYear}-${String((currentMonth + 1) % 12 + 1).padStart(2, '0')}-${new Date(currentYear, (currentMonth + 1) % 12 + 1, 0).getDate()}`,
                            aiSuggested: true,
                            reason: `Basierend auf aktuellen €${stats.thisMonth.revenue.toFixed(2)} (+20% Ziel)`
                        });
                    }
                    
                    // Customer goal suggestion
                    if (stats.thisMonth.customers > 0) {
                        const suggestedCustomers = Math.round(stats.thisMonth.customers * 1.15); // 15% increase
                        suggestions.push({
                            title: 'Kundenwachstum',
                            type: 'customers',
                            target: suggestedCustomers,
                            current: 0,
                            deadline: `${currentYear}-${String((currentMonth + 1) % 12 + 1).padStart(2, '0')}-${new Date(currentYear, (currentMonth + 1) % 12 + 1, 0).getDate()}`,
                            aiSuggested: true,
                            reason: `Basierend auf ${stats.thisMonth.customers} aktuellen Kunden (+15% Ziel)`
                        });
                    }
                    
                    // Product diversification goal
                    const uniqueProducts = new Set();
                    receipts.forEach(receipt => {
                        if (receipt.items && Array.isArray(receipt.items)) {
                            receipt.items.forEach(item => {
                                if (item.barcode) uniqueProducts.add(item.barcode);
                            });
                        }
                    });
                    
                    if (uniqueProducts.size > 0) {
                        suggestions.push({
                            title: 'Produktdiversifikation',
                            type: 'products',
                            target: uniqueProducts.size + 3, // Add 3 new products
                            current: uniqueProducts.size,
                            deadline: `${currentYear}-${String((currentMonth + 1) % 12 + 1).padStart(2, '0')}-${new Date(currentYear, (currentMonth + 1) % 12 + 1, 0).getDate()}`,
                            aiSuggested: true,
                            reason: `Aktuell ${uniqueProducts.size} verschiedene Produkte (+3 neue Produkte)`
                        });
                    }
                    
                    return suggestions;
                } catch (error) {
                    console.error('Error generating AI suggested goals:', error);
                    return [];
                }
            }

            // Generate product analysis
            function generateProductAnalysis() {
                try {
                    const topProducts = getProductPerformance(10);
                    const alerts = getInventoryAlerts();
                    const stats = getSalesStats();
                    
                    let analysis = `# Produktanalyse\n\n`;
                    analysis += `**Zeitraum**: Letzter Monat\n`;
                    analysis += `**Gesamtumsatz**: €${stats.thisMonth.revenue.toFixed(2)}\n`;
                    analysis += `**Anzahl Produkte**: ${Object.keys(products).length}\n\n`;
                    
                    if (topProducts.length > 0) {
                        analysis += `## Top 5 Produkte\n`;
                        topProducts.slice(0, 5).forEach((product, index) => {
                            const share = stats.thisMonth.revenue > 0 ? (product.revenue / stats.thisMonth.revenue * 100).toFixed(1) : '0.0';
                            analysis += `${index + 1}. **${product.name}**\n`;
                            analysis += `   - Umsatz: €${product.revenue.toFixed(2)} (${share}%)\n`;
                            analysis += `   - Verkauft: ${product.quantity} Einheiten\n`;
                            analysis += `   - Ø Preis: €${(product.price || 0).toFixed(2)}\n`;
                        });
                    }
                    
                    if (alerts.length > 0) {
                        analysis += `\n## ⚠️ Lagerwarnungen\n`;
                        alerts.slice(0, 3).forEach(alert => {
                            analysis += `- ${alert.description}\n`;
                        });
                    }
                    
                    analysis += `\n## 📈 Empfehlungen\n`;
                    
                    if (topProducts.length > 0) {
                        const topProduct = topProducts[0];
                        analysis += `1. **${topProduct.name} stärker bewerben** - Dies ist Ihr Bestseller\n`;
                        
                        if (topProducts.length >= 3) {
                            const bottomProducts = topProducts.slice(-3);
                            analysis += `2. **Schwache Produkte überprüfen**: ${bottomProducts.map(p => p.name).join(', ')}\n`;
                        }
                    }
                    
                    if (alerts.length > 0) {
                        analysis += `3. **Lagerbestände auffüllen** - ${alerts.length} Produkte sind knapp\n`;
                    }
                    
                    if (topProducts.length === 0 && alerts.length === 0) {
                        analysis += `1. **Produkte hinzufügen** - Beginnen Sie mit der Produktverwaltung\n`;
                        analysis += `2. **Verkäufe starten** - Nutzen Sie die Kassenansicht\n`;
                    }
                    
                    return analysis;
                } catch (error) {
                    console.error('Error generating product analysis:', error);
                    return '# Fehler bei der Analyse\n\nEs ist ein Fehler aufgetreten. Bitte versuchen Sie es später erneut.';
                }
            }

            // Generate restock suggestions
            function generateRestockSuggestions() {
                try {
                    const alerts = getInventoryAlerts();
                    const topProducts = getProductPerformance(20);
                    
                    if (alerts.length === 0) {
                        return {
                            hasSuggestions: false,
                            message: 'Keine dringenden Nachbestellungen erforderlich.'
                        };
                    }
                    
                    const suggestions = alerts.map(alert => {
                        const product = alert.product;
                        const currentStock = parseInt(product.stock) || 0;
                        const suggestedQuantity = Math.max(10, Math.round(currentStock * 2));
                        const productPrice = parseFloat(product.price) || 0;
                        
                        return {
                            product: product,
                            currentStock: currentStock,
                            suggestedQuantity: suggestedQuantity,
                            urgency: alert.severity === 'critical' ? 'Hoch' : 'Mittel',
                            estimatedCost: productPrice * suggestedQuantity
                        };
                    });
                    
                    const totalCost = suggestions.reduce((sum, s) => sum + s.estimatedCost, 0);
                    
                    return {
                        hasSuggestions: true,
                        suggestions: suggestions,
                        totalCost: totalCost,
                        message: `${suggestions.length} Nachbestellungen empfohlen. Geschätzte Kosten: €${totalCost.toFixed(2)}`
                    };
                } catch (error) {
                    console.error('Error generating restock suggestions:', error);
                    return {
                        hasSuggestions: false,
                        message: 'Fehler beim Generieren der Nachbestellungsvorschläge.'
                    };
                }
            }

            // Public API
            return {
                init,
                getSalesStats,
                getRevenueByDay,
                getProductPerformance,
                getInventoryAlerts,
                getGoals: () => goals,
                getActivities: () => activities,
                getProducts: () => products,
                getReceipts: () => receipts,
                addGoal,
                updateGoal,
                deleteGoal,
                addActivity,
                processQuickSale,
                updateGoalProgress,
                getAIResponse,
                generateAISuggestedGoals,
                generateProductAnalysis,
                generateRestockSuggestions,
                updateAllData,
                triggerRefresh
            };
        })();

        // Chart Manager
        const chartManager = (function() {
            let revenueChart = null;
            let currentPeriod = 'month';
            
            // Initialize charts
            function initCharts() {
                try {
                    // Revenue chart
                    const revenueCtx = document.getElementById('revenue-chart');
                    if (!revenueCtx) return;
                    
                    const ctx = revenueCtx.getContext('2d');
                    const revenueData = dashboardManager.getRevenueByDay(30);
                    
                    revenueChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: revenueData.labels,
                            datasets: [{
                                label: 'Umsatz (€)',
                                data: revenueData.data,
                                backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--color-accent') + '20',
                                borderColor: getComputedStyle(document.documentElement).getPropertyValue('--color-accent'),
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true,
                                pointBackgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--color-accent'),
                                pointBorderColor: getComputedStyle(document.documentElement).getPropertyValue('--color-bg'),
                                pointBorderWidth: 2,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '€' + value;
                                        },
                                        font: {
                                            size: window.innerWidth <= 768 ? 10 : 12
                                        },
                                        color: getComputedStyle(document.documentElement).getPropertyValue('--color-text-muted')
                                    },
                                    grid: {
                                        color: getComputedStyle(document.documentElement).getPropertyValue('--color-border') + '50'
                                    }
                                },
                                x: {
                                    ticks: {
                                        font: {
                                            size: window.innerWidth <= 768 ? 10 : 12
                                        },
                                        maxRotation: window.innerWidth <= 768 ? 45 : 0,
                                        color: getComputedStyle(document.documentElement).getPropertyValue('--color-text-muted')
                                    },
                                    grid: {
                                        color: getComputedStyle(document.documentElement).getPropertyValue('--color-border') + '50'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return 'Umsatz: €' + context.raw;
                                        }
                                    },
                                    titleFont: {
                                        size: window.innerWidth <= 768 ? 12 : 14
                                    },
                                    bodyFont: {
                                        size: window.innerWidth <= 768 ? 12 : 14
                                    },
                                    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--color-bg'),
                                    titleColor: getComputedStyle(document.documentElement).getPropertyValue('--color-text'),
                                    bodyColor: getComputedStyle(document.documentElement).getPropertyValue('--color-text'),
                                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--color-border'),
                                    borderWidth: 1
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            animation: {
                                duration: window.innerWidth <= 768 ? 0 : 1000
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error initializing charts:', error);
                }
            }
            
            // Update charts
            function updateCharts() {
                if (!revenueChart) return;
                
                try {
                    const days = currentPeriod === 'week' ? 7 : currentPeriod === 'year' ? 365 : 30;
                    const revenueData = dashboardManager.getRevenueByDay(days);
                    revenueChart.data.labels = revenueData.labels;
                    revenueChart.data.datasets[0].data = revenueData.data;
                    
                    // Update colors for dark mode
                    const isDarkMode = document.body.classList.contains('dark-mode');
                    revenueChart.data.datasets[0].backgroundColor = isDarkMode ? 'rgba(59, 130, 246, 0.1)' : 'rgba(37, 99, 235, 0.1)';
                    revenueChart.data.datasets[0].borderColor = isDarkMode ? 'rgb(59, 130, 246)' : 'rgb(37, 99, 235)';
                    revenueChart.data.datasets[0].pointBackgroundColor = isDarkMode ? 'rgb(59, 130, 246)' : 'rgb(37, 99, 235)';
                    
                    revenueChart.update();
                } catch (error) {
                    console.error('Error updating charts:', error);
                }
            }
            
            // Change chart period
            function changeChartPeriod(days, period) {
                if (!revenueChart) return;
                
                try {
                    currentPeriod = period;
                    const revenueData = dashboardManager.getRevenueByDay(days);
                    revenueChart.data.labels = revenueData.labels;
                    revenueChart.data.datasets[0].data = revenueData.data;
                    
                    // Update animation based on screen size
                    revenueChart.options.animation.duration = window.innerWidth <= 768 ? 0 : 500;
                    revenueChart.update();
                } catch (error) {
                    console.error('Error changing chart period:', error);
                }
            }
            
            // Get current period
            function getCurrentPeriod() {
                return currentPeriod;
            }
            
            // Public API
            return {
                initCharts,
                updateCharts,
                changeChartPeriod,
                getCurrentPeriod
            };
        })();

        // UI Manager
        const uiManager = (function() {
            let isMobile = window.innerWidth <= 768;
            
            // Update stats cards
            function updateStatsCards() {
                try {
                    const stats = dashboardManager.getSalesStats();
                    const statsGrid = document.getElementById('stats-grid');
                    
                    if (!statsGrid) return;
                    
                    statsGrid.innerHTML = `
                        <div class="stat-card" role="region" aria-label="Umsatz Statistik">
                            <div class="stat-card-header">
                                <div class="stat-card-title">Heutiger Umsatz</div>
                                <div class="stat-card-icon revenue" aria-hidden="true">
                                    <i class="fas fa-euro-sign"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="today-revenue">€${stats.today.revenue.toFixed(2)}</div>
                            <div class="stat-card-change ${stats.changes.revenue >= 0 ? 'positive' : 'negative'}" aria-live="polite">
                                <i class="fas fa-${stats.changes.revenue >= 0 ? 'arrow-up' : 'arrow-down'}"></i>
                                ${Math.abs(stats.changes.revenue).toFixed(1)}% ${stats.changes.revenue >= 0 ? 'Steigerung' : 'Rückgang'} gegenüber gestern
                            </div>
                        </div>
                        
                        <div class="stat-card" role="region" aria-label="Verkäufe Statistik">
                            <div class="stat-card-header">
                                <div class="stat-card-title">Heutige Verkäufe</div>
                                <div class="stat-card-icon sales" aria-hidden="true">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="today-sales">${stats.today.transactions}</div>
                            <div class="stat-card-change ${stats.changes.transactions >= 0 ? 'positive' : 'negative'}" aria-live="polite">
                                <i class="fas fa-${stats.changes.transactions >= 0 ? 'arrow-up' : 'arrow-down'}"></i>
                                ${Math.abs(stats.changes.transactions).toFixed(1)}% ${stats.changes.transactions >= 0 ? 'Steigerung' : 'Rückgang'} gegenüber gestern
                            </div>
                        </div>
                        
                        <div class="stat-card" role="region" aria-label="Kunden Statistik">
                            <div class="stat-card-header">
                                <div class="stat-card-title">Heutige Kunden</div>
                                <div class="stat-card-icon customers" aria-hidden="true">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="today-customers">${stats.today.customers}</div>
                            <div class="stat-card-change ${stats.changes.customers >= 0 ? 'positive' : 'negative'}" aria-live="polite">
                                <i class="fas fa-${stats.changes.customers >= 0 ? 'arrow-up' : 'arrow-down'}"></i>
                                ${Math.abs(stats.changes.customers).toFixed(1)}% ${stats.changes.customers >= 0 ? 'Steigerung' : 'Rückgang'} gegenüber gestern
                            </div>
                        </div>
                        
                        <div class="stat-card" role="region" aria-label="Durchschnittlicher Bestellwert Statistik">
                            <div class="stat-card-header">
                                <div class="stat-card-title">Durchschn. Bestellwert</div>
                                <div class="stat-card-icon avg-order" aria-hidden="true">
                                    <i class="fas fa-receipt"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="today-avg-order">€${stats.today.avgOrder.toFixed(2)}</div>
                            <div class="stat-card-change ${stats.changes.avgOrder >= 0 ? 'positive' : 'negative'}" aria-live="polite">
                                <i class="fas fa-${stats.changes.avgOrder >= 0 ? 'arrow-up' : 'arrow-down'}"></i>
                                ${Math.abs(stats.changes.avgOrder).toFixed(1)}% ${stats.changes.avgOrder >= 0 ? 'Steigerung' : 'Rückgang'} gegenüber gestern
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error updating stats cards:', error);
                }
            }
            
            // Update welcome message
            function updateWelcomeMessage() {
                try {
                    const stats = dashboardManager.getSalesStats();
                    const welcomeSubtitle = document.getElementById('welcome-subtitle');
                    const welcomeTitle = document.getElementById('welcome-title');
                    const pageSubtitle = document.getElementById('page-subtitle');
                    
                    if (!welcomeSubtitle || !welcomeTitle || !pageSubtitle) return;
                    
                    const now = new Date();
                    const hour = now.getHours();
                    let greeting = '';
                    
                    if (hour < 12) {
                        greeting = 'Guten Morgen';
                    } else if (hour < 18) {
                        greeting = 'Guten Tag';
                    } else {
                        greeting = 'Guten Abend';
                    }
                    
                    welcomeTitle.textContent = `${greeting} bei Gittertier Pro!`;
                    
                    if (stats.today.revenue > 0) {
                        welcomeSubtitle.textContent = `Großartig! Sie haben heute bereits €${stats.today.revenue.toFixed(2)} umgesetzt.`;
                    } else if (stats.today.transactions > 0) {
                        welcomeSubtitle.textContent = `Sie hatten heute bereits ${stats.today.transactions} Verkäufe.`;
                    } else {
                        const messages = [
                            'Ein neuer Tag für Ihr Geschäft beginnt.',
                            'Bereit für erfolgreiche Verkäufe?',
                            'Zeit, Ihr Geschäft voranzubringen.',
                            'Perfekter Zeitpunkt für neue Kunden.'
                        ];
                        const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                        welcomeSubtitle.textContent = randomMessage;
                    }
                    
                    // Update page subtitle with current stats
                    pageSubtitle.textContent = `Aktueller Status: €${stats.thisMonth.revenue.toFixed(2)} Umsatz diesen Monat, ${stats.thisMonth.transactions} Verkäufe, ${stats.thisMonth.customers} Kunden.`;
                } catch (error) {
                    console.error('Error updating welcome message:', error);
                }
            }
            
            // Update recent activities
            function updateRecentActivities() {
                try {
                    const activities = dashboardManager.getActivities();
                    const activityList = document.getElementById('activity-list');
                    
                    if (!activityList) return;
                    
                    if (activities.length === 0) {
                        activityList.innerHTML = `
                            <div class="empty-state" aria-live="polite">
                                <i class="fas fa-clock"></i>
                                <p>Keine Aktivitäten vorhanden</p>
                                <p>Sobald Sie Aktionen durchführen, erscheinen sie hier.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    activityList.innerHTML = activities.slice(0, 5).map(activity => {
                        const time = new Date(activity.time);
                        const timeString = time.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                        const dateString = time.toLocaleDateString('de-DE');
                        
                        let iconClass = 'info';
                        let icon = 'info';
                        if (activity.type === 'success') {
                            iconClass = 'success';
                            icon = 'check';
                        } else if (activity.type === 'warning') {
                            iconClass = 'warning';
                            icon = 'exclamation';
                        }
                        
                        return `
                            <div class="activity-item" role="article" aria-label="Aktivität: ${activity.title}">
                                <div class="activity-icon ${iconClass}" aria-hidden="true">
                                    <i class="fas fa-${icon}"></i>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">${activity.title}</div>
                                    <div class="activity-description">${activity.description}</div>
                                    <div class="activity-time">${dateString} um ${timeString}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } catch (error) {
                    console.error('Error updating recent activities:', error);
                }
            }
            
            // Update product performance table
            function updateProductPerformance() {
                try {
                    const products = dashboardManager.getProductPerformance();
                    const tableBody = document.getElementById('product-performance-body');
                    
                    if (!tableBody) return;
                    
                    if (products.length === 0) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="4" class="empty-state">
                                    <i class="fas fa-box-open"></i>
                                    <p>Noch keine Verkaufsdaten</p>
                                    <p>Beginnen Sie mit dem Verkauf von Produkten.</p>
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    tableBody.innerHTML = products.map((product, index) => {
                        // Determine trend based on recent performance (simplified)
                        const trend = index < 3 ? 'up' : index > 7 ? 'down' : 'right';
                        const trendLabel = index < 3 ? 'Steigend' : index > 7 ? 'Fallend' : 'Stabil';
                        
                        return `
                            <tr role="row" aria-rowindex="${index + 2}">
                                <td role="cell" data-label="Produkt">${product.name}</td>
                                <td role="cell" data-label="Umsatz">€${product.revenue.toFixed(2)}</td>
                                <td role="cell" data-label="Verkäufe">${product.quantity}</td>
                                <td role="cell" data-label="Trend">
                                    <i class="fas fa-arrow-${trend} ${trend === 'up' ? 'positive' : trend === 'down' ? 'negative' : ''}" aria-label="${trendLabel}"></i>
                                </td>
                            </tr>
                        `;
                    }).join('');
                } catch (error) {
                    console.error('Error updating product performance:', error);
                }
            }
            
            // Update goals
            function updateGoals() {
                try {
                    const goals = dashboardManager.getGoals();
                    const goalsList = document.getElementById('goals-list');
                    const goalsGrid = document.getElementById('goals-grid');
                    
                    // Update goals list (sidebar)
                    if (goalsList) {
                        if (goals.length === 0) {
                            goalsList.innerHTML = `
                                <div class="empty-state" aria-live="polite">
                                    <i class="fas fa-bullseye"></i>
                                    <p>Noch keine Ziele</p>
                                    <p>Setzen Sie sich Ziele für Ihr Geschäft.</p>
                                </div>
                            `;
                        } else {
                            goalsList.innerHTML = goals.slice(0, 3).map(goal => {
                                const progress = goal.target > 0 ? Math.min(100, (goal.current / goal.target) * 100) : 0;
                                const deadline = new Date(goal.deadline);
                                const now = new Date();
                                const daysLeft = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
                                const daysText = daysLeft > 0 ? `${daysLeft} Tage` : 'Abgelaufen';
                                
                                return `
                                    <div class="goal-card" role="region" aria-label="Ziel: ${goal.title}">
                                        <div class="goal-header">
                                            <div class="goal-title">${goal.title}</div>
                                            <div class="goal-value" aria-label="Fortschritt: ${Math.round(progress)} Prozent">${Math.round(progress)}%</div>
                                        </div>
                                        <div class="goal-progress" role="progressbar" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100">
                                            <div class="goal-progress-bar ${goal.type}" style="width: ${progress}%" aria-hidden="true"></div>
                                        </div>
                                        <div class="goal-details">
                                            <span>${goal.current} / ${goal.target} ${getGoalUnit(goal.type)}</span>
                                            <span>${daysText}</span>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        }
                    }
                    
                    // Update goals grid (main section)
                    if (goalsGrid) {
                        goalsGrid.innerHTML = goals.map(goal => {
                            const progress = goal.target > 0 ? Math.min(100, (goal.current / goal.target) * 100) : 0;
                            const deadline = new Date(goal.deadline);
                            const now = new Date();
                            const daysLeft = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
                            const daysText = daysLeft > 0 ? `${daysLeft} Tage verbleibend` : 'Abgelaufen';
                            const aiBadge = goal.aiSuggested ? '<span class="new-feature" style="font-size: 10px; padding: 1px 6px;">KI</span>' : '';
                            
                            return `
                                <div class="goal-card" role="region" aria-label="Ziel: ${goal.title}">
                                    <div class="goal-header">
                                        <div class="goal-title">${goal.title} ${aiBadge}</div>
                                        <div class="goal-value" aria-label="Fortschritt: ${Math.round(progress)} Prozent">${Math.round(progress)}%</div>
                                    </div>
                                    <div class="goal-progress" role="progressbar" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100">
                                        <div class="goal-progress-bar ${goal.type}" style="width: ${progress}%" aria-hidden="true"></div>
                                    </div>
                                    <div class="goal-details">
                                        <span>${goal.current} / ${goal.target} ${getGoalUnit(goal.type)}</span>
                                        <span>${daysText}</span>
                                    </div>
                                    <div class="goal-actions">
                                        <button class="goal-btn edit touch-feedback" data-goal-id="${goal.id}" aria-label="Ziel ${goal.title} bearbeiten">
                                            <i class="fas fa-edit"></i> ${isMobile ? '' : 'Bearbeiten'}
                                        </button>
                                        <button class="goal-btn delete touch-feedback" data-goal-id="${goal.id}" aria-label="Ziel ${goal.title} löschen">
                                            <i class="fas fa-trash"></i> ${isMobile ? '' : 'Löschen'}
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                } catch (error) {
                    console.error('Error updating goals:', error);
                }
            }
            
            // Get goal unit based on type
            function getGoalUnit(type) {
                switch (type) {
                    case 'revenue': return '€';
                    case 'sales': return 'Verkäufe';
                    case 'customers': return 'Kunden';
                    case 'products': return 'Produkte';
                    default: return '';
                }
            }
            
            // Update inventory alerts
            function updateInventoryAlerts() {
                try {
                    const alerts = dashboardManager.getInventoryAlerts();
                    const alertList = document.getElementById('alert-list');
                    
                    if (!alertList) return;
                    
                    if (alerts.length === 0) {
                        alertList.innerHTML = `
                            <div class="empty-state" aria-live="polite">
                                <i class="fas fa-check-circle"></i>
                                <p>Keine Warnungen</p>
                                <p>Alle Lagerbestände sind ausreichend.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    alertList.innerHTML = alerts.slice(0, 3).map(alert => `
                        <div class="alert-item" role="alert" aria-label="Lagerwarnung: ${alert.title}">
                            <div class="alert-icon" aria-hidden="true">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="alert-content">
                                <div class="alert-title">${alert.title}</div>
                                <div class="alert-description">${alert.description}</div>
                            </div>
                            <button class="alert-action touch-feedback" data-product-id="${alert.product.barcode}" aria-label="Nachbestellung für ${alert.product.name}">
                                ${isMobile ? 'Bestellen' : 'Nachbestellen'}
                            </button>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Error updating inventory alerts:', error);
                }
            }
            
            // Update product dropdown for quick sale
            function updateProductDropdown() {
                try {
                    const products = dashboardManager.getProducts();
                    const dropdown = document.getElementById('sale-product');
                    
                    if (!dropdown) return;
                    
                    const productArray = Object.values(products);
                    
                    if (productArray.length === 0) {
                        dropdown.innerHTML = '<option value="" disabled selected>Keine Produkte verfügbar</option>';
                        document.getElementById('sale-price').value = '0.00';
                        return;
                    }
                    
                    dropdown.innerHTML = productArray.map(product => `
                        <option value="${product.barcode || product.name}">${product.name} - €${(product.price || 0).toFixed(2)} ${product.stock !== undefined && product.stock !== null ? `(${product.stock} verfügbar)` : ''}</option>
                    `).join('');
                    
                    // Set default price when product is selected
                    dropdown.addEventListener('change', function() {
                        const selectedProduct = products[this.value];
                        if (selectedProduct && selectedProduct.price) {
                            document.getElementById('sale-price').value = selectedProduct.price.toFixed(2);
                        }
                    });
                    
                    // Set initial price if dropdown has options
                    if (dropdown.options.length > 0 && dropdown.options[0].value) {
                        const firstProduct = products[dropdown.options[0].value];
                        if (firstProduct && firstProduct.price) {
                            document.getElementById('sale-price').value = firstProduct.price.toFixed(2);
                        }
                    }
                } catch (error) {
                    console.error('Error updating product dropdown:', error);
                }
            }
            
            // Update weather widget
            function updateWeatherWidget() {
                try {
                    // In a real app, this would fetch data from a weather API
                    // For now, we'll use mock data that changes based on time
                    const now = new Date();
                    const hour = now.getHours();
                    
                    let weatherData;
                    
                    // Simple mock weather based on time of day
                    if (hour >= 6 && hour < 12) {
                        weatherData = {
                            location: 'München',
                            temp: 18 + Math.floor(Math.random() * 5),
                            description: 'Heiter',
                            icon: 'fa-sun',
                            wind: (3 + Math.floor(Math.random() * 5)) + ' km/h',
                            humidity: (40 + Math.floor(Math.random() * 20)) + '%'
                        };
                    } else if (hour >= 12 && hour < 18) {
                        weatherData = {
                            location: 'München',
                            temp: 22 + Math.floor(Math.random() * 5),
                            description: 'Sonnig',
                            icon: 'fa-sun',
                            wind: (5 + Math.floor(Math.random() * 5)) + ' km/h',
                            humidity: (35 + Math.floor(Math.random() * 15)) + '%'
                        };
                    } else {
                        weatherData = {
                            location: 'München',
                            temp: 15 + Math.floor(Math.random() * 5),
                            description: 'Klar',
                            icon: 'fa-moon',
                            wind: (2 + Math.floor(Math.random() * 3)) + ' km/h',
                            humidity: (50 + Math.floor(Math.random() * 20)) + '%'
                        };
                    }
                    
                    const locationEl = document.getElementById('weather-location');
                    const iconEl = document.getElementById('weather-icon');
                    const tempEl = document.getElementById('weather-temp');
                    const descEl = document.getElementById('weather-desc');
                    const windEl = document.getElementById('weather-wind');
                    const humidityEl = document.getElementById('weather-humidity');
                    
                    if (locationEl) locationEl.textContent = weatherData.location;
                    if (iconEl) iconEl.innerHTML = `<i class="fas ${weatherData.icon}"></i>`;
                    if (tempEl) tempEl.textContent = `${weatherData.temp}°C`;
                    if (descEl) descEl.textContent = weatherData.description;
                    if (windEl) windEl.textContent = weatherData.wind;
                    if (humidityEl) humidityEl.textContent = weatherData.humidity;
                } catch (error) {
                    console.error('Error updating weather widget:', error);
                }
            }
            
            // Add AI message to chat with typing indicator
            function addAIMessage(message, isUser = false) {
                try {
                    const aiBody = document.getElementById('ai-body');
                    if (!aiBody) return;
                    
                    // Remove any existing typing indicator
                    const existingTyping = aiBody.querySelector('.ai-typing');
                    if (existingTyping) {
                        existingTyping.remove();
                    }
                    
                    const messageClass = isUser ? 'user' : 'assistant';
                    
                    const messageElement = document.createElement('div');
                    messageElement.className = `ai-message ${messageClass}`;
                    messageElement.textContent = message;
                    messageElement.setAttribute('role', 'log');
                    messageElement.setAttribute('aria-live', 'polite');
                    
                    aiBody.appendChild(messageElement);
                    aiBody.scrollTop = aiBody.scrollHeight;
                } catch (error) {
                    console.error('Error adding AI message:', error);
                }
            }
            
            // Show typing indicator
            function showTypingIndicator() {
                try {
                    const aiBody = document.getElementById('ai-body');
                    if (!aiBody) return null;
                    
                    // Remove any existing typing indicator
                    const existingTyping = aiBody.querySelector('.ai-typing');
                    if (existingTyping) {
                        existingTyping.remove();
                    }
                    
                    const typingElement = document.createElement('div');
                    typingElement.className = 'ai-typing';
                    typingElement.setAttribute('aria-label', 'KI-Assistent schreibt');
                    typingElement.innerHTML = `
                        <div class="ai-typing-dot"></div>
                        <div class="ai-typing-dot"></div>
                        <div class="ai-typing-dot"></div>
                    `;
                    
                    aiBody.appendChild(typingElement);
                    aiBody.scrollTop = aiBody.scrollHeight;
                    
                    return typingElement;
                } catch (error) {
                    console.error('Error showing typing indicator:', error);
                    return null;
                }
            }
            
            // Hide typing indicator
            function hideTypingIndicator() {
                try {
                    const aiBody = document.getElementById('ai-body');
                    if (!aiBody) return;
                    
                    const typingElement = aiBody.querySelector('.ai-typing');
                    if (typingElement) {
                        typingElement.remove();
                    }
                } catch (error) {
                    console.error('Error hiding typing indicator:', error);
                }
            }
            
            // Update AI quick commands
            function updateAIQuickCommands() {
                // Quick commands are static for now, but could be dynamic based on context
                // This function is kept for future enhancements
            }
            
            // Show AI analysis modal
            function showAIAnalysisModal(content, showApplyButton = false) {
                try {
                    const modal = document.getElementById('ai-analysis-modal');
                    const contentEl = document.getElementById('ai-analysis-content');
                    const applyBtn = document.getElementById('apply-analysis-btn');
                    
                    if (!modal || !contentEl) return;
                    
                    contentEl.innerHTML = `<div style="white-space: pre-line; line-height: 1.6; max-height: 400px; overflow-y: auto;">${content}</div>`;
                    
                    if (applyBtn) {
                        applyBtn.style.display = showApplyButton ? 'flex' : 'none';
                    }
                    
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                } catch (error) {
                    console.error('Error showing AI analysis modal:', error);
                }
            }
            
            // Update all UI components
            function updateAll() {
                try {
                    updateStatsCards();
                    updateWelcomeMessage();
                    updateRecentActivities();
                    updateProductPerformance();
                    updateGoals();
                    updateInventoryAlerts();
                    updateProductDropdown();
                    updateWeatherWidget();
                    updateAIQuickCommands();
                    chartManager.updateCharts();
                    dashboardManager.updateGoalProgress();
                    
                    // Update mobile state
                    isMobile = window.innerWidth <= 768;
                } catch (error) {
                    console.error('Error updating UI:', error);
                }
            }
            
            // Check if mobile
            function isMobileView() {
                return isMobile;
            }
            
            // Public API
            return {
                updateAll,
                addAIMessage,
                showTypingIndicator,
                hideTypingIndicator,
                showAIAnalysisModal,
                isMobileView
            };
        })();

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Apply dark mode if enabled
                applyDarkMode();
                
                // Set up event listeners
                setupEventListeners();
                
                // Initialize dashboard
                await dashboardManager.init();
                
                // Initialize charts
                chartManager.initCharts();
                
                // Update UI
                uiManager.updateAll();
                
                // Update time display
                updateTime();
                setInterval(updateTime, 1000);
                
                // Check for updates every 5 minutes
                setInterval(() => {
                    dashboardManager.updateAllData();
                    uiManager.updateAll();
                }, 5 * 60 * 1000);
                
                // Initialize mobile-specific features
                initMobileFeatures();
                
                // Show welcome notification
                setTimeout(() => {
                    showNotification('Dashboard erfolgreich geladen', 'success');
                }, 500);
            } catch (error) {
                console.error('Error initializing application:', error);
                showNotification('Fehler beim Initialisieren des Dashboards', 'error');
            }
        });

        // Apply dark mode if enabled
        function applyDarkMode() {
            try {
                const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
                if (settings.darkMode === true) {
                    document.body.classList.add('dark-mode');
                } else if (settings.darkMode === false) {
                    document.body.classList.remove('dark-mode');
                } else {
                    // Use system preference
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        document.body.classList.add('dark-mode');
                    } else {
                        document.body.classList.remove('dark-mode');
                    }
                }
            } catch (error) {
                console.error('Error applying dark mode:', error);
            }
        }

        // Initialize mobile-specific features
        function initMobileFeatures() {
            if (window.innerWidth <= 768) {
                // Add touch-friendly enhancements
                document.body.classList.add('mobile-view');
                
                // Make sure all interactive elements have proper touch targets
                const interactiveElements = document.querySelectorAll('button, a, input, select, [role="button"]');
                interactiveElements.forEach(el => {
                    if (el.offsetHeight < 44 || el.offsetWidth < 44) {
                        el.style.minHeight = '44px';
                        el.style.minWidth = '44px';
                        el.style.padding = '12px';
                    }
                });
                
                // Prevent double-tap zoom
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function(event) {
                    const now = Date.now();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, { passive: false });
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Hamburger menu toggle for mobile
            const hamburger = document.getElementById('hamburger');
            if (hamburger) {
                hamburger.addEventListener('click', () => {
                    const sidebar = document.getElementById('sidebar');
                    const sidebarOverlay = document.getElementById('sidebarOverlay');
                    sidebar.classList.toggle('active');
                    sidebarOverlay.classList.toggle('active');
                    
                    // Close AI assistant when opening sidebar on mobile
                    if (window.innerWidth <= 768) {
                        document.getElementById('ai-assistant').classList.remove('active');
                    }
                });
                
                // Add touch feedback
                hamburger.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                }, { passive: true });
                
                hamburger.addEventListener('touchend', function() {
                    this.style.transform = '';
                }, { passive: true });
            }
            
            // Close sidebar when clicking overlay
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', () => {
                    const sidebar = document.getElementById('sidebar');
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                });
                
                // Also close on touch
                sidebarOverlay.addEventListener('touchstart', (e) => {
                    if (e.target === sidebarOverlay) {
                        sidebar.classList.remove('active');
                        sidebarOverlay.classList.remove('active');
                    }
                }, { passive: true });
            }
            
            // Close sidebar when clicking a link on mobile
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.remove('active');
                        document.getElementById('sidebarOverlay').classList.remove('active');
                    }
                });
            });
            
            // Logout functionality
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
                    
                    if (settings.logoutConfirmation !== false) {
                        if (!confirm('Möchten Sie sich wirklich abmelden?')) {
                            return;
                        }
                    }
                    
                    try {
                        sessionStorage.removeItem('validTokens');
                        localStorage.removeItem('authToken');
                        window.location.href = 'login';
                    } catch (error) {
                        console.error('Error during logout:', error);
                        window.location.reload();
                    }
                });
                
                // Add touch feedback for mobile
                logoutBtn.addEventListener('touchstart', function() {
                    if (window.innerWidth <= 768) {
                        this.style.backgroundColor = 'var(--color-bg-secondary)';
                    }
                }, { passive: true });
                
                logoutBtn.addEventListener('touchend', function() {
                    if (window.innerWidth <= 768) {
                        this.style.backgroundColor = '';
                    }
                }, { passive: true });
            }
            
            // Chart period buttons
            const revenueWeekBtn = document.getElementById('revenue-week');
            const revenueMonthBtn = document.getElementById('revenue-month');
            const revenueYearBtn = document.getElementById('revenue-year');
            
            function setActivePeriodButton(activeButton) {
                [revenueWeekBtn, revenueMonthBtn, revenueYearBtn].forEach(btn => {
                    if (btn) btn.classList.remove('active');
                });
                if (activeButton) activeButton.classList.add('active');
            }
            
            if (revenueWeekBtn) {
                revenueWeekBtn.addEventListener('click', function() {
                    setActivePeriodButton(this);
                    chartManager.changeChartPeriod(7, 'week');
                    
                    // Add activity
                    dashboardManager.addActivity({
                        type: 'info',
                        title: 'Diagramm aktualisiert',
                        description: 'Umsatzdiagramm auf Wochenansicht geändert.'
                    });
                });
                
                // Touch feedback
                revenueWeekBtn.addEventListener('touchstart', function() {
                    if (window.innerWidth <= 768) {
                        this.style.transform = 'scale(0.95)';
                    }
                }, { passive: true });
            }
            
            if (revenueMonthBtn) {
                revenueMonthBtn.addEventListener('click', function() {
                    setActivePeriodButton(this);
                    chartManager.changeChartPeriod(30, 'month');
                    
                    // Add activity
                    dashboardManager.addActivity({
                        type: 'info',
                        title: 'Diagramm aktualisiert',
                        description: 'Umsatzdiagramm auf Monatsansicht geändert.'
                    });
                });
                
                // Touch feedback
                revenueMonthBtn.addEventListener('touchstart', function() {
                    if (window.innerWidth <= 768) {
                        this.style.transform = 'scale(0.95)';
                    }
                }, { passive: true });
            }
            
            if (revenueYearBtn) {
                revenueYearBtn.addEventListener('click', function() {
                    setActivePeriodButton(this);
                    chartManager.changeChartPeriod(365, 'year');
                    
                    // Add activity
                    dashboardManager.addActivity({
                        type: 'info',
                        title: 'Diagramm aktualisiert',
                        description: 'Umsatzdiagramm auf Jahresansicht geändert.'
                    });
                });
                
                // Touch feedback
                revenueYearBtn.addEventListener('touchstart', function() {
                    if (window.innerWidth <= 768) {
                        this.style.transform = 'scale(0.95)';
                    }
                }, { passive: true });
            }
            
            // Refresh activities
            const refreshActivitiesBtn = document.getElementById('refresh-activities');
            if (refreshActivitiesBtn) {
                refreshActivitiesBtn.addEventListener('click', function() {
                    // Add rotation animation
                    this.style.transform = 'rotate(180deg)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 300);
                    
                    dashboardManager.updateAllData();
                    uiManager.updateAll();
                    showNotification('Aktivitäten aktualisiert', 'success');
                });
                
                // Touch feedback
                refreshActivitiesBtn.addEventListener('touchstart', function() {
                    if (window.innerWidth <= 768) {
                        this.style.backgroundColor = 'var(--color-bg-secondary)';
                    }
                }, { passive: true });
            }
            
            // Refresh alerts
            const refreshAlertsBtn = document.getElementById('refresh-alerts');
            if (refreshAlertsBtn) {
                refreshAlertsBtn.addEventListener('click', function() {
                    // Add rotation animation
                    this.style.transform = 'rotate(180deg)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 300);
                    
                    dashboardManager.updateAllData();
                    uiManager.updateAll();
                    showNotification('Warnungen aktualisiert', 'success');
                });
                
                // Touch feedback
                refreshAlertsBtn.addEventListener('touchstart', function() {
                    if (window.innerWidth <= 768) {
                        this.style.backgroundColor = 'var(--color-bg-secondary)';
                    }
                }, { passive: true });
            }
            
            // Mobile refresh button
            const mobileRefreshBtn = document.getElementById('mobile-refresh');
            if (mobileRefreshBtn) {
                mobileRefreshBtn.addEventListener('click', function() {
                    dashboardManager.triggerRefresh();
                });
            }
            
            // AI help button in welcome card
            const aiHelpBtn = document.getElementById('ai-help-btn');
            if (aiHelpBtn) {
                aiHelpBtn.addEventListener('click', function() {
                    document.getElementById('ai-assistant').classList.add('active');
                    setTimeout(() => {
                        document.getElementById('ai-input').focus();
                    }, 100);
                });
            }
            
            // AI quick help button
            const aiQuickHelpBtn = document.getElementById('ai-quick-help');
            if (aiQuickHelpBtn) {
                aiQuickHelpBtn.addEventListener('click', function() {
                    document.getElementById('ai-assistant').classList.add('active');
                    setTimeout(() => {
                        document.getElementById('ai-input').focus();
                        
                        // Add a quick help question
                        const input = document.getElementById('ai-input');
                        input.value = 'Was sind meine Top-Produkte?';
                        setTimeout(() => {
                            document.getElementById('ai-send').click();
                        }, 50);
                    }, 100);
                });
            }
            
            // AI analyze products button
            const aiAnalyzeProductsBtn = document.getElementById('ai-analyze-products');
            if (aiAnalyzeProductsBtn) {
                aiAnalyzeProductsBtn.addEventListener('click', function() {
                    const analysis = dashboardManager.generateProductAnalysis();
                    uiManager.showAIAnalysisModal(analysis, false);
                });
            }
            
            // AI suggest goals button
            const aiSuggestGoalsBtn = document.getElementById('ai-suggest-goals');
            if (aiSuggestGoalsBtn) {
                aiSuggestGoalsBtn.addEventListener('click', function() {
                    const suggestions = dashboardManager.generateAISuggestedGoals();
                    
                    let analysis = `# KI-Zielvorschläge\n\n`;
                    analysis += `Basierend auf Ihren aktuellen Verkaufsdaten schlage ich folgende Ziele vor:\n\n`;
                    
                    suggestions.forEach((suggestion, index) => {
                        analysis += `## Vorschlag ${index + 1}: ${suggestion.title}\n`;
                        analysis += `- **Typ**: ${suggestion.type === 'revenue' ? 'Umsatz' : suggestion.type === 'customers' ? 'Kunden' : 'Produkte'}\n`;
                        analysis += `- **Zielwert**: ${suggestion.target} ${suggestion.type === 'revenue' ? '€' : ''}\n`;
                        analysis += `- **Begründung**: ${suggestion.reason}\n`;
                        analysis += `- **Frist**: ${new Date(suggestion.deadline).toLocaleDateString('de-DE')}\n\n`;
                    });
                    
                    analysis += `Möchten Sie eines dieser Ziele übernehmen?`;
                    
                    uiManager.showAIAnalysisModal(analysis, true);
                    
                    // Store suggestions for later use
                    this.dataset.suggestions = JSON.stringify(suggestions);
                });
            }
            
            // AI restock suggestions button
            const aiRestockBtn = document.getElementById('ai-restock-suggestions');
            if (aiRestockBtn) {
                aiRestockBtn.addEventListener('click', function() {
                    const restockData = dashboardManager.generateRestockSuggestions();
                    
                    let analysis = `# KI-Nachbestellvorschläge\n\n`;
                    
                    if (!restockData.hasSuggestions) {
                        analysis += restockData.message;
                    } else {
                        analysis += `${restockData.message}\n\n`;
                        analysis += `## Detailierte Vorschläge:\n\n`;
                        
                        restockData.suggestions.forEach((suggestion, index) => {
                            analysis += `### ${index + 1}. ${suggestion.product.name}\n`;
                            analysis += `- **Aktueller Bestand**: ${suggestion.currentStock}\n`;
                            analysis += `- **Empfohlene Menge**: ${suggestion.suggestedQuantity}\n`;
                            analysis += `- **Dringlichkeit**: ${suggestion.urgency}\n`;
                            analysis += `- **Geschätzte Kosten**: €${suggestion.estimatedCost.toFixed(2)}\n\n`;
                        });
                        
                        analysis += `## Zusammenfassung\n`;
                        analysis += `- **Gesamtkosten**: €${restockData.totalCost.toFixed(2)}\n`;
                        analysis += `- **Anzahl Produkte**: ${restockData.suggestions.length}\n`;
                        analysis += `- **Dringlichkeit**: ${restockData.suggestions.some(s => s.urgency === 'Hoch') ? 'Hoch - sofort handeln' : 'Mittel - bald nachbestellen'}\n`;
                    }
                    
                    uiManager.showAIAnalysisModal(analysis, false);
                });
            }
            
            // Add goal button
            const addGoalBtn = document.getElementById('add-goal-btn');
            if (addGoalBtn) {
                addGoalBtn.addEventListener('click', function() {
                    document.getElementById('goal-modal-title').textContent = 'Ziel hinzufügen';
                    document.getElementById('goal-title').value = '';
                    document.getElementById('goal-type').value = 'revenue';
                    document.getElementById('goal-target').value = '';
                    
                    // Remove any existing goal ID from save button
                    document.getElementById('save-goal').removeAttribute('data-goal-id');
                    
                    // Set default deadline to end of current month
                    const currentDate = new Date();
                    const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
                    document.getElementById('goal-deadline').value = lastDay.toISOString().split('T')[0];
                    
                    document.getElementById('goal-modal').classList.add('active');
                    document.body.style.overflow = 'hidden';
                });
                
                // Touch feedback
                addGoalBtn.addEventListener('touchstart', function() {
                    if (window.innerWidth <= 768) {
                        this.style.transform = 'scale(0.95)';
                    }
                }, { passive: true });
            }
            
            // Save goal
            const saveGoalBtn = document.getElementById('save-goal');
            if (saveGoalBtn) {
                saveGoalBtn.addEventListener('click', function() {
                    const goalId = this.getAttribute('data-goal-id');
                    const title = document.getElementById('goal-title').value.trim();
                    const type = document.getElementById('goal-type').value;
                    const target = parseFloat(document.getElementById('goal-target').value);
                    const deadline = document.getElementById('goal-deadline').value;
                    
                    // Validation
                    if (!title) {
                        showNotification('Bitte geben Sie einen Zielnamen ein.', 'error');
                        document.getElementById('goal-title').focus();
                        return;
                    }
                    
                    if (!target || target <= 0) {
                        showNotification('Bitte geben Sie einen gültigen Zielwert ein.', 'error');
                        document.getElementById('goal-target').focus();
                        return;
                    }
                    
                    if (!deadline) {
                        showNotification('Bitte wählen Sie ein Fälligkeitsdatum.', 'error');
                        document.getElementById('goal-deadline').focus();
                        return;
                    }
                    
                    if (goalId) {
                        // Update existing goal
                        const success = dashboardManager.updateGoal(goalId, { title, type, target, deadline });
                        if (success) {
                            uiManager.updateAll();
                            document.getElementById('goal-modal').classList.remove('active');
                            document.body.style.overflow = '';
                            showNotification('Ziel erfolgreich aktualisiert', 'success');
                            this.removeAttribute('data-goal-id');
                        } else {
                            showNotification('Fehler beim Aktualisieren des Ziels', 'error');
                        }
                    } else {
                        // Add new goal
                        const goal = {
                            title,
                            type,
                            target,
                            deadline
                        };
                        
                        const addedGoal = dashboardManager.addGoal(goal);
                        if (addedGoal) {
                            uiManager.updateAll();
                            document.getElementById('goal-modal').classList.remove('active');
                            document.body.style.overflow = '';
                            showNotification('Ziel erfolgreich hinzugefügt', 'success');
                        } else {
                            showNotification('Fehler beim Hinzufügen des Ziels', 'error');
                        }
                    }
                });
            }
            
            // Cancel goal
            const cancelGoalBtn = document.getElementById('cancel-goal');
            if (cancelGoalBtn) {
                cancelGoalBtn.addEventListener('click', function() {
                    document.getElementById('goal-modal').classList.remove('active');
                    document.body.style.overflow = '';
                });
            }
            
            // Close goal modal
            const closeGoalModalBtn = document.getElementById('close-goal-modal');
            if (closeGoalModalBtn) {
                closeGoalModalBtn.addEventListener('click', function() {
                    document.getElementById('goal-modal').classList.remove('active');
                    document.body.style.overflow = '';
                });
            }
            
            // Goal actions (edit/delete) - event delegation
            document.addEventListener('click', function(e) {
                if (e.target.closest('.goal-btn.edit')) {
                    const goalId = e.target.closest('.goal-btn.edit').getAttribute('data-goal-id');
                    const goals = dashboardManager.getGoals();
                    const goal = goals.find(g => g.id === goalId);
                    
                    if (goal) {
                        document.getElementById('goal-modal-title').textContent = 'Ziel bearbeiten';
                        document.getElementById('goal-title').value = goal.title;
                        document.getElementById('goal-type').value = goal.type;
                        document.getElementById('goal-target').value = goal.target;
                        document.getElementById('goal-deadline').value = goal.deadline.split('T')[0];
                        
                        // Store the goal ID for updating
                        document.getElementById('save-goal').setAttribute('data-goal-id', goalId);
                        
                        document.getElementById('goal-modal').classList.add('active');
                        document.body.style.overflow = 'hidden';
                    }
                }
                
                if (e.target.closest('.goal-btn.delete')) {
                    const goalId = e.target.closest('.goal-btn.delete').getAttribute('data-goal-id');
                    const goals = dashboardManager.getGoals();
                    const goal = goals.find(g => g.id === goalId);
                    
                    if (goal && confirm(`Möchten Sie das Ziel "${goal.title}" wirklich löschen?`)) {
                        const success = dashboardManager.deleteGoal(goalId);
                        if (success) {
                            uiManager.updateAll();
                            showNotification('Ziel gelöscht', 'success');
                        } else {
                            showNotification('Fehler beim Löschen des Ziels', 'error');
                        }
                    }
                }
            });
            
            // Apply analysis button
            const applyAnalysisBtn = document.getElementById('apply-analysis-btn');
            if (applyAnalysisBtn) {
                applyAnalysisBtn.addEventListener('click', function() {
                    const aiSuggestGoalsBtn = document.getElementById('ai-suggest-goals');
                    const suggestions = aiSuggestGoalsBtn ? JSON.parse(aiSuggestGoalsBtn.dataset.suggestions || '[]') : [];
                    
                    if (suggestions.length > 0) {
                        // Add the first suggestion as a goal
                        const suggestion = suggestions[0];
                        const goal = {
                            title: suggestion.title,
                            type: suggestion.type,
                            target: suggestion.target,
                            deadline: suggestion.deadline,
                            aiSuggested: true
                        };
                        
                        const addedGoal = dashboardManager.addGoal(goal);
                        if (addedGoal) {
                            uiManager.updateAll();
                            document.getElementById('ai-analysis-modal').classList.remove('active');
                            document.body.style.overflow = '';
                            showNotification('KI-Vorschlag wurde als Ziel übernommen', 'success');
                        } else {
                            showNotification('Fehler beim Übernehmen des KI-Vorschlags', 'error');
                        }
                    } else {
                        showNotification('Keine KI-Vorschläge verfügbar', 'warning');
                    }
                });
            }
            
            // Close analysis modal
            const closeAnalysisBtn = document.getElementById('close-analysis-btn');
            const closeAiAnalysisModalBtn = document.getElementById('close-ai-analysis-modal');
            
            if (closeAnalysisBtn) {
                closeAnalysisBtn.addEventListener('click', function() {
                    document.getElementById('ai-analysis-modal').classList.remove('active');
                    document.body.style.overflow = '';
                });
            }
            
            if (closeAiAnalysisModalBtn) {
                closeAiAnalysisModalBtn.addEventListener('click', function() {
                    document.getElementById('ai-analysis-modal').classList.remove('active');
                    document.body.style.overflow = '';
                });
            }
            
            // Quick sale button
            const quickSaleBtn = document.getElementById('quick-sale-btn');
            if (quickSaleBtn) {
                quickSaleBtn.addEventListener('click', function() {
                    // Update product dropdown first
                    uiManager.updateProductDropdown();
                    
                    document.getElementById('quick-sale-modal').classList.add('active');
                    document.body.style.overflow = 'hidden';
                    
                    // Focus on first input
                    setTimeout(() => {
                        const productSelect = document.getElementById('sale-product');
                        if (productSelect) productSelect.focus();
                    }, 100);
                });
            }
            
            // Complete quick sale
            const completeQuickSaleBtn = document.getElementById('complete-quick-sale');
            if (completeQuickSaleBtn) {
                completeQuickSaleBtn.addEventListener('click', function() {
                    const productId = document.getElementById('sale-product').value;
                    const quantity = parseInt(document.getElementById('sale-quantity').value);
                    const price = parseFloat(document.getElementById('sale-price').value);
                    const customer = document.getElementById('sale-customer').value.trim();
                    
                    // Validation
                    if (!productId) {
                        showNotification('Bitte wählen Sie ein Produkt.', 'error');
                        document.getElementById('sale-product').focus();
                        return;
                    }
                    
                    if (!quantity || quantity <= 0) {
                        showNotification('Bitte geben Sie eine gültige Menge ein.', 'error');
                        document.getElementById('sale-quantity').focus();
                        return;
                    }
                    
                    if (!price || price <= 0) {
                        showNotification('Bitte geben Sie einen gültigen Preis ein.', 'error');
                        document.getElementById('sale-price').focus();
                        return;
                    }
                    
                    const result = dashboardManager.processQuickSale({
                        productId,
                        quantity,
                        price,
                        customer
                    });
                    
                    if (result.success) {
                        uiManager.updateAll();
                        document.getElementById('quick-sale-modal').classList.remove('active');
                        document.body.style.overflow = '';
                        showNotification(result.message, 'success');
                        
                        // Reset form
                        document.getElementById('sale-quantity').value = 1;
                        document.getElementById('sale-customer').value = '';
                    } else {
                        showNotification(result.message, 'error');
                    }
                });
            }
            
            // Cancel quick sale
            const cancelQuickSaleBtn = document.getElementById('cancel-quick-sale');
            if (cancelQuickSaleBtn) {
                cancelQuickSaleBtn.addEventListener('click', function() {
                    document.getElementById('quick-sale-modal').classList.remove('active');
                    document.body.style.overflow = '';
                });
            }
            
            // Close quick sale modal
            const closeQuickSaleModalBtn = document.getElementById('close-quick-sale-modal');
            if (closeQuickSaleModalBtn) {
                closeQuickSaleModalBtn.addEventListener('click', function() {
                    document.getElementById('quick-sale-modal').classList.remove('active');
                    document.body.style.overflow = '';
                });
            }
            
            // Backup data button
            const backupDataBtn = document.getElementById('backup-data-btn');
            if (backupDataBtn) {
                backupDataBtn.addEventListener('click', function() {
                    try {
                        // Create a backup of important data
                        const receipts = dashboardManager.getReceipts();
                        const products = dashboardManager.getProducts();
                        const goals = dashboardManager.getGoals();
                        const activities = dashboardManager.getActivities();
                        
                        const backupData = {
                            receipts,
                            products: Object.values(products),
                            goals,
                            activities,
                            backupDate: new Date().toISOString(),
                            version: '1.0',
                            app: 'Gittertier Pro'
                        };
                        
                        const dataStr = JSON.stringify(backupData, null, 2);
                        const dataUri = `data:application/json;charset=utf-8,${encodeURIComponent(dataStr)}`;
                        
                        const exportFileDefaultName = `gittertier_backup_${new Date().toISOString().split('T')[0]}.json`;
                        
                        const linkElement = document.createElement('a');
                        linkElement.setAttribute('href', dataUri);
                        linkElement.setAttribute('download', exportFileDefaultName);
                        linkElement.style.display = 'none';
                        document.body.appendChild(linkElement);
                        linkElement.click();
                        document.body.removeChild(linkElement);
                        
                        // Add activity
                        dashboardManager.addActivity({
                            type: 'success',
                            title: 'Backup erstellt',
                            description: 'Ein Backup Ihrer Daten wurde erstellt.'
                        });
                        
                        uiManager.updateAll();
                        showNotification('Backup erfolgreich erstellt', 'success');
                    } catch (error) {
                        console.error('Error creating backup:', error);
                        showNotification('Fehler beim Erstellen des Backups', 'error');
                    }
                });
                
                // Touch feedback
                backupDataBtn.addEventListener('touchstart', function() {
                    if (window.innerWidth <= 768) {
                        this.style.transform = 'scale(0.95)';
                    }
                }, { passive: true });
            }
            
            // AI Assistant toggle
            const aiToggle = document.getElementById('ai-toggle');
            if (aiToggle) {
                aiToggle.addEventListener('click', function() {
                    const aiAssistant = document.getElementById('ai-assistant');
                    aiAssistant.classList.toggle('active');
                    
                    if (aiAssistant.classList.contains('active')) {
                        setTimeout(() => {
                            document.getElementById('ai-input').focus();
                        }, 100);
                    }
                });
                
                // Touch feedback
                aiToggle.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                }, { passive: true });
            }
            
            // AI Assistant close
            const aiClose = document.getElementById('ai-close');
            if (aiClose) {
                aiClose.addEventListener('click', function() {
                    document.getElementById('ai-assistant').classList.remove('active');
                });
                
                // Touch feedback
                aiClose.addEventListener('touchstart', function() {
                    if (window.innerWidth <= 768) {
                        this.style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
                    }
                }, { passive: true });
            }
            
            // AI Assistant send message
            const aiSend = document.getElementById('ai-send');
            if (aiSend) {
                aiSend.addEventListener('click', function() {
                    sendAIMessage();
                });
                
                // Touch feedback
                aiSend.addEventListener('touchstart', function() {
                    if (window.innerWidth <= 768) {
                        this.style.transform = 'scale(0.95)';
                    }
                }, { passive: true });
            }
            
            // AI Assistant input enter key
            const aiInput = document.getElementById('ai-input');
            if (aiInput) {
                aiInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendAIMessage();
                    }
                });
                
                // Clear placeholder on focus for mobile
                aiInput.addEventListener('focus', function() {
                    if (window.innerWidth <= 768) {
                        this.setAttribute('data-placeholder', this.getAttribute('placeholder'));
                        this.setAttribute('placeholder', '');
                    }
                });
                
                aiInput.addEventListener('blur', function() {
                    if (window.innerWidth <= 768 && this.getAttribute('data-placeholder')) {
                        this.setAttribute('placeholder', this.getAttribute('data-placeholder'));
                        this.removeAttribute('data-placeholder');
                    }
                });
            }
            
            // AI quick command buttons
            document.addEventListener('click', function(e) {
                if (e.target.closest('.ai-command-btn')) {
                    const command = e.target.closest('.ai-command-btn').getAttribute('data-command');
                    const aiInput = document.getElementById('ai-input');
                    
                    if (aiInput) {
                        aiInput.value = command;
                        sendAIMessage();
                    }
                }
            });
            
            // Alert actions
            document.addEventListener('click', function(e) {
                if (e.target.closest('.alert-action')) {
                    const productId = e.target.closest('.alert-action').getAttribute('data-product-id');
                    const products = dashboardManager.getProducts();
                    const product = products[productId];
                    
                    if (product) {
                        // In a real app, this would trigger an order process
                        // For now, show a confirmation
                        if (confirm(`Möchten Sie ${product.name} nachbestellen?`)) {
                            showNotification(`Nachbestellung für ${product.name} wurde ausgelöst`, 'success');
                            
                            // Add activity
                            dashboardManager.addActivity({
                                type: 'info',
                                title: 'Nachbestellung ausgelöst',
                                description: `${product.name} wurde zur Nachbestellung markiert.`
                            });
                            
                            uiManager.updateAll();
                        }
                    }
                }
            });
            
            // Other quick action buttons
            const addProductBtn = document.getElementById('add-product-btn');
            if (addProductBtn) {
                addProductBtn.addEventListener('click', function() {
                    window.location.href = 'products';
                });
            }
            
            const viewReportsBtn = document.getElementById('view-reports-btn');
            if (viewReportsBtn) {
                viewReportsBtn.addEventListener('click', function() {
                    window.location.href = 'analytics';
                });
            }
            
            // Export products button
            const exportProductsBtn = document.getElementById('export-products');
            if (exportProductsBtn) {
                exportProductsBtn.addEventListener('click', function() {
                    try {
                        const products = dashboardManager.getProductPerformance();
                        const dataStr = JSON.stringify(products, null, 2);
                        const dataUri = `data:application/json;charset=utf-8,${encodeURIComponent(dataStr)}`;
                        
                        const linkElement = document.createElement('a');
                        linkElement.setAttribute('href', dataUri);
                        linkElement.setAttribute('download', `produkt_performance_${new Date().toISOString().split('T')[0]}.json`);
                        linkElement.style.display = 'none';
                        document.body.appendChild(linkElement);
                        linkElement.click();
                        document.body.removeChild(linkElement);
                        
                        showNotification('Produktdaten exportiert', 'success');
                    } catch (error) {
                        console.error('Error exporting products:', error);
                        showNotification('Fehler beim Exportieren der Produktdaten', 'error');
                    }
                });
            }
            
            // Window resize handler for responsive updates
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    uiManager.updateAll();
                    chartManager.updateCharts();
                }, 250);
            });
            
            // Close modals when clicking outside
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-overlay')) {
                    e.target.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
            
            // Close modals with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                        modal.classList.remove('active');
                        document.body.style.overflow = '';
                    });
                    
                    // Also close AI assistant
                    document.getElementById('ai-assistant').classList.remove('active');
                }
            });
            
            // Prevent form submission on Enter in modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.target.closest('.modal')) {
                    if (e.target.type !== 'textarea' && e.target.type !== 'submit' && !e.target.classList.contains('ai-input')) {
                        e.preventDefault();
                    }
                }
            });
        }

        // Send AI message
        function sendAIMessage() {
            const input = document.getElementById('ai-input');
            const sendBtn = document.getElementById('ai-send');
            const message = input.value.trim();
            
            if (message && !sendBtn.disabled) {
                // Disable send button while processing
                sendBtn.disabled = true;
                
                // Add user message
                uiManager.addAIMessage(message, true);
                
                // Clear input
                input.value = '';
                
                // Show typing indicator
                const typingIndicator = uiManager.showTypingIndicator();
                
                // Get AI response after a short delay
                setTimeout(() => {
                    try {
                        const response = dashboardManager.getAIResponse(message);
                        uiManager.hideTypingIndicator();
                        uiManager.addAIMessage(response);
                        
                        // Re-enable send button
                        sendBtn.disabled = false;
                        input.focus();
                    } catch (error) {
                        console.error('Error sending AI message:', error);
                        uiManager.hideTypingIndicator();
                        uiManager.addAIMessage('Entschuldigung, es ist ein Fehler aufgetreten. Bitte versuchen Sie es erneut.');
                        sendBtn.disabled = false;
                        input.focus();
                    }
                }, 1000 + Math.random() * 1000); // Random delay for natural feel
            }
        }

        // Time display function
        function updateTime() {
            try {
                const now = new Date();
                const timeDisplay = document.getElementById('timeDisplay');
                
                if (timeDisplay) {
                    const timeString = now.toLocaleTimeString('de-DE', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: window.innerWidth <= 768 ? undefined : '2-digit'
                    });
                    const dateString = now.toLocaleDateString('de-DE', {
                        weekday: window.innerWidth <= 768 ? 'short' : 'long',
                        day: '2-digit',
                        month: window.innerWidth <= 768 ? 'short' : 'long',
                        year: window.innerWidth <= 768 ? undefined : 'numeric'
                    });
                    timeDisplay.textContent = window.innerWidth <= 768 ? 
                        `${dateString}, ${timeString}` : 
                        `${dateString}, ${timeString}`;
                }
            } catch (error) {
                console.error('Error updating time:', error);
            }
        }

        // Show notification function
        function showNotification(message, type = 'success') {
            try {
                // Create notification element if it doesn't exist
                let notification = document.querySelector('.notification-toast');
                if (!notification) {
                    notification = document.createElement('div');
                    notification.className = 'notification-toast';
                    document.body.appendChild(notification);
                }
                
                notification.textContent = message;
                notification.className = 'notification-toast';
                if (type) notification.classList.add(type);
                
                // Remove any existing show class
                notification.classList.remove('show');
                
                // Trigger reflow
                void notification.offsetWidth;
                
                // Add show class
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.textContent === message) {
                            notification.textContent = '';
                            notification.className = 'notification-toast';
                        }
                    }, 300);
                }, 3000);
            } catch (error) {
                console.error('Error showing notification:', error);
            }
        }

        // Token verification
        (function() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const urlToken = decodeURIComponent(urlParams.get('token') || '');
                const validTokens = JSON.parse(sessionStorage.getItem('validTokens') || '[]');
                const tokenIndex = validTokens.indexOf(urlToken);

                if(tokenIndex === -1) {
                    const redirect = encodeURIComponent(window.location.href);
                    window.location.href = `login?redirect=${redirect}`;
                } else {
                    // Remove used token and clean URL
                    validTokens.splice(tokenIndex, 1);
                    sessionStorage.setItem('validTokens', JSON.stringify(validTokens));
                    history.replaceState(null, null, window.location.pathname);
                }
            } catch (error) {
                console.error('Token verification error:', error);
                window.location.href = 'login';
            }
        })();
    </script>
</body>
</html>