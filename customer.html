<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Payment</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <!-- Add Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    :root {
        --color-bg: #ffffff;
        --color-text: #111111;
        --color-text-muted: #6b7280;
        --color-border: #e5e7eb;
        --color-accent: #2563eb;
        --color-accent-hover: #1d4ed8;
        --color-success: #16a34a;
        --color-error: #dc2626;
        --color-warning: #f59e0b;
        --color-overlay: rgba(0, 0, 0, 0.5);
        
        --radius: 12px;
        --radius-sm: 6px;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.07), 0 1px 2px rgba(0, 0, 0, 0.04);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --focus-ring: 0 0 0 3px rgba(37, 99, 235, 0.35);
        
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;
        --spacing-xxl: 48px;
        
        --transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
        --transition-slow: all 0.3s cubic-bezier(0.2, 0, 0, 1);
        
        --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, "Helvetica Neue", Arial, sans-serif;
        --text-xs: 0.75rem;
        --text-sm: 0.875rem;
        --text-base: 1rem;
        --text-lg: 1.125rem;
        --text-xl: 1.25rem;
        --text-2xl: 1.5rem;
        --text-3xl: 1.875rem;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: var(--font-family);
        background-color: var(--color-bg);
        color: var(--color-text);
        line-height: 1.5;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: var(--spacing-lg);
    }

    .container {
        max-width: 600px;
        width: 100%;
    }

    .payment-card {
        background: var(--color-bg);
        border-radius: var(--radius);
        border: 1px solid var(--color-border);
        box-shadow: var(--shadow);
        padding: var(--spacing-xl);
        text-align: center;
        position: relative;
        overflow: hidden;
        animation: fadeIn 0.4s ease-out;
    }

    .payment-header {
        margin-bottom: var(--spacing-xl);
    }

    .payment-title {
        font-size: var(--text-2xl);
        font-weight: 700;
        margin-bottom: var(--spacing-sm);
        color: var(--color-text);
    }

    .payment-subtitle {
        color: var(--color-text-muted);
        font-size: var(--text-base);
    }

    .amount {
        font-size: var(--text-3xl);
        font-weight: 700;
        margin: var(--spacing-lg) 0;
        color: var(--color-text);
    }

    .items-list {
        margin: var(--spacing-lg) 0;
        text-align: left;
    }

    .item-box {
        background: #f9fafb;
        border-radius: var(--radius);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-sm);
        border: 1px solid var(--color-border);
    }

    .item-box h3 {
        font-size: var(--text-base);
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
    }

    .item-box p {
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        margin-bottom: var(--spacing-xs);
    }

    #qrcode {
        margin: var(--spacing-xl) auto;
        padding: var(--spacing-md);
        background: #f9fafb;
        border-radius: var(--radius);
        display: inline-block;
        border: 1px solid var(--color-border);
        box-shadow: var(--shadow);
        max-width: 100%;
        overflow: hidden;
    }

    #qrcode canvas, 
    #qrcode img {
        max-width: 100%;
        height: auto !important;
        display: block;
        margin: 0 auto;
    }

    .countdown-container {
        margin: var(--spacing-lg) 0;
        font-size: var(--text-base);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        color: var(--color-text);
    }

    .countdown-value {
        font-weight: 700;
        font-size: var(--text-lg);
        background: #f3f4f6;
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--radius-sm);
    }

    .status {
        padding: var(--spacing-md);
        border-radius: var(--radius);
        margin: var(--spacing-lg) 0;
        font-size: var(--text-base);
        font-weight: 600;
        transition: all 0.3s ease;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        box-shadow: var(--shadow);
    }

    .status.pending {
        background: #fffbeb;
        color: #b45309;
        border: 1px solid #fcd34d;
    }

    .status.confirmed {
        background: #f0fdf4;
        color: #166534;
        border: 1px solid #86efac;
    }

    .status.declined {
        background: #fef2f2;
        color: #991b1b;
        border: 1px solid #fca5a5;
    }

    .payment-footer {
        text-align: center;
        margin-top: var(--spacing-xl);
        color: var(--color-text-muted);
        font-size: var(--text-sm);
        padding-top: var(--spacing-md);
        border-top: 1px solid var(--color-border);
    }

    /* Error Modal Styles */
    .error-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--color-overlay);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.4s ease;
    }

    .error-modal.active {
        opacity: 1;
        pointer-events: all;
    }

    .error-content {
        background: var(--color-bg);
        border-radius: var(--radius);
        padding: var(--spacing-xl);
        text-align: center;
        width: 90%;
        max-width: 500px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--color-border);
        transform: scale(0.9);
        opacity: 0;
        transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.5s ease;
    }

    .error-modal.active .error-content {
        transform: scale(1);
        opacity: 1;
    }

    .error-icon {
        font-size: var(--text-3xl);
        margin-bottom: var(--spacing-md);
        color: var(--color-error);
    }

    .error-title {
        font-size: var(--text-xl);
        color: var(--color-text);
        margin-bottom: var(--spacing-md);
        font-weight: 700;
    }

    .error-message {
        font-size: var(--text-base);
        color: var(--color-text-muted);
        margin-bottom: var(--spacing-lg);
        line-height: 1.6;
    }

    .error-details {
        background: #f9fafb;
        padding: var(--spacing-md);
        border-radius: var(--radius-sm);
        margin-top: var(--spacing-md);
        color: var(--color-text-muted);
        font-size: var(--text-sm);
        border-left: 4px solid var(--color-error);
    }

    .error-footer {
        color: var(--color-text-muted);
        margin-top: var(--spacing-md);
        font-size: var(--text-xs);
    }

    /* Connection Modal */
    .connection-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--color-overlay);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1500;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.4s ease;
    }

    .connection-modal.active {
        opacity: 1;
        pointer-events: all;
    }

    .connection-content {
        background: var(--color-bg);
        border-radius: var(--radius);
        padding: var(--spacing-xl);
        text-align: center;
        width: 90%;
        max-width: 500px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--color-border);
        transform: scale(0.9);
        opacity: 0;
        transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.5s ease;
    }

    .connection-modal.active .connection-content {
        transform: scale(1);
        opacity: 1;
    }

    .connection-icon {
        font-size: var(--text-3xl);
        margin-bottom: var(--spacing-md);
        color: var(--color-accent);
        animation: rotate 2s linear infinite;
    }

    .connection-title {
        font-size: var(--text-xl);
        color: var(--color-text);
        margin-bottom: var(--spacing-md);
        font-weight: 700;
    }

    .connection-message {
        font-size: var(--text-base);
        color: var(--color-text-muted);
        margin-bottom: var(--spacing-lg);
        line-height: 1.6;
    }

    /* Status Modals */
    .status-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--color-overlay);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1500;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.4s ease;
    }

    .status-modal.active {
        opacity: 1;
        pointer-events: all;
    }

    .status-content {
        background: var(--color-bg);
        border-radius: var(--radius);
        padding: var(--spacing-xl);
        text-align: center;
        width: 90%;
        max-width: 500px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--color-border);
        transform: scale(0.9);
        opacity: 0;
        transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.6s ease;
    }

    .status-modal.active .status-content {
        transform: scale(1);
        opacity: 1;
    }

    .status-icon {
        font-size: var(--text-3xl);
        margin-bottom: var(--spacing-md);
        animation: float 3s ease-in-out infinite;
    }

    /* Confirmed state */
    .status-content.confirmed .status-icon {
        color: var(--color-success);
    }

    /* Declined state */
    .status-content.declined .status-icon {
        color: var(--color-error);
    }

    /* Pending state */
    .status-content.pending .status-icon {
        color: var(--color-warning);
        animation: rotate 2s linear infinite;
    }

    .status-title {
        font-size: var(--text-xl);
        margin-bottom: var(--spacing-md);
        font-weight: 700;
        color: var(--color-text);
    }

    .status-message {
        font-size: var(--text-base);
        margin-bottom: var(--spacing-lg);
        line-height: 1.6;
        color: var(--color-text-muted);
    }

    /* Animation Keyframes */
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7);
        }
        70% {
            box-shadow: 0 0 0 15px rgba(37, 99, 235, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
        }
    }

    @keyframes float {
        0% {
            transform: translateY(0px);
        }
        50% {
            transform: translateY(-10px);
        }
        100% {
            transform: translateY(0px);
        }
    }

    @keyframes rotate {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(360deg);
        }
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .payment-card {
            padding: var(--spacing-lg);
        }
        
        .payment-title {
            font-size: var(--text-xl);
        }
        
        .amount {
            font-size: var(--text-2xl);
        }
        
        #qrcode {
            padding: var(--spacing-sm);
            margin: var(--spacing-lg) auto;
        }
        
        .status {
            padding: var(--spacing-sm);
            font-size: var(--text-sm);
        }
        
        .error-content,
        .connection-content,
        .status-content {
            padding: var(--spacing-lg);
        }
        
        .error-title,
        .connection-title,
        .status-title {
            font-size: var(--text-lg);
        }
        
        .error-message,
        .connection-message,
        .status-message {
            font-size: var(--text-sm);
        }
    }

    @media (max-width: 480px) {
        body {
            padding: var(--spacing-md);
        }
        
        .payment-card {
            padding: var(--spacing-md);
        }
        
        .payment-title {
            font-size: var(--text-lg);
        }
        
        .payment-subtitle {
            font-size: var(--text-sm);
        }
        
        .amount {
            font-size: var(--text-xl);
            margin: var(--spacing-md) 0;
        }
        
        .countdown-container {
            font-size: var(--text-sm);
        }
        
        .countdown-value {
            font-size: var(--text-base);
        }
        
        .error-content,
        .connection-content,
        .status-content {
            padding: var(--spacing-md);
        }
        
        .error-title,
        .connection-title,
        .status-title {
            font-size: var(--text-lg);
        }
        
        .error-message,
        .connection-message,
        .status-message {
            font-size: var(--text-sm);
        }
    }
    </style>
</head>
<body>
    <div class="container">
        <div class="payment-card">
            <div class="payment-header">
                <h1 class="payment-title">Zahlung erforderlich</h1>
                <p class="payment-subtitle">Scannen Sie den QR-Code mit dem Händlergerät</p>
            </div>
            
            <div class="amount" id="amount">€0.00</div>
            
            <div id="items-list" class="items-list"></div>
            
            <div id="qrcode"></div>
            
            <!-- Countdown timer -->
            <div class="countdown-container">
                QR-Code gültig für: 
                <span id="countdown-value" class="countdown-value">60</span>
                Sekunden
            </div>
            
            <div id="status" class="status pending">
                <i class="fas fa-clock"></i>
                <span>Zahlung ausstehend</span>
            </div>
        </div>
    </div>
    
    <!-- Error Modal -->
    <div class="error-modal" id="errorModal">
        <div class="error-content">
            <div class="error-icon">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <h2 class="error-title">Kritischer Fehler</h2>
            <p class="error-message">Die Zahlungsinformationen konnten nicht geladen werden.</p>
            <div class="error-details">Bitte überprüfen Sie die URL oder versuchen Sie es später erneut.</div>
            <p class="error-footer">Fehlercode: PAY-ERR-004</p>
        </div>
    </div>
    
    <!-- Merchant Connection Modal -->
    <div class="connection-modal" id="connectionModal">
        <div class="connection-content">
            <div class="connection-icon">
                <i class="fas fa-hourglass-half"></i>
            </div>
            <h2 class="connection-title">Händler verbunden!</h2>
            <p class="connection-message">Der Händler hat eine Verbindung hergestellt. Bitte warten Sie auf die Bestätigung der Zahlung.</p>
        </div>
    </div>
    
    <!-- Confirmed Status Modal -->
    <div class="status-modal" id="confirmedModal">
        <div class="status-content confirmed">
            <div class="status-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2 class="status-title">Bestätigt!</h2>
            <p class="status-message">Ihre Zahlung wurde erfolgreich bestätigt.</p>
        </div>
    </div>
    
    <!-- Declined Status Modal -->
    <div class="status-modal" id="declinedModal">
        <div class="status-content declined">
            <div class="status-icon">
                <i class="fas fa-times-circle"></i>
            </div>
            <h2 class="status-title">Abgelehnt!</h2>
            <p class="status-message">Ihre Zahlung wurde leider abgelehnt.</p>
        </div>
    </div>
    
    <!-- Pending Status Modal -->
    <div class="status-modal" id="pendingModal">
        <div class="status-content pending">
            <div class="status-icon">
                <i class="fas fa-hourglass-half"></i>
            </div>
            <h2 class="status-title">In Bearbeitung</h2>
            <p class="status-message">Ihre Zahlung wird verarbeitet...</p>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        let paymentId = 'PAY-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
        let peer = null;
        let paymentData = null;
        let refreshInterval = null;
        let countdownInterval = null;
        let countdownTime = 60; // seconds
        
        // Get modals
        const errorModal = document.getElementById('errorModal');
        const connectionModal = document.getElementById('connectionModal');
        const confirmedModal = document.getElementById('confirmedModal');
        const declinedModal = document.getElementById('declinedModal');
        const pendingModal = document.getElementById('pendingModal');
        
        // Function to show error modal
        function showErrorModal() {
            errorModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        // Function to show connection modal
        function showConnectionModal() {
            connectionModal.classList.add('active');
        }
        
        // Function to hide connection modal
        function hideConnectionModal() {
            connectionModal.classList.remove('active');
        }
        
        // Function to show status modal
        function showStatusModal(modal) {
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        // Start countdown timer
        function startCountdown() {
            const countdownElement = document.getElementById('countdown-value');
            countdownElement.textContent = countdownTime;
            
            countdownInterval = setInterval(() => {
                countdownTime--;
                countdownElement.textContent = countdownTime;
                
                if (countdownTime <= 0) {
                    clearInterval(countdownInterval);
                    location.reload();
                }
            }, 1000);
        }
        
        // Stop all intervals
        function stopAllIntervals() {
            if (refreshInterval) clearInterval(refreshInterval);
            if (countdownInterval) clearInterval(countdownInterval);
        }
        
        // Initialize payment
        function initPayment() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const compressedData = urlParams.get('id');
                if (!compressedData) throw new Error('Keine Zahlungsdaten gefunden');
                
                const jsonString = LZString.decompressFromBase64(compressedData);
                if (!jsonString) throw new Error('Daten-Dekompression fehlgeschlagen');
                
                paymentData = JSON.parse(jsonString);
                if (!paymentData?.items || !paymentData?.total) throw new Error('Ungültige Datenstruktur');
                
                // Initialize PeerJS
                peer = new Peer(paymentId, {
                    debug: 3,
                    config: {'iceServers': [{ urls: 'stun:stun.l.google.com:19302' }]}
                });
                
                // Set up auto-refresh
                refreshInterval = setInterval(() => {
                    location.reload();
                }, 60000);
                
                // Start countdown
                startCountdown();
                
                // Display payment data
                document.getElementById('amount').textContent = `€ ${paymentData.total.toFixed(2)}`;
                const itemsList = document.getElementById('items-list');
                itemsList.innerHTML = '';
                
                paymentData.items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'item-box';
                    div.innerHTML = `
                        <h3>${item.name}</h3>
                        <p>${item.quantity}x € ${item.price.toFixed(2)}</p>
                        <p>Summe: € ${(item.quantity * item.price).toFixed(2)}</p>
                    `;
                    itemsList.appendChild(div);
                });
                
                generateQR();
                
                // Listen for connections
                peer.on('connection', (conn) => {
                    // Stop refreshing and countdown when merchant connects
                    stopAllIntervals();
                    showConnectionModal();
                    
                    conn.on('data', (data) => {
                        hideConnectionModal();
                        const statusEl = document.getElementById('status');
                        
                        if (data.type === 'confirm') {
                            statusEl.className = 'status confirmed';
                            statusEl.innerHTML = '<i class="fas fa-check-circle"></i><span>Zahlung bestätigt!</span>';
                            saveToArchive('Bestätigt');
                            generateReceipt('Bestätigt');
                            showStatusModal(confirmedModal);
                        } else if (data.type === 'decline') {
                            statusEl.className = 'status declined';
                            statusEl.innerHTML = '<i class="fas fa-times-circle"></i><span>Zahlung abgelehnt</span>';
                            saveToArchive('Abgelehnt');
                            generateReceipt('Abgelehnt');
                            showStatusModal(declinedModal);
                        } else if (data.type === 'pending') {
                            statusEl.className = 'status pending';
                            statusEl.innerHTML = '<i class="fas fa-clock"></i><span>Zahlung in Bearbeitung</span>';
                            showStatusModal(pendingModal);
                        }
                    });
                });
                
            } catch(e) {
                showErrorModal();
                console.error('Payment initialization error: ' + e.message);
            }
        }
        
        function saveToArchive(status) {
            const archiveEntry = {
                data: LZString.compressToBase64(JSON.stringify({
                    ...paymentData,
                    peerId: paymentId,
                    date: new Date().toISOString()
                })),
                date: new Date().toISOString(),
                total: paymentData.total,
                status: status
            };
            
            const shortId = paymentId.split('-').pop().substr(0, 8);
            localStorage.setItem(`receipt_${shortId}`, JSON.stringify(archiveEntry));
        }

        function generateQR() {
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            
            // Maintain full data structure but optimize it
            const qrData = {
                p: paymentId,       // Peer ID
                t: paymentData.total, // Total amount
                i: paymentData.items.map(item => ({
                    n: item.name,  // Shortened property names
                    q: item.quantity,
                    p: item.price
                }))
            };

            try {
                // Double compression strategy
                const jsonStr = JSON.stringify(qrData);
                const compressed = LZString.compressToBase64(jsonStr);
                
                // Split data into chunks if needed
                const maxChunkSize = 1500;
                const chunks = [];
                
                for(let i = 0; i < compressed.length; i += maxChunkSize) {
                    chunks.push(compressed.slice(i, i + maxChunkSize));
                }

                // Calculate QR size based on viewport
                const qrSize = Math.min(300, Math.min(window.innerWidth, window.innerHeight) * 0.7);
                
                // Only show first chunk if within limit
                if(chunks.length === 1) {
                    new QRCode(qrContainer, {
                        text: compressed,
                        width: qrSize,
                        height: qrSize,
                        colorDark: "#2c3e50",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                } else {
                    // Implement multi-QR system or error
                    qrContainer.innerHTML = '<p>Zu viele Artikel für QR-Code</p>';
                    console.error('QR data too large:', compressed.length);
                }
                
            } catch(e) {
                console.error('QR Generation Error:', e);
                qrContainer.innerHTML = '<p>QR-Code generation fehlgeschlagen</p>';
            }
        }

        function generateReceipt(status) {
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            const paymentDate = new Date().toLocaleDateString('de-DE');
            const paymentTime = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            let yPos = 20;
            
            // Color scheme matching the Gittertier Pro design
            const primaryColor = [17, 17, 17];        // #111111 - Primary text
            const accentColor = [37, 99, 235];        // #2563eb - Accent blue
            const successColor = [22, 163, 74];       // #16a34a - Success green
            const dangerColor = [220, 38, 38];        // #dc2626 - Error red
            const lightGray = [243, 244, 246];        // #f3f4f6 - Light background
            const borderColor = [229, 231, 235];      // #e5e7eb - Border color
            
            // Set font - using helvetica as it's available in PDF
            doc.setFont("helvetica");
            
            // Header with logo and receipt info
            doc.setFillColor(...lightGray);
            doc.roundedRect(20, yPos, pageWidth - 40, 50, 3, 3, 'F');
            
            // App name
            doc.setFontSize(20);
            doc.setTextColor(...accentColor);
            doc.setFont(undefined, 'bold');
            doc.text("Gittertier Pro", 30, yPos + 15);
            
            // Receipt info
            doc.setFontSize(10);
            doc.setTextColor(...primaryColor);
            doc.setFont(undefined, 'normal');
            doc.text(`Belegnummer: ${paymentId}`, pageWidth - 30, yPos + 10, null, 'right');
            doc.text(`Datum: ${paymentDate}`, pageWidth - 30, yPos + 20, null, 'right');
            doc.text(`Uhrzeit: ${paymentTime}`, pageWidth - 30, yPos + 30, null, 'right');
            
            yPos += 60;
            
            // Receipt title
            doc.setFontSize(16);
            doc.setTextColor(...primaryColor);
            doc.setFont(undefined, 'bold');
            doc.text("KASSENBON", pageWidth/2, yPos, null, 'center');
            
            yPos += 15;
            
            // Items header
            doc.setFillColor(...lightGray);
            doc.rect(30, yPos, pageWidth - 60, 10, 'F');
            doc.setDrawColor(...borderColor);
            doc.rect(30, yPos, pageWidth - 60, 10, 'S');
            
            doc.setFontSize(10);
            doc.setTextColor(...primaryColor);
            doc.setFont(undefined, 'bold');
            doc.text("Artikel", 35, yPos + 7);
            doc.text("Menge", 120, yPos + 7);
            doc.text("Einzelpreis", 150, yPos + 7);
            doc.text("Gesamt", pageWidth - 35, yPos + 7, null, 'right');
            
            yPos += 15;
            
            // Items list
            doc.setFontSize(10);
            doc.setTextColor(...primaryColor);
            doc.setFont(undefined, 'normal');
            
            paymentData.items.forEach((item, index) => {
                if (yPos > pageHeight - 60) {
                    doc.addPage();
                    yPos = 20;
                    
                    // Add header to new page
                    doc.setFontSize(10);
                    doc.setTextColor(...primaryColor);
                    doc.text("Fortsetzung Kassenbon", 30, 15);
                }
                
                // Item name (with word wrapping)
                const itemName = item.name;
                const splitName = doc.splitTextToSize(itemName, 70);
                doc.text(splitName, 35, yPos + 4);
                
                // Item details
                doc.text(`${item.quantity}x`, 120, yPos + 4);
                doc.text(`€ ${item.price.toFixed(2)}`, 150, yPos + 4);
                doc.text(`€ ${(item.quantity * item.price).toFixed(2)}`, pageWidth - 35, yPos + 4, null, 'right');
                
                // Calculate height needed for this item
                const lineHeight = 5;
                const itemHeight = Math.max(lineHeight, splitName.length * lineHeight);
                
                // Draw border around item
                doc.setDrawColor(...borderColor);
                doc.line(30, yPos - 2, pageWidth - 30, yPos - 2);
                
                yPos += itemHeight;
            });
            
            // Total section
            yPos += 10;
            doc.setDrawColor(...borderColor);
            doc.line(30, yPos, pageWidth - 30, yPos);
            
            yPos += 10;
            doc.setFontSize(12);
            doc.setTextColor(...primaryColor);
            doc.setFont(undefined, 'bold');
            doc.text("Zwischensumme:", pageWidth - 100, yPos);
            doc.text(`€ ${paymentData.total.toFixed(2)}`, pageWidth - 35, yPos, null, 'right');
            
            yPos += 8;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(...primaryColor);
            doc.text("Enthaltene MwSt. 19%:", pageWidth - 100, yPos);
            const tax = paymentData.total * 0.19;
            doc.text(`€ ${tax.toFixed(2)}`, pageWidth - 35, yPos, null, 'right');
            
            yPos += 15;
            doc.setDrawColor(...accentColor);
            doc.setLineWidth(0.5);
            doc.line(pageWidth - 130, yPos, pageWidth - 30, yPos);
            
            yPos += 10;
            doc.setFontSize(14);
            doc.setTextColor(...primaryColor);
            doc.setFont(undefined, 'bold');
            doc.text("GESAMTSUMME:", pageWidth - 100, yPos);
            doc.text(`€ ${paymentData.total.toFixed(2)}`, pageWidth - 35, yPos, null, 'right');
            
            // Payment status
            yPos += 25;
            const statusColor = status === 'Bestätigt' ? successColor : dangerColor;
            doc.setFillColor(...statusColor);
            doc.roundedRect(30, yPos, pageWidth - 60, 15, 2, 2, 'F');
            
            doc.setFontSize(12);
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.text(`ZAHLUNG ${status.toUpperCase()}`, pageWidth/2, yPos + 10, null, 'center');
            
            // Footer
            yPos += 30;
            doc.setFontSize(8);
            doc.setTextColor(...primaryColor);
            doc.setFont(undefined, 'normal');
            doc.text("Vielen Dank für Ihren Einkauf bei Gittertier Pro!", pageWidth/2, yPos, null, 'center');
            
            yPos += 5;
            doc.text("Dieser Beleg dient als ordnungsgemäße Kaufquittung.", pageWidth/2, yPos, null, 'center');
            
            yPos += 5;
            doc.text("Bei Fragen zu Ihrem Einkauf wenden Sie sich bitte an unseren Support.", pageWidth/2, yPos, null, 'center');
            
            yPos += 10;
            doc.setDrawColor(...borderColor);
            doc.line(30, yPos, pageWidth - 30, yPos);
            
            yPos += 8;
            doc.text(`Belegnummer: ${paymentId} | ${paymentDate} ${paymentTime}`, pageWidth/2, yPos, null, 'center');
            
            // Save the PDF
            doc.save(`gittertier_beleg_${paymentId}.pdf`);
        }
        
        // Initialize payment when page loads
        window.addEventListener('DOMContentLoaded', initPayment);
    </script>
</body>
</html>