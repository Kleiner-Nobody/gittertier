<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bezahlung - Gittertier Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    /* ==================== CSS VARIABLES ==================== */
    :root {
        /* Colors */
        --color-bg: #ffffff;
        --color-bg-secondary: #f8fafc;
        --color-bg-tertiary: #f1f5f9;
        --color-text: #111111;
        --color-text-muted: #6b7280;
        --color-text-light: #9ca3af;
        --color-border: #e5e7eb;
        --color-border-light: #f3f4f6;
        --color-accent: #2563eb;
        --color-accent-hover: #1d4ed8;
        --color-accent-light: #dbeafe;
        --color-success: #16a34a;
        --color-success-light: #dcfce7;
        --color-error: #dc2626;
        --color-error-light: #fef2f2;
        --color-warning: #d97706;
        --color-warning-light: #fef3c7;
        --color-overlay: rgba(0, 0, 0, 0.5);
        --color-overlay-light: rgba(0, 0, 0, 0.1);
        --color-tutorial: #FF9900;
        --color-tutorial-light: #FFF3CD;
        --color-surface: #ffffff;
        --color-surface-elevated: #ffffff;
        
        /* Gradients */
        --gradient-primary: linear-gradient(135deg, var(--color-accent) 0%, #3b82f6 100%);
        --gradient-success: linear-gradient(135deg, var(--color-success) 0%, #22c55e 100%);
        --gradient-surface: linear-gradient(135deg, var(--color-bg) 0%, var(--color-bg-secondary) 100%);
        
        /* Shadows */
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.07), 0 1px 2px rgba(0, 0, 0, 0.04);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        --shadow-focus: 0 0 0 3px rgba(37, 99, 235, 0.15);
        
        /* Border Radius */
        --radius-sm: 6px;
        --radius: 12px;
        --radius-md: 16px;
        --radius-lg: 20px;
        --radius-xl: 24px;
        --radius-full: 9999px;
        
        /* Spacing */
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;
        --spacing-xxl: 48px;
        --spacing-xxxl: 64px;
        
        /* Transitions */
        --transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
        --transition-slow: all 0.3s cubic-bezier(0.2, 0, 0, 1);
        --transition-bounce: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        
        /* Typography */
        --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, "Helvetica Neue", Arial, sans-serif;
        --text-xs: 0.75rem;
        --text-sm: 0.875rem;
        --text-base: 1rem;
        --text-lg: 1.125rem;
        --text-xl: 1.25rem;
        --text-2xl: 1.5rem;
        --text-3xl: 1.875rem;
        --text-4xl: 2.25rem;
        
        /* Layout */
        --header-height: 70px;
        --bottom-nav-height: 70px;
        --sidebar-width: 280px;
        --sidebar-width-collapsed: 80px;
        --max-content-width: 1200px;
        --card-padding: var(--spacing-lg);
        
        /* New Customer-specific variables */
        --color-premium: #c5a47e;
        --color-premium-dark: #8b6b4c;
        --color-premium-light: #f4eee6;
        --color-loyalty-primary: #7e22ce;
        --color-loyalty-secondary: #a855f7;
        --color-loyalty-light: #f3e8ff;
        --color-fresh: #22c55e;
        --color-fresh-light: #dcfce7;
        --color-frozen: #3b82f6;
        --color-frozen-light: #dbeafe;
        --color-household: #f97316;
        --color-household-light: #ffedd5;
    }

    /* ==================== DARK MODE ==================== */
    @media (prefers-color-scheme: dark) {
        :root {
            --color-bg: #0f172a;
            --color-bg-secondary: #1e293b;
            --color-bg-tertiary: #334155;
            --color-text: #f1f5f9;
            --color-text-muted: #94a3b8;
            --color-text-light: #64748b;
            --color-border: #334155;
            --color-border-light: #475569;
            --color-accent: #3b82f6;
            --color-accent-hover: #60a5fa;
            --color-accent-light: #1e3a8a;
            --color-success: #22c55e;
            --color-success-light: #14532d;
            --color-error: #ef4444;
            --color-error-light: #7f1d1d;
            --color-warning: #f59e0b;
            --color-warning-light: #78350f;
            --color-overlay: rgba(0, 0, 0, 0.7);
            --color-overlay-light: rgba(0, 0, 0, 0.3);
            --color-surface: #1e293b;
            --color-surface-elevated: #334155;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.2);
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.3), 0 1px 2px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }
    }

    /* ==================== BASE STYLES ==================== */
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    html {
        scroll-behavior: smooth;
    }

    body {
        font-family: var(--font-family);
        background-color: var(--color-bg);
        color: var(--color-text);
        line-height: 1.5;
        min-height: 100vh;
        overflow-x: hidden;
        position: relative;
    }

    /* ==================== LAYOUT ==================== */
    .app-container {
        display: flex;
        min-height: 100vh;
        position: relative;
    }

    /* Sidebar for Desktop */
    .sidebar {
        width: var(--sidebar-width);
        background: var(--color-surface);
        border-right: 1px solid var(--color-border);
        display: flex;
        flex-direction: column;
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        z-index: 100;
        transition: var(--transition-slow);
        overflow-y: auto;
        box-shadow: var(--shadow-md);
    }

    .sidebar.collapsed {
        width: var(--sidebar-width-collapsed);
    }

    .sidebar-header {
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--color-border);
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        height: var(--header-height);
        flex-shrink: 0;
    }

    .sidebar-logo {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        font-weight: 700;
        font-size: var(--text-lg);
        color: var(--color-text);
        white-space: nowrap;
        overflow: hidden;
    }

    .sidebar.collapsed .sidebar-logo span {
        display: none;
    }

    .sidebar-toggle {
        background: none;
        border: none;
        color: var(--color-text-muted);
        cursor: pointer;
        margin-left: auto;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: var(--radius);
        transition: var(--transition);
    }

    .sidebar-toggle:hover {
        background-color: var(--color-bg-secondary);
        color: var(--color-text);
    }

    .sidebar-nav {
        flex: 1;
        padding: var(--spacing-lg) 0;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
    }

    .nav-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-md) var(--spacing-lg);
        color: var(--color-text-muted);
        text-decoration: none;
        transition: var(--transition);
        border-radius: 0;
        margin: 0 var(--spacing-md);
        white-space: nowrap;
        overflow: hidden;
    }

    .sidebar.collapsed .nav-item {
        justify-content: center;
        padding: var(--spacing-md);
        border-radius: var(--radius);
    }

    .sidebar.collapsed .nav-item span {
        display: none;
    }

    .nav-item:hover {
        background-color: var(--color-bg-secondary);
        color: var(--color-text);
    }

    .nav-item.active {
        background-color: var(--color-accent-light);
        color: var(--color-accent);
        font-weight: 500;
    }

    .nav-item i {
        font-size: var(--text-lg);
        width: 24px;
        text-align: center;
    }

    .nav-badge {
        background-color: var(--color-accent);
        color: white;
        border-radius: var(--radius-full);
        padding: 2px 6px;
        font-size: var(--text-xs);
        margin-left: auto;
    }

    .sidebar.collapsed .nav-badge {
        position: absolute;
        top: 6px;
        right: 6px;
        margin-left: 0;
    }

    .sidebar-footer {
        padding: var(--spacing-lg);
        border-top: 1px solid var(--color-border);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
        flex-shrink: 0;
    }

    .user-profile {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        padding: var(--spacing-sm);
        border-radius: var(--radius);
        transition: var(--transition);
        cursor: pointer;
    }

    .user-profile:hover {
        background-color: var(--color-bg-secondary);
    }

    .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: var(--radius-full);
        background: var(--gradient-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        flex-shrink: 0;
    }

    .user-info {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
    }

    .user-name {
        font-weight: 500;
        font-size: var(--text-sm);
        margin-bottom: 2px;
    }

    .user-role {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
    }

    .sidebar.collapsed .user-info {
        display: none;
    }

    /* Main Content Area */
    .main-content {
        flex: 1;
        margin-left: var(--sidebar-width);
        transition: var(--transition-slow);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .sidebar.collapsed + .main-content {
        margin-left: var(--sidebar-width-collapsed);
    }

    .content-header {
        height: var(--header-height);
        background: var(--color-surface);
        border-bottom: 1px solid var(--color-border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 var(--spacing-lg);
        position: sticky;
        top: 0;
        z-index: 90;
        box-shadow: var(--shadow-sm);
    }

    .page-title {
        font-size: var(--text-xl);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }

    .page-title i {
        color: var(--color-accent);
    }

    .header-actions {
        display: flex;
        gap: var(--spacing-sm);
    }

    .header-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: var(--radius);
        background: none;
        border: none;
        color: var(--color-text-muted);
        cursor: pointer;
        transition: var(--transition);
        position: relative;
    }

    .header-btn:hover {
        background-color: var(--color-bg-secondary);
        color: var(--color-text);
    }

    .header-btn.active {
        color: var(--color-accent);
        background-color: var(--color-accent-light);
    }

    .header-badge {
        position: absolute;
        top: 6px;
        right: 6px;
        width: 8px;
        height: 8px;
        border-radius: var(--radius-full);
        background-color: var(--color-error);
    }

    .content-area {
        flex: 1;
        padding: var(--spacing-lg);
        max-width: var(--max-content-width);
        width: 100%;
        margin: 0 auto;
    }

    /* Bottom Navigation for Mobile */
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: var(--bottom-nav-height);
        background: var(--color-surface);
        border-top: 1px solid var(--color-border);
        display: none;
        justify-content: space-around;
        align-items: center;
        z-index: 100;
        box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
        padding: 0 var(--spacing-md);
    }

    .nav-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: none;
        border: none;
        padding: var(--spacing-sm);
        color: var(--color-text-muted);
        cursor: pointer;
        transition: var(--transition);
        flex: 1;
        height: 100%;
        border-radius: var(--radius);
        position: relative;
    }

    .nav-btn:hover {
        color: var(--color-accent);
    }

    .nav-btn.active {
        color: var(--color-accent);
    }

    .nav-btn i {
        font-size: var(--text-lg);
        margin-bottom: 4px;
    }

    .nav-btn span {
        font-size: var(--text-xs);
        font-weight: 500;
    }

    .nav-badge {
        position: absolute;
        top: 8px;
        right: 50%;
        transform: translateX(50%);
        width: 6px;
        height: 6px;
        border-radius: var(--radius-full);
        background-color: var(--color-error);
    }

    .floating-pay-btn {
        position: fixed;
        bottom: calc(var(--bottom-nav-height) + var(--spacing-lg));
        right: var(--spacing-lg);
        background: var(--gradient-primary);
        color: white;
        border: none;
        border-radius: var(--radius-full);
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow-lg);
        cursor: pointer;
        z-index: 95;
        transition: var(--transition-bounce);
    }

    .floating-pay-btn:hover {
        transform: translateY(-5px) scale(1.05);
        box-shadow: var(--shadow-xl);
    }

    .floating-pay-btn i {
        font-size: var(--text-xl);
    }

    /* ==================== CUSTOMER PAGE SPECIFIC STYLES ==================== */
    
    /* Payment Card */
    .payment-card {
        background: var(--color-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border);
        overflow: hidden;
        box-shadow: var(--shadow-md);
        margin-bottom: var(--spacing-xl);
        padding: var(--spacing-xl);
        text-align: center;
        position: relative;
        overflow: hidden;
        animation: fadeIn 0.4s ease-out;
    }

    .payment-header {
        margin-bottom: var(--spacing-xl);
    }

    .payment-title {
        font-size: var(--text-2xl);
        font-weight: 700;
        margin-bottom: var(--spacing-sm);
        color: var(--color-text);
    }

    .payment-subtitle {
        color: var(--color-text-muted);
        font-size: var(--text-base);
    }

    .amount {
        font-size: var(--text-3xl);
        font-weight: 700;
        margin: var(--spacing-lg) 0;
        color: var(--color-text);
    }

    /* Items List */
    .items-list {
        margin: var(--spacing-lg) 0;
        text-align: left;
    }

    .item-box {
        background: var(--color-bg-secondary);
        border-radius: var(--radius);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-sm);
        border: 1px solid var(--color-border);
    }

    .item-box h3 {
        font-size: var(--text-base);
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
    }

    .item-box p {
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        margin-bottom: var(--spacing-xs);
    }

    /* QR Code */
    #qrcode {
        margin: var(--spacing-xl) auto;
        padding: var(--spacing-md);
        background: var(--color-bg-secondary);
        border-radius: var(--radius);
        display: inline-block;
        border: 1px solid var(--color-border);
        box-shadow: var(--shadow);
        max-width: 100%;
        overflow: hidden;
    }

    #qrcode canvas, 
    #qrcode img {
        max-width: 100%;
        height: auto !important;
        display: block;
        margin: 0 auto;
    }

    /* Countdown */
    .countdown-container {
        margin: var(--spacing-lg) 0;
        font-size: var(--text-base);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        color: var(--color-text);
    }

    .countdown-value {
        font-weight: 700;
        font-size: var(--text-lg);
        background: var(--color-bg-tertiary);
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--radius-sm);
    }

    /* Status */
    .status {
        padding: var(--spacing-md);
        border-radius: var(--radius);
        margin: var(--spacing-lg) 0;
        font-size: var(--text-base);
        font-weight: 600;
        transition: all 0.3s ease;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        box-shadow: var(--shadow);
    }

    .status.pending {
        background: var(--color-warning-light);
        color: var(--color-warning);
        border: 1px solid var(--color-warning);
    }

    .status.confirmed {
        background: var(--color-success-light);
        color: var(--color-success);
        border: 1px solid var(--color-success);
    }

    .status.declined {
        background: var(--color-error-light);
        color: var(--color-error);
        border: 1px solid var(--color-error);
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: var(--spacing-md);
        margin-top: var(--spacing-xl);
        flex-wrap: wrap;
    }

    .action-btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-md);
        border: 1px solid var(--color-border);
        border-radius: var(--radius);
        background-color: var(--color-surface);
        color: var(--color-text);
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        min-width: 140px;
    }

    .action-btn:hover {
        background-color: var(--color-bg-secondary);
        border-color: var(--color-accent);
    }

    .action-btn:focus {
        outline: none;
        box-shadow: var(--shadow-focus);
    }

    .action-btn i {
        font-size: var(--text-lg);
    }

    .cancel-btn {
        color: var(--color-error);
        border-color: rgba(220, 38, 38, 0.2);
    }

    .cancel-btn:hover {
        background-color: rgba(220, 38, 38, 0.05);
        border-color: var(--color-error);
    }

    .confirm-btn {
        color: var(--color-success);
        border-color: rgba(22, 163, 74, 0.2);
    }

    .confirm-btn:hover {
        background-color: rgba(22, 163, 74, 0.05);
        border-color: var(--color-success);
    }

    /* ==================== MODALS ==================== */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--color-overlay);
        z-index: 1000;
        display: none;
        animation: fadeIn 0.3s ease;
        backdrop-filter: blur(5px);
    }

    .modal-overlay.active {
        display: block;
    }

    .modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: var(--color-surface);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-xl);
        z-index: 1001;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        display: none;
        animation: scaleIn 0.3s ease;
    }

    .modal.active {
        display: block;
    }

    .modal-header {
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--color-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: var(--color-bg-secondary);
    }

    .modal-header h2 {
        font-size: var(--text-xl);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .modal-close {
        background: none;
        border: none;
        font-size: var(--text-xl);
        cursor: pointer;
        color: var(--color-text-muted);
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: var(--transition);
    }

    .modal-close:hover {
        background-color: var(--color-bg-secondary);
    }

    .modal-content {
        padding: var(--spacing-lg);
    }

    .modal-input-group {
        margin-bottom: var(--spacing-md);
    }

    .modal-label {
        display: block;
        margin-bottom: var(--spacing-xs);
        font-weight: 500;
        color: var(--color-text);
    }

    .modal-input {
        width: 100%;
        padding: var(--spacing-md);
        border: 1px solid var(--color-border);
        border-radius: var(--radius);
        font-size: var(--text-base);
        transition: var(--transition);
        background: var(--color-bg);
        color: var(--color-text);
    }

    .modal-input:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: var(--shadow-focus);
    }

    .modal-textarea {
        min-height: 100px;
        resize: vertical;
    }

    .modal-buttons {
        display: flex;
        gap: var(--spacing-md);
        margin-top: var(--spacing-lg);
    }

    .modal-btn {
        flex: 1;
        padding: var(--spacing-md);
        border: none;
        border-radius: var(--radius);
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        transition: var(--transition);
    }

    .btn-save {
        background: var(--color-success);
        color: white;
    }

    .btn-save:hover {
        background: #0f9c5a;
        transform: translateY(-2px);
    }

    .btn-cancel {
        background: var(--color-bg);
        border: 1px solid var(--color-border);
        color: var(--color-text);
    }

    .btn-cancel:hover {
        background: var(--color-bg-secondary);
        transform: translateY(-2px);
    }

    /* Customer Data Setup Modal - Redesigned */
    .customer-setup-modal {
        max-width: 600px;
    }

    .step-indicators {
        display: flex;
        justify-content: center;
        margin-bottom: var(--spacing-lg);
        gap: var(--spacing-xs);
    }
    
    .step-indicator {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: var(--color-border);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        position: relative;
        transition: var(--transition);
    }
    
    .step-indicator.active {
        background-color: var(--color-accent);
        color: white;
        transform: scale(1.1);
    }
    
    .step-indicator::before {
        content: attr(data-step);
    }
    
    .step {
        display: none;
    }
    
    .step.active {
        display: block;
        animation: fadeIn 0.3s ease-out;
    }

    .step-navigation {
        display: flex;
        justify-content: space-between;
        margin-top: var(--spacing-xl);
    }

    /* Radio Group Styles */
    .radio-group {
        display: flex;
        gap: var(--spacing-md);
        margin-top: var(--spacing-sm);
    }

    .radio-option {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-md);
        border: 2px solid var(--color-border);
        border-radius: var(--radius);
        cursor: pointer;
        transition: var(--transition);
        min-height: 80px;
    }

    .radio-option.selected {
        border-color: var(--color-accent);
        background-color: rgba(37, 99, 235, 0.05);
    }

    .radio-option i {
        font-size: var(--text-xl);
        margin-bottom: var(--spacing-xs);
    }

    /* Coupon Section */
    .coupon-section {
        background-color: var(--color-bg-secondary);
        border-radius: var(--radius);
        padding: var(--spacing-md);
        margin-top: var(--spacing-lg);
    }

    .coupon-header {
        display: flex;
        align-items: center;
        margin-bottom: var(--spacing-sm);
    }

    .coupon-title {
        font-weight: 500;
        color: var(--color-text);
    }

    .coupon-input-group {
        display: flex;
        gap: var(--spacing-sm);
    }

    .coupon-input {
        flex: 1;
    }

    .apply-coupon-btn {
        white-space: nowrap;
    }

    .coupon-result {
        margin-top: var(--spacing-sm);
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        font-size: var(--text-sm);
    }

    .coupon-success {
        background-color: rgba(22, 163, 74, 0.1);
        color: var(--color-success);
    }

    .coupon-error {
        background-color: rgba(220, 38, 38, 0.1);
        color: var(--color-error);
    }

    /* Loyalty Program Styles */
    .loyalty-section {
        background-color: var(--color-loyalty-light);
        border-radius: var(--radius);
        padding: var(--spacing-md);
        margin-top: var(--spacing-lg);
        border: 1px solid var(--color-loyalty-secondary);
    }

    .loyalty-header {
        display: flex;
        align-items: center;
        margin-bottom: var(--spacing-sm);
    }

    .loyalty-title {
        font-weight: 600;
        color: var(--color-loyalty-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .loyalty-status {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--spacing-md);
        padding: var(--spacing-sm);
        background: var(--color-surface);
        border-radius: var(--radius-sm);
        box-shadow: var(--shadow);
    }

    .loyalty-points {
        font-weight: 700;
        font-size: var(--text-lg);
        color: var(--color-loyalty-primary);
    }

    .loyalty-tier {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-weight: 600;
    }

    .tier-badge {
        padding: 4px 8px;
        border-radius: 20px;
        font-size: var(--text-xs);
        font-weight: 700;
    }

    .tier-bronze {
        background-color: #cd7f32;
        color: white;
    }

    .tier-silver {
        background-color: #c0c0c0;
        color: #333;
    }

    .tier-gold {
        background-color: #ffd700;
        color: #333;
    }

    .tier-platinum {
        background-color: #e5e4e2;
        color: #333;
    }

    .progress-container {
        margin: var(--spacing-md) 0;
    }

    .progress-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--spacing-xs);
        font-size: var(--text-sm);
    }

    .progress-bar {
        height: 8px;
        background-color: var(--color-border);
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--color-loyalty-primary), var(--color-loyalty-secondary));
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .loyalty-options {
        margin-top: var(--spacing-md);
    }

    .loyalty-option {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--spacing-md);
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-sm);
        margin-bottom: var(--spacing-sm);
        cursor: pointer;
        transition: var(--transition);
    }

    .loyalty-option:hover {
        border-color: var(--color-loyalty-primary);
        background-color: #faf5ff;
    }

    .loyalty-option.selected {
        border-color: var(--color-loyalty-primary);
        background-color: var(--color-loyalty-light);
    }

    .loyalty-option-details {
        display: flex;
        flex-direction: column;
        flex: 1;
    }

    .loyalty-option-title {
        font-weight: 600;
        color: var(--color-loyalty-primary);
    }

    .loyalty-option-desc {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        margin-top: var(--spacing-xs);
    }

    .loyalty-option-cost {
        font-weight: 700;
        color: var(--color-loyalty-primary);
        white-space: nowrap;
        margin-left: var(--spacing-sm);
    }

    .loyalty-result {
        margin-top: var(--spacing-sm);
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        font-size: var(--text-sm);
    }

    .loyalty-success {
        background-color: rgba(22, 163, 74, 0.1);
        color: var(--color-success);
    }

    .loyalty-error {
        background-color: rgba(220, 38, 38, 0.1);
        color: var(--color-error);
    }

    /* Receipt Design Options */
    .receipt-design-options {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-md);
        margin-top: var(--spacing-md);
    }

    .design-option {
        border: 2px solid var(--color-border);
        border-radius: var(--radius);
        padding: var(--spacing-md);
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100px;
    }

    .design-option:hover {
        border-color: var(--color-accent);
    }

    .design-option.selected {
        border-color: var(--color-accent);
        background-color: rgba(37, 99, 235, 0.05);
    }

    .design-option i {
        font-size: var(--text-xl);
        margin-bottom: var(--spacing-xs);
    }

    /* Delivery Options */
    .delivery-section {
        background-color: var(--color-fresh-light);
        border-radius: var(--radius);
        padding: var(--spacing-md);
        margin-top: var(--spacing-lg);
        border: 1px solid var(--color-fresh);
    }

    .delivery-options {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-md);
        margin-top: var(--spacing-md);
    }

    .delivery-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-md);
        border: 2px solid var(--color-border);
        border-radius: var(--radius);
        cursor: pointer;
        transition: var(--transition);
        text-align: center;
        min-height: 100px;
    }

    .delivery-option:hover {
        border-color: var(--color-fresh);
    }

    .delivery-option.selected {
        border-color: var(--color-fresh);
        background-color: rgba(34, 197, 94, 0.1);
    }

    .delivery-option i {
        font-size: var(--text-xl);
        margin-bottom: var(--spacing-xs);
        color: var(--color-fresh);
    }

    /* Bagging Options */
    .bagging-section {
        background-color: var(--color-household-light);
        border-radius: var(--radius);
        padding: var(--spacing-md);
        margin-top: var(--spacing-lg);
        border: 1px solid var(--color-household);
    }

    .bagging-options {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--spacing-md);
        margin-top: var(--spacing-md);
    }

    .bagging-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-md);
        border: 2px solid var(--color-border);
        border-radius: var(--radius);
        cursor: pointer;
        transition: var(--transition);
        text-align: center;
        min-height: 80px;
    }

    .bagging-option:hover {
        border-color: var(--color-household);
    }

    .bagging-option.selected {
        border-color: var(--color-household);
        background-color: rgba(249, 115, 22, 0.1);
    }

    .bagging-option i {
        font-size: var(--text-lg);
        margin-bottom: var(--spacing-xs);
        color: var(--color-household);
    }

    /* Donation Options */
    .donation-section {
        background-color: var(--color-frozen-light);
        border-radius: var(--radius);
        padding: var(--spacing-md);
        margin-top: var(--spacing-lg);
        border: 1px solid var(--color-frozen);
    }

    .donation-options {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--spacing-md);
        margin-top: var(--spacing-md);
    }

    .donation-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-md);
        border: 2px solid var(--color-border);
        border-radius: var(--radius);
        cursor: pointer;
        transition: var(--transition);
        text-align: center;
        min-height: 80px;
    }

    .donation-option:hover {
        border-color: var(--color-frozen);
    }

    .donation-option.selected {
        border-color: var(--color-frozen);
        background-color: rgba(59, 130, 246, 0.1);
    }

    .donation-option i {
        font-size: var(--text-lg);
        margin-bottom: var(--spacing-xs);
        color: var(--color-frozen);
    }

    /* Summary Styles */
    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--spacing-xs);
        padding: var(--spacing-xs) 0;
    }

    .summary-total {
        border-top: 1px solid var(--color-border);
        margin-top: var(--spacing-xs);
        padding-top: var(--spacing-sm);
        font-weight: 700;
        font-size: var(--text-lg);
    }

    .discount {
        color: var(--color-success);
    }

    .remember-choice {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-lg);
        font-size: var(--text-sm);
    }

    /* Payment Details Summary */
    .payment-details-summary {
        background-color: var(--color-bg-secondary);
        border-radius: var(--radius);
        padding: var(--spacing-md);
        margin: var(--spacing-lg) 0;
        text-align: left;
    }

    .payment-details-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--spacing-xs);
    }

    .payment-details-label {
        font-weight: 500;
        color: var(--color-text-muted);
    }

    .payment-details-value {
        font-weight: 600;
    }

    /* ==================== ANIMATIONS ==================== */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from { transform: translateY(20px) translateX(-50%); opacity: 0; }
        to { transform: translateY(0) translateX(-50%); opacity: 1; }
    }

    @keyframes scaleIn {
        from { transform: translate(-50%, -50%) scale(0.95); opacity: 0; }
        to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    @keyframes slideInLeft {
        from { transform: translateX(-100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    /* ==================== RESPONSIVE DESIGN ==================== */
    @media (max-width: 1024px) {
        .sidebar {
            transform: translateX(-100%);
        }
        
        .sidebar.active {
            transform: translateX(0);
        }
        
        .main-content {
            margin-left: 0;
        }
        
        .bottom-nav {
            display: flex;
        }
        
        .floating-pay-btn {
            bottom: calc(var(--bottom-nav-height) + var(--spacing-lg));
        }
    }

    @media (max-width: 768px) {
        :root {
            --spacing-lg: 16px;
            --spacing-xl: 20px;
            --bottom-nav-height: 70px;
        }
        
        .content-area {
            padding: var(--spacing-md);
        }
        
        .payment-card {
            padding: var(--spacing-lg);
        }
        
        .payment-title {
            font-size: var(--text-xl);
        }
        
        .amount {
            font-size: var(--text-2xl);
        }
        
        #qrcode {
            padding: var(--spacing-sm);
            margin: var(--spacing-lg) auto;
        }
        
        .status {
            padding: var(--spacing-sm);
            font-size: var(--text-sm);
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .action-btn {
            width: 100%;
        }
        
        .radio-group {
            flex-direction: column;
        }
        
        .receipt-design-options {
            grid-template-columns: 1fr;
        }

        .delivery-options {
            grid-template-columns: 1fr;
        }

        .bagging-options {
            grid-template-columns: repeat(2, 1fr);
        }

        .donation-options {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .step-indicators {
            flex-wrap: wrap;
            gap: var(--spacing-xs);
        }
        
        .step-indicator {
            width: 25px;
            height: 25px;
            font-size: var(--text-xs);
        }
    }

    @media (max-width: 480px) {
        .content-header {
            padding: 0 var(--spacing-md);
        }
        
        .sidebar-header {
            padding: var(--spacing-md);
        }
        
        .modal-content {
            padding: var(--spacing-md);
        }
        
        .modal-header h2 {
            font-size: var(--text-base);
        }
        
        .payment-card {
            padding: var(--spacing-md);
        }
        
        .payment-title {
            font-size: var(--text-lg);
        }
        
        .payment-subtitle {
            font-size: var(--text-sm);
        }
        
        .amount {
            font-size: var(--text-xl);
            margin: var(--spacing-md) 0;
        }
        
        .countdown-container {
            font-size: var(--text-sm);
        }
        
        .countdown-value {
            font-size: var(--text-base);
        }
        
        .step-navigation {
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        
        .step-navigation .modal-btn {
            width: 100%;
        }

        .bagging-options {
            grid-template-columns: 1fr;
        }

        .donation-options {
            grid-template-columns: 1fr;
        }
        
        .step-indicators {
            gap: 4px;
        }
        
        .step-indicator {
            width: 22px;
            height: 22px;
            font-size: 10px;
        }
    }

    /* ==================== ACCESSIBILITY ==================== */
    @media (prefers-reduced-motion: reduce) {
        * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
    }

    /* Focus styles for keyboard navigation */
    button:focus-visible, 
    input:focus-visible, 
    a:focus-visible {
        outline: 2px solid var(--color-accent);
        outline-offset: 2px;
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
        :root {
            --color-border: #000000;
            --shadow: 0 0 0 1px #000000;
        }
    }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation for Desktop -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Gittertier Pro</span>
                </div>
                <button class="sidebar-toggle" id="sidebar-toggle">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            
            <nav class="sidebar-nav">
                <a href="index" class="nav-item">
                    <i class="fas fa-camera"></i>
                    <span>Scanner</span>
                </a>
                <a href="index#products-page" class="nav-item">
                    <i class="fas fa-cube"></i>
                    <span>Produkte</span>
                </a>
                <a href="index#cart-page" class="nav-item">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Warenkorb</span>
                </a>
                <a href="#" class="nav-item active">
                    <i class="fas fa-qrcode"></i>
                    <span>Bezahlung</span>
                </a>
                <a href="index#settings-page" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Einstellungen</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <a href="#" class="nav-item" id="help-btn">
                    <i class="fas fa-question-circle"></i>
                    <span>Hilfe</span>
                </a>
                <div class="user-profile">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-info">
                        <div class="user-name">Max Mustermann</div>
                        <div class="user-role">Benutzer</div>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Main Content Area -->
        <main class="main-content">
            <header class="content-header">
                <h1 class="page-title">
                    <i class="fas fa-qrcode"></i>
                    <span id="page-title">Bezahlung</span>
                </h1>
                <div class="header-actions">
                    <button class="header-btn" id="edit-details-btn">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="header-btn" id="menu-btn">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </header>
            
            <div class="content-area">
                <div class="payment-card">
                    <div class="payment-header">
                        <h1 class="payment-title">Bezahlung</h1>
                        <p class="payment-subtitle">Scannen Sie den QR-Code zur Zahlung</p>
                    </div>
                    
                    <div class="amount" id="amount">€0.00</div>
                    
                    <div id="payment-details-summary" class="payment-details-summary" style="display: none;">
                        <div class="payment-details-row">
                            <span class="payment-details-label">Name:</span>
                            <span class="payment-details-value" id="summary-name"></span>
                        </div>
                        <div class="payment-details-row">
                            <span class="payment-details-label">Zahlungsart:</span>
                            <span class="payment-details-value" id="summary-method"></span>
                        </div>
                        <div class="payment-details-row">
                            <span class="payment-details-label">Gutschein:</span>
                            <span class="payment-details-value" id="summary-coupon"></span>
                        </div>
                        <div class="payment-details-row">
                            <span class="payment-details-label">Treuepunkte:</span>
                            <span class="payment-details-value" id="summary-loyalty"></span>
                        </div>
                        <div class="payment-details-row">
                            <span class="payment-details-label">Belegdesign:</span>
                            <span class="payment-details-value" id="summary-receipt"></span>
                        </div>
                        <div class="payment-details-row">
                            <span class="payment-details-label">Lieferoption:</span>
                            <span class="payment-details-value" id="summary-delivery"></span>
                        </div>
                        <div class="payment-details-row">
                            <span class="payment-details-label">Verpackung:</span>
                            <span class="payment-details-value" id="summary-bagging"></span>
                        </div>
                        <div class="payment-details-row">
                            <span class="payment-details-label">Spende:</span>
                            <span class="payment-details-value" id="summary-donation"></span>
                        </div>
                    </div>
                    
                    <div id="items-list" class="items-list"></div>
                    
                    <div id="qrcode"></div>
                    
                    <div class="countdown-container">
                        QR-Code gültig für: 
                        <span id="countdown-value" class="countdown-value">60</span>
                        Sekunden
                    </div>
                    
                    <div id="status" class="status pending">
                        <i class="fas fa-clock"></i>
                        <span>Zahlung ausstehend</span>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Bottom Navigation for Mobile -->
        <nav class="bottom-nav">
            <button class="nav-btn" onclick="window.location.href='index'">
                <i class="fas fa-arrow-left"></i>
                <span>Zurück</span>
            </button>
            <button class="nav-btn" id="mobile-edit-btn">
                <i class="fas fa-edit"></i>
                <span>Bearbeiten</span>
            </button>
            <button class="nav-btn active">
                <i class="fas fa-qrcode"></i>
                <span>Bezahlen</span>
            </button>
        </nav>
    </div>
    
    <!-- Modal Overlay -->
    <div class="modal-overlay" id="modal-overlay"></div>
    
    <!-- Customer Data Setup Modal - Redesigned -->
    <div id="customer-setup-modal" class="modal customer-setup-modal">
        <div class="modal-header">
            <h2><i class="fas fa-user-circle"></i> Kundendaten</h2>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-content">
            <!-- Step indicators -->
            <div class="step-indicators">
                <div class="step-indicator active" data-step="1"></div>
                <div class="step-indicator" data-step="2"></div>
                <div class="step-indicator" data-step="3"></div>
                <div class="step-indicator" data-step="4"></div>
                <div class="step-indicator" data-step="5"></div>
                <div class="step-indicator" data-step="6"></div>
                <div class="step-indicator" data-step="7"></div>
                <div class="step-indicator" data-step="8"></div>
                <div class="step-indicator" data-step="9"></div>
            </div>
            
            <!-- Step 1: Customer Name -->
            <div class="step active" id="step-1">
                <div class="modal-input-group">
                    <label class="modal-label" for="customer-name">Ihr Name</label>
                    <input type="text" id="customer-name" class="modal-input" placeholder="Vor- und Nachname" autocomplete="name">
                </div>
                
                <div class="step-navigation">
                    <button class="modal-btn btn-cancel" onclick="closeModal()">
                        Abbrechen
                    </button>
                    <button class="modal-btn btn-save" onclick="showStep(2)">
                        Weiter
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 2: Payment Method -->
            <div class="step" id="step-2">
                <div class="modal-input-group">
                    <label class="modal-label">Zahlungsmethode</label>
                    <div class="radio-group">
                        <div class="radio-option" data-value="cash" onclick="selectPaymentMethod('cash')">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>Bar</span>
                        </div>
                        <div class="radio-option" data-value="card" onclick="selectPaymentMethod('card')">
                            <i class="fas fa-credit-card"></i>
                            <span>Karte</span>
                        </div>
                    </div>
                </div>
                
                <div class="step-navigation">
                    <button class="modal-btn btn-cancel" onclick="showStep(1)">
                        <i class="fas fa-arrow-left"></i>
                        Zurück
                    </button>
                    <button class="modal-btn btn-save" onclick="showStep(3)">
                        Weiter
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 3: Coupon -->
            <div class="step" id="step-3">
                <div class="coupon-section">
                    <div class="coupon-header">
                        <span class="coupon-title">Gutschein anwenden</span>
                    </div>
                    
                    <div class="coupon-input-group">
                        <input type="text" id="coupon-code" class="modal-input coupon-input" placeholder="Gutscheincode eingeben">
                        <button class="modal-btn apply-coupon-btn" onclick="applyCoupon()">
                            Anwenden
                        </button>
                    </div>
                    <div id="coupon-result" class="coupon-result"></div>
                </div>
                
                <div class="step-navigation">
                    <button class="modal-btn btn-cancel" onclick="showStep(2)">
                        <i class="fas fa-arrow-left"></i>
                        Zurück
                    </button>
                    <button class="modal-btn btn-save" onclick="showStep(4)">
                        Weiter
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 4: Loyalty Program -->
            <div class="step" id="step-4">
                <div class="loyalty-section">
                    <div class="loyalty-header">
                        <span class="loyalty-title">
                            <i class="fas fa-crown"></i>
                            Treueprogramm
                        </span>
                    </div>
                    
                    <div class="loyalty-status">
                        <div class="loyalty-points" id="loyalty-points">0 Punkte</div>
                        <div class="loyalty-tier" id="loyalty-tier">
                            <span class="tier-badge tier-bronze">Bronze</span>
                        </div>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Fortschritt zum nächsten Level</span>
                            <span id="progress-text">0/200</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="loyalty-options" id="loyalty-options">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    
                    <div id="loyalty-result" class="loyalty-result"></div>
                </div>
                
                <div class="step-navigation">
                    <button class="modal-btn btn-cancel" onclick="showStep(3)">
                        <i class="fas fa-arrow-left"></i>
                        Zurück
                    </button>
                    <button class="modal-btn btn-save" onclick="showStep(5)">
                        Weiter
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 5: Receipt Design -->
            <div class="step" id="step-5">
                <div class="modal-input-group">
                    <label class="modal-label">Belegdesign auswählen</label>
                    <div class="receipt-design-options">
                        <div class="design-option" data-design="simple" onclick="selectReceiptDesign('simple')">
                            <i class="fas fa-file-alt"></i>
                            <span>Einfach</span>
                        </div>
                        <div class="design-option" data-design="compact" onclick="selectReceiptDesign('compact')">
                            <i class="fas fa-receipt"></i>
                            <span>Kompakt</span>
                        </div>
                        <div class="design-option" data-design="detailed" onclick="selectReceiptDesign('detailed')">
                            <i class="fas fa-file-invoice"></i>
                            <span>Detailliert</span>
                        </div>
                        <div class="design-option" data-design="premium" onclick="selectReceiptDesign('premium')">
                            <i class="fas fa-crown"></i>
                            <span>Premium</span>
                        </div>
                    </div>
                </div>
                
                <div class="step-navigation">
                    <button class="modal-btn btn-cancel" onclick="showStep(4)">
                        <i class="fas fa-arrow-left"></i>
                        Zurück
                    </button>
                    <button class="modal-btn btn-save" onclick="showStep(6)">
                        Weiter
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 6: Delivery Option -->
            <div class="step" id="step-6">
                <div class="delivery-section">
                    <div class="modal-input-group">
                        <label class="modal-label">Lieferoption auswählen</label>
                        <div class="delivery-options">
                            <div class="delivery-option" data-delivery="store-pickup" onclick="selectDeliveryOption('store-pickup')">
                                <i class="fas fa-store"></i>
                                <span>Abholung im Geschäft</span>
                                <small>Kostenlos</small>
                            </div>
                            <div class="delivery-option" data-delivery="home-delivery" onclick="selectDeliveryOption('home-delivery')">
                                <i class="fas fa-truck"></i>
                                <span>Lieferung nach Hause</span>
                                <small>€ 4,99</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="step-navigation">
                    <button class="modal-btn btn-cancel" onclick="showStep(5)">
                        <i class="fas fa-arrow-left"></i>
                        Zurück
                    </button>
                    <button class="modal-btn btn-save" onclick="showStep(7)">
                        Weiter
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 7: Bagging Option -->
            <div class="step" id="step-7">
                <div class="bagging-section">
                    <div class="modal-input-group">
                        <label class="modal-label">Verpackungsoption auswählen</label>
                        <div class="bagging-options">
                            <div class="bagging-option" data-bagging="standard" onclick="selectBaggingOption('standard')">
                                <i class="fas fa-shopping-bag"></i>
                                <span>Standard Tüten</span>
                                <small>€ 0,20 pro Stück</small>
                            </div>
                            <div class="bagging-option" data-bagging="premium" onclick="selectBaggingOption('premium')">
                                <i class="fas fa-gift"></i>
                                <span>Premium Verpackung</span>
                                <small>€ 1,50</small>
                            </div>
                            <div class="bagging-option" data-bagging="own" onclick="selectBaggingOption('own')">
                                <i class="fas fa-shopping-basket"></i>
                                <span>Eigene Tasche</span>
                                <small>Kostenlos</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="step-navigation">
                    <button class="modal-btn btn-cancel" onclick="showStep(6)">
                        <i class="fas fa-arrow-left"></i>
                        Zurück
                    </button>
                    <button class="modal-btn btn-save" onclick="showStep(8)">
                        Weiter
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 8: Donation Option -->
            <div class="step" id="step-8">
                <div class="donation-section">
                    <div class="modal-input-group">
                        <label class="modal-label">Möchten Sie spenden?</label>
                        <div class="donation-options">
                            <div class="donation-option" data-donation="none" onclick="selectDonationOption('none')">
                                <i class="fas fa-times-circle"></i>
                                <span>Nein, danke</span>
                            </div>
                            <div class="donation-option" data-donation="1" onclick="selectDonationOption('1')">
                                <i class="fas fa-euro-sign"></i>
                                <span>€ 1,00 spenden</span>
                                <small>Lebensmittelbank</small>
                            </div>
                            <div class="donation-option" data-donation="2" onclick="selectDonationOption('2')">
                                <i class="fas fa-euro-sign"></i>
                                <span>€ 2,00 spenden</span>
                                <small>Tafel</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="step-navigation">
                    <button class="modal-btn btn-cancel" onclick="showStep(7)">
                        <i class="fas fa-arrow-left"></i>
                        Zurück
                    </button>
                    <button class="modal-btn btn-save" onclick="showStep(9)">
                        Weiter
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 9: Summary -->
            <div class="step" id="step-9">
                <div class="modal-input-group">
                    <h3>Zusammenfassung</h3>
                    <div id="payment-summary">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="remember-choice">
                    <input type="checkbox" id="remember-choice" checked>
                    <label for="remember-choice">Meine Auswahl merken</label>
                </div>
                
                <div class="step-navigation">
                    <button class="modal-btn btn-cancel" onclick="showStep(8)">
                        <i class="fas fa-arrow-left"></i>
                        Zurück
                    </button>
                    <button class="modal-btn btn-save" onclick="processPayment()">
                        <i class="fas fa-check"></i>
                        Bezahlung bestätigen
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success Modal -->
    <div id="success-modal" class="modal">
        <div class="modal-header">
            <h2><i class="fas fa-check-circle"></i> Bezahlung erfolgreich</h2>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-content">
            <p class="text-muted">Ihre Zahlung wurde erfolgreich verarbeitet.</p>
            <div class="modal-buttons">
                <button class="modal-btn btn-save" onclick="generateReceipt()">
                    <i class="fas fa-receipt"></i>
                    Beleg drucken
                </button>
                <button class="modal-btn btn-cancel" onclick="window.location.href='index'">
                    <i class="fas fa-home"></i>
                    Zur Startseite
                </button>
            </div>
        </div>
    </div>
    
    <!-- Error Modal -->
    <div id="error-modal" class="modal">
        <div class="modal-header">
            <h2><i class="fas fa-exclamation-circle"></i> Fehler</h2>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-content">
            <p class="text-muted" id="error-message">Die Zahlungsinformationen konnten nicht geladen werden.</p>
            <div class="modal-buttons">
                <button class="modal-btn btn-cancel" onclick="closeModal()">Schließen</button>
                <button class="modal-btn btn-save" onclick="window.location.href='index'">Zur Startseite</button>
            </div>
        </div>
    </div>

    <script>
    // ==================== APP STATE AND CONFIGURATION ====================
    const APP_STATE = {
        // Payment
        paymentId: 'PAY-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5),
        paymentData: null,
        countdownInterval: null,
        countdownTime: 60,
        customerPeer: null,
        merchantConnection: null,
        
        // Customer preferences
        selectedPaymentMethod: null,
        appliedCoupon: null,
        selectedReceiptDesign: 'compact',
        selectedDeliveryOption: 'store-pickup',
        selectedBaggingOption: 'standard',
        selectedDonationOption: 'none',
        deliveryAddress: '',
        deliveryTime: '',
        
        // Loyalty Program
        loyaltyPoints: 0,
        loyaltyTier: 'bronze',
        loyaltyDiscount: 0,
        loyaltyPointsToRedeem: 0,
        loyaltyPointsEarned: 0,
        isLoyaltyMember: false,
        
        // UI
        currentStep: 1,
        coupons: [],
        userPreferences: null
    };

    // Loyalty Program Configuration
    const LOYALTY_CONFIG = {
        pointsPerEuro: 1,
        tiers: {
            bronze: { minPoints: 0, discount: 0, benefits: ['Willkommensgeschenk', '5% Rabatt auf ausgewählte Artikel'] },
            silver: { minPoints: 500, discount: 5, benefits: ['5% Rabatt auf alle Einkäufe', 'Exklusive Angebote', 'Premium Belegdesign'] },
            gold: { minPoints: 1500, discount: 10, benefits: ['10% Rabatt auf alle Einkäufe', 'Kostenlose Produktproben', 'Prioritärer Support', 'Gold Belegdesign'] },
            platinum: { minPoints: 3000, discount: 15, benefits: ['15% Rabatt auf alle Einkäufe', 'Früher Zugang zu neuen Produkten', 'Persönlicher Shopping-Assistent', 'Platinum Belegdesign'] }
        },
        redemptionOptions: [
            { points: 100, discount: 3, title: '3€ Rabatt', description: 'Einlösbar ab 100 Punkten', available: true },
            { points: 200, discount: 5, title: '5€ Rabatt', description: 'Einlösbar ab 200 Punkten', available: true },
            { points: 500, discount: 12, title: '12€ Rabatt', description: 'Einlösbar ab 500 Punkten', available: true },
            { points: 1000, discount: 25, title: '25€ Rabatt', description: 'Einlösbar ab 1000 Punkten', available: true }
        ]
    };

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
        // Set up navigation
        setupNavigation();
        
        // Set up customer data setup modal
        document.getElementById('edit-details-btn').addEventListener('click', showCustomerSetupModal);
        document.getElementById('mobile-edit-btn').addEventListener('click', showCustomerSetupModal);
        
        // Set up modal event listeners
        document.getElementById('modal-overlay').addEventListener('click', closeModal);
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
        
        // Initialize payment
        initPayment();
    });

    // ==================== NAVIGATION ====================
    function setupNavigation() {
        // Desktop sidebar navigation
        const navItems = document.querySelectorAll('.sidebar .nav-item');
        navItems.forEach(item => {
            item.addEventListener('click', function(e) {
                if (this.getAttribute('href') === '#') {
                    e.preventDefault();
                }
            });
        });
        
        // Mobile bottom navigation
        const navBtns = document.querySelectorAll('.bottom-nav .nav-btn');
        navBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                navBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });
        
        // Sidebar toggle
        document.getElementById('sidebar-toggle').addEventListener('click', toggleSidebar);
        document.getElementById('menu-btn').addEventListener('click', toggleSidebarMobile);
    }
    
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const toggleIcon = document.getElementById('sidebar-toggle').querySelector('i');
        
        sidebar.classList.toggle('collapsed');
        
        if (sidebar.classList.contains('collapsed')) {
            toggleIcon.classList.remove('fa-chevron-left');
            toggleIcon.classList.add('fa-chevron-right');
        } else {
            toggleIcon.classList.remove('fa-chevron-right');
            toggleIcon.classList.add('fa-chevron-left');
        }
    }
    
    function toggleSidebarMobile() {
        document.getElementById('sidebar').classList.toggle('active');
    }

    // ==================== PAYMENT FUNCTIONS ====================
    function initPayment() {
        try {
            // Check if we have payment data in localStorage first
            const storedPaymentData = getStoredPaymentData();
            
            // Try to get payment data from URL
            const urlParams = new URLSearchParams(window.location.search);
            const compressedData = urlParams.get('id');
            
            if (!compressedData) {
                if (storedPaymentData) {
                    // Check if payment was already processed
                    if (storedPaymentData.status === 'confirmed' || storedPaymentData.status === 'declined') {
                        // Check if it's within the 10-minute window
                        const tenMinutesAgo = Date.now() - (10 * 60 * 1000);
                        if (storedPaymentData.timestamp > tenMinutesAgo) {
                            showAlreadyProcessedModal(storedPaymentData.status);
                            return;
                        } else {
                            // Clear expired payment data
                            clearStoredPaymentData();
                        }
                    } else {
                        // Use stored payment data
                        APP_STATE.paymentData = storedPaymentData.data;
                        processPaymentWithStoredData();
                        return;
                    }
                }
                throw new Error('Keine Zahlungsdaten gefunden');
            }
            
            const jsonString = LZString.decompressFromBase64(compressedData);
            
            if (!jsonString) {
                throw new Error('Daten-Dekompression fehlgeschlagen');
            }
            
            const newPaymentData = JSON.parse(jsonString);
            
            if (!newPaymentData?.items || !newPaymentData?.total) {
                throw new Error('Ungültige Datenstruktur');
            }
            
            // Check if the new payment data is different from stored data
            let isDifferentPayment = true;
            if (storedPaymentData) {
                // Compare the new data with stored data
                const storedData = storedPaymentData.data;
                isDifferentPayment = !arePaymentsEqual(newPaymentData, storedData);
                
                if (!isDifferentPayment) {
                    // Same payment, check status
                    if (storedPaymentData.status === 'confirmed' || storedPaymentData.status === 'declined') {
                        // Check if it's within the 10-minute window
                        const tenMinutesAgo = Date.now() - (10 * 60 * 1000);
                        if (storedPaymentData.timestamp > tenMinutesAgo) {
                            showAlreadyProcessedModal(storedPaymentData.status);
                            return;
                        } else {
                            // Clear expired payment data
                            clearStoredPaymentData();
                        }
                    } else {
                        // Use stored payment data
                        APP_STATE.paymentData = storedPaymentData.data;
                        processPaymentWithStoredData();
                        return;
                    }
                }
            }
            
            // Store new payment data
            APP_STATE.paymentData = newPaymentData;
            storePaymentData(APP_STATE.paymentData, 'pending');
            clearURLParameters();
            
            // Load user preferences
            loadUserPreferences();
            
            // Display payment data immediately
            displayOriginalItems();
            
            // Load coupons
            loadCoupons();
            
            // Initialize PeerJS
            initializePeerJS();
            
            // Check if we have saved preferences
            if (!APP_STATE.userPreferences || !APP_STATE.userPreferences.rememberChoice || !APP_STATE.userPreferences.customerName || !APP_STATE.userPreferences.paymentMethod) {
                // Show modal automatically after a short delay
                setTimeout(() => {
                    showCustomerSetupModal();
                }, 500);
            } else {
                // Use saved preferences
                APP_STATE.selectedReceiptDesign = APP_STATE.userPreferences.receiptDesign || 'compact';
                APP_STATE.selectedDeliveryOption = APP_STATE.userPreferences.deliveryOption || 'store-pickup';
                APP_STATE.selectedBaggingOption = APP_STATE.userPreferences.baggingOption || 'standard';
                APP_STATE.selectedDonationOption = APP_STATE.userPreferences.donationOption || 'none';
                APP_STATE.isLoyaltyMember = APP_STATE.userPreferences.isLoyaltyMember || false;
                processPaymentWithSavedPreferences();
            }
            
        } catch(error) {
            console.error('Payment initialization error:', error);
            document.getElementById('error-message').textContent = error.message;
            showModal('error-modal');
        }
    }
    
    // Helper function to compare two payment objects
    function arePaymentsEqual(payment1, payment2) {
        // Compare total amount
        if (payment1.total !== payment2.total) return false;
        
        // Compare number of items
        if (payment1.items.length !== payment2.items.length) return false;
        
        // Compare each item
        for (let i = 0; i < payment1.items.length; i++) {
            const item1 = payment1.items[i];
            const item2 = payment2.items[i];
            
            if (item1.name !== item2.name || 
                item1.price !== item2.price || 
                item1.quantity !== item2.quantity) {
                return false;
            }
        }
        
        return true;
    }
    
    // Store payment data in localStorage
    function storePaymentData(data, status) {
        const paymentDataToStore = {
            data: data,
            status: status,
            timestamp: Date.now()
        };
        localStorage.setItem('gittertier_payment_data', JSON.stringify(paymentDataToStore));
    }
    
    // Get stored payment data from localStorage
    function getStoredPaymentData() {
        try {
            const storedData = localStorage.getItem('gittertier_payment_data');
            if (storedData) {
                return JSON.parse(storedData);
            }
        } catch (e) {
            console.error('Error retrieving stored payment data:', e);
        }
        return null;
    }
    
    // Clear stored payment data
    function clearStoredPaymentData() {
        localStorage.removeItem('gittertier_payment_data');
    }
    
    // Clear URL parameters
    function clearURLParameters() {
        window.history.replaceState({}, document.title, window.location.pathname);
    }
    
    // Show already processed modal
    function showAlreadyProcessedModal(status) {
        // In a real implementation, this would show a modal
        // For now, we'll just update the status
        const statusEl = document.getElementById('status');
        if (status === 'confirmed') {
            statusEl.className = 'status confirmed';
            statusEl.innerHTML = '<i class="fas fa-check-circle"></i><span>Bezahlung bereits durchgeführt</span>';
        } else {
            statusEl.className = 'status declined';
            statusEl.innerHTML = '<i class="fas fa-times-circle"></i><span>Zahlung abgelehnt</span>';
        }
    }
    
    // Process payment with stored data
    function processPaymentWithStoredData() {
        // Display payment data
        displayOriginalItems();
        
        // Load user preferences
        loadUserPreferences();
        
        // Load coupons
        loadCoupons();
        
        // Initialize PeerJS
        initializePeerJS();
        
        // Use saved preferences if available
        if (APP_STATE.userPreferences) {
            APP_STATE.selectedReceiptDesign = APP_STATE.userPreferences.receiptDesign || 'compact';
            APP_STATE.selectedDeliveryOption = APP_STATE.userPreferences.deliveryOption || 'store-pickup';
            APP_STATE.selectedBaggingOption = APP_STATE.userPreferences.baggingOption || 'standard';
            APP_STATE.selectedDonationOption = APP_STATE.userPreferences.donationOption || 'none';
            APP_STATE.isLoyaltyMember = APP_STATE.userPreferences.isLoyaltyMember || false;
        }
        
        processPaymentWithSavedPreferences();
    }
    
    // Display original items only
    function displayOriginalItems() {
        const itemsList = document.getElementById('items-list');
        itemsList.innerHTML = '';
        
        APP_STATE.paymentData.items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'item-box';
            div.innerHTML = `
                <h3>${item.name}</h3>
                <p>${item.quantity}x € ${item.price.toFixed(2)}</p>
                <p>Summe: € ${(item.quantity * item.price).toFixed(2)}</p>
            `;
            itemsList.appendChild(div);
        });
    }
    
    // Display additional items (coupons, delivery, etc.)
    function displayAdditionalItems() {
        const itemsList = document.getElementById('items-list');
        
        // Clear any previously added additional items
        const additionalItems = itemsList.querySelectorAll('.additional-item');
        additionalItems.forEach(item => item.remove());
        
        // Add coupon discount if applied
        if (APP_STATE.appliedCoupon) {
            const discountDiv = document.createElement('div');
            discountDiv.className = 'item-box additional-item';
            let discountText = '';
            
            if (APP_STATE.appliedCoupon.type === 'percent') {
                discountText = `Rabatt (${APP_STATE.appliedCoupon.code}): -${APP_STATE.appliedCoupon.discount}%`;
            } else {
                discountText = `Rabatt (${APP_STATE.appliedCoupon.code}): -€ ${APP_STATE.appliedCoupon.discount.toFixed(2)}`;
            }
            
            discountDiv.innerHTML = `<h3 class="discount">${discountText}</h3>`;
            itemsList.appendChild(discountDiv);
        }
        
        // Add loyalty discount if applied
        if (APP_STATE.loyaltyDiscount > 0) {
            const loyaltyDiv = document.createElement('div');
            loyaltyDiv.className = 'item-box additional-item';
            loyaltyDiv.innerHTML = `<h3 class="discount">Treuepunkte-Rabatt: -€ ${APP_STATE.loyaltyDiscount.toFixed(2)}</h3>`;
            itemsList.appendChild(loyaltyDiv);
        }
        
        // Add delivery cost if applicable
        if (APP_STATE.selectedDeliveryOption === 'home-delivery') {
            const deliveryDiv = document.createElement('div');
            deliveryDiv.className = 'item-box additional-item';
            deliveryDiv.innerHTML = `<h3>Lieferung nach Hause: +€ 4,99</h3>`;
            itemsList.appendChild(deliveryDiv);
        }
        
        // Add bagging cost if applicable
        if (APP_STATE.selectedBaggingOption === 'standard') {
            const baggingDiv = document.createElement('div');
            baggingDiv.className = 'item-box additional-item';
            baggingDiv.innerHTML = `<h3>Standard Tüten (2x): +€ 0,40</h3>`;
            itemsList.appendChild(baggingDiv);
        } else if (APP_STATE.selectedBaggingOption === 'premium') {
            const baggingDiv = document.createElement('div');
            baggingDiv.className = 'item-box additional-item';
            baggingDiv.innerHTML = `<h3>Premium Verpackung: +€ 1,50</h3>`;
            itemsList.appendChild(baggingDiv);
        }
        
        // Add donation if applicable
        if (APP_STATE.selectedDonationOption !== 'none') {
            const donationDiv = document.createElement('div');
            donationDiv.className = 'item-box additional-item';
            donationDiv.innerHTML = `<h3>Spende: +€ ${parseFloat(APP_STATE.selectedDonationOption).toFixed(2)}</h3>`;
            itemsList.appendChild(donationDiv);
        }
    }
    
    // Load user preferences from localStorage
    function loadUserPreferences() {
        try {
            const preferences = localStorage.getItem('gittertier_payment_preferences');
            if (preferences) {
                APP_STATE.userPreferences = JSON.parse(preferences);
                
                // Load loyalty data if available
                if (APP_STATE.userPreferences.loyaltyPoints !== undefined) {
                    APP_STATE.loyaltyPoints = APP_STATE.userPreferences.loyaltyPoints;
                    updateLoyaltyTier();
                }
                
                if (APP_STATE.userPreferences.isLoyaltyMember !== undefined) {
                    APP_STATE.isLoyaltyMember = APP_STATE.userPreferences.isLoyaltyMember;
                }
                
                // Load new supermarket options if available
                if (APP_STATE.userPreferences.deliveryOption) {
                    APP_STATE.selectedDeliveryOption = APP_STATE.userPreferences.deliveryOption;
                }
                if (APP_STATE.userPreferences.baggingOption) {
                    APP_STATE.selectedBaggingOption = APP_STATE.userPreferences.baggingOption;
                }
                if (APP_STATE.userPreferences.donationOption) {
                    APP_STATE.selectedDonationOption = APP_STATE.userPreferences.donationOption;
                }
            }
        } catch (e) {
            console.error('Error loading user preferences:', e);
            APP_STATE.userPreferences = null;
        }
    }
    
    // Save user preferences to localStorage
    function saveUserPreferences() {
        try {
            const rememberChoice = document.getElementById('remember-choice').checked;
            
            if (rememberChoice) {
                APP_STATE.userPreferences = {
                    rememberChoice: true,
                    customerName: document.getElementById('customer-name').value,
                    paymentMethod: APP_STATE.selectedPaymentMethod,
                    couponCode: APP_STATE.appliedCoupon ? APP_STATE.appliedCoupon.code : null,
                    receiptDesign: APP_STATE.selectedReceiptDesign,
                    loyaltyPoints: APP_STATE.loyaltyPoints,
                    isLoyaltyMember: APP_STATE.isLoyaltyMember,
                    deliveryOption: APP_STATE.selectedDeliveryOption,
                    baggingOption: APP_STATE.selectedBaggingOption,
                    donationOption: APP_STATE.selectedDonationOption
                };
                
                localStorage.setItem('gittertier_payment_preferences', JSON.stringify(APP_STATE.userPreferences));
            } else {
                // Clear preferences if not remembering
                localStorage.removeItem('gittertier_payment_preferences');
                APP_STATE.userPreferences = null;
            }
        } catch (e) {
            console.error('Error saving user preferences:', e);
        }
    }
    
    // Load coupons from GitHub
    function loadCoupons() {
        // In a real implementation, this would fetch from a server
        // For now, we'll use some sample coupons
        APP_STATE.coupons = [
            { code: 'WELCOME10', discount: 10, type: 'percent', valid: true },
            { code: 'SUMMER5', discount: 5, type: 'percent', valid: true },
            { code: 'SAVE5', discount: 5, type: 'fixed', valid: true }
        ];
        
        // If we have saved coupon, try to apply it
        if (APP_STATE.userPreferences && APP_STATE.userPreferences.couponCode) {
            APP_STATE.appliedCoupon = APP_STATE.coupons.find(c => c.code === APP_STATE.userPreferences.couponCode);
            if (APP_STATE.appliedCoupon) {
                updatePaymentSummary();
            }
        }
    }
    
    // Process payment with saved preferences (without showing modal)
    function processPaymentWithSavedPreferences() {
        if (!APP_STATE.userPreferences) return;
        
        // Calculate final total with coupon and loyalty discount
        let finalTotal = calculateFinalTotal();
        
        // Update payment data with final total
        APP_STATE.paymentData.finalTotal = finalTotal;
        APP_STATE.paymentData.customerName = APP_STATE.userPreferences.customerName;
        APP_STATE.paymentData.paymentMethod = APP_STATE.userPreferences.paymentMethod;
        APP_STATE.paymentData.coupon = APP_STATE.appliedCoupon ? APP_STATE.appliedCoupon.code : null;
        APP_STATE.paymentData.loyaltyDiscount = APP_STATE.loyaltyDiscount;
        APP_STATE.paymentData.loyaltyPointsRedeemed = APP_STATE.loyaltyPointsToRedeem;
        APP_STATE.paymentData.loyaltyPointsEarned = APP_STATE.loyaltyPointsEarned;
        APP_STATE.paymentData.receiptDesign = APP_STATE.selectedReceiptDesign;
        APP_STATE.paymentData.deliveryOption = APP_STATE.selectedDeliveryOption;
        APP_STATE.paymentData.baggingOption = APP_STATE.selectedBaggingOption;
        APP_STATE.paymentData.donationOption = APP_STATE.selectedDonationOption;
        
        // Show payment details summary
        document.getElementById('payment-details-summary').style.display = 'block';
        document.getElementById('summary-name').textContent = APP_STATE.userPreferences.customerName;
        document.getElementById('summary-method').textContent = APP_STATE.userPreferences.paymentMethod === 'cash' ? 'Bar' : 'Karte';
        document.getElementById('summary-coupon').textContent = APP_STATE.appliedCoupon ? APP_STATE.appliedCoupon.code : 'Keiner';
        document.getElementById('summary-loyalty').textContent = APP_STATE.loyaltyPointsToRedeem > 0 ? `${APP_STATE.loyaltyPointsToRedeem} Punkte eingelöst` : 'Keine';
        document.getElementById('summary-receipt').textContent = getReceiptDesignName(APP_STATE.selectedReceiptDesign);
        document.getElementById('summary-delivery').textContent = getDeliveryOptionName(APP_STATE.selectedDeliveryOption);
        document.getElementById('summary-bagging').textContent = getBaggingOptionName(APP_STATE.selectedBaggingOption);
        document.getElementById('summary-donation').textContent = getDonationOptionName(APP_STATE.selectedDonationOption);
        
        // Update displayed amount
        document.getElementById('amount').textContent = `€ ${finalTotal.toFixed(2)}`;
        
        // Show discounts and additional costs
        displayAdditionalItems();
        
        // Start QR code generation
        startQRCodeGeneration();
    }
    
    // Calculate final total including coupons and loyalty discounts
    function calculateFinalTotal() {
        let finalTotal = APP_STATE.paymentData.total;
        
        // Apply coupon discount first
        if (APP_STATE.appliedCoupon) {
            if (APP_STATE.appliedCoupon.type === 'percent') {
                finalTotal -= finalTotal * (APP_STATE.appliedCoupon.discount / 100);
            } else {
                finalTotal -= APP_STATE.appliedCoupon.discount;
            }
        }
        
        // Apply loyalty discount
        if (APP_STATE.loyaltyDiscount > 0) {
            finalTotal -= APP_STATE.loyaltyDiscount;
        }
        
        // Apply delivery cost
        if (APP_STATE.selectedDeliveryOption === 'home-delivery') {
            finalTotal += 4.99;
        }
        
        // Apply bagging cost
        if (APP_STATE.selectedBaggingOption === 'standard') {
            // Assume 2 bags for standard shopping
            finalTotal += 0.40;
        } else if (APP_STATE.selectedBaggingOption === 'premium') {
            finalTotal += 1.50;
        }
        
        // Apply donation
        if (APP_STATE.selectedDonationOption !== 'none') {
            finalTotal += parseFloat(APP_STATE.selectedDonationOption);
        }
        
        // Calculate points to be earned from this purchase (based on original total)
        APP_STATE.loyaltyPointsEarned = Math.floor(APP_STATE.paymentData.total * LOYALTY_CONFIG.pointsPerEuro);
        
        // Apply tier discount if applicable
        const tierDiscount = finalTotal * (LOYALTY_CONFIG.tiers[APP_STATE.loyaltyTier].discount / 100);
        if (tierDiscount > 0) {
            finalTotal -= tierDiscount;
            APP_STATE.loyaltyDiscount += tierDiscount; // Add to total loyalty discount for reporting
        }
        
        // Ensure total doesn't go negative
        finalTotal = Math.max(0, finalTotal);
        
        return finalTotal;
    }
    
    // Get receipt design name for display
    function getReceiptDesignName(design) {
        switch(design) {
            case 'simple': return 'Einfach';
            case 'compact': return 'Kompakt';
            case 'detailed': return 'Detailliert';
            case 'premium': return 'Premium';
            default: return 'Kompakt';
        }
    }
    
    // Get delivery option name for display
    function getDeliveryOptionName(option) {
        switch(option) {
            case 'store-pickup': return 'Abholung im Geschäft';
            case 'home-delivery': return 'Lieferung nach Hause';
            default: return 'Abholung im Geschäft';
        }
    }
    
    // Get bagging option name for display
    function getBaggingOptionName(option) {
        switch(option) {
            case 'standard': return 'Standard Tüten';
            case 'premium': return 'Premium Verpackung';
            case 'own': return 'Eigene Tasche';
            default: return 'Standard Tüten';
        }
    }
    
    // Get donation option name for display
    function getDonationOptionName(option) {
        switch(option) {
            case 'none': return 'Keine Spende';
            case '1': return '€ 1,00 an Lebensmittelbank';
            case '2': return '€ 2,00 an Tafel';
            default: return 'Keine Spende';
        }
    }
    
    // ==================== CUSTOMER DATA SETUP MODAL FUNCTIONS ====================
    
    function showCustomerSetupModal() {
        // Initialize the modal with current values if available
        if (APP_STATE.userPreferences) {
            document.getElementById('customer-name').value = APP_STATE.userPreferences.customerName || '';
            
            if (APP_STATE.userPreferences.paymentMethod) {
                selectPaymentMethod(APP_STATE.userPreferences.paymentMethod);
            }
            
            if (APP_STATE.userPreferences.couponCode) {
                APP_STATE.appliedCoupon = APP_STATE.coupons.find(c => c.code === APP_STATE.userPreferences.couponCode);
                if (APP_STATE.appliedCoupon) {
                    document.getElementById('coupon-code').value = APP_STATE.appliedCoupon.code;
                    document.getElementById('coupon-result').innerHTML = 
                        `<div class="coupon-success">Aktiver Gutschein: ${APP_STATE.appliedCoupon.code}</div>`;
                }
            }
            
            if (APP_STATE.userPreferences.receiptDesign) {
                selectReceiptDesign(APP_STATE.userPreferences.receiptDesign);
            }
            
            if (APP_STATE.userPreferences.deliveryOption) {
                selectDeliveryOption(APP_STATE.userPreferences.deliveryOption);
            }
            
            if (APP_STATE.userPreferences.baggingOption) {
                selectBaggingOption(APP_STATE.userPreferences.baggingOption);
            }
            
            if (APP_STATE.userPreferences.donationOption) {
                selectDonationOption(APP_STATE.userPreferences.donationOption);
            }
            
            // Initialize loyalty program with current values
            if (APP_STATE.userPreferences.loyaltyPointsRedeemed !== undefined) {
                APP_STATE.loyaltyPointsToRedeem = APP_STATE.userPreferences.loyaltyPointsRedeemed;
                APP_STATE.loyaltyDiscount = APP_STATE.userPreferences.loyaltyDiscount;
            }
        }
        
        // Initialize loyalty program
        initLoyaltyProgram();
        
        // Show the modal
        showModal('customer-setup-modal');
    }
    
    function showStep(stepNumber) {
        // Validate current step before proceeding
        if (stepNumber > APP_STATE.currentStep) {
            if (APP_STATE.currentStep === 1 && !document.getElementById('customer-name').value.trim()) {
                alert('Bitte geben Sie Ihren Namen ein');
                return;
            }
            if (APP_STATE.currentStep === 2 && !APP_STATE.selectedPaymentMethod) {
                alert('Bitte wählen Sie eine Zahlungsmethode aus');
                return;
            }
        }
        
        // Hide current step
        document.getElementById(`step-${APP_STATE.currentStep}`).classList.remove('active');
        document.querySelectorAll('.step-indicator')[APP_STATE.currentStep - 1].classList.remove('active');
        
        // Show new step
        APP_STATE.currentStep = stepNumber;
        document.getElementById(`step-${APP_STATE.currentStep}`).classList.add('active');
        document.querySelectorAll('.step-indicator')[APP_STATE.currentStep - 1].classList.add('active');
        
        // Update summary if we're on the last step
        if (APP_STATE.currentStep === 9) {
            updatePaymentSummary();
        }
    }
    
    function selectPaymentMethod(method) {
        APP_STATE.selectedPaymentMethod = method;
        
        // Update UI
        document.querySelectorAll('.radio-option').forEach(option => {
            if (option.getAttribute('data-value') === method) {
                option.classList.add('selected');
            } else {
                option.classList.remove('selected');
            }
        });
    }
    
    function applyCoupon() {
        const code = document.getElementById('coupon-code').value.trim();
        const resultElement = document.getElementById('coupon-result');
        
        if (!code) {
            resultElement.innerHTML = '<div class="coupon-error">Bitte geben Sie einen Gutscheincode ein</div>';
            return;
        }
        
        // Find coupon
        const coupon = APP_STATE.coupons.find(c => c.code === code.toUpperCase());
        
        if (!coupon || !coupon.valid) {
            resultElement.innerHTML = '<div class="coupon-error">Ungültiger Gutscheincode</div>';
            return;
        }
        
        // Apply coupon
        APP_STATE.appliedCoupon = coupon;
        resultElement.innerHTML = `<div class="coupon-success">Gutschein erfolgreich angewendet: ${coupon.code}</div>`;
        
        // Update summary
        updatePaymentSummary();
    }
    
    function initLoyaltyProgram() {
        // Display current points and tier
        document.getElementById('loyalty-points').textContent = `${APP_STATE.loyaltyPoints} Punkte`;
        updateLoyaltyTier();
        
        // Calculate points to be earned from this purchase
        APP_STATE.loyaltyPointsEarned = Math.floor(APP_STATE.paymentData.total * LOYALTY_CONFIG.pointsPerEuro);
        
        // Create redemption options
        const optionsContainer = document.getElementById('loyalty-options');
        optionsContainer.innerHTML = '';
        
        // Add redemption options
        LOYALTY_CONFIG.redemptionOptions.forEach(option => {
            if (APP_STATE.loyaltyPoints >= option.points) {
                const optionElement = createLoyaltyOptionElement(option);
                optionsContainer.appendChild(optionElement);
            }
        });
        
        // Add "No redemption" option
        const noOptionElement = document.createElement('div');
        noOptionElement.className = 'loyalty-option';
        noOptionElement.innerHTML = `
            <div class="loyalty-option-details">
                <div class="loyalty-option-title">Keine Punkte einlösen</div>
                <div class="loyalty-option-desc">Punkte für zukünftige Einkäufe sparen</div>
            </div>
        `;
        
        noOptionElement.addEventListener('click', () => {
            selectLoyaltyOption(noOptionElement, { points: 0, discount: 0 });
        });
        
        optionsContainer.appendChild(noOptionElement);
    }
    
    function createLoyaltyOptionElement(option) {
        const optionElement = document.createElement('div');
        optionElement.className = 'loyalty-option';
        
        optionElement.innerHTML = `
            <div class="loyalty-option-details">
                <div class="loyalty-option-title">
                    <i class="fas fa-gift"></i>
                    ${option.title}
                </div>
                <div class="loyalty-option-desc">${option.description}</div>
            </div>
            <div class="loyalty-option-cost">${option.points} Punkte</div>
        `;
        
        optionElement.addEventListener('click', () => {
            selectLoyaltyOption(optionElement, option);
        });
        
        return optionElement;
    }
    
    function updateLoyaltyTier() {
        let newTier = 'bronze';
        
        if (APP_STATE.loyaltyPoints >= LOYALTY_CONFIG.tiers.platinum.minPoints) {
            newTier = 'platinum';
        } else if (APP_STATE.loyaltyPoints >= LOYALTY_CONFIG.tiers.gold.minPoints) {
            newTier = 'gold';
        } else if (APP_STATE.loyaltyPoints >= LOYALTY_CONFIG.tiers.silver.minPoints) {
            newTier = 'silver';
        }
        
        APP_STATE.loyaltyTier = newTier;
        
        // Update UI
        const tierElement = document.getElementById('loyalty-tier');
        tierElement.innerHTML = `<span class="tier-badge tier-${APP_STATE.loyaltyTier}">${capitalizeFirstLetter(APP_STATE.loyaltyTier)}</span>`;
        
        // Update progress bar
        const nextTier = getNextTier();
        if (nextTier) {
            const minPoints = LOYALTY_CONFIG.tiers[APP_STATE.loyaltyTier].minPoints;
            const nextTierMinPoints = LOYALTY_CONFIG.tiers[nextTier].minPoints;
            const progress = ((APP_STATE.loyaltyPoints - minPoints) / (nextTierMinPoints - minPoints)) * 100;
            
            document.getElementById('progress-fill').style.width = `${Math.min(progress, 100)}%`;
            document.getElementById('progress-text').textContent = `${APP_STATE.loyaltyPoints - minPoints}/${nextTierMinPoints - minPoints}`;
        } else {
            // Highest tier reached
            document.getElementById('progress-fill').style.width = '100%';
            document.getElementById('progress-text').textContent = 'Maximales Level erreicht!';
        }
    }
    
    function getNextTier() {
        switch(APP_STATE.loyaltyTier) {
            case 'bronze': return 'silver';
            case 'silver': return 'gold';
            case 'gold': return 'platinum';
            default: return null;
        }
    }
    
    function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }
    
    function selectLoyaltyOption(element, option) {
        // Deselect all options
        document.querySelectorAll('.loyalty-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        
        // Select clicked option
        element.classList.add('selected');
        
        // Set loyalty discount and points to redeem
        APP_STATE.loyaltyDiscount = option.discount;
        APP_STATE.loyaltyPointsToRedeem = option.points;
        
        // Show result
        const resultElement = document.getElementById('loyalty-result');
        if (option.points > 0) {
            resultElement.innerHTML = `<div class="loyalty-success">${option.title} angewendet! -€ ${option.discount.toFixed(2)}</div>`;
        } else {
            resultElement.innerHTML = '<div class="loyalty-success">Keine Punkte eingelöst</div>';
        }
    }
    
    function selectReceiptDesign(design) {
        APP_STATE.selectedReceiptDesign = design;
        
        // Update UI
        document.querySelectorAll('.design-option').forEach(option => {
            if (option.getAttribute('data-design') === design) {
                option.classList.add('selected');
            } else {
                option.classList.remove('selected');
            }
        });
    }
    
    function selectDeliveryOption(option) {
        APP_STATE.selectedDeliveryOption = option;
        
        // Update UI
        document.querySelectorAll('.delivery-option').forEach(el => {
            if (el.getAttribute('data-delivery') === option) {
                el.classList.add('selected');
            } else {
                el.classList.remove('selected');
            }
        });
    }
    
    function selectBaggingOption(option) {
        APP_STATE.selectedBaggingOption = option;
        
        // Update UI
        document.querySelectorAll('.bagging-option').forEach(el => {
            if (el.getAttribute('data-bagging') === option) {
                el.classList.add('selected');
            } else {
                el.classList.remove('selected');
            }
        });
    }
    
    function selectDonationOption(option) {
        APP_STATE.selectedDonationOption = option;
        
        // Update UI
        document.querySelectorAll('.donation-option').forEach(el => {
            if (el.getAttribute('data-donation') === option) {
                el.classList.add('selected');
            } else {
                el.classList.remove('selected');
            }
        });
    }
    
    function updatePaymentSummary() {
        const summaryElement = document.getElementById('payment-summary');
        let html = '';
        let subtotal = APP_STATE.paymentData.total;
        
        // Add items
        APP_STATE.paymentData.items.forEach(item => {
            html += `
                <div class="summary-row">
                    <span>${item.quantity}x ${item.name}</span>
                    <span>€ ${(item.quantity * item.price).toFixed(2)}</span>
                </div>
            `;
        });
        
        // Add coupon discount if applied
        if (APP_STATE.appliedCoupon) {
            let discountAmount = 0;
            
            if (APP_STATE.appliedCoupon.type === 'percent') {
                discountAmount = subtotal * (APP_STATE.appliedCoupon.discount / 100);
            } else {
                discountAmount = APP_STATE.appliedCoupon.discount;
            }
            
            subtotal -= discountAmount;
            
            html += `
                <div class="summary-row discount">
                    <span>Rabatt (${APP_STATE.appliedCoupon.code})</span>
                    <span>-€ ${discountAmount.toFixed(2)}</span>
                </div>
            `;
        }
        
        // Add loyalty discount if applied
        if (APP_STATE.loyaltyDiscount > 0) {
            subtotal -= APP_STATE.loyaltyDiscount;
            
            html += `
                <div class="summary-row discount">
                    <span>Treuepunkte-Rabatt</span>
                    <span>-€ ${APP_STATE.loyaltyDiscount.toFixed(2)}</span>
                </div>
            `;
        }
        
        // Add delivery cost if applicable
        if (APP_STATE.selectedDeliveryOption === 'home-delivery') {
            subtotal += 4.99;
            html += `
                <div class="summary-row">
                    <span>Lieferung nach Hause</span>
                    <span>+€ 4,99</span>
                </div>
            `;
        }
        
        // Add bagging cost if applicable
        if (APP_STATE.selectedBaggingOption === 'standard') {
            subtotal += 0.40;
            html += `
                <div class="summary-row">
                    <span>Standard Tüten (2x)</span>
                    <span>+€ 0,40</span>
                </div>
            `;
        } else if (APP_STATE.selectedBaggingOption === 'premium') {
            subtotal += 1.50;
            html += `
                <div class="summary-row">
                    <span>Premium Verpackung</span>
                    <span>+€ 1,50</span>
                </div>
            `;
        }
        
        // Add donation if applicable
        if (APP_STATE.selectedDonationOption !== 'none') {
            const donationAmount = parseFloat(APP_STATE.selectedDonationOption);
            subtotal += donationAmount;
            html += `
                <div class="summary-row">
                    <span>Spende</span>
                    <span>+€ ${donationAmount.toFixed(2)}</span>
                </div>
            `;
        }
        
        // Add receipt design info
        html += `
            <div class="summary-row">
                <span>Belegdesign</span>
                <span>${getReceiptDesignName(APP_STATE.selectedReceiptDesign)}</span>
            </div>
        `;
        
        // Add loyalty points info
        html += `
            <div class="summary-row">
                <span>Erworbene Punkte</span>
                <span>+${APP_STATE.loyaltyPointsEarned}</span>
            </div>
        `;
        
        // Add total
        html += `
            <div class="summary-row summary-total">
                <span>Gesamtsumme</span>
                <span>€ ${subtotal.toFixed(2)}</span>
            </div>
        `;
        
        summaryElement.innerHTML = html;
    }
    
    function processPayment() {
        const customerName = document.getElementById('customer-name').value.trim();
        
        // Validate inputs
        if (!customerName) {
            alert('Bitte geben Sie Ihren Namen ein');
            showStep(1);
            return;
        }
        
        if (!APP_STATE.selectedPaymentMethod) {
            alert('Bitte wählen Sie eine Zahlungsmethode aus');
            showStep(2);
            return;
        }
        
        // Check if loyalty points are sufficient for redemption
        if (APP_STATE.loyaltyPointsToRedeem > APP_STATE.loyaltyPoints) {
            document.getElementById('loyalty-result').innerHTML = '<div class="loyalty-error">Nicht genügend Punkte für diese Aktion</div>';
            showStep(4);
            return;
        }
        
        // Save user preferences
        saveUserPreferences();
        
        // Hide payment modal
        closeModal();
        
        // Show payment details summary
        document.getElementById('payment-details-summary').style.display = 'block';
        document.getElementById('summary-name').textContent = customerName;
        document.getElementById('summary-method').textContent = APP_STATE.selectedPaymentMethod === 'cash' ? 'Bar' : 'Karte';
        document.getElementById('summary-coupon').textContent = APP_STATE.appliedCoupon ? APP_STATE.appliedCoupon.code : 'Keiner';
        document.getElementById('summary-loyalty').textContent = APP_STATE.loyaltyPointsToRedeem > 0 ? `${APP_STATE.loyaltyPointsToRedeem} Punkte eingelöst` : 'Keine';
        document.getElementById('summary-receipt').textContent = getReceiptDesignName(APP_STATE.selectedReceiptDesign);
        document.getElementById('summary-delivery').textContent = getDeliveryOptionName(APP_STATE.selectedDeliveryOption);
        document.getElementById('summary-bagging').textContent = getBaggingOptionName(APP_STATE.selectedBaggingOption);
        document.getElementById('summary-donation').textContent = getDonationOptionName(APP_STATE.selectedDonationOption);
        
        // Calculate final total with coupon and loyalty discount
        let finalTotal = calculateFinalTotal();
        
        // Update payment data with final total
        APP_STATE.paymentData.finalTotal = finalTotal;
        APP_STATE.paymentData.customerName = customerName;
        APP_STATE.paymentData.paymentMethod = APP_STATE.selectedPaymentMethod;
        APP_STATE.paymentData.coupon = APP_STATE.appliedCoupon ? APP_STATE.appliedCoupon.code : null;
        APP_STATE.paymentData.loyaltyDiscount = APP_STATE.loyaltyDiscount;
        APP_STATE.paymentData.loyaltyPointsRedeemed = APP_STATE.loyaltyPointsToRedeem;
        APP_STATE.paymentData.loyaltyPointsEarned = APP_STATE.loyaltyPointsEarned;
        APP_STATE.paymentData.receiptDesign = APP_STATE.selectedReceiptDesign;
        APP_STATE.paymentData.deliveryOption = APP_STATE.selectedDeliveryOption;
        APP_STATE.paymentData.baggingOption = APP_STATE.selectedBaggingOption;
        APP_STATE.paymentData.donationOption = APP_STATE.selectedDonationOption;
        
        // Update displayed amount
        document.getElementById('amount').textContent = `€ ${finalTotal.toFixed(2)}`;
        
        // Show discounts and additional costs
        displayAdditionalItems();
        
        // Update stored payment data
        storePaymentData(APP_STATE.paymentData, 'pending');
        
        // Start QR code generation
        startQRCodeGeneration();
    }
    
    // ==================== PEERJS AND QR CODE FUNCTIONS ====================
    
    function initializePeerJS() {
        try {
            APP_STATE.customerPeer = new Peer(APP_STATE.paymentId, {
                debug: 2,
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });

            APP_STATE.customerPeer.on('open', (id) => {
                console.log('Customer Peer ID:', id);
            });

            APP_STATE.customerPeer.on('connection', (conn) => {
                console.log('Merchant connected:', conn.peer);
                APP_STATE.merchantConnection = conn;
                
                // Send payment data to merchant
                conn.send({
                    type: 'payment-data',
                    data: APP_STATE.paymentData
                });
                
                // Stop the countdown timer
                clearInterval(APP_STATE.countdownInterval);
                
                conn.on('data', (data) => {
                    console.log('Received data:', data);
                    if (data.type === 'confirm') {
                        handlePaymentConfirmation();
                    } else if (data.type === 'decline') {
                        handlePaymentDecline();
                    } else if (data.type === 'request-payment-data') {
                        // Send payment data to merchant
                        conn.send({
                            type: 'payment-data',
                            data: APP_STATE.paymentData
                        });
                    }
                });

                conn.on('error', (err) => {
                    console.error('Connection error:', err);
                });
            });

            APP_STATE.customerPeer.on('error', (err) => {
                console.error('PeerJS error:', err);
                // Try to reinitialize if connection fails
                if (err.type === 'peer-unavailable') {
                    setTimeout(initializePeerJS, 2000);
                }
            });
            
        } catch (error) {
            console.error('Failed to initialize PeerJS:', error);
            // Retry initialization after a delay
            setTimeout(initializePeerJS, 3000);
        }
    }
    
    function handlePaymentConfirmation() {
        const statusEl = document.getElementById('status');
        statusEl.className = 'status confirmed';
        statusEl.innerHTML = '<i class="fas fa-check-circle"></i><span>Zahlung bestätigt!</span>';
        
        // Update loyalty points
        const newPoints = APP_STATE.loyaltyPoints - APP_STATE.loyaltyPointsToRedeem + APP_STATE.loyaltyPointsEarned;
        
        // Save updated points to preferences
        if (APP_STATE.userPreferences) {
            APP_STATE.userPreferences.loyaltyPoints = newPoints;
            localStorage.setItem('gittertier_payment_preferences', JSON.stringify(APP_STATE.userPreferences));
        }
        
        // Update stored payment data
        storePaymentData(APP_STATE.paymentData, 'confirmed');
        
        clearInterval(APP_STATE.countdownInterval);
        showModal('success-modal');
    }
    
    function handlePaymentDecline() {
        const statusEl = document.getElementById('status');
        statusEl.className = 'status declined';
        statusEl.innerHTML = '<i class="fas fa-times-circle"></i><span>Zahlung abgelehnt!</span>';
        
        // Update stored payment data
        storePaymentData(APP_STATE.paymentData, 'declined');
        
        clearInterval(APP_STATE.countdownInterval);
        // Show error modal with decline message
        document.getElementById('error-message').textContent = 'Der Händler hat die Zahlung abgelehnt.';
        showModal('error-modal');
    }
    
    function startCountdown() {
        const countdownElement = document.getElementById('countdown-value');
        countdownElement.textContent = APP_STATE.countdownTime;
        
        APP_STATE.countdownInterval = setInterval(() => {
            APP_STATE.countdownTime--;
            countdownElement.textContent = APP_STATE.countdownTime;
            
            if (APP_STATE.countdownTime <= 0) {
                clearInterval(APP_STATE.countdownInterval);
                location.reload();
            }
        }, 1000);
    }
    
    function generateQR() {
        return new Promise((resolve, reject) => {
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            
            // Create minimal data structure for QR code - only the peer ID
            const qrData = JSON.stringify({
                p: APP_STATE.paymentId,  // Only include the peer ID
                t: 'gittertier-payment' // Type identifier
            });

            try {
                // Calculate QR size based on viewport
                const qrSize = Math.min(300, Math.min(window.innerWidth, window.innerHeight) * 0.7);
                
                // Generate QR code
                new QRCode(qrContainer, {
                    text: qrData,
                    width: qrSize,
                    height: qrSize,
                    colorDark: "#2c3e50",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                // Check if QR code was generated successfully
                setTimeout(() => {
                    if (qrContainer.querySelector('canvas')) {
                        resolve();
                    } else {
                        reject(new Error('QR code generation failed'));
                    }
                }, 100);
                
            } catch(error) {
                console.error('QR Generation Error:', error);
                reject(error);
            }
        });
    }
    
    function startQRCodeGeneration() {
        generateQR().then(() => {
            // QR code generated successfully
            startCountdown();
        }).catch(error => {
            console.error('QR generation failed:', error);
            document.getElementById('error-message').textContent = 'QR-Code konnte nicht generiert werden. Bitte versuchen Sie es erneut.';
            showModal('error-modal');
        });
    }
    
    // ==================== MODAL MANAGEMENT ====================
    function showModal(modalId) {
        document.getElementById(modalId).classList.add('active');
        document.getElementById('modal-overlay').classList.add('active');
    }
    
    function closeModal() {
        document.querySelectorAll('.modal').forEach(modal => {
            modal.classList.remove('active');
        });
        document.getElementById('modal-overlay').classList.remove('active');
    }
    
    // ==================== RECEIPT GENERATION ====================
    // Generate receipt for already processed payment
    function generateReceiptForProcessedPayment() {
        const storedPaymentData = getStoredPaymentData();
        if (storedPaymentData) {
            // Set the global paymentData to the stored data
            paymentData = storedPaymentData.data;
            
            // Set other necessary variables from stored data
            if (paymentData.receiptDesign) {
                selectedReceiptDesign = paymentData.receiptDesign;
            }
            if (paymentData.loyaltyPointsEarned !== undefined) {
                loyaltyPointsEarned = paymentData.loyaltyPointsEarned;
            }
            if (paymentData.loyaltyPointsRedeemed !== undefined) {
                loyaltyPointsToRedeem = paymentData.loyaltyPointsRedeemed;
            }
            if (paymentData.loyaltyDiscount !== undefined) {
                loyaltyDiscount = paymentData.loyaltyDiscount;
            }
            
            // Load user preferences to get loyalty points
            loadUserPreferences();
            
            // Generate the receipt
            generateReceipt();
        } else {
            alert('Beleg-Daten nicht gefunden.');
        }
}
    
    // Generate receipt
    function generateReceipt() {
        const receiptFormat = selectedReceiptDesign || 'compact';
        
        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.width;
        const pageHeight = doc.internal.pageSize.height;
        const paymentDate = new Date().toLocaleDateString('de-DE');
        const paymentTime = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
        const shortPaymentId = paymentId.split('-').pop().substr(0, 8);
        let yPos = 20;

        // Simple Beleg
        function generateSimpleReceipt() {
            yPos = drawHeader();
            
            doc.setFontSize(14);
            doc.setTextColor(17, 17, 17);
            doc.setFont(undefined, 'bold');
            doc.text("EINKAUFSBELEG", pageWidth / 2, yPos, null, 'center');
            yPos += 15;
            
            // Kundendaten
            doc.setFontSize(12);
            doc.setTextColor(55, 65, 81);
            doc.text(`Kunde: ${paymentData.customerName}`, 20, yPos);
            yPos += 8;
            doc.text(`Zahlungsart: ${selectedPaymentMethod === 'cash' ? 'Bar' : 'Karte'}`, 20, yPos);
            yPos += 15;
            
            // Artikel (nur Namen und Gesamtpreise)
            doc.setFontSize(11);
            doc.setTextColor(17, 17, 17);
            
            paymentData.items.forEach((item) => {
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                doc.text(`${item.quantity}x ${item.name}`, 20, yPos);
                doc.text(`€ ${(item.quantity * item.price).toFixed(2)}`, pageWidth - 20, yPos, null, 'right');
                yPos += 8;
            });
            
            // Rabatt, falls vorhanden
            if (appliedCoupon) {
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                yPos += 5;
                doc.setTextColor(22, 163, 74);
                let discountText = '';
                
                if (appliedCoupon.type === 'percent') {
                    discountText = `Rabatt (${appliedCoupon.code}): -${appliedCoupon.discount}%`;
                } else {
                    discountText = `Rabatt (${appliedCoupon.code}): -€ ${appliedCoupon.discount.toFixed(2)}`;
                }
                
                doc.text(discountText, pageWidth - 20, yPos, null, 'right');
                doc.setTextColor(17, 17, 17);
                yPos += 8;
            }
            
            // Treuepunkte-Rabatt, falls vorhanden
            if (loyaltyDiscount > 0) {
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                yPos += 5;
                doc.setTextColor(126, 34, 206);
                doc.text(`Treuepunkte-Rabatt: -€ ${loyaltyDiscount.toFixed(2)}`, pageWidth - 20, yPos, null, 'right');
                doc.setTextColor(17, 17, 17);
                yPos += 8;
            }
            
            // Lieferkosten, falls vorhanden
            if (selectedDeliveryOption === 'home-delivery') {
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                yPos += 5;
                doc.text(`Lieferung: +€ 4,99`, pageWidth - 20, yPos, null, 'right');
                yPos += 8;
            }
            
            // Verpackungskosten, falls vorhanden
            if (selectedBaggingOption === 'standard') {
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                yPos += 5;
                doc.text(`Verpackung: +€ 0,40`, pageWidth - 20, yPos, null, 'right');
                yPos += 8;
            } else if (selectedBaggingOption === 'premium') {
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                yPos += 5;
                doc.text(`Verpackung: +€ 1,50`, pageWidth - 20, yPos, null, 'right');
                yPos += 8;
            }
            
            // Spende, falls vorhanden
            if (selectedDonationOption !== 'none') {
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                yPos += 5;
                doc.text(`Spende: +€ ${parseFloat(selectedDonationOption).toFixed(2)}`, pageWidth - 20, yPos, null, 'right');
                yPos += 8;
            }
            
            // Gesamtsumme
            yPos += 10;
            doc.setDrawColor(229, 231, 235);
            doc.line(20, yPos, pageWidth - 20, yPos);
            yPos += 15;
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("Gesamtsumme:", 20, yPos);
            doc.text(`€ ${paymentData.finalTotal.toFixed(2)}`, pageWidth - 20, yPos, null, 'right');
            
            // Treuepunkte-Information
            yPos += 15;
            doc.setFontSize(10);
            doc.setTextColor(126, 34, 206);
            doc.text(`Eingelöste Punkte: ${loyaltyPointsToRedeem}`, 20, yPos);
            doc.text(`Erworbene Punkte: +${loyaltyPointsEarned}`, pageWidth - 20, yPos, null, 'right');
            
            drawFooter();
        }

        // Compact Beleg (aktuelles Design)
        function generateCompactReceipt() {
            yPos = drawHeader();
            
            doc.setFontSize(12);
            doc.setTextColor(55, 65, 81);
            
            // Kundendaten
            doc.text(`Kunde: ${paymentData.customerName}`, 20, yPos);
            yPos += 8;
            doc.text(`Zahlungsart: ${selectedPaymentMethod === 'cash' ? 'Bar' : 'Karte'}`, 20, yPos);
            yPos += 15;
            
            // Artikelübersicht
            doc.setFontSize(11);
            doc.setTextColor(17, 17, 17);
            
            paymentData.items.forEach((item) => {
                if (yPos > pageHeight - 60) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                // Artikelbox
                doc.setFillColor(249, 250, 251);
                doc.roundedRect(15, yPos - 5, pageWidth - 30, 25, 3, 3, 'F');
                doc.setDrawColor(229, 231, 235);
                doc.roundedRect(15, yPos - 5, pageWidth - 30, 25, 3, 3, 'S');
                
                // Artikelinfo
                doc.text(item.name, 25, yPos + 3);
                doc.text(`${item.quantity} x € ${item.price.toFixed(2)}`, 25, yPos + 10);
                doc.text(`€ ${(item.quantity * item.price).toFixed(2)}`, pageWidth - 25, yPos + 6, null, 'right');
                
                yPos += 30;
            });
            
            // Rabatt, falls vorhanden
            if (appliedCoupon) {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                doc.setTextColor(22, 163, 74);
                let discountText = '';
                
                if (appliedCoupon.type === 'percent') {
                    discountText = `Rabatt (${appliedCoupon.code}): -${appliedCoupon.discount}%`;
                } else {
                    discountText = `Rabatt (${appliedCoupon.code}): -€ ${appliedCoupon.discount.toFixed(2)}`;
                }
                
                doc.text(discountText, pageWidth - 20, yPos, null, 'right');
                doc.setTextColor(17, 17, 17);
                yPos += 10;
            }
            
            // Treuepunkte-Rabatt, falls vorhanden
            if (loyaltyDiscount > 0) {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                doc.setTextColor(126, 34, 206);
                doc.text(`Treuepunkte-Rabatt: -€ ${loyaltyDiscount.toFixed(2)}`, pageWidth - 20, yPos, null, 'right');
                doc.setTextColor(17, 17, 17);
                yPos += 10;
            }
            
            // Lieferkosten, falls vorhanden
            if (selectedDeliveryOption === 'home-delivery') {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                doc.text(`Lieferung: +€ 4,99`, pageWidth - 20, yPos, null, 'right');
                yPos += 10;
            }
            
            // Verpackungskosten, falls vorhanden
            if (selectedBaggingOption === 'standard') {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                doc.text(`Verpackung: +€ 0,40`, pageWidth - 20, yPos, null, 'right');
                yPos += 10;
            } else if (selectedBaggingOption === 'premium') {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                doc.text(`Verpackung: +€ 1,50`, pageWidth - 20, yPos, null, 'right');
                yPos += 10;
            }
            
            // Spende, falls vorhanden
            if (selectedDonationOption !== 'none') {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                doc.text(`Spende: +€ ${parseFloat(selectedDonationOption).toFixed(2)}`, pageWidth - 20, yPos, null, 'right');
                yPos += 10;
            }
            
            // Gesamtsumme
            yPos += 10;
            doc.setDrawColor(229, 231, 235);
            doc.line(20, yPos, pageWidth - 20, yPos);
            yPos += 15;
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("Gesamtsumme:", 20, yPos);
            doc.text(`€ ${paymentData.finalTotal.toFixed(2)}`, pageWidth - 20, yPos, null, 'right');
            
            // Treuepunkte-Information
            yPos += 15;
            doc.setFontSize(10);
            doc.setTextColor(126, 34, 206);
            doc.text(`Eingelöste Punkte: ${loyaltyPointsToRedeem}`, 20, yPos);
            doc.text(`Erworbene Punkte: +${loyaltyPointsEarned}`, pageWidth - 20, yPos, null, 'right');
            
            drawFooter();
        }

        // Detailed Beleg
        function generateDetailedReceipt() {
            yPos = drawHeader();
            
            doc.setFontSize(14);
            doc.setTextColor(17, 17, 17);
            doc.setFont(undefined, 'bold');
            doc.text("DETAILIERTER EINKAUFSBELEG", pageWidth / 2, yPos, null, 'center');
            yPos += 15;
            
            // Kundendaten
            doc.setFontSize(12);
            doc.setTextColor(55, 65, 81);
            doc.text(`Kunde: ${paymentData.customerName}`, 20, yPos);
            yPos += 8;
            doc.text(`Zahlungsart: ${selectedPaymentMethod === 'cash' ? 'Bar' : 'Karte'}`, 20, yPos);
            yPos += 8;
            doc.text(`Belegnummer: ${shortPaymentId}`, 20, yPos);
            yPos += 8;
            doc.text(`Datum: ${paymentDate} ${paymentTime}`, 20, yPos);
            yPos += 15;
            
            // Artikelübersicht mit Details
            doc.setFontSize(11);
            doc.setTextColor(17, 17, 17);
            
            // Tabellenkopf
            doc.setFillColor(243, 244, 246);
            doc.rect(20, yPos, pageWidth - 40, 12, 'F');
            doc.setDrawColor(229, 231, 235);
            doc.rect(20, yPos, pageWidth - 40, 12, 'S');
            
            doc.text("Artikel", 25, yPos + 8);
            doc.text("Menge", pageWidth - 90, yPos + 8, null, 'right');
            doc.text("Preis", pageWidth - 60, yPos + 8, null, 'right');
            doc.text("Summe", pageWidth - 20, yPos + 8, null, 'right');
            
            yPos += 15;
            
            // Artikelzeilen
            paymentData.items.forEach((item) => {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                    // Tabellenkopf auf neuer Seite
                    doc.setFillColor(243, 244, 246);
                    doc.rect(20, yPos, pageWidth - 40, 12, 'F');
                    doc.setDrawColor(229, 231, 235);
                    doc.rect(20, yPos, pageWidth - 40, 12, 'S');
                    doc.text("Artikel", 25, yPos + 8);
                    doc.text("Menge", pageWidth - 90, yPos + 8, null, 'right');
                    doc.text("Preis", pageWidth - 60, yPos + 8, null, 'right');
                    doc.text("Summe", pageWidth - 20, yPos + 8, null, 'right');
                    yPos += 15;
                }
                
                doc.text(item.name, 25, yPos + 6);
                doc.text(item.quantity.toString(), pageWidth - 90, yPos + 6, null, 'right');
                doc.text(`€ ${item.price.toFixed(2)}`, pageWidth - 60, yPos + 6, null, 'right');
                doc.text(`€ ${(item.quantity * item.price).toFixed(2)}`, pageWidth - 20, yPos + 6, null, 'right');
                
                yPos += 10;
            });
            
            // Rabatt, falls vorhanden
            if (appliedCoupon) {
                if (yPos > pageHeight - 30) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                yPos += 5;
                doc.setTextColor(22, 163, 74);
                let discountText = '';
                
                if (appliedCoupon.type === 'percent') {
                    discountText = `Rabatt (${appliedCoupon.code}): -${appliedCoupon.discount}%`;
                } else {
                    discountText = `Rabatt (${appliedCoupon.code}): -€ ${appliedCoupon.discount.toFixed(2)}`;
                }
                
                doc.text(discountText, pageWidth - 20, yPos, null, 'right');
                doc.setTextColor(17, 17, 17);
                yPos += 8;
            }
            
            // Treuepunkte-Rabatt, falls vorhanden
            if (loyaltyDiscount > 0) {
                if (yPos > pageHeight - 30) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                yPos += 5;
                doc.setTextColor(126, 34, 206);
                doc.text(`Treuepunkte-Rabatt: -€ ${loyaltyDiscount.toFixed(2)}`, pageWidth - 20, yPos, null, 'right');
                doc.setTextColor(17, 17, 17);
                yPos += 8;
            }
            
            // Lieferkosten, falls vorhanden
            if (selectedDeliveryOption === 'home-delivery') {
                if (yPos > pageHeight - 30) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                yPos += 5;
                doc.text(`Lieferung: +€ 4,99`, pageWidth - 20, yPos, null, 'right');
                yPos += 8;
            }
            
            // Verpackungskosten, falls vorhanden
            if (selectedBaggingOption === 'standard') {
                if (yPos > pageHeight - 30) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                yPos += 5;
                doc.text(`Verpackung: +€ 0,40`, pageWidth - 20, yPos, null, 'right');
                yPos += 8;
            } else if (selectedBaggingOption === 'premium') {
                if (yPos > pageHeight - 30) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                yPos += 5;
                doc.text(`Verpackung: +€ 1,50`, pageWidth - 20, yPos, null, 'right');
                yPos += 8;
            }
            
            // Spende, falls vorhanden
            if (selectedDonationOption !== 'none') {
                if (yPos > pageHeight - 30) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                yPos += 5;
                doc.text(`Spende: +€ ${parseFloat(selectedDonationOption).toFixed(2)}`, pageWidth - 20, yPos, null, 'right');
                yPos += 8;
            }
            
            // Gesamtsumme
            yPos += 10;
            doc.setDrawColor(229, 231, 235);
            doc.line(20, yPos, pageWidth - 20, yPos);
            yPos += 15;
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("Gesamtsumme:", 20, yPos);
            doc.text(`€ ${paymentData.finalTotal.toFixed(2)}`, pageWidth - 20, yPos, null, 'right');
            
            // Treuepunkte-Information
            yPos += 15;
            doc.setFontSize(10);
            doc.setTextColor(126, 34, 206);
            doc.text(`Eingelöste Punkte: ${loyaltyPointsToRedeem}`, 20, yPos);
            doc.text(`Erworbene Punkte: +${loyaltyPointsEarned}`, pageWidth - 20, yPos, null, 'right');
            
            drawFooter();
        }

        // Premium Beleg (nur für Premium-Mitglieder)
        function generatePremiumReceipt() {
            // Premium Design mit speziellen Styling
            doc.setFillColor(244, 238, 230); // Cremefarbener Hintergrund
            doc.rect(0, 0, pageWidth, pageHeight, 'F');
            
            yPos = 25;
            
            // Header mit Logo
            doc.setFontSize(24);
            doc.setTextColor(139, 107, 76); // Goldbraun
            doc.setFont(undefined, 'bold');
            doc.text("GITTERTIER PRO", pageWidth / 2, yPos, null, 'center');
            yPos += 8;
            
            doc.setFontSize(12);
            doc.setTextColor(139, 107, 76);
            doc.text("Premium Beleg", pageWidth / 2, yPos, null, 'center');
            yPos += 15;
            
            // Trennlinie
            doc.setDrawColor(197, 164, 126);
            doc.line(30, yPos, pageWidth - 30, yPos);
            yPos += 15;
            
            // Kundendaten
            doc.setFontSize(12);
            doc.setTextColor(90, 74, 58);
            doc.text(`Kunde: ${paymentData.customerName}`, 35, yPos);
            yPos += 8;
            doc.text(`Zahlungsart: ${selectedPaymentMethod === 'cash' ? 'Bar' : 'Karte'}`, 35, yPos);
            yPos += 8;
            doc.text(`Belegnummer: ${shortPaymentId}`, 35, yPos);
            yPos += 8;
            doc.text(`Datum: ${paymentDate} ${paymentTime}`, 35, yPos);
            yPos += 15;
            
            // Artikelübersicht
            doc.setFontSize(11);
            
            paymentData.items.forEach((item) => {
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = 25;
                    // Header auf neuer Seite
                    doc.setFillColor(244, 238, 230);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(90, 74, 58);
                    doc.text("Fortsetzung nächste Seite", pageWidth / 2, 15, null, 'center');
                }
                
                doc.setTextColor(90, 74, 58);
                doc.text(`${item.quantity}x ${item.name}`, 35, yPos);
                doc.text(`€ ${(item.quantity * item.price).toFixed(2)}`, pageWidth - 35, yPos, null, 'right');
                
                yPos += 8;
            });
            
            // Rabatt, falls vorhanden
            if (appliedCoupon) {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 25;
                    doc.setFillColor(244, 238, 230);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(90, 74, 58);
                    doc.text("Fortsetzung nächste Seite", pageWidth / 2, 15, null, 'center');
                }
                
                yPos += 5;
                doc.setTextColor(22, 163, 74);
                let discountText = '';
                
                if (appliedCoupon.type === 'percent') {
                    discountText = `Rabatt (${appliedCoupon.code}): -${appliedCoupon.discount}%`;
                } else {
                    discountText = `Rabatt (${appliedCoupon.code}): -€ ${appliedCoupon.discount.toFixed(2)}`;
                }
                
                doc.text(discountText, pageWidth - 35, yPos, null, 'right');
                doc.setTextColor(90, 74, 58);
                yPos += 8;
            }
            
            // Treuepunkte-Rabatt, falls vorhanden
            if (loyaltyDiscount > 0) {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 25;
                    doc.setFillColor(244, 238, 230);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(90, 74, 58);
                    doc.text("Fortsetzung nächste Seite", pageWidth / 2, 15, null, 'center');
                }
                
                yPos += 5;
                doc.setTextColor(126, 34, 206);
                doc.text(`Treuepunkte-Rabatt: -€ ${loyaltyDiscount.toFixed(2)}`, pageWidth - 35, yPos, null, 'right');
                doc.setTextColor(90, 74, 58);
                yPos += 8;
            }
            
            // Lieferkosten, falls vorhanden
            if (selectedDeliveryOption === 'home-delivery') {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 25;
                    doc.setFillColor(244, 238, 230);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(90, 74, 58);
                    doc.text("Fortsetzung nächste Seite", pageWidth / 2, 15, null, 'center');
                }
                
                yPos += 5;
                doc.text(`Lieferung: +€ 4,99`, pageWidth - 35, yPos, null, 'right');
                yPos += 8;
            }
            
            // Verpackungskosten, falls vorhanden
            if (selectedBaggingOption === 'standard') {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 25;
                    doc.setFillColor(244, 238, 230);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(90, 74, 58);
                    doc.text("Fortsetzung nächste Seite", pageWidth / 2, 15, null, 'center');
                }
                
                yPos += 5;
                doc.text(`Verpackung: +€ 0,40`, pageWidth - 35, yPos, null, 'right');
                yPos += 8;
            } else if (selectedBaggingOption === 'premium') {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 25;
                    doc.setFillColor(244, 238, 230);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(90, 74, 58);
                    doc.text("Fortsetzung nächste Seite", pageWidth / 2, 15, null, 'center');
                }
                
                yPos += 5;
                doc.text(`Verpackung: +€ 1,50`, pageWidth - 35, yPos, null, 'right');
                yPos += 8;
            }
            
            // Spende, falls vorhanden
            if (selectedDonationOption !== 'none') {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 25;
                    doc.setFillColor(244, 238, 230);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(90, 74, 58);
                    doc.text("Fortsetzung nächste Seite", pageWidth / 2, 15, null, 'center');
                }
                
                yPos += 5;
                doc.text(`Spende: +€ ${parseFloat(selectedDonationOption).toFixed(2)}`, pageWidth - 35, yPos, null, 'right');
                yPos += 8;
            }
            
            // Gesamtsumme
            yPos += 10;
            doc.setDrawColor(197, 164, 126);
            doc.line(30, yPos, pageWidth - 30, yPos);
            yPos += 15;
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(139, 107, 76);
            doc.text("Gesamtsumme:", 35, yPos);
            doc.text(`€ ${paymentData.finalTotal.toFixed(2)}`, pageWidth - 35, yPos, null, 'right');
            
            // Treuepunkte-Information
            yPos += 15;
            doc.setFontSize(10);
            doc.setTextColor(126, 34, 206);
            doc.text(`Eingelöste Punkte: ${loyaltyPointsToRedeem}`, 35, yPos);
            doc.text(`Erworbene Punkte: +${loyaltyPointsEarned}`, pageWidth - 35, yPos, null, 'right');
            
            drawFooter();
        }

        // Gold Beleg (nur für Gold-Mitglieder)
        function generateGoldReceipt() {
            // Gold Design
            doc.setFillColor(255, 250, 230); // Hellgold Hintergrund
            doc.rect(0, 0, pageWidth, pageHeight, 'F');
            
            yPos = 25;
            
            // Header mit Gold-Logo
            doc.setFontSize(26);
            doc.setTextColor(139, 107, 0); // Gold
            doc.setFont(undefined, 'bold');
            doc.text("GITTERTIER GOLD", pageWidth / 2, yPos, null, 'center');
            yPos += 8;
            
            doc.setFontSize(12);
            doc.setTextColor(139, 107, 0);
            doc.text("Exklusiv für Gold-Mitglieder", pageWidth / 2, yPos, null, 'center');
            yPos += 15;
            
            // Goldene Trennlinie
            doc.setDrawColor(255, 215, 0);
            doc.setLineWidth(1.5);
            doc.line(30, yPos, pageWidth - 30, yPos);
            doc.setLineWidth(0.5);
            yPos += 15;
            
            // Kundendaten
            doc.setFontSize(12);
            doc.setTextColor(90, 74, 0);
            doc.text(`Kunde: ${paymentData.customerName}`, 35, yPos);
            yPos += 8;
            doc.text(`Mitgliedsstatus: Gold`, 35, yPos);
            yPos += 8;
            doc.text(`Belegnummer: ${shortPaymentId}`, 35, yPos);
            yPos += 8;
            doc.text(`Datum: ${paymentDate} ${paymentTime}`, 35, yPos);
            yPos += 15;
            
            // Artikelübersicht
            doc.setFontSize(11);
            
            paymentData.items.forEach((item) => {
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = 25;
                    // Header auf neuer Seite
                    doc.setFillColor(255, 250, 230);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(90, 74, 0);
                    doc.text("Fortsetzung nächste Seite", pageWidth / 2, 15, null, 'center');
                }
                
                doc.setTextColor(90, 74, 0);
                doc.text(`${item.quantity}x ${item.name}`, 35, yPos);
                doc.text(`€ ${(item.quantity * item.price).toFixed(2)}`, pageWidth - 35, yPos, null, 'right');
                
                yPos += 8;
            });
            
            // Rabatt, falls vorhanden
            if (appliedCoupon) {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 25;
                    doc.setFillColor(255, 250, 230);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(90, 74, 0);
                    doc.text("Fortsetzung nächste Seite", pageWidth / 2, 15, null, 'center');
                }
                
                yPos += 5;
                doc.setTextColor(22, 163, 74);
                let discountText = '';
                
                if (appliedCoupon.type === 'percent') {
                    discountText = `Rabatt (${appliedCoupon.code}): -${appliedCoupon.discount}%`;
                } else {
                    discountText = `Rabatt (${appliedCoupon.code}): -€ ${appliedCoupon.discount.toFixed(2)}`;
                }
                
                doc.text(discountText, pageWidth - 35, yPos, null, 'right');
                doc.setTextColor(90, 74, 0);
                yPos += 8;
            }
            
            // Treuepunkte-Rabatt, falls vorhanden
            if (loyaltyDiscount > 0) {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 25;
                    doc.setFillColor(255, 250, 230);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(90, 74, 0);
                    doc.text("Fortsetzung nächste Seite", pageWidth / 2, 15, null, 'center');
                }
                
                yPos += 5;
                doc.setTextColor(126, 34, 206);
                doc.text(`Treuepunkte-Rabatt: -€ ${loyaltyDiscount.toFixed(2)}`, pageWidth - 35, yPos, null, 'right');
                doc.setTextColor(90, 74, 0);
                yPos += 8;
            }
            
            // Lieferkosten, falls vorhanden
            if (selectedDeliveryOption === 'home-delivery') {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 25;
                    doc.setFillColor(255, 250, 230);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(90, 74, 0);
                    doc.text("Fortsetzung nächste Seite", pageWidth / 2, 15, null, 'center');
                }
                
                yPos += 5;
                doc.text(`Lieferung: +€ 4,99`, pageWidth - 35, yPos, null, 'right');
                yPos += 8;
            }
            
            // Verpackungskosten, falls vorhanden
            if (selectedBaggingOption === 'standard') {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 25;
                    doc.setFillColor(255, 250, 230);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(90, 74, 0);
                    doc.text("Fortsetzung nächste Seite", pageWidth / 2, 15, null, 'center');
                }
                
                yPos += 5;
                doc.text(`Verpackung: +€ 0,40`, pageWidth - 35, yPos, null, 'right');
                yPos += 8;
            } else if (selectedBaggingOption === 'premium') {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 25;
                    doc.setFillColor(255, 250, 230);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(90, 74, 0);
                    doc.text("Fortsetzung nächste Seite", pageWidth / 2, 15, null, 'center');
                }
                
                yPos += 5;
                doc.text(`Verpackung: +€ 1,50`, pageWidth - 35, yPos, null, 'right');
                yPos += 8;
            }
            
            // Spende, falls vorhanden
            if (selectedDonationOption !== 'none') {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 25;
                    doc.setFillColor(255, 250, 230);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(90, 74, 0);
                    doc.text("Fortsetzung nächste Seite", pageWidth / 2, 15, null, 'center');
                }
                
                yPos += 5;
                doc.text(`Spende: +€ ${parseFloat(selectedDonationOption).toFixed(2)}`, pageWidth - 35, yPos, null, 'right');
                yPos += 8;
            }
            
            // Gesamtsumme
            yPos += 10;
            doc.setDrawColor(255, 215, 0);
            doc.setLineWidth(1.5);
            doc.line(30, yPos, pageWidth - 30, yPos);
            doc.setLineWidth(0.5);
            yPos += 15;
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(139, 107, 0);
            doc.text("Gesamtsumme:", 35, yPos);
            doc.text(`€ ${paymentData.finalTotal.toFixed(2)}`, pageWidth - 35, yPos, null, 'right');
            
            // Treuepunkte-Information
            yPos += 15;
            doc.setFontSize(10);
            doc.setTextColor(126, 34, 206);
            doc.text(`Eingelöste Punkte: ${loyaltyPointsToRedeem}`, 35, yPos);
            doc.text(`Erworbene Punkte: +${loyaltyPointsEarned}`, pageWidth - 35, yPos, null, 'right');
            
            drawFooter();
        }

        // Platinum Beleg (nur für Platinum-Mitglieder)
        function generatePlatinumReceipt() {
            // Platinum Design
            doc.setFillColor(240, 240, 240); // Platinfarbener Hintergrund
            doc.rect(0, 0, pageWidth, pageHeight, 'F');
            
            yPos = 25;
            
            // Header mit Platinum-Logo
            doc.setFontSize(26);
            doc.setTextColor(96, 96, 96); // Platinum
            doc.setFont(undefined, 'bold');
            doc.text("GITTERTIER PLATINUM", pageWidth / 2, yPos, null, 'center');
            yPos += 8;
            
            doc.setFontSize(12);
            doc.setTextColor(96, 96, 96);
            doc.text("Exklusiv für Platinum-Mitglieder", pageWidth / 2, yPos, null, 'center');
            yPos += 15;
            
            // Platinum Trennlinie
            doc.setDrawColor(185, 242, 255);
            doc.setLineWidth(1.5);
            doc.line(30, yPos, pageWidth - 30, yPos);
            doc.setLineWidth(0.5);
            yPos += 15;
            
            // Kundendaten
            doc.setFontSize(12);
            doc.setTextColor(47, 79, 79);
            doc.text(`Kunde: ${paymentData.customerName}`, 35, yPos);
            yPos += 8;
            doc.text(`Mitgliedsstatus: Platinum`, 35, yPos);
            yPos += 8;
            doc.text(`Belegnummer: ${shortPaymentId}`, 35, yPos);
            yPos += 8;
            doc.text(`Datum: ${paymentDate} ${paymentTime}`, 35, yPos);
            yPos += 15;
            
            // Artikelübersicht
            doc.setFontSize(11);
            
            paymentData.items.forEach((item) => {
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = 25;
                    // Header auf neuer Seite
                    doc.setFillColor(240, 240, 240);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(47, 79, 79);
                    doc.text("Fortsetzung nächste Seite", pageWidth / 2, 15, null, 'center');
                }
                
                doc.setTextColor(47, 79, 79);
                doc.text(`${item.quantity}x ${item.name}`, 35, yPos);
                doc.text(`€ ${(item.quantity * item.price).toFixed(2)}`, pageWidth - 35, yPos, null, 'right');
                
                yPos += 8;
            });
            
            // Rabatt, falls vorhanden
            if (appliedCoupon) {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 25;
                    doc.setFillColor(240, 240, 240);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(47, 79, 79);
                    doc.text("Fortsetzung nächste Seite", pageWidth / 2, 15, null, 'center');
                }
                
                yPos += 5;
                doc.setTextColor(22, 163, 74);
                let discountText = '';
                
                if (appliedCoupon.type === 'percent') {
                    discountText = `Rabatt (${appliedCoupon.code}): -${appliedCoupon.discount}%`;
                } else {
                    discountText = `Rabatt (${appliedCoupon.code}): -€ ${appliedCoupon.discount.toFixed(2)}`;
                }
                
                doc.text(discountText, pageWidth - 35, yPos, null, 'right');
                doc.setTextColor(47, 79, 79);
                yPos += 8;
            }
            
            // Treuepunkte-Rabatt, falls vorhanden
            if (loyaltyDiscount > 0) {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 25;
                    doc.setFillColor(240, 240, 240);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(47, 79, 79);
                    doc.text("Fortsetzung nächste Seite", pageWidth / 2, 15, null, 'center');
                }
                
                yPos += 5;
                doc.setTextColor(126, 34, 206);
                doc.text(`Treuepunkte-Rabatt: -€ ${loyaltyDiscount.toFixed(2)}`, pageWidth - 35, yPos, null, 'right');
                doc.setTextColor(47, 79, 79);
                yPos += 8;
            }
            
            // Lieferkosten, falls vorhanden
            if (selectedDeliveryOption === 'home-delivery') {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 25;
                    doc.setFillColor(240, 240, 240);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(47, 79, 79);
                    doc.text("Fortsetzung nächste Seite", pageWidth / 2, 15, null, 'center');
                }
                
                yPos += 5;
                doc.text(`Lieferung: +€ 4,99`, pageWidth - 35, yPos, null, 'right');
                yPos += 8;
            }
            
            // Verpackungskosten, falls vorhanden
            if (selectedBaggingOption === 'standard') {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 25;
                    doc.setFillColor(240, 240, 240);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(47, 79, 79);
                    doc.text("Fortsetzung nächste Seite", pageWidth / 2, 15, null, 'center');
                }
                
                yPos += 5;
                doc.text(`Verpackung: +€ 0,40`, pageWidth - 35, yPos, null, 'right');
                yPos += 8;
            } else if (selectedBaggingOption === 'premium') {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 25;
                    doc.setFillColor(240, 240, 240);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(47, 79, 79);
                    doc.text("Fortsetzung nächste Seite", pageWidth / 2, 15, null, 'center');
                }
                
                yPos += 5;
                doc.text(`Verpackung: +€ 1,50`, pageWidth - 35, yPos, null, 'right');
                yPos += 8;
            }
            
            // Spende, falls vorhanden
            if (selectedDonationOption !== 'none') {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 25;
                    doc.setFillColor(240, 240, 240);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');
                    doc.setFontSize(12);
                    doc.setTextColor(47, 79, 79);
                    doc.text("Fortsetzung nächste Seite", pageWidth / 2, 15, null, 'center');
                }
                
                yPos += 5;
                doc.text(`Spende: +€ ${parseFloat(selectedDonationOption).toFixed(2)}`, pageWidth - 35, yPos, null, 'right');
                yPos += 8;
            }
            
            // Gesamtsumme
            yPos += 10;
            doc.setDrawColor(185, 242, 255);
            doc.setLineWidth(1.5);
            doc.line(30, yPos, pageWidth - 30, yPos);
            doc.setLineWidth(0.5);
            yPos += 15;
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(96, 96, 96);
            doc.text("Gesamtsumme:", 35, yPos);
            doc.text(`€ ${paymentData.finalTotal.toFixed(2)}`, pageWidth - 35, yPos, null, 'right');
            
            // Treuepunkte-Information
            yPos += 15;
            doc.setFontSize(10);
            doc.setTextColor(126, 34, 206);
            doc.text(`Eingelöste Punkte: ${loyaltyPointsToRedeem}`, 35, yPos);
            doc.text(`Erworbene Punkte: +${loyaltyPointsEarned}`, pageWidth - 35, yPos, null, 'right');
            
            drawFooter();
        }

        // Gemeinsame Funktionen
        function drawHeader() {
            const yStart = 15;
            doc.setFontSize(10);
            doc.setTextColor(107, 114, 128);
            doc.text("Gittertier Pro", pageWidth / 2, yStart, null, 'center');
            doc.text(`Beleg ${shortPaymentId}`, pageWidth / 2, yStart + 5, null, 'center');
            return yStart + 15;
        }

        function drawFooter() {
            const yPos = pageHeight - 20;
            doc.setFontSize(8);
            doc.setTextColor(107, 114, 128);
            doc.text("Vielen Dank für Ihren Einkauf!", pageWidth / 2, yPos, null, 'center');
            doc.text("Ihr Gittertier Pro Team", pageWidth / 2, yPos + 5, null, 'center');
        }

        // Wählen Sie das passende Receipt-Format
        switch(receiptFormat) {
            case 'simple':
                generateSimpleReceipt();
                break;
            case 'detailed':
                generateDetailedReceipt();
                break;
            case 'premium':
                generatePremiumReceipt();
                break;
            case 'gold':
                generateGoldReceipt();
                break;
            case 'platinum':
                generatePlatinumReceipt();
                break;
            default:
                generateCompactReceipt();
        }

        // PDF speichern
        doc.save(`Gittertier_Beleg_${shortPaymentId}.pdf`);
    }  
    </script>
</body>
</html>
