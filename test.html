<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bezahlung - Gittertier Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    :root {
        --color-bg: #ffffff;
        --color-text: #111111;
        --color-text-muted: #6b7280;
        --color-border: #e5e7eb;
        --color-accent: #2563eb;
        --color-accent-hover: #1d4ed8;
        --color-success: #16a34a;
        --color-error: #dc2626;
        --color-warning: #f59e0b;
        --color-warning-bg: #fffbeb;
        --color-warning-border: #fcd34d;
        --color-overlay: rgba(0, 0, 0, 0.5);
        --color-premium: #c5a47e;
        --color-premium-dark: #8b6b4c;
        --color-premium-light: #f4eee6;
        
        /* Loyalty Program Colors */
        --color-bronze: #cd7f32;
        --color-silver: #c0c0c0;
        --color-gold: #ffd700;
        --color-platinum: #e5e4e2;
        --color-diamond: #b9f2ff;
        --color-loyalty-primary: #7e22ce;
        --color-loyalty-secondary: #a855f7;
        --color-loyalty-light: #f3e8ff;
        
        /* New Supermarket Colors */
        --color-fresh: #22c55e;
        --color-fresh-light: #dcfce7;
        --color-frozen: #3b82f6;
        --color-frozen-light: #dbeafe;
        --color-household: #f97316;
        --color-household-light: #ffedd5;
        
        --radius: 12px;
        --radius-sm: 6px;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.07), 0 1px 2px rgba(0, 0, 0, 0.04);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --focus-ring: 0 0 0 3px rgba(37, 99, 235, 0.35);
        
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;
        --spacing-xxl: 48px;
        
        --transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
        --transition-slow: all 0.3s cubic-bezier(0.2, 0, 0, 1);
        
        --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, "Helvetica Neue", Arial, sans-serif;
        --text-xs: 0.75rem;
        --text-sm: 0.875rem;
        --text-base: 1rem;
        --text-lg: 1.125rem;
        --text-xl: 1.25rem;
        --text-2xl: 1.5rem;
        --text-3xl: 1.875rem;
        
        --header-height: 64px;
        --footer-height: 80px;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: var(--font-family);
        background-color: var(--color-bg);
        color: var(--color-text);
        line-height: 1.5;
        min-height: 100vh;
        padding-bottom: var(--footer-height);
    }

    /* Header Styles */
    header {
        height: var(--header-height);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 var(--spacing-lg);
        border-bottom: 1px solid var(--color-border);
        background-color: var(--color-bg);
        position: sticky;
        top: 0;
        z-index: 50;
    }

    .logo {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        font-weight: 700;
        font-size: var(--text-xl);
    }

    .logo i {
        font-size: var(--text-xl);
        color: var(--color-accent);
    }

    .header-controls {
        display: flex;
        gap: var(--spacing-md);
        align-items: center;
    }

    .edit-details-btn {
        background: none;
        border: none;
        color: var(--color-accent);
        cursor: pointer;
        font-size: var(--text-lg);
        padding: var(--spacing-sm);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Main Content */
    main {
        max-width: 600px;
        margin: 0 auto;
        padding: var(--spacing-xl) var(--spacing-lg);
    }

    .section {
        margin-bottom: var(--spacing-xl);
    }

    .section-title {
        font-size: var(--text-lg);
        font-weight: 600;
        margin-bottom: var(--spacing-md);
        color: var(--color-text);
    }

    /* Payment Card */
    .payment-card {
        background: var(--color-bg);
        border-radius: var(--radius);
        border: 1px solid var(--color-border);
        box-shadow: var(--shadow);
        padding: var(--spacing-xl);
        text-align: center;
        position: relative;
        overflow: hidden;
        animation: fadeIn 0.4s ease-out;
    }

    .payment-header {
        margin-bottom: var(--spacing-xl);
    }

    .payment-title {
        font-size: var(--text-2xl);
        font-weight: 700;
        margin-bottom: var(--spacing-sm);
        color: var(--color-text);
    }

    .payment-subtitle {
        color: var(--color-text-muted);
        font-size: var(--text-base);
    }

    .amount {
        font-size: var(--text-3xl);
        font-weight: 700;
        margin: var(--spacing-lg) 0;
        color: var(--color-text);
    }

    /* Items List */
    .items-list {
        margin: var(--spacing-lg) 0;
        text-align: left;
    }

    .item-box {
        background: #f9fafb;
        border-radius: var(--radius);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-sm);
        border: 1px solid var(--color-border);
    }

    .item-box h3 {
        font-size: var(--text-base);
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
    }

    .item-box p {
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        margin-bottom: var(--spacing-xs);
    }

    /* QR Code */
    #qrcode {
        margin: var(--spacing-xl) auto;
        padding: var(--spacing-md);
        background: #f9fafb;
        border-radius: var(--radius);
        display: inline-block;
        border: 1px solid var(--color-border);
        box-shadow: var(--shadow);
        max-width: 100%;
        overflow: hidden;
    }

    #qrcode canvas, 
    #qrcode img {
        max-width: 100%;
        height: auto !important;
        display: block;
        margin: 0 auto;
    }

    /* Countdown */
    .countdown-container {
        margin: var(--spacing-lg) 0;
        font-size: var(--text-base);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        color: var(--color-text);
    }

    .countdown-value {
        font-weight: 700;
        font-size: var(--text-lg);
        background: #f3f4f6;
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--radius-sm);
    }

    /* Status */
    .status {
        padding: var(--spacing-md);
        border-radius: var(--radius);
        margin: var(--spacing-lg) 0;
        font-size: var(--text-base);
        font-weight: 600;
        transition: all 0.3s ease;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        box-shadow: var(--shadow);
    }

    .status.pending {
        background: #fffbeb;
        color: #b45309;
        border: 1px solid #fcd34d;
    }

    .status.confirmed {
        background: #f0fdf4;
        color: #166534;
        border: 1px solid #86efac;
    }

    .status.declined {
        background: #fef2f2;
        color: #991b1b;
        border: 1px solid #fca5a5;
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: var(--spacing-md);
        margin-top: var(--spacing-xl);
        flex-wrap: wrap;
    }

    .action-btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-md);
        border: 1px solid var(--color-border);
        border-radius: var(--radius);
        background-color: var(--color-bg);
        color: var(--color-text);
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
        min-width: 140px;
    }

    .action-btn:hover {
        background-color: #f9fafb;
        border-color: var(--color-accent);
    }

    .action-btn:focus {
        outline: none;
        box-shadow: var(--focus-ring);
    }

    .action-btn i {
        font-size: var(--text-lg);
    }

    .cancel-btn {
        color: var(--color-error);
        border-color: rgba(220, 38, 38, 0.2);
    }

    .cancel-btn:hover {
        background-color: rgba(220, 38, 38, 0.05);
        border-color: var(--color-error);
    }

    .confirm-btn {
        color: var(--color-success);
        border-color: rgba(22, 163, 74, 0.2);
    }

    .confirm-btn:hover {
        background-color: rgba(22, 163, 74, 0.05);
        border-color: var(--color-success);
    }

    /* Modal Styles - Redesigned */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--color-overlay);
        z-index: 100;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-lg);
    }

    .modal-content {
        background-color: var(--color-bg);
        border-radius: var(--radius);
        padding: var(--spacing-xl);
        width: 100%;
        max-width: 500px;
        box-shadow: var(--shadow-md);
        animation: scaleIn 0.3s cubic-bezier(0.2, 0, 0, 1);
        text-align: center;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
    }

    .modal-icon {
        font-size: 3rem;
        margin-bottom: var(--spacing-lg);
    }

    .modal-title {
        font-weight: 600;
        font-size: var(--text-xl);
        margin-bottom: var(--spacing-md);
    }

    .modal-message {
        color: var(--color-text-muted);
        margin-bottom: var(--spacing-xl);
    }

    .modal-actions {
        display: flex;
        gap: var(--spacing-md);
    }

    .modal-btn {
        flex: 1;
        padding: var(--spacing-md);
        border-radius: var(--radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
    }

    .modal-btn.primary {
        background-color: var(--color-accent);
        color: white;
        border: none;
    }

    .modal-btn.primary:hover {
        background-color: var(--color-accent-hover);
    }

    .modal-btn.secondary {
        background-color: transparent;
        border: 1px solid var(--color-border);
        color: var(--color-text-muted);
    }

    .modal-btn.secondary:hover {
        background-color: #f9fafb;
        color: var(--color-text);
    }

    /* Payment Modal Specific Styles - Redesigned */
    #payment-modal .modal-content {
        max-width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        padding: var(--spacing-lg);
    }

    .payment-modal-header {
        display: flex;
        align-items: center;
        margin-bottom: var(--spacing-lg);
        padding-bottom: var(--spacing-md);
        border-bottom: 1px solid var(--color-border);
        position: relative;
    }

    .payment-modal-title {
        font-weight: 600;
        font-size: var(--text-xl);
        text-align: center;
        flex: 1;
        margin: 0;
        color: var(--color-accent);
    }

    .payment-modal-close {
        position: absolute;
        right: 0;
        top: 0;
        background: none;
        border: none;
        font-size: var(--text-lg);
        color: var(--color-text-muted);
        cursor: pointer;
        padding: var(--spacing-xs);
    }

    .form-group {
        margin-bottom: var(--spacing-lg);
        text-align: left;
    }

    .form-group label {
        display: block;
        margin-bottom: var(--spacing-xs);
        font-weight: 500;
        color: var(--color-text);
    }

    .form-control {
        width: 100%;
        padding: var(--spacing-md);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-sm);
        font-size: var(--text-base);
        transition: var(--transition);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--color-accent);
        box-shadow: var(--focus-ring);
    }

    .radio-group {
        display: flex;
        gap: var(--spacing-md);
        margin-top: var(--spacing-sm);
    }

    .radio-option {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-md);
        border: 2px solid var(--color-border);
        border-radius: var(--radius);
        cursor: pointer;
        transition: var(--transition);
        min-height: 80px;
    }

    .radio-option.selected {
        border-color: var(--color-accent);
        background-color: rgba(37, 99, 235, 0.05);
    }

    .radio-option i {
        font-size: var(--text-xl);
        margin-bottom: var(--spacing-xs);
    }

    .radio-option.premium {
        border-color: var(--color-premium);
    }

    .radio-option.premium.selected {
        background-color: rgba(197, 164, 126, 0.1);
        position: relative;
        overflow: hidden;
    }

    .radio-option.premium.selected::after {
        content: "★";
        position: absolute;
        top: 5px;
        right: 5px;
        color: var(--color-premium);
        font-size: var(--text-sm);
    }

    .coupon-section {
        background-color: #f9fafb;
        border-radius: var(--radius);
        padding: var(--spacing-md);
        margin-top: var(--spacing-lg);
    }

    .coupon-header {
        display: flex;
        align-items: center;
        margin-bottom: var(--spacing-sm);
    }

    .coupon-title {
        font-weight: 500;
        color: var(--color-text);
    }

    .coupon-content {
        margin-top: var(--spacing-md);
        display: block;
    }

    .coupon-apply-btn-container {
        display: flex;
        justify-content: center;
        margin-top: var(--spacing-sm);
    }

    .coupon-apply-btn-container .action-btn {
        width: auto;
        min-width: 120px;
    }

    .coupon-input-group {
        display: flex;
        gap: var(--spacing-sm);
    }

    .coupon-input {
        flex: 1;
    }

    .apply-coupon-btn {
        white-space: nowrap;
    }

    .coupon-result {
        margin-top: var(--spacing-sm);
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        font-size: var(--text-sm);
    }

    .coupon-success {
        background-color: rgba(22, 163, 74, 0.1);
        color: var(--color-success);
    }

    .coupon-error {
        background-color: rgba(220, 38, 38, 0.1);
        color: var(--color-error);
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--spacing-xs);
        padding: var(--spacing-xs) 0;
    }

    .summary-total {
        border-top: 1px solid var(--color-border);
        margin-top: var(--spacing-xs);
        padding-top: var(--spacing-sm);
        font-weight: 700;
        font-size: var(--text-lg);
    }

    .discount {
        color: var(--color-success);
    }

    .remember-choice {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-lg);
        font-size: var(--text-sm);
    }

    .payment-details-summary {
        background-color: #f9fafb;
        border-radius: var(--radius);
        padding: var(--spacing-md);
        margin: var(--spacing-lg) 0;
        text-align: left;
    }

    .payment-details-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--spacing-xs);
    }

    .payment-details-label {
        font-weight: 500;
        color: var(--color-text-muted);
    }

    .payment-details-value {
        font-weight: 600;
    }

    /* Step-by-step tutorial styles - Redesigned */
    .step {
        display: none;
    }
    
    .step.active {
        display: block;
        animation: fadeIn 0.3s ease-out;
    }
    
    .step-indicators {
        display: flex;
        justify-content: center;
        margin-bottom: var(--spacing-lg);
        gap: var(--spacing-xs);
    }
    
    .step-indicator {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background-color: var(--color-border);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        position: relative;
        transition: var(--transition);
    }
    
    .step-indicator.active {
        background-color: var(--color-accent);
        color: white;
        transform: scale(1.1);
    }
    
    .step-indicator::before {
        content: attr(data-step);
    }
    
    .step-navigation {
        display: flex;
        justify-content: space-between;
        margin-top: var(--spacing-xl);
    }

    /* Receipt Design Options */
    .receipt-design-options {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-md);
        margin-top: var(--spacing-md);
    }

    .design-option {
        border: 2px solid var(--color-border);
        border-radius: var(--radius);
        padding: var(--spacing-md);
        text-align: center;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100px;
    }

    .design-option:hover {
        border-color: var(--color-accent);
    }

    .design-option.selected {
        border-color: var(--color-accent);
        background-color: rgba(37, 99, 235, 0.05);
    }

    .design-option.premium {
        border-color: var(--color-premium);
        background: linear-gradient(135deg, var(--color-premium-light) 0%, #ffffff 100%);
        position: relative;
        overflow: hidden;
    }

    .design-option.premium::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--color-premium) 0%, var(--color-premium-dark) 100%);
    }

    .design-option.premium.selected {
        border-color: var(--color-premium);
        background: linear-gradient(135deg, var(--color-premium-light) 0%, #f9f6f2 100%);
        box-shadow: 0 4px 12px rgba(197, 164, 126, 0.2);
    }

    .design-option.premium .premium-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background-color: var(--color-premium);
        color: white;
        font-size: var(--text-xs);
        padding: 2px 6px;
        border-radius: 10px;
        font-weight: 600;
    }

    .design-option i {
        font-size: var(--text-xl);
        margin-bottom: var(--spacing-xs);
        color: var(--color-text);
    }

    .design-option.premium i {
        color: var(--color-premium-dark);
    }

    .design-preview {
        margin-top: var(--spacing-md);
        padding: var(--spacing-md);
        border: 1px solid var(--color-border);
        border-radius: var(--radius);
        background-color: #f9fafb;
        text-align: left;
        display: none;
    }

    .design-preview.active {
        display: block;
    }

    .design-preview.premium-preview {
        background: linear-gradient(135deg, var(--color-premium-light) 0%, #ffffff 100%);
        border-color: var(--color-premium);
        color: #5a4a3a;
        font-family: 'Georgia', serif;
    }

    .design-preview.premium-preview .preview-header {
        text-align: center;
        border-bottom: 2px solid var(--color-premium);
        padding-bottom: var(--spacing-sm);
        margin-bottom: var(--spacing-sm);
    }

    .design-preview.premium-preview .preview-header h3 {
        color: var(--color-premium-dark);
        font-weight: bold;
        font-size: 1.2em;
        letter-spacing: 1px;
    }

    .design-preview.premium-preview .preview-item {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        border-bottom: 1px dotted #d6c8b5;
    }

    .design-preview.premium-preview .preview-total {
        font-weight: bold;
        border-top: 2px solid var(--color-premium);
        margin-top: var(--spacing-sm);
        padding-top: var(--spacing-sm);
    }

    /* LOYALTY PROGRAM STYLES - COMPLETELY REDESIGNED */
    .loyalty-intro-container {
        text-align: center;
        padding: var(--spacing-lg) 0;
    }

    .loyalty-program-name {
        font-size: var(--text-2xl);
        font-weight: 700;
        color: var(--color-loyalty-primary);
        margin-bottom: var(--spacing-md);
        background: linear-gradient(135deg, var(--color-loyalty-primary) 0%, var(--color-loyalty-secondary) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .loyalty-intro-icon {
        font-size: 4rem;
        color: var(--color-loyalty-primary);
        margin-bottom: var(--spacing-lg);
        animation: pulse 2s infinite;
    }

    .loyalty-benefits-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-md);
        margin: var(--spacing-lg) 0;
    }

    .loyalty-benefit-card {
        background: white;
        border-radius: var(--radius);
        padding: var(--spacing-md);
        text-align: center;
        box-shadow: var(--shadow);
        transition: var(--transition);
        border: 1px solid var(--color-border);
    }

    .loyalty-benefit-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-md);
    }

    .loyalty-benefit-card i {
        font-size: var(--text-2xl);
        color: var(--color-loyalty-primary);
        margin-bottom: var(--spacing-sm);
    }

    .loyalty-join-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: var(--spacing-xl) 0;
        gap: var(--spacing-md);
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .toggle-slider {
        background: linear-gradient(135deg, var(--color-loyalty-primary) 0%, var(--color-loyalty-secondary) 100%);
    }

    input:checked + .toggle-slider:before {
        transform: translateX(26px);
    }

    .toggle-label {
        font-weight: 600;
        color: var(--color-text);
    }

    .loyalty-join-btn {
        background: linear-gradient(135deg, var(--color-loyalty-primary) 0%, var(--color-loyalty-secondary) 100%);
        color: white;
        border: none;
        padding: var(--spacing-md) var(--spacing-xl);
        border-radius: var(--radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: 0 4px 6px rgba(126, 34, 206, 0.2);
        margin-top: var(--spacing-lg);
    }

    .loyalty-join-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(126, 34, 206, 0.3);
    }

    .loyalty-join-btn:disabled {
        background: var(--color-border);
        color: var(--color-text-muted);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .loyalty-section {
        background-color: var(--color-loyalty-light);
        border-radius: var(--radius);
        padding: var(--spacing-md);
        margin-top: var(--spacing-lg);
        border: 1px solid var(--color-loyalty-secondary);
    }

    .loyalty-header {
        display: flex;
        align-items: center;
        margin-bottom: var(--spacing-sm);
    }

    .loyalty-title {
        font-weight: 600;
        color: var(--color-loyalty-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .loyalty-content {
        margin-top: var(--spacing-md);
        display: block;
    }

    .loyalty-status {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--spacing-md);
        padding: var(--spacing-sm);
        background: white;
        border-radius: var(--radius-sm);
        box-shadow: var(--shadow);
    }

    .loyalty-points {
        font-weight: 700;
        font-size: var(--text-lg);
        color: var(--color-loyalty-primary);
    }

    .loyalty-tier {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-weight: 600;
    }

    .tier-badge {
        padding: 4px 8px;
        border-radius: 20px;
        font-size: var(--text-xs);
        font-weight: 700;
    }

    .tier-bronze {
        background-color: var(--color-bronze);
        color: white;
    }

    .tier-silver {
        background-color: var(--color-silver);
        color: #333;
    }

    .tier-gold {
        background-color: var(--color-gold);
        color: #333;
    }

    .tier-platinum {
        background-color: var(--color-platinum);
        color: #333;
    }

    .tier-diamond {
        background: linear-gradient(135deg, var(--color-diamond) 0%, #b9f2ff 100%);
        color: #0066a6;
    }

    .progress-container {
        margin: var(--spacing-md) 0;
    }

    .progress-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--spacing-xs);
        font-size: var(--text-sm);
    }

    .progress-bar {
        height: 8px;
        background-color: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--color-loyalty-primary), var(--color-loyalty-secondary));
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .loyalty-options {
        margin-top: var(--spacing-md);
    }

    .loyalty-option {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--spacing-md);
        background: white;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-sm);
        margin-bottom: var(--spacing-sm);
        cursor: pointer;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
    }

    .loyalty-option:hover {
        border-color: var(--color-loyalty-primary);
        background-color: #faf5ff;
        transform: translateY(-2px);
        box-shadow: var(--shadow);
    }

    .loyalty-option.selected {
        border-color: var(--color-loyalty-primary);
        background-color: var(--color-loyalty-light);
        box-shadow: 0 0 0 3px rgba(126, 34, 206, 0.2);
    }

    .loyalty-option.unavailable {
        opacity: 0.6;
        cursor: not-allowed;
        background-color: #f9fafb;
    }

    .loyalty-option.unavailable:hover {
        transform: none;
        border-color: var(--color-border);
        background-color: #f9fafb;
        box-shadow: none;
    }

    .loyalty-option-featured {
        position: absolute;
        top: -5px;
        right: -5px;
        background: linear-gradient(135deg, var(--color-gold) 0%, #ffd700 100%);
        color: #333;
        font-size: var(--text-xs);
        font-weight: 700;
        padding: 4px 8px;
        border-radius: 0 0 0 10px;
        transform: rotate(3deg);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        animation: shimmer 2s infinite;
    }

    .loyalty-option-details {
        display: flex;
        flex-direction: column;
        flex: 1;
    }

    .loyalty-option-title {
        font-weight: 600;
        color: var(--color-loyalty-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .loyalty-option-desc {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        margin-top: var(--spacing-xs);
    }

    .loyalty-option-cost {
        font-weight: 700;
        color: var(--color-loyalty-primary);
        white-space: nowrap;
        margin-left: var(--spacing-sm);
    }

    .loyalty-rewards {
        margin-top: var(--spacing-md);
        padding-top: var(--spacing-md);
        border-top: 1px dashed var(--color-border);
    }

    .loyalty-rewards-title {
        font-weight: 600;
        margin-bottom: var(--spacing-sm);
        color: var(--color-loyalty-primary);
    }

    .loyalty-benefits {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-sm);
    }

    .loyalty-benefit {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: var(--text-xs);
        padding: var(--spacing-xs);
        background: white;
        border-radius: var(--radius-sm);
        box-shadow: var(--shadow);
    }

    .loyalty-benefit i {
        color: var(--color-loyalty-primary);
    }

    .loyalty-result {
        margin-top: var(--spacing-sm);
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        font-size: var(--text-sm);
    }

    .loyalty-success {
        background-color: rgba(22, 163, 74, 0.1);
        color: var(--color-success);
    }

    .loyalty-error {
        background-color: rgba(220, 38, 38, 0.1);
        color: var(--color-error);
    }

    .points-earned {
        margin-top: var(--spacing-md);
        padding: var(--spacing-sm);
        background: rgba(22, 163, 74, 0.1);
        border-radius: var(--radius-sm);
        color: var(--color-success);
        font-weight: 600;
        text-align: center;
        animation: pulse 2s infinite;
    }

    /* NEW SUPERMARKET FEATURES */
    .delivery-section {
        background-color: var(--color-fresh-light);
        border-radius: var(--radius);
        padding: var(--spacing-md);
        margin-top: var(--spacing-lg);
        border: 1px solid var(--color-fresh);
    }

    .delivery-options {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-md);
        margin-top: var(--spacing-md);
    }

    .delivery-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-md);
        border: 2px solid var(--color-border);
        border-radius: var(--radius);
        cursor: pointer;
        transition: var(--transition);
        text-align: center;
        min-height: 100px;
    }

    .delivery-option:hover {
        border-color: var(--color-fresh);
    }

    .delivery-option.selected {
        border-color: var(--color-fresh);
        background-color: rgba(34, 197, 94, 0.1);
    }

    .delivery-option i {
        font-size: var(--text-xl);
        margin-bottom: var(--spacing-xs);
        color: var(--color-fresh);
    }

    .delivery-details {
        margin-top: var(--spacing-md);
        display: none;
    }

    .delivery-details.expanded {
        display: block;
    }

    .bagging-section {
        background-color: var(--color-household-light);
        border-radius: var(--radius);
        padding: var(--spacing-md);
        margin-top: var(--spacing-lg);
        border: 1px solid var(--color-household);
    }

    .bagging-options {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--spacing-md);
        margin-top: var(--spacing-md);
    }

    .bagging-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-md);
        border: 2px solid var(--color-border);
        border-radius: var(--radius);
        cursor: pointer;
        transition: var(--transition);
        text-align: center;
        min-height: 80px;
    }

    .bagging-option:hover {
        border-color: var(--color-household);
    }

    .bagging-option.selected {
        border-color: var(--color-household);
        background-color: rgba(249, 115, 22, 0.1);
    }

    .bagging-option i {
        font-size: var(--text-lg);
        margin-bottom: var(--spacing-xs);
        color: var(--color-household);
    }

    .donation-section {
        background-color: var(--color-frozen-light);
        border-radius: var(--radius);
        padding: var(--spacing-md);
        margin-top: var(--spacing-lg);
        border: 1px solid var(--color-frozen);
    }

    .donation-options {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--spacing-md);
        margin-top: var(--spacing-md);
    }

    .donation-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-md);
        border: 2px solid var(--color-border);
        border-radius: var(--radius);
        cursor: pointer;
        transition: var(--transition);
        text-align: center;
        min-height: 80px;
    }

    .donation-option:hover {
        border-color: var(--color-frozen);
    }

    .donation-option.selected {
        border-color: var(--color-frozen);
        background-color: rgba(59, 130, 246, 0.1);
    }

    .donation-option i {
        font-size: var(--text-lg);
        margin-bottom: var(--spacing-xs);
        color: var(--color-frozen);
    }

    /* NEW LOYALTY PROGRAM FEATURES */
    .loyalty-features-container {
        margin-top: var(--spacing-xl);
        border-top: 1px solid var(--color-border);
        padding-top: var(--spacing-lg);
    }

    .loyalty-features-title {
        font-weight: 600;
        margin-bottom: var(--spacing-md);
        color: var(--color-loyalty-primary);
        text-align: center;
    }

    .loyalty-features-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-md);
    }

    .loyalty-feature-card {
        background: white;
        border-radius: var(--radius);
        padding: var(--spacing-md);
        text-align: center;
        box-shadow: var(--shadow);
        transition: var(--transition);
        border: 1px solid var(--color-border);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 120px;
    }

    .loyalty-feature-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-md);
    }

    .loyalty-feature-card i {
        font-size: var(--text-xl);
        color: var(--color-loyalty-primary);
        margin-bottom: var(--spacing-sm);
    }

    .loyalty-feature-card h4 {
        font-size: var(--text-sm);
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
        color: var(--color-text);
    }

    .loyalty-feature-card p {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
    }

    /* NEW REWARDS SECTION */
    .loyalty-new-rewards {
        margin-top: var(--spacing-xl);
        border-top: 1px solid var(--color-border);
        padding-top: var(--spacing-lg);
    }

    .loyalty-new-rewards-title {
        font-weight: 600;
        margin-bottom: var(--spacing-md);
        color: var(--color-loyalty-primary);
        text-align: center;
    }

    .loyalty-new-rewards-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--spacing-md);
    }

    .loyalty-new-reward-card {
        background: white;
        border-radius: var(--radius);
        padding: var(--spacing-md);
        text-align: center;
        box-shadow: var(--shadow);
        transition: var(--transition);
        border: 1px solid var(--color-border);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 140px;
        position: relative;
    }

    .loyalty-new-reward-card.new {
        border: 2px solid var(--color-success);
    }

    .loyalty-new-reward-card.new::after {
        content: "NEU";
        position: absolute;
        top: -8px;
        right: -8px;
        background-color: var(--color-success);
        color: white;
        font-size: var(--text-xs);
        font-weight: 700;
        padding: 2px 8px;
        border-radius: 10px;
        animation: pulse 2s infinite;
    }

    .loyalty-new-reward-card i {
        font-size: var(--text-xl);
        color: var(--color-loyalty-primary);
        margin-bottom: var(--spacing-sm);
    }

    .loyalty-new-reward-card h4 {
        font-size: var(--text-sm);
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
        color: var(--color-text);
    }

    .loyalty-new-reward-card p {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
    }

    .loyalty-new-reward-card .reward-cost {
        margin-top: var(--spacing-xs);
        font-weight: 700;
        color: var(--color-loyalty-primary);
    }

    /* Animation Keyframes */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes scaleIn {
        from { transform: scale(0.95); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    @keyframes shimmer {
        0% { background-position: -200px 0; }
        100% { background-position: calc(200px + 100%) 0; }
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-10px); }
        60% { transform: translateY(-5px); }
    }

    @keyframes confetti {
        0% { transform: translateY(0) rotate(0); opacity: 1; }
        100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .payment-card {
            padding: var(--spacing-lg);
        }

        #payment-modal .modal-content {
            max-width: 95%;
        }
        
        .payment-title {
            font-size: var(--text-xl);
        }
        
        .amount {
            font-size: var(--text-2xl);
        }
        
        #qrcode {
            padding: var(--spacing-sm);
            margin: var(--spacing-lg) auto;
        }
        
        .status {
            padding: var(--spacing-sm);
            font-size: var(--text-sm);
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .action-btn {
            width: 100%;
        }
        
        .radio-group {
            flex-direction: column;
        }
        
        .receipt-design-options {
            grid-template-columns: 1fr;
        }

        .loyalty-benefits-grid {
            grid-template-columns: 1fr;
        }

        .loyalty-benefits {
            grid-template-columns: 1fr;
        }

        .delivery-options {
            grid-template-columns: 1fr;
        }

        .bagging-options {
            grid-template-columns: repeat(2, 1fr);
        }

        .donation-options {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .step-indicators {
            flex-wrap: wrap;
            gap: var(--spacing-xs);
        }
        
        .step-indicator {
            width: 25px;
            height: 25px;
            font-size: var(--text-xs);
        }

        .loyalty-features-grid {
            grid-template-columns: 1fr;
        }

        .loyalty-new-rewards-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 480px) {
        header {
            padding: 0 var(--spacing-md);
        }
        
        .logo {
            font-size: var(--text-lg);
        }
        
        .payment-card {
            padding: var(--spacing-md);
        }
        
        .payment-title {
            font-size: var(--text-lg);
        }
        
        .payment-subtitle {
            font-size: var(--text-sm);
        }
        
        .amount {
            font-size: var(--text-xl);
            margin: var(--spacing-md) 0;
        }
        
        .countdown-container {
            font-size: var(--text-sm);
        }
        
        .countdown-value {
            font-size: var(--text-base);
        }
        
        #payment-modal .modal-content {
            padding: var(--spacing-lg);
            max-width: 95%;
        }
        
        .step-navigation {
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        
        .step-navigation .modal-btn {
            width: 100%;
        }

        .bagging-options {
            grid-template-columns: 1fr;
        }

        .donation-options {
            grid-template-columns: 1fr;
        }
        
        .step-indicators {
            gap: 4px;
        }
        
        .step-indicator {
            width: 22px;
            height: 22px;
            font-size: 10px;
        }
    }

    .control-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--spacing-xs);
        background: none;
        border: none;
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        color: var(--color-text-muted);
        font-size: var(--text-xs);
        cursor: pointer;
        transition: var(--transition);
        flex: 1;
        min-width: 60px;
    }

    .control-btn:hover {
        background-color: #f9fafb;
        color: var(--color-text);
    }

    .control-btn:focus {
        outline: none;
        box-shadow: var(--focus-ring);
    }

    .control-btn i {
        font-size: var(--text-lg);
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
        :root {
            --color-bg: #111827;
            --color-text: #f3f4f6;
            --color-text-muted: #9ca3af;
            --color-border: #374151;
        }
        
        body {
            background-color: var(--color-bg);
        }
        
        .payment-card {
            background-color: #1f2937;
            border-color: var(--color-border);
        }
        
        .item-box {
            background-color: #374151;
        }
        
        .countdown-value {
            background-color: #374151;
        }
        
        #qrcode {
            background-color: #374151;
        }
        
        .action-btn:hover {
            background-color: #374151;
        }
        
        .coupon-section {
            background-color: #1f2937;
        }
        
        .form-control {
            background-color: #1f2937;
            color: var(--color-text);
            border-color: var(--color-border);
        }
        
        .radio-option {
            background-color: #1f2937;
        }
        
        .payment-details-summary {
            background-color: #1f2937;
        }
        
        .design-option {
            background-color: #1f2937;
            border-color: var(--color-border);
        }
        
        .design-preview {
            background-color: #1f2937;
            border-color: var(--color-border);
        }

        .loyalty-section {
            background-color: #1f2937;
            border-color: var(--color-loyalty-secondary);
        }

        .loyalty-status, 
        .loyalty-option,
        .loyalty-benefit {
            background-color: #374151;
        }

        .delivery-section {
            background-color: #1f2937;
            border-color: var(--color-fresh);
        }

        .bagging-section {
            background-color: #1f2937;
            border-color: var(--color-household);
        }

        .donation-section {
            background-color: #1f2937;
            border-color: var(--color-frozen);
        }
        
        .step-indicator {
            background-color: #374151;
            color: var(--color-text-muted);
        }
        
        .step-indicator.active {
            background-color: var(--color-accent);
            color: white;
        }

        .loyalty-benefit-card {
            background-color: #374151;
            border-color: var(--color-border);
        }

        .loyalty-feature-card {
            background-color: #374151;
            border-color: var(--color-border);
        }

        .loyalty-new-reward-card {
            background-color: #374151;
            border-color: var(--color-border);
        }
    }

    /* Confetti animation for loyalty program celebration */
    .confetti-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1000;
        display: none;
    }

    .confetti {
        position: absolute;
        width: 10px;
        height: 10px;
        background-color: var(--color-loyalty-primary);
        opacity: 0.7;
        animation: confetti 5s ease-in-out forwards;
    }

    .confetti:nth-child(2n) {
        background-color: var(--color-loyalty-secondary);
    }

    .confetti:nth-child(3n) {
        background-color: var(--color-gold);
    }

    .confetti:nth-child(4n) {
        background-color: var(--color-premium);
    }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <i class="fas fa-shopping-cart"></i>
            <span>Gittertier Pro</span>
        </div>
        <div class="header-controls">
            <button class="control-btn" id="edit-details-btn" style="display: none;">
                <i class="fas fa-edit"></i>
                <span>Bearbeiten</span>
            </button>
            <button class="control-btn" onclick="window.location.href='index'">
                <i class="fas fa-arrow-left"></i>
                <span>Zurück</span>
            </button>
        </div>
    </header>

    <main>
        <div class="payment-card">
            <div class="payment-header">
                <h1 class="payment-title">Bezahlung</h1>
                <p class="payment-subtitle">Scannen Sie den QR-Code zur Zahlung</p>
            </div>
            
            <div class="amount" id="amount">€0.00</div>
            
            <div id="payment-details-summary" class="payment-details-summary" style="display: none;">
                <div class="payment-details-row">
                    <span class="payment-details-label">Name:</span>
                    <span class="payment-details-value" id="summary-name"></span>
                </div>
                <div class="payment-details-row">
                    <span class="payment-details-label">Zahlungsart:</span>
                    <span class="payment-details-value" id="summary-method"></span>
                </div>
                <div class="payment-details-row">
                    <span class="payment-details-label">Gutschein:</span>
                    <span class="payment-details-value" id="summary-coupon"></span>
                </div>
                <div class="payment-details-row">
                    <span class="payment-details-label">Treuepunkte:</span>
                    <span class="payment-details-value" id="summary-loyalty"></span>
                </div>
                <div class="payment-details-row">
                    <span class="payment-details-label">Belegdesign:</span>
                    <span class="payment-details-value" id="summary-receipt"></span>
                </div>
                <div class="payment-details-row">
                    <span class="payment-details-label">Lieferoption:</span>
                    <span class="payment-details-value" id="summary-delivery"></span>
                </div>
                <div class="payment-details-row">
                    <span class="payment-details-label">Verpackung:</span>
                    <span class="payment-details-value" id="summary-bagging"></span>
                </div>
                <div class="payment-details-row">
                    <span class="payment-details-label">Spende:</span>
                    <span class="payment-details-value" id="summary-donation"></span>
                </div>
            </div>
            
            <div id="items-list" class="items-list"></div>
            
            <div id="qrcode"></div>
            
            <div class="countdown-container">
                QR-Code gültig für: 
                <span id="countdown-value" class="countdown-value">60</span>
                Sekunden
            </div>
            
            <div id="status" class="status pending">
                <i class="fas fa-clock"></i>
                <span>Zahlung ausstehend</span>
            </div>
            
            <div class="action-buttons">
                <!-- <button class="action-btn cancel-btn" onclick="cancelPayment()">
                    <i class="fas fa-times"></i>
                    Abbrechen
                </button>
                <button class="action-btn confirm-btn" onclick="confirmPayment()">
                    <i class="fas fa-check"></i>
                    Manuell bestätigen
                </button> -->
            </div>
        </div>
    </main>

    <!-- Payment Modal - Redesigned -->
    <div id="payment-modal" class="modal">
        <div class="modal-content">
            <div class="payment-modal-header">
                <h2 class="payment-modal-title">Zahlungsdetails</h2>
                <button class="payment-modal-close" onclick="closeModal('payment-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Step indicators - Redesigned -->
            <div class="step-indicators">
                <div class="step-indicator active" data-step="1"></div>
                <div class="step-indicator" data-step="2"></div>
                <div class="step-indicator" data-step="3"></div>
                <div class="step-indicator" data-step="4"></div>
                <div class="step-indicator" data-step="5"></div>
                <div class="step-indicator" data-step="6"></div>
                <div class="step-indicator" data-step="7"></div>
                <div class="step-indicator" data-step="8"></div>
                <div class="step-indicator" data-step="9"></div>
            </div>
            
            <!-- Step 1: Customer Name -->
            <div class="step active" id="step-1">
                <div class="form-group">
                    <label for="customer-name">Ihr Name</label>
                    <input type="text" id="customer-name" class="form-control" placeholder="Vor- und Nachname" autocomplete="name">
                </div>
                
                <div class="step-navigation">
                    <button class="modal-btn secondary" id="step1-cancel-btn">
                        Abbrechen
                    </button>
                    <button class="modal-btn primary" onclick="showStep(2)">
                        Weiter
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 2: Payment Method -->
            <div class="step" id="step-2">
                <div class="form-group">
                    <label>Zahlungsmethode</label>
                    <div class="radio-group">
                        <div class="radio-option" data-value="cash" onclick="selectPaymentMethod('cash')">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>Bar</span>
                        </div>
                        <div class="radio-option" data-value="card" onclick="selectPaymentMethod('card')">
                            <i class="fas fa-credit-card"></i>
                            <span>Karte</span>
                        </div>
                    </div>
                </div>
                
                <div class="step-navigation">
                    <button class="modal-btn secondary" onclick="showStep(1)">
                        <i class="fas fa-arrow-left"></i>
                        Zurück
                    </button>
                    <button class="modal-btn primary" onclick="showStep(3)">
                        Weiter
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 3: Coupon - Updated to always show content -->
            <div class="step" id="step-3">
                <div class="coupon-section">
                    <div class="coupon-header">
                        <span class="coupon-title">Gutschein anwenden</span>
                    </div>
                    
                    <div class="coupon-content" id="coupon-content">
                        <div class="coupon-input-group">
                            <input type="text" id="coupon-code" class="form-control coupon-input" placeholder="Gutscheincode eingeben">
                        </div>
                        <div class="coupon-apply-btn-container">
                            <button class="action-btn apply-coupon-btn" onclick="applyCoupon()">
                                Anwenden
                            </button>
                        </div>
                        <div id="coupon-result" class="coupon-result"></div>
                    </div>
                </div>
                
                <div class="step-navigation">
                    <button class="modal-btn secondary" onclick="showStep(2)">
                        <i class="fas fa-arrow-left"></i>
                        Zurück
                    </button>
                    <button class="modal-btn primary" onclick="showStep(4)">
                        Weiter
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 4: Loyalty Program - COMPLETELY REDESIGNED -->
            <div class="step" id="step-4">
                <div id="loyalty-intro-container" class="loyalty-intro-container">
                    <div class="loyalty-program-name">Gittertier Premium Club</div>
                    <div class="loyalty-intro-icon">
                        <i class="fas fa-crown"></i>
                    </div>
                    <p>Werden Sie Teil unseres exklusiven Premium Clubs und genießen Sie besondere Vorteile, Rabatte und Belohnungen!</p>
                    
                    <div class="loyalty-benefits-grid">
                        <div class="loyalty-benefit-card">
                            <i class="fas fa-gift"></i>
                            <h4>Willkommensgeschenk</h4>
                            <p>Bei Ihrer ersten Anmeldung</p>
                        </div>
                        <div class="loyalty-benefit-card">
                            <i class="fas fa-percentage"></i>
                            <h4>Exklusive Rabatte</h4>
                            <p>Bis zu 20% auf alle Einkäufe</p>
                        </div>
                        <div class="loyalty-benefit-card">
                            <i class="fas fa-star"></i>
                            <h4>Premium-Belege</h4>
                            <p>Exklusive Designs nur für Mitglieder</p>
                        </div>
                        <div class="loyalty-benefit-card">
                            <i class="fas fa-bolt"></i>
                            <h4>Schnellerer Checkout</h4>
                            <p>Bezahlen Sie in Sekunden</p>
                        </div>
                    </div>
                    
                    <div class="loyalty-join-toggle">
                        <span class="toggle-label">Am Premium Club teilnehmen</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="loyalty-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <button id="loyalty-join-btn" class="loyalty-join-btn" onclick="joinLoyaltyProgram()" disabled>
                        Dem Club beitreten
                    </button>
                    
                    <button id="loyalty-skip-btn" class="modal-btn secondary" onclick="skipLoyaltyProgram()" style="margin-top: var(--spacing-md);">
                        Überspringen
                    </button>
                </div>
                
                <div id="loyalty-options-container" class="loyalty-content" style="display: none;">
                    <div class="loyalty-status">
                        <div class="loyalty-points" id="loyalty-points">0 Punkte</div>
                        <div class="loyalty-tier" id="loyalty-tier">
                            <span class="tier-badge tier-bronze">Bronze</span>
                        </div>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Fortschritt zum nächsten Level</span>
                            <span id="progress-text">0/200</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="loyalty-options" id="loyalty-options">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    
                    <div id="loyalty-result" class="loyalty-result"></div>
                    
                    <div class="points-earned" id="points-earned" style="display: none;">
                        Sie erhalten <span id="points-to-earn">0</span> Punkte für diesen Einkauf!
                    </div>

                    <!-- NEW: Loyalty Program Features -->
                    <div class="loyalty-features-container">
                        <h3 class="loyalty-features-title">Exklusive Premium-Features</h3>
                        <div class="loyalty-features-grid">
                            <div class="loyalty-feature-card">
                                <i class="fas fa-calendar-alt"></i>
                                <h4>Persönlicher Einkaufsplaner</h4>
                                <p>Planen Sie Ihre Einkäufe und erhalten Sie personalisierte Empfehlungen</p>
                            </div>
                            <div class="loyalty-feature-card">
                                <i class="fas fa-utensils"></i>
                                <h4>Rezeptvorschläge</h4>
                                <p>Passende Rezepte basierend auf Ihren Einkäufen</p>
                            </div>
                            <div class="loyalty-feature-card">
                                <i class="fas fa-leaf"></i>
                                <h4>Nachhaltigkeits-Tracker</h4>
                                <p>Verfolgen Sie Ihren ökologischen Fußabdruck</p>
                            </div>
                            <div class="loyalty-feature-card">
                                <i class="fas fa-heart"></i>
                                <h4>Gesundheitsprofil</h4>
                                <p>Personalisiert nach Ihren Ernährungspräferenzen</p>
                            </div>
                            <div class="loyalty-feature-card">
                                <i class="fas fa-award"></i>
                                <h4>Exklusive Events</h4>
                                <p>Zugang zu Verkostungen und Sonderveranstaltungen</p>
                            </div>
                        </div>
                    </div>

                    <!-- NEW: Additional Rewards -->
                    <div class="loyalty-new-rewards">
                        <h3 class="loyalty-new-rewards-title">Neue Belohnungen</h3>
                        <div class="loyalty-new-rewards-grid">
                            <div class="loyalty-new-reward-card new">
                                <i class="fas fa-truck"></i>
                                <h4>Kostenlose Lieferung</h4>
                                <p>Einmalige gratis Lieferung</p>
                                <div class="reward-cost">300 Punkte</div>
                            </div>
                            <div class="loyalty-new-reward-card new">
                                <i class="fas fa-wine-bottle"></i>
                                <h4>Premium-Produkt</h4>
                                <p>Exklusives Produkt Ihrer Wahl</p>
                                <div class="reward-cost">500 Punkte</div>
                            </div>
                            <div class="loyalty-new-reward-card new">
                                <i class="fas fa-hand-holding-usd"></i>
                                <h4>Spenden-Verdopplung</h4>
                                <p>Wir verdoppeln Ihre nächste Spende</p>
                                <div class="reward-cost">200 Punkte</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="loyalty-rewards">
                        <div class="loyalty-rewards-title">Ihre Vorteile</div>
                        <div class="loyalty-benefits" id="loyalty-benefits">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="step-navigation">
                        <button class="modal-btn secondary" onclick="showStep(3)">
                            <i class="fas fa-arrow-left"></i>
                            Zurück
                        </button>
                        <button class="modal-btn primary" onclick="showStep(5)">
                            Weiter
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Step 5: Receipt Design -->
            <div class="step" id="step-5">
                <div class="form-group">
                    <label>Belegdesign auswählen</label>
                    <p class="payment-subtitle" style="text-align: center; margin-bottom: var(--spacing-md);">
                        Wählen Sie das Design für Ihren Beleg
                    </p>
                    
                    <div class="receipt-design-options">
                        <div class="design-option" data-design="simple" onclick="selectReceiptDesign('simple')">
                            <i class="fas fa-file-alt"></i>
                            <span>Einfach</span>
                        </div>
                        <div class="design-option" data-design="compact" onclick="selectReceiptDesign('compact')">
                            <i class="fas fa-receipt"></i>
                            <span>Kompakt</span>
                        </div>
                        <div class="design-option" data-design="detailed" onclick="selectReceiptDesign('detailed')">
                            <i class="fas fa-file-invoice"></i>
                            <span>Detailliert</span>
                        </div>
                        <div class="design-option premium" data-design="premium" onclick="selectReceiptDesign('premium')">
                            <div class="premium-badge">PREMIUM</div>
                            <i class="fas fa-crown"></i>
                            <span>Premium</span>
                        </div>
                        <div class="design-option premium" data-design="gold" onclick="selectReceiptDesign('gold')" id="gold-receipt-option" style="display: none;">
                            <div class="premium-badge">GOLD</div>
                            <i class="fas fa-medal"></i>
                            <span>Gold</span>
                        </div>
                        <div class="design-option premium" data-design="platinum" onclick="selectReceiptDesign('platinum')" id="platinum-receipt-option" style="display: none;">
                            <div class="premium-badge">PLATINUM</div>
                            <i class="fas fa-gem"></i>
                            <span>Platinum</span>
                        </div>
                    </div>
                    
                    <div id="design-preview-simple" class="design-preview">
                        <h4>Einfaches Design</h4>
                        <p>Klassischer Beleg mit den wichtigsten Informationen.</p>
                    </div>
                    
                    <div id="design-preview-compact" class="design-preview">
                        <h4>Kompaktes Design</h4>
                        <p>Übersichtliche Darstellung aller Artikel.</p>
                    </div>
                    
                    <div id="design-preview-detailed" class="design-preview">
                        <h4>Detailliertes Design</h4>
                        <p>Ausführlicher Beleg mit allen Details.</p>
                    </div>
                    
                    <div id="design-preview-premium" class="design-preview premium-preview">
                        <div class="preview-header">
                            <h3>GITTERTIER PRO</h3>
                            <p>Premium Beleg</p>
                        </div>
                        <div class="preview-item">
                            <span>Artikel 1</span>
                            <span>€ 10,00</span>
                        </div>
                        <div class="preview-item">
                            <span>Artikel 2</span>
                            <span>€ 15,00</span>
                        </div>
                        <div class="preview-total">
                            <span>Gesamtsumme</span>
                            <span>€ 25,00</span>
                        </div>
                    </div>

                    <div id="design-preview-gold" class="design-preview premium-preview" style="background: linear-gradient(135deg, #f4e8c6 0%, #ffffff 100%); border-color: #ffd700; color: #5a4a3a; font-family: 'Georgia', serif;">
                        <div class="preview-header" style="border-bottom: 2px solid #ffd700;">
                            <h3 style="color: #8b7500;">GITTERTIER GOLD</h3>
                            <p style="color: #8b7500;">Exklusiv für Gold-Mitglieder</p>
                        </div>
                        <div class="preview-item">
                            <span>Artikel 1</span>
                            <span>€ 10,00</span>
                        </div>
                        <div class="preview-item">
                            <span>Artikel 2</span>
                            <span>€ 15,00</span>
                        </div>
                        <div class="preview-total" style="border-top: 2px solid #ffd700;">
                            <span>Gesamtsumme</span>
                            <span>€ 25,00</span>
                        </div>
                    </div>

                    <div id="design-preview-platinum" class="design-preview premium-preview" style="background: linear-gradient(135deg, #e5e4e2 0%, #ffffff 100%); border-color: #b9f2ff; color: #2f4f4f; font-family: 'Georgia', serif;">
                        <div class="preview-header" style="border-bottom: 2px solid #b9f2ff;">
                            <h3 style="color: #0066a6;">GITTERTIER PLATINUM</h3>
                            <p style="color: #0066a6;">Exklusiv für Platinum-Mitglieder</p>
                        </div>
                        <div class="preview-item">
                            <span>Artikel 1</span>
                            <span>€ 10,00</span>
                        </div>
                        <div class="preview-item">
                            <span>Artikel 2</span>
                            <span>€ 15,00</span>
                        </div>
                        <div class="preview-total" style="border-top: 2px solid #b9f2ff;">
                            <span>Gesamtsumme</span>
                            <span>€ 25,00</span>
                        </div>
                    </div>
                </div>
                
                <div class="step-navigation">
                    <button class="modal-btn secondary" onclick="showStep(4)">
                        <i class="fas fa-arrow-left"></i>
                        Zurück
                    </button>
                    <button class="modal-btn primary" onclick="showStep(6)">
                        Weiter
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 6: Delivery Option -->
            <div class="step" id="step-6">
                <div class="delivery-section">
                    <div class="form-group">
                        <label>Lieferoption auswählen</label>
                        <p class="payment-subtitle" style="text-align: center; margin-bottom: var(--spacing-md);">
                            Wie möchten Sie Ihre Einkäufe erhalten?
                        </p>
                        
                        <div class="delivery-options">
                            <div class="delivery-option" data-delivery="store-pickup" onclick="selectDeliveryOption('store-pickup')">
                                <i class="fas fa-store"></i>
                                <span>Abholung im Geschäft</span>
                                <small>Kostenlos</small>
                            </div>
                            <div class="delivery-option" data-delivery="home-delivery" onclick="selectDeliveryOption('home-delivery')">
                                <i class="fas fa-truck"></i>
                                <span>Lieferung nach Hause</span>
                                <small>€ 4,99</small>
                            </div>
                        </div>
                        
                        <div class="delivery-details" id="delivery-details">
                            <div class="form-group" id="delivery-address-group" style="display: none;">
                                <label for="delivery-address">Lieferadresse</label>
                                <textarea id="delivery-address" class="form-control" placeholder="Straße, Hausnummer, PLZ, Ort" rows="3"></textarea>
                            </div>
                            <div class="form-group" id="delivery-time-group" style="display: none;">
                                <label for="delivery-time">Bevorzugte Lieferzeit</label>
                                <select id="delivery-time" class="form-control">
                                    <option value="">Bitte wählen</option>
                                    <option value="morning">Vormittag (8-12 Uhr)</option>
                                    <option value="afternoon">Nachmittag (12-17 Uhr)</option>
                                    <option value="evening">Abend (17-20 Uhr)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="step-navigation">
                    <button class="modal-btn secondary" onclick="showStep(5)">
                        <i class="fas fa-arrow-left"></i>
                        Zurück
                    </button>
                    <button class="modal-btn primary" onclick="showStep(7)">
                        Weiter
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 7: Bagging Option -->
            <div class="step" id="step-7">
                <div class="bagging-section">
                    <div class="form-group">
                        <label>Verpackungsoption auswählen</label>
                        <p class="payment-subtitle" style="text-align: center; margin-bottom: var(--spacing-md);">
                            Wie möchten Sie Ihre Einkäufe verpackt haben?
                        </p>
                        
                        <div class="bagging-options">
                            <div class="bagging-option" data-bagging="standard" onclick="selectBaggingOption('standard')">
                                <i class="fas fa-shopping-bag"></i>
                                <span>Standard Tüten</span>
                                <small>€ 0,20 pro Stück</small>
                            </div>
                            <div class="bagging-option" data-bagging="premium" onclick="selectBaggingOption('premium')">
                                <i class="fas fa-gift"></i>
                                <span>Premium Verpackung</span>
                                <small>€ 1,50</small>
                            </div>
                            <div class="bagging-option" data-bagging="own" onclick="selectBaggingOption('own')">
                                <i class="fas fa-shopping-basket"></i>
                                <span>Eigene Tasche</span>
                                <small>Kostenlos</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="step-navigation">
                    <button class="modal-btn secondary" onclick="showStep(6)">
                        <i class="fas fa-arrow-left"></i>
                        Zurück
                    </button>
                    <button class="modal-btn primary" onclick="showStep(8)">
                        Weiter
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 8: Donation Option -->
            <div class="step" id="step-8">
                <div class="donation-section">
                    <div class="form-group">
                        <label>Möchten Sie spenden?</label>
                        <p class="payment-subtitle" style="text-align: center; margin-bottom: var(--spacing-md);">
                            Unterstützen Sie lokale gemeinnützige Organisationen
                        </p>
                        
                        <div class="donation-options">
                            <div class="donation-option" data-donation="none" onclick="selectDonationOption('none')">
                                <i class="fas fa-times-circle"></i>
                                <span>Nein, danke</span>
                            </div>
                            <div class="donation-option" data-donation="1" onclick="selectDonationOption('1')">
                                <i class="fas fa-euro-sign"></i>
                                <span>€ 1,00 spenden</span>
                                <small>Lebensmittelbank</small>
                            </div>
                            <div class="donation-option" data-donation="2" onclick="selectDonationOption('2')">
                                <i class="fas fa-euro-sign"></i>
                                <span>€ 2,00 spenden</span>
                                <small>Tafel</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="step-navigation">
                    <button class="modal-btn secondary" onclick="showStep(7)">
                        <i class="fas fa-arrow-left"></i>
                        Zurück
                    </button>
                    <button class="modal-btn primary" onclick="showStep(9)">
                        Weiter
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 9: Summary -->
            <div class="step" id="step-9">
                <div class="form-group">
                    <h3>Zusammenfassung</h3>
                    <div id="payment-summary">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="remember-choice">
                    <input type="checkbox" id="remember-choice" checked>
                    <label for="remember-choice">Meine Auswahl merken</label>
                </div>
                
                <div class="step-navigation">
                    <button class="modal-btn secondary" onclick="showStep(8)">
                        <i class="fas fa-arrow-left"></i>
                        Zurück
                    </button>
                    <button class="modal-btn primary" onclick="processPayment()">
                        <i class="fas fa-check"></i>
                        Bezahlung bestätigen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="modal">
        <div class="modal-content">
            <div class="modal-icon" style="color: var(--color-error);">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <h2 class="modal-title">Fehler</h2>
            <p class="modal-message" id="error-message">Die Zahlungsinformationen konnten nicht geladen werden.</p>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeModal('error-modal')">Schließen</button>
                <button class="modal-btn primary" onclick="window.location.href='index'">Zur Startseite</button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="modal">
        <div class="modal-content">
            <div class="modal-icon" style="color: var(--color-success);">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2 class="modal-title">Bezahlung erfolgreich</h2>
            <p class="modal-message">Ihre Zahlung wurde erfolgreicht verarbeitet.</p>
            <div class="modal-actions">
                <button class="modal-btn primary" onclick="generateReceipt()">
                    <i class="fas fa-receipt"></i>
                    Beleg drucken
                </button>
                <button class="modal-btn secondary" onclick="window.location.href='index'">
                    <i class="fas fa-home"></i>
                    Zur Startseite
                </button>
            </div>
        </div>
    </div>

    <!-- Connecting Modal (Yellow) -->
    <div id="connecting-modal" class="modal">
        <div class="modal-content">
            <div class="modal-icon" style="color: var(--color-warning);">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
            <h2 class="modal-title">Verbindung hergestellt</h2>
            <p class="modal-message">Warten auf Bestätigung vom Händler...</p>
            <div class="modal-actions">
                <!-- <button class="modal-btn secondary" onclick="closeModal('connecting-modal')">Schließen</button>-->
            </div>
        </div>
    </div>

    <!-- QR Generation Modal -->
    <div id="qr-generation-modal" class="modal">
        <div class="modal-content">
            <div class="modal-icon" style="color: var(--color-accent);">
                <i class="fas fa-qrcode fa-spin"></i>
            </div>
            <h2 class modal-title">QR-Code wird erstellt</h2>
            <p class="modal-message">Bitte warten Sie, während wir Ihren QR-Code für die Zahlung generieren.</p>
        </div>
    </div>

    <!-- Confetti container for celebrations -->
    <div id="confetti-container" class="confetti-container"></div>

<script>
    // Initialize jsPDF
    const { jsPDF } = window.jspdf;
    
    let paymentId = 'PAY-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
    let paymentData = null;
    let countdownInterval = null;
    let countdownTime = 60; // seconds
    let customerPeer = null;
    let merchantConnection = null;
    let selectedPaymentMethod = null;
    let appliedCoupon = null;
    let selectedReceiptDesign = 'compact'; // Default receipt design
    let coupons = [];
    let userPreferences = null;
    let currentStep = 1;
    let infoModalOpenedManually = false;
    let qrGenerationAttempts = 0;
    const MAX_QR_ATTEMPTS = 10;
    
    // New supermarket options
    let selectedDeliveryOption = 'store-pickup';
    let selectedBaggingOption = 'standard';
    let selectedDonationOption = 'none';
    let deliveryAddress = '';
    let deliveryTime = '';
    
    // Loyalty Program Variables
    let loyaltyPoints = 0;
    let loyaltyTier = 'bronze';
    let loyaltyDiscount = 0;
    let loyaltyPointsToRedeem = 0;
    let loyaltyPointsEarned = 0;
    let isLoyaltyMember = false;
    
    // Loyalty Program Configuration - COMPLETELY REDESIGNED
    const LOYALTY_CONFIG = {
        programName: "Gittertier Premium Club",
        pointsPerEuro: 1, // 1 point per 1€ spent
        tiers: {
            bronze: { minPoints: 0, discount: 0, benefits: ['Willkommensgeschenk', '5% Rabatt auf ausgewählte Artikel'] },
            silver: { minPoints: 500, discount: 5, benefits: ['5% Rabatt auf alle Einkäufe', 'Exklusive Angebote', 'Premium Belegdesign'] },
            gold: { minPoints: 1500, discount: 10, benefits: ['10% Rabatt auf alle Einkäufe', 'Kostenlose Produktproben', 'Prioritärer Support', 'Gold Belegdesign'] },
            platinum: { minPoints: 3000, discount: 15, benefits: ['15% Rabatt auf alle Einkäufe', 'Früher Zugang zu neuen Produkten', 'Persönlicher Shopping-Assistent', 'Platinum Belegdesign'] },
            diamond: { minPoints: 5000, discount: 20, benefits: ['20% Rabatt auf alle Einkäufe', 'Kostenlose Lieferung', 'VIP-Events', 'Persönlicher Einkaufsberater'] }
        },
        redemptionOptions: [
            { points: 100, discount: 3, title: '3€ Rabatt', description: 'Einlösbar ab 100 Punkten', available: true },
            { points: 200, discount: 5, title: '5€ Rabatt', description: 'Einlösbar ab 200 Punkten', available: true },
            { points: 500, discount: 12, title: '12€ Rabatt', description: 'Einlösbar ab 500 Punkten', available: true },
            { points: 1000, discount: 25, title: '25€ Rabatt', description: 'Einlösbar ab 1000 Punkten', available: true },
            { points: 1500, discount: 40, title: '40€ Rabatt', description: 'Einlösbar ab 1500 Punkten', available: true }
        ],
        specialOffers: [
            { id: 'welcome', points: 0, discount: 10, title: 'Willkommensrabatt', description: '10% Rabatt auf Ihren ersten Einkauf', oneTime: true, available: false },
            { id: 'weekend', points: 0, discount: 5, title: 'Wochenend-Special', description: '5% Rabatt am Samstag', oneTime: false, available: isWeekend() },
            { id: 'birthday', points: 0, discount: 20, title: 'Geburtstagsrabatt', description: '20% Rabatt im Geburtsmonat', oneTime: true, available: false }
        ]
    };
    
    // Check if it's weekend for special offers
    function isWeekend() {
        const today = new Date();
        return today.getDay() === 6 || today.getDay() === 0; // 6 = Saturday, 0 = Sunday
    }
    
    // Initialize payment
    function initPayment() {
        try {
            // Check if we have payment data in localStorage (within 10 minutes)
            const storedPaymentData = localStorage.getItem('gittertier_payment_data');
            const storedPaymentTime = localStorage.getItem('gittertier_payment_time');
            
            if (storedPaymentData && storedPaymentTime) {
                const currentTime = Date.now();
                const storedTime = parseInt(storedPaymentTime, 10);
                
                // Check if data is not older than 10 minutes (600000 milliseconds)
                if (currentTime - storedTime < 600000) {
                    paymentData = JSON.parse(storedPaymentData);
                    console.log('Loaded payment data from localStorage');
                    
                    // Load user preferences
                    loadUserPreferences();
                    
                    // Display payment data immediately
                    displayOriginalItems();
                    
                    // Load coupons
                    loadCoupons();
                    
                    // Initialize PeerJS
                    initializePeerJS();
                    
                    // Check if we have saved preferences
                    if (!userPreferences || !userPreferences.rememberChoice || !userPreferences.customerName || !userPreferences.paymentMethod) {
                        // Show modal automatically
                        infoModalOpenedManually = false;
                        showModal('payment-modal');
                        // Hide the back button on first step if modal opened automatically
                        document.getElementById('step1-cancel-btn').style.display = 'none';
                    } else {
                        // Use saved preferences
                        selectedReceiptDesign = userPreferences.receiptDesign || 'compact';
                        selectedDeliveryOption = userPreferences.deliveryOption || 'store-pickup';
                        selectedBaggingOption = userPreferences.baggingOption || 'standard';
                        selectedDonationOption = userPreferences.donationOption || 'none';
                        isLoyaltyMember = userPreferences.isLoyaltyMember || false;
                        processPaymentWithSavedPreferences();
                    }
                    
                    return;
                } else {
                    // Data is too old, remove it
                    localStorage.removeItem('gittertier_payment_data');
                    localStorage.removeItem('gittertier_payment_time');
                }
            }
            
            // If no valid data in localStorage, check URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const compressedData = urlParams.get('id');
            
            if (!compressedData) {
                throw new Error('Keine Zahlungsdaten gefunden');
            }
            
            const jsonString = LZString.decompressFromBase64(compressedData);
            
            if (!jsonString) {
                throw new Error('Daten-Dekompression fehlgeschlagen');
            }
            
            paymentData = JSON.parse(jsonString);
            
            if (!paymentData?.items || !paymentData?.total) {
                throw new Error('Ungültige Datenstruktur');
            }
            
            // Store payment data in localStorage with timestamp
            localStorage.setItem('gittertier_payment_data', JSON.stringify(paymentData));
            localStorage.setItem('gittertier_payment_time', Date.now().toString());
            
            // Remove the data from URL to hide it
            const urlWithoutParams = window.location.origin + window.location.pathname;
            window.history.replaceState({}, document.title, urlWithoutParams);
            
            // Load user preferences
            loadUserPreferences();
            
            // Display payment data immediately
            displayOriginalItems();
            
            // Load coupons
            loadCoupons();
            
            // Initialize PeerJS
            initializePeerJS();
            
            // Check if we have saved preferences
            if (!userPreferences || !userPreferences.rememberChoice || !userPreferences.customerName || !userPreferences.paymentMethod) {
                // Show modal automatically
                infoModalOpenedManually = false;
                showModal('payment-modal');
                // Hide the back button on first step if modal opened automatically
                document.getElementById('step1-cancel-btn').style.display = 'none';
            } else {
                // Use saved preferences
                selectedReceiptDesign = userPreferences.receiptDesign || 'compact';
                selectedDeliveryOption = userPreferences.deliveryOption || 'store-pickup';
                selectedBaggingOption = userPreferences.baggingOption || 'standard';
                selectedDonationOption = userPreferences.donationOption || 'none';
                isLoyaltyMember = userPreferences.isLoyaltyMember || false;
                processPaymentWithSavedPreferences();
            }
            
        } catch(error) {
            console.error('Payment initialization error:', error);
            document.getElementById('error-message').textContent = error.message;
            showModal('error-modal');
        }
    }
    
    // Display original items only
    function displayOriginalItems() {
        const itemsList = document.getElementById('items-list');
        itemsList.innerHTML = '';
        
        paymentData.items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'item-box';
            div.innerHTML = `
                <h3>${item.name}</h3>
                <p>${item.quantity}x € ${item.price.toFixed(2)}</p>
                <p>Summe: € ${(item.quantity * item.price).toFixed(2)}</p>
            `;
            itemsList.appendChild(div);
        });
    }
    
    // Display additional items (coupons, delivery, etc.)
    function displayAdditionalItems() {
        const itemsList = document.getElementById('items-list');
        
        // Clear any previously added additional items
        const additionalItems = itemsList.querySelectorAll('.additional-item');
        additionalItems.forEach(item => item.remove());
        
        // Add coupon discount if applied
        if (appliedCoupon) {
            const discountDiv = document.createElement('div');
            discountDiv.className = 'item-box additional-item';
            let discountText = '';
            
            if (appliedCoupon.type === 'percent') {
                discountText = `Rabatt (${appliedCoupon.code}): -${appliedCoupon.discount}%`;
            } else {
                discountText = `Rabatt (${appliedCoupon.code}): -€ ${appliedCoupon.discount.toFixed(2)}`;
            }
            
            discountDiv.innerHTML = `<h3 class="discount">${discountText}</h3>`;
            itemsList.appendChild(discountDiv);
        }
        
        // Add loyalty discount if applied
        if (loyaltyDiscount > 0) {
            const loyaltyDiv = document.createElement('div');
            loyaltyDiv.className = 'item-box additional-item';
            loyaltyDiv.innerHTML = `<h3 class="discount">Treuepunkte-Rabatt: -€ ${loyaltyDiscount.toFixed(2)}</h3>`;
            itemsList.appendChild(loyaltyDiv);
        }
        
        // Add delivery cost if applicable
        if (selectedDeliveryOption === 'home-delivery') {
            const deliveryDiv = document.createElement('div');
            deliveryDiv.className = 'item-box additional-item';
            deliveryDiv.innerHTML = `<h3>Lieferung nach Hause: +€ 4,99</h3>`;
            itemsList.appendChild(deliveryDiv);
        }
        
        // Add bagging cost if applicable
        if (selectedBaggingOption === 'standard') {
            const baggingDiv = document.createElement('div');
            baggingDiv.className = 'item-box additional-item';
            baggingDiv.innerHTML = `<h3>Standard Tüten (2x): +€ 0,40</h3>`;
            itemsList.appendChild(baggingDiv);
        } else if (selectedBaggingOption === 'premium') {
            const baggingDiv = document.createElement('div');
            baggingDiv.className = 'item-box additional-item';
            baggingDiv.innerHTML = `<h3>Premium Verpackung: +€ 1,50</h3>`;
            itemsList.appendChild(baggingDiv);
        }
        
        // Add donation if applicable
        if (selectedDonationOption !== 'none') {
            const donationDiv = document.createElement('div');
            donationDiv.className = 'item-box additional-item';
            donationDiv.innerHTML = `<h3>Spende: +€ ${parseFloat(selectedDonationOption).toFixed(2)}</h3>`;
            itemsList.appendChild(donationDiv);
        }
    }
    
    // Load user preferences from localStorage
    function loadUserPreferences() {
        try {
            const preferences = localStorage.getItem('gittertier_payment_preferences');
            if (preferences) {
                userPreferences = JSON.parse(preferences);
                
                // Load loyalty data if available
                if (userPreferences.loyaltyPoints !== undefined) {
                    loyaltyPoints = userPreferences.loyaltyPoints;
                    updateLoyaltyTier();
                }
                
                if (userPreferences.isLoyaltyMember !== undefined) {
                    isLoyaltyMember = userPreferences.isLoyaltyMember;
                }
                
                // Load new supermarket options if available
                if (userPreferences.deliveryOption) {
                    selectedDeliveryOption = userPreferences.deliveryOption;
                }
                if (userPreferences.baggingOption) {
                    selectedBaggingOption = userPreferences.baggingOption;
                }
                if (userPreferences.donationOption) {
                    selectedDonationOption = userPreferences.donationOption;
                }
            }
        } catch (e) {
            console.error('Error loading user preferences:', e);
            userPreferences = null;
        }
    }
    
    // Save user preferences to localStorage
    function saveUserPreferences() {
        try {
            const rememberChoice = document.getElementById('remember-choice').checked;
            
            if (rememberChoice) {
                userPreferences = {
                    rememberChoice: true,
                    customerName: document.getElementById('customer-name').value,
                    paymentMethod: selectedPaymentMethod,
                    couponCode: appliedCoupon ? appliedCoupon.code : null,
                    receiptDesign: selectedReceiptDesign,
                    loyaltyPoints: loyaltyPoints,
                    isLoyaltyMember: isLoyaltyMember,
                    deliveryOption: selectedDeliveryOption,
                    baggingOption: selectedBaggingOption,
                    donationOption: selectedDonationOption
                };
                
                localStorage.setItem('gittertier_payment_preferences', JSON.stringify(userPreferences));
            } else {
                // Clear preferences if not remembering
                localStorage.removeItem('gittertier_payment_preferences');
                userPreferences = null;
            }
        } catch (e) {
            console.error('Error saving user preferences:', e);
        }
    }
    
    // Load coupons from GitHub
    function loadCoupons() {
        fetch('https://raw.githubusercontent.com/Kleiner-Nobody/gittertier/main/coupons.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Coupons konnten nicht geladen werden');
                }
                return response.json();
            })
            .then(data => {
                coupons = data;
                console.log('Coupons erfolgreich geladen:', coupons);
                
                // If we have saved coupon, try to apply it
                if (userPreferences && userPreferences.couponCode) {
                    appliedCoupon = coupons.find(c => c.code === userPreferences.couponCode);
                    if (appliedCoupon) {
                        updatePaymentSummary();
                    }
                }
            })
            .catch(error => {
                console.error('Fehler beim Laden der Coupons:', error);
                // Don't use fallback coupons - only fetch from JSON
            });
    }
    
    // Process payment with saved preferences (without showing modal)
    function processPaymentWithSavedPreferences() {
        if (!userPreferences) return;
        
        // Calculate final total with coupon and loyalty discount
        let finalTotal = calculateFinalTotal();
        
        // Update payment data with final total
        paymentData.finalTotal = finalTotal;
        paymentData.customerName = userPreferences.customerName;
        paymentData.paymentMethod = userPreferences.paymentMethod;
        paymentData.coupon = appliedCoupon ? appliedCoupon.code : null;
        paymentData.loyaltyDiscount = loyaltyDiscount;
        paymentData.loyaltyPointsRedeemed = loyaltyPointsToRedeem;
        paymentData.loyaltyPointsEarned = loyaltyPointsEarned;
        paymentData.receiptDesign = selectedReceiptDesign;
        paymentData.deliveryOption = selectedDeliveryOption;
        paymentData.baggingOption = selectedBaggingOption;
        paymentData.donationOption = selectedDonationOption;
        
        // Show payment details summary
        document.getElementById('payment-details-summary').style.display = 'block';
        document.getElementById('summary-name').textContent = userPreferences.customerName;
        document.getElementById('summary-method').textContent = userPreferences.paymentMethod === 'cash' ? 'Bar' : 'Karte';
        document.getElementById('summary-coupon').textContent = appliedCoupon ? appliedCoupon.code : 'Keiner';
        document.getElementById('summary-loyalty').textContent = loyaltyPointsToRedeem > 0 ? `${loyaltyPointsToRedeem} Punkte eingelöst` : 'Keine';
        document.getElementById('summary-receipt').textContent = getReceiptDesignName(selectedReceiptDesign);
        document.getElementById('summary-delivery').textContent = getDeliveryOptionName(selectedDeliveryOption);
        document.getElementById('summary-bagging').textContent = getBaggingOptionName(selectedBaggingOption);
        document.getElementById('summary-donation').textContent = getDonationOptionName(selectedDonationOption);
        
        // Show edit button
        document.getElementById('edit-details-btn').style.display = 'block';
        
        // Update displayed amount
        document.getElementById('amount').textContent = `€ ${finalTotal.toFixed(2)}`;
        
        // Show discounts and additional costs
        displayAdditionalItems();
        
        // Start QR code generation with retry mechanism
        startQRCodeGeneration();
    }
    
    // Calculate final total including coupons and loyalty discounts
    function calculateFinalTotal() {
        let finalTotal = paymentData.total;
        
        // Apply coupon discount first
        if (appliedCoupon) {
            if (appliedCoupon.type === 'percent') {
                finalTotal -= finalTotal * (appliedCoupon.discount / 100);
            } else {
                finalTotal -= appliedCoupon.discount;
            }
        }
        
        // Apply loyalty discount
        if (loyaltyDiscount > 0) {
            finalTotal -= loyaltyDiscount;
        }
        
        // Apply delivery cost
        if (selectedDeliveryOption === 'home-delivery') {
            finalTotal += 4.99;
        }
        
        // Apply bagging cost
        if (selectedBaggingOption === 'standard') {
            // Assume 2 bags for standard shopping
            finalTotal += 0.40;
        } else if (selectedBaggingOption === 'premium') {
            finalTotal += 1.50;
        }
        
        // Apply donation
        if (selectedDonationOption !== 'none') {
            finalTotal += parseFloat(selectedDonationOption);
        }
        
        // Calculate points to be earned from this purchase (based on original total)
        loyaltyPointsEarned = Math.floor(paymentData.total * LOYALTY_CONFIG.pointsPerEuro);
        
        // Apply tier discount if applicable
        const tierDiscount = finalTotal * (LOYALTY_CONFIG.tiers[loyaltyTier].discount / 100);
        if (tierDiscount > 0) {
            finalTotal -= tierDiscount;
            loyaltyDiscount += tierDiscount; // Add to total loyalty discount for reporting
        }
        
        // Ensure total doesn't go negative
        finalTotal = Math.max(0, finalTotal);
        
        return finalTotal;
    }
    
    // Get receipt design name for display
    function getReceiptDesignName(design) {
        switch(design) {
            case 'simple': return 'Einfach';
            case 'compact': return 'Kompakt';
            case 'detailed': return 'Detailliert';
            case 'premium': return 'Premium';
            case 'gold': return 'Gold';
            case 'platinum': return 'Platinum';
            default: return 'Kompakt';
        }
    }
    
    // Get delivery option name for display
    function getDeliveryOptionName(option) {
        switch(option) {
            case 'store-pickup': return 'Abholung im Geschäft';
            case 'home-delivery': return 'Lieferung nach Hause';
            default: return 'Abholung im Geschäft';
        }
    }
    
    // Get bagging option name for display
    function getBaggingOptionName(option) {
        switch(option) {
            case 'standard': return 'Standard Tüten';
            case 'premium': return 'Premium Verpackung';
            case 'own': return 'Eigene Tasche';
            default: return 'Standard Tüten';
        }
    }
    
    // Get donation option name for display
    function getDonationOptionName(option) {
        switch(option) {
            case 'none': return 'Keine Spende';
            case '1': return '€ 1,00 an Lebensmittelbank';
            case '2': return '€ 2,00 an Tafel';
            default: return 'Keine Spende';
        }
    }
    
    // Update payment summary in the modal
    function updatePaymentSummary() {
        const summaryElement = document.getElementById('payment-summary');
        let html = '';
        let subtotal = paymentData.total;
        
        // Add items
        paymentData.items.forEach(item => {
            html += `
                <div class="summary-row">
                    <span>${item.quantity}x ${item.name}</span>
                    <span>€ ${(item.quantity * item.price).toFixed(2)}</span>
                </div>
            `;
        });
        
        // Add coupon discount if applied
        if (appliedCoupon) {
            let discountAmount = 0;
            
            if (appliedCoupon.type === 'percent') {
                discountAmount = subtotal * (appliedCoupon.discount / 100);
            } else {
                discountAmount = appliedCoupon.discount;
            }
            
            subtotal -= discountAmount;
            
            html += `
                <div class="summary-row discount">
                    <span>Rabatt (${appliedCoupon.code})</span>
                    <span>-€ ${discountAmount.toFixed(2)}</span>
                </div>
            `;
        }
        
        // Add loyalty discount if applied
        if (loyaltyDiscount > 0) {
            subtotal -= loyaltyDiscount;
            
            html += `
                <div class="summary-row discount">
                    <span>Treuepunkte-Rabatt</span>
                    <span>-€ ${loyaltyDiscount.toFixed(2)}</span>
                </div>
            `;
        }
        
        // Add delivery cost if applicable
        if (selectedDeliveryOption === 'home-delivery') {
            subtotal += 4.99;
            html += `
                <div class="summary-row">
                    <span>Lieferung nach Hause</span>
                    <span>+€ 4,99</span>
                </div>
            `;
        }
        
        // Add bagging cost if applicable
        if (selectedBaggingOption === 'standard') {
            subtotal += 0.40;
            html += `
                <div class="summary-row">
                    <span>Standard Tüten (2x)</span>
                    <span>+€ 0,40</span>
                </div>
            `;
        } else if (selectedBaggingOption === 'premium') {
            subtotal += 1.50;
            html += `
                <div class="summary-row">
                    <span>Premium Verpackung</span>
                    <span>+€ 1,50</span>
                </div>
            `;
        }
        
        // Add donation if applicable
        if (selectedDonationOption !== 'none') {
            const donationAmount = parseFloat(selectedDonationOption);
            subtotal += donationAmount;
            html += `
                <div class="summary-row">
                    <span>Spende</span>
                    <span>+€ ${donationAmount.toFixed(2)}</span>
                </div>
            `;
        }
        
        // Add receipt design info
        html += `
            <div class="summary-row">
                <span>Belegdesign</span>
                <span>${getReceiptDesignName(selectedReceiptDesign)}</span>
            </div>
        `;
        
        // Add loyalty points info
        html += `
            <div class="summary-row">
                <span>Erworbene Punkte</span>
                <span>+${loyaltyPointsEarned}</span>
            </div>
        `;
        
        // Add total
        html += `
            <div class="summary-row summary-total">
                <span>Gesamtsumme</span>
                <span>€ ${subtotal.toFixed(2)}</span>
            </div>
        `;
        
        summaryElement.innerHTML = html;
    }
    
    // Show step in the tutorial modal
    function showStep(stepNumber) {
        // Validate current step before proceeding
        if (stepNumber > currentStep) {
            if (currentStep === 1 && !document.getElementById('customer-name').value.trim()) {
                alert('Bitte geben Sie Ihren Namen ein');
                return;
            }
            if (currentStep === 2 && !selectedPaymentMethod) {
                alert('Bitte wählen Sie eine Zahlungsmethode aus');
                return;
            }
            
            // Initialize loyalty program when reaching step 4
            if (stepNumber === 4 && currentStep < 4) {
                initLoyaltyProgramStep();
            }
            
            // Initialize delivery options when reaching step 6
            if (stepNumber === 6 && currentStep < 6) {
                initDeliveryOptions();
            }
        }
        
        // Hide current step
        document.getElementById(`step-${currentStep}`).classList.remove('active');
        document.querySelectorAll('.step-indicator')[currentStep - 1].classList.remove('active');
        
        // Show new step
        currentStep = stepNumber;
        document.getElementById(`step-${currentStep}`).classList.add('active');
        document.querySelectorAll('.step-indicator')[currentStep - 1].classList.add('active');
        
        // Update summary if we're on the last step
        if (currentStep === 9) {
            updatePaymentSummary();
        }
    }
    
    // Initialize loyalty program step
    function initLoyaltyProgramStep() {
        // If user is already a member, show options directly
        if (isLoyaltyMember) {
            document.getElementById('loyalty-intro-container').style.display = 'none';
            document.getElementById('loyalty-options-container').style.display = 'block';
            initLoyaltyProgram();
        } else {
            document.getElementById('loyalty-intro-container').style.display = 'block';
            document.getElementById('loyalty-options-container').style.display = 'none';
            
            // Enable/disable join button based on toggle
            document.getElementById('loyalty-toggle').addEventListener('change', function() {
                document.getElementById('loyalty-join-btn').disabled = !this.checked;
            });
        }
    }
    
    // Join loyalty program
    function joinLoyaltyProgram() {
        isLoyaltyMember = true;
        
        // Show celebration animation
        celebrateLoyaltyJoin();
        
        // Hide intro and show options
        document.getElementById('loyalty-intro-container').style.display = 'none';
        document.getElementById('loyalty-options-container').style.display = 'block';
        
        // Initialize loyalty program
        initLoyaltyProgram();
        
        // Add welcome bonus points
        loyaltyPoints += 100;
        updateLoyaltyTier();
        
        // Show welcome message
        document.getElementById('loyalty-result').innerHTML = 
            '<div class="loyalty-success">Willkommen im Gittertier Premium Club! Sie haben 100 Willkommenspunkte erhalten!</div>';
    }
    
    // Skip loyalty program
    function skipLoyaltyProgram() {
        isLoyaltyMember = false;
        showStep(5); // Skip to next step
    }
    
    // Celebration animation for joining loyalty program
    function celebrateLoyaltyJoin() {
        const confettiContainer = document.getElementById('confetti-container');
        confettiContainer.style.display = 'block';
        
        // Create confetti particles
        for (let i = 0; i < 100; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.width = Math.random() * 10 + 5 + 'px';
            confetti.style.height = Math.random() * 10 + 5 + 'px';
            confetti.style.backgroundColor = getRandomColor();
            confetti.style.animationDuration = Math.random() * 3 + 2 + 's';
            confetti.style.animationDelay = Math.random() * 2 + 's';
            confettiContainer.appendChild(confetti);
        }
        
        // Hide confetti after animation
        setTimeout(() => {
            confettiContainer.style.display = 'none';
            confettiContainer.innerHTML = '';
        }, 5000);
    }
    
    // Get random color for confetti
    function getRandomColor() {
        const colors = [
            '#7e22ce', '#a855f7', '#ffd700', '#c5a47e', '#22c55e', 
            '#3b82f6', '#f97316', '#dc2626', '#16a34a'
        ];
        return colors[Math.floor(Math.random() * colors.length)];
    }
    
    // Select payment method
    function selectPaymentMethod(method) {
        selectedPaymentMethod = method;
        
        // Update UI
        document.querySelectorAll('.radio-option').forEach(option => {
            if (option.getAttribute('data-value') === method) {
                option.classList.add('selected');
            } else {
                option.classList.remove('selected');
            }
        });
    }
    
    // Select receipt design
    function selectReceiptDesign(design) {
        selectedReceiptDesign = design;
        
        // Update UI
        document.querySelectorAll('.design-option').forEach(option => {
            if (option.getAttribute('data-design') === design) {
                option.classList.add('selected');
            } else {
                option.classList.remove('selected');
            }
        });
        
        // Show preview
        document.querySelectorAll('.design-preview').forEach(preview => {
            preview.classList.remove('active');
        });
        document.getElementById(`design-preview-${design}`).classList.add('active');
    }
    
    // Select delivery option
    function selectDeliveryOption(option) {
        selectedDeliveryOption = option;
        
        // Update UI
        document.querySelectorAll('.delivery-option').forEach(el => {
            if (el.getAttribute('data-delivery') === option) {
                el.classList.add('selected');
            } else {
                el.classList.remove('selected');
            }
        });
        
        // Show/hide delivery details
        const deliveryDetails = document.getElementById('delivery-details');
        const addressGroup = document.getElementById('delivery-address-group');
        const timeGroup = document.getElementById('delivery-time-group');
        
        if (option === 'home-delivery') {
            deliveryDetails.classList.add('expanded');
            addressGroup.style.display = 'block';
            timeGroup.style.display = 'block';
        } else {
            deliveryDetails.classList.remove('expanded');
            addressGroup.style.display = 'none';
            timeGroup.style.display = 'none';
        }
    }
    
    // Select bagging option
    function selectBaggingOption(option) {
        selectedBaggingOption = option;
        
        // Update UI
        document.querySelectorAll('.bagging-option').forEach(el => {
            if (el.getAttribute('data-bagging') === option) {
                el.classList.add('selected');
            } else {
                el.classList.remove('selected');
            }
        });
    }
    
    // Select donation option
    function selectDonationOption(option) {
        selectedDonationOption = option;
        
        // Update UI
        document.querySelectorAll('.donation-option').forEach(el => {
            if (el.getAttribute('data-donation') === option) {
                el.classList.add('selected');
            } else {
                el.classList.remove('selected');
            }
        });
    }
    
    // Initialize delivery options
    function initDeliveryOptions() {
        // Set the current selection
        selectDeliveryOption(selectedDeliveryOption);
    }
    
    // Apply coupon
    function applyCoupon() {
        const code = document.getElementById('coupon-code').value.trim();
        const resultElement = document.getElementById('coupon-result');
        
        if (!code) {
            resultElement.innerHTML = '<div class="coupon-error">Bitte geben Sie einen Gutscheincode ein</div>';
            return;
        }
        
        // Find coupon
        const coupon = coupons.find(c => c.code === code.toUpperCase());
        
        if (!coupon || !coupon.valid) {
            resultElement.innerHTML = '<div class="coupon-error">Ungültiger Gutscheincode</div>';
            return;
        }
        
        // Apply coupon
        appliedCoupon = coupon;
        resultElement.innerHTML = `<div class="coupon-success">Gutschein erfolgreich angewendet: ${coupon.code}</div>`;
        
        // Update summary
        updatePaymentSummary();
    }
    
    // Initialize loyalty program
    function initLoyaltyProgram() {
        // Display current points and tier
        document.getElementById('loyalty-points').textContent = `${loyaltyPoints} Punkte`;
        updateLoyaltyTier();
        
        // Calculate points to be earned from this purchase
        loyaltyPointsEarned = Math.floor(paymentData.total * LOYALTY_CONFIG.pointsPerEuro);
        document.getElementById('points-to-earn').textContent = loyaltyPointsEarned;
        document.getElementById('points-earned').style.display = 'block';
        
        // Create redemption options
        const optionsContainer = document.getElementById('loyalty-options');
        optionsContainer.innerHTML = '';
        
        // Add special offers
        LOYALTY_CONFIG.specialOffers.forEach(offer => {
            if (offer.available) {
                const optionElement = createLoyaltyOptionElement(offer, 'special');
                optionsContainer.appendChild(optionElement);
            }
        });
        
        // Add redemption options
        LOYALTY_CONFIG.redemptionOptions.forEach(option => {
            if (loyaltyPoints >= option.points) {
                const optionElement = createLoyaltyOptionElement(option, 'redemption');
                optionsContainer.appendChild(optionElement);
            }
        });
        
        // Add "No redemption" option
        const noOptionElement = document.createElement('div');
        noOptionElement.className = 'loyalty-option';
        noOptionElement.innerHTML = `
            <div class="loyalty-option-details">
                <div class="loyalty-option-title">Keine Punkte einlösen</div>
                <div class="loyalty-option-desc">Punkte für zukünftige Einkäufe sparen</div>
            </div>
        `;
        
        noOptionElement.addEventListener('click', () => {
            selectLoyaltyOption(noOptionElement, { points: 0, discount: 0 });
        });
        
        optionsContainer.appendChild(noOptionElement);
        
        // Create benefits list
        const benefitsContainer = document.getElementById('loyalty-benefits');
        benefitsContainer.innerHTML = '';
        
        LOYALTY_CONFIG.tiers[loyaltyTier].benefits.forEach(benefit => {
            const benefitElement = document.createElement('div');
            benefitElement.className = 'loyalty-benefit';
            benefitElement.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <span>${benefit}</span>
            `;
            benefitsContainer.appendChild(benefitElement);
        });
    }
    
    // Create loyalty option element
    function createLoyaltyOptionElement(option, type) {
        const optionElement = document.createElement('div');
        optionElement.className = 'loyalty-option';
        if (!option.available) {
            optionElement.classList.add('unavailable');
        }
        
        let icon = 'fas fa-gift';
        if (type === 'special') {
            icon = 'fas fa-star';
        }
        
        optionElement.innerHTML = `
            <div class="loyalty-option-details">
                <div class="loyalty-option-title">
                    <i class="${icon}"></i>
                    ${option.title}
                </div>
                <div class="loyalty-option-desc">${option.description}</div>
            </div>
            <div class="loyalty-option-cost">${option.points > 0 ? option.points + ' Punkte' : 'Kostenlos'}</div>
        `;
        
        if (type === 'special' && option.available) {
            optionElement.innerHTML += '<div class="loyalty-option-featured">SPECIAL</div>';
        }
        
        if (option.available) {
            optionElement.addEventListener('click', () => {
                selectLoyaltyOption(optionElement, option);
            });
        }
        
        return optionElement;
    }
    
    // Update loyalty tier based on points
    function updateLoyaltyTier() {
        let newTier = 'bronze';
        
        if (loyaltyPoints >= LOYALTY_CONFIG.tiers.diamond.minPoints) {
            newTier = 'diamond';
        } else if (loyaltyPoints >= LOYALTY_CONFIG.tiers.platinum.minPoints) {
            newTier = 'platinum';
        } else if (loyaltyPoints >= LOYALTY_CONFIG.tiers.gold.minPoints) {
            newTier = 'gold';
        } else if (loyaltyPoints >= LOYALTY_CONFIG.tiers.silver.minPoints) {
            newTier = 'silver';
        }
        
        loyaltyTier = newTier;
        
        // Update UI
        const tierElement = document.getElementById('loyalty-tier');
        tierElement.innerHTML = `<span class="tier-badge tier-${loyaltyTier}">${capitalizeFirstLetter(loyaltyTier)}</span>`;
        
        // Show/hide premium receipt options based on tier
        if (loyaltyTier === 'gold' || loyaltyTier === 'platinum' || loyaltyTier === 'diamond') {
            document.getElementById('gold-receipt-option').style.display = 'flex';
        }
        if (loyaltyTier === 'platinum' || loyaltyTier === 'diamond') {
            document.getElementById('platinum-receipt-option').style.display = 'flex';
        }
        
        // Update progress bar
        const nextTier = getNextTier();
        if (nextTier) {
            const minPoints = LOYALTY_CONFIG.tiers[loyaltyTier].minPoints;
            const nextTierMinPoints = LOYALTY_CONFIG.tiers[nextTier].minPoints;
            const progress = ((loyaltyPoints - minPoints) / (nextTierMinPoints - minPoints)) * 100;
            
            document.getElementById('progress-fill').style.width = `${Math.min(progress, 100)}%`;
            document.getElementById('progress-text').textContent = `${loyaltyPoints - minPoints}/${nextTierMinPoints - minPoints}`;
        } else {
            // Highest tier reached
            document.getElementById('progress-fill').style.width = '100%';
            document.getElementById('progress-text').textContent = 'Maximales Level erreicht!';
        }
    }
    
    // Get next tier
    function getNextTier() {
        switch(loyaltyTier) {
            case 'bronze': return 'silver';
            case 'silver': return 'gold';
            case 'gold': return 'platinum';
            case 'platinum': return 'diamond';
            default: return null;
        }
    }
    
    // Capitalize first letter
    function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
    }
    
    // Select loyalty option
    function selectLoyaltyOption(element, option) {
        // Deselect all options
        document.querySelectorAll('.loyalty-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        
        // Select clicked option
        element.classList.add('selected');
        
        // Set loyalty discount and points to redeem
        loyaltyDiscount = option.discount;
        loyaltyPointsToRedeem = option.points;
        
        // Show result
        const resultElement = document.getElementById('loyalty-result');
        if (option.points > 0) {
            resultElement.innerHTML = `<div class="loyalty-success">${option.title} angewendet! -€ ${option.discount.toFixed(2)}</div>`;
        } else if (option.discount > 0) {
            resultElement.innerHTML = `<div class="loyalty-success">${option.title} angewendet! -€ ${option.discount.toFixed(2)}</div>`;
        } else {
            resultElement.innerHTML = '<div class="loyalty-success">Keine Punkte eingelöst</div>';
        }
    }
    
    // Process payment
    function processPayment() {
        const customerName = document.getElementById('customer-name').value.trim();
        
        // Validate inputs
        if (!customerName) {
            alert('Bitte geben Sie Ihren Namen ein');
            showStep(1);
            return;
        }
        
        if (!selectedPaymentMethod) {
            alert('Bitte wählen Sie eine Zahlungsmethode aus');
            showStep(2);
            return;
        }
        
        // Validate delivery details if home delivery is selected
        if (selectedDeliveryOption === 'home-delivery') {
            deliveryAddress = document.getElementById('delivery-address').value.trim();
            deliveryTime = document.getElementById('delivery-time').value;
            
            if (!deliveryAddress) {
                alert('Bitte geben Sie eine Lieferadresse ein');
                showStep(6);
                return;
            }
            
            if (!deliveryTime) {
                alert('Bitte wählen Sie eine Lieferzeit aus');
                showStep(6);
                return;
            }
        }
        
        // Check if loyalty points are sufficient for redemption
        if (loyaltyPointsToRedeem > loyaltyPoints) {
            document.getElementById('loyalty-result').innerHTML = '<div class="loyalty-error">Nicht genügend Punkte für diese Aktion</div>';
            showStep(4);
            return;
        }
        
        // Save user preferences
        saveUserPreferences();
        
        // Hide payment modal
        closeModal('payment-modal');
        
        // Show payment details summary
        document.getElementById('payment-details-summary').style.display = 'block';
        document.getElementById('summary-name').textContent = customerName;
        document.getElementById('summary-method').textContent = selectedPaymentMethod === 'cash' ? 'Bar' : 'Karte';
        document.getElementById('summary-coupon').textContent = appliedCoupon ? appliedCoupon.code : 'Keiner';
        document.getElementById('summary-loyalty').textContent = loyaltyPointsToRedeem > 0 ? `${loyaltyPointsToRedeem} Punkte eingelöst` : 'Keine';
        document.getElementById('summary-receipt').textContent = getReceiptDesignName(selectedReceiptDesign);
        document.getElementById('summary-delivery').textContent = getDeliveryOptionName(selectedDeliveryOption);
        document.getElementById('summary-bagging').textContent = getBaggingOptionName(selectedBaggingOption);
        document.getElementById('summary-donation').textContent = getDonationOptionName(selectedDonationOption);
        
        // Show edit button
        document.getElementById('edit-details-btn').style.display = 'block';
        
        // Calculate final total with coupon and loyalty discount
        let finalTotal = calculateFinalTotal();
        
        // Update payment data with final total
        paymentData.finalTotal = finalTotal;
        paymentData.customerName = customerName;
        paymentData.paymentMethod = selectedPaymentMethod;
        paymentData.coupon = appliedCoupon ? appliedCoupon.code : null;
        paymentData.loyaltyDiscount = loyaltyDiscount;
        paymentData.loyaltyPointsRedeemed = loyaltyPointsToRedeem;
        paymentData.loyaltyPointsEarned = loyaltyPointsEarned;
        paymentData.receiptDesign = selectedReceiptDesign;
        paymentData.deliveryOption = selectedDeliveryOption;
        paymentData.baggingOption = selectedBaggingOption;
        paymentData.donationOption = selectedDonationOption;
        paymentData.deliveryAddress = deliveryAddress;
        paymentData.deliveryTime = deliveryTime;
        
        // Update displayed amount
        document.getElementById('amount').textContent = `€ ${finalTotal.toFixed(2)}`;
        
        // Show discounts and additional costs
        displayAdditionalItems();
        
        // Start QR code generation with retry mechanism
        startQRCodeGeneration();
    }
    
    // Edit payment details
    function editPaymentDetails() {
        // Set flag that modal was opened manually
        infoModalOpenedManually = true;
        
        // Show the payment modal again
        showModal('payment-modal');
        
        // Show the back button
        document.getElementById('step1-cancel-btn').style.display = 'block';
        
        // Prefill with current values
        document.getElementById('customer-name').value = paymentData.customerName || '';
        
        if (paymentData.paymentMethod) {
            selectPaymentMethod(paymentData.paymentMethod);
        }
        
        if (paymentData.coupon) {
            appliedCoupon = coupons.find(c => c.code === paymentData.coupon);
            if (appliedCoupon) {
                document.getElementById('coupon-code').value = appliedCoupon.code;
                document.getElementById('coupon-result').innerHTML = 
                    `<div class="coupon-success">Aktiver Gutschein: ${appliedCoupon.code}</div>`;
            }
        }
        
        if (paymentData.receiptDesign) {
            selectReceiptDesign(paymentData.receiptDesign);
        }
        
        if (paymentData.deliveryOption) {
            selectDeliveryOption(paymentData.deliveryOption);
            if (paymentData.deliveryAddress) {
                document.getElementById('delivery-address').value = paymentData.deliveryAddress;
            }
            if (paymentData.deliveryTime) {
                document.getElementById('delivery-time').value = paymentData.deliveryTime;
            }
        }
        
        if (paymentData.baggingOption) {
            selectBaggingOption(paymentData.baggingOption);
        }
        
        if (paymentData.donationOption) {
            selectDonationOption(paymentData.donationOption);
        }
        
        // Initialize loyalty program with current values
        if (paymentData.loyaltyPointsRedeemed !== undefined) {
            loyaltyPointsToRedeem = paymentData.loyaltyPointsRedeemed;
            loyaltyDiscount = paymentData.loyaltyDiscount;
        }
        
        initLoyaltyProgramStep();
        
        // Update summary
        updatePaymentSummary();
        
        // Hide the summary and edit button
        document.getElementById('payment-details-summary').style.display = 'none';
        document.getElementById('edit-details-btn').style.display = 'none';
        
        // Stop countdown if it's running
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
        
        // Clear QR code
        document.getElementById('qrcode').innerHTML = '';
        
        // Reset status
        document.getElementById('status').className = 'status pending';
        document.getElementById('status').innerHTML = '<i class="fas fa-clock"></i><span>Zahlung ausstehend</span>';
    }
    
    // Initialize PeerJS for customer
    function initializePeerJS() {
        try {
            customerPeer = new Peer(paymentId, {
                debug: 2,
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });

            customerPeer.on('open', (id) => {
                console.log('Customer Peer ID:', id);
            });

            customerPeer.on('connection', (conn) => {
                console.log('Merchant connected:', conn.peer);
                merchantConnection = conn;
                
                // Send payment data to merchant
                conn.send({
                    type: 'payment-data',
                    data: paymentData
                });
                
                // Show connecting modal when merchant connects
                showModal('connecting-modal');
                
                // Stop the countdown timer
                clearInterval(countdownInterval);
                
                conn.on('data', (data) => {
                    console.log('Received data:', data);
                    if (data.type === 'confirm') {
                        handlePaymentConfirmation();
                    } else if (data.type === 'decline') {
                        handlePaymentDecline();
                    } else if (data.type === 'request-payment-data') {
                        // Send payment data to merchant
                        conn.send({
                            type: 'payment-data',
                            data: paymentData
                        });
                    }
                });

                conn.on('error', (err) => {
                    console.error('Connection error:', err);
                });
            });

            customerPeer.on('error', (err) => {
                console.error('PeerJS error:', err);
                // Try to reinitialize if connection fails
                if (err.type === 'peer-unavailable') {
                    setTimeout(initializePeerJS, 2000);
                }
            });
            
        } catch (error) {
            console.error('Failed to initialize PeerJS:', error);
            // Retry initialization after a delay
            setTimeout(initializePeerJS, 3000);
        }
    }
    
    // Handle payment confirmation from merchant
    function handlePaymentConfirmation() {
        const statusEl = document.getElementById('status');
        statusEl.className = 'status confirmed';
        statusEl.innerHTML = '<i class="fas fa-check-circle"></i><span>Zahlung bestätigt!</span>';
        
        // Update loyalty points
        const newPoints = loyaltyPoints - loyaltyPointsToRedeem + loyaltyPointsEarned;
        
        // Save updated points to preferences
        if (userPreferences) {
            userPreferences.loyaltyPoints = newPoints;
            localStorage.setItem('gittertier_payment_preferences', JSON.stringify(userPreferences));
        }
        
        clearInterval(countdownInterval);
        closeModal('connecting-modal');
        showModal('success-modal');
    }
    
    // Handle payment decline from merchant
    function handlePaymentDecline() {
        const statusEl = document.getElementById('status');
        statusEl.className = 'status declined';
        statusEl.innerHTML = '<i class="fas fa-times-circle"></i><span>Zahlung abgelehnt!</span>';
        
        clearInterval(countdownInterval);
        closeModal('connecting-modal');
        // Show error modal with decline message
        document.getElementById('error-message').textContent = 'Der Händler hat die Zahlung abgelehnt.';
        showModal('error-modal');
    }
    
    // Start countdown timer
    function startCountdown() {
        const countdownElement = document.getElementById('countdown-value');
        countdownElement.textContent = countdownTime;
        
        countdownInterval = setInterval(() => {
            countdownTime--;
            countdownElement.textContent = countdownTime;
            
            if (countdownTime <= 0) {
                clearInterval(countdownInterval);
                location.reload();
            }
        }, 1000);
    }
    
    // Generate QR code with retry mechanism - Now only contains the peer ID
    function generateQR() {
        return new Promise((resolve, reject) => {
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            
            // Create minimal data structure for QR code - only the peer ID
            const qrData = JSON.stringify({
                p: paymentId,  // Only include the peer ID
                t: 'gittertier-payment' // Type identifier
            });

            try {
                // Calculate QR size based on viewport
                const qrSize = Math.min(300, Math.min(window.innerWidth, window.innerHeight) * 0.7);
                
                // Generate QR code
                new QRCode(qrContainer, {
                    text: qrData,
                    width: qrSize,
                    height: qrSize,
                    colorDark: "#2c3e50",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                // Check if QR code was generated successfully
                setTimeout(() => {
                    if (qrContainer.querySelector('canvas')) {
                        resolve();
                    } else {
                        reject(new Error('QR code generation failed'));
                    }
                }, 100);
                
            } catch(error) {
                console.error('QR Generation Error:', error);
                reject(error);
            }
        });
    }
    
    // Start QR code generation with retry mechanism
    function startQRCodeGeneration() {
        qrGenerationAttempts = 0;
        showModal('qr-generation-modal');
        attemptQRCodeGeneration();
    }
    
    // Attempt to generate QR code with retries
    function attemptQRCodeGeneration() {
        qrGenerationAttempts++;
        
        generateQR().then(() => {
            // QR code generated successfully
            closeModal('qr-generation-modal');
            startCountdown();
        }).catch(error => {
            console.error(`QR generation attempt ${qrGenerationAttempts} failed:`, error);
            
            if (qrGenerationAttempts < MAX_QR_ATTEMPTS) {
                // Retry after a short delay
                setTimeout(attemptQRCodeGeneration, 500);
            } else {
                // Max attempts reached, show error
                closeModal('qr-generation-modal');
                document.getElementById('error-message').textContent = 'QR-Code konnte nicht generiert werden. Bitte versuchen Sie es erneut.';
                showModal('error-modal');
            }
        });
    }
    
    // Show modal
    function showModal(modalId) {
        document.getElementById(modalId).style.display = 'flex';
    }
    
    // Close modal
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
    
    // Cancel payment
    function cancelPayment() {
        window.location.href = 'index';
    }
    
    // Confirm payment manually
    function confirmPayment() {
        const statusEl = document.getElementById('status');
        statusEl.className = 'status confirmed';
        statusEl.innerHTML = '<i class="fas fa-check-circle"></i><span>Zahlung bestätigt!</span>';
        
        clearInterval(countdownInterval);
        showModal('success-modal');
    }
    
    // Generate receipt
    function generateReceipt() {
        const receiptFormat = selectedReceiptDesign || 'compact';
        
        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.width;
        const pageHeight = doc.internal.pageSize.height;
        const paymentDate = new Date().toLocaleDateString('de-DE');
        const paymentTime = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
        const shortPaymentId = paymentId.split('-').pop().substr(0, 8);
        let yPos = 20;

        // Simple Beleg
        function generateSimpleReceipt() {
            yPos = drawHeader();
            
            doc.setFontSize(14);
            doc.setTextColor(17, 17, 17);
            doc.setFont(undefined, 'bold');
            doc.text("EINKAUFSBELEG", pageWidth / 2, yPos, null, 'center');
            yPos += 15;
            
            // Kundendaten
            doc.setFontSize(12);
            doc.setTextColor(55, 65, 81);
            doc.text(`Kunde: ${paymentData.customerName}`, 20, yPos);
            yPos += 8;
            doc.text(`Zahlungsart: ${selectedPaymentMethod === 'cash' ? 'Bar' : 'Karte'}`, 20, yPos);
            yPos += 15;
            
            // Artikel (nur Namen und Gesamtpreise)
            doc.setFontSize(11);
            doc.setTextColor(17, 17, 17);
            
            paymentData.items.forEach((item) => {
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                doc.text(`${item.quantity}x ${item.name}`, 20, yPos);
                doc.text(`€ ${(item.quantity * item.price).toFixed(2)}`, pageWidth - 20, yPos, null, 'right');
                yPos += 8;
            });
            
            // Rabatt, falls vorhanden
            if (appliedCoupon) {
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                yPos += 5;
                doc.setTextColor(22, 163, 74);
                let discountText = '';
                
                if (appliedCoupon.type === 'percent') {
                    discountText = `Rabatt (${appliedCoupon.code}): -${appliedCoupon.discount}%`;
                } else {
                    discountText = `Rabatt (${appliedCoupon.code}): -€ ${appliedCoupon.discount.toFixed(2)}`;
                }
                
                doc.text(discountText, pageWidth - 20, yPos, null, 'right');
                yPos += 8;
            }
            
            // Treuepunkte Rabatt, falls vorhanden
            if (loyaltyDiscount > 0) {
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                doc.setTextColor(22, 163, 74);
                doc.text(`Treuepunkte Rabatt: -€ ${loyaltyDiscount.toFixed(2)}`, pageWidth - 20, yPos, null, 'right');
                yPos += 8;
            }
            
            // Lieferkosten, falls vorhanden
            if (selectedDeliveryOption === 'home-delivery') {
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                doc.setTextColor(17, 17, 17);
                doc.text(`Lieferung: +€ 4,99`, pageWidth - 20, yPos, null, 'right');
                yPos += 8;
            }
            
            // Verpackungskosten, falls vorhanden
            if (selectedBaggingOption === 'standard') {
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                doc.setTextColor(17, 17, 17);
                doc.text(`Standard Tüten: +€ 0,40`, pageWidth - 20, yPos, null, 'right');
                yPos += 8;
            } else if (selectedBaggingOption === 'premium') {
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                doc.setTextColor(17, 17, 17);
                doc.text(`Premium Verpackung: +€ 1,50`, pageWidth - 20, yPos, null, 'right');
                yPos += 8;
            }
            
            // Spende, falls vorhanden
            if (selectedDonationOption !== 'none') {
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                doc.setTextColor(17, 17, 17);
                doc.text(`Spende: +€ ${parseFloat(selectedDonationOption).toFixed(2)}`, pageWidth - 20, yPos, null, 'right');
                yPos += 8;
            }
            
            // Gesamtsumme
            if (yPos > pageHeight - 50) {
                doc.addPage();
                yPos = 20;
                drawHeader();
                yPos += 40;
            }
            
            yPos += 10;
            doc.setDrawColor(0, 0, 0);
            doc.line(20, yPos, pageWidth - 20, yPos);
            yPos += 5;
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("GESAMTSUMME:", 20, yPos);
            doc.text(`€ ${paymentData.finalTotal.toFixed(2)}`, pageWidth - 20, yPos, null, 'right');
            yPos += 15;
            
            // Treuepunkte
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(55, 65, 81);
            doc.text(`Erworbene Treuepunkte: +${loyaltyPointsEarned}`, 20, yPos);
            yPos += 8;
            
            // Datum und ID
            doc.text(`Belegnummer: ${shortPaymentId}`, 20, pageHeight - 30);
            doc.text(`${paymentDate} ${paymentTime}`, pageWidth - 20, pageHeight - 30, null, 'right');
            
            // Footer
            doc.setFontSize(10);
            doc.setTextColor(107, 114, 128);
            doc.text("Vielen Dank für Ihren Einkauf bei Gittertier Pro!", pageWidth / 2, pageHeight - 15, null, 'center');
        }
        
        // Kompakter Beleg
        function generateCompactReceipt() {
            yPos = drawHeader();
            
            doc.setFontSize(16);
            doc.setTextColor(37, 99, 235);
            doc.setFont(undefined, 'bold');
            doc.text("GITTERTIER PRO", pageWidth / 2, yPos, null, 'center');
            yPos += 10;
            
            doc.setFontSize(12);
            doc.setTextColor(17, 17, 17);
            doc.text("EINKAUFSBELEG", pageWidth / 2, yPos, null, 'center');
            yPos += 15;
            
            // Kundendaten
            doc.setFontSize(10);
            doc.setTextColor(55, 65, 81);
            doc.text(`Kunde: ${paymentData.customerName}`, 20, yPos);
            doc.text(`Beleg: ${shortPaymentId}`, pageWidth - 20, yPos, null, 'right');
            yPos += 6;
            doc.text(`Zahlungsart: ${selectedPaymentMethod === 'cash' ? 'Bar' : 'Karte'}`, 20, yPos);
            doc.text(`${paymentDate} ${paymentTime}`, pageWidth - 20, yPos, null, 'right');
            yPos += 15;
            
            // Artikelübersicht
            doc.setDrawColor(229, 231, 235);
            doc.line(20, yPos, pageWidth - 20, yPos);
            yPos += 8;
            
            doc.setFontSize(11);
            doc.setTextColor(17, 17, 17);
            doc.setFont(undefined, 'bold');
            doc.text("ARTIKEL", 20, yPos);
            doc.text("MENGE", pageWidth / 2 - 20, yPos);
            doc.text("GESAMT", pageWidth - 20, yPos, null, 'right');
            yPos += 8;
            
            doc.setFont(undefined, 'normal');
            paymentData.items.forEach((item) => {
                if (yPos > pageHeight - 60) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                doc.text(item.name, 20, yPos);
                doc.text(`${item.quantity}x`, pageWidth / 2 - 20, yPos);
                doc.text(`€ ${(item.quantity * item.price).toFixed(2)}`, pageWidth - 20, yPos, null, 'right');
                yPos += 8;
            });
            
            // Rabatte und Zusatzkosten
            if (appliedCoupon || loyaltyDiscount > 0 || selectedDeliveryOption === 'home-delivery' || 
                selectedBaggingOption !== 'own' || selectedDonationOption !== 'none') {
                
                if (yPos > pageHeight - 80) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                yPos += 10;
                doc.line(20, yPos, pageWidth - 20, yPos);
                yPos += 8;
                
                // Rabatt, falls vorhanden
                if (appliedCoupon) {
                    doc.setTextColor(22, 163, 74);
                    let discountText = '';
                    
                    if (appliedCoupon.type === 'percent') {
                        discountText = `Rabatt (${appliedCoupon.code}): -${appliedCoupon.discount}%`;
                    } else {
                        discountText = `Rabatt (${appliedCoupon.code}): -€ ${appliedCoupon.discount.toFixed(2)}`;
                    }
                    
                    doc.text(discountText, pageWidth - 20, yPos, null, 'right');
                    yPos += 8;
                }
                
                // Treuepunkte Rabatt, falls vorhanden
                if (loyaltyDiscount > 0) {
                    doc.setTextColor(22, 163, 74);
                    doc.text(`Treuepunkte Rabatt: -€ ${loyaltyDiscount.toFixed(2)}`, pageWidth - 20, yPos, null, 'right');
                    yPos += 8;
                }
                
                // Lieferkosten, falls vorhanden
                if (selectedDeliveryOption === 'home-delivery') {
                    doc.setTextColor(17, 17, 17);
                    doc.text(`Lieferung: +€ 4,99`, pageWidth - 20, yPos, null, 'right');
                    yPos += 8;
                }
                
                // Verpackungskosten, falls vorhanden
                if (selectedBaggingOption === 'standard') {
                    doc.setTextColor(17, 17, 17);
                    doc.text(`Standard Tüten: +€ 0,40`, pageWidth - 20, yPos, null, 'right');
                    yPos += 8;
                } else if (selectedBaggingOption === 'premium') {
                    doc.setTextColor(17, 17, 17);
                    doc.text(`Premium Verpackung: +€ 1,50`, pageWidth - 20, yPos, null, 'right');
                    yPos += 8;
                }
                
                // Spende, falls vorhanden
                if (selectedDonationOption !== 'none') {
                    doc.setTextColor(17, 17, 17);
                    doc.text(`Spende: +€ ${parseFloat(selectedDonationOption).toFixed(2)}`, pageWidth - 20, yPos, null, 'right');
                    yPos += 8;
                }
            }
            
            // Gesamtsumme
            if (yPos > pageHeight - 50) {
                doc.addPage();
                yPos = 20;
                drawHeader();
                yPos += 40;
            }
            
            yPos += 10;
            doc.setDrawColor(0, 0, 0);
            doc.line(20, yPos, pageWidth - 20, yPos);
            yPos += 8;
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("GESAMTSUMME:", 20, yPos);
            doc.text(`€ ${paymentData.finalTotal.toFixed(2)}`, pageWidth - 20, yPos, null, 'right');
            yPos += 15;
            
            // Treuepunkte
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(55, 65, 81);
            doc.text(`Erworbene Treuepunkte: +${loyaltyPointsEarned}`, 20, yPos);
            yPos += 8;
            
            if (isLoyaltyMember) {
                doc.text(`Aktuelle Treuepunkte: ${loyaltyPoints - loyaltyPointsToRedeem + loyaltyPointsEarned}`, 20, yPos);
                yPos += 8;
                doc.text(`Treuestatus: ${capitalizeFirstLetter(loyaltyTier)}`, 20, yPos);
                yPos += 8;
            }
            
            // Footer
            doc.setFontSize(9);
            doc.setTextColor(107, 114, 128);
            doc.text("Vielen Dank für Ihren Einkauf bei Gittertier Pro!", pageWidth / 2, pageHeight - 15, null, 'center');
        }
        
        // Detaillierter Beleg
        function generateDetailedReceipt() {
            yPos = drawHeader();
            
            doc.setFontSize(16);
            doc.setTextColor(37, 99, 235);
            doc.setFont(undefined, 'bold');
            doc.text("GITTERTIER PRO", pageWidth / 2, yPos, null, 'center');
            yPos += 10;
            
            doc.setFontSize(12);
            doc.setTextColor(17, 17, 17);
            doc.text("DETAILIERTER EINKAUFSBELEG", pageWidth / 2, yPos, null, 'center');
            yPos += 15;
            
            // Kundendaten
            doc.setFontSize(10);
            doc.setTextColor(55, 65, 81);
            doc.text(`Kunde: ${paymentData.customerName}`, 20, yPos);
            doc.text(`Belegnummer: ${shortPaymentId}`, pageWidth - 20, yPos, null, 'right');
            yPos += 6;
            doc.text(`Zahlungsart: ${selectedPaymentMethod === 'cash' ? 'Bar' : 'Karte'}`, 20, yPos);
            doc.text(`Datum: ${paymentDate} ${paymentTime}`, pageWidth - 20, yPos, null, 'right');
            yPos += 15;
            
            // Artikelübersicht
            doc.setDrawColor(229, 231, 235);
            doc.line(20, yPos, pageWidth - 20, yPos);
            yPos += 8;
            
            doc.setFontSize(11);
            doc.setTextColor(17, 17, 17);
            doc.setFont(undefined, 'bold');
            doc.text("ARTIKEL", 20, yPos);
            doc.text("EINZELPREIS", pageWidth / 2 - 30, yPos);
            doc.text("MENGE", pageWidth / 2 + 10, yPos);
            doc.text("GESAMT", pageWidth - 20, yPos, null, 'right');
            yPos += 8;
            
            doc.setFont(undefined, 'normal');
            paymentData.items.forEach((item) => {
                if (yPos > pageHeight - 60) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                doc.text(item.name, 20, yPos);
                doc.text(`€ ${item.price.toFixed(2)}`, pageWidth / 2 - 30, yPos);
                doc.text(`${item.quantity}x`, pageWidth / 2 + 10, yPos);
                doc.text(`€ ${(item.quantity * item.price).toFixed(2)}`, pageWidth - 20, yPos, null, 'right');
                yPos += 8;
            });
            
            // Rabatte und Zusatzkosten
            if (appliedCoupon || loyaltyDiscount > 0 || selectedDeliveryOption === 'home-delivery' || 
                selectedBaggingOption !== 'own' || selectedDonationOption !== 'none') {
                
                if (yPos > pageHeight - 100) {
                    doc.addPage();
                    yPos = 20;
                    drawHeader();
                    yPos += 40;
                }
                
                yPos += 10;
                doc.line(20, yPos, pageWidth - 20, yPos);
                yPos += 8;
                
                doc.setFont(undefined, 'bold');
                doc.text("ZUSATZKOSTEN & RABATTE", 20, yPos);
                yPos += 10;
                doc.setFont(undefined, 'normal');
                
                // Rabatt, falls vorhanden
                if (appliedCoupon) {
                    doc.setTextColor(22, 163, 74);
                    let discountText = '';
                    
                    if (appliedCoupon.type === 'percent') {
                        discountText = `Rabatt (${appliedCoupon.code}): -${appliedCoupon.discount}%`;
                    } else {
                        discountText = `Rabatt (${appliedCoupon.code}): -€ ${appliedCoupon.discount.toFixed(2)}`;
                    }
                    
                    doc.text(discountText, pageWidth - 20, yPos, null, 'right');
                    yPos += 8;
                }
                
                // Treuepunkte Rabatt, falls vorhanden
                if (loyaltyDiscount > 0) {
                    doc.setTextColor(22, 163, 74);
                    doc.text(`Treuepunkte Rabatt: -€ ${loyaltyDiscount.toFixed(2)}`, pageWidth - 20, yPos, null, 'right');
                    yPos += 8;
                }
                
                // Lieferkosten, falls vorhanden
                if (selectedDeliveryOption === 'home-delivery') {
                    doc.setTextColor(17, 17, 17);
                    doc.text(`Lieferung nach Hause: +€ 4,99`, pageWidth - 20, yPos, null, 'right');
                    yPos += 8;
                }
                
                // Verpackungskosten, falls vorhanden
                if (selectedBaggingOption === 'standard') {
                    doc.setTextColor(17, 17, 17);
                    doc.text(`Standard Tüten (2x): +€ 0,40`, pageWidth - 20, yPos, null, 'right');
                    yPos += 8;
                } else if (selectedBaggingOption === 'premium') {
                    doc.setTextColor(17, 17, 17);
                    doc.text(`Premium Verpackung: +€ 1,50`, pageWidth - 20, yPos, null, 'right');
                    yPos += 8;
                }
                
                // Spende, falls vorhanden
                if (selectedDonationOption !== 'none') {
                    doc.setTextColor(17, 17, 17);
                    let donationOrg = '';
                    if (selectedDonationOption === '1') {
                        donationOrg = ' (Lebensmittelbank)';
                    } else if (selectedDonationOption === '2') {
                        donationOrg = ' (Tafel)';
                    }
                    
                    doc.text(`Spende${donationOrg}: +€ ${parseFloat(selectedDonationOption).toFixed(2)}`, pageWidth - 20, yPos, null, 'right');
                    yPos += 8;
                }
            }
            
            // Gesamtsumme
            if (yPos > pageHeight - 50) {
                doc.addPage();
                yPos = 20;
                drawHeader();
                yPos += 40;
            }
            
            yPos += 10;
            doc.setDrawColor(0, 0, 0);
            doc.line(20, yPos, pageWidth - 20, yPos);
            yPos += 8;
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text("GESAMTSUMME:", 20, yPos);
            doc.text(`€ ${paymentData.finalTotal.toFixed(2)}`, pageWidth - 20, yPos, null, 'right');
            yPos += 15;
            
            // Treuepunkte Details
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(55, 65, 81);
            
            if (isLoyaltyMember) {
                doc.text("TREUEPUNKTE DETAILS", 20, yPos);
                yPos += 8;
                
                if (loyaltyPointsToRedeem > 0) {
                    doc.text(`Eingelöste Punkte: -${loyaltyPointsToRedeem}`, 20, yPos);
                    yPos += 8;
                }
                
                doc.text(`Erworbene Punkte: +${loyaltyPointsEarned}`, 20, yPos);
                yPos += 8;
                
                const newPoints = loyaltyPoints - loyaltyPointsToRedeem + loyaltyPointsEarned;
                doc.text(`Neuer Punktestand: ${newPoints}`, 20, yPos);
                yPos += 8;
                
                doc.text(`Treuestatus: ${capitalizeFirstLetter(loyaltyTier)}`, 20, yPos);
                yPos += 8;
                
                // Show progress to next tier
                const nextTier = getNextTier();
                if (nextTier) {
                    const minPoints = LOYALTY_CONFIG.tiers[loyaltyTier].minPoints;
                    const nextTierMinPoints = LOYALTY_CONFIG.tiers[nextTier].minPoints;
                    const pointsNeeded = nextTierMinPoints - newPoints;
                    
                    if (pointsNeeded > 0) {
                        doc.text(`Punkte bis ${capitalizeFirstLetter(nextTier)}: ${pointsNeeded}`, 20, yPos);
                        yPos += 8;
                    }
                }
            } else {
                doc.text(`Erworbene Treuepunkte (bei Anmeldung): +${loyaltyPointsEarned}`, 20, yPos);
                yPos += 8;
            }
            
            // Footer
            doc.setFontSize(9);
            doc.setTextColor(107, 114, 128);
            doc.text("Vielen Dank für Ihren Einkauf bei Gittertier Pro!", pageWidth / 2, pageHeight - 15, null, 'center');
        }
        
        // Premium Beleg
        function generatePremiumReceipt() {
            // Set background color
            doc.setFillColor(244, 238, 230);
            doc.rect(0, 0, pageWidth, pageHeight, 'F');
            
            // Draw decorative border
            doc.setDrawColor(197, 164, 126);
            doc.setLineWidth(0.5);
            doc.rect(10, 10, pageWidth - 20, pageHeight - 20);
            
            yPos = 25;
            
            // Header with logo
            doc.setFontSize(20);
            doc.setTextColor(139, 107, 76);
            doc.setFont(undefined, 'bold');
            doc.text("★ GITTERTIER PRO ★", pageWidth / 2, yPos, null, 'center');
            yPos += 8;
            
            doc.setFontSize(14);
            doc.text("PREMIUM BELEG", pageWidth / 2, yPos, null, 'center');
            yPos += 15;
            
            // Customer details in an elegant box
            doc.setFillColor(255, 255, 255);
            doc.setDrawColor(197, 164, 126);
            doc.roundedRect(20, yPos, pageWidth - 40, 30, 3, 3, 'FD');
            
            doc.setFontSize(11);
            doc.setTextColor(90, 74, 58);
            doc.text(`Kunde: ${paymentData.customerName}`, 25, yPos + 8);
            doc.text(`Beleg: ${shortPaymentId}`, pageWidth - 25, yPos + 8, null, 'right');
            doc.text(`Zahlungsart: ${selectedPaymentMethod === 'cash' ? 'Bar' : 'Karte'}`, 25, yPos + 18);
            doc.text(`${paymentDate} ${paymentTime}`, pageWidth - 25, yPos + 18, null, 'right');
            
            yPos += 40;
            
            // Items table with elegant styling
            doc.setFontSize(12);
            doc.setTextColor(90, 74, 58);
            doc.setFont(undefined, 'bold');
            doc.text("ARTIKEL", 25, yPos);
            doc.text("EINZELPREIS", pageWidth / 2 - 20, yPos);
            doc.text("MENGE", pageWidth / 2 + 15, yPos);
            doc.text("GESAMT", pageWidth - 25, yPos, null, 'right');
            yPos += 8;
            
            doc.setDrawColor(214, 200, 181);
            doc.line(25, yPos, pageWidth - 25, yPos);
            yPos += 10;
            
            doc.setFont(undefined, 'normal');
            doc.setFontSize(11);
            paymentData.items.forEach((item) => {
                if (yPos > pageHeight - 80) {
                    doc.addPage();
                    yPos = 25;
                    
                    // Draw decorative border on new page
                    doc.setDrawColor(197, 164, 126);
                    doc.rect(10, 10, pageWidth - 20, pageHeight - 20);
                }
                
                doc.setTextColor(90, 74, 58);
                doc.text(item.name, 25, yPos);
                doc.text(`€ ${item.price.toFixed(2)}`, pageWidth / 2 - 20, yPos);
                doc.text(`${item.quantity}x`, pageWidth / 2 + 15, yPos);
                doc.text(`€ ${(item.quantity * item.price).toFixed(2)}`, pageWidth - 25, yPos, null, 'right');
                yPos += 8;
            });
            
            // Discounts and additional costs
            if (appliedCoupon || loyaltyDiscount > 0 || selectedDeliveryOption === 'home-delivery' || 
                selectedBaggingOption !== 'own' || selectedDonationOption !== 'none') {
                
                if (yPos > pageHeight - 100) {
                    doc.addPage();
                    yPos = 25;
                    doc.setDrawColor(197, 164, 126);
                    doc.rect(10, 10, pageWidth - 20, pageHeight - 20);
                }
                
                yPos += 10;
                doc.setDrawColor(214, 200, 181);
                doc.line(25, yPos, pageWidth - 25, yPos);
                yPos += 10;
                
                doc.setFont(undefined, 'bold');
                doc.setTextColor(139, 107, 76);
                doc.text("ZUSATZKOSTEN & RABATTE", 25, yPos);
                yPos += 10;
                doc.setFont(undefined, 'normal');
                
                // Coupon discount
                if (appliedCoupon) {
                    doc.setTextColor(22, 163, 74);
                    let discountText = '';
                    
                    if (appliedCoupon.type === 'percent') {
                        discountText = `Rabatt (${appliedCoupon.code}): -${appliedCoupon.discount}%`;
                    } else {
                        discountText = `Rabatt (${appliedCoupon.code}): -€ ${appliedCoupon.discount.toFixed(2)}`;
                    }
                    
                    doc.text(discountText, pageWidth - 25, yPos, null, 'right');
                    yPos += 8;
                }
                
                // Loyalty discount
                if (loyaltyDiscount > 0) {
                    doc.setTextColor(22, 163, 74);
                    doc.text(`Treuepunkte Rabatt: -€ ${loyaltyDiscount.toFixed(2)}`, pageWidth - 25, yPos, null, 'right');
                    yPos += 8;
                }
                
                // Delivery cost
                if (selectedDeliveryOption === 'home-delivery') {
                    doc.setTextColor(90, 74, 58);
                    doc.text(`Lieferung nach Hause: +€ 4,99`, pageWidth - 25, yPos, null, 'right');
                    yPos += 8;
                }
                
                // Bagging cost
                if (selectedBaggingOption === 'standard') {
                    doc.setTextColor(90, 74, 58);
                    doc.text(`Standard Tüten (2x): +€ 0,40`, pageWidth - 25, yPos, null, 'right');
                    yPos += 8;
                } else if (selectedBaggingOption === 'premium') {
                    doc.setTextColor(90, 74, 58);
                    doc.text(`Premium Verpackung: +€ 1,50`, pageWidth - 25, yPos, null, 'right');
                    yPos += 8;
                }
                
                // Donation
                if (selectedDonationOption !== 'none') {
                    doc.setTextColor(90, 74, 58);
                    let donationOrg = '';
                    if (selectedDonationOption === '1') {
                        donationOrg = ' (Lebensmittelbank)';
                    } else if (selectedDonationOption === '2') {
                        donationOrg = ' (Tafel)';
                    }
                    
                    doc.text(`Spende${donationOrg}: +€ ${parseFloat(selectedDonationOption).toFixed(2)}`, pageWidth - 25, yPos, null, 'right');
                    yPos += 8;
                }
            }
            
            // Total
            if (yPos > pageHeight - 60) {
                doc.addPage();
                yPos = 25;
                doc.setDrawColor(197, 164, 126);
                doc.rect(10, 10, pageWidth - 20, pageHeight - 20);
            }
            
            yPos += 10;
            doc.setDrawColor(139, 107, 76);
            doc.setLineWidth(0.8);
            doc.line(25, yPos, pageWidth - 25, yPos);
            yPos += 10;
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(139, 107, 76);
            doc.text("GESAMTSUMME:", 25, yPos);
            doc.text(`€ ${paymentData.finalTotal.toFixed(2)}`, pageWidth - 25, yPos, null, 'right');
            yPos += 15;
            
            // Loyalty details
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(90, 74, 58);
            
            if (isLoyaltyMember) {
                doc.setFillColor(255, 255, 255);
                doc.setDrawColor(197, 164, 126);
                doc.roundedRect(25, yPos, pageWidth - 50, 40, 3, 3, 'FD');
                
                doc.text("TREUEPROGRAMM DETAILS", 30, yPos + 8);
                
                if (loyaltyPointsToRedeem > 0) {
                    doc.text(`Eingelöste Punkte: ${loyaltyPointsToRedeem}`, 30, yPos + 16);
                }
                
                doc.text(`Erworbene Punkte: +${loyaltyPointsEarned}`, pageWidth / 2, yPos + 16);
                
                const newPoints = loyaltyPoints - loyaltyPointsToRedeem + loyaltyPointsEarned;
                doc.text(`Neuer Punktestand: ${newPoints}`, 30, yPos + 24);
                doc.text(`Status: ${capitalizeFirstLetter(loyaltyTier)}`, pageWidth / 2, yPos + 24);
                
                yPos += 50;
            } else {
                doc.text(`Erworbene Punkte (bei Anmeldung): +${loyaltyPointsEarned}`, 25, yPos);
                yPos += 10;
            }
            
            // Thank you message
            doc.setFontSize(10);
            doc.setTextColor(139, 107, 76);
            doc.setFont(undefined, 'italic');
            doc.text("Vielen Dank für Ihren Einkauf bei Gittertier Pro!", pageWidth / 2, pageHeight - 20, null, 'center');
        }
        
        // Gold Beleg (for Gold tier members)
        function generateGoldReceipt() {
            // Gold gradient background
            const gradient = doc.createLinearGradient(0, 0, pageWidth, pageHeight);
            gradient.addColorStop(0, "#f4e8c6");
            gradient.addColorStop(1, "#ffffff");
            doc.setFillColor(gradient);
            doc.rect(0, 0, pageWidth, pageHeight, 'F');
            
            // Gold border
            doc.setDrawColor(255, 215, 0);
            doc.setLineWidth(1);
            doc.rect(10, 10, pageWidth - 20, pageHeight - 20);
            
            yPos = 25;
            
            // Gold header
            doc.setFontSize(22);
            doc.setTextColor(139, 117, 0);
            doc.setFont(undefined, 'bold');
            doc.text("✦ GITTERTIER GOLD ✦", pageWidth / 2, yPos, null, 'center');
            yPos += 10;
            
            doc.setFontSize(16);
            doc.text("EXKLUSIVER GOLD BELEG", pageWidth / 2, yPos, null, 'center');
            yPos += 20;
            
            // Customer details in gold box
            doc.setFillColor(255, 250, 240);
            doc.setDrawColor(255, 215, 0);
            doc.roundedRect(20, yPos, pageWidth - 40, 35, 5, 5, 'FD');
            
            doc.setFontSize(12);
            doc.setTextColor(139, 117, 0);
            doc.text(`Gold-Mitglied: ${paymentData.customerName}`, 25, yPos + 10);
            doc.text(`Beleg: ${shortPaymentId}`, pageWidth - 25, yPos + 10, null, 'right');
            doc.text(`Zahlungsart: ${selectedPaymentMethod === 'cash' ? 'Bar' : 'Karte'}`, 25, yPos + 22);
            doc.text(`${paymentDate} ${paymentTime}`, pageWidth - 25, yPos + 22, null, 'right');
            
            yPos += 45;
            
            // Items table with gold accents
            doc.setFontSize(13);
            doc.setTextColor(139, 117, 0);
            doc.setFont(undefined, 'bold');
            doc.text("ARTIKEL", 25, yPos);
            doc.text("EINZEL", pageWidth / 2 - 20, yPos);
            doc.text("MENGE", pageWidth / 2 + 10, yPos);
            doc.text("GESAMT", pageWidth - 25, yPos, null, 'right');
            yPos += 8;
            
            doc.setDrawColor(255, 215, 0);
            doc.line(25, yPos, pageWidth - 25, yPos);
            yPos += 12;
            
            doc.setFont(undefined, 'normal');
            doc.setFontSize(12);
            paymentData.items.forEach((item) => {
                if (yPos > pageHeight - 80) {
                    doc.addPage();
                    yPos = 25;
                    
                    // Gold border on new page
                    doc.setDrawColor(255, 215, 0);
                    doc.rect(10, 10, pageWidth - 20, pageHeight - 20);
                }
                
                doc.setTextColor(90, 75, 40);
                doc.text(item.name, 25, yPos);
                doc.text(`€ ${item.price.toFixed(2)}`, pageWidth / 2 - 20, yPos);
                doc.text(`${item.quantity}x`, pageWidth / 2 + 10, yPos);
                doc.text(`€ ${(item.quantity * item.price).toFixed(2)}`, pageWidth - 25, yPos, null, 'right');
                yPos += 9;
            });
            
            // Discounts and additional costs
            if (appliedCoupon || loyaltyDiscount > 0 || selectedDeliveryOption === 'home-delivery' || 
                selectedBaggingOption !== 'own' || selectedDonationOption !== 'none') {
                
                if (yPos > pageHeight - 100) {
                    doc.addPage();
                    yPos = 25;
                    doc.setDrawColor(255, 215, 0);
                    doc.rect(10, 10, pageWidth - 20, pageHeight - 20);
                }
                
                yPos += 12;
                doc.setDrawColor(255, 215, 0);
                doc.line(25, yPos, pageWidth - 25, yPos);
                yPos += 12;
                
                doc.setFont(undefined, 'bold');
                doc.setTextColor(139, 117, 0);
                doc.text("RABATTE & ZUSATZKOSTEN", 25, yPos);
                yPos += 12;
                doc.setFont(undefined, 'normal');
                
                // Coupon discount
                if (appliedCoupon) {
                    doc.setTextColor(22, 163, 74);
                    let discountText = '';
                    
                    if (appliedCoupon.type === 'percent') {
                        discountText = `Rabatt (${appliedCoupon.code}): -${appliedCoupon.discount}%`;
                    } else {
                        discountText = `Rabatt (${appliedCoupon.code}): -€ ${appliedCoupon.discount.toFixed(2)}`;
                    }
                    
                    doc.text(discountText, pageWidth - 25, yPos, null, 'right');
                    yPos += 9;
                }
                
                // Loyalty discount
                if (loyaltyDiscount > 0) {
                    doc.setTextColor(22, 163, 74);
                    doc.text(`Treuepunkte Rabatt: -€ ${loyaltyDiscount.toFixed(2)}`, pageWidth - 25, yPos, null, 'right');
                    yPos += 9;
                }
                
                // Delivery cost
                if (selectedDeliveryOption === 'home-delivery') {
                    doc.setTextColor(90, 75, 40);
                    doc.text(`Lieferung: +€ 4,99`, pageWidth - 25, yPos, null, 'right');
                    yPos += 9;
                }
                
                // Bagging cost
                if (selectedBaggingOption === 'standard') {
                    doc.setTextColor(90, 75, 40);
                    doc.text(`Tüten: +€ 0,40`, pageWidth - 25, yPos, null, 'right');
                    yPos += 9;
                } else if (selectedBaggingOption === 'premium') {
                    doc.setTextColor(90, 75, 40);
                    doc.text(`Premium Verpackung: +€ 1,50`, pageWidth - 25, yPos, null, 'right');
                    yPos += 9;
                }
                
                // Donation
                if (selectedDonationOption !== 'none') {
                    doc.setTextColor(90, 75, 40);
                    doc.text(`Spende: +€ ${parseFloat(selectedDonationOption).toFixed(2)}`, pageWidth - 25, yPos, null, 'right');
                    yPos += 9;
                }
            }
            
            // Total
            if (yPos > pageHeight - 60) {
                doc.addPage();
                yPos = 25;
                doc.setDrawColor(255, 215, 0);
                doc.rect(10, 10, pageWidth - 20, pageHeight - 20);
            }
            
            yPos += 12;
            doc.setDrawColor(139, 117, 0);
            doc.setLineWidth(1);
            doc.line(25, yPos, pageWidth - 25, yPos);
            yPos += 12;
            
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(139, 117, 0);
            doc.text("GESAMTSUMME:", 25, yPos);
            doc.text(`€ ${paymentData.finalTotal.toFixed(2)}`, pageWidth - 25, yPos, null, 'right');
            yPos += 18;
            
            // Gold member benefits summary
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(90, 75, 40);
            
            doc.setFillColor(255, 250, 240);
            doc.setDrawColor(255, 215, 0);
            doc.roundedRect(25, yPos, pageWidth - 50, 50, 5, 5, 'FD');
            
            doc.text("GOLD MITGLIEDSCHAFTSVORTEILE", 30, yPos + 10);
            doc.text(`Ersparnis durch Gold-Status: € ${(paymentData.finalTotal * 0.1).toFixed(2)}`, 30, yPos + 20);
            doc.text(`Erworbene Punkte: +${loyaltyPointsEarned}`, 30, yPos + 30);
            doc.text(`Aktuelle Treuepunkte: ${loyaltyPoints - loyaltyPointsToRedeem + loyaltyPointsEarned}`, 30, yPos + 40);
            
            yPos += 60;
            
            // Gold seal
            const sealX = pageWidth - 40;
            const sealY = pageHeight - 40;
            doc.setFillColor(255, 215, 0);
            doc.circle(sealX, sealY, 15, 'F');
            doc.setFontSize(8);
            doc.setTextColor(139, 117, 0);
            doc.text("GOLD", sealX, sealY - 2, null, 'center');
            doc.text("MEMBER", sealX, sealY + 4, null, 'center');
            
            // Thank you message
            doc.setFontSize(11);
            doc.setTextColor(139, 117, 0);
            doc.setFont(undefined, 'italic');
            doc.text("Vielen Dank für Ihren Einkauf als Gold-Mitglied!", pageWidth / 2, pageHeight - 20, null, 'center');
        }
        
        // Platinum Beleg (for Platinum tier members)
        function generatePlatinumReceipt() {
            // Platinum gradient background
            const gradient = doc.createLinearGradient(0, 0, pageWidth, pageHeight);
            gradient.addColorStop(0, "#e5e4e2");
            gradient.addColorStop(1, "#ffffff");
            doc.setFillColor(gradient);
            doc.rect(0, 0, pageWidth, pageHeight, 'F');
            
            // Platinum border
            doc.setDrawColor(185, 242, 255);
            doc.setLineWidth(1);
            doc.rect(10, 10, pageWidth - 20, pageHeight - 20);
            
            yPos = 25;
            
            // Platinum header
            doc.setFontSize(24);
            doc.setTextColor(0, 102, 166);
            doc.setFont(undefined, 'bold');
            doc.text("✧ GITTERTIER PLATINUM ✧", pageWidth / 2, yPos, null, 'center');
            yPos += 10;
            
            doc.setFontSize(18);
            doc.text("EXKLUSIVER PLATINUM BELEG", pageWidth / 2, yPos, null, 'center');
            yPos += 20;
            
            // Customer details in platinum box
            doc.setFillColor(240, 248, 255);
            doc.setDrawColor(185, 242, 255);
            doc.roundedRect(20, yPos, pageWidth - 40, 35, 5, 5, 'FD');
            
            doc.setFontSize(12);
            doc.setTextColor(0, 102, 166);
            doc.text(`Platinum-Mitglied: ${paymentData.customerName}`, 25, yPos + 10);
            doc.text(`Beleg: ${shortPaymentId}`, pageWidth - 25, yPos + 10, null, 'right');
            doc.text(`Zahlungsart: ${selectedPaymentMethod === 'cash' ? 'Bar' : 'Karte'}`, 25, yPos + 22);
            doc.text(`${paymentDate} ${paymentTime}`, pageWidth - 25, yPos + 22, null, 'right');
            
            yPos += 45;
            
            // Items table with platinum accents
            doc.setFontSize(13);
            doc.setTextColor(0, 102, 166);
            doc.setFont(undefined, 'bold');
            doc.text("ARTIKEL", 25, yPos);
            doc.text("EINZEL", pageWidth / 2 - 20, yPos);
            doc.text("MENGE", pageWidth / 2 + 10, yPos);
            doc.text("GESAMT", pageWidth - 25, yPos, null, 'right');
            yPos += 8;
            
            doc.setDrawColor(185, 242, 255);
            doc.line(25, yPos, pageWidth - 25, yPos);
            yPos += 12;
            
            doc.setFont(undefined, 'normal');
            doc.setFontSize(12);
            paymentData.items.forEach((item) => {
                if (yPos > pageHeight - 80) {
                    doc.addPage();
                    yPos = 25;
                    
                    // Platinum border on new page
                    doc.setDrawColor(185, 242, 255);
                    doc.rect(10, 10, pageWidth - 20, pageHeight - 20);
                }
                
                doc.setTextColor(47, 79, 79);
                doc.text(item.name, 25, yPos);
                doc.text(`€ ${item.price.toFixed(2)}`, pageWidth / 2 - 20, yPos);
                doc.text(`${item.quantity}x`, pageWidth / 2 + 10, yPos);
                doc.text(`€ ${(item.quantity * item.price).toFixed(2)}`, pageWidth - 25, yPos, null, 'right');
                yPos += 9;
            });
            
            // Discounts and additional costs
            if (appliedCoupon || loyaltyDiscount > 0 || selectedDeliveryOption === 'home-delivery' || 
                selectedBaggingOption !== 'own' || selectedDonationOption !== 'none') {
                
                if (yPos > pageHeight - 100) {
                    doc.addPage();
                    yPos = 25;
                    doc.setDrawColor(185, 242, 255);
                    doc.rect(10, 10, pageWidth - 20, pageHeight - 20);
                }
                
                yPos += 12;
                doc.setDrawColor(185, 242, 255);
                doc.line(25, yPos, pageWidth - 25, yPos);
                yPos += 12;
                
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 102, 166);
                doc.text("RABATTE & ZUSATZKOSTEN", 25, yPos);
                yPos += 12;
                doc.setFont(undefined, 'normal');
                
                // Coupon discount
                if (appliedCoupon) {
                    doc.setTextColor(22, 163, 74);
                    let discountText = '';
                    
                    if (appliedCoupon.type === 'percent') {
                        discountText = `Rabatt (${appliedCoupon.code}): -${appliedCoupon.discount}%`;
                    } else {
                        discountText = `Rabatt (${appliedCoupon.code}): -€ ${appliedCoupon.discount.toFixed(2)}`;
                    }
                    
                    doc.text(discountText, pageWidth - 25, yPos, null, 'right');
                    yPos += 9;
                }
                
                // Loyalty discount
                if (loyaltyDiscount > 0) {
                    doc.setTextColor(22, 163, 74);
                    doc.text(`Treuepunkte Rabatt: -€ ${loyaltyDiscount.toFixed(2)}`, pageWidth - 25, yPos, null, 'right');
                    yPos += 9;
                }
                
                // Delivery cost
                if (selectedDeliveryOption === 'home-delivery') {
                    doc.setTextColor(47, 79, 79);
                    doc.text(`Lieferung: +€ 4,99`, pageWidth - 25, yPos, null, 'right');
                    yPos += 9;
                }
                
                // Bagging cost
                if (selectedBaggingOption === 'standard') {
                    doc.setTextColor(47, 79, 79);
                    doc.text(`Tüten: +€ 0,40`, pageWidth - 25, yPos, null, 'right');
                    yPos += 9;
                } else if (selectedBaggingOption === 'premium') {
                    doc.setTextColor(47, 79, 79);
                    doc.text(`Premium Verpackung: +€ 1,50`, pageWidth - 25, yPos, null, 'right');
                    yPos += 9;
                }
                
                // Donation
                if (selectedDonationOption !== 'none') {
                    doc.setTextColor(47, 79, 79);
                    doc.text(`Spende: +€ ${parseFloat(selectedDonationOption).toFixed(2)}`, pageWidth - 25, yPos, null, 'right');
                    yPos += 9;
                }
            }
            
            // Total
            if (yPos > pageHeight - 60) {
                doc.addPage();
                yPos = 25;
                doc.setDrawColor(185, 242, 255);
                doc.rect(10, 10, pageWidth - 20, pageHeight - 20);
            }
            
            yPos += 12;
            doc.setDrawColor(0, 102, 166);
            doc.setLineWidth(1);
            doc.line(25, yPos, pageWidth - 25, yPos);
            yPos += 12;
            
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(0, 102, 166);
            doc.text("GESAMTSUMME:", 25, yPos);
            doc.text(`€ ${paymentData.finalTotal.toFixed(2)}`, pageWidth - 25, yPos, null, 'right');
            yPos += 18;
            
            // Platinum member benefits summary
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(47, 79, 79);
            
            doc.setFillColor(240, 248, 255);
            doc.setDrawColor(185, 242, 255);
            doc.roundedRect(25, yPos, pageWidth - 50, 50, 5, 5, 'FD');
            
            doc.text("PLATINUM MITGLIEDSCHAFTSVORTEILE", 30, yPos + 10);
            doc.text(`Ersparnis durch Platinum-Status: € ${(paymentData.finalTotal * 0.15).toFixed(2)}`, 30, yPos + 20);
            doc.text(`Erworbene Punkte: +${loyaltyPointsEarned}`, 30, yPos + 30);
            doc.text(`Aktuelle Treuepunkte: ${loyaltyPoints - loyaltyPointsToRedeem + loyaltyPointsEarned}`, 30, yPos + 40);
            
            yPos += 60;
            
            // Platinum seal
            const sealX = pageWidth - 40;
            const sealY = pageHeight - 40;
            doc.setFillColor(185, 242, 255);
            doc.circle(sealX, sealY, 15, 'F');
            doc.setFontSize(8);
            doc.setTextColor(0, 102, 166);
            doc.text("PLATINUM", sealX, sealY - 2, null, 'center');
            doc.text("MEMBER", sealX, sealY + 4, null, 'center');
            
            // Thank you message
            doc.setFontSize(11);
            doc.setTextColor(0, 102, 166);
            doc.setFont(undefined, 'italic');
            doc.text("Vielen Dank für Ihren Einkauf als Platinum-Mitglied!", pageWidth / 2, pageHeight - 20, null, 'center');
        }
        
        // Draw header function for receipts
        function drawHeader() {
            let y = 15;
            doc.setFontSize(10);
            doc.setTextColor(107, 114, 128);
            doc.setFont(undefined, 'normal');
            doc.text("Gittertier Pro Supermarkt", pageWidth / 2, y, null, 'center');
            y += 5;
            doc.text("Musterstraße 123, 12345 Musterstadt", pageWidth / 2, y, null, 'center');
            y += 5;
            doc.text("Tel: 01234 567890 | www.gittertier-pro.de", pageWidth / 2, y, null, 'center');
            return y + 10;
        }
        
        // Generate the selected receipt format
        switch(receiptFormat) {
            case 'simple':
                generateSimpleReceipt();
                break;
            case 'compact':
                generateCompactReceipt();
                break;
            case 'detailed':
                generateDetailedReceipt();
                break;
            case 'premium':
                generatePremiumReceipt();
                break;
            case 'gold':
                generateGoldReceipt();
                break;
            case 'platinum':
                generatePlatinumReceipt();
                break;
            default:
                generateCompactReceipt();
        }
        
        // Save the PDF
        doc.save(`Gittertier_Beleg_${shortPaymentId}.pdf`);
    }
    
    // Add event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize payment
        initPayment();
        
        // Add event listener for edit button
        document.getElementById('edit-details-btn').addEventListener('click', editPaymentDetails);
        
        // Add event listener for step 1 cancel button
        document.getElementById('step1-cancel-btn').addEventListener('click', function() {
            if (infoModalOpenedManually) {
                closeModal('payment-modal');
            } else {
                window.location.href = 'index';
            }
        });
    });
</script>
</body>
</html>