<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treuepunkte - Gittertier Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    :root {
        --color-bg: #ffffff;
        --color-text: #111111;
        --color-text-muted: #6b7280;
        --color-border: #e5e7eb;
        --color-accent: #2563eb;
        --color-accent-hover: #1d4ed8;
        --color-success: #16a34a;
        --color-error: #dc2626;
        --color-warning: #f59e0b;
        --color-warning-bg: #fffbeb;
        --color-warning-border: #fcd34d;
        --color-overlay: rgba(0, 0, 0, 0.5);
        --color-premium: #c5a47e;
        --color-premium-dark: #8b6b4c;
        --color-premium-light: #f4eee6;
        
        /* Loyalty Program Colors */
        --color-bronze: #cd7f32;
        --color-silver: #c0c0c0;
        --color-gold: #ffd700;
        --color-platinum: #e5e4e2;
        --color-diamond: #b9f2ff;
        --color-loyalty-primary: #7e22ce;
        --color-loyalty-secondary: #a855f7;
        --color-loyalty-light: #f3e8ff;
        
        --radius: 12px;
        --radius-sm: 6px;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.07), 0 1px 2px rgba(0, 0, 0, 0.04);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --focus-ring: 0 0 0 3px rgba(37, 99, 235, 0.35);
        
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;
        --spacing-xxl: 48px;
        
        --transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
        --transition-slow: all 0.3s cubic-bezier(0.2, 0, 0, 1);
        
        --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, "Helvetica Neue", Arial, sans-serif;
        --text-xs: 0.75rem;
        --text-sm: 0.875rem;
        --text-base: 1rem;
        --text-lg: 1.125rem;
        --text-xl: 1.25rem;
        --text-2xl: 1.5rem;
        --text-3xl: 1.875rem;
        
        --header-height: 64px;
        --footer-height: 80px;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: var(--font-family);
        background-color: var(--color-bg);
        color: var(--color-text);
        line-height: 1.5;
        min-height: 100vh;
        padding-bottom: var(--footer-height);
        background: linear-gradient(135deg, #f3e8ff 0%, #f0f9ff 100%);
    }

    /* Header Styles */
    header {
        height: var(--header-height);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 var(--spacing-lg);
        border-bottom: 1px solid var(--color-border);
        background-color: var(--color-bg);
        position: sticky;
        top: 0;
        z-index: 50;
    }

    .logo {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        font-weight: 700;
        font-size: var(--text-xl);
    }

    .logo i {
        font-size: var(--text-xl);
        color: var(--color-accent);
    }

    .header-controls {
        display: flex;
        gap: var(--spacing-md);
        align-items: center;
    }

    .control-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--spacing-xs);
        background: none;
        border: none;
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        color: var(--color-text-muted);
        font-size: var(--text-xs);
        cursor: pointer;
        transition: var(--transition);
        flex: 1;
        min-width: 60px;
    }

    .control-btn:hover {
        background-color: #f9fafb;
        color: var(--color-text);
    }

    .control-btn:focus {
        outline: none;
        box-shadow: var(--focus-ring);
    }

    .control-btn i {
        font-size: var(--text-lg);
    }

    /* Main Content */
    main {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--spacing-xl) var(--spacing-lg);
    }

    .page-title {
        font-size: var(--text-3xl);
        font-weight: 700;
        margin-bottom: var(--spacing-xl);
        text-align: center;
        color: var(--color-loyalty-primary);
        background: linear-gradient(135deg, var(--color-loyalty-primary) 0%, var(--color-loyalty-secondary) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .loyalty-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
    }

    @media (max-width: 968px) {
        .loyalty-grid {
            grid-template-columns: 1fr;
        }
    }

    .loyalty-card {
        background: var(--color-bg);
        border-radius: var(--radius);
        border: 1px solid var(--color-border);
        box-shadow: var(--shadow);
        padding: var(--spacing-xl);
        position: relative;
        overflow: hidden;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
    }

    .card-title {
        font-size: var(--text-xl);
        font-weight: 600;
        color: var(--color-text);
    }

    .card-icon {
        font-size: var(--text-2xl);
        color: var(--color-loyalty-primary);
    }

    /* Points Overview */
    .points-display {
        text-align: center;
        margin-bottom: var(--spacing-lg);
    }

    .points-value {
        font-size: 4rem;
        font-weight: 800;
        color: var(--color-loyalty-primary);
        line-height: 1;
        margin: var(--spacing-md) 0;
        text-shadow: 0 2px 4px rgba(126, 34, 206, 0.1);
    }

    .points-label {
        font-size: var(--text-lg);
        color: var(--color-text-muted);
    }

    .tier-display {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        margin: var(--spacing-lg) 0;
    }

    .tier-badge {
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: 100px;
        font-weight: 700;
        font-size: var(--text-sm);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .tier-bronze {
        background-color: var(--color-bronze);
        color: white;
    }

    .tier-silver {
        background-color: var(--color-silver);
        color: #333;
    }

    .tier-gold {
        background-color: var(--color-gold);
        color: #333;
    }

    .tier-platinum {
        background-color: var(--color-platinum);
        color: #333;
    }

    .tier-diamond {
        background: linear-gradient(135deg, var(--color-diamond) 0%, #b9f2ff 100%);
        color: #0066a6;
    }

    .progress-container {
        margin: var(--spacing-lg) 0;
    }

    .progress-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--spacing-xs);
        font-size: var(--text-sm);
    }

    .progress-bar {
        height: 12px;
        background-color: #e5e7eb;
        border-radius: 100px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--color-loyalty-primary), var(--color-loyalty-secondary));
        border-radius: 100px;
        transition: width 0.5s ease;
        position: relative;
    }

    .progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        background-image: linear-gradient(
            -45deg,
            rgba(255, 255, 255, 0.2) 25%,
            transparent 25%,
            transparent 50%,
            rgba(255, 255, 255, 0.2) 50%,
            rgba(255, 255, 255, 0.2) 75%,
            transparent 75%,
            transparent
        );
        z-index: 1;
        background-size: 20px 20px;
        animation: move 1s linear infinite;
    }

    @keyframes move {
        0% {
            background-position: 0 0;
        }
        100% {
            background-position: 20px 0;
        }
    }

    /* Rewards Section */
    .rewards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: var(--spacing-md);
        margin-top: var(--spacing-lg);
    }

    .reward-card {
        background: white;
        border-radius: var(--radius);
        padding: var(--spacing-lg);
        border: 1px solid var(--color-border);
        transition: var(--transition);
        cursor: pointer;
        display: flex;
        flex-direction: column;
    }

    .reward-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-md);
        border-color: var(--color-loyalty-primary);
    }

    .reward-card.featured {
        border: 2px solid var(--color-gold);
        position: relative;
        overflow: hidden;
    }

    .reward-card.featured::before {
        content: 'EMPFEHLUNG';
        position: absolute;
        top: 10px;
        right: -30px;
        background: var(--color-gold);
        color: #333;
        font-size: var(--text-xs);
        font-weight: 700;
        padding: 4px 30px;
        transform: rotate(45deg);
    }

    .reward-icon {
        font-size: 2.5rem;
        color: var(--color-loyalty-primary);
        margin-bottom: var(--spacing-md);
        text-align: center;
    }

    .reward-title {
        font-weight: 600;
        font-size: var(--text-lg);
        margin-bottom: var(--spacing-xs);
        color: var(--color-loyalty-primary);
    }

    .reward-description {
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        margin-bottom: var(--spacing-md);
        flex-grow: 1;
    }

    .reward-cost {
        font-weight: 700;
        color: var(--color-loyalty-primary);
        text-align: center;
        padding: var(--spacing-sm);
        background: var(--color-loyalty-light);
        border-radius: var(--radius-sm);
    }

    .reward-action {
        margin-top: var(--spacing-md);
        background: linear-gradient(135deg, var(--color-loyalty-primary) 0%, var(--color-loyalty-secondary) 100%);
        color: white;
        border: none;
        padding: var(--spacing-sm);
        border-radius: var(--radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
    }

    .reward-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(126, 34, 206, 0.3);
    }

    .reward-action:disabled {
        background: var(--color-border);
        color: var(--color-text-muted);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    /* Statistics Section */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--spacing-md);
        margin-top: var(--spacing-lg);
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }

    .stat-card {
        background: white;
        border-radius: var(--radius);
        padding: var(--spacing-lg);
        border: 1px solid var(--color-border);
        text-align: center;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--color-loyalty-primary);
        margin: var(--spacing-sm) 0;
    }

    .stat-label {
        font-size: var(--text-sm);
        color: var(--color-text-muted);
    }

    .chart-container {
        margin-top: var(--spacing-xl);
        height: 300px;
        position: relative;
    }

    /* Transactions Section */
    .transactions-list {
        margin-top: var(--spacing-lg);
    }

    .transaction-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md);
        border-bottom: 1px solid var(--color-border);
    }

    .transaction-item:last-child {
        border-bottom: none;
    }

    .transaction-details {
        display: flex;
        flex-direction: column;
    }

    .transaction-title {
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
    }

    .transaction-date {
        font-size: var(--text-sm);
        color: var(--color-text-muted);
    }

    .transaction-points {
        font-weight: 700;
        font-size: var(--text-lg);
    }

    .points-earned {
        color: var(--color-success);
    }

    .points-spent {
        color: var(--color-error);
    }

    /* Coupons Section */
    .coupons-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: var(--spacing-md);
        margin-top: var(--spacing-lg);
    }

    .coupon-card {
        background: white;
        border-radius: var(--radius);
        padding: var(--spacing-lg);
        border: 1px solid var(--color-border);
        transition: var(--transition);
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
    }

    .coupon-card.upcoming {
        border-left: 4px solid var(--color-success);
    }

    .coupon-card.expiring {
        border-left: 4px solid var(--color-warning);
    }

    .coupon-badge {
        position: absolute;
        top: 10px;
        right: -25px;
        padding: 4px 30px;
        font-size: var(--text-xs);
        font-weight: 700;
        transform: rotate(45deg);
    }

    .upcoming .coupon-badge {
        background: var(--color-success);
        color: white;
    }

    .expiring .coupon-badge {
        background: var(--color-warning);
        color: #333;
    }

    .coupon-title {
        font-weight: 600;
        font-size: var(--text-lg);
        margin-bottom: var(--spacing-xs);
        color: var(--color-loyalty-primary);
    }

    .coupon-code {
        font-family: monospace;
        background: #f3f4f6;
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--radius-sm);
        margin: var(--spacing-sm) 0;
        display: inline-block;
        font-weight: 700;
        color: var(--color-text);
    }

    .coupon-description {
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        margin-bottom: var(--spacing-sm);
        flex-grow: 1;
    }

    .coupon-expiry {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        margin-top: var(--spacing-sm);
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--color-overlay);
        z-index: 100;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-lg);
    }

    .modal-content {
        background-color: var(--color-bg);
        border-radius: var(--radius);
        padding: var(--spacing-xl);
        width: 100%;
        max-width: 500px;
        box-shadow: var(--shadow-md);
        animation: scaleIn 0.3s cubic-bezier(0.2, 0, 0, 1);
        text-align: center;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
    }

    .modal-icon {
        font-size: 3rem;
        margin-bottom: var(--spacing-lg);
    }

    .modal-title {
        font-weight: 600;
        font-size: var(--text-xl);
        margin-bottom: var(--spacing-md);
    }

    .modal-message {
        color: var(--color-text-muted);
        margin-bottom: var(--spacing-xl);
    }

    .modal-actions {
        display: flex;
        gap: var(--spacing-md);
        justify-content: center;
    }

    .modal-btn {
        padding: var(--spacing-md) var(--spacing-lg);
        border-radius: var(--radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
    }

    .modal-btn.primary {
        background-color: var(--color-loyalty-primary);
        color: white;
        border: none;
    }

    .modal-btn.primary:hover {
        background-color: var(--color-loyalty-secondary);
    }

    .modal-btn.secondary {
        background-color: transparent;
        border: 1px solid var(--color-border);
        color: var(--color-text-muted);
    }

    .modal-btn.secondary:hover {
        background-color: #f9fafb;
        color: var(--color-text);
    }

    /* Animation Keyframes */
    @keyframes scaleIn {
        from { transform: scale(0.95); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    /* Confetti animation */
    .confetti-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1000;
        display: none;
    }

    .confetti {
        position: absolute;
        width: 10px;
        height: 10px;
        background-color: var(--color-loyalty-primary);
        opacity: 0.7;
        animation: confetti 5s ease-in-out forwards;
    }

    .confetti:nth-child(2n) {
        background-color: var(--color-loyalty-secondary);
    }

    .confetti:nth-child(3n) {
        background-color: var(--color-gold);
    }

    .confetti:nth-child(4n) {
        background-color: var(--color-premium);
    }

    @keyframes confetti {
        0% { transform: translateY(0) rotate(0); opacity: 1; }
        100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
        :root {
            --color-bg: #111827;
            --color-text: #f3f4f6;
            --color-text-muted: #9ca3af;
            --color-border: #374151;
        }
        
        body {
            background: linear-gradient(135deg, #1f1235 0%, #1e2b45 100%);
        }
        
        .loyalty-card, .stat-card, .reward-card, .coupon-card {
            background-color: #1f2937;
            border-color: var(--color-border);
        }
        
        .reward-cost, .coupon-code {
            background-color: #374151;
        }
    }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <i class="fas fa-crown"></i>
            <span>Gittertier Pro</span>
        </div>
        <div class="header-controls">
            <button class="control-btn" onclick="window.location.href='customer.html'">
                <i class="fas fa-arrow-left"></i>
                <span>Zurück</span>
            </button>
            <button class="control-btn" onclick="window.location.href='index.html'">
                <i class="fas fa-home"></i>
                <span>Start</span>
            </button>
        </div>
    </header>

    <main>
        <h1 class="page-title">Meine Treuepunkte</h1>
        
        <div class="loyalty-grid">
            <!-- Points Overview Card -->
            <div class="loyalty-card">
                <div class="card-header">
                    <h2 class="card-title">Punkteübersicht</h2>
                    <i class="card-icon fas fa-coins"></i>
                </div>
                
                <div class="points-display">
                    <div class="points-value" id="points-value">0</div>
                    <div class="points-label">Aktuelle Punkte</div>
                </div>
                
                <div class="tier-display">
                    <span class="tier-badge tier-bronze" id="tier-badge">
                        <i class="fas fa-medal"></i>
                        <span id="tier-name">Bronze</span>
                    </span>
                </div>
                
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Fortschritt zum nächsten Level</span>
                        <span id="progress-text">0/500</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-earned">0</div>
                        <div class="stat-label">Insgesamt verdient</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-redeemed">0</div>
                        <div class="stat-label">Eingelöst</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="months-active">0</div>
                        <div class="stat-label">Aktive Monate</div>
                    </div>
                </div>
            </div>
            
            <!-- Rewards Card -->
            <div class="loyalty-card">
                <div class="card-header">
                    <h2 class="card-title">Belohnungen</h2>
                    <i class="card-icon fas fa-gift"></i>
                </div>
                
                <p>Lösen Sie Ihre Punkte für exklusive Belohnungen ein:</p>
                
                <div class="rewards-grid" id="rewards-container">
                    <!-- Rewards will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Statistics & Charts Card -->
        <div class="loyalty-card">
            <div class="card-header">
                <h2 class="card-title">Statistiken & Verlauf</h2>
                <i class="card-icon fas fa-chart-line"></i>
            </div>
            
            <div class="chart-container">
                <canvas id="points-chart"></canvas>
            </div>
            
            <h3 style="margin-top: var(--spacing-xl);">Letzte Transaktionen</h3>
            <div class="transactions-list" id="transactions-container">
                <!-- Transactions will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Coupons Section -->
        <div class="loyalty-card">
            <div class="card-header">
                <h2 class="card-title">Meine Gutscheine</h2>
                <i class="card-icon fas fa-tags"></i>
            </div>
            
            <div class="coupons-grid" id="coupons-container">
                <!-- Coupons will be populated by JavaScript -->
            </div>
        </div>
    </main>

    <!-- Reward Redemption Modal -->
    <div id="reward-modal" class="modal">
        <div class="modal-content">
            <div class="modal-icon" style="color: var(--color-loyalty-primary);">
                <i class="fas fa-gift"></i>
            </div>
            <h2 class="modal-title" id="reward-modal-title">Belohnung einlösen</h2>
            <p class="modal-message" id="reward-modal-message">Möchten Sie diese Belohnung einlösen?</p>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeModal('reward-modal')">Abbrechen</button>
                <button class="modal-btn primary" id="confirm-reward-btn">Einlösen</button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="modal">
        <div class="modal-content">
            <div class="modal-icon" style="color: var(--color-success);">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2 class="modal-title">Erfolgreich eingelöst</h2>
            <p class="modal-message" id="success-message">Ihre Belohnung wurde erfolgreich eingelöst.</p>
            <div class="modal-actions">
                <button class="modal-btn primary" onclick="closeModal('success-modal')">OK</button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="modal">
        <div class="modal-content">
            <div class="modal-icon" style="color: var(--color-error);">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <h2 class="modal-title">Fehler</h2>
            <p class="modal-message" id="error-message">Es ist ein Fehler aufgetreten.</p>
            <div class="modal-actions">
                <button class="modal-btn primary" onclick="closeModal('error-modal')">OK</button>
            </div>
        </div>
    </div>

    <!-- Confetti container for celebrations -->
    <div id="confetti-container" class="confetti-container"></div>

    <script>
    // Loyalty Program Configuration
    const LOYALTY_CONFIG = {
        programName: "Gittertier Premium Club",
        pointsPerEuro: 1,
        tiers: {
            bronze: { minPoints: 0, name: "Bronze", discount: 0 },
            silver: { minPoints: 500, name: "Silber", discount: 5 },
            gold: { minPoints: 1500, name: "Gold", discount: 10 },
            platinum: { minPoints: 3000, name: "Platin", discount: 15 },
            diamond: { minPoints: 5000, name: "Diamant", discount: 20 }
        },
        rewards: [
            { id: 'voucher-5', title: '5€ Gutschein', description: 'Einlösbar für jeden Einkauf', points: 200, icon: 'fa-ticket-alt' },
            { id: 'voucher-10', title: '10€ Gutschein', description: 'Einlösbar für jeden Einkauf', points: 350, icon: 'fa-ticket-alt', featured: true },
            { id: 'free-shipping', title: 'Kostenloser Versand', description: 'Kostenloser Versand bei Ihrer nächsten Bestellung', points: 150, icon: 'fa-truck' },
            { id: 'product-bonus', title: 'Kostenloses Produkt', description: 'Wählen Sie ein kostenloses Produkt aus unserem Sortiment', points: 500, icon: 'fa-gift' },
            { id: 'premium-receipt', title: 'Premium-Beleg', description: 'Exklusives Belegdesign für Ihre nächsten Einkäufe', points: 100, icon: 'fa-receipt' },
            { id: 'donation', title: 'Spende', description: 'Spenden Sie Ihre Punkte für einen guten Zweck', points: 250, icon: 'fa-hand-holding-heart' }
        ]
    };

    let loyaltyData = {
        points: 0,
        tier: 'bronze',
        transactions: [],
        stats: {
            totalEarned: 0,
            totalRedeemed: 0,
            joinDate: new Date()
        }
    };

    let couponsData = [];
    let selectedReward = null;
    let pointsChart = null;

    // Initialize the page
    function initLoyaltyPage() {
        loadLoyaltyData();
        loadCouponsData();
        renderLoyaltyData();
        setupRewards();
        renderTransactions();
        renderCoupons();
        initChart();
        
        // Animate points count
        animatePoints();
    }

    // Load loyalty data from localStorage
    function loadLoyaltyData() {
        try {
            const savedData = localStorage.getItem('gittertier_loyalty_data');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                loyaltyData = { ...loyaltyData, ...parsedData };
                
                // Ensure transactions exist
                if (!loyaltyData.transactions) {
                    loyaltyData.transactions = [];
                }
                
                // Ensure stats exist
                if (!loyaltyData.stats) {
                    loyaltyData.stats = {
                        totalEarned: 0,
                        totalRedeemed: 0,
                        joinDate: new Date()
                    };
                }
            } else {
                // Initialize with some demo data if no saved data exists
                generateDemoData();
            }
        } catch (e) {
            console.error('Error loading loyalty data:', e);
            generateDemoData();
        }
    }

    // Load coupons data from localStorage
    function loadCouponsData() {
        try {
            const savedCoupons = localStorage.getItem('gittertier_coupons');
            if (savedCoupons) {
                couponsData = JSON.parse(savedCoupons);
            } else {
                // Load from customer preferences or generate demo data
                const customerPreferences = localStorage.getItem('gittertier_payment_preferences');
                if (customerPreferences) {
                    const preferences = JSON.parse(customerPreferences);
                    if (preferences.couponCode) {
                        // Add the saved coupon
                        couponsData = [{
                            id: 'saved-coupon',
                            code: preferences.couponCode,
                            title: 'Ihr gespeicherter Gutschein',
                            description: 'Dieser Gutschein wurde in Ihren Einstellungen gespeichert',
                            discount: '10%',
                            expiry: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 days from now
                            status: 'active'
                        }];
                    }
                }
                
                // If still no coupons, generate demo data
                if (couponsData.length === 0) {
                    generateDemoCoupons();
                }
            }
        } catch (e) {
            console.error('Error loading coupons data:', e);
            generateDemoCoupons();
        }
    }

    // Generate demo data for first-time users
    function generateDemoData() {
        loyaltyData.points = 1240;
        loyaltyData.tier = 'silver';
        loyaltyData.stats = {
            totalEarned: 1860,
            totalRedeemed: 620,
            joinDate: new Date(Date.now() - 90 * 24 * 60 * 60 * 1000) // 90 days ago
        };
        
        loyaltyData.transactions = [
            { id: '1', date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000), description: 'Einkauf am 12.05.2023', points: 120, type: 'earned' },
            { id: '2', date: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000), description: '10€ Gutschein eingelöst', points: -350, type: 'redeemed' },
            { id: '3', date: new Date(Date.now() - 12 * 24 * 60 * 60 * 1000), description: 'Einkauf am 05.05.2023', points: 85, type: 'earned' },
            { id: '4', date: new Date(Date.now() - 19 * 24 * 60 * 60 * 1000), description: 'Einkauf am 28.04.2023', points: 210, type: 'earned' },
            { id: '5', date: new Date(Date.now() - 26 * 24 * 60 * 60 * 1000), description: 'Kostenloser Versand', points: -150, type: 'redeemed' },
            { id: '6', date: new Date(Date.now() - 33 * 24 * 60 * 60 * 1000), description: 'Einkauf am 14.04.2023', points: 175, type: 'earned' },
            { id: '7', date: new Date(Date.now() - 40 * 24 * 60 * 60 * 1000), description: 'Einkauf am 07.04.2023', points: 90, type: 'earned' },
            { id: '8', date: new Date(Date.now() - 47 * 24 * 60 * 60 * 1000), description: 'Willkommenspunkte', points: 100, type: 'earned' },
            { id: '9', date: new Date(Date.now() - 54 * 24 * 60 * 60 * 1000), description: 'Einkauf am 24.03.2023', points: 130, type: 'earned' },
            { id: '10', date: new Date(Date.now() - 61 * 24 * 60 * 60 * 1000), description: 'Einkauf am 17.03.2023', points: 95, type: 'earned' },
            { id: '11', date: new Date(Date.now() - 68 * 24 * 60 * 60 * 1000), description: 'Einkauf am 10.03.2023', points: 160, type: 'earned' },
            { id: '12', date: new Date(Date.now() - 75 * 24 * 60 * 60 * 1000), description: 'Einkauf am 03.03.2023', points: 110, type: 'earned' },
            { id: '13', date: new Date(Date.now() - 82 * 24 * 60 * 60 * 1000), description: 'Einkauf am 24.02.2023', points: 140, type: 'earned' },
            { id: '14', date: new Date(Date.now() - 89 * 24 * 60 * 60 * 1000), description: 'Erster Einkauf', points: 100, type: 'earned' }
        ];
        
        saveLoyaltyData();
    }

    // Generate demo coupons for first-time users
    function generateDemoCoupons() {
        couponsData = [
            {
                id: 'welcome2023',
                code: 'WILLKOMMEN15',
                title: 'Willkommensgutschein',
                description: '15% Rabatt auf Ihren nächsten Einkauf',
                discount: '15%',
                expiry: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000), // 14 days from now
                status: 'active'
            },
            {
                id: 'summer2023',
                code: 'SOMMER10',
                title: 'Sommeraktion',
                description: '10€ Rabatt bei einem Mindesteinkauf von 50€',
                discount: '10€',
                expiry: new Date(Date.now() + 45 * 24 * 60 * 60 * 1000), // 45 days from now
                status: 'active'
            },
            {
                id: 'premium2023',
                code: 'PREMIUM5',
                title: 'Premium-Kundengutschein',
                description: '5% Rabatt auf alle Premium-Produkte',
                discount: '5%',
                expiry: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7 days from now
                status: 'active'
            }
        ];
        
        saveCouponsData();
    }

    // Save loyalty data to localStorage
    function saveLoyaltyData() {
        try {
            localStorage.setItem('gittertier_loyalty_data', JSON.stringify(loyaltyData));
        } catch (e) {
            console.error('Error saving loyalty data:', e);
        }
    }

    // Save coupons data to localStorage
    function saveCouponsData() {
        try {
            localStorage.setItem('gittertier_coupons', JSON.stringify(couponsData));
        } catch (e) {
            console.error('Error saving coupons data:', e);
        }
    }

    // Render loyalty data to the UI
    function renderLoyaltyData() {
        // Update points display
        document.getElementById('points-value').textContent = loyaltyData.points;
        
        // Update tier badge
        updateTierDisplay();
        
        // Update progress bar
        updateProgressBar();
        
        // Update stats
        document.getElementById('total-earned').textContent = loyaltyData.stats.totalEarned;
        document.getElementById('total-redeemed').textContent = loyaltyData.stats.totalRedeemed;
        
        // Calculate months active
        const joinDate = new Date(loyaltyData.stats.joinDate);
        const monthsActive = Math.floor((new Date() - joinDate) / (1000 * 60 * 60 * 24 * 30));
        document.getElementById('months-active').textContent = Math.max(1, monthsActive);
    }

    // Update tier display based on current points
    function updateTierDisplay() {
        const tiers = Object.keys(LOYALTY_CONFIG.tiers);
        let currentTier = 'bronze';
        
        for (const tier of tiers) {
            if (loyaltyData.points >= LOYALTY_CONFIG.tiers[tier].minPoints) {
                currentTier = tier;
            } else {
                break;
            }
        }
        
        loyaltyData.tier = currentTier;
        const tierConfig = LOYALTY_CONFIG.tiers[currentTier];
        
        // Update badge
        const tierBadge = document.getElementById('tier-badge');
        tierBadge.className = `tier-badge tier-${currentTier}`;
        tierBadge.innerHTML = `<i class="fas fa-medal"></i><span id="tier-name">${tierConfig.name}</span>`;
    }

    // Update progress bar to next tier
    function updateProgressBar() {
        const tiers = Object.keys(LOYALTY_CONFIG.tiers);
        const currentTierIndex = tiers.indexOf(loyaltyData.tier);
        
        if (currentTierIndex < tiers.length - 1) {
            const currentTierMin = LOYALTY_CONFIG.tiers[loyaltyData.tier].minPoints;
            const nextTier = tiers[currentTierIndex + 1];
            const nextTierMin = LOYALTY_CONFIG.tiers[nextTier].minPoints;
            
            const progress = ((loyaltyData.points - currentTierMin) / (nextTierMin - currentTierMin)) * 100;
            document.getElementById('progress-fill').style.width = `${Math.min(progress, 100)}%`;
            document.getElementById('progress-text').textContent = 
                `${loyaltyData.points - currentTierMin}/${nextTierMin - currentTierMin}`;
        } else {
            // Highest tier reached
            document.getElementById('progress-fill').style.width = '100%';
            document.getElementById('progress-text').textContent = 'Maximales Level erreicht!';
        }
    }

    // Set up rewards display
    function setupRewards() {
        const rewardsContainer = document.getElementById('rewards-container');
        rewardsContainer.innerHTML = '';
        
        LOYALTY_CONFIG.rewards.forEach(reward => {
            const canAfford = loyaltyData.points >= reward.points;
            const rewardElement = document.createElement('div');
            rewardElement.className = `reward-card ${reward.featured ? 'featured' : ''}`;
            rewardElement.innerHTML = `
                <div class="reward-icon">
                    <i class="fas ${reward.icon}"></i>
                </div>
                <h3 class="reward-title">${reward.title}</h3>
                <p class="reward-description">${reward.description}</p>
                <div class="reward-cost">${reward.points} Punkte</div>
                <button class="reward-action" ${!canAfford ? 'disabled' : ''} 
                    onclick="selectReward('${reward.id}')">
                    ${canAfford ? 'Jetzt einlösen' : 'Nicht genug Punkte'}
                </button>
            `;
            
            rewardsContainer.appendChild(rewardElement);
        });
    }

    // Render coupons to the UI
    function renderCoupons() {
        const couponsContainer = document.getElementById('coupons-container');
        couponsContainer.innerHTML = '';
        
        if (couponsData.length === 0) {
            couponsContainer.innerHTML = '<p class="text-muted" style="text-align: center; padding: 20px;">Keine aktiven Gutscheine</p>';
            return;
        }
        
        couponsData.forEach(coupon => {
            const today = new Date();
            const expiryDate = new Date(coupon.expiry);
            const daysUntilExpiry = Math.floor((expiryDate - today) / (1000 * 60 * 60 * 24));
            
            let statusClass = '';
            let statusText = '';
            
            if (daysUntilExpiry <= 7) {
                statusClass = 'expiring';
                statusText = 'Läuft bald ab';
            } else if (daysUntilExpiry <= 30) {
                statusClass = 'upcoming';
                statusText = 'Aktiv';
            }
            
            const couponElement = document.createElement('div');
            couponElement.className = `coupon-card ${statusClass}`;
            couponElement.innerHTML = `
                ${statusText ? `<div class="coupon-badge">${statusText}</div>` : ''}
                <h3 class="coupon-title">${coupon.title}</h3>
                <div class="coupon-code">${coupon.code}</div>
                <p class="coupon-description">${coupon.description}</p>
                <div class="coupon-expiry">Gültig bis: ${expiryDate.toLocaleDateString('de-DE')}</div>
            `;
            
            couponsContainer.appendChild(couponElement);
        });
    }

    // Select a reward for redemption
    function selectReward(rewardId) {
        selectedReward = LOYALTY_CONFIG.rewards.find(r => r.id === rewardId);
        
        if (!selectedReward) return;
        
        if (loyaltyData.points < selectedReward.points) {
            showError('Sie haben nicht genug Punkte für diese Belohnung.');
            return;
        }
        
        // Show redemption confirmation modal
        document.getElementById('reward-modal-title').textContent = selectedReward.title;
        document.getElementById('reward-modal-message').textContent = 
            `Möchten Sie "${selectedReward.title}" für ${selectedReward.points} Punkte einlösen?`;
        
        document.getElementById('confirm-reward-btn').onclick = redeemReward;
        showModal('reward-modal');
    }

    // Redeem the selected reward
    function redeemReward() {
        if (!selectedReward) return;
        
        // Deduct points
        loyaltyData.points -= selectedReward.points;
        loyaltyData.stats.totalRedeemed += selectedReward.points;
        
        // Add transaction
        loyaltyData.transactions.unshift({
            id: Date.now().toString(),
            date: new Date(),
            description: selectedReward.title,
            points: -selectedReward.points,
            type: 'redeemed'
        });
        
        // Save data
        saveLoyaltyData();
        
        // Update UI
        renderLoyaltyData();
        setupRewards();
        renderTransactions();
        updateChart();
        
        // Close modal and show success
        closeModal('reward-modal');
        
        // Show success message
        document.getElementById('success-message').textContent = 
            `Sie haben "${selectedReward.title}" erfolgreich eingelöst.`;
        showModal('success-modal');
        
        // Celebrate with confetti
        celebrate();
        
        // Reset selected reward
        selectedReward = null;
    }

    // Render transactions list
    function renderTransactions() {
        const transactionsContainer = document.getElementById('transactions-container');
        transactionsContainer.innerHTML = '';
        
        // Show last 10 transactions
        const recentTransactions = loyaltyData.transactions.slice(0, 10);
        
        if (recentTransactions.length === 0) {
            transactionsContainer.innerHTML = '<p class="text-muted" style="text-align: center; padding: 20px;">Noch keine Transaktionen</p>';
            return;
        }
        
        recentTransactions.forEach(transaction => {
            const transactionElement = document.createElement('div');
            transactionElement.className = 'transaction-item';
            
            const dateString = new Date(transaction.date).toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            
            transactionElement.innerHTML = `
                <div class="transaction-details">
                    <div class="transaction-title">${transaction.description}</div>
                    <div class="transaction-date">${dateString}</div>
                </div>
                <div class="transaction-points ${transaction.points > 0 ? 'points-earned' : 'points-spent'}">
                    ${transaction.points > 0 ? '+' : ''}${transaction.points}
                </div>
            `;
            
            transactionsContainer.appendChild(transactionElement);
        });
    }

    // Initialize the points chart
    function initChart() {
        const ctx = document.getElementById('points-chart').getContext('2d');
        
        // Prepare data for last 6 months
        const months = [];
        const pointsData = [];
        
        const now = new Date();
        for (let i = 5; i >= 0; i--) {
            const month = new Date(now.getFullYear(), now.getMonth() - i, 1);
            months.push(month.toLocaleDateString('de-DE', { month: 'short', year: 'numeric' }));
            
            // Calculate points for this month (simplified)
            const monthPoints = loyaltyData.transactions
                .filter(t => {
                    const tDate = new Date(t.date);
                    return tDate.getMonth() === month.getMonth() && 
                           tDate.getFullYear() === month.getFullYear() &&
                           t.points > 0;
                })
                .reduce((sum, t) => sum + t.points, 0);
                
            pointsData.push(monthPoints);
        }
        
        pointsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'Punkte pro Monat',
                    data: pointsData,
                    backgroundColor: 'rgba(126, 34, 206, 0.1)',
                    borderColor: 'rgba(126, 34, 206, 1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // Update chart with new data
    function updateChart() {
        if (!pointsChart) return;
        
        // Update data
        const now = new Date();
        const months = [];
        const pointsData = [];
        
        for (let i = 5; i >= 0; i--) {
            const month = new Date(now.getFullYear(), now.getMonth() - i, 1);
            months.push(month.toLocaleDateString('de-DE', { month: 'short', year: 'numeric' }));
            
            // Calculate points for this month (simplified)
            const monthPoints = loyaltyData.transactions
                .filter(t => {
                    const tDate = new Date(t.date);
                    return tDate.getMonth() === month.getMonth() && 
                           tDate.getFullYear() === month.getFullYear() &&
                           t.points > 0;
                })
                .reduce((sum, t) => sum + t.points, 0);
                
            pointsData.push(monthPoints);
        }
        
        pointsChart.data.labels = months;
        pointsChart.data.datasets[0].data = pointsData;
        pointsChart.update();
    }

    // Animate points count
    function animatePoints() {
        const pointsElement = document.getElementById('points-value');
        const targetPoints = loyaltyData.points;
        let currentPoints = 0;
        const duration = 1500;
        const frameRate = 30;
        const totalFrames = duration / (1000 / frameRate);
        const pointsPerFrame = targetPoints / totalFrames;
        
        const interval = setInterval(() => {
            currentPoints += pointsPerFrame;
            if (currentPoints >= targetPoints) {
                currentPoints = targetPoints;
                clearInterval(interval);
            }
            pointsElement.textContent = Math.round(currentPoints);
        }, 1000 / frameRate);
    }

    // Show celebration confetti
    function celebrate() {
        const confettiContainer = document.getElementById('confetti-container');
        confettiContainer.style.display = 'block';
        confettiContainer.innerHTML = '';
        
        // Create confetti particles
        for (let i = 0; i < 100; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.width = Math.random() * 10 + 5 + 'px';
            confetti.style.height = Math.random() * 10 + 5 + 'px';
            confetti.style.backgroundColor = getRandomColor();
            confetti.style.animationDuration = Math.random() * 3 + 2 + 's';
            confetti.style.animationDelay = Math.random() * 2 + 's';
            confettiContainer.appendChild(confetti);
        }
        
        // Hide confetti after animation
        setTimeout(() => {
            confettiContainer.style.display = 'none';
            confettiContainer.innerHTML = '';
        }, 5000);
    }

    // Get random color for confetti
    function getRandomColor() {
        const colors = [
            '#7e22ce', '#a855f7', '#ffd700', '#c5a47e', '#22c55e', 
            '#3b82f6', '#f97316', '#dc2626', '#16a34a'
        ];
        return colors[Math.floor(Math.random() * colors.length)];
    }

    // Show modal
    function showModal(modalId) {
        document.getElementById(modalId).style.display = 'flex';
    }

    // Close modal
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // Show error message
    function showError(message) {
        document.getElementById('error-message').textContent = message;
        showModal('error-modal');
    }

    // Initialize the page when loaded
    document.addEventListener('DOMContentLoaded', initLoyaltyPage);
    </script>
</body>
</html>