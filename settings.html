<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Systemeinstellungen</title>
    <style>
        /* Previous styles remain unchanged */
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--surface);
            padding: 2rem;
            border-radius: 12px;
            width: 95%;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .modal-input {
            width: 100%;
            padding: 0.8rem;
            margin: 0.8rem 0;
            border: 1px solid var(--border);
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <!-- Previous HTML structure remains unchanged -->

    <script>
        // Enhanced settings handling
        const settings = JSON.parse(localStorage.getItem('settings')) || {
            theme: 'light',
            fontSize: 16,
            taxRate: 19.0,
            currency: 'EUR',
            receiptHeader: 'Vielen Dank für Ihren Einkauf!',
            printerType: 'thermal',
            scannerSensitivity: 5,
            logoutTimer: 30,
            backupFrequency: 'weekly',
            barcodePrefix: '',
            autoDiscount: 0,
            voiceFeedback: 'off'
        };

        function initSettings() {
            // Initialize all inputs
            document.getElementById('theme-select').value = settings.theme;
            document.getElementById('font-size').value = settings.fontSize;
            document.getElementById('tax-rate').value = settings.taxRate;
            document.getElementById('currency').value = settings.currency;
            document.getElementById('receipt-header').value = settings.receiptHeader;
            document.getElementById('printer-type').value = settings.printerType;
            document.getElementById('scanner-sensitivity').value = settings.scannerSensitivity;
            document.getElementById('logout-timer').value = settings.logoutTimer;
            document.getElementById('backup-frequency').value = settings.backupFrequency;
            document.getElementById('barcode-prefix').value = settings.barcodePrefix;
            document.getElementById('auto-discount').value = settings.autoDiscount;
            document.getElementById('voice-feedback').value = settings.voiceFeedback;

            // Theme customization
            document.getElementById('theme-select').addEventListener('change', function() {
                const showCustom = this.value === 'custom';
                document.getElementById('custom-colors').style.display = showCustom ? 'flex' : 'none';
                if(!showCustom) applyTheme(this.value);
            });

            // Color pickers
            document.getElementById('primary-color').addEventListener('input', (e) => {
                document.documentElement.style.setProperty('--primary', e.target.value);
            });

            document.getElementById('accent-color').addEventListener('input', (e) => {
                document.documentElement.style.setProperty('--accent', e.target.value);
            });
        }

        function applyTheme(theme) {
            const root = document.documentElement;
            switch(theme) {
                case 'dark':
                    root.style.setProperty('--bg', '#1a1a1a');
                    root.style.setProperty('--surface', '#2d2d2d');
                    root.style.setProperty('--text', '#ffffff');
                    break;
                case 'light':
                    root.style.setProperty('--bg', '#f8f9fa');
                    root.style.setProperty('--surface', '#ffffff');
                    root.style.setProperty('--text', '#212529');
                    break;
                case 'custom':
                    // Colors set via color pickers
                    break;
            }
        }

        function saveSettings() {
            // Collect all settings
            const newSettings = {
                theme: document.getElementById('theme-select').value,
                fontSize: parseInt(document.getElementById('font-size').value),
                taxRate: parseFloat(document.getElementById('tax-rate').value),
                currency: document.getElementById('currency').value,
                receiptHeader: document.getElementById('receipt-header').value,
                printerType: document.getElementById('printer-type').value,
                scannerSensitivity: parseInt(document.getElementById('scanner-sensitivity').value),
                logoutTimer: parseInt(document.getElementById('logout-timer').value),
                backupFrequency: document.getElementById('backup-frequency').value,
                barcodePrefix: document.getElementById('barcode-prefix').value,
                autoDiscount: parseInt(document.getElementById('auto-discount').value),
                voiceFeedback: document.getElementById('voice-feedback').value,
                primaryColor: document.getElementById('primary-color').value,
                accentColor: document.getElementById('accent-color').value
            };

            localStorage.setItem('settings', JSON.stringify(newSettings));
            applySettings();
            alert('Einstellungen erfolgreich gespeichert!');
        }

        function applySettings() {
            // Apply font size
            document.documentElement.style.fontSize = settings.fontSize + 'px';
            
            // Apply theme
            applyTheme(settings.theme);
            
            // Apply custom colors
            if(settings.theme === 'custom') {
                document.documentElement.style.setProperty('--primary', settings.primaryColor);
                document.documentElement.style.setProperty('--accent', settings.accentColor);
            }
        }

        // PIN Handling with validation
        function setupPIN() {
            document.getElementById('pin-modal').style.display = 'block';
        }

        function confirmPIN() {
            const newPIN = document.getElementById('new-pin').value;
            const confirmPIN = document.getElementById('confirm-pin').value;

            if(!/^\d{4}$/.test(newPIN)) {
                alert('PIN muss 4 Ziffern enthalten');
                return;
            }

            if(newPIN !== confirmPIN) {
                alert('PINs stimmen nicht überein');
                return;
            }

            settings.pin = newPIN;
            localStorage.setItem('settings', JSON.stringify(settings));
            document.getElementById('pin-modal').style.display = 'none';
            alert('PIN erfolgreich gespeichert');
        }

        // Initialize settings on load
        initSettings();
        applySettings();
    </script>
</body>
</html>