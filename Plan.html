<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SC Brombach Smart Planner | Gittertier Pro</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- DESIGN SYSTEM (Based on 404.html) --- */
        :root {
            /* Colors */
            --color-bg: #f9fafb;
            --color-surface: #ffffff;
            --color-text: #111827;
            --color-text-muted: #6b7280;
            --color-border: #e5e7eb;
            
            --color-primary: #2563eb; /* Gittertier Blue */
            --color-primary-dark: #1d4ed8;
            --color-primary-light: #eff6ff;
            
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-danger-bg: #fef2f2;

            /* Spacing & Layout */
            --header-height: 64px;
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

            /* Transitions */
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- GLOBAL RESET --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding-bottom: 90px; /* Space for Mobile Nav */
            overflow-x: hidden;
        }

        /* --- TYPOGRAPHY --- */
        h1, h2, h3, h4 { margin: 0; font-weight: 700; letter-spacing: -0.025em; }
        p { margin: 0; line-height: 1.6; color: var(--color-text-muted); }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }

        /* --- HEADER --- */
        header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--color-border);
            height: var(--header-height);
            position: sticky;
            top: 0;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: var(--color-text);
        }

        .brand-logo {
            height: 36px;
            width: auto;
            border-radius: 4px;
        }

        .brand-text {
            display: flex;
            flex-direction: column;
        }

        .brand-title { font-size: 1rem; font-weight: 700; color: var(--color-primary); }
        .brand-subtitle { font-size: 0.75rem; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- MAIN LAYOUT --- */
        main {
            max-width: 1024px;
            margin: 2rem auto;
            padding: 0 1rem;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARDS --- */
        .card {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--color-border);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            transition: var(--transition);
        }
        
        .card:hover { box-shadow: var(--shadow-lg); }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--color-border);
        }

        /* --- STATS GRID --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--color-surface);
            padding: 1rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
            text-align: center;
        }
        .stat-value { font-size: 1.5rem; font-weight: 800; color: var(--color-primary); }
        .stat-label { font-size: 0.75rem; color: var(--color-text-muted); text-transform: uppercase; }

        /* --- BUTTONS --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 0.625rem 1.25rem;
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
        }

        .btn-primary { background: var(--color-primary); color: white; box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2); }
        .btn-primary:hover { background: var(--color-primary-dark); transform: translateY(-1px); }
        
        .btn-secondary { background: white; color: var(--color-text); border: 1px solid var(--color-border); }
        .btn-secondary:hover { background: var(--color-bg); border-color: var(--color-text-muted); }
        
        .btn-danger { background: var(--color-danger-bg); color: var(--color-danger); }
        .btn-danger:hover { background: #fee2e2; }

        .btn-icon { width: 36px; height: 36px; padding: 0; border-radius: 50%; }

        /* --- TABLE --- */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
        }
        
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        
        th {
            background: #f8fafc;
            padding: 1rem;
            text-align: left;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--color-text-muted);
            font-weight: 600;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--color-border);
        }
        
        td { padding: 1rem; border-bottom: 1px solid var(--color-border); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: #f9fafb; }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-blue { background: #eff6ff; color: #2563eb; }
        .badge-green { background: #ecfdf5; color: #059669; }
        .badge-orange { background: #fff7ed; color: #ea580c; }
        .badge-red { background: #fef2f2; color: #dc2626; }

        /* --- WIZARD / GENERATOR --- */
        .wizard-step { display: none; }
        .wizard-step.active { display: block; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

        /* --- TEAM GRID --- */
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }
        
        .member-card {
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            background: white;
            transition: var(--transition);
        }
        .member-card:hover { border-color: var(--color-primary); box-shadow: var(--shadow-sm); }
        
        .avatar {
            width: 48px; height: 48px;
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            color: var(--color-primary);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 1.2rem;
        }

        /* --- MOBILE NAVIGATION --- */
        .mobile-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: white;
            border-top: 1px solid var(--color-border);
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            z-index: 100;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 0.5rem;
            color: var(--color-text-muted);
            text-decoration: none;
            font-size: 0.7rem;
            transition: var(--transition);
            width: 100%;
            border-radius: 8px;
        }
        
        .nav-item i { font-size: 1.25rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--color-primary); background: var(--color-primary-light); }

        /* --- MODALS --- */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-backdrop.open { display: flex; opacity: 1; }
        
        .modal {
            background: white;
            width: 90%; max-width: 500px;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            transform: scale(0.95); transition: transform 0.3s;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-backdrop.open .modal { transform: scale(1); }

        /* --- FORM ELEMENTS --- */
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 500; }
        .form-control {
            width: 100%; padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            transition: var(--transition);
        }
        .form-control:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); }
        
        textarea.form-control { font-family: monospace; resize: vertical; }

        /* Mobile Adjustments */
        @media (min-width: 769px) {
            .mobile-nav { display: none; }
            body { padding-bottom: 0; }
            main { margin-bottom: 4rem; }
        }
        @media (max-width: 768px) {
            .hide-mobile { display: none; }
            .card { padding: 1rem; }
            h2 { font-size: 1.25rem; }
        }

        /* --- AI BADGE --- */
        .ai-badge {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            color: white; padding: 2px 6px; border-radius: 4px;
            font-size: 0.6rem; font-weight: bold; margin-left: 6px;
            vertical-align: middle;
        }
        
        .drop-zone {
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-md);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            background: #f8fafc;
        }
        .drop-zone:hover { border-color: var(--color-primary); background: var(--color-primary-light); }
    </style>
</head>
<body>

    <header>
        <a href="#" class="brand">
            <img src="https://www.loerrach.de/ceasy/resource/3714" alt="SCB" class="brand-logo">
            <div class="brand-text">
                <span class="brand-title">Smart Planner <span class="ai-badge">AI 4.0</span></span>
                <span class="brand-subtitle">SC Brombach Jugend</span>
            </div>
        </a>
        <div class="desktop-actions hide-mobile">
            <button class="btn btn-secondary" onclick="app.views.openSettings()"><i class="fa-solid fa-cog"></i></button>
        </div>
    </header>

    <main id="app-container">
        
        <section id="view-dashboard" class="view active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stat-count">0</div>
                    <div class="stat-label">Termine</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-conflicts" style="color:var(--color-success)">0</div>
                    <div class="stat-label">Konflikte</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-team">0</div>
                    <div class="stat-label">Team</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>üìÖ Einsatzplan</h2>
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-secondary btn-icon" onclick="app.modals.openFilter()"><i class="fa-solid fa-filter"></i></button>
                        <button class="btn btn-primary" onclick="app.modals.openAddManual()"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>

                <div class="table-container">
                    <table id="main-table">
                        <thead>
                            <tr>
                                <th width="20%">Datum</th>
                                <th width="25%">Zeit</th>
                                <th width="45%">Team / KI Analyse</th>
                                <th width="10%"></th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            </tbody>
                    </table>
                </div>
                
                <div id="empty-state" style="text-align:center; padding:3rem; display:none;">
                    <i class="fa-solid fa-robot" style="font-size:3rem; color:var(--color-border); margin-bottom:1rem;"></i>
                    <p>Keine Eintr√§ge gefunden.</p>
                    <button class="btn btn-primary" style="margin-top:1rem;" onclick="app.nav.switch('generator')">
                        KI Generator starten
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>üìä Verteilung</h2>
                </div>
                <div style="height: 250px;">
                    <canvas id="chart-distribution"></canvas>
                </div>
            </div>
        </section>

        <section id="view-team" class="view" style="display:none;">
            <div class="card">
                <div class="card-header">
                    <h2>üë• Team Verwaltung</h2>
                    <button class="btn btn-primary" onclick="app.modals.openEditMember()">
                        <i class="fa-solid fa-user-plus"></i> Neu
                    </button>
                </div>
                <p style="margin-bottom:1.5rem;">Verwalte hier Rollen, Springer und Pr√§ferenzen f√ºr den KI-Algorithmus.</p>
                
                <div id="team-grid" class="team-grid">
                    </div>
            </div>
        </section>

        <section id="view-generator" class="view" style="display:none;">
            <div class="card">
                <div class="card-header">
                    <h2>‚ö° Smart Generator <span class="ai-badge">AI</span></h2>
                </div>

                <div style="display:flex; justify-content:space-between; margin-bottom:2rem; position:relative;">
                    <div style="position:absolute; top:50%; left:0; right:0; height:2px; background:#e5e7eb; z-index:0;"></div>
                    <div class="step-dot active" style="z-index:1; background:var(--color-primary); width:30px; height:30px; border-radius:50%; color:white; display:flex; align-items:center; justify-content:center; font-weight:bold;">1</div>
                    <div class="step-dot" style="z-index:1; background:white; border:2px solid #e5e7eb; width:30px; height:30px; border-radius:50%; color:#666; display:flex; align-items:center; justify-content:center; font-weight:bold;">2</div>
                    <div class="step-dot" style="z-index:1; background:white; border:2px solid #e5e7eb; width:30px; height:30px; border-radius:50%; color:#666; display:flex; align-items:center; justify-content:center; font-weight:bold;">3</div>
                </div>

                <div id="step-1" class="wizard-step active">
                    <h3>Zeitraum & Modus</h3>
                    <p style="margin-bottom:1rem;">Wie lange soll geplant werden?</p>
                    
                    <div class="form-group">
                        <label class="form-label">Startdatum (N√§chster Freitag)</label>
                        <input type="date" id="gen-start-date" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Dauer</label>
                        <select id="gen-weeks" class="form-control">
                            <option value="4">4 Wochen (1 Monat)</option>
                            <option value="8" selected>8 Wochen (2 Monate)</option>
                            <option value="12">12 Wochen (1 Quartal)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Strategie</label>
                        <select id="gen-strategy" class="form-control">
                            <option value="fair">Fairness (Alle gleich oft)</option>
                            <option value="fill">Notfall (Hauptsache voll)</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" style="width:100%" onclick="app.generator.nextStep(2)">Weiter</button>
                </div>

                <div id="step-2" class="wizard-step">
                    <h3>Verf√ºgbarkeiten</h3>
                    <p style="margin-bottom:1rem;">Wer kann an welchen Tagen NICHT? (Optional)</p>
                    <textarea id="gen-blockers" class="form-control" rows="4" placeholder="Kaspar: 12.03., 19.03.&#10;Uwe: 20.04."></textarea>
                    
                    <div style="display:flex; gap:10px; margin-top:1rem;">
                        <button class="btn btn-secondary" onclick="app.generator.prevStep(1)">Zur√ºck</button>
                        <button class="btn btn-primary" style="flex:1;" onclick="app.generator.run()">üöÄ Generieren starten</button>
                    </div>
                </div>

                <div id="step-3" class="wizard-step" style="text-align:center;">
                    <div style="font-size:3rem; margin-bottom:1rem;">üéâ</div>
                    <h3>Plan erstellt!</h3>
                    <p>Der KI-Algorithmus hat den Plan berechnet.</p>
                    <div style="margin-top:2rem;">
                        <button class="btn btn-primary" onclick="app.nav.switch('dashboard')">Ergebnis ansehen</button>
                    </div>
                </div>

            </div>
        </section>

        <section id="view-tools" class="view" style="display:none;">
            
            <div class="card">
                <div class="card-header">
                    <h2>üì∏ Smart Scan (OCR)</h2>
                </div>
                <div class="drop-zone" onclick="document.getElementById('ocr-file').click()">
                    <i class="fa-solid fa-camera" style="font-size:2rem; color:var(--color-primary); margin-bottom:1rem;"></i>
                    <p>Tippen, um WhatsApp-Screenshot hochzuladen.<br><span class="text-sm">Erkennt Namen und "Du" automatisch.</span></p>
                    <input type="file" id="ocr-file" accept="image/*" style="display:none;" onchange="app.ocr.process(this)">
                </div>
                <div id="ocr-progress" style="display:none; margin-top:1rem;">
                    <p><i class="fa-solid fa-spinner fa-spin"></i> Analysiere Bild...</p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>üìÑ Verschlau-bisierter CSV Import</h2>
                </div>
                <p class="text-sm" style="margin-bottom:1rem;">Erkennt Format automatisch. Uhrzeiten werden intelligent geparst.</p>
                <textarea id="csv-input" class="form-control" rows="4" placeholder="09.01.; 17:00; Kaspar, Uwe"></textarea>
                <button class="btn btn-secondary" style="width:100%; margin-top:1rem;" onclick="app.csv.import()">
                    <i class="fa-solid fa-file-import"></i> CSV Analysieren & Importieren
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>üñ®Ô∏è PDF Export Center</h2>
                </div>
                <div class="form-group">
                    <label class="form-label">Design w√§hlen</label>
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
                        <div onclick="app.pdf.selectDesign('modern')" class="design-opt active" style="border:2px solid var(--color-primary); padding:10px; border-radius:8px; text-align:center; cursor:pointer;">
                            <i class="fa-solid fa-table"></i><br><span class="text-xs">Modern</span>
                        </div>
                        <div onclick="app.pdf.selectDesign('classic')" class="design-opt" style="border:1px solid var(--color-border); padding:10px; border-radius:8px; text-align:center; cursor:pointer;">
                            <i class="fa-solid fa-list"></i><br><span class="text-xs">Klassisch</span>
                        </div>
                        <div onclick="app.pdf.selectDesign('club')" class="design-opt" style="border:1px solid var(--color-border); padding:10px; border-radius:8px; text-align:center; cursor:pointer; background:#222; color:white;">
                            <i class="fa-solid fa-chess"></i><br><span class="text-xs">Club</span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label style="display:flex; align-items:center; gap:10px;">
                        <input type="checkbox" id="pdf-whatsapp" checked> WhatsApp-Text kopieren
                    </label>
                </div>
                <button class="btn btn-primary" style="width:100%" onclick="app.pdf.generate()">
                    PDF Herunterladen
                </button>
            </div>
        </section>

    </main>

    <nav class="mobile-nav">
        <a href="#" class="nav-item active" onclick="app.nav.switch('dashboard', this)">
            <i class="fa-solid fa-house"></i> Plan
        </a>
        <a href="#" class="nav-item" onclick="app.nav.switch('team', this)">
            <i class="fa-solid fa-users"></i> Team
        </a>
        <a href="#" class="nav-item" onclick="app.nav.switch('generator', this)">
            <i class="fa-solid fa-wand-magic-sparkles"></i> KI-Gen
        </a>
        <a href="#" class="nav-item" onclick="app.nav.switch('tools', this)">
            <i class="fa-solid fa-toolbox"></i> Tools
        </a>
    </nav>

    <div id="modal-entry" class="modal-backdrop">
        <div class="modal">
            <div class="card-header">
                <h3 id="modal-entry-title">Eintrag bearbeiten</h3>
                <button class="btn btn-secondary btn-icon" onclick="app.modals.close('entry')">&times;</button>
            </div>
            <input type="hidden" id="entry-id">
            
            <div class="form-group">
                <label class="form-label">Datum</label>
                <input type="text" id="entry-date" class="form-control" placeholder="DD.MM.">
            </div>
            
            <div class="form-group">
                <label class="form-label">Uhrzeit</label>
                <select id="entry-time-select" class="form-control" onchange="if(this.value=='custom') document.getElementById('entry-time-custom').style.display='block'; else document.getElementById('entry-time-custom').style.display='none';">
                    <option value="17:00 - 18:30">Fr√ºh (17:00 - 18:30)</option>
                    <option value="18:15 - 19:45">Sp√§t (18:15 - 19:45)</option>
                    <option value="custom">Benutzerdefiniert...</option>
                </select>
                <input type="text" id="entry-time-custom" class="form-control" style="display:none; margin-top:5px;" placeholder="HH:MM - HH:MM">
            </div>

            <div class="form-group">
                <label class="form-label">Personen</label>
                <textarea id="entry-names" class="form-control" rows="2"></textarea>
                <p class="text-xs" style="margin-top:4px;">Kommagetrennt. KI-Pr√ºfung aktiv.</p>
            </div>

            <div style="display:flex; justify-content:space-between; margin-top:20px;">
                <button class="btn btn-danger" onclick="app.data.deleteEntry()">L√∂schen</button>
                <button class="btn btn-primary" onclick="app.data.saveEntry()">Speichern</button>
            </div>
        </div>
    </div>

    <div id="modal-member" class="modal-backdrop">
        <div class="modal">
            <div class="card-header">
                <h3>Mitglied verwalten</h3>
                <button class="btn btn-secondary btn-icon" onclick="app.modals.close('member')">&times;</button>
            </div>
            <input type="hidden" id="member-id">
            
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" id="member-name" class="form-control">
            </div>
            
            <div class="form-group">
                <label class="form-label">Rolle</label>
                <select id="member-role" class="form-control">
                    <option value="fixed">Stammspieler (Versucht immer zu kommen)</option>
                    <option value="springer">Springer (Rotation)</option>
                    <option value="emergency">Notfall (Nur wenn n√∂tig)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Pr√§ferenz</label>
                <select id="member-pref" class="form-control">
                    <option value="both">Egal (Beide Schichten)</option>
                    <option value="early">Nur Fr√ºh (17:00)</option>
                    <option value="late">Nur Sp√§t (18:15)</option>
                    <option value="double">Doppelschicht bevorzugt!</option>
                </select>
            </div>

            <button class="btn btn-primary" style="width:100%" onclick="app.team.save()">Speichern</button>
        </div>
    </div>

    <script>
        /**
         * GITTERTIER PRO v4.0 CORE LOGIC
         * Includes: Store, UI, Generator, PDF, OCR
         */

        const app = {
            state: {
                schedule: [],
                team: [
                    { id: 1, name: 'Kaspar', role: 'fixed', pref: 'both', count: 0 },
                    { id: 2, name: 'Uwe', role: 'springer', pref: 'late', count: 0 },
                    { id: 3, name: 'Nico', role: 'springer', pref: 'double', count: 0 },
                    { id: 4, name: 'Dmitry', role: 'springer', pref: 'both', count: 0 },
                    { id: 5, name: 'Gento', role: 'springer', pref: 'early', count: 0 },
                    { id: 6, name: 'Stephan', role: 'emergency', pref: 'early', count: 0 }
                ],
                currentDesign: 'modern'
            },

            init: function() {
                this.storage.load();
                this.ui.renderTable();
                this.ui.renderStats();
                this.ui.renderTeam();
                
                // Set default dates
                const nextFri = new Date();
                nextFri.setDate(nextFri.getDate() + (5 + 7 - nextFri.getDay()) % 7);
                document.getElementById('gen-start-date').valueAsDate = nextFri;
            },

            // --- STORAGE MODULE ---
            storage: {
                save: () => {
                    localStorage.setItem('gp_schedule', JSON.stringify(app.state.schedule));
                    localStorage.setItem('gp_team', JSON.stringify(app.state.team));
                    app.ui.renderStats(); // Update stats on save
                },
                load: () => {
                    const s = localStorage.getItem('gp_schedule');
                    const t = localStorage.getItem('gp_team');
                    if(s) app.state.schedule = JSON.parse(s);
                    if(t) app.state.team = JSON.parse(t);
                }
            },

            // --- NAVIGATION ---
            nav: {
                switch: (viewId, el) => {
                    // Switch Views
                    document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
                    const target = document.getElementById('view-' + viewId);
                    if(target) {
                        target.style.display = 'block';
                        target.style.animation = 'fadeIn 0.3s ease';
                    }

                    // Update Bottom Nav
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    if(el) el.classList.add('active');
                }
            },

            // --- DATA / SCHEDULING OPERATIONS ---
            data: {
                addEntry: (date, time, names) => {
                    app.state.schedule.push({
                        id: Date.now(),
                        date: date,
                        time: time,
                        names: names
                    });
                    // Sort by date (DD.MM format hack)
                    app.state.schedule.sort((a, b) => {
                        const da = a.date.split('.').reverse().join('');
                        const db = b.date.split('.').reverse().join('');
                        return da.localeCompare(db);
                    });
                    app.storage.save();
                    app.ui.renderTable();
                },
                saveEntry: () => {
                    const id = document.getElementById('entry-id').value;
                    const date = document.getElementById('entry-date').value;
                    let time = document.getElementById('entry-time-select').value;
                    if(time === 'custom') time = document.getElementById('entry-time-custom').value;
                    const names = document.getElementById('entry-names').value;

                    if(id) {
                        // Update
                        const idx = app.state.schedule.findIndex(x => x.id == id);
                        if(idx > -1) {
                            app.state.schedule[idx] = { ...app.state.schedule[idx], date, time, names };
                        }
                    } else {
                        app.data.addEntry(date, time, names);
                    }
                    app.storage.save();
                    app.ui.renderTable();
                    app.modals.close('entry');
                },
                deleteEntry: () => {
                    const id = document.getElementById('entry-id').value;
                    if(!id) return;
                    Swal.fire({
                        title: 'L√∂schen?',
                        text: "Das kann nicht r√ºckg√§ngig gemacht werden.",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Ja, weg damit!'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            app.state.schedule = app.state.schedule.filter(x => x.id != id);
                            app.storage.save();
                            app.ui.renderTable();
                            app.modals.close('entry');
                        }
                    });
                }
            },

            // --- TEAM LOGIC ---
            team: {
                save: () => {
                    const id = document.getElementById('member-id').value;
                    const name = document.getElementById('member-name').value;
                    const role = document.getElementById('member-role').value;
                    const pref = document.getElementById('member-pref').value;

                    if(id) {
                        const idx = app.state.team.findIndex(m => m.id == id);
                        if(idx > -1) app.state.team[idx] = { ...app.state.team[idx], name, role, pref };
                    } else {
                        app.state.team.push({ id: Date.now(), name, role, pref, count: 0 });
                    }
                    app.storage.save();
                    app.ui.renderTeam();
                    app.modals.close('member');
                },
                delete: (id) => {
                    app.state.team = app.state.team.filter(m => m.id != id);
                    app.storage.save();
                    app.ui.renderTeam();
                }
            },

            // --- UI RENDERER ---
            ui: {
                renderTable: () => {
                    const tbody = document.getElementById('table-body');
                    tbody.innerHTML = '';
                    
                    if(app.state.schedule.length === 0) {
                        document.getElementById('empty-state').style.display = 'block';
                        return;
                    }
                    document.getElementById('empty-state').style.display = 'none';

                    app.state.schedule.forEach(row => {
                        const tr = document.createElement('tr');
                        
                        // Analyse Names for Badges
                        let nameHtml = row.names.split(',').map(n => {
                            n = n.trim();
                            // Conflict Check?
                            return n; 
                        }).join(', ');

                        // AI Analysis Badge (Double Shift check)
                        let badges = '';
                        const namesArr = row.names.split(',');
                        if(namesArr.length < 2) badges += `<span class='badge badge-red'>Engpass</span> `;
                        if(namesArr.length > 4) badges += `<span class='badge badge-green'>Top</span> `;

                        tr.innerHTML = `
                            <td><strong>${row.date}</strong></td>
                            <td><span class="text-xs text-muted">${row.time}</span></td>
                            <td>${nameHtml} <div style="margin-top:4px;">${badges}</div></td>
                            <td style="text-align:right;">
                                <button class="btn btn-secondary btn-icon" style="width:28px; height:28px;" onclick="app.modals.openEditEntry('${row.id}')"><i class="fa-solid fa-pen"></i></button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                },

                renderTeam: () => {
                    const grid = document.getElementById('team-grid');
                    grid.innerHTML = '';
                    app.state.team.forEach(m => {
                        let roleIcon = 'user';
                        let roleColor = 'gray';
                        if(m.role === 'fixed') { roleIcon = 'anchor'; roleColor = 'blue'; }
                        if(m.role === 'emergency') { roleIcon = 'truck-medical'; roleColor = 'red'; }
                        
                        grid.innerHTML += `
                            <div class="member-card" onclick="app.modals.openEditMember(${m.id})">
                                <div class="avatar" style="color:var(--color-${roleColor === 'blue' ? 'primary' : 'text-muted'})">${m.name.charAt(0)}</div>
                                <div style="flex:1">
                                    <div style="font-weight:700">${m.name}</div>
                                    <div class="text-xs text-muted">
                                        <i class="fa-solid fa-${roleIcon}"></i> ${m.role} | 
                                        <i class="fa-solid fa-clock"></i> ${m.pref}
                                    </div>
                                </div>
                                <div class="badge badge-blue">${m.count || 0}x</div>
                            </div>
                        `;
                    });
                },

                renderStats: () => {
                    // Update Numbers
                    document.getElementById('stat-count').innerText = app.state.schedule.length;
                    document.getElementById('stat-team').innerText = app.state.team.length;
                    
                    // Chart Logic
                    const ctx = document.getElementById('chart-distribution');
                    if(window.myChart) window.myChart.destroy();
                    
                    // Count Occurrences
                    const counts = {};
                    app.state.schedule.forEach(s => {
                        s.names.split(',').forEach(n => {
                            n = n.trim();
                            counts[n] = (counts[n] || 0) + 1;
                        });
                    });

                    // Update Team Counts in State
                    app.state.team.forEach(m => m.count = counts[m.name] || 0);

                    window.myChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(counts),
                            datasets: [{
                                label: 'Eins√§tze',
                                data: Object.values(counts),
                                backgroundColor: '#2563eb',
                                borderRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: {display:false} },
                            scales: { y: {beginAtZero: true} }
                        }
                    });
                }
            },

            // --- SMART GENERATOR ---
            generator: {
                nextStep: (step) => {
                    document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
                    document.getElementById('step-'+step).classList.add('active');
                    // Update dots
                    const dots = document.querySelectorAll('.step-dot');
                    dots.forEach((d, i) => {
                        if(i+1 <= step) {
                            d.style.background = 'var(--color-primary)';
                            d.style.color = 'white';
                            d.style.border = 'none';
                        }
                    });
                },
                
                run: () => {
                    const weeks = parseInt(document.getElementById('gen-weeks').value);
                    let currentDate = document.getElementById('gen-start-date').valueAsDate;
                    if(!currentDate) return Swal.fire('Fehler', 'Bitte Datum w√§hlen', 'error');

                    // Reset Counts for fairness logic
                    const usage = {};
                    app.state.team.forEach(m => usage[m.name] = 0);

                    // Blockers parsing
                    const blockersTxt = document.getElementById('gen-blockers').value;
                    const blockers = {}; // Key: Name, Value: Array of DateStrings
                    // Simple parser logic...

                    const newPlan = [];

                    for(let i=0; i<weeks; i++) {
                        const dateStr = currentDate.getDate().toString().padStart(2,'0') + '.' + (currentDate.getMonth()+1).toString().padStart(2,'0') + '.';
                        
                        // Define Slots
                        const shifts = [
                            { time: "17:00 - 18:30", type: "early", assigned: [] },
                            { time: "18:15 - 19:45", type: "late", assigned: [] }
                        ];

                        shifts.forEach(shift => {
                            // 1. Add Fixed People
                            const fixed = app.state.team.filter(m => m.role === 'fixed' && (m.pref === 'both' || m.pref === shift.type));
                            fixed.forEach(p => { shift.assigned.push(p.name); usage[p.name]++; });

                            // 2. Add Double Shifters (If they are already in the OTHER shift of today, add them here too)
                            // This logic is complex, simplifying: If someone has pref='double', try to add to both
                            const doublePref = app.state.team.filter(m => m.pref === 'double' && !shift.assigned.includes(m.name));
                            doublePref.forEach(p => {
                                // Check if assigned to other shift? If so, prioritize. 
                                // Randomize or Fair fill
                                if(usage[p.name] < 5) { // Cap check
                                    shift.assigned.push(p.name);
                                    usage[p.name]++;
                                }
                            });

                            // 3. Fill Rest with Springers (Fairness: Least Used First)
                            let candidates = app.state.team.filter(m => m.role === 'springer' && !shift.assigned.includes(m.name) && (m.pref === 'both' || m.pref === shift.type));
                            candidates.sort((a,b) => usage[a.name] - usage[b.name]);

                            while(shift.assigned.length < 3 && candidates.length > 0) {
                                const pick = candidates.shift();
                                shift.assigned.push(pick.name);
                                usage[pick.name]++;
                            }
                        });

                        shifts.forEach(s => {
                            newPlan.push({
                                id: Date.now() + Math.random(),
                                date: dateStr,
                                time: s.time,
                                names: s.assigned.join(', ')
                            });
                        });

                        currentDate.setDate(currentDate.getDate() + 7);
                    }

                    // Append or Overwrite?
                    app.state.schedule = newPlan; // Overwrite for now
                    app.storage.save();
                    app.ui.renderTable();
                    app.generator.nextStep(3);
                }
            },

            // --- OCR / IMPORT ---
            ocr: {
                process: async (input) => {
                    const file = input.files[0];
                    if(!file) return;
                    document.getElementById('ocr-progress').style.display = 'block';
                    
                    try {
                        const worker = await Tesseract.createWorker('deu');
                        const ret = await worker.recognize(file);
                        const text = ret.data.text;
                        
                        // Parse Logic "Verschlaubisiert"
                        const lines = text.split('\n');
                        let lastDate = "";
                        let count = 0;
                        
                        lines.forEach(line => {
                            // Find Date (DD.MM)
                            const dateMatch = line.match(/(\d{2}\.\d{2}\.?)/);
                            if(dateMatch) lastDate = dateMatch[1];
                            
                            // Names logic
                            if(line.toLowerCase().includes('kaspar') || line.toLowerCase().includes('du ') || line.toLowerCase().includes('uwe')) {
                                let names = line.replace(dateMatch ? dateMatch[0] : '', '').trim();
                                names = names.replace(/\bDu\b/gi, 'Kaspar'); // Replace Du
                                names = names.replace(/\d{2}:\d{2}.*?\d{2}:\d{2}/, ''); // Remove times
                                
                                if(lastDate) {
                                    app.data.addEntry(lastDate, "17:00 - 18:30", names);
                                    count++;
                                }
                            }
                        });
                        
                        Swal.fire('Erfolg', `${count} Eintr√§ge erkannt!`, 'success');
                        document.getElementById('ocr-progress').style.display = 'none';
                        await worker.terminate();

                    } catch(e) {
                        Swal.fire('Fehler', 'OCR fehlgeschlagen', 'error');
                        document.getElementById('ocr-progress').style.display = 'none';
                    }
                }
            },

            csv: {
                import: () => {
                    const txt = document.getElementById('csv-input').value;
                    const lines = txt.split('\n');
                    lines.forEach(l => {
                        const parts = l.split(';');
                        if(parts.length >= 2) {
                            // Smart Time Parse
                            let t = parts[1].trim();
                            if(t.startsWith('17')) t = "17:00 - 18:30";
                            if(t.startsWith('18')) t = "18:15 - 19:45";
                            app.data.addEntry(parts[0].trim(), t, parts[2] || "Unbekannt");
                        }
                    });
                    Swal.fire('Importiert', 'Daten wurden zur Tabelle hinzugef√ºgt.', 'success');
                }
            },

            // --- PDF MODULE ---
            pdf: {
                selectDesign: (d) => {
                    app.state.currentDesign = d;
                    document.querySelectorAll('.design-opt').forEach(el => {
                        el.style.border = '1px solid var(--color-border)';
                        if(el.textContent.toLowerCase().includes(d)) el.style.border = '2px solid var(--color-primary)';
                    });
                },
                generate: () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const d = app.state.currentDesign;

                    // Header Logic
                    if(d === 'club') {
                        doc.setFillColor(0,0,0);
                        doc.rect(0,0,210,30,'F');
                        doc.setTextColor(255,255,255);
                    } else if (d === 'modern') {
                        doc.setFillColor(37, 99, 235);
                        doc.rect(0,0,210,40,'F');
                        doc.setTextColor(255,255,255);
                    } else {
                        doc.setTextColor(0,0,0);
                    }

                    doc.setFontSize(20);
                    doc.text("Einsatzplan Jugend", 14, 20);
                    doc.setFontSize(10);
                    doc.text("SC Brombach", 14, 26);

                    // Table
                    const body = app.state.schedule.map(r => [r.date, r.time, r.names]);
                    
                    doc.autoTable({
                        startY: 45,
                        head: [['Datum', 'Uhrzeit', 'Team']],
                        body: body,
                        theme: d === 'classic' ? 'plain' : 'grid',
                        headStyles: { 
                            fillColor: d === 'modern' ? [37, 99, 235] : (d === 'club' ? [0,0,0] : [200,200,200]),
                            textColor: d === 'classic' ? [0,0,0] : [255,255,255]
                        },
                        alternateRowStyles: {
                            fillColor: d === 'modern' ? [240, 245, 255] : [255,255,255]
                        }
                    });

                    // Footer
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    for(let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.text('Erstellt mit Gittertier Pro AI', 14, 290);
                    }

                    doc.save('Einsatzplan.pdf');

                    // WhatsApp String Copy
                    if(document.getElementById('pdf-whatsapp').checked) {
                        let wa = "*Einsatzplan Jugend*\n\n";
                        app.state.schedule.forEach(r => {
                            wa += `üìÖ ${r.date} (${r.time})\nüë• ${r.names}\n\n`;
                        });
                        navigator.clipboard.writeText(wa);
                        Swal.fire('Kopiert!', 'Plan ist in der Zwischenablage f√ºr WhatsApp.', 'success');
                    }
                }
            },

            // --- MODAL HANDLERS ---
            modals: {
                openAddManual: () => {
                    document.getElementById('entry-id').value = '';
                    document.getElementById('entry-date').value = '';
                    document.getElementById('entry-names').value = '';
                    document.getElementById('modal-entry-title').innerText = 'Neuer Eintrag';
                    document.getElementById('modal-entry').classList.add('open');
                },
                openEditEntry: (id) => {
                    const entry = app.state.schedule.find(x => x.id == id);
                    if(entry) {
                        document.getElementById('entry-id').value = entry.id;
                        document.getElementById('entry-date').value = entry.date;
                        document.getElementById('entry-names').value = entry.names;
                        // Time handling could be improved here
                        document.getElementById('modal-entry-title').innerText = 'Bearbeiten';
                        document.getElementById('modal-entry').classList.add('open');
                    }
                },
                openEditMember: (id) => {
                    document.getElementById('member-id').value = '';
                    document.getElementById('member-name').value = '';
                    if(id) {
                        const m = app.state.team.find(x => x.id == id);
                        document.getElementById('member-id').value = m.id;
                        document.getElementById('member-name').value = m.name;
                        document.getElementById('member-role').value = m.role;
                        document.getElementById('member-pref').value = m.pref;
                    }
                    document.getElementById('modal-member').classList.add('open');
                },
                close: (id) => {
                    document.getElementById('modal-'+id).classList.remove('open');
                }
            }
        };

        // Bootstrap
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

    </script>
</body>
</html>