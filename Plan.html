<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Einsatzplaner Ultimate | SC Brombach</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- DESIGN SYSTEM (Based on 404.html / Gittertier Pro) --- */
        :root {
            /* Palette */
            --color-bg: #f9fafb;
            --color-surface: #ffffff;
            --color-text: #111827;
            --color-text-muted: #6b7280;
            --color-border: #e5e7eb;
            
            --color-primary: #2563eb; /* Gittertier Blue */
            --color-primary-dark: #1d4ed8;
            --color-primary-light: #eff6ff;
            
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-purple: #8b5cf6;

            /* Spacing & Radius */
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --header-height: 60px;
            --bottom-nav-height: 70px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 0;
            padding-bottom: var(--bottom-nav-height); /* Space for mobile nav */
        }

        /* --- LAYOUT UTILS --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .grid { display: grid; gap: 20px; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .flex { display: flex; gap: 10px; align-items: center; }
        .flex-col { flex-direction: column; }
        .justify-between { justify-content: space-between; }
        .w-full { width: 100%; }
        .hidden { display: none !important; }

        /* --- HEADER --- */
        header {
            background: var(--color-surface);
            height: var(--header-height);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: var(--shadow-sm);
        }

        .brand {
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--color-text);
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }
        .brand img { height: 32px; width: auto; }
        .brand span { color: var(--color-primary); }

        /* --- CARDS --- */
        .card {
            background: var(--color-surface);
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-sm);
            padding: 24px;
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--color-border);
        }
        
        .card h2 { margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        
        /* --- BUTTONS --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
            gap: 8px;
        }
        
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
        .btn-icon { padding: 8px; width: 36px; height: 36px; border-radius: 50%; }

        .btn-primary { background: var(--color-primary); color: white; box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2); }
        .btn-primary:hover { background: var(--color-primary-dark); transform: translateY(-1px); }
        
        .btn-secondary { background: white; border-color: var(--color-border); color: var(--color-text); }
        .btn-secondary:hover { background: var(--color-bg); border-color: var(--color-text-muted); }
        
        .btn-ghost { background: transparent; color: var(--color-text-muted); }
        .btn-ghost:hover { background: var(--color-bg); color: var(--color-text); }

        .btn-danger { background: #fee2e2; color: var(--color-danger); border-color: #fecaca; }
        .btn-danger:hover { background: #fecaca; }

        /* --- INPUTS --- */
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 0.85rem; color: var(--color-text-muted); margin-bottom: 6px; font-weight: 500; }
        
        input[type="text"], input[type="date"], input[type="number"], select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            font-family: var(--font-main);
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* --- BADGES --- */
        .badge {
            padding: 4px 8px;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .badge-fixed { background: #dbeafe; color: #1e40af; }
        .badge-rotate { background: #f3f4f6; color: #374151; }
        .badge-emergency { background: #fee2e2; color: #991b1b; }

        /* --- NAVIGATION (Mobile Bottom Bar) --- */
        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: var(--bottom-nav-height);
            background: var(--color-surface);
            border-top: 1px solid var(--color-border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--color-text-muted);
            font-size: 0.75rem;
            gap: 4px;
            cursor: pointer;
            transition: color 0.2s;
            border: none; background: none;
        }
        
        .nav-item i { font-size: 1.25rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--color-primary); }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        
        .modal {
            background: var(--color-surface);
            width: 90%; max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: var(--radius-md);
            padding: 0;
            transform: translateY(20px);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: var(--shadow-lg);
        }
        .modal-overlay.open .modal { transform: translateY(0); }
        
        .modal-header { padding: 20px; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; font-size: 1.25rem; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 20px; border-top: 1px solid var(--color-border); background: #f9fafb; display: flex; justify-content: flex-end; gap: 10px; }

        /* --- TABLE --- */
        .table-wrapper { overflow-x: auto; border: 1px solid var(--color-border); border-radius: var(--radius-sm); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #f9fafb; padding: 12px 16px; text-align: left; font-size: 0.75rem; color: var(--color-text-muted); text-transform: uppercase; border-bottom: 1px solid var(--color-border); }
        td { padding: 12px 16px; border-bottom: 1px solid var(--color-border); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #f9fafb; }

        /* --- WIZARD --- */
        .wizard-step { display: none; }
        .wizard-step.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- TEAM LIST --- */
        .member-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; border: 1px solid var(--color-border);
            border-radius: var(--radius-sm); margin-bottom: 8px;
            background: white;
        }
        .member-info { display: flex; align-items: center; gap: 10px; }
        .role-indicator { width: 8px; height: 8px; border-radius: 50%; }
        
        /* --- LOADING SPINNER --- */
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- DRAG & DROP ZONE --- */
        .drop-zone {
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-md);
            padding: 40px; text-align: center;
            transition: all 0.2s; cursor: pointer;
        }
        .drop-zone:hover, .drop-zone.dragover { border-color: var(--color-primary); background: var(--color-primary-light); }

    </style>
</head>
<body>

    <header>
        <a href="#" class="brand">
            <img src="https://www.loerrach.de/ceasy/resource/3714" alt="SC Brombach">
            <div>SC Brombach <span style="font-size:0.8em; color:#999; font-weight:400;">Planer V4</span></div>
        </a>
        <div class="flex">
            <button class="btn btn-sm btn-secondary" onclick="app.ui.toggleDarkMode()"><i class="fa-solid fa-moon"></i></button>
            <button class="btn btn-sm btn-primary" onclick="app.ui.openWizard()">
                <i class="fa-solid fa-wand-magic-sparkles"></i> <span style="display:none; @media(min-width:600px){display:inline;}">Wizard</span>
            </button>
        </div>
    </header>

    <main class="container" style="padding-bottom: 80px;">
        
        <section id="view-dashboard" class="view active">
            <div class="grid grid-2">
                <div class="card" style="border-left: 4px solid var(--color-primary);">
                    <div style="font-size:0.85rem; color:var(--color-text-muted);">Geplante Schichten</div>
                    <div style="font-size:2rem; font-weight:700;" id="stat-total-shifts">0</div>
                </div>
                <div class="card" style="border-left: 4px solid var(--color-success);">
                    <div style="font-size:0.85rem; color:var(--color-text-muted);">Aktive Helfer</div>
                    <div style="font-size:2rem; font-weight:700;" id="stat-active-helpers">0</div>
                </div>
            </div>

            <div class="card" style="margin-top:20px;">
                <div class="card-header">
                    <h2><i class="fa-solid fa-calendar-days"></i> Aktueller Einsatzplan</h2>
                    <div class="flex">
                        <button class="btn btn-sm btn-secondary" onclick="app.export.openModal()">
                            <i class="fa-solid fa-file-pdf"></i> Export
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="app.ui.openModal('modal-add-entry')">
                            <i class="fa-solid fa-plus"></i> Neu
                        </button>
                    </div>
                </div>
                
                <div class="table-wrapper">
                    <table id="schedule-table">
                        <thead>
                            <tr>
                                <th>Datum</th>
                                <th>Uhrzeit</th>
                                <th>Team (Anzahl)</th>
                                <th style="text-align:right">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="schedule-body">
                            </tbody>
                    </table>
                </div>
                <div id="empty-state" style="text-align:center; padding:40px; color:var(--color-text-muted); display:none;">
                    <i class="fa-solid fa-wind" style="font-size:2rem; margin-bottom:10px;"></i>
                    <p>Noch keine Eintr√§ge. Nutze den Generator oder importiere ein Foto.</p>
                </div>
            </div>
            
            <div class="grid grid-2" style="margin-top:20px;">
                <div class="card drop-zone" onclick="document.getElementById('ocr-file').click()">
                    <input type="file" id="ocr-file" hidden accept="image/*" onchange="app.ocr.process(this)">
                    <i class="fa-solid fa-camera" style="font-size:2rem; color:var(--color-primary); margin-bottom:10px;"></i>
                    <h3>Foto-Import (WhatsApp)</h3>
                    <p style="font-size:0.9rem; color:var(--color-text-muted);">Screenshot hochladen. Die KI erkennt Datum & Namen.</p>
                </div>
                <div class="card" onclick="app.ui.openModal('modal-csv')" style="cursor:pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
                    <i class="fa-solid fa-file-csv" style="font-size:2rem; color:var(--color-success); margin-bottom:10px;"></i>
                    <h3>CSV Verschlaubisieren</h3>
                    <p style="font-size:0.9rem; color:var(--color-text-muted);">Rohe Excel-Daten intelligent importieren.</p>
                </div>
            </div>
        </section>

        <section id="view-team" class="view hidden">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fa-solid fa-users"></i> Teamverwaltung</h2>
                    <button class="btn btn-primary btn-sm" onclick="app.team.openAddModal()">
                        <i class="fa-solid fa-user-plus"></i> Helfer
                    </button>
                </div>
                <div id="team-list">
                    </div>
            </div>
            <div class="card" style="margin-top:20px;">
                <div class="card-header"><h2><i class="fa-solid fa-chart-pie"></i> Fairness-Analyse</h2></div>
                <div style="height:250px;"><canvas id="fairnessChart"></canvas></div>
            </div>
        </section>

        <section id="view-settings" class="view hidden">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fa-solid fa-robot"></i> KI Generator</h2>
                </div>
                <div class="grid grid-2">
                    <div class="form-group">
                        <label>Startdatum</label>
                        <input type="date" id="gen-start">
                    </div>
                    <div class="form-group">
                        <label>Dauer</label>
                        <select id="gen-weeks">
                            <option value="4">4 Wochen</option>
                            <option value="8" selected>8 Wochen</option>
                            <option value="12">12 Wochen</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Modus</label>
                    <div class="flex" style="gap:20px; margin-top:10px;">
                        <label class="flex"><input type="checkbox" id="gen-keep-double" checked> Doppelschichten erlauben</label>
                        <label class="flex"><input type="checkbox" id="gen-use-emergency"> Notfall-Helfer nutzen</label>
                    </div>
                </div>
                <button class="btn btn-primary w-full" onclick="app.generator.run()">
                    <i class="fa-solid fa-bolt"></i> Generieren
                </button>
            </div>
        </section>

    </main>

    <nav class="bottom-nav">
        <button class="nav-item active" onclick="app.ui.switchView('dashboard', this)">
            <i class="fa-solid fa-list-check"></i>
            <span>Plan</span>
        </button>
        <button class="nav-item" onclick="app.ui.switchView('team', this)">
            <i class="fa-solid fa-users"></i>
            <span>Team</span>
        </button>
        <button class="nav-item" onclick="app.ui.switchView('settings', this)">
            <i class="fa-solid fa-gears"></i>
            <span>Tools</span>
        </button>
    </nav>

    <div id="modal-edit-entry" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Eintrag bearbeiten</h3>
                <button class="btn-ghost btn-icon" onclick="app.ui.closeModal('modal-edit-entry')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-id">
                <div class="form-group">
                    <label>Datum</label>
                    <input type="text" id="edit-date">
                </div>
                <div class="form-group">
                    <label>Uhrzeit</label>
                    <input type="text" id="edit-time">
                </div>
                <div class="form-group">
                    <label>Helfer (Auswahl)</label>
                    <div id="edit-member-select" class="grid grid-2" style="max-height:200px; overflow-y:scroll; border:1px solid #eee; padding:10px;">
                        </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.ui.closeModal('modal-edit-entry')">Abbrechen</button>
                <button class="btn btn-primary" onclick="app.schedule.saveEdit()">Speichern</button>
            </div>
        </div>
    </div>

    <div id="modal-add-entry" class="modal-overlay">
        <div class="modal">
            <div class="modal-header"><h3>Neuer Termin</h3><button class="btn-ghost btn-icon" onclick="app.ui.closeModal('modal-add-entry')">&times;</button></div>
            <div class="modal-body">
                <div class="form-group"><label>Datum</label><input type="text" id="add-date" placeholder="TT.MM."></div>
                <div class="form-group">
                    <label>Zeit</label>
                    <select id="add-time">
                        <option value="17:00 - 18:30">Fr√ºh (17:00 - 18:30)</option>
                        <option value="18:15 - 19:45">Sp√§t (18:15 - 19:45)</option>
                    </select>
                </div>
                <div class="form-group"><label>Namen (Freitext)</label><input type="text" id="add-names" placeholder="Max, Moritz"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="app.schedule.addManual()">Hinzuf√ºgen</button>
            </div>
        </div>
    </div>

    <div id="modal-member" class="modal-overlay">
        <div class="modal">
            <div class="modal-header"><h3>Mitglied verwalten</h3><button class="btn-ghost btn-icon" onclick="app.ui.closeModal('modal-member')">&times;</button></div>
            <div class="modal-body">
                <input type="hidden" id="mem-id">
                <div class="form-group"><label>Name</label><input type="text" id="mem-name"></div>
                <div class="form-group">
                    <label>Rolle</label>
                    <select id="mem-role">
                        <option value="fixed">Stammspieler (Immer)</option>
                        <option value="rotate">Springer (Rotation)</option>
                        <option value="emergency">Notfall (Nur bei Engpass)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Bevorzugte Schicht</label>
                    <select id="mem-shift">
                        <option value="both">Egal</option>
                        <option value="early">Fr√ºh (17:00)</option>
                        <option value="late">Sp√§t (18:15)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="mem-delete-btn" onclick="app.team.deleteMember()">L√∂schen</button>
                <button class="btn btn-primary" onclick="app.team.saveMember()">Speichern</button>
            </div>
        </div>
    </div>

    <div id="modal-export" class="modal-overlay">
        <div class="modal">
            <div class="modal-header"><h3>PDF Export</h3><button class="btn-ghost btn-icon" onclick="app.ui.closeModal('modal-export')">&times;</button></div>
            <div class="modal-body">
                <div class="grid grid-2">
                    <div class="card" onclick="app.export.generate('standard')" style="cursor:pointer; border:2px solid transparent; text-align:center;">
                        <i class="fa-solid fa-building" style="font-size:2rem; color:var(--color-primary);"></i>
                        <p>Corporate</p>
                    </div>
                    <div class="card" onclick="app.export.generate('modern')" style="cursor:pointer; border:2px solid transparent; text-align:center;">
                        <i class="fa-solid fa-layer-group" style="font-size:2rem; color:var(--color-purple);"></i>
                        <p>Modern</p>
                    </div>
                    <div class="card" onclick="app.export.generate('list')" style="cursor:pointer; border:2px solid transparent; text-align:center;">
                        <i class="fa-solid fa-list" style="font-size:2rem; color:var(--color-text-muted);"></i>
                        <p>Liste</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-csv" class="modal-overlay">
        <div class="modal">
            <div class="modal-header"><h3>CSV Import</h3><button class="btn-ghost btn-icon" onclick="app.ui.closeModal('modal-csv')">&times;</button></div>
            <div class="modal-body">
                <p style="font-size:0.9rem; color:#666;">Format: <code>Datum; Zeit; Name1, Name2</code></p>
                <textarea id="csv-input" rows="5" placeholder="01.01.; 17:00; Kaspar, Nico"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="app.data.importCSV()">Importieren</button>
            </div>
        </div>
    </div>

    <div id="wizard-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:2000; padding:20px; display:none;">
        <div style="max-width:600px; margin:40px auto; text-align:center;">
            <h1>üöÄ Willkommen beim Planer</h1>
            
            <div id="wiz-step-1" class="wizard-step active">
                <p>Lass uns kurz dein Team einrichten.</p>
                <div class="form-group" style="text-align:left;">
                    <label>F√ºge deine ersten Mitglieder hinzu (Kommagetrennt):</label>
                    <input type="text" id="wiz-names" placeholder="Kaspar, Nico, Dmitry...">
                </div>
                <button class="btn btn-primary w-full" onclick="app.wizard.next(1)">Weiter</button>
            </div>

            <div id="wiz-step-2" class="wizard-step">
                <p>Perfekt! Wer davon ist immer dabei (Stammspieler)?</p>
                <div id="wiz-selection" style="text-align:left; margin-bottom:20px;"></div>
                <button class="btn btn-primary w-full" onclick="app.wizard.finish()">Fertigstellen</button>
            </div>
        </div>
    </div>

    <div id="loader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:3000; display:none; flex-direction:column; justify-content:center; align-items:center;">
        <div class="spinner"></div>
        <h3 id="loader-text">Verarbeite...</h3>
    </div>

    <script>
        /**
         * GITTERTIER PRO V4.0 - CORE LOGIC
         * A monolithic JS structure for stability and ease of copy-paste.
         */

        const app = {
            state: {
                schedule: [],
                members: [],
                settings: {
                    clubName: "SC Brombach",
                    shifts: [
                        { id: 'early', label: '17:00 - 18:30' },
                        { id: 'late', label: '18:15 - 19:45' }
                    ]
                }
            },

            init: function() {
                // Load Data
                const savedSched = localStorage.getItem('gp_schedule');
                const savedMem = localStorage.getItem('gp_members');
                
                if (savedSched) this.state.schedule = JSON.parse(savedSched);
                if (savedMem) this.state.members = JSON.parse(savedMem);

                // Initialize Views
                this.schedule.render();
                this.team.render();
                
                // Show Wizard if empty
                if (!savedMem || this.state.members.length === 0) {
                    this.wizard.start();
                }

                // Date default
                document.getElementById('gen-start').valueAsDate = this.helpers.getNextFriday();
            },

            /* --- UI MANAGER --- */
            ui: {
                switchView: function(viewId, btn) {
                    document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
                    document.getElementById('view-' + viewId).classList.remove('hidden');
                    
                    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                    if(btn) btn.classList.add('active');

                    if(viewId === 'team') app.team.updateChart();
                },
                openModal: function(id) {
                    document.getElementById(id).classList.add('open');
                },
                closeModal: function(id) {
                    document.getElementById(id).classList.remove('open');
                },
                toggleDarkMode: function() {
                    // Simple toggle for demonstration (expandable)
                    document.body.style.filter = document.body.style.filter ? "" : "invert(0.9) hue-rotate(180deg)";
                },
                openWizard: function() {
                    app.wizard.start();
                },
                showLoader: function(msg) {
                    document.getElementById('loader-text').innerText = msg;
                    document.getElementById('loader').style.display = 'flex';
                },
                hideLoader: function() {
                    document.getElementById('loader').style.display = 'none';
                }
            },

            /* --- SCHEDULE LOGIC --- */
            schedule: {
                render: function() {
                    const tbody = document.getElementById('schedule-body');
                    tbody.innerHTML = '';
                    const empty = document.getElementById('empty-state');
                    
                    if (app.state.schedule.length === 0) {
                        empty.style.display = 'block';
                        document.getElementById('stat-total-shifts').innerText = '0';
                        return;
                    }
                    empty.style.display = 'none';
                    document.getElementById('stat-total-shifts').innerText = app.state.schedule.length;

                    // Sort by Date
                    app.state.schedule.sort((a,b) => app.helpers.parseDate(a.date) - app.helpers.parseDate(b.date));

                    app.state.schedule.forEach((row, idx) => {
                        const tr = document.createElement('tr');
                        const count = row.names.split(',').filter(n=>n.trim()).length;
                        
                        tr.innerHTML = `
                            <td><strong>${row.date}</strong></td>
                            <td>${row.time}</td>
                            <td>
                                <div style="font-weight:500;">${row.names}</div>
                                <span class="badge ${count < 3 ? 'badge-emergency' : 'badge-fixed'}">${count} Pers.</span>
                            </td>
                            <td style="text-align:right;">
                                <button class="btn-ghost btn-icon" onclick="app.schedule.openEdit(${idx})"><i class="fa-solid fa-pen"></i></button>
                                <button class="btn-ghost btn-icon" style="color:var(--color-danger);" onclick="app.schedule.delete(${idx})"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    app.data.save();
                },
                addManual: function() {
                    const d = document.getElementById('add-date').value;
                    const t = document.getElementById('add-time').value;
                    const n = document.getElementById('add-names').value;
                    if(d && n) {
                        app.state.schedule.push({date: d, time: t, names: n});
                        app.schedule.render();
                        app.ui.closeModal('modal-add-entry');
                        // Clean inputs
                        document.getElementById('add-names').value = '';
                    }
                },
                delete: function(idx) {
                    if(confirm('Wirklich l√∂schen?')) {
                        app.state.schedule.splice(idx, 1);
                        app.schedule.render();
                    }
                },
                openEdit: function(idx) {
                    const entry = app.state.schedule[idx];
                    document.getElementById('edit-id').value = idx;
                    document.getElementById('edit-date').value = entry.date;
                    document.getElementById('edit-time').value = entry.time;
                    
                    // Generate Member Checkboxes
                    const container = document.getElementById('edit-member-select');
                    container.innerHTML = '';
                    const currentNames = entry.names.split(',').map(n => n.trim());
                    
                    app.state.members.forEach(m => {
                        const isChecked = currentNames.includes(m.name);
                        const div = document.createElement('div');
                        div.innerHTML = `
                            <label class="flex" style="cursor:pointer; padding:5px; border:1px solid #eee; border-radius:4px;">
                                <input type="checkbox" value="${m.name}" ${isChecked ? 'checked' : ''}>
                                ${m.name} <span style="font-size:0.7em; color:#999;">(${m.role})</span>
                            </label>
                        `;
                        container.appendChild(div);
                    });

                    app.ui.openModal('modal-edit-entry');
                },
                saveEdit: function() {
                    const idx = document.getElementById('edit-id').value;
                    const checkboxes = document.querySelectorAll('#edit-member-select input:checked');
                    const selectedNames = Array.from(checkboxes).map(cb => cb.value).join(', ');
                    
                    app.state.schedule[idx].date = document.getElementById('edit-date').value;
                    app.state.schedule[idx].time = document.getElementById('edit-time').value;
                    app.state.schedule[idx].names = selectedNames;
                    
                    app.schedule.render();
                    app.ui.closeModal('modal-edit-entry');
                }
            },

            /* --- TEAM LOGIC --- */
            team: {
                render: function() {
                    const list = document.getElementById('team-list');
                    list.innerHTML = '';
                    document.getElementById('stat-active-helpers').innerText = app.state.members.length;

                    app.state.members.forEach((m, idx) => {
                        const el = document.createElement('div');
                        el.className = 'member-item';
                        let roleColor = '#999';
                        if(m.role === 'fixed') roleColor = 'var(--color-primary)';
                        if(m.role === 'emergency') roleColor = 'var(--color-danger)';

                        el.innerHTML = `
                            <div class="member-info">
                                <div class="role-indicator" style="background:${roleColor}"></div>
                                <div>
                                    <div style="font-weight:600;">${m.name}</div>
                                    <div style="font-size:0.8rem; color:#666;">
                                        ${m.role === 'fixed' ? 'Stamm' : (m.role === 'rotate' ? 'Springer' : 'Notfall')} ‚Ä¢ 
                                        ${m.shift === 'both' ? 'Beide' : (m.shift === 'early' ? 'Fr√ºh' : 'Sp√§t')}
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-ghost" onclick="app.team.openEdit(${idx})"><i class="fa-solid fa-pen"></i></button>
                        `;
                        list.appendChild(el);
                    });
                    app.data.save();
                },
                openAddModal: function() {
                    document.getElementById('mem-id').value = '-1';
                    document.getElementById('mem-name').value = '';
                    document.getElementById('mem-delete-btn').style.display = 'none';
                    app.ui.openModal('modal-member');
                },
                openEdit: function(idx) {
                    const m = app.state.members[idx];
                    document.getElementById('mem-id').value = idx;
                    document.getElementById('mem-name').value = m.name;
                    document.getElementById('mem-role').value = m.role;
                    document.getElementById('mem-shift').value = m.shift;
                    document.getElementById('mem-delete-btn').style.display = 'inline-block';
                    app.ui.openModal('modal-member');
                },
                saveMember: function() {
                    const idx = parseInt(document.getElementById('mem-id').value);
                    const newMem = {
                        name: document.getElementById('mem-name').value,
                        role: document.getElementById('mem-role').value,
                        shift: document.getElementById('mem-shift').value
                    };

                    if(idx === -1) app.state.members.push(newMem);
                    else app.state.members[idx] = newMem;

                    app.team.render();
                    app.ui.closeModal('modal-member');
                },
                deleteMember: function() {
                    const idx = parseInt(document.getElementById('mem-id').value);
                    if(idx > -1 && confirm('L√∂schen?')) {
                        app.state.members.splice(idx, 1);
                        app.team.render();
                        app.ui.closeModal('modal-member');
                    }
                },
                updateChart: function() {
                    const ctx = document.getElementById('fairnessChart').getContext('2d');
                    
                    // Calculate Stats
                    const counts = {};
                    app.state.members.forEach(m => counts[m.name] = 0);
                    app.state.schedule.forEach(row => {
                        const names = row.names.split(',').map(n=>n.trim());
                        names.forEach(n => { if(counts[n] !== undefined) counts[n]++; });
                    });

                    if(window.myChart) window.myChart.destroy();
                    window.myChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(counts),
                            datasets: [{
                                label: 'Eins√§tze',
                                data: Object.values(counts),
                                backgroundColor: 'rgba(37, 99, 235, 0.6)',
                                borderRadius: 4
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
            },

            /* --- GENERATOR (The Brain) --- */
            generator: {
                run: function() {
                    if(app.state.members.length === 0) return alert('Kein Team vorhanden!');

                    app.ui.showLoader("Generiere Plan...");
                    setTimeout(() => {
                        const weeks = parseInt(document.getElementById('gen-weeks').value);
                        const allowDouble = document.getElementById('gen-keep-double').checked;
                        const useEmergency = document.getElementById('gen-use-emergency').checked;
                        let startDate = new Date(document.getElementById('gen-start').value);

                        // Reset Usage Counters (for fair rotation this session)
                        let usage = {};
                        app.state.members.forEach(m => usage[m.name] = 0);

                        for(let i=0; i<weeks; i++) {
                            const dateStr = app.helpers.formatDate(startDate);
                            
                            // Define Slots
                            const slots = [
                                { time: "17:00 - 18:30", type: "early", assigned: [] },
                                { time: "18:15 - 19:45", type: "late", assigned: [] }
                            ];

                            slots.forEach(slot => {
                                // 1. Fixed Players
                                const fixed = app.state.members.filter(m => m.role === 'fixed' && (m.shift === 'both' || m.shift === slot.type));
                                fixed.forEach(m => { slot.assigned.push(m); usage[m.name]++; });

                                // 2. Check for double shifters (if enabled)
                                // If someone is in early shift, prefers 'both', put them in late shift too
                                if(slot.type === 'late' && allowDouble) {
                                    const earlySlot = slots[0]; // Assuming index 0 is early
                                    earlySlot.assigned.forEach(m => {
                                        if(m.shift === 'both' && !slot.assigned.includes(m)) {
                                            slot.assigned.push(m);
                                            usage[m.name]++;
                                        }
                                    });
                                }

                                // 3. Fill Rotation (Fairness weighted)
                                // We need at least 3 people ideally
                                let needed = 3 - slot.assigned.length;
                                if(needed > 0) {
                                    let candidates = app.state.members.filter(m => 
                                        m.role === 'rotate' && 
                                        (m.shift === 'both' || m.shift === slot.type) && 
                                        !slot.assigned.includes(m)
                                    );
                                    
                                    // Sort by usage (ascending) + Random factor
                                    candidates.sort((a,b) => (usage[a.name] - usage[b.name]) + (Math.random() - 0.5));
                                    
                                    for(let k=0; k<needed; k++) {
                                        if(candidates[k]) {
                                            slot.assigned.push(candidates[k]);
                                            usage[candidates[k].name]++;
                                        }
                                    }
                                }
                                
                                // 4. Emergency (if still not enough)
                                if(slot.assigned.length < 2 && useEmergency) {
                                    const emerg = app.state.members.filter(m => m.role === 'emergency' && !slot.assigned.includes(m));
                                    if(emerg.length > 0) slot.assigned.push(emerg[0]);
                                }

                                // Add to Schedule
                                app.state.schedule.push({
                                    date: dateStr,
                                    time: slot.time,
                                    names: slot.assigned.map(x => x.name).join(', ')
                                });
                            });

                            startDate.setDate(startDate.getDate() + 7); // Next week
                        }

                        app.ui.hideLoader();
                        app.schedule.render();
                        app.ui.switchView('dashboard');
                        alert("Plan erfolgreich generiert!");
                    }, 500); // UI delay
                }
            },

            /* --- OCR / DATA --- */
            ocr: {
                process: async function(input) {
                    if (!input.files[0]) return;
                    app.ui.showLoader("Lese Bild (KI)...");
                    
                    try {
                        const worker = await Tesseract.createWorker('deu');
                        const ret = await worker.recognize(input.files[0]);
                        const text = ret.data.text;
                        
                        // Parse logic for the specific screenshot format
                        const lines = text.split('\n');
                        let lastDate = null;
                        let count = 0;

                        const dateRegex = /(\d{2}\.\d{2}\.?)/;

                        lines.forEach(line => {
                            line = line.trim();
                            if(line.length < 3) return;

                            // Is Date?
                            const dateMatch = line.match(dateRegex);
                            if(dateMatch) {
                                lastDate = dateMatch[1];
                                return; // Next line likely has names
                            }

                            // If we have a date, assume this line is Names (or Time+Names)
                            if(lastDate) {
                                // Filter out time if mixed in line
                                let names = line.replace(/\d{1,2}:\d{2}.*?\d{1,2}:\d{2}/, '').replace(dateRegex, '').replace(/[|\[\]_]/g, '');
                                
                                // Heuristic: Line must contain at least one known name or comma
                                if(names.includes(',') || names.length > 5) {
                                    app.state.schedule.push({
                                        date: lastDate,
                                        time: "Importiert",
                                        names: names.trim()
                                    });
                                    count++;
                                }
                            }
                        });

                        await worker.terminate();
                        app.schedule.render();
                        alert(`${count} Eintr√§ge erkannt!`);

                    } catch(e) {
                        alert("Fehler bei OCR: " + e.message);
                    } finally {
                        app.ui.hideLoader();
                    }
                }
            },

            data: {
                save: function() {
                    localStorage.setItem('gp_schedule', JSON.stringify(app.state.schedule));
                    localStorage.setItem('gp_members', JSON.stringify(app.state.members));
                },
                importCSV: function() {
                    const txt = document.getElementById('csv-input').value;
                    const lines = txt.split('\n');
                    let added = 0;
                    lines.forEach(l => {
                        // Intelligent split (semicolon or tab)
                        const parts = l.split(/[;\t]/);
                        if(parts.length >= 2) {
                            app.state.schedule.push({
                                date: parts[0].trim(),
                                time: parts[1].trim(),
                                names: parts[2] ? parts[2].trim() : ""
                            });
                            added++;
                        }
                    });
                    app.schedule.render();
                    app.ui.closeModal('modal-csv');
                    alert(`${added} Zeilen importiert.`);
                }
            },

            /* --- EXPORT --- */
            export: {
                openModal: function() { app.ui.openModal('modal-export'); },
                generate: function(style) {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const pageWidth = doc.internal.pageSize.getWidth();
                    
                    // --- HEADER ---
                    if (style === 'standard') {
                        doc.setFillColor(37, 99, 235); // Blue
                        doc.rect(0, 0, pageWidth, 30, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(20);
                        doc.text("Einsatzplan Jugendtraining", 14, 18);
                        doc.setFontSize(10);
                        doc.text("SC Brombach", 14, 25);
                    } else if (style === 'modern') {
                        doc.setTextColor(37, 99, 235);
                        doc.setFontSize(26);
                        doc.setFont("helvetica", "bold");
                        doc.text("PLAN", 14, 20);
                        doc.setTextColor(0,0,0);
                        doc.setFontSize(12);
                        doc.text("SC Brombach Jugend", 14, 28);
                        doc.setDrawColor(200,200,200);
                        doc.line(14, 32, pageWidth-14, 32);
                    } else { // List
                        doc.setFontSize(18);
                        doc.text("Einsatzplan", 14, 20);
                    }

                    // --- TABLE ---
                    const body = app.state.schedule.map(r => [r.date, r.time, r.names]);
                    
                    let tableConfig = {
                        startY: 40,
                        head: [['Datum', 'Uhrzeit', 'Team']],
                        body: body,
                        styles: { fontSize: 10, cellPadding: 4 },
                        columnStyles: { 0: {cellWidth: 25, fontStyle:'bold'}, 1: {cellWidth: 35} }
                    };

                    if(style === 'standard') {
                        tableConfig.theme = 'grid';
                        tableConfig.headStyles = { fillColor: [37, 99, 235] };
                    } else if(style === 'modern') {
                        tableConfig.theme = 'striped';
                        tableConfig.headStyles = { fillColor: [240, 240, 240], textColor: [0,0,0] };
                    } else {
                        tableConfig.theme = 'plain';
                    }

                    doc.autoTable(tableConfig);

                    // --- FOOTER ---
                    const totalPages = doc.internal.getNumberOfPages();
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    for (let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        doc.text(`Seite ${i} von ${totalPages} | Generiert am ${new Date().toLocaleDateString()}`, 14, doc.internal.pageSize.getHeight() - 10);
                    }

                    doc.save(`plan_${style}.pdf`);
                    app.ui.closeModal('modal-export');
                }
            },

            /* --- WIZARD --- */
            wizard: {
                start: function() {
                    document.getElementById('wizard-overlay').style.display = 'block';
                },
                next: function(step) {
                    if(step === 1) {
                        // Parse names and generate checklist
                        const input = document.getElementById('wiz-names').value;
                        const names = input.split(',').map(n => n.trim()).filter(n=>n);
                        
                        // Add to state temporarily
                        names.forEach(n => {
                            // Avoid duplicates
                            if(!app.state.members.find(m => m.name === n)) {
                                app.state.members.push({ name: n, role: 'rotate', shift: 'both' });
                            }
                        });

                        // Build Selection UI
                        const container = document.getElementById('wiz-selection');
                        container.innerHTML = '';
                        app.state.members.forEach((m, idx) => {
                            const div = document.createElement('div');
                            div.innerHTML = `
                                <label style="display:block; padding:10px; border-bottom:1px solid #eee;">
                                    <input type="checkbox" onchange="app.state.members[${idx}].role = this.checked ? 'fixed' : 'rotate'"> 
                                    ${m.name} ist Stammspieler
                                </label>
                            `;
                            container.appendChild(div);
                        });

                        document.getElementById('wiz-step-1').classList.remove('active');
                        document.getElementById('wiz-step-2').classList.add('active');
                    }
                },
                finish: function() {
                    document.getElementById('wizard-overlay').style.display = 'none';
                    app.team.render();
                    app.data.save();
                }
            },

            helpers: {
                getNextFriday: function() {
                    const d = new Date();
                    d.setDate(d.getDate() + (5 + 7 - d.getDay()) % 7);
                    return d;
                },
                formatDate: function(date) {
                    let d = date.getDate();
                    let m = date.getMonth() + 1;
                    return (d < 10 ? '0'+d : d) + '.' + (m < 10 ? '0'+m : m) + '.';
                },
                parseDate: function(dateStr) {
                    // Primitive parse for sorting "DD.MM."
                    const parts = dateStr.split('.');
                    if(parts.length < 2) return 0;
                    return parseInt(parts[1])*100 + parseInt(parts[0]);
                }
            }
        };

        // Boot
        document.addEventListener('DOMContentLoaded', () => app.init());

    </script>
</body>
</html>