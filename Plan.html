<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Einsatzplaner - SC Brombach</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <style>
        /* --- Design System (Analog zu 404.html) --- */
        :root {
            --color-bg: #f9fafb;
            --color-card-bg: #ffffff;
            --color-text: #111111;
            --color-text-muted: #6b7280;
            --color-border: #e5e7eb;
            --color-accent: #2563eb;       /* Gittertier Blau */
            --color-accent-hover: #1d4ed8;
            --color-success: #16a34a;
            --color-danger: #dc2626;
            --color-overlay: rgba(0, 0, 0, 0.5);
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, "Helvetica Neue", Arial, sans-serif;
            
            --header-height: 64px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-family);
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding-bottom: 80px;
        }

        /* --- Header --- */
        header {
            height: var(--header-height);
            background-color: var(--color-card-bg);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: var(--shadow-sm);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--color-text);
            text-decoration: none;
        }
        .logo i { color: var(--color-accent); font-size: 1.2rem; }
        .logo img { height: 32px; width: auto; }

        .header-actions { display: flex; gap: 10px; }

        /* --- Layout & Cards --- */
        main {
            max-width: 900px;
            margin: 24px auto;
            padding: 0 16px;
        }

        .card {
            background: var(--color-card-bg);
            border-radius: var(--radius);
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 24px;
        }

        h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        h2 i { color: var(--color-accent); }

        h3 {
            font-size: 1rem;
            font-weight: 600;
            margin: 16px 0 8px 0;
            color: var(--color-text);
        }

        p { color: var(--color-text-muted); font-size: 0.95rem; line-height: 1.5; margin-bottom: 16px; }

        /* --- Tabs Navigation --- */
        .tabs {
            display: flex;
            background: #e5e7eb;
            padding: 4px;
            border-radius: var(--radius);
            margin-bottom: 24px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-weight: 500;
            color: var(--color-text-muted);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
        }
        
        .tab-btn.active {
            background-color: white;
            color: var(--color-accent);
            box-shadow: var(--shadow-sm);
        }

        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Forms & Inputs --- */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--color-text-muted);
            margin-bottom: 6px;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 1rem;
            background: #fff;
            transition: border-color 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* --- Buttons --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            text-decoration: none;
        }

        .btn-primary { background-color: var(--color-accent); color: white; }
        .btn-primary:hover { background-color: var(--color-accent-hover); }

        .btn-secondary { background-color: white; border: 1px solid var(--color-border); color: var(--color-text); }
        .btn-secondary:hover { background-color: #f9fafb; border-color: var(--color-text-muted); }

        .btn-danger { background-color: #fee2e2; color: var(--color-danger); }
        .btn-icon { padding: 8px; border-radius: 6px; background: transparent; color: var(--color-text-muted); border: none; cursor: pointer; font-size: 1.1rem; }
        .btn-icon:hover { background-color: #f3f4f6; color: var(--color-text); }

        .w-full { width: 100%; }

        /* --- Team Manager List --- */
        .team-list { display: flex; flex-direction: column; gap: 12px; }
        
        .team-member {
            background: #f9fafb;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .member-header { display: flex; justify-content: space-between; align-items: center; font-weight: 600; }
        
        .chip-group { display: flex; gap: 8px; flex-wrap: wrap; }
        
        .chip {
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 20px;
            border: 1px solid var(--color-border);
            background: white;
            color: var(--color-text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .chip.active {
            background: #eff6ff;
            border-color: var(--color-accent);
            color: var(--color-accent);
            font-weight: 600;
        }

        /* --- Tabelle --- */
        .table-container {
            border: 1px solid var(--color-border);
            border-radius: 8px;
            overflow: hidden;
            overflow-x: auto;
        }

        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        
        th {
            background-color: #f9fafb;
            padding: 12px 16px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--color-text-muted);
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        td { padding: 12px 16px; border-bottom: 1px solid var(--color-border); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            background: #f3f4f6;
            color: var(--color-text);
        }
        .badge.early { background: #dbeafe; color: #1e40af; } /* Blau */
        .badge.late { background: #fae8ff; color: #86198f; } /* Lila */

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--color-overlay);
            z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: all 0.2s;
            backdrop-filter: blur(2px);
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        
        .modal {
            background: white;
            width: 90%; max-width: 500px;
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            transform: scale(0.95); transition: all 0.2s;
        }
        .modal-overlay.active .modal { transform: scale(1); }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 1.2rem; font-weight: 700; }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--color-text-muted); }

        /* --- Responsive --- */
        @media (min-width: 768px) {
            .team-member { flex-direction: row; align-items: center; justify-content: space-between; }
            .member-header { width: 150px; }
        }
        @media (max-width: 600px) {
            .form-grid { grid-template-columns: 1fr; }
            h2 { font-size: 1.1rem; }
        }
    </style>
</head>
<body>

    <header>
        <a href="#" class="logo">
            <img src="https://www.loerrach.de/ceasy/resource/3714" alt="SC Logo">
            <span>SC Brombach</span>
        </a>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="openModal('pdfModal')">
                <i class="fa-solid fa-file-pdf"></i> <span style="display:none; @media(min-width:600px){display:inline;}">Export</span>
            </button>
        </div>
    </header>

    <main>
        <div class="tabs">
            <button class="tab-btn active" onclick="switchView('plan')">üìÖ Einsatzplan</button>
            <button class="tab-btn" onclick="switchView('team')">üë• Team & Settings</button>
            <button class="tab-btn" onclick="switchView('generator')">‚ö° Smart-Generator</button>
        </div>

        <div id="view-plan" class="view-section active">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                    <h2><i class="fa-solid fa-calendar-check"></i> Aktuelle Termine</h2>
                    <span id="entriesCount" class="badge">0 Eintr√§ge</span>
                </div>

                <div class="table-container">
                    <table id="scheduleTable">
                        <thead>
                            <tr>
                                <th>Datum</th>
                                <th>Schicht</th>
                                <th>Team</th>
                                <th style="text-align:right">Optionen</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            </tbody>
                    </table>
                </div>
                
                <div id="emptyState" style="text-align:center; padding: 40px; color: var(--color-text-muted);">
                    <i class="fa-solid fa-clipboard-list" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.3;"></i>
                    <p>Noch keine Eintr√§ge vorhanden.</p>
                    <button class="btn btn-secondary" onclick="switchView('generator')">Jetzt Plan generieren</button>
                </div>

                <div style="margin-top: 20px; display:flex; gap:10px;">
                    <button class="btn btn-secondary w-full" onclick="openModal('manualModal')"><i class="fa-solid fa-plus"></i> Manuell</button>
                    <button class="btn btn-secondary w-full" onclick="openModal('csvModal')"><i class="fa-solid fa-file-csv"></i> CSV</button>
                </div>
            </div>
        </div>

        <div id="view-team" class="view-section">
            <div class="card">
                <h2><i class="fa-solid fa-users-gear"></i> Teilnehmer verwalten</h2>
                <p>Hier legst du fest, wer wie oft kommen kann. Der Generator nutzt diese Daten.</p>

                <div id="teamList" class="team-list">
                    </div>

                <div style="margin-top: 20px; border-top: 1px solid var(--color-border); padding-top: 20px;">
                    <div class="form-grid">
                        <input type="text" id="newMemberName" placeholder="Name (z.B. Bastian)">
                        <button class="btn btn-primary" onclick="addTeamMember()">Hinzuf√ºgen</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-generator" class="view-section">
            <div class="card">
                <h2><i class="fa-solid fa-wand-magic-sparkles"></i> Smarte Einteilung</h2>
                <p>Der Algorithmus erstellt einen fairen Plan. Stammspieler werden gesetzt, Springer f√ºllen die L√ºcken auf.</p>
                
                <div class="form-grid">
                    <div>
                        <label>Startdatum (N√§chster Freitag)</label>
                        <input type="date" id="genStartDate">
                    </div>
                    <div>
                        <label>Zeitraum</label>
                        <select id="genWeeks">
                            <option value="4">4 Wochen</option>
                            <option value="8" selected>8 Wochen</option>
                            <option value="12">12 Wochen</option>
                        </select>
                    </div>
                </div>

                <div style="background: #eff6ff; padding: 12px; border-radius: 8px; border: 1px solid #dbeafe; margin-bottom: 20px;">
                    <h3 style="margin-top:0; font-size:0.9rem; color:#1e40af;"><i class="fa-solid fa-circle-info"></i> Logik</h3>
                    <ul style="font-size: 0.85rem; color: #1e3a8a; padding-left: 20px; margin: 5px 0;">
                        <li><strong>Fr√ºhschicht:</strong> 17:00 - 18:30</li>
                        <li><strong>Sp√§tschicht:</strong> 18:15 - 19:45</li>
                        <li>Stammspieler werden bevorzugt eingeteilt.</li>
                        <li>Springer rotieren fair (Wer wenig dran war, kommt dran).</li>
                    </ul>
                </div>

                <button class="btn btn-primary w-full" onclick="runGenerator()">
                    Plan Generieren
                </button>
            </div>

            <div class="card">
                <h2><i class="fa-solid fa-camera"></i> Foto-Import (Beta)</h2>
                <p>Lade einen alten Plan hoch, um Daten zu extrahieren.</p>
                <input type="file" id="ocrInput" accept="image/*" onchange="runOCR(this)" style="display:block; width:100%;">
                <div id="ocrStatus" style="margin-top:10px; font-size:0.85rem; color: var(--color-accent);"></div>
            </div>
        </div>
    </main>

    <div id="manualModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Eintrag hinzuf√ºgen</div>
                <button class="close-modal" onclick="closeModal('manualModal')">&times;</button>
            </div>
            <div class="form-grid">
                <div>
                    <label>Datum</label>
                    <input type="text" id="manDate" placeholder="TT.MM.">
                </div>
                <div>
                    <label>Zeit</label>
                    <input type="text" id="manTime" value="17:00 - 18:30">
                </div>
                <div style="grid-column: 1/-1;">
                    <label>Namen (Kommagetrennt)</label>
                    <input type="text" id="manNames" placeholder="Kaspar, Uwe...">
                </div>
            </div>
            <button class="btn btn-primary w-full" onclick="saveManualEntry()">Speichern</button>
        </div>
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Eintrag bearbeiten</div>
                <button class="close-modal" onclick="closeModal('editModal')">&times;</button>
            </div>
            <input type="hidden" id="editIndex">
            <div class="form-grid">
                <div>
                    <label>Datum</label>
                    <input type="text" id="editDate">
                </div>
                <div>
                    <label>Zeit</label>
                    <input type="text" id="editTime">
                </div>
                <div style="grid-column: 1/-1;">
                    <label>Namen</label>
                    <input type="text" id="editNames">
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-danger" onclick="deleteEntryFromEdit()">L√∂schen</button>
                <button class="btn btn-primary w-full" onclick="saveEditEntry()">√Ñnderungen speichern</button>
            </div>
        </div>
    </div>

    <div id="pdfModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">PDF Exportieren</div>
                <button class="close-modal" onclick="closeModal('pdfModal')">&times;</button>
            </div>
            <p>W√§hle ein Design f√ºr den Aushang:</p>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                <button class="btn btn-secondary" onclick="generatePDF('standard')">Standard (Blau)</button>
                <button class="btn btn-secondary" onclick="generatePDF('bw')">Schachclub (S/W)</button>
                <button class="btn btn-secondary" onclick="generatePDF('minimal')">Minimal</button>
                <button class="btn btn-secondary" onclick="generatePDF('compact')">Kompakt</button>
            </div>
            <button class="btn btn-primary w-full" onclick="generatePDF('standard')">Standard herunterladen</button>
        </div>
    </div>

    <div id="csvModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">CSV Import/Export</div>
                <button class="close-modal" onclick="closeModal('csvModal')">&times;</button>
            </div>
            <textarea id="csvText" rows="5" placeholder="Datum;Zeit;Namen" style="width:100%; margin-bottom:10px; font-family:monospace;"></textarea>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-primary w-full" onclick="importCSV()">Importieren</button>
                <button class="btn btn-secondary w-full" onclick="exportCSV()">Exportieren</button>
            </div>
        </div>
    </div>

    <script>
        // --- INITIAL DATA ---
        // L√§dt Daten aus LocalStorage oder nutzt Standardwerte
        let schedule = JSON.parse(localStorage.getItem('sc_schedule')) || [];
        
        // Standard-Team (Falls noch keins existiert)
        let team = JSON.parse(localStorage.getItem('sc_team')) || [
            { id: 1, name: "Kaspar", type: "fixed", shift: "both" },  // fixed = Stamm, rotate = Springer
            { id: 2, name: "Uwe", type: "rotate", shift: "late" },    // early, late, both
            { id: 3, name: "Nico", type: "rotate", shift: "both" },
            { id: 4, name: "Dmitry", type: "rotate", shift: "both" },
            { id: 5, name: "Gento", type: "rotate", shift: "early" },
            { id: 6, name: "Stephan", type: "rotate", shift: "early" }
        ];

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            renderSchedule();
            renderTeam();
            
            // Setze Datum auf n√§chsten Freitag
            const nextFri = new Date();
            nextFri.setDate(nextFri.getDate() + (5 + 7 - nextFri.getDay()) % 7);
            document.getElementById('genStartDate').valueAsDate = nextFri;
        });

        // --- VIEW NAVIGATION ---
        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById('view-' + viewId).classList.add('active');
            
            // Tab Button Highlight Logic (Index based simple match)
            const btns = document.querySelectorAll('.tab-btn');
            if(viewId === 'plan') btns[0].classList.add('active');
            if(viewId === 'team') btns[1].classList.add('active');
            if(viewId === 'generator') btns[2].classList.add('active');
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        // --- TEAM MANAGEMENT ---
        function renderTeam() {
            const list = document.getElementById('teamList');
            list.innerHTML = '';
            
            team.forEach((member, index) => {
                const el = document.createElement('div');
                el.className = 'team-member';
                el.innerHTML = `
                    <div class="member-header">
                        <span>${member.name}</span>
                        <button class="btn-icon" style="color:var(--color-danger);" onclick="deleteMember(${index})"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    
                    <div style="display:flex; flex-direction:column; gap:8px; width:100%;">
                        <div class="chip-group">
                            <span class="chip ${member.type === 'fixed' ? 'active' : ''}" onclick="updateMember(${index}, 'type', 'fixed')">Stammspieler</span>
                            <span class="chip ${member.type === 'rotate' ? 'active' : ''}" onclick="updateMember(${index}, 'type', 'rotate')">Springer</span>
                        </div>
                        
                        <div class="chip-group">
                            <span class="chip ${member.shift === 'early' ? 'active' : ''}" onclick="updateMember(${index}, 'shift', 'early')">17:00</span>
                            <span class="chip ${member.shift === 'late' ? 'active' : ''}" onclick="updateMember(${index}, 'shift', 'late')">18:15</span>
                            <span class="chip ${member.shift === 'both' ? 'active' : ''}" onclick="updateMember(${index}, 'shift', 'both')">Egal</span>
                        </div>
                    </div>
                `;
                list.appendChild(el);
            });
            localStorage.setItem('sc_team', JSON.stringify(team));
        }

        function addTeamMember() {
            const name = document.getElementById('newMemberName').value.trim();
            if(!name) return;
            team.push({ id: Date.now(), name: name, type: 'rotate', shift: 'both' });
            document.getElementById('newMemberName').value = '';
            renderTeam();
        }

        function updateMember(index, key, value) {
            team[index][key] = value;
            renderTeam();
        }

        function deleteMember(index) {
            if(confirm('Teilnehmer wirklich l√∂schen?')) {
                team.splice(index, 1);
                renderTeam();
            }
        }

        // --- SCHEDULING LOGIC ---
        function renderSchedule() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            if(schedule.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                document.querySelector('.table-container').style.display = 'none';
                document.getElementById('entriesCount').innerText = '0';
                return;
            }

            document.getElementById('emptyState').style.display = 'none';
            document.querySelector('.table-container').style.display = 'block';
            document.getElementById('entriesCount').innerText = schedule.length;

            schedule.forEach((row, index) => {
                const tr = document.createElement('tr');
                
                // Badge Logic f√ºr Schichten
                let badgeClass = 'badge';
                if(row.time.includes('17')) badgeClass += ' early';
                if(row.time.includes('18:15') || row.time.includes('18:00')) badgeClass += ' late';

                tr.innerHTML = `
                    <td style="font-weight:600;">${row.date}</td>
                    <td><span class="${badgeClass}">${row.time}</span></td>
                    <td>${row.names}</td>
                    <td style="text-align:right;">
                        <button class="btn-icon" onclick="openEdit(${index})"><i class="fa-solid fa-pen"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            localStorage.setItem('sc_schedule', JSON.stringify(schedule));
        }

        function runGenerator() {
            const weeks = parseInt(document.getElementById('genWeeks').value);
            let currentDate = document.getElementById('genStartDate').valueAsDate;
            if(!currentDate) return alert("Bitte Startdatum w√§hlen!");

            // Fairness Tracker: Z√§hlt wie oft jemand schon dran war
            let usageCount = {};
            team.forEach(m => usageCount[m.name] = 0);

            let newEntries = [];

            for(let i=0; i<weeks; i++) {
                // Datum formatieren
                let d = currentDate.getDate();
                let m = currentDate.getMonth() + 1;
                let dateStr = (d<10?'0'+d:d) + '.' + (m<10?'0'+m:m) + '.';

                // Zwei Slots definieren
                const slots = [
                    { time: "17:00 - 18:30", type: "early" },
                    { time: "18:15 - 19:45", type: "late" }
                ];

                slots.forEach(slot => {
                    let assigned = [];

                    // 1. Stammspieler hinzuf√ºgen (Typ Fixed)
                    const fixed = team.filter(p => p.type === 'fixed' && (p.shift === 'both' || p.shift === slot.type));
                    fixed.forEach(p => {
                        assigned.push(p.name);
                        usageCount[p.name]++;
                    });

                    // 2. Springer auff√ºllen (Typ Rotate)
                    // Wir brauchen mind. 3 Leute (oder alle, wenn weniger da sind)
                    let candidates = team.filter(p => 
                        p.type === 'rotate' && 
                        (p.shift === 'both' || p.shift === slot.type) &&
                        !assigned.includes(p.name) // Nicht doppelt buchen
                    );

                    // Sortieren nach Fairness (Wer hat am wenigsten Eins√§tze?) + Zufall
                    candidates.sort((a, b) => {
                        let diff = usageCount[a.name] - usageCount[b.name];
                        if(diff !== 0) return diff;
                        return 0.5 - Math.random();
                    });

                    // Auff√ºllen bis z.B. 3 Personen (Konfigurierbar, hier hardcoded f√ºr "voll")
                    // Wenn 1 Stamm da ist, nehmen wir noch 2 Springer dazu.
                    let needed = Math.max(0, 3 - assigned.length);
                    for(let k=0; k<needed; k++) {
                        if(candidates[k]) {
                            assigned.push(candidates[k].name);
                            usageCount[candidates[k].name]++;
                        }
                    }

                    newEntries.push({
                        date: dateStr,
                        time: slot.time,
                        names: assigned.join(', ')
                    });
                });

                // Woche weiter
                currentDate.setDate(currentDate.getDate() + 7);
            }

            if(confirm("Plan erstellt! Bestehende Eintr√§ge √ºberschreiben? (Abbrechen = Anh√§ngen)")) {
                schedule = newEntries;
            } else {
                schedule = schedule.concat(newEntries);
            }
            
            renderSchedule();
            switchView('plan');
        }

        // --- EDITING & MANUAL ---
        function saveManualEntry() {
            const date = document.getElementById('manDate').value;
            const time = document.getElementById('manTime').value;
            const names = document.getElementById('manNames').value;
            
            if(date && names) {
                schedule.push({ date, time, names });
                renderSchedule();
                closeModal('manualModal');
                // Reset Fields
                document.getElementById('manNames').value = '';
            }
        }

        function openEdit(index) {
            const item = schedule[index];
            document.getElementById('editIndex').value = index;
            document.getElementById('editDate').value = item.date;
            document.getElementById('editTime').value = item.time;
            document.getElementById('editNames').value = item.names;
            openModal('editModal');
        }

        function saveEditEntry() {
            const idx = document.getElementById('editIndex').value;
            schedule[idx] = {
                date: document.getElementById('editDate').value,
                time: document.getElementById('editTime').value,
                names: document.getElementById('editNames').value
            };
            renderSchedule();
            closeModal('editModal');
        }

        function deleteEntryFromEdit() {
            const idx = document.getElementById('editIndex').value;
            schedule.splice(idx, 1);
            renderSchedule();
            closeModal('editModal');
        }

        // --- PDF GENERATION ---
        function generatePDF(design) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Zeitraum berechnen
            let dateRange = "";
            if(schedule.length > 0) {
                dateRange = `${schedule[0].date} - ${schedule[schedule.length-1].date}`;
            }

            // Design Einstellungen
            let headColor = [37, 99, 235]; // Blau
            let textColor = 255;
            let theme = 'grid';

            if(design === 'bw') { headColor = [20, 20, 20]; theme = 'grid'; }
            if(design === 'minimal') { headColor = [255, 255, 255]; textColor = 0; theme = 'plain'; }

            // Header Box
            if(design !== 'minimal') {
                doc.setFillColor(...headColor);
                doc.rect(0, 0, 210, 40, 'F');
                doc.setTextColor(255, 255, 255);
            } else {
                doc.setTextColor(0,0,0);
            }

            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("Einsatzplan Jugendtraining", 14, 20);
            
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(`SC Brombach | Zeitraum: ${dateRange}`, 14, 30);

            const rows = schedule.map(s => [s.date, s.time, s.names]);

            doc.autoTable({
                startY: 45,
                head: [['Datum', 'Uhrzeit', 'Team']],
                body: rows,
                theme: theme,
                headStyles: { 
                    fillColor: (design === 'minimal' ? [240,240,240] : headColor), 
                    textColor: (design === 'minimal' ? 0 : 255),
                    fontStyle: 'bold'
                },
                columnStyles: {
                    0: { cellWidth: 30, fontStyle: 'bold' },
                    1: { cellWidth: 40 }
                },
                styles: { fontSize: (design === 'compact' ? 9 : 11), cellPadding: 4 }
            });

            doc.save('Einsatzplan.pdf');
            closeModal('pdfModal');
        }

        // --- CSV ---
        function importCSV() {
            const text = document.getElementById('csvText').value;
            const lines = text.split('\n');
            lines.forEach(l => {
                const parts = l.split(';');
                if(parts.length >= 3) {
                    schedule.push({ date: parts[0].trim(), time: parts[1].trim(), names: parts[2].trim() });
                }
            });
            renderSchedule();
            closeModal('csvModal');
        }

        function exportCSV() {
            let txt = "";
            schedule.forEach(s => {
                txt += `${s.date};${s.time};${s.names}\n`;
            });
            document.getElementById('csvText').value = txt;
        }

        // --- OCR (Tesseract) ---
        async function runOCR(input) {
            if(!input.files[0]) return;
            const stat = document.getElementById('ocrStatus');
            stat.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Analysiere Bild...';
            
            try {
                const worker = await Tesseract.createWorker('deu');
                const ret = await worker.recognize(input.files[0]);
                stat.innerHTML = '<i class="fa-solid fa-check"></i> Fertig! Daten werden interpretiert...';
                
                const lines = ret.data.text.split('\n');
                let found = 0;
                let lastDate = "??.??.";

                lines.forEach(line => {
                    // Simpler Parser f√ºr Datum
                    const dateMatch = line.match(/(\d{1,2}\.\d{1,2}\.?)/);
                    if(dateMatch) lastDate = dateMatch[1];
                    
                    // Suche nach Namen aus dem Team
                    let foundNames = [];
                    team.forEach(t => {
                        if(line.includes(t.name)) foundNames.push(t.name);
                    });

                    if(foundNames.length > 0) {
                        schedule.push({
                            date: lastDate,
                            time: "Importiert",
                            names: foundNames.join(', ')
                        });
                        found++;
                    }
                });
                
                await worker.terminate();
                renderSchedule();
                switchView('plan');
                alert(found + " Eintr√§ge gefunden und hinzugef√ºgt.");
                stat.innerHTML = "";

            } catch(e) {
                console.error(e);
                stat.innerHTML = "Fehler bei der Erkennung.";
            }
        }

    </script>
</body>
</html>
