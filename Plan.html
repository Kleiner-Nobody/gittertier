<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gittertier Pro - Smart Planer</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <style>
        /* --- DESIGN SYSTEM (Basiert auf 404.html) --- */
        :root {
            --color-bg: #ffffff;
            --color-surface: #f9fafb;
            --color-card: #ffffff;
            --color-text: #111111;
            --color-text-muted: #6b7280;
            --color-border: #e5e7eb;
            --color-accent: #2563eb;
            --color-accent-hover: #1d4ed8;
            --color-success: #16a34a;
            --color-warning: #f59e0b;
            --color-error: #dc2626;
            --color-overlay: rgba(0, 0, 0, 0.6);
            
            --radius: 12px;
            --radius-sm: 6px;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.07), 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, Helvetica, Arial, sans-serif;
            --header-height: 70px;
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --color-bg: #111827;
                --color-surface: #1f2937;
                --color-card: #1f2937;
                --color-text: #f3f4f6;
                --color-text-muted: #9ca3af;
                --color-border: #374151;
                --shadow: 0 1px 3px rgba(0,0,0,0.3);
            }
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background-color: var(--color-surface);
            color: var(--color-text);
            padding-bottom: 80px; /* Platz f√ºr Mobile Buttons */
        }

        /* --- LAYOUT --- */
        header {
            height: var(--header-height);
            background: var(--color-card);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: var(--shadow-sm);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--color-text);
            text-decoration: none;
        }
        .brand img { height: 38px; width: auto; }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* --- CARDS & GRID --- */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--color-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 24px;
            transition: transform 0.2s;
            position: relative;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        h2 { font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        h3 { font-size: 1rem; font-weight: 600; margin-bottom: 10px; color: var(--color-text-muted); }

        /* --- UI ELEMENTS --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 18px;
            border-radius: var(--radius-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            font-size: 0.95rem;
        }
        .btn-primary { background: var(--color-accent); color: white; }
        .btn-primary:hover { background: var(--color-accent-hover); box-shadow: var(--shadow-md); transform: translateY(-1px); }
        .btn-secondary { background: var(--color-card); border-color: var(--color-border); color: var(--color-text); }
        .btn-secondary:hover { background: var(--color-surface); }
        .btn-ghost { background: transparent; color: var(--color-text-muted); padding: 6px; }
        .btn-ghost:hover { color: var(--color-accent); background: rgba(37, 99, 235, 0.1); }
        .btn-block { width: 100%; }

        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            background: var(--color-card);
            color: var(--color-text);
            font-size: 1rem;
            margin-bottom: 10px;
            transition: border 0.2s;
        }
        input:focus { outline: none; border-color: var(--color-accent); ring: 2px solid rgba(37,99,235,0.2); }

        /* --- TEAM LIST (Modern) --- */
        .team-list { display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto; }
        .member-row {
            display: flex;
            align-items: center;
            padding: 10px;
            background: var(--color-surface);
            border-radius: var(--radius-sm);
            border: 1px solid var(--color-border);
            gap: 10px;
        }
        .avatar {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: var(--color-accent);
            color: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 0.8rem;
        }
        .member-info { flex: 1; }
        .member-name { font-weight: 600; font-size: 0.95rem; }
        .member-details { font-size: 0.8rem; color: var(--color-text-muted); display: flex; gap: 8px; }
        
        .tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: 700; }
        .tag-stamm { background: #dbeafe; color: #1e40af; }
        .tag-springer { background: #f3f4f6; color: #4b5563; }
        .tag-notfall { background: #fee2e2; color: #991b1b; }

        /* --- SCHEDULE TABLE --- */
        .schedule-container {
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            overflow: hidden;
            background: var(--color-card);
        }
        .schedule-row {
            display: grid;
            grid-template-columns: 100px 1fr 1fr auto;
            border-bottom: 1px solid var(--color-border);
            padding: 15px;
            align-items: center;
            transition: background 0.1s;
        }
        .schedule-row:last-child { border-bottom: none; }
        .schedule-row:hover { background: var(--color-surface); }
        
        .date-cell { font-weight: 700; display: flex; flex-direction: column; }
        .date-day { font-size: 0.8rem; color: var(--color-text-muted); text-transform: uppercase; }
        
        .shift-block { display: flex; flex-direction: column; gap: 4px; padding: 0 10px; }
        .shift-label { font-size: 0.75rem; color: var(--color-text-muted); font-weight: 600; margin-bottom: 2px; }
        .person-pill { 
            display: inline-block; padding: 4px 8px; 
            background: var(--color-surface); border: 1px solid var(--color-border); 
            border-radius: 100px; font-size: 0.85rem; margin-right: 4px; margin-bottom: 4px;
        }
        
        /* Mobile Schedule View */
        @media (max-width: 768px) {
            .schedule-row { grid-template-columns: 1fr; gap: 10px; }
            .date-cell { flex-direction: row; gap: 10px; align-items: baseline; border-bottom: 1px dashed var(--color-border); padding-bottom: 8px; margin-bottom: 4px; }
        }

        /* --- MODALS & WIZARD --- */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--color-overlay);
            z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            backdrop-filter: blur(4px);
        }
        .modal-backdrop.active { opacity: 1; pointer-events: auto; }
        
        .modal {
            background: var(--color-card);
            width: 90%; max-width: 550px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 30px;
            transform: translateY(20px); transition: transform 0.3s;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-backdrop.active .modal { transform: translateY(0); }

        .wizard-steps { display: flex; gap: 5px; margin-bottom: 20px; }
        .step-dot { flex: 1; height: 4px; background: var(--color-border); border-radius: 2px; }
        .step-dot.active { background: var(--color-accent); }
        
        .wizard-content { display: none; animation: fadeIn 0.3s; }
        .wizard-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- FLOATING ACTION BUTTON (Mobile) --- */
        .fab {
            position: fixed; bottom: 20px; right: 20px;
            width: 56px; height: 56px;
            border-radius: 50%;
            background: var(--color-accent);
            color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-lg);
            z-index: 90;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .fab:hover { transform: scale(1.1); }
        .fab:active { transform: scale(0.9); }

        /* --- NOTIFICATIONS --- */
        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 12px 24px;
            border-radius: 50px; font-size: 0.9rem;
            opacity: 0; transition: 0.3s; pointer-events: none; z-index: 200;
        }
        .toast.show { opacity: 1; bottom: 40px; }

    </style>
</head>
<body>

    <header>
        <a href="#" class="brand">
            <img src="https://www.loerrach.de/ceasy/resource/3714" alt="Logo">
            Gittertier Pro <span style="font-size: 0.7rem; background: var(--color-accent); color: white; padding: 2px 6px; border-radius: 4px;">ULTRA</span>
        </a>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-ghost" onclick="toggleTheme()"><i class="fa-solid fa-moon"></i></button>
            <button class="btn btn-primary" onclick="openWizard()"><i class="fa-solid fa-wand-magic-sparkles"></i> <span class="desktop-only">Generator</span></button>
        </div>
    </header>

    <div class="container">
        
        <div class="grid">
            
            <div style="grid-column: span 2; display: flex; flex-direction: column; gap: 20px;">
                
                <div class="card" style="padding: 15px; display: flex; gap: 10px; overflow-x: auto;">
                    <button class="btn btn-secondary" onclick="exportPDF()"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                    <button class="btn btn-secondary" onclick="exportWhatsApp()"><i class="fa-brands fa-whatsapp"></i> WhatsApp</button>
                    <button class="btn btn-secondary" onclick="exportICAL()"><i class="fa-solid fa-calendar-plus"></i> iCal</button>
                    <button class="btn btn-secondary" onclick="openCSVModal()"><i class="fa-solid fa-file-csv"></i> Import</button>
                    <div style="flex:1"></div>
                    <button class="btn btn-ghost" style="color:var(--color-error)" onclick="resetAll()"><i class="fa-solid fa-trash"></i> Reset</button>
                </div>

                <div class="card" style="padding: 0; overflow: hidden;">
                    <div class="card-header" style="padding: 20px; border-bottom: 1px solid var(--color-border); margin-bottom: 0;">
                        <h2>üìÖ Einsatzplan <span id="planRange" style="font-size: 0.9rem; color: var(--color-text-muted); font-weight: 400; margin-left: 10px;"></span></h2>
                        <div id="ai-alert" style="display:none; font-size: 0.8rem; background: #fee2e2; color: #dc2626; padding: 5px 10px; border-radius: 20px;">
                            <i class="fa-solid fa-triangle-exclamation"></i> Unterbesetzung erkannt!
                        </div>
                    </div>
                    
                    <div class="schedule-container" id="scheduleList" style="border: none; border-radius: 0;">
                        <div style="padding: 40px; text-align: center; color: var(--color-text-muted);">
                            <i class="fa-solid fa-robot" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            <p>Kein Plan vorhanden.<br>Starte den Generator oder importiere eine CSV.</p>
                        </div>
                    </div>
                </div>

            </div>

            <div style="display: flex; flex-direction: column; gap: 20px;">
                
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fa-solid fa-chart-pie"></i> Fairness Check</h2>
                    </div>
                    <canvas id="statsChart" style="max-height: 200px;"></canvas>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2><i class="fa-solid fa-users"></i> Das Team</h2>
                        <button class="btn btn-ghost" onclick="openTeamModal()"><i class="fa-solid fa-pen"></i></button>
                    </div>
                    <div id="teamDisplay" class="team-list">
                        </div>
                </div>

            </div>
        </div>

    </div>

    <div class="fab" onclick="openWizard()">
        <i class="fa-solid fa-plus"></i>
    </div>

    <div id="wizardModal" class="modal-backdrop">
        <div class="modal">
            <div class="modal-header" style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h2>‚ö° Smart Generator</h2>
                <button class="btn btn-ghost" onclick="closeModal('wizardModal')">&times;</button>
            </div>
            
            <div class="wizard-steps">
                <div class="step-dot active" id="dot1"></div>
                <div class="step-dot" id="dot2"></div>
                <div class="step-dot" id="dot3"></div>
            </div>

            <div id="step1" class="wizard-content active">
                <h3>Zeitraum w√§hlen</h3>
                <label>Startdatum (Freitag)</label>
                <input type="date" id="wizStartDate">
                <label>Anzahl Wochen</label>
                <select id="wizWeeks">
                    <option value="4">4 Wochen</option>
                    <option value="8" selected>8 Wochen</option>
                    <option value="12">12 Wochen</option>
                </select>
                <div style="margin-top: 20px; text-align: right;">
                    <button class="btn btn-primary btn-block" onclick="wizNext(2)">Weiter zu Team</button>
                </div>
            </div>

            <div id="step2" class="wizard-content">
                <h3>Wer ist verf√ºgbar?</h3>
                <p style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">Deaktiviere Personen, die im Urlaub sind.</p>
                <div id="wizTeamList" class="team-list" style="max-height: 300px; margin-bottom: 20px;"></div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="wizNext(1)">Zur√ºck</button>
                    <button class="btn btn-primary" style="flex:1" onclick="wizNext(3)">Weiter</button>
                </div>
            </div>

            <div id="step3" class="wizard-content">
                <h3><i class="fa-solid fa-microchip"></i> KI-Berechnung</h3>
                <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border: 1px solid #bae6fd; margin-bottom: 20px;">
                    <ul style="font-size: 0.9rem; padding-left: 20px; color: #0c4a6e;">
                        <li>Stammspieler werden gesetzt.</li>
                        <li>Doppelschicht-W√ºnsche werden respektiert.</li>
                        <li>Springer werden fair verteilt.</li>
                        <li>Notfall-Reserven werden geschont.</li>
                    </ul>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="wizNext(2)">Zur√ºck</button>
                    <button class="btn btn-primary" style="flex:1" onclick="runGenerator()">üöÄ Plan erstellen</button>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal-backdrop">
        <div class="modal">
            <h3>Eintrag bearbeiten</h3>
            <input type="hidden" id="editIndex">
            <label>Datum</label>
            <input type="text" id="editDate" disabled style="background: #eee;">
            
            <div style="margin: 15px 0;">
                <label>Fr√ºhschicht (17:00 - 18:30)</label>
                <div id="editEarlyContainer" style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;"></div>
                <select id="addEarlySelect" onchange="addPersonToShift('early')" style="font-size: 0.9rem;">
                    <option value="">+ Person hinzuf√ºgen</option>
                </select>
            </div>

            <div style="margin: 15px 0;">
                <label>Sp√§tschicht (18:15 - 19:45)</label>
                <div id="editLateContainer" style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;"></div>
                <select id="addLateSelect" onchange="addPersonToShift('late')" style="font-size: 0.9rem;">
                    <option value="">+ Person hinzuf√ºgen</option>
                </select>
            </div>

            <button class="btn btn-primary btn-block" onclick="saveEdit()">Speichern</button>
        </div>
    </div>

    <div id="teamModal" class="modal-backdrop">
        <div class="modal">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Team verwalten</h3>
                <button class="btn btn-ghost" onclick="closeModal('teamModal')">&times;</button>
            </div>
            
            <div class="input-group" style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <label>Neues Mitglied</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="text" id="newMemberName" placeholder="Name">
                    <select id="newMemberRole">
                        <option value="stamm">Stamm (Immer)</option>
                        <option value="springer" selected>Springer (Rotation)</option>
                        <option value="notfall">Notfall (Reserve)</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px;">
                    <select id="newMemberPref">
                        <option value="both">Egal / Beides</option>
                        <option value="early">Nur Fr√ºh</option>
                        <option value="late">Nur Sp√§t</option>
                    </select>
                    <button class="btn btn-primary" onclick="addTeamMember()">Hinzuf√ºgen</button>
                </div>
            </div>

            <div id="teamManagerList" class="team-list"></div>
        </div>
    </div>

    <div id="csvModal" class="modal-backdrop">
        <div class="modal">
            <h3>CSV Verschlaubisieren</h3>
            <p style="font-size: 0.9rem; color: #666;">F√ºge deine "dumme" Excel/CSV Liste ein. Die AI versucht, das Team zu erkennen und einen smarten Plan daraus zu bauen.</p>
            <textarea id="csvInput" rows="6" placeholder="09.01.; Kaspar, Uwe&#10;16.01.; Nico, Gento"></textarea>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn btn-secondary" onclick="closeModal('csvModal')">Abbrechen</button>
                <button class="btn btn-primary" style="flex:1" onclick="processSmartCSV()">Analysieren & Importieren</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Nachricht</div>

    <script>
        // --- STATUS & DATEN ---
        let schedule = JSON.parse(localStorage.getItem('gp_schedule')) || [];
        
        let team = JSON.parse(localStorage.getItem('gp_team')) || [
            { id: 1, name: "Kaspar", role: "stamm", pref: "both", active: true },
            { id: 2, name: "Uwe", role: "springer", pref: "late", active: true },
            { id: 3, name: "Nico", role: "springer", pref: "both", active: true },
            { id: 4, name: "Dmitry", role: "springer", pref: "both", active: true },
            { id: 5, name: "Gento", role: "springer", pref: "early", active: true },
            { id: 6, name: "Stephan", role: "notfall", pref: "early", active: true }
        ];

        // Temp Variables for Editing
        let currentEditIndex = -1;
        let tempEditData = { early: [], late: [] };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            renderSchedule();
            renderTeamDisplay();
            updateStats();
            
            // Set Generator Date to next Friday
            const d = new Date();
            d.setDate(d.getDate() + (5 + 7 - d.getDay()) % 7);
            document.getElementById('wizStartDate').valueAsDate = d;
        });

        // --- CORE FUNCTIONS ---
        function saveData() {
            localStorage.setItem('gp_schedule', JSON.stringify(schedule));
            localStorage.setItem('gp_team', JSON.stringify(team));
            renderSchedule();
            renderTeamDisplay();
            updateStats();
        }

        function renderSchedule() {
            const container = document.getElementById('scheduleList');
            container.innerHTML = '';
            
            if(schedule.length === 0) {
                container.innerHTML = `<div style="padding: 40px; text-align: center; color: var(--color-text-muted);"><i class="fa-solid fa-robot" style="font-size: 2rem; margin-bottom: 10px;"></i><p>Kein Plan vorhanden.</p></div>`;
                document.getElementById('planRange').innerText = "";
                return;
            }

            // Sortierung
            schedule.sort((a,b) => new Date(a.date.split('.').reverse().join('-')) - new Date(b.date.split('.').reverse().join('-')));
            
            // Range Anzeige
            document.getElementById('planRange').innerText = `${schedule[0].date} - ${schedule[schedule.length-1].date}`;

            // AI Check
            let warning = false;

            schedule.forEach((day, index) => {
                // Check Understaffing (min 2 per shift)
                const problem = (day.early.length < 2 || day.late.length < 2);
                if(problem) warning = true;

                const div = document.createElement('div');
                div.className = 'schedule-row';
                div.innerHTML = `
                    <div class="date-cell">
                        <span>${day.date}</span>
                        <span class="date-day">Freitag</span>
                    </div>
                    
                    <div class="shift-block">
                        <div class="shift-label">FR√úH (17:00 - 18:30) ${day.early.length < 2 ? '<i class="fa-solid fa-triangle-exclamation" style="color:#dc2626"></i>' : ''}</div>
                        <div>${day.early.map(p => `<span class="person-pill">${p}</span>`).join('')}</div>
                    </div>

                    <div class="shift-block">
                        <div class="shift-label">SP√ÑT (18:15 - 19:45) ${day.late.length < 2 ? '<i class="fa-solid fa-triangle-exclamation" style="color:#dc2626"></i>' : ''}</div>
                        <div>${day.late.map(p => `<span class="person-pill">${p}</span>`).join('')}</div>
                    </div>

                    <div style="text-align: right;">
                        <button class="btn btn-ghost" onclick="openEditModal(${index})"><i class="fa-solid fa-pen-to-square"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });

            document.getElementById('ai-alert').style.display = warning ? 'inline-block' : 'none';
        }

        // --- GENERATOR LOGIC (THE BRAIN) ---
        function runGenerator() {
            const weeks = parseInt(document.getElementById('wizWeeks').value);
            let currentDate = document.getElementById('wizStartDate').valueAsDate;
            
            // Backup old schedule if exists? Nah, overwrite based on user intent usually.
            schedule = []; 
            
            // Fairness Counter
            let shiftsCount = {};
            team.forEach(p => shiftsCount[p.name] = 0);

            for (let i = 0; i < weeks; i++) {
                const dateStr = formatDate(currentDate);
                let dayPlan = { date: dateStr, early: [], late: [] };
                
                // 1. Stammspieler setzen (Fixed)
                team.filter(p => p.active && p.role === 'stamm').forEach(p => {
                    if(p.pref === 'early' || p.pref === 'both') { dayPlan.early.push(p.name); shiftsCount[p.name]++; }
                    if(p.pref === 'late' || p.pref === 'both') { dayPlan.late.push(p.name); shiftsCount[p.name]++; }
                });

                // 2. Doppelschicht-Logik & Springer
                // Wir f√ºllen auf mind. 3 Leute auf (Idealerweise)
                const fillShift = (shiftName, timePref) => {
                    while(dayPlan[shiftName].length < 3) {
                        // Kandidaten: Springer, Aktiv, noch nicht in dieser Schicht
                        let candidates = team.filter(p => 
                            p.active && 
                            p.role !== 'stamm' && // Stamm schon drin
                            p.role !== 'notfall' && // Notfall erst sp√§ter
                            (p.pref === timePref || p.pref === 'both') &&
                            !dayPlan[shiftName].includes(p.name)
                        );

                        // Wenn Doppelschicht-Logik greifen soll: 
                        // Wenn jemand "Both" pr√§feriert und schon in der anderen Schicht ist -> Priorisieren!
                        // Hier vereinfacht: Wir sortieren nach Eins√§tzen.
                        
                        candidates.sort((a,b) => shiftsCount[a.name] - shiftsCount[b.name]); // Fairness

                        if(candidates.length > 0) {
                            const chosen = candidates[0];
                            dayPlan[shiftName].push(chosen.name);
                            shiftsCount[chosen.name]++;
                            
                            // SMART LOGIC: Wenn Preference "Both", pack ihn auch in die andere Schicht wenn Platz!
                            if(chosen.pref === 'both') {
                                const otherShift = shiftName === 'early' ? 'late' : 'early';
                                if(!dayPlan[otherShift].includes(chosen.name)) {
                                    dayPlan[otherShift].push(chosen.name);
                                    shiftsCount[chosen.name]++;
                                }
                            }
                        } else {
                            break; // Keine Springer mehr
                        }
                    }
                };

                fillShift('early', 'early');
                fillShift('late', 'late');

                // 3. Notfall (Wenn immer noch < 2)
                const emergencyFill = (shiftName) => {
                    if(dayPlan[shiftName].length < 2) {
                        const notfall = team.find(p => p.active && p.role === 'notfall' && !dayPlan[shiftName].includes(p.name));
                        if(notfall) {
                             dayPlan[shiftName].push(notfall.name);
                             shiftsCount[notfall.name]++;
                        }
                    }
                };
                emergencyFill('early');
                emergencyFill('late');

                schedule.push(dayPlan);
                currentDate.setDate(currentDate.getDate() + 7);
            }

            closeModal('wizardModal');
            saveData();
            showToast("Plan erfolgreich generiert!");
        }

        // --- EDITING ---
        function openEditModal(index) {
            currentEditIndex = index;
            const entry = schedule[index];
            tempEditData = { early: [...entry.early], late: [...entry.late] };
            
            document.getElementById('editDate').value = entry.date;
            renderEditLists();
            
            // Populate Dropdowns
            const fillSelect = (id) => {
                const sel = document.getElementById(id);
                sel.innerHTML = '<option value="">+ Person hinzuf√ºgen</option>';
                team.forEach(p => {
                    sel.innerHTML += `<option value="${p.name}">${p.name}</option>`;
                });
            };
            fillSelect('addEarlySelect');
            fillSelect('addLateSelect');

            document.getElementById('editModal').classList.add('active');
        }

        function renderEditLists() {
            const render = (arr, containerId, type) => {
                const c = document.getElementById(containerId);
                c.innerHTML = arr.map((name, i) => `
                    <div class="person-pill" style="background: #e5e7eb; cursor:pointer;" onclick="removePersonFromEdit('${type}', ${i})">
                        ${name} <i class="fa-solid fa-times" style="font-size:0.7rem; margin-left:4px;"></i>
                    </div>
                `).join('');
            };
            render(tempEditData.early, 'editEarlyContainer', 'early');
            render(tempEditData.late, 'editLateContainer', 'late');
        }

        function addPersonToShift(type) {
            const sel = document.getElementById(type === 'early' ? 'addEarlySelect' : 'addLateSelect');
            const name = sel.value;
            if(name && !tempEditData[type].includes(name)) {
                tempEditData[type].push(name);
                renderEditLists();
            }
            sel.value = "";
        }

        function removePersonFromEdit(type, index) {
            tempEditData[type].splice(index, 1);
            renderEditLists();
        }

        function saveEdit() {
            schedule[currentEditIndex].early = tempEditData.early;
            schedule[currentEditIndex].late = tempEditData.late;
            saveData();
            closeModal('editModal');
        }

        // --- WIZARD & MODAL UTILS ---
        function openWizard() {
            document.getElementById('wizardModal').classList.add('active');
            wizNext(1); // Reset
            renderWizTeam();
        }

        function renderWizTeam() {
            const c = document.getElementById('wizTeamList');
            c.innerHTML = team.map((p, i) => `
                <div class="member-row">
                    <input type="checkbox" ${p.active ? 'checked' : ''} onchange="toggleTeamActive(${i})">
                    <span>${p.name}</span>
                    <span class="tag tag-${p.role}">${p.role}</span>
                </div>
            `).join('');
        }
        
        function toggleTeamActive(index) {
            team[index].active = !team[index].active;
            localStorage.setItem('gp_team', JSON.stringify(team)); // Save state immediately
        }

        function wizNext(step) {
            document.querySelectorAll('.wizard-content').forEach(el => el.classList.remove('active'));
            document.getElementById('step'+step).classList.add('active');
            
            document.querySelectorAll('.step-dot').forEach((el, i) => {
                if(i < step) el.classList.add('active'); else el.classList.remove('active');
            });
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // --- TEAM MANAGEMENT ---
        function openTeamModal() {
            renderTeamManager();
            document.getElementById('teamModal').classList.add('active');
        }

        function renderTeamManager() {
            const c = document.getElementById('teamManagerList');
            c.innerHTML = team.map((p, i) => `
                <div class="member-row">
                    <div class="avatar">${p.name.substring(0,1)}</div>
                    <div class="member-info">
                        <div class="member-name">${p.name}</div>
                        <div class="member-details">
                            <span class="tag tag-${p.role}">${p.role}</span>
                            <span><i class="fa-regular fa-clock"></i> ${p.pref}</span>
                        </div>
                    </div>
                    <button class="btn btn-ghost" onclick="deleteTeamMember(${i})" style="color:var(--color-error)"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('');
        }

        function renderTeamDisplay() {
            const c = document.getElementById('teamDisplay');
            c.innerHTML = team.map(p => `
                <div class="member-row">
                    <div class="avatar">${p.name.substring(0,1)}</div>
                    <div class="member-info">
                        <div class="member-name">${p.name}</div>
                        <div class="member-details">
                            <span class="tag tag-${p.role}">${p.role}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function addTeamMember() {
            const name = document.getElementById('newMemberName').value.trim();
            if(!name) return;
            team.push({
                id: Date.now(),
                name: name,
                role: document.getElementById('newMemberRole').value,
                pref: document.getElementById('newMemberPref').value,
                active: true
            });
            document.getElementById('newMemberName').value = '';
            renderTeamManager();
            saveData();
        }

        function deleteTeamMember(i) {
            if(confirm('L√∂schen?')) {
                team.splice(i, 1);
                renderTeamManager();
                saveData();
            }
        }

        // --- CSV SMART IMPORT ---
        function openCSVModal() { document.getElementById('csvModal').classList.add('active'); }
        
        function processSmartCSV() {
            const txt = document.getElementById('csvInput').value;
            const lines = txt.split('\n');
            
            schedule = []; // Reset or Append? Reset for clean start logic.
            
            lines.forEach(line => {
                // Simple parser: Datum; Names (comma separated)
                // Assume 17:00 is first half names, 18:15 logic is hard from dumb CSV.
                // We'll put all names in Early and Late for now or try to split if quantity > 3
                const parts = line.split(';');
                if(parts.length >= 2) {
                    const date = parts[0].trim();
                    const namesStr = parts[1] || "";
                    const names = namesStr.split(',').map(n => n.trim()).filter(n => n);
                    
                    // Dumb logic: First 2 early, rest late? Or duplicate?
                    // Let's assume if it's imported, we add all to both to be safe, user edits later
                    // Or improved:
                    const mid = Math.ceil(names.length / 2);
                    const early = names.slice(0, mid + 1); // overlap slightly
                    const late = names.slice(mid - 1); // overlap slightly
                    
                    schedule.push({ date: date, early: names, late: names }); // Duplicate for safety
                }
            });
            
            closeModal('csvModal');
            saveData();
            showToast("CSV importiert (Bitte pr√ºfen!)");
        }

        // --- EXTRA FEATURES ---
        function updateStats() {
            const counts = {};
            team.forEach(p => counts[p.name] = 0);
            
            schedule.forEach(day => {
                [...new Set([...day.early, ...day.late])].forEach(name => {
                    if(counts[name] !== undefined) counts[name]++;
                });
            });

            // Chart.js
            const ctx = document.getElementById('statsChart');
            if(window.myChart) window.myChart.destroy();
            
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{
                        label: 'Eins√§tze',
                        data: Object.values(counts),
                        backgroundColor: '#2563eb',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }

        function exportWhatsApp() {
            let text = "*üìÖ Einsatzplan Jugendtraining*\n\n";
            schedule.forEach(day => {
                text += `*${day.date} (Fr)*\n`;
                text += `üïî 17:00: ${day.early.join(', ')}\n`;
                text += `üïï 18:15: ${day.late.join(', ')}\n\n`;
            });
            navigator.clipboard.writeText(text).then(() => showToast("F√ºr WhatsApp kopiert!"));
        }

        function exportICAL() {
            let ical = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//GittertierPro//DE\n";
            
            schedule.forEach(day => {
                const [d, m] = day.date.split('.');
                const year = new Date().getFullYear(); // Assume current year or logic needed
                // Simple Logic: 2026 if month < current month etc. 
                // Let's assume passed date format
                const yyyy = (parseInt(m) < new Date().getMonth()+1) ? year+1 : year;
                
                const formatTime = (time) => `${yyyy}${m}${d}T${time.replace(':','')}00`;
                
                // Shift 1
                ical += "BEGIN:VEVENT\n";
                ical += `SUMMARY:Training Fr√ºh (${day.early.join(', ')})\n`;
                ical += `DTSTART:${formatTime('1700')}\nDTEND:${formatTime('1830')}\n`;
                ical += "END:VEVENT\n";
                
                // Shift 2
                ical += "BEGIN:VEVENT\n";
                ical += `SUMMARY:Training Sp√§t (${day.late.join(', ')})\n`;
                ical += `DTSTART:${formatTime('1815')}\nDTEND:${formatTime('1945')}\n`;
                ical += "END:VEVENT\n";
            });
            ical += "END:VCALENDAR";
            
            const blob = new Blob([ical], { type: 'text/calendar' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'training.ics';
            link.click();
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.text("Einsatzplan Jugendtraining", 14, 20);
            doc.setFontSize(12);
            doc.text("SC Brombach", 14, 28);
            
            const body = schedule.map(day => [
                day.date, 
                day.early.join(', '), 
                day.late.join(', ')
            ]);
            
            doc.autoTable({
                startY: 50,
                head: [['Datum', 'Fr√ºhschicht (17:00)', 'Sp√§tschicht (18:15)']],
                body: body,
                theme: 'grid',
                headStyles: { fillColor: [30, 58, 138] },
                styles: { fontSize: 10, cellPadding: 5 }
            });
            
            doc.save('einsatzplan.pdf');
        }

        function resetAll() {
            if(confirm("Wirklich alles l√∂schen?")) {
                schedule = [];
                saveData();
            }
        }

        function toggleTheme() {
            const body = document.body;
            // Simple Dark Mode Toggle logic (better via class)
            // Here we rely on CSS media query, but manual toggle:
            // Just swapping root vars via JS is cleaner but verbose. 
            // For now, let's just alert (or implement class toggle)
            alert("Dark Mode ist automatisch basierend auf deiner Systemeinstellung aktiv!");
        }

        // --- HELPERS ---
        function formatDate(d) {
            let da = d.getDate(); let mo = d.getMonth()+1;
            return (da<10?'0':'')+da + '.' + (mo<10?'0':'')+mo + '.';
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

    </script>
</body>
</html>