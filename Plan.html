<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schachclub Einsatzplaner Pro</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>

    <style>
        /* --- Design-System (Gittertier Pro) --- */
        :root {
            --color-bg: #f3f4f6;
            --color-card: #ffffff;
            --color-text: #111827;
            --color-text-muted: #6b7280;
            --color-border: #e5e7eb;
            --color-accent: #2563eb;       /* Modern Blue */
            --color-accent-hover: #1d4ed8;
            --color-brand: #000000;        /* Schachclub Schwarz/Weiß */
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-family);
            background-color: var(--color-bg);
            color: var(--color-text);
            padding-bottom: 40px;
        }

        /* --- Header --- */
        header {
            background: var(--color-card);
            border-bottom: 1px solid var(--color-border);
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--color-text);
            text-decoration: none;
        }

        .brand img {
            height: 45px;
            width: auto;
        }

        /* --- Container & Layout --- */
        .container {
            max-width: 1000px;
            margin: 30px auto;
            padding: 0 20px;
            display: grid;
            gap: 25px;
        }

        .card {
            background: var(--color-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 25px;
            border: 1px solid var(--color-border);
        }

        h2 { margin-bottom: 20px; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        
        /* --- Upload Zone (OCR) --- */
        .upload-zone {
            border: 2px dashed var(--color-border);
            border-radius: var(--radius);
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #f9fafb;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--color-accent);
            background: #eff6ff;
        }

        .upload-icon { font-size: 2rem; color: var(--color-text-muted); margin-bottom: 10px; }
        
        #ocrProgress {
            display: none;
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--color-accent);
            font-weight: 600;
        }

        /* --- Inputs --- */
        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr auto;
            gap: 15px;
            align-items: end;
        }

        label { display: block; font-size: 0.8rem; color: var(--color-text-muted); margin-bottom: 5px; font-weight: 600; }
        
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 0.95rem;
        }

        /* --- Buttons --- */
        .btn {
            background: var(--color-text);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.1s;
        }
        
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-accent { background: var(--color-accent); }
        .btn-outline { background: white; border: 1px solid var(--color-border); color: var(--color-text); }
        .btn-outline:hover { background: #f3f4f6; }
        .btn-danger { background: #fee2e2; color: #ef4444; }
        .btn-danger:hover { background: #fecaca; }

        /* --- Table --- */
        .table-wrapper {
            border: 1px solid var(--color-border);
            border-radius: 8px;
            overflow: hidden;
        }

        table { width: 100%; border-collapse: collapse; text-align: left; }
        th { background: #f9fafb; padding: 12px 15px; font-size: 0.85rem; text-transform: uppercase; color: var(--color-text-muted); }
        td { padding: 12px 15px; border-bottom: 1px solid var(--color-border); font-size: 0.95rem; }
        tr:last-child td { border-bottom: none; }
        
        .badge {
            background: #e0f2fe; color: #0369a1;
            padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: 700;
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: 0.2s; z-index: 100;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .modal {
            background: white; width: 90%; max-width: 500px;
            padding: 30px; border-radius: var(--radius);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }

        .design-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;
        }
        
        .design-option {
            border: 2px solid var(--color-border); border-radius: 8px; padding: 15px;
            text-align: center; cursor: pointer;
        }
        .design-option:hover { border-color: var(--color-accent); background: #eff6ff; }
        .design-option.selected { border-color: var(--color-accent); background: #eff6ff; ring: 2px solid var(--color-accent); }
        
        textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid var(--color-border); border-radius: 6px; font-family: monospace; }

        @media (max-width: 700px) {
            .input-group { grid-template-columns: 1fr; }
            header { padding: 15px; }
            .brand span { display: none; } /* Nur Logo auf Handy */
        }
    </style>
</head>
<body>

    <header>
        <a href="#" class="brand">
            <img src="https://www.loerrach.de/ceasy/resource/3714" alt="Schachclub Brombach Logo" id="clubLogo">
            <span>Schachclub Planer</span>
        </a>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-outline" onclick="openModal('csvModal')"><i class="fa-solid fa-file-csv"></i> CSV</button>
            <button class="btn btn-accent" onclick="openModal('pdfModal')"><i class="fa-solid fa-file-pdf"></i> Export</button>
        </div>
    </header>

    <div class="container">

        <div class="card">
            <h2><i class="fa-solid fa-robot"></i> Automatische Erkennung</h2>
            <div class="upload-zone" id="dropZone">
                <i class="fa-solid fa-cloud-arrow-up upload-icon"></i>
                <p><strong>Screenshot hier ablegen</strong> oder klicken zum Hochladen</p>
                <p style="font-size: 0.8rem; color: #999;">Erkennt WhatsApp-Umfragen und Listen</p>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
                <div id="ocrProgress"><i class="fa-solid fa-spinner fa-spin"></i> Analysiere Bild... Bitte warten.</div>
            </div>
        </div>

        <div class="card">
            <h2><i class="fa-solid fa-pen-to-square"></i> Eintrag bearbeiten</h2>
            <div class="input-group">
                <div>
                    <label>Datum</label>
                    <input type="text" id="inpDate" placeholder="05.12.">
                </div>
                <div>
                    <label>Uhrzeit</label>
                    <input type="text" id="inpTime" placeholder="17:00 - 18:30">
                </div>
                <div>
                    <label>Trainer / Team</label>
                    <input type="text" id="inpNames" placeholder="Kaspar, Dmitry...">
                </div>
                <button class="btn btn-accent" onclick="addEntry()"><i class="fa-solid fa-plus"></i></button>
            </div>
        </div>

        <div class="table-wrapper">
            <table id="scheduleTable">
                <thead>
                    <tr>
                        <th width="15%">Datum</th>
                        <th width="20%">Uhrzeit</th>
                        <th width="50%">Team</th>
                        <th width="10%">Anz.</th>
                        <th width="5%"></th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    </tbody>
            </table>
            <div id="emptyState" style="padding: 40px; text-align: center; color: #9ca3af;">
                Noch keine Einträge. Lade ein Bild hoch oder erstelle einen Eintrag.
            </div>
        </div>

    </div>

    <div id="pdfModal" class="modal-overlay">
        <div class="modal">
            <h2>PDF Design wählen</h2>
            <div class="design-grid">
                <div class="design-option selected" onclick="selectDesign(this, 'clean')">
                    <i class="fa-regular fa-file-lines" style="font-size: 2rem; margin-bottom: 5px;"></i><br>
                    Clean (Weiß)
                </div>
                <div class="design-option" onclick="selectDesign(this, 'branded')">
                    <i class="fa-solid fa-chess-knight" style="font-size: 2rem; margin-bottom: 5px; color: #000;"></i><br>
                    Schachclub
                </div>
                <div class="design-option" onclick="selectDesign(this, 'modern')">
                    <i class="fa-solid fa-layer-group" style="font-size: 2rem; margin-bottom: 5px; color: #2563eb;"></i><br>
                    Modern Blue
                </div>
                <div class="design-option" onclick="selectDesign(this, 'list')">
                    <i class="fa-solid fa-list" style="font-size: 2rem; margin-bottom: 5px;"></i><br>
                    Kompakte Liste
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-outline" style="flex:1" onclick="closeModal('pdfModal')">Abbrechen</button>
                <button class="btn btn-accent" style="flex:1" onclick="generatePDF()">PDF Erstellen</button>
            </div>
        </div>
    </div>

    <div id="csvModal" class="modal-overlay">
        <div class="modal">
            <h2>CSV Daten</h2>
            <p style="font-size: 0.9rem; margin-bottom: 10px; color: #666;">Format: Datum; Uhrzeit; Namen</p>
            <textarea id="csvInput"></textarea>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn btn-outline" style="flex:1" onclick="downloadCSV()"><i class="fa-solid fa-download"></i> Herunterladen</button>
                <button class="btn btn-accent" style="flex:1" onclick="importCSV()"><i class="fa-solid fa-upload"></i> Importieren</button>
            </div>
            <button class="btn btn-outline" style="width:100%; margin-top:10px; border:none;" onclick="closeModal('csvModal')">Schließen</button>
        </div>
    </div>

    <script>
        let scheduleData = [];
        let currentDesign = 'clean';

        /* --- UI Logic --- */
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const empty = document.getElementById('emptyState');
            tbody.innerHTML = '';

            if (scheduleData.length === 0) {
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            // Sortieren nach Datum (Simpel)
            // scheduleData.sort((a, b) => a.date.localeCompare(b.date)); 

            scheduleData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${row.date}</strong></td>
                    <td>${row.time}</td>
                    <td>${row.names}</td>
                    <td><span class="badge">${row.names.split(',').filter(n=>n.trim()).length}</span></td>
                    <td><button class="btn-danger" style="padding:4px 8px; border-radius:4px; border:none; cursor:pointer;" onclick="deleteRow(${index})">×</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function addEntry() {
            const date = document.getElementById('inpDate').value.trim();
            const time = document.getElementById('inpTime').value.trim();
            let names = document.getElementById('inpNames').value.trim();

            if (!date) return alert("Datum fehlt!");

            // Auto-Correct Name
            names = names.replace(/\bDu\b/g, "Kaspar");

            scheduleData.push({ date, time, names });
            renderTable();
            
            document.getElementById('inpNames').value = '';
            // Datum/Zeit lassen wir stehen für schnelles Eintragen
        }

        function deleteRow(idx) {
            scheduleData.splice(idx, 1);
            renderTable();
        }

        /* --- OCR Logic (Tesseract) --- */
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => processImage(e.target.files[0]);

        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            processImage(e.dataTransfer.files[0]);
        });

        async function processImage(file) {
            if (!file) return;
            document.getElementById('ocrProgress').style.display = 'block';

            try {
                const worker = await Tesseract.createWorker('deu'); // Deutsch laden
                const { data: { text } } = await worker.recognize(file);
                console.log("Raw OCR:", text);
                
                parseOCRText(text);
                await worker.terminate();
            } catch (err) {
                alert("Fehler bei der Erkennung: " + err);
            } finally {
                document.getElementById('ocrProgress').style.display = 'none';
            }
        }

        function parseOCRText(text) {
            const lines = text.split('\n');
            let currentDate = "";
            let currentTime = "";
            let currentNames = [];

            // Regex für Datum (DD.MM.) und Zeit (HH:MM)
            const dateRegex = /(\d{1,2}\.\d{2}\.?)/;
            const timeRegex = /(\d{1,2}:\d{2}\s*[-–]\s*\d{1,2}:\d{2})/;

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                // Prüfen ob Datum oder Zeit in der Zeile ist
                const dateMatch = line.match(dateRegex);
                const timeMatch = line.match(timeRegex);

                if (dateMatch) {
                    // Wenn wir schon Daten gesammelt haben, speichern
                    if (currentDate && currentNames.length > 0) {
                        saveExtracted(currentDate, currentTime, currentNames);
                        currentNames = [];
                    }
                    currentDate = dateMatch[1];
                    // Wenn Zeit in gleicher Zeile
                    if (timeMatch) currentTime = timeMatch[1];
                } 
                else if (timeMatch) {
                    // Falls Zeit auf neuer Zeile steht
                    if (currentDate && currentNames.length > 0) {
                        // Neuer Zeitblock am selben Tag? Oder Abschluss des alten?
                        // Wir speichern den alten Block ab
                        saveExtracted(currentDate, currentTime, currentNames);
                        currentNames = [];
                    }
                    currentTime = timeMatch[1];
                } 
                else {
                    // Wahrscheinlich ein Name
                    // Ignoriere typische WhatsApp Wörter
                    if (!line.includes("Stimmen") && !line.includes("Option hinzufügen") && line.length > 2) {
                        currentNames.push(line);
                    }
                }
            });

            // Letzten Eintrag speichern
            if (currentDate && currentNames.length > 0) {
                saveExtracted(currentDate, currentTime, currentNames);
            }
            renderTable();
        }

        function saveExtracted(d, t, nArr) {
            // Bereinigen
            const namesStr = nArr.join(', ').replace(/\bDu\b/g, "Kaspar");
            scheduleData.push({ date: d, time: t || "??:??", names: namesStr });
        }

        /* --- PDF Export --- */
        function selectDesign(el, id) {
            document.querySelectorAll('.design-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            currentDesign = id;
        }

        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const logoUrl = document.getElementById('clubLogo').src;

            // Header Logik
            let startY = 30;
            
            // Logo laden (wenn nicht 'clean' Modus ohne Logo gewünscht)
            if (currentDesign === 'branded') {
                // Logo Bild abrufen und als Base64 einfügen (komplex im Browser wg CORS)
                // Fallback: Wir nutzen den Canvas Hack oder lassen es simpel.
                // Text Header:
                doc.setFont("helvetica", "bold");
                doc.setFontSize(22);
                doc.text("Schachclub Brombach", 14, 20);
                doc.setFontSize(14);
                doc.text("Jugendtraining Einsatzplan", 14, 28);
                startY = 40;
            } else {
                doc.setFontSize(18);
                doc.text("Einsatzplan Jugendtraining", 14, 20);
            }

            // Design Styles
            let styles = {};
            let headStyles = {};

            if (currentDesign === 'clean') {
                headStyles = { fillColor: [240, 240, 240], textColor: [0, 0, 0], fontStyle: 'bold' };
            } else if (currentDesign === 'branded') {
                headStyles = { fillColor: [0, 0, 0], textColor: [255, 255, 255] }; // Schwarz/Weiß
            } else if (currentDesign === 'modern') {
                headStyles = { fillColor: [37, 99, 235], textColor: 255 }; // Blau
            }

            const body = scheduleData.map(row => [row.date, row.time, row.names, row.names.split(',').length]);

            doc.autoTable({
                startY: startY,
                head: [['Datum', 'Uhrzeit', 'Trainer / Team', 'Anz.']],
                body: body,
                theme: currentDesign === 'list' ? 'plain' : 'grid',
                headStyles: headStyles,
                styles: { fontSize: 11, cellPadding: 4 },
                columnStyles: { 0: { fontStyle: 'bold' } }
            });

            doc.save(`Einsatzplan_${currentDesign}.pdf`);
            closeModal('pdfModal');
        }

        /* --- CSV --- */
        function downloadCSV() {
            let csv = "Datum;Uhrzeit;Namen\n";
            scheduleData.forEach(row => {
                csv += `${row.date};${row.time};${row.names}\n`;
            });
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "einsatzplan.csv";
            link.click();
        }

        function importCSV() {
            const txt = document.getElementById('csvInput').value;
            const lines = txt.split('\n');
            lines.forEach(l => {
                const p = l.split(';');
                if (p.length >= 2) {
                    scheduleData.push({ date: p[0], time: p[1], names: p[2] || "" });
                }
            });
            renderTable();
            closeModal('csvModal');
        }

        /* --- Helper --- */
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        window.onclick = (e) => { if (e.target.classList.contains('modal-overlay')) closeModal(e.target.id); }

    </script>
</body>
</html>
