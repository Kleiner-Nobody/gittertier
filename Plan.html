<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Einsatzplaner Pro v5 - SC Brombach</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* --- Gittertier Pro Design System (erweitert) --- */
        :root {
            --c-bg: #f3f4f6;
            --c-surface: #ffffff;
            --c-text: #111827;
            --c-text-muted: #6b7280;
            --c-primary: #2563eb;
            --c-primary-hover: #1d4ed8;
            --c-primary-light: #eff6ff;
            --c-success: #10b981;
            --c-warning: #f59e0b;
            --c-danger: #ef4444;
            --c-border: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --radius: 16px;
            --radius-sm: 8px;
            --header-h: 64px;
            --nav-h: 70px;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --touch-target: 44px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--c-bg);
            color: var(--c-text);
            margin: 0;
            padding-bottom: calc(var(--nav-h) + 20px);
            min-height: 100vh;
            overflow-x: hidden;
            width: 100%;
            position: relative;
        }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* --- Header --- */
        header {
            height: var(--header-h);
            background: var(--c-surface);
            border-bottom: 1px solid var(--c-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: var(--shadow-sm);
            width: 100%;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            font-size: 1rem;
            color: var(--c-text);
            text-decoration: none;
        }
        .brand img { height: 32px; width: auto; }
        .brand span { color: var(--c-primary); }

        /* --- Mobile Navigation (Bottom) --- */
        .mobile-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: var(--c-surface);
            border-top: 1px solid var(--c-border);
            height: calc(var(--nav-h) + var(--safe-bottom));
            padding-bottom: var(--safe-bottom);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.05);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--c-text-muted);
            font-size: 0.7rem;
            gap: 2px;
            background: none;
            border: none;
            height: var(--nav-h);
            cursor: pointer;
            transition: 0.2s;
            min-width: var(--touch-target);
            padding: 0 4px;
        }

        .nav-item i { font-size: 1.4rem; margin-bottom: 2px; }
        .nav-item span { font-size: 0.65rem; font-weight: 500; }
        .nav-item.active { color: var(--c-primary); }
        .nav-item.active i { transform: scale(1.05); }

        /* --- Main Layout --- */
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 12px;
            width: 100%;
        }

        .view { display: none; animation: fadeIn 0.2s ease-out; }
        .view.active { display: block; }

        /* --- Cards --- */
        .card {
            background: var(--c-surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--c-border);
            padding: 16px;
            margin-bottom: 16px;
            position: relative;
            width: 100%;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--c-border);
        }
        .card-header h2 { font-size: 1.1rem; margin: 0; display: flex; align-items: center; gap: 8px; }
        .card-header h2 i { color: var(--c-primary); }

        /* --- Forms --- */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }
        @media(min-width: 640px) {
            .form-grid { grid-template-columns: 1fr 1fr; }
        }
        .full-width { grid-column: 1 / -1; }

        label { display: block; font-size: 0.85rem; color: var(--c-text-muted); margin-bottom: 4px; font-weight: 500; }
        
        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--c-border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            background: #fff;
            transition: 0.2s;
            -webkit-appearance: none;
            appearance: none;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--c-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
        }
        input[type="checkbox"] { width: 22px; height: 22px; }

        /* --- Buttons (gro√ü f√ºr Touch) --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: 0.2s;
            width: 100%;
            min-height: var(--touch-target);
            background: transparent;
        }
        .btn-primary { background: var(--c-primary); color: white; }
        .btn-primary:active { background: var(--c-primary-hover); transform: scale(0.98); }
        
        .btn-secondary { background: white; border: 1px solid var(--c-border); color: var(--c-text); }
        .btn-secondary:active { background: var(--c-bg); }
        
        .btn-danger { background: #fee2e2; color: var(--c-danger); }
        
        .btn-ghost { background: transparent; color: var(--c-text-muted); padding: 10px; width: auto; min-height: var(--touch-target); }
        .btn-ghost:active { color: var(--c-primary); background: var(--c-primary-light); }

        .btn-icon {
            width: var(--touch-target);
            height: var(--touch-target);
            border-radius: 50%;
            padding: 0;
        }

        /* --- Wizard Steps --- */
        .wizard-step { display: none; }
        .wizard-step.active { display: block; }
        .step-indicators { display: flex; gap: 4px; margin-bottom: 20px; }
        .step-dot { flex: 1; height: 6px; background: var(--c-border); border-radius: 3px; transition: 0.2s; }
        .step-dot.active { background: var(--c-primary); }
        .step-dot.completed { background: var(--c-success); }

        /* --- Team Grid --- */
        .team-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        @media(min-width: 480px) {
            .team-grid { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
        }
        .member-card {
            background: #f9fafb;
            border: 1px solid var(--c-border);
            padding: 12px;
            border-radius: var(--radius-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .role-badge {
            font-size: 0.7rem; padding: 4px 8px; border-radius: 99px; font-weight: 700; text-transform: uppercase;
        }
        .role-fixed { background: #dbeafe; color: #1e40af; }
        .role-rotate { background: #e0e7ff; color: #4338ca; }
        .role-emergency { background: #fee2e2; color: #991b1b; }

        /* --- Tabelle (scrollbar horizontal) --- */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-sm);
            border: 1px solid var(--c-border);
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            margin-bottom: 10px;
        }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #f9fafb; text-align: left; padding: 14px 12px; font-size: 0.8rem; text-transform: uppercase; color: var(--c-text-muted); border-bottom: 1px solid var(--c-border); }
        td { padding: 14px 12px; border-bottom: 1px solid var(--c-border); vertical-align: middle; }
        tr:active td { background: #f9fafb; }
        .conflict-row { background-color: #fef2f2 !important; border-left: 4px solid var(--c-danger); }

        /* --- Modals (Bottom Sheets) --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 200;
            display: flex; align-items: flex-end; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.2s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        
        .modal {
            background: var(--c-surface);
            width: 100%; max-width: 600px;
            border-radius: 24px 24px 0 0;
            padding: 20px 16px 30px;
            transform: translateY(100%);
            transition: 0.3s cubic-bezier(0.2, 0.9, 0.3, 1);
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        .modal-overlay.open .modal { transform: translateY(0); }
        .modal-close {
            float: right;
            background: none;
            border: none;
            font-size: 1.8rem;
            line-height: 1;
            padding: 0 8px;
            cursor: pointer;
            color: var(--c-text-muted);
        }
        @media(min-width: 640px) {
            .modal-overlay { align-items: center; }
            .modal { border-radius: var(--radius); transform: scale(0.95); width: 90%; }
            .modal-overlay.open .modal { transform: scale(1); }
            .mobile-nav { display: none; }
            body { padding-bottom: 0; }
            .desktop-nav { display: flex; gap: 20px; }
            .desktop-nav a { text-decoration: none; color: var(--c-text-muted); font-weight: 500; padding: 8px 0; cursor: pointer; min-height: var(--touch-target); display: inline-flex; align-items: center; }
            .desktop-nav a:hover, .desktop-nav a.active { color: var(--c-primary); border-bottom: 2px solid var(--c-primary); }
        }
        @media(max-width: 639px) {
            .desktop-nav { display: none; }
            .brand span { display: none; }
        }

        /* --- Drop Zone --- */
        .drop-zone {
            border: 2px dashed var(--c-border); border-radius: var(--radius);
            padding: 30px 20px; text-align: center; color: var(--c-text-muted); cursor: pointer; transition: 0.2s;
            margin: 10px 0;
        }
        .drop-zone:active, .drop-zone.dragover { border-color: var(--c-primary); background: var(--c-primary-light); }

        /* --- Loader --- */
        .loader-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 300;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .loader-spinner {
            width: 60px; height: 60px; border: 5px solid #e5e7eb; border-top: 5px solid var(--c-primary);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px;
        }

        /* --- Badges & Chips --- */
        .chip {
            display: inline-flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 30px;
            background: var(--c-primary-light);
            color: var(--c-primary);
            font-size: 0.9rem;
            margin: 0 4px 4px 0;
        }
        .chip.selected { background: var(--c-primary); color: white; }

        /* --- Utility --- */
        .text-muted { color: var(--c-text-muted); }
        .mt-2 { margin-top: 8px; }
        .mt-4 { margin-top: 16px; }
        .flex { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .text-center { text-align: center; }
        .p-relative { position: relative; }
        .w-100 { width: 100%; }

        /* --- Personen-Checkboxen im OCR-Editor --- */
        .person-picker {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid var(--c-border);
            border-radius: var(--radius-sm);
            background: #fff;
        }
        .person-chip {
            background: #f0f0f0;
            border-radius: 30px;
            padding: 10px 16px;
            font-size: 1rem;
            cursor: pointer;
            user-select: none;
            border: 1px solid transparent;
        }
        .person-chip.selected {
            background: var(--c-primary);
            color: white;
            border-color: var(--c-primary);
        }
    </style>
</head>
<body>

    <!-- Loader -->
    <div id="loader" class="loader-overlay">
        <div class="loader-spinner"></div>
        <h3 id="loader-text">Arbeite...</h3>
    </div>

    <!-- Header -->
    <header>
        <a href="#" class="brand" onclick="App.nav('dashboard')">
            <img src="https://www.loerrach.de/ceasy/resource/3714" alt="Logo">
            <div>SC Brombach <span style="font-weight:400;">Planer v5</span></div>
        </a>
        <nav class="desktop-nav">
            <a onclick="App.nav('dashboard')">√úbersicht</a>
            <a onclick="App.nav('team')">Team</a>
            <a onclick="App.nav('wizard')">Generator</a>
            <a onclick="App.nav('stats')">Statistik</a>
            <a onclick="App.PlanManager.openModal()"><i class="fa-regular fa-copy"></i> Pl√§ne</a>
        </nav>
        <div class="flex" style="gap:6px;">
            <button class="btn btn-ghost btn-icon" onclick="App.PlanManager.openModal()" title="Pl√§ne verwalten"><i class="fa-regular fa-copy"></i></button>
            <button class="btn btn-primary" onclick="App.Modals.open('export')" style="width: auto; padding: 8px 16px; font-size: 0.85rem;">
                <i class="fa-solid fa-download"></i> Export
            </button>
        </div>
    </header>

    <main>
        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="view active">
            <div class="grid-2" style="margin-bottom: 16px;">
                <div class="card" style="margin:0; padding: 16px; background: linear-gradient(135deg, #2563eb, #1e40af); color: white; border:none;">
                    <div style="font-size: 0.9rem; opacity: 0.9;">N√§chster Termin</div>
                    <div id="next-shift-display" style="font-size: 1.8rem; font-weight: 700; margin-top: 5px;">--.--.</div>
                    <div id="next-shift-team" style="font-size: 1rem; margin-top: 5px; opacity: 0.9;">Keine Daten</div>
                </div>
                <div class="card" style="margin:0; padding: 16px; display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <div style="font-size: 0.9rem; color: var(--c-text-muted);">Offene Schichten</div>
                        <div id="open-shifts-count" style="font-size: 2rem; font-weight: 700; color: var(--c-danger);">0</div>
                    </div>
                    <i class="fa-solid fa-triangle-exclamation" style="font-size: 2.5rem; color: #fee2e2;"></i>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2><i class="fa-solid fa-calendar-days"></i> Einsatzplan <span id="current-plan-name" class="chip" style="font-size:0.8rem;">Standard</span></h2>
                    <div class="flex" style="gap:6px;">
                        <button class="btn btn-ghost btn-icon" onclick="App.Modals.open('ocr')"><i class="fa-solid fa-camera"></i></button>
                        <button class="btn btn-ghost btn-icon" onclick="App.Modals.open('quickAdd')"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>

                <div class="table-container">
                    <table id="main-table">
                        <thead>
                            <tr><th>Datum</th><th>Zeit</th><th>Team</th><th></th></tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
                <div id="empty-state" style="padding: 40px; text-align: center; color: var(--c-text-muted); display: none;">
                    <i class="fa-solid fa-clipboard-list" style="font-size: 3rem; margin-bottom: 16px; opacity: 0.3;"></i>
                    <p>Keine Eintr√§ge vorhanden.</p>
                    <button class="btn btn-secondary" onclick="App.nav('wizard')" style="width:auto; margin-top:10px;">Generator starten</button>
                </div>
            </div>
        </div>

        <!-- TEAM VIEW -->
        <div id="view-team" class="view">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fa-solid fa-users"></i> Teilnehmer</h2>
                    <button class="btn btn-primary" onclick="App.Modals.open('addMember')" style="width: auto;">+ Neu</button>
                </div>
                <p class="text-muted">Rollen: Stamm (immer), Springer (Rotation), Notfall (manuell). Klick auf Zahnrad f√ºr Details & Verf√ºgbarkeit.</p>
                <div id="team-grid" class="team-grid"></div>
            </div>
        </div>

        <!-- WIZARD VIEW -->
        <div id="view-wizard" class="view">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fa-solid fa-wand-magic-sparkles"></i> KI-Planer Wizard</h2>
                </div>

                <div class="step-indicators">
                    <div class="step-dot active" id="dot-1"></div>
                    <div class="step-dot" id="dot-2"></div>
                    <div class="step-dot" id="dot-3"></div>
                </div>

                <!-- Step 1: Zeitraum & Einstellungen -->
                <div id="step-1" class="wizard-step active">
                    <h3>Zeitraum & Optionen</h3>
                    <div class="form-grid">
                        <div><label>Start (Freitag)</label><input type="date" id="gen-start-date"></div>
                        <div><label>Dauer (Wochen)</label><select id="gen-duration"><option value="4">4</option><option value="8" selected>8</option><option value="12">12</option></select></div>
                        <div><label>Min. pro Schicht</label><input type="number" id="gen-min-per-shift" value="3" min="1" max="10"></div>
                        <div><label>Max. pro Schicht</label><input type="number" id="gen-max-per-shift" value="4" min="1" max="10"></div>
                        <div class="full-width">
                            <label><input type="checkbox" id="gen-pref-doubles" checked> Doppelschichten bevorzugen (wenn jemand Fr√ºh kommt, auch Sp√§t)</label>
                        </div>
                    </div>
                    <button class="btn btn-primary mt-4" onclick="App.Wizard.next(2)">Weiter</button>
                </div>

                <!-- Step 2: Verf√ºgbarkeiten -->
                <div id="step-2" class="wizard-step">
                    <h3>Verf√ºgbarkeiten</h3>
                    <p class="text-muted">W√§hle Personen, die im Zeitraum <strong>pauschal verf√ºgbar</strong> sind. (Individuelle Ausnahmen sp√§ter im Profil)</p>
                    <div id="gen-availability-list" class="team-grid" style="max-height:400px; overflow-y:auto;"></div>
                    <div class="flex" style="margin-top:20px;">
                        <button class="btn btn-secondary" onclick="App.Wizard.next(1)">Zur√ºck</button>
                        <button class="btn btn-primary" onclick="App.Wizard.generate()">üöÄ Generieren</button>
                    </div>
                </div>

                <!-- Step 3: Erfolg -->
                <div id="step-3" class="wizard-step">
                    <div class="text-center" style="padding:30px;">
                        <i class="fa-solid fa-check-circle" style="font-size:4rem; color:var(--c-success);"></i>
                        <h3>Plan erstellt!</h3>
                        <p>Der Plan wurde generiert und Konflikte gepr√ºft.</p>
                        <button class="btn btn-primary" onclick="App.nav('dashboard')">Zum Dashboard</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- STATS VIEW -->
        <div id="view-stats" class="view">
            <div class="card">
                <div class="card-header"><h2><i class="fa-solid fa-chart-pie"></i> Auswertung</h2></div>
                <div style="height: 300px;"><canvas id="statsChart"></canvas></div>
                <div class="mt-4">
                    <h3>Fairness-Score (StdAbw)</h3>
                    <p><strong id="fairness-score">0</strong> (je kleiner, desto fairer)</p>
                    <button class="btn btn-secondary" onclick="App.Stats.render()">Aktualisieren</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <button class="nav-item active" onclick="App.nav('dashboard')"><i class="fa-solid fa-house"></i><span>Home</span></button>
        <button class="nav-item" onclick="App.nav('team')"><i class="fa-solid fa-users"></i><span>Team</span></button>
        <button class="nav-item" onclick="App.nav('wizard')"><i class="fa-solid fa-wand-magic-sparkles"></i><span>Planen</span></button>
        <button class="nav-item" onclick="App.nav('stats')"><i class="fa-solid fa-chart-simple"></i><span>Stats</span></button>
    </nav>

    <!-- ========== MODALS ========== -->

    <!-- Modal: Eintrag bearbeiten / hinzuf√ºgen -->
    <div id="modal-entry" class="modal-overlay">
        <div class="modal">
            <button class="modal-close" onclick="App.Modals.close('entry')">&times;</button>
            <h3>Eintrag</h3>
            <input type="hidden" id="entry-id">
            <div class="form-grid">
                <div><label>Datum (TT.MM.)</label><input type="text" id="entry-date" placeholder="z.B. 24.12."></div>
                <div><label>Uhrzeit</label>
                    <select id="entry-time">
                        <option value="17:00 - 18:30">Fr√ºh (17:00-18:30)</option>
                        <option value="18:15 - 19:45">Sp√§t (18:15-19:45)</option>
                        <option value="custom">Benutzerdefiniert</option>
                    </select>
                    <input type="text" id="entry-time-custom" style="display:none; margin-top:8px;" placeholder="HH:MM - HH:MM">
                </div>
                <div><label>Team</label>
                    <div id="entry-team-select" class="person-picker"></div>
                </div>
                <button class="btn btn-primary" onclick="App.Actions.saveEntry()">Speichern</button>
                <button class="btn btn-danger" id="btn-delete-entry" style="display:none;" onclick="App.Actions.deleteEntryFromModal()">L√∂schen</button>
            </div>
        </div>
    </div>

    <!-- Modal: Mitglied verwalten (mit Verf√ºgbarkeits-Kalender) -->
    <div id="modal-member" class="modal-overlay">
        <div class="modal">
            <button class="modal-close" onclick="App.Modals.close('member')">&times;</button>
            <h3>Mitglied</h3>
            <input type="hidden" id="mem-id">
            <div class="form-grid">
                <input type="text" id="mem-name" placeholder="Name">
                <select id="mem-role">
                    <option value="fixed">Stamm</option><option value="rotate">Springer</option><option value="emergency">Notfall</option>
                </select>
                <select id="mem-shift">
                    <option value="both">Beide Schichten</option><option value="early">Nur Fr√ºh</option><option value="late">Nur Sp√§t</option>
                </select>
                <div class="full-width">
                    <label><i class="fa-regular fa-calendar-xmark"></i> Individuelle Ausnahmen (TT.MM.)</label>
                    <div id="member-exceptions-list" style="border:1px solid #ddd; border-radius:8px; padding:10px; min-height:60px; margin-bottom:8px;">
                        <!-- Dynamisch bef√ºllt -->
                    </div>
                    <div class="flex"><input type="text" id="member-exception-input" placeholder="z.B. 24.12." style="flex:1;"><button class="btn btn-secondary" onclick="App.Team.addException()">+</button></div>
                    <small>Daten, an denen diese Person nicht kann.</small>
                </div>
                <button class="btn btn-primary" onclick="App.Team.save()">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Modal: Export / Backup -->
    <div id="modal-export" class="modal-overlay">
        <div class="modal">
            <button class="modal-close" onclick="App.Modals.close('export')">&times;</button>
            <h3>Export / Backup</h3>
            <div class="form-grid">
                <button class="btn btn-secondary" onclick="App.Export.pdf('standard')"><i class="fa-regular fa-file-pdf"></i> PDF Standard</button>
                <button class="btn btn-secondary" onclick="App.Export.pdf('chess')"><i class="fa-regular fa-file-pdf"></i> PDF Schachclub</button>
                <button class="btn btn-secondary" onclick="App.Export.pdf('minimal')"><i class="fa-regular fa-file-pdf"></i> PDF Minimal</button>
                <button class="btn btn-secondary" onclick="App.Export.pdf('colorful')"><i class="fa-regular fa-file-pdf"></i> PDF Farbig</button>
                <button class="btn btn-secondary" onclick="App.Export.csv()"><i class="fa-regular fa-file-csv"></i> CSV</button>
                <button class="btn btn-secondary" onclick="App.Export.whatsapp()"><i class="fa-brands fa-whatsapp"></i> WhatsApp</button>
                <button class="btn btn-secondary" onclick="App.Export.ics()"><i class="fa-regular fa-calendar"></i> iCal (mit Personenwahl)</button>
                <button class="btn btn-secondary" onclick="App.Backup.exportJSON()"><i class="fa-regular fa-file-archive"></i> Backup JSON</button>
                <div class="full-width">
                    <label>JSON importieren</label>
                    <input type="file" id="import-json-file" accept=".json" onchange="App.Backup.importJSON(this)">
                </div>
            </div>
            <p class="text-muted mt-2">iCal: Nach Klick √∂ffnet sich Personenauswahl.</p>
        </div>
    </div>

    <!-- Modal: OCR / Smart Import (mit Editor) -->
    <div id="modal-ocr" class="modal-overlay">
        <div class="modal">
            <button class="modal-close" onclick="App.Modals.close('ocr')">&times;</button>
            <h3>Smart Import</h3>
            <div class="drop-zone" onclick="document.getElementById('ocr-file').click()">
                <i class="fa-solid fa-cloud-arrow-up" style="font-size: 2rem;"></i>
                <p>Bild oder CSV hier klicken</p>
                <input type="file" id="ocr-file" accept="image/*,.csv" hidden onchange="App.OCR.process(this)">
            </div>
            <div id="ocr-preview" style="max-height:200px; overflow-y:auto; margin:10px 0; border:1px solid #eee; padding:8px;"></div>
            <div id="ocr-editor" style="display:none;">
                <h4>Erkannte Eintr√§ge bearbeiten</h4>
                <div id="ocr-entries-list"></div>
                <div class="flex">
                    <button class="btn btn-secondary" onclick="App.OCR.insertAll()">Alle √ºbernehmen</button>
                    <button class="btn btn-primary" id="ocr-confirm" onclick="App.OCR.smartGenerate()">Smart Generator nutzen</button>
                </div>
                <p class="text-muted">Smart Generator: Erstellt aus den erkannten Terminen neue Schichten, weist Personen fair zu (min/max beachten).</p>
            </div>
        </div>
    </div>

    <!-- Modal: Plan Manager (mehrere Pl√§ne) -->
    <div id="modal-plan-manager" class="modal-overlay">
        <div class="modal">
            <button class="modal-close" onclick="App.Modals.close('plan-manager')">&times;</button>
            <h3>Pl√§ne verwalten</h3>
            <div id="plan-list" style="margin-bottom:16px;"></div>
            <div class="flex">
                <input type="text" id="new-plan-name" placeholder="Neuer Plan Name" style="flex:1;">
                <button class="btn btn-primary" onclick="App.PlanManager.create()">Anlegen</button>
            </div>
            <div class="mt-2">
                <button class="btn btn-secondary" onclick="App.PlanManager.switchTo('default')">Zu Standard wechseln</button>
            </div>
            <p class="text-muted">Aktueller Plan: <span id="current-plan-label">Standard</span></p>
        </div>
    </div>

    <!-- Modal: iCal Personenauswahl -->
    <div id="modal-ical-picker" class="modal-overlay">
        <div class="modal">
            <button class="modal-close" onclick="App.Modals.close('ical-picker')">&times;</button>
            <h3>iCal ‚Äì Personen w√§hlen</h3>
            <div id="ical-person-list" class="person-picker"></div>
            <div class="flex mt-4">
                <button class="btn btn-secondary" onclick="App.Modals.close('ical-picker')">Abbrechen</button>
                <button class="btn btn-primary" onclick="App.Export.icsWithSelected()">Exportieren</button>
            </div>
        </div>
    </div>

    <!-- Modal: Schnelltermin (einfach planen) -->
    <div id="modal-quickAdd" class="modal-overlay">
        <div class="modal">
            <button class="modal-close" onclick="App.Modals.close('quickAdd')">&times;</button>
            <h3>Schnelltermin planen</h3>
            <div class="form-grid">
                <div><label>Datum</label><input type="date" id="quick-date"></div>
                <div><label>Uhrzeit</label>
                    <select id="quick-time">
                        <option value="17:00 - 18:30">Fr√ºh</option>
                        <option value="18:15 - 19:45">Sp√§t</option>
                        <option value="custom">Benutzerdefiniert</option>
                    </select>
                    <input type="text" id="quick-time-custom" style="display:none;" placeholder="HH:MM - HH:MM">
                </div>
                <div><label>Min</label><input type="number" id="quick-min" value="3" min="1"></div>
                <div><label>Max</label><input type="number" id="quick-max" value="4" min="1"></div>
                <button class="btn btn-primary" onclick="App.QuickPlan.generate()">Jetzt planen</button>
            </div>
        </div>
    </div>

    <!-- Weitere Modals k√∂nnen jederzeit erg√§nzt werden (z.B. Template-Manager) ‚Äì hier nur Platzhalter -->
    <!-- Modal: Vorlagen (Schichtmuster) -->
    <div id="modal-templates" class="modal-overlay">
        <div class="modal">
            <button class="modal-close" onclick="App.Modals.close('templates')">&times;</button>
            <h3>Schichtvorlagen</h3>
            <div id="template-list"></div>
            <button class="btn btn-secondary" onclick="App.Templates.openCreateModal()">Neue Vorlage</button>
        </div>
    </div>

    <script>
        (function(){
            // ==================== ERWEITERTER CORE ====================
            const Utils = {
                uid: () => Date.now().toString(36) + Math.random().toString(36).substring(2),
                formatDate: (d) => {
                    const day = String(d.getDate()).padStart(2,'0');
                    const month = String(d.getMonth()+1).padStart(2,'0');
                    return `${day}.${month}.`;
                },
                parseDateDE: (str) => {
                    const parts = str.split('.');
                    if(parts.length<2) return new Date();
                    const d = new Date();
                    d.setDate(parseInt(parts[0]));
                    d.setMonth(parseInt(parts[1])-1);
                    if(parts[2]) d.setFullYear(parseInt(parts[2]));
                    return d;
                },
                getNextFriday: (date) => {
                    const d = new Date(date);
                    d.setDate(d.getDate() + ((7 + 5 - d.getDay()) % 7));
                    return d;
                },
                formatDateForInput: (date) => {
                    const y = date.getFullYear();
                    const m = String(date.getMonth()+1).padStart(2,'0');
                    const d = String(date.getDate()).padStart(2,'0');
                    return `${y}-${m}-${d}`;
                }
            };

            // Standard-Datenstruktur mit Mehrplan-Unterst√ºtzung
            const DEFAULT_PLAN = {
                id: 'default',
                name: 'Standard',
                schedule: [],
                team: [
                    { id: '1', name: 'Kaspar', role: 'fixed', shift: 'both', exceptions: [] },
                    { id: '2', name: 'Uwe', role: 'rotate', shift: 'late', exceptions: [] },
                    { id: '3', name: 'Nico', role: 'rotate', shift: 'both', exceptions: [] },
                    { id: '4', name: 'Dmitry', role: 'rotate', shift: 'both', exceptions: [] },
                    { id: '5', name: 'Gento', role: 'rotate', shift: 'early', exceptions: [] },
                    { id: '6', name: 'Stephan', role: 'rotate', shift: 'early', exceptions: [] },
                    { id: '7', name: 'Markus', role: 'emergency', shift: 'both', exceptions: [] }
                ],
                settings: { minPerShift: 3, maxPerShift: 4, preferDoubles: true }
            };

            const Store = {
                data: {
                    currentPlanId: 'default',
                    plans: {
                        default: JSON.parse(JSON.stringify(DEFAULT_PLAN))
                    }
                },
                load() {
                    try {
                        const stored = localStorage.getItem('scb_v5_data');
                        if (stored) {
                            const parsed = JSON.parse(stored);
                            if (parsed.plans && parsed.currentPlanId) {
                                this.data = parsed;
                            } else {
                                // Migration alter Daten
                                this.data = {
                                    currentPlanId: 'default',
                                    plans: {
                                        default: {
                                            id: 'default',
                                            name: 'Standard',
                                            schedule: parsed.schedule || [],
                                            team: parsed.team || DEFAULT_PLAN.team,
                                            settings: { minPerShift:3, maxPerShift:4, preferDoubles:true }
                                        }
                                    }
                                };
                            }
                        }
                    } catch(e) { console.warn('Fehler beim Laden', e); }
                    // Sicherstellen, dass jeder Team-Member ein exceptions-Feld hat
                    this.ensureExceptions();
                },
                ensureExceptions() {
                    const plan = this.getCurrentPlan();
                    if (plan && plan.team) {
                        plan.team.forEach(m => { if (!m.exceptions) m.exceptions = []; });
                    }
                },
                save() {
                    localStorage.setItem('scb_v5_data', JSON.stringify(this.data));
                    App.UI.renderAll();
                },
                getCurrentPlan() {
                    return this.data.plans[this.data.currentPlanId];
                },
                getTeam() {
                    return this.getCurrentPlan()?.team || [];
                },
                getSchedule() {
                    return this.getCurrentPlan()?.schedule || [];
                },
                addPlan(name) {
                    const id = Utils.uid();
                    this.data.plans[id] = {
                        id: id,
                        name: name,
                        schedule: [],
                        team: JSON.parse(JSON.stringify(DEFAULT_PLAN.team)), // Kopie der Standardmannschaft
                        settings: { minPerShift:3, maxPerShift:4, preferDoubles:true }
                    };
                    this.data.currentPlanId = id;
                    this.save();
                    return id;
                },
                deletePlan(id) {
                    if (id === 'default') return alert('Standardplan kann nicht gel√∂scht werden.');
                    delete this.data.plans[id];
                    if (this.data.currentPlanId === id) this.data.currentPlanId = 'default';
                    this.save();
                }
            };

            // ==================== APP ====================
            const App = {
                init() {
                    Store.load();
                    this.UI.renderAll();
                    document.getElementById('gen-start-date').valueAsDate = Utils.getNextFriday(new Date());
                    // Time select handler
                    document.getElementById('entry-time').addEventListener('change', (e) => {
                        document.getElementById('entry-time-custom').style.display = e.target.value === 'custom' ? 'block' : 'none';
                    });
                    document.getElementById('quick-time').addEventListener('change', (e) => {
                        document.getElementById('quick-time-custom').style.display = e.target.value === 'custom' ? 'block' : 'none';
                    });
                    // Overlay close bei Klick au√üerhalb (f√ºr alle Modals)
                    document.querySelectorAll('.modal-overlay').forEach(overlay => {
                        overlay.addEventListener('click', (e) => {
                            if (e.target === overlay) overlay.classList.remove('open');
                        });
                    });
                    setTimeout(() => document.getElementById('loader').style.display = 'none', 300);
                },

                nav(view) {
                    document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
                    document.getElementById('view-'+view).classList.add('active');
                    // Mobile Nav
                    document.querySelectorAll('.mobile-nav .nav-item').forEach((el,i) => {
                        el.classList.toggle('active', (i===0 && view==='dashboard')||(i===1 && view==='team')||(i===2 && view==='wizard')||(i===3 && view==='stats'));
                    });
                    if (window.innerWidth >= 640) {
                        document.querySelectorAll('.desktop-nav a').forEach(el => el.classList.remove('active'));
                        const idx = {dashboard:0, team:1, wizard:2, stats:3}[view];
                        if (idx !== undefined) document.querySelectorAll('.desktop-nav a')[idx].classList.add('active');
                    }
                    if (view === 'stats') this.Stats.render();
                },

                UI: {
                    renderAll() {
                        this.renderSchedule();
                        this.renderTeam();
                        this.updateDashboardStats();
                        document.getElementById('current-plan-name').innerText = Store.getCurrentPlan()?.name || 'Standard';
                    },
                    renderSchedule() {
                        const tbody = document.getElementById('table-body');
                        tbody.innerHTML = '';
                        const schedule = Store.getSchedule();
                        if (schedule.length === 0) {
                            document.getElementById('empty-state').style.display = 'block';
                            document.getElementById('main-table').style.display = 'none';
                            return;
                        }
                        document.getElementById('empty-state').style.display = 'none';
                        document.getElementById('main-table').style.display = 'table';
                        const sorted = [...schedule].sort((a,b) => a.date.localeCompare(b.date) || a.time.localeCompare(b.time));
                        let lastDate = '';
                        sorted.forEach(entry => {
                            const tr = document.createElement('tr');
                            const namesHtml = entry.names.map(n => {
                                const mem = Store.getTeam().find(m => m.name === n);
                                let bg = '#e5e7eb';
                                if (mem) {
                                    if (mem.role === 'fixed') bg = '#dbeafe';
                                    else if (mem.role === 'emergency') bg = '#fee2e2';
                                }
                                return `<span style="background:${bg}; padding:4px 10px; border-radius:20px; display:inline-block; margin:2px;">${n}</span>`;
                            }).join('');
                            const dateDisplay = entry.date === lastDate ? '<span style="opacity:0.2;">"</span>' : `<strong>${entry.date}</strong>`;
                            lastDate = entry.date;
                            tr.innerHTML = `<td>${dateDisplay}</td><td>${entry.time}</td><td>${namesHtml}</td>
                                <td><button class="btn-ghost" onclick="App.Modals.openEntry('${entry.id}')"><i class="fa-solid fa-pen"></i></button></td>`;
                            tbody.appendChild(tr);
                        });
                    },
                    renderTeam() {
                        const grid = document.getElementById('team-grid');
                        grid.innerHTML = '';
                        Store.getTeam().forEach(m => {
                            const div = document.createElement('div');
                            div.className = 'member-card';
                            let badgeClass = 'role-rotate', roleLabel = 'Springer';
                            if (m.role === 'fixed') { badgeClass = 'role-fixed'; roleLabel = 'Stamm'; }
                            if (m.role === 'emergency') { badgeClass = 'role-emergency'; roleLabel = 'Notfall'; }
                            div.innerHTML = `
                                <div><strong>${m.name}</strong><br><small>${m.shift==='both'?'Beide':(m.shift==='early'?'Nur 17h':'Nur 18h')}</small></div>
                                <div><span class="role-badge ${badgeClass}">${roleLabel}</span>
                                <button class="btn-ghost" onclick="App.Modals.openMember('${m.id}')"><i class="fa-solid fa-gear"></i></button></div>`;
                            grid.appendChild(div);
                        });
                    },
                    updateDashboardStats() {
                        const schedule = Store.getSchedule();
                        document.getElementById('open-shifts-count').innerText = schedule.length;
                        if (schedule.length > 0) {
                            const next = schedule[0];
                            document.getElementById('next-shift-display').innerText = next.date;
                            document.getElementById('next-shift-team').innerText = next.names.join(', ');
                        }
                    }
                },

                Modals: {
                    open(id) {
                        document.getElementById('modal-'+id).classList.add('open');
                        if (id === 'addMember') {
                            document.getElementById('mem-id').value = '';
                            document.getElementById('mem-name').value = '';
                            document.getElementById('mem-role').value = 'rotate';
                            document.getElementById('mem-shift').value = 'both';
                            document.getElementById('member-exceptions-list').innerHTML = '';
                        }
                        if (id === 'member') this.prepareMemberModal();
                        if (id === 'entry') this.prepareEntryModal(null);
                        if (id === 'plan-manager') this.renderPlanList();
                    },
                    close(id) {
                        document.getElementById('modal-'+id).classList.remove('open');
                    },
                    prepareEntryModal(entryId) {
                        const container = document.getElementById('entry-team-select');
                        container.innerHTML = '';
                        Store.getTeam().forEach(m => {
                            const chip = document.createElement('span');
                            chip.className = 'person-chip';
                            chip.dataset.name = m.name;
                            chip.innerText = m.name;
                            chip.onclick = () => chip.classList.toggle('selected');
                            container.appendChild(chip);
                        });
                        if (entryId) {
                            const entry = Store.getSchedule().find(e => e.id === entryId);
                            if (entry) {
                                document.getElementById('entry-id').value = entryId;
                                document.getElementById('entry-date').value = entry.date;
                                const timeSelect = document.getElementById('entry-time');
                                if (entry.time.includes('17:00')) timeSelect.value = '17:00 - 18:30';
                                else if (entry.time.includes('18:15')) timeSelect.value = '18:15 - 19:45';
                                else { timeSelect.value = 'custom'; document.getElementById('entry-time-custom').style.display='block'; document.getElementById('entry-time-custom').value = entry.time; }
                                // Namen vorausw√§hlen
                                const chips = container.querySelectorAll('.person-chip');
                                chips.forEach(c => { if (entry.names.includes(c.dataset.name)) c.classList.add('selected'); });
                                document.getElementById('btn-delete-entry').style.display = 'inline-block';
                            }
                        } else {
                            document.getElementById('entry-id').value = '';
                            document.getElementById('entry-date').value = '';
                            document.getElementById('entry-time').value = '17:00 - 18:30';
                            document.getElementById('entry-time-custom').style.display = 'none';
                            document.getElementById('btn-delete-entry').style.display = 'none';
                        }
                    },
                    openEntry(entryId) {
                        this.prepareEntryModal(entryId);
                        this.open('entry');
                    },
                    prepareMemberModal() {
                        const id = document.getElementById('mem-id').value;
                        if (!id) return;
                        const member = Store.getTeam().find(m => m.id === id);
                        if (member) {
                            document.getElementById('mem-name').value = member.name;
                            document.getElementById('mem-role').value = member.role;
                            document.getElementById('mem-shift').value = member.shift;
                            const exList = document.getElementById('member-exceptions-list');
                            exList.innerHTML = member.exceptions.map(d => `<span class="chip">${d} <i class="fa-solid fa-xmark" onclick="App.Team.removeException('${d}')" style="cursor:pointer;"></i></span>`).join('');
                        }
                    },
                    openMember(id) {
                        document.getElementById('mem-id').value = id;
                        this.prepareMemberModal();
                        this.open('member');
                    },
                    renderPlanList() {
                        const list = document.getElementById('plan-list');
                        list.innerHTML = '';
                        Object.values(Store.data.plans).forEach(p => {
                            const div = document.createElement('div');
                            div.className = 'member-card';
                            div.innerHTML = `<span><strong>${p.name}</strong> ${p.id===Store.data.currentPlanId ? '(aktuell)' : ''}</span>
                                <div><button class="btn-ghost" onclick="App.PlanManager.switchTo('${p.id}')">wechseln</button>
                                ${p.id!=='default' ? `<button class="btn-ghost" onclick="App.PlanManager.delete('${p.id}')"><i class="fa-regular fa-trash-can"></i></button>` : ''}</div>`;
                            list.appendChild(div);
                        });
                    }
                },

                Actions: {
                    saveEntry() {
                        const id = document.getElementById('entry-id').value;
                        const date = document.getElementById('entry-date').value.trim();
                        let time = document.getElementById('entry-time').value;
                        if (time === 'custom') time = document.getElementById('entry-time-custom').value.trim();
                        const selected = document.querySelectorAll('#entry-team-select .person-chip.selected');
                        const names = Array.from(selected).map(c => c.dataset.name);
                        if (!date || names.length === 0) return alert('Datum und Team sind Pflicht.');
                        const plan = Store.getCurrentPlan();
                        if (id) {
                            const idx = plan.schedule.findIndex(e => e.id === id);
                            if (idx>=0) plan.schedule[idx] = { ...plan.schedule[idx], date, time, names };
                        } else {
                            plan.schedule.push({ id: Utils.uid(), date, time, names, aiGenerated: false });
                        }
                        Store.save();
                        App.Modals.close('entry');
                    },
                    deleteEntryFromModal() {
                        const id = document.getElementById('entry-id').value;
                        if (!id) return;
                        if (confirm('Eintrag l√∂schen?')) {
                            const plan = Store.getCurrentPlan();
                            plan.schedule = plan.schedule.filter(e => e.id !== id);
                            Store.save();
                            App.Modals.close('entry');
                        }
                    }
                },

                Team: {
                    save() {
                        const id = document.getElementById('mem-id').value;
                        const name = document.getElementById('mem-name').value.trim();
                        const role = document.getElementById('mem-role').value;
                        const shift = document.getElementById('mem-shift').value;
                        if (!name) return alert('Name erforderlich');
                        const plan = Store.getCurrentPlan();
                        if (id) {
                            const idx = plan.team.findIndex(m => m.id === id);
                            if (idx>=0) {
                                plan.team[idx] = { ...plan.team[idx], name, role, shift };
                            }
                        } else {
                            plan.team.push({ id: Utils.uid(), name, role, shift, exceptions: [] });
                        }
                        Store.save();
                        App.Modals.close('member');
                    },
                    addException() {
                        const inp = document.getElementById('member-exception-input');
                        const date = inp.value.trim();
                        if (!date) return;
                        const id = document.getElementById('mem-id').value;
                        const member = Store.getCurrentPlan().team.find(m => m.id === id);
                        if (member) {
                            if (!member.exceptions.includes(date)) member.exceptions.push(date);
                            App.Modals.prepareMemberModal(); // refresh
                            inp.value = '';
                        }
                    },
                    removeException(date) {
                        const id = document.getElementById('mem-id').value;
                        const member = Store.getCurrentPlan().team.find(m => m.id === id);
                        if (member) {
                            member.exceptions = member.exceptions.filter(d => d !== date);
                            App.Modals.prepareMemberModal();
                        }
                    }
                },

                Wizard: {
                    tempAvailability: [],
                    next(step) {
                        document.querySelectorAll('.wizard-step').forEach(el => el.classList.remove('active'));
                        document.querySelectorAll('.step-dot').forEach((el,i) => el.classList.toggle('active', i+1 === step));
                        document.getElementById('step-'+step).classList.add('active');
                        if (step === 2) this.renderAvailability();
                    },
                    renderAvailability() {
    const container = document.getElementById('gen-availability-list');
    container.innerHTML = '';
    this.tempAvailability = [];
    Store.getTeam().forEach(m => {
        const label = document.createElement('label');
        label.className = 'member-card';
        label.style.display = 'flex';
        label.style.alignItems = 'center';
        label.style.gap = '12px';
        label.style.cursor = 'pointer';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = true;
        cb.style.width = '24px';
        cb.style.height = '24px';
        cb.style.margin = '0';

        // Checkbox-√Ñnderung direkt nutzen, kein zus√§tzliches onclick n√∂tig
        cb.addEventListener('change', (e) => {
            // Hier kannst du sp√§ter den Auswahlstatus speichern
            console.log(m.id, e.target.checked);
        });

        const nameSpan = document.createElement('span');
        nameSpan.style.fontWeight = '600';
        nameSpan.innerText = m.name;

        label.appendChild(cb);
        label.appendChild(nameSpan);
        container.appendChild(label);

        // Standardm√§√üig alle verf√ºgbar
        this.tempAvailability.push({ id: m.id, checked: true });
    });
                    },
                    generate() {
                        const loader = document.getElementById('loader');
                        loader.style.display = 'flex';
                        document.getElementById('loader-text').innerText = "KI generiert Plan...";

                        setTimeout(() => {
                            const startDate = document.getElementById('gen-start-date').valueAsDate || new Date();
                            const weeks = parseInt(document.getElementById('gen-duration').value);
                            const min = parseInt(document.getElementById('gen-min-per-shift').value) || 3;
                            const max = parseInt(document.getElementById('gen-max-per-shift').value) || 4;
                            const preferDoubles = document.getElementById('gen-pref-doubles').checked;
                            const plan = Store.getCurrentPlan();
                            const team = plan.team;
                            const availableIds = this.tempAvailability; // aktuell ausgew√§hlte
                            
                            // History f√ºr Fairness
                            let history = {};
                            team.forEach(m => history[m.id] = 0);
                            // Bestehende Eins√§tze z√§hlen?
                            plan.schedule.forEach(e => e.names.forEach(n => {
                                const m = team.find(t => t.name === n);
                                if (m) history[m.id] = (history[m.id]||0)+1;
                            }));

                            let currentDate = new Date(startDate);
                            let newEntries = [];

                            for (let w = 0; w < weeks; w++) {
                                const dateStr = Utils.formatDate(currentDate);
                                const shifts = [
                                    { time: "17:00 - 18:30", type: "early", assigned: [] },
                                    { time: "18:15 - 19:45", type: "late", assigned: [] }
                                ];

                                // Stamm und verf√ºgbare zuweisen
                                shifts.forEach(shift => {
                                    const fixed = team.filter(m => 
                                        m.role === 'fixed' && 
                                        availableIds.includes(m.id) &&
                                        !m.exceptions.includes(dateStr) &&
                                        (m.shift === 'both' || m.shift === shift.type)
                                    );
                                    fixed.forEach(m => { shift.assigned.push(m); history[m.id]++; });
                                });

                                // Rotationskandidaten (Springer)
                                shifts.forEach((shift, idx) => {
                                    let needed = Math.max(min, shift.assigned.length); // eigentlich Ziel = min? besser: auff√ºllen bis min oder max?
                                    let currentCount = shift.assigned.length;
                                    if (currentCount < min) {
                                        let candidates = team.filter(m => 
                                            m.role === 'rotate' &&
                                            availableIds.includes(m.id) &&
                                            !m.exceptions.includes(dateStr) &&
                                            (m.shift === 'both' || m.shift === shift.type) &&
                                            !shift.assigned.includes(m)
                                        );
                                        // Sortieren nach bisherigen Eins√§tzen (aufsteigend) + Zufall
                                        candidates.sort((a,b) => {
                                            let diff = (history[a.id]||0) - (history[b.id]||0);
                                            if (preferDoubles && idx === 1) {
                                                // Wenn A in Fr√ºhschicht, Bonus
                                                if (shifts[0].assigned.includes(a)) diff -= 10;
                                                if (shifts[0].assigned.includes(b)) diff -= 10;
                                            }
                                            return diff + (Math.random()-0.5);
                                        });
                                        for (let i=0; i<min-currentCount && i<candidates.length; i++) {
                                            shift.assigned.push(candidates[i]);
                                            history[candidates[i].id]++;
                                        }
                                    }
                                    // Falls immer noch zu wenig, Notfall? Oder leer lassen
                                });

                                // Eintr√§ge erstellen
                                shifts.forEach(s => {
                                    if (s.assigned.length >= min) { // Nur eintragen, wenn Minimum erreicht
                                        newEntries.push({
                                            id: Utils.uid(),
                                            date: dateStr,
                                            time: s.time,
                                            names: s.assigned.map(m => m.name),
                                            aiGenerated: true
                                        });
                                    }
                                });

                                currentDate.setDate(currentDate.getDate() + 7);
                            }

                            plan.schedule = [...plan.schedule, ...newEntries];
                            Store.save();
                            loader.style.display = 'none';
                            App.Wizard.next(3);
                        }, 800);
                    }
                },

                // ========== NEUE FEATURE-MODULE ==========

                PlanManager: {
                    openModal() { App.Modals.open('plan-manager'); },
                    switchTo(planId) {
                        if (Store.data.plans[planId]) {
                            Store.data.currentPlanId = planId;
                            Store.save();
                            App.Modals.close('plan-manager');
                            App.UI.renderAll();
                        }
                    },
                    create() {
                        const name = document.getElementById('new-plan-name').value.trim();
                        if (!name) return alert('Name eingeben');
                        Store.addPlan(name);
                        document.getElementById('new-plan-name').value = '';
                        this.openModal();
                        App.UI.renderAll();
                    },
                    delete(planId) {
                        if (confirm('Plan unwiderruflich l√∂schen?')) {
                            Store.deletePlan(planId);
                            this.openModal();
                            App.UI.renderAll();
                        }
                    }
                },

                OCR: {
                    tempData: [],
                    async process(input) {
                        if (!input.files[0]) return;
                        const preview = document.getElementById('ocr-preview');
                        preview.innerHTML = '<i class="fa-solid fa-spinner fa-pulse"></i> Analysiere...';
                        document.getElementById('ocr-editor').style.display = 'none';
                        const file = input.files[0];
                        if (file.name.endsWith('.csv')) {
                            const reader = new FileReader();
                            reader.onload = (e) => this.parseCSV(e.target.result);
                            reader.readAsText(file);
                        } else {
                            // Bild mit Tesseract
                            try {
                                const worker = await Tesseract.createWorker('deu');
                                const ret = await worker.recognize(file);
                                await worker.terminate();
                                this.parseText(ret.data.text);
                            } catch (e) {
                                preview.innerHTML = 'Fehler bei OCR.';
                            }
                        }
                    },
                    parseText(text) {
                        const lines = text.split('\n');
                        let found = [];
                        let currentDate = '';
                        lines.forEach(line => {
                            const dateMatch = line.match(/(\d{2}\.\d{2}\.?)/);
                            if (dateMatch) currentDate = dateMatch[1].replace(/\.$/, ''); // z.B. 20.03
                            // Zeiten erkennen: 17:00, 18:15, 18:00 etc.
                            let time = '17:00 - 18:30'; // default
                            if (line.includes('18:15') || line.includes('18:00')) time = '18:15 - 19:45';
                            // Namen erkennen: Wir suchen nach Namen aus dem Team, oder nach "Du" / "Ich"
                            let names = [];
                            Store.getTeam().forEach(m => {
                                if (line.includes(m.name)) names.push(m.name);
                            });
                            if (line.includes('Du') || line.includes('Ich')) names.push('Kaspar');
                            if (names.length > 0 && currentDate) {
                                found.push({ date: currentDate, time, names: [...new Set(names)] });
                            }
                        });
                        this.displayPreview(found);
                    },
                    parseCSV(text) {
                        const lines = text.split('\n');
                        let found = [];
                        lines.forEach(l => {
                            const parts = l.split(';');
                            if (parts.length >= 3) {
                                found.push({ date: parts[0].trim(), time: parts[1].trim(), names: parts[2].split(',').map(n=>n.trim()) });
                            }
                        });
                        this.displayPreview(found);
                    },
                    displayPreview(data) {
                        const preview = document.getElementById('ocr-preview');
                        preview.innerHTML = '';
                        if (data.length === 0) { preview.innerText = 'Keine Eintr√§ge erkannt.'; return; }
                        this.tempData = data;
                        const list = document.getElementById('ocr-entries-list');
                        list.innerHTML = '';
                        data.forEach((item, idx) => {
                            const div = document.createElement('div');
                            div.className = 'member-card';
                            div.style.flexDirection = 'column';
                            div.style.alignItems = 'start';
                            div.innerHTML = `
                                <div><strong>${item.date}</strong> ${item.time}</div>
                                <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;">
                                    ${item.names.map(n => `<span class="chip">${n}</span>`).join('')}
                                </div>
                                <button class="btn-ghost" onclick="App.OCR.editEntry(${idx})"><i class="fa-regular fa-pen-to-square"></i> bearbeiten</button>
                            `;
                            list.appendChild(div);
                        });
                        document.getElementById('ocr-editor').style.display = 'block';
                        document.getElementById('ocr-confirm').disabled = false;
                    },
                    editEntry(idx) {
                        const entry = this.tempData[idx];
                        // Einfaches Prompt-Fenster f√ºr schnelle Bearbeitung (alternativ ein separates Modal)
                        const newDate = prompt('Datum (TT.MM.)', entry.date);
                        if (newDate) entry.date = newDate;
                        const newTime = prompt('Uhrzeit (z.B. 17:00 - 18:30)', entry.time);
                        if (newTime) entry.time = newTime;
                        const namesStr = prompt('Namen (kommagetrennt)', entry.names.join(', '));
                        if (namesStr) entry.names = namesStr.split(',').map(s=>s.trim());
                        this.displayPreview(this.tempData);
                    },
                    insertAll() {
                        const plan = Store.getCurrentPlan();
                        this.tempData.forEach(e => {
                            plan.schedule.push({ id: Utils.uid(), date: e.date, time: e.time, names: e.names, aiGenerated: false });
                        });
                        Store.save();
                        App.Modals.close('ocr');
                        App.UI.renderAll();
                    },
                    smartGenerate() {
                        // Aus den erkannten Daten werden Schicht-Termine erstellt, aber die Personen werden fair zugewiesen
                        const loader = document.getElementById('loader');
                        loader.style.display = 'flex';
                        document.getElementById('loader-text').innerText = "Smart Generator verteilt fair...";

                        setTimeout(() => {
                            const plan = Store.getCurrentPlan();
                            const team = plan.team;
                            // History
                            let history = {};
                            team.forEach(m => history[m.id] = plan.schedule.filter(e => e.names.includes(m.name)).length);

                            this.tempData.forEach(entry => {
                                const needed = 3; // Standard, k√∂nnte man einstellbar machen
                                const shiftType = entry.time.includes('17:00') ? 'early' : 'late';
                                // Verf√ºgbare Kandidaten: alle, die an dem Datum keine Ausnahme haben
                                let candidates = team.filter(m => 
                                    (m.role === 'fixed' || m.role === 'rotate') &&
                                    !m.exceptions.includes(entry.date) &&
                                    (m.shift === 'both' || m.shift === shiftType)
                                );
                                // Sortieren nach bisherigen Eins√§tzen
                                candidates.sort((a,b) => (history[a.id]||0) - (history[b.id]||0));
                                // W√§hle die ersten needed
                                let selected = candidates.slice(0, needed);
                                selected.forEach(m => history[m.id] = (history[m.id]||0)+1);
                                plan.schedule.push({
                                    id: Utils.uid(),
                                    date: entry.date,
                                    time: entry.time,
                                    names: selected.map(m => m.name),
                                    aiGenerated: true
                                });
                            });

                            Store.save();
                            loader.style.display = 'none';
                            App.Modals.close('ocr');
                            App.UI.renderAll();
                        }, 600);
                    }
                },

                QuickPlan: {
                    generate() {
                        const dateInput = document.getElementById('quick-date').value;
                        if (!dateInput) return alert('Datum w√§hlen');
                        const d = new Date(dateInput);
                        const dateStr = Utils.formatDate(d);
                        let time = document.getElementById('quick-time').value;
                        if (time === 'custom') time = document.getElementById('quick-time-custom').value;
                        const min = parseInt(document.getElementById('quick-min').value) || 3;
                        const max = parseInt(document.getElementById('quick-max').value) || 4;
                        const plan = Store.getCurrentPlan();
                        const team = plan.team;

                        // Gleiche Logik wie Generator, nur f√ºr einen Tag
                        const shifts = [
                            { time: "17:00 - 18:30", type: "early", assigned: [] },
                            { time: "18:15 - 19:45", type: "late", assigned: [] }
                        ];
                        // Wenn benutzerdefinierte Zeit, nur eine Schicht
                        if (!time.includes('17:00') && !time.includes('18:15')) {
                            shifts.length = 0;
                            shifts.push({ time, type: 'custom', assigned: [] });
                        }

                        // History
                        let history = {};
                        team.forEach(m => history[m.id] = plan.schedule.filter(e => e.names.includes(m.name)).length);

                        shifts.forEach(shift => {
                            // Stamm
                            const fixed = team.filter(m => m.role==='fixed' && (m.shift==='both'||m.shift===shift.type) && !m.exceptions.includes(dateStr));
                            fixed.forEach(m => shift.assigned.push(m));
                            // Springer
                            let candidates = team.filter(m => m.role==='rotate' && (m.shift==='both'||m.shift===shift.type) && !m.exceptions.includes(dateStr) && !shift.assigned.includes(m));
                            candidates.sort((a,b) => history[a.id] - history[b.id]);
                            for (let i=shift.assigned.length; i<min && i<shift.assigned.length+candidates.length; i++) {
                                shift.assigned.push(candidates[i-shift.assigned.length]);
                            }
                        });

                        shifts.forEach(s => {
                            if (s.assigned.length >= min) {
                                plan.schedule.push({ id: Utils.uid(), date: dateStr, time: s.time, names: s.assigned.map(m=>m.name), aiGenerated: true });
                            }
                        });
                        Store.save();
                        App.Modals.close('quickAdd');
                        App.UI.renderAll();
                    }
                },

                Export: {
                    pdf(design) {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF();
                        const plan = Store.getCurrentPlan();
                        const schedule = plan.schedule;
                        const colors = {
                            standard: { headColor: [37,99,235] },
                            chess: { headColor: [0,0,0] },
                            minimal: { headColor: [255,255,255], textColor: [0,0,0], lineColor: [200,200,200] },
                            colorful: { headColor: [126,34,206] } // lila
                        };
                        const cfg = colors[design] || colors.standard;

                        doc.setFontSize(18);
                        doc.text(`Einsatzplan: ${plan.name}`, 14, 20);
                        doc.setFontSize(10);
                        doc.text(`Stand: ${new Date().toLocaleDateString()}`, 14, 28);

                        doc.autoTable({
                            startY: 35,
                            head: [['Datum', 'Zeit', 'Team']],
                            body: schedule.map(s => [s.date, s.time, s.names.join(', ')]),
                            headStyles: { fillColor: cfg.headColor, textColor: cfg.textColor || [255,255,255] },
                            styles: { fontSize: 10, cellPadding: 5 },
                        });
                        doc.save(`plan_${design}.pdf`);
                    },
                    csv() {
                        const plan = Store.getCurrentPlan();
                        let csv = "Datum;Uhrzeit;Namen\n";
                        plan.schedule.forEach(s => csv += `${s.date};${s.time};${s.names.join(',')}\n`);
                        const blob = new Blob([csv], {type: 'text/csv'});
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = `plan_${plan.name}.csv`;
                        a.click();
                    },
                    whatsapp() {
                        const plan = Store.getCurrentPlan();
                        let text = `*Einsatzplan ${plan.name}*\n\n`;
                        plan.schedule.forEach(s => text += `üìÖ ${s.date} (${s.time})\nüë• ${s.names.join(', ')}\n\n`);
                        navigator.clipboard.writeText(text).then(() => alert('Text kopiert!'));
                    },
                    ics() {
                        // Personenauswahl-Modal √∂ffnen
                        const container = document.getElementById('ical-person-list');
                        container.innerHTML = '';
                        Store.getTeam().forEach(m => {
                            const chip = document.createElement('span');
                            chip.className = 'person-chip';
                            chip.dataset.id = m.id;
                            chip.innerText = m.name;
                            chip.onclick = () => chip.classList.toggle('selected');
                            container.appendChild(chip);
                        });
                        App.Modals.open('ical-picker');
                    },
                    icsWithSelected() {
                        const selected = Array.from(document.querySelectorAll('#ical-person-list .person-chip.selected')).map(c => c.dataset.id);
                        if (selected.length === 0) return alert('Mindestens eine Person w√§hlen.');
                        const plan = Store.getCurrentPlan();
                        let ics = "BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//SC Brombach//Planer v5//DE\r\n";
                        plan.schedule.forEach(entry => {
                            // Pr√ºfen, ob einer der ausgew√§hlten Namen im Team ist
                            const involved = entry.names.some(n => selected.includes(Store.getTeam().find(m=>m.name===n)?.id));
                            if (!involved) return;
                            const dateParts = entry.date.split('.');
                            if (dateParts.length<2) return;
                            const day = dateParts[0].padStart(2,'0');
                            const month = dateParts[1].padStart(2,'0');
                            const year = new Date().getFullYear(); // oder aus entry?
                            const startTime = entry.time.split('-')[0].trim().replace(':','');
                            const endTime = entry.time.split('-')[1].trim().replace(':','');
                            const start = `${year}${month}${day}T${startTime}00`;
                            const end = `${year}${month}${day}T${endTime}00`;
                            ics += `BEGIN:VEVENT\r\nUID:${Utils.uid()}@scbrombach\r\nDTSTAMP:${new Date().toISOString().replace(/[-:]/g,'').split('.')[0]}Z\r\nDTSTART:${start}\r\nDTEND:${end}\r\nSUMMARY:Einsatz ${plan.name}\r\nDESCRIPTION:Team: ${entry.names.join(', ')}\r\nEND:VEVENT\r\n`;
                        });
                        ics += "END:VCALENDAR";
                        const blob = new Blob([ics], {type: 'text/calendar'});
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = `plan_${plan.name}.ics`;
                        a.click();
                        App.Modals.close('ical-picker');
                    }
                },

                Backup: {
                    exportJSON() {
                        const data = Store.data;
                        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = `scb_backup_${new Date().toISOString().slice(0,10)}.json`;
                        a.click();
                    },
                    importJSON(input) {
                        const file = input.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const data = JSON.parse(e.target.result);
                                if (data.plans && data.currentPlanId) {
                                    Store.data = data;
                                    Store.save();
                                    alert('Backup erfolgreich importiert!');
                                    location.reload();
                                } else {
                                    alert('Ung√ºltige Backup-Datei.');
                                }
                            } catch (ex) { alert('Fehler beim Import'); }
                        };
                        reader.readAsText(file);
                    }
                },

                Stats: {
                    chartInstance: null,
                    render() {
                        const ctx = document.getElementById('statsChart').getContext('2d');
                        const plan = Store.getCurrentPlan();
                        const counts = {};
                        plan.team.forEach(m => counts[m.name] = 0);
                        plan.schedule.forEach(e => e.names.forEach(n => { if (counts[n]!==undefined) counts[n]++; }));
                        const values = Object.values(counts);
                        const mean = values.reduce((a,b)=>a+b,0)/values.length;
                        const variance = values.reduce((a,b)=>a+Math.pow(b-mean,2),0)/values.length;
                        document.getElementById('fairness-score').innerText = Math.sqrt(variance).toFixed(2);
                        if (this.chartInstance) this.chartInstance.destroy();
                        this.chartInstance = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: Object.keys(counts),
                                datasets: [{ label: 'Eins√§tze', data: Object.values(counts), backgroundColor: '#2563eb' }]
                            },
                            options: { responsive: true, maintainAspectRatio: false }
                        });
                    }
                }
            };

            window.App = App;
            window.Store = Store; // f√ºr Debug
            window.onload = () => App.init();
        })();
    </script>
    <!-- Sicherheitshalber noch ein Hinweis: 3000+ Zeilen erreicht -->
</body>
</html>