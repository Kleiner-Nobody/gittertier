<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gittertier Planer Pro</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* --- Design System (Based on 404.html) --- */
        :root {
            --color-bg: #ffffff;
            --color-surface: #f9fafb;
            --color-text: #111111;
            --color-text-muted: #6b7280;
            --color-border: #e5e7eb;
            --color-accent: #2563eb;
            --color-accent-hover: #1d4ed8;
            --color-success: #16a34a;
            --color-warning: #f59e0b;
            --color-error: #dc2626;
            --color-overlay: rgba(0, 0, 0, 0.5);
            
            --radius: 12px;
            --radius-sm: 6px;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.07), 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, sans-serif;
            --header-height: 60px;
            --nav-height: 65px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-family);
            background-color: var(--color-surface);
            color: var(--color-text);
            margin: 0;
            padding-bottom: calc(var(--nav-height) + 20px); /* Platz f√ºr Bottom Nav */
        }

        /* --- Header --- */
        header {
            background: var(--color-bg);
            height: var(--header-height);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .brand {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--color-text);
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }
        .brand img { height: 30px; width: auto; }
        .brand span { color: var(--color-accent); }

        /* --- Main Layout --- */
        main {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Cards --- */
        .card {
            background: var(--color-bg);
            border-radius: var(--radius);
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        h2 { margin: 0; font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        h3 { margin: 0 0 10px 0; font-size: 1rem; color: var(--color-text-muted); font-weight: 500; }

        /* --- Buttons --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid transparent;
            text-decoration: none;
        }
        
        .btn-primary { background-color: var(--color-accent); color: white; }
        .btn-primary:hover { background-color: var(--color-accent-hover); box-shadow: var(--shadow-md); }
        
        .btn-secondary { background-color: white; border-color: var(--color-border); color: var(--color-text); }
        .btn-secondary:hover { background-color: var(--color-surface); }
        
        .btn-ghost { background: transparent; color: var(--color-text-muted); padding: 8px; }
        .btn-ghost:hover { color: var(--color-accent); background: #eff6ff; }

        .btn-danger { background-color: #fef2f2; color: var(--color-error); border-color: #fee2e2; }

        .btn-full { width: 100%; }

        /* --- Bottom Navigation (Mobile) --- */
        .bottom-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: var(--nav-height);
            background: var(--color-bg);
            border-top: 1px solid var(--color-border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--color-text-muted);
            font-size: 0.75rem;
            gap: 4px;
            height: 100%;
            cursor: pointer;
            transition: 0.2s;
        }
        
        .nav-item i { font-size: 1.2rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--color-accent); }

        /* --- Views --- */
        .view { display: none; }
        .view.active { display: block; }

        /* --- Table --- */
        .schedule-list { list-style: none; padding: 0; margin: 0; }
        
        .schedule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--color-border);
        }
        .schedule-item:last-child { border-bottom: none; }
        
        .schedule-info { flex: 1; }
        .schedule-date { font-weight: 600; font-size: 1rem; display: block; }
        .schedule-time { font-size: 0.85rem; color: var(--color-text-muted); display: block; margin-top: 2px; }
        .schedule-team { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
        
        .avatar {
            background: #eff6ff; color: var(--color-accent);
            padding: 4px 10px; border-radius: 99px;
            font-size: 0.8rem; font-weight: 500;
        }

        /* --- Team Grid --- */
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
        }

        .team-card {
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
        }
        .team-card.selected { border-color: var(--color-accent); background: #eff6ff; }
        .team-role { font-size: 0.75rem; color: var(--color-text-muted); margin-top: 4px; }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--color-overlay);
            z-index: 200;
            display: flex; align-items: flex-end; /* Mobile sheet style */
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        
        @media(min-width: 768px) { .modal-overlay { align-items: center; justify-content: center; } }

        .modal-overlay.open { opacity: 1; pointer-events: auto; }

        .modal {
            background: var(--color-bg);
            width: 100%;
            max-width: 500px;
            border-radius: var(--radius) var(--radius) 0 0;
            padding: 24px;
            transform: translateY(100%); transition: 0.3s cubic-bezier(0.2, 0, 0, 1);
            max-height: 90vh; overflow-y: auto;
        }
        
        @media(min-width: 768px) { 
            .modal { border-radius: var(--radius); transform: translateY(20px); }
            .modal-overlay.open .modal { transform: translateY(0); }
        }
        .modal-overlay.open .modal { transform: translateY(0); }

        /* --- Form Elements --- */
        .form-group { margin-bottom: 16px; }
        label { display: block; font-size: 0.9rem; color: var(--color-text-muted); margin-bottom: 6px; }
        input, select, textarea {
            width: 100%; padding: 12px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-family: inherit; font-size: 1rem;
            background: #fff;
        }
        input:focus { outline: none; border-color: var(--color-accent); }

        /* --- AI Badge --- */
        .ai-badge {
            background: linear-gradient(135deg, #6366f1, #a855f7);
            color: white; padding: 2px 8px; border-radius: 4px;
            font-size: 0.7rem; font-weight: 700; text-transform: uppercase;
            margin-left: 8px;
        }

        /* --- Wizard Steps --- */
        .wizard-step { display: none; }
        .wizard-step.active { display: block; animation: fadeIn 0.3s; }

    </style>
</head>
<body>

    <header>
        <a href="#" class="brand">
            <img src="https://www.loerrach.de/ceasy/resource/3714" alt="SCB Logo">
            SC Brombach <span>Planer</span>
        </a>
        <button class="btn btn-ghost" onclick="app.exportWhatsApp()">
            <i class="fa-brands fa-whatsapp" style="font-size: 1.2rem; color: #25D366;"></i>
        </button>
    </header>

    <main>
        
        <div id="view-dashboard" class="view active">
            
            <div class="card" id="aiCard" style="background: linear-gradient(to right, #f8fafc, #eff6ff); border-color: #bfdbfe;">
                <div class="card-header">
                    <h2><i class="fa-solid fa-robot" style="color: var(--color-accent);"></i> AI Analyse</h2>
                    <span class="ai-badge">Beta</span>
                </div>
                <div id="aiContent">
                    <p style="color: var(--color-text-muted); font-size: 0.9rem;">
                        Ich analysiere deine Pl√§ne auf Fairness und L√ºcken. F√ºge Eintr√§ge hinzu, um zu starten.
                    </p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>Aktueller Plan</h2>
                    <button class="btn btn-secondary btn-sm" onclick="app.openPDFModal()">
                        <i class="fa-solid fa-file-pdf"></i> PDF
                    </button>
                </div>
                
                <div id="emptyState" style="text-align: center; padding: 40px 0; display: none;">
                    <i class="fa-solid fa-clipboard-list" style="font-size: 3rem; color: #e5e7eb; margin-bottom: 15px;"></i>
                    <p style="color: var(--color-text-muted);">Keine Termine geplant.</p>
                    <button class="btn btn-primary" onclick="app.navTo('wizard')">
                        Plan generieren
                    </button>
                </div>

                <ul class="schedule-list" id="scheduleList">
                    </ul>
            </div>
        </div>

        <div id="view-wizard" class="view">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fa-solid fa-wand-magic-sparkles"></i> Smart Generator</h2>
                </div>

                <div id="step-1" class="wizard-step active">
                    <div class="form-group">
                        <label>Startdatum (Freitag)</label>
                        <input type="date" id="wizStartDate">
                    </div>
                    <div class="form-group">
                        <label>Zeitraum</label>
                        <select id="wizDuration">
                            <option value="4">4 Wochen</option>
                            <option value="8" selected>8 Wochen</option>
                            <option value="12">12 Wochen (Quartal)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Modus</label>
                        <select id="wizMode">
                            <option value="standard">Standard (Fr√ºh & Sp√§t)</option>
                            <option value="force">Alle verf√ºgbaren Kr√§fte</option>
                        </select>
                    </div>
                    <button class="btn btn-primary btn-full" onclick="wizard.nextStep()">Weiter</button>
                </div>

                <div id="step-2" class="wizard-step">
                    <h3>Verf√ºgbares Team pr√ºfen</h3>
                    <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">W√§hle ab, wer in diesem Zeitraum komplett fehlt (Urlaub/Krank).</p>
                    
                    <div class="team-grid" id="wizTeamGrid">
                        </div>

                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn btn-secondary btn-full" onclick="wizard.prevStep()">Zur√ºck</button>
                        <button class="btn btn-primary btn-full" onclick="wizard.generate()">Generieren</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-team" class="view">
            <div class="card">
                <div class="card-header">
                    <h2>Team Verwaltung</h2>
                    <button class="btn btn-primary" onclick="app.openTeamModal()">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>
                <div class="schedule-list" id="teamList">
                    </div>
            </div>
        </div>

        <div id="view-tools" class="view">
            <div class="card">
                <h2><i class="fa-solid fa-file-csv"></i> Smart CSV Import</h2>
                <p style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">
                    F√ºge Excel-Daten ein. Das System erkennt Namen automatisch und lernt neue Teilnehmer ("Verschlaubisierung").
                </p>
                <textarea id="csvInput" rows="5" placeholder="09.01.; 17:00; Kaspar, Uwe"></textarea>
                <button class="btn btn-primary btn-full" style="margin-top: 10px;" onclick="app.importCSV()">
                    Analysieren & Importieren
                </button>
            </div>

            <div class="card" style="border-color: var(--color-error);">
                <h2 style="color: var(--color-error);"><i class="fa-solid fa-triangle-exclamation"></i> Danger Zone</h2>
                <p style="font-size: 0.9rem; margin-bottom: 10px;">Alle Daten l√∂schen.</p>
                <button class="btn btn-danger btn-full" onclick="app.resetAll()">Factory Reset</button>
            </div>
        </div>

    </main>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="app.navTo('dashboard', this)">
            <i class="fa-solid fa-calendar-days"></i>
            <span>Plan</span>
        </div>
        <div class="nav-item" onclick="app.navTo('wizard', this)">
            <i class="fa-solid fa-wand-magic-sparkles"></i>
            <span>Wizard</span>
        </div>
        <div class="nav-item" onclick="app.navTo('team', this)">
            <i class="fa-solid fa-users"></i>
            <span>Team</span>
        </div>
        <div class="nav-item" onclick="app.navTo('tools', this)">
            <i class="fa-solid fa-sliders"></i>
            <span>Tools</span>
        </div>
    </nav>

    <div id="modalEdit" class="modal-overlay">
        <div class="modal">
            <div class="card-header">
                <h2>Termin bearbeiten</h2>
                <button class="btn btn-ghost" onclick="app.closeModal('modalEdit')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <input type="hidden" id="editId">
            
            <div class="form-group">
                <label>Datum</label>
                <input type="text" id="editDate">
            </div>
            <div class="form-group">
                <label>Uhrzeit</label>
                <div style="display:flex; gap:10px;">
                    <button type="button" class="btn btn-secondary" style="flex:1;" onclick="document.getElementById('editTime').value='17:00 - 18:30'">Fr√ºh</button>
                    <button type="button" class="btn btn-secondary" style="flex:1;" onclick="document.getElementById('editTime').value='18:15 - 19:45'">Sp√§t</button>
                </div>
                <input type="text" id="editTime" style="margin-top: 5px;">
            </div>
            
            <div class="form-group">
                <label>Eingeteiltes Team</label>
                <div class="team-grid" id="editTeamGrid">
                    </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-danger btn-full" onclick="app.deleteEntry()">L√∂schen</button>
                <button class="btn btn-primary btn-full" onclick="app.saveEntry()">Speichern</button>
            </div>
        </div>
    </div>

    <div id="modalTeam" class="modal-overlay">
        <div class="modal">
            <div class="card-header">
                <h2>Person verwalten</h2>
                <button class="btn btn-ghost" onclick="app.closeModal('modalTeam')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <input type="hidden" id="memberId">
            
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="memberName">
            </div>
            
            <div class="form-group">
                <label>Rolle (H√§ufigkeit)</label>
                <select id="memberRole">
                    <option value="fixed">Stammspieler (Immer/Prio)</option>
                    <option value="rotate">Rotation (Normal)</option>
                    <option value="backup">Springer (Selten)</option>
                </select>
            </div>

            <div class="form-group">
                <label>Bevorzugte Schicht</label>
                <select id="memberShift">
                    <option value="both">Egal</option>
                    <option value="early">Fr√ºh (17:00)</option>
                    <option value="late">Sp√§t (18:15)</option>
                </select>
            </div>

            <button class="btn btn-primary btn-full" onclick="app.saveMember()">Speichern</button>
        </div>
    </div>

    <div id="modalPDF" class="modal-overlay">
        <div class="modal">
             <div class="card-header">
                <h2>PDF Design</h2>
                <button class="btn btn-ghost" onclick="app.closeModal('modalPDF')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div style="display: grid; gap: 10px;">
                <button class="btn btn-secondary btn-full" onclick="app.generatePDF('standard')">
                    <i class="fa-solid fa-palette"></i> Standard (Blau)
                </button>
                <button class="btn btn-secondary btn-full" onclick="app.generatePDF('chess')">
                    <i class="fa-solid fa-chess-knight"></i> Schachclub (S/W)
                </button>
                <button class="btn btn-secondary btn-full" onclick="app.generatePDF('list')">
                    <i class="fa-solid fa-list"></i> Simple Liste
                </button>
            </div>
        </div>
    </div>

    <script>
        /**
         * Gittertier Planer Pro Logic
         * Uses LocalStorage for persistence.
         */
        
        class PlanerApp {
            constructor() {
                this.data = JSON.parse(localStorage.getItem('gp_data')) || {
                    schedule: [],
                    team: [
                        { id: 1, name: 'Kaspar', role: 'fixed', shift: 'both' },
                        { id: 2, name: 'Uwe', role: 'rotate', shift: 'late' },
                        { id: 3, name: 'Nico', role: 'rotate', shift: 'both' },
                        { id: 4, name: 'Dmitry', role: 'rotate', shift: 'both' },
                        { id: 5, name: 'Gento', role: 'rotate', shift: 'early' },
                        { id: 6, name: 'Stephan', role: 'rotate', shift: 'early' }
                    ]
                };
                this.init();
            }

            init() {
                this.renderSchedule();
                this.renderTeam();
                this.runAIAnalysis();
                
                // Set Date for Wizard
                const nextFri = this.getNextFriday();
                document.getElementById('wizStartDate').valueAsDate = nextFri;
            }

            save() {
                localStorage.setItem('gp_data', JSON.stringify(this.data));
                this.renderSchedule();
                this.runAIAnalysis();
            }

            navTo(viewId, navEl) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById('view-' + viewId).classList.add('active');
                
                if(navEl) {
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    navEl.classList.add('active');
                }
            }

            /* --- RENDER LOGIC --- */
            renderSchedule() {
                const list = document.getElementById('scheduleList');
                list.innerHTML = '';
                const empty = document.getElementById('emptyState');

                if (this.data.schedule.length === 0) {
                    empty.style.display = 'block';
                    return;
                }
                empty.style.display = 'none';

                // Sort by date logic (simple string compare for now, assumed correct format)
                this.data.schedule.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'schedule-item';
                    li.innerHTML = `
                        <div class="schedule-info" onclick="app.openEditModal(${index})">
                            <span class="schedule-date">${item.date}</span>
                            <span class="schedule-time"><i class="fa-regular fa-clock"></i> ${item.time}</span>
                            <div class="schedule-team">
                                ${item.names.map(n => `<span class="avatar">${n}</span>`).join('')}
                            </div>
                        </div>
                        <button class="btn btn-ghost" onclick="app.openEditModal(${index})">
                            <i class="fa-solid fa-pen-to-square"></i>
                        </button>
                    `;
                    list.appendChild(li);
                });
            }

            renderTeam() {
                const list = document.getElementById('teamList');
                list.innerHTML = '';
                
                this.data.team.forEach(member => {
                    const div = document.createElement('div');
                    div.className = 'schedule-item';
                    
                    let roleIcon = '<i class="fa-solid fa-arrows-rotate"></i>'; // Rotate
                    if(member.role === 'fixed') roleIcon = '<i class="fa-solid fa-anchor"></i>';
                    if(member.role === 'backup') roleIcon = '<i class="fa-solid fa-life-ring"></i>';

                    div.innerHTML = `
                        <div class="schedule-info">
                            <span class="schedule-date">${member.name}</span>
                            <span class="schedule-time">${roleIcon} ${member.role.toUpperCase()} | Schicht: ${member.shift}</span>
                        </div>
                        <button class="btn btn-ghost" onclick="app.openTeamMember(${member.id})">
                            <i class="fa-solid fa-gear"></i>
                        </button>
                    `;
                    list.appendChild(div);
                });
            }

            /* --- AI & LOGIC --- */
            runAIAnalysis() {
                const aiBox = document.getElementById('aiContent');
                if(this.data.schedule.length === 0) {
                    aiBox.innerHTML = '<p style="color:#666;">Keine Daten f√ºr eine Analyse.</p>';
                    return;
                }

                // Fairness Check
                let counts = {};
                this.data.team.forEach(t => counts[t.name] = 0);
                let warnings = [];

                this.data.schedule.forEach(s => {
                    s.names.forEach(n => {
                        if(counts[n] !== undefined) counts[n]++;
                        else counts[n] = 1; // Unknown person
                    });
                    
                    // Check Understaffing
                    if(s.names.length < 2) {
                        warnings.push(`‚ö†Ô∏è <strong>${s.date} (${s.time})</strong>: Nur ${s.names.length} Person(en)!`);
                    }
                });

                // Find overworked/underworked
                let max = 0; let min = 999;
                Object.values(counts).forEach(c => {
                    if(c > max) max = c;
                    if(c < min) min = c;
                });

                let html = '<div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px;">';
                
                // Render Mini Charts
                Object.keys(counts).forEach(name => {
                    const percent = max > 0 ? (counts[name] / max) * 100 : 0;
                    const color = counts[name] === max ? 'var(--color-accent)' : '#cbd5e1';
                    html += `
                        <div style="text-align:center; min-width:50px;">
                            <div style="height:50px; display:flex; align-items:flex-end; justify-content:center;">
                                <div style="width:10px; background:${color}; height:${percent}%; border-radius:4px;"></div>
                            </div>
                            <span style="font-size:0.7rem;">${name}</span>
                            <div style="font-size:0.8rem; font-weight:bold;">${counts[name]}</div>
                        </div>
                    `;
                });
                html += '</div>';

                if(warnings.length > 0) {
                    html += `<div style="margin-top:10px; background:#fef2f2; padding:10px; border-radius:8px; font-size:0.85rem; color:var(--color-error);">
                        ${warnings.slice(0, 3).join('<br>')}
                        ${warnings.length > 3 ? '<br>...und weitere.' : ''}
                    </div>`;
                } else {
                    html += `<div style="margin-top:10px; color:var(--color-success); font-size:0.9rem;">
                        <i class="fa-solid fa-check-circle"></i> Keine kritischen Engp√§sse gefunden.
                    </div>`;
                }

                aiBox.innerHTML = html;
            }

            /* --- MODALS --- */
            openModal(id) { document.getElementById(id).classList.add('open'); }
            closeModal(id) { document.getElementById(id).classList.remove('open'); }

            openEditModal(index) {
                const entry = this.data.schedule[index];
                document.getElementById('editId').value = index;
                document.getElementById('editDate').value = entry.date;
                document.getElementById('editTime').value = entry.time;

                // Build Team Selector
                const grid = document.getElementById('editTeamGrid');
                grid.innerHTML = '';
                this.data.team.forEach(m => {
                    const isSelected = entry.names.includes(m.name);
                    const div = document.createElement('div');
                    div.className = `team-card ${isSelected ? 'selected' : ''}`;
                    div.innerHTML = `<strong>${m.name}</strong>`;
                    div.onclick = () => {
                        div.classList.toggle('selected');
                    };
                    grid.appendChild(div);
                });

                this.openModal('modalEdit');
            }

            saveEntry() {
                const idx = document.getElementById('editId').value;
                const grid = document.getElementById('editTeamGrid');
                const selectedNames = [];
                grid.querySelectorAll('.selected').forEach(el => selectedNames.push(el.innerText));

                const newData = {
                    date: document.getElementById('editDate').value,
                    time: document.getElementById('editTime').value,
                    names: selectedNames
                };

                if(idx !== "") {
                    this.data.schedule[idx] = newData;
                }
                this.save();
                this.closeModal('modalEdit');
            }

            deleteEntry() {
                const idx = document.getElementById('editId').value;
                if(confirm('Wirklich l√∂schen?')) {
                    this.data.schedule.splice(idx, 1);
                    this.save();
                    this.closeModal('modalEdit');
                }
            }
            
            /* --- TEAM MANAGEMENT --- */
            openTeamModal() {
                document.getElementById('memberId').value = 'new';
                document.getElementById('memberName').value = '';
                this.openModal('modalTeam');
            }

            openTeamMember(id) {
                const member = this.data.team.find(m => m.id === id);
                document.getElementById('memberId').value = id;
                document.getElementById('memberName').value = member.name;
                document.getElementById('memberRole').value = member.role;
                document.getElementById('memberShift').value = member.shift;
                this.openModal('modalTeam');
            }

            saveMember() {
                const id = document.getElementById('memberId').value;
                const name = document.getElementById('memberName').value;
                const role = document.getElementById('memberRole').value;
                const shift = document.getElementById('memberShift').value;

                if(!name) return;

                if(id === 'new') {
                    const newId = Date.now();
                    this.data.team.push({ id: newId, name, role, shift });
                } else {
                    const member = this.data.team.find(m => m.id == id);
                    member.name = name;
                    member.role = role;
                    member.shift = shift;
                }
                this.save();
                this.renderTeam();
                this.closeModal('modalTeam');
            }

            /* --- TOOLS --- */
            importCSV() {
                const txt = document.getElementById('csvInput').value;
                const lines = txt.split('\n');
                let newCount = 0;
                let newNames = 0;

                lines.forEach(line => {
                    const parts = line.split(';');
                    if(parts.length >= 2) {
                        const date = parts[0].trim();
                        const time = parts[1].trim();
                        const namesRaw = parts[2] || "";
                        
                        // Smart Name Parsing
                        const names = namesRaw.split(/,|&|\+/).map(n => n.trim()).filter(n => n);
                        
                        // "Verschlaubisierung": Check if name exists, if not, add to team
                        names.forEach(n => {
                            const exists = this.data.team.find(t => t.name.toLowerCase() === n.toLowerCase());
                            if(!exists && n.length > 2) {
                                this.data.team.push({ id: Date.now() + Math.random(), name: n, role: 'rotate', shift: 'both' });
                                newNames++;
                            }
                        });

                        this.data.schedule.push({ date, time, names });
                        newCount++;
                    }
                });

                alert(`${newCount} Termine importiert. ${newNames} neue Team-Mitglieder erkannt.`);
                this.save();
                this.renderTeam();
                document.getElementById('csvInput').value = '';
            }

            resetAll() {
                if(confirm("Alles l√∂schen? Kann nicht r√ºckg√§ngig gemacht werden.")) {
                    localStorage.removeItem('gp_data');
                    location.reload();
                }
            }

            exportWhatsApp() {
                let msg = "*üìÖ Einsatzplan Jugendtraining*\n\n";
                this.data.schedule.forEach(s => {
                    msg += `üóì *${s.date}* (${s.time})\nüë• ${s.names.join(', ')}\n\n`;
                });
                msg += "_Generiert mit Gittertier Pro_ üõí";
                
                // Copy to clipboard
                navigator.clipboard.writeText(msg).then(() => {
                    alert("Text f√ºr WhatsApp kopiert!");
                });
            }

            getNextFriday() {
                const d = new Date();
                const day = d.getDay();
                const diff = 5 - day; // 5 = Friday
                d.setDate(d.getDate() + (diff >= 0 ? diff : 7 + diff));
                return d;
            }

            openPDFModal() { this.openModal('modalPDF'); }

            generatePDF(design) {
                const doc = new window.jspdf.jsPDF();
                
                // Header colors
                let headColor = [37, 99, 235];
                if(design === 'chess') headColor = [0,0,0];

                doc.setFontSize(20);
                doc.text("Einsatzplan Jugendtraining", 14, 20);
                doc.setFontSize(10);
                doc.text(`Stand: ${new Date().toLocaleDateString('de-DE')}`, 14, 28);

                const bodyData = this.data.schedule.map(s => [s.date, s.time, s.names.join(', ')]);

                doc.autoTable({
                    startY: 35,
                    head: [['Datum', 'Uhrzeit', 'Team']],
                    body: bodyData,
                    theme: design === 'list' ? 'plain' : 'grid',
                    headStyles: { fillColor: headColor, textColor: 255 },
                    styles: { cellPadding: 4 }
                });

                doc.save('plan.pdf');
                this.closeModal('modalPDF');
            }
        }

        /**
         * Wizard Logic (Smart Generator)
         */
        const wizard = {
            step: 1,
            
            nextStep() {
                document.getElementById('step-1').classList.remove('active');
                document.getElementById('step-2').classList.add('active');
                this.renderTeamCheckboxes();
            },
            
            prevStep() {
                document.getElementById('step-2').classList.remove('active');
                document.getElementById('step-1').classList.add('active');
            },

            renderTeamCheckboxes() {
                const grid = document.getElementById('wizTeamGrid');
                grid.innerHTML = '';
                app.data.team.forEach(m => {
                    const div = document.createElement('div');
                    div.className = 'team-card selected'; // Default selected
                    div.innerHTML = `<strong>${m.name}</strong><div class="team-role">${m.shift}</div>`;
                    div.dataset.name = m.name;
                    div.onclick = () => div.classList.toggle('selected');
                    grid.appendChild(div);
                });
            },

            generate() {
                const startDate = new Date(document.getElementById('wizStartDate').value);
                const weeks = parseInt(document.getElementById('wizDuration').value);
                
                // Who is available?
                const availableNames = [];
                document.querySelectorAll('#wizTeamGrid .selected').forEach(el => availableNames.push(el.dataset.name));
                
                const activeTeam = app.data.team.filter(t => availableNames.includes(t.name));
                
                // Logic
                let currentDate = startDate;
                let newSchedule = [];
                
                // Fairness Tracker
                let assignCount = {};
                activeTeam.forEach(t => assignCount[t.name] = 0);

                for(let i=0; i<weeks; i++) {
                    const dateStr = currentDate.getDate().toString().padStart(2,'0') + '.' + (currentDate.getMonth()+1).toString().padStart(2,'0') + '.';
                    
                    const slots = [
                        { time: '17:00 - 18:30', shift: 'early', assigned: [] },
                        { time: '18:15 - 19:45', shift: 'late', assigned: [] }
                    ];

                    slots.forEach(slot => {
                        // 1. Assign FIXED roles
                        const fixed = activeTeam.filter(t => t.role === 'fixed' && (t.shift === 'both' || t.shift === slot.shift));
                        fixed.forEach(f => {
                            slot.assigned.push(f.name);
                            assignCount[f.name]++;
                        });

                        // 2. Fill with ROTATE roles (Target: 3 people)
                        let needed = 3 - slot.assigned.length;
                        if(needed > 0) {
                            // Find candidates
                            let candidates = activeTeam.filter(t => 
                                t.role === 'rotate' && 
                                (t.shift === 'both' || t.shift === slot.shift) &&
                                !slot.assigned.includes(t.name)
                            );
                            
                            // Sort by least assigned
                            candidates.sort((a,b) => assignCount[a.name] - assignCount[b.name]);
                            
                            // Pick top candidates
                            for(let k=0; k<needed; k++) {
                                if(candidates[k]) {
                                    slot.assigned.push(candidates[k].name);
                                    assignCount[candidates[k].name]++;
                                }
                            }
                        }

                        newSchedule.push({ date: dateStr, time: slot.time, names: slot.assigned });
                    });

                    currentDate.setDate(currentDate.getDate() + 7);
                }

                // Append to main data
                app.data.schedule = [...app.data.schedule, ...newSchedule];
                app.save();
                app.navTo('dashboard');
                alert("Plan erfolgreich generiert!");
                this.prevStep(); // Reset wizard
            }
        };

        // Start App
        const app = new PlanerApp();

    </script>
</body>
</html>