<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gittertier Planer Ultimate</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* --- Gittertier Pro Design System --- */
        :root {
            --color-bg: #f9fafb; /* Heller Background wie 404 */
            --color-surface: #ffffff;
            --color-text: #111111;
            --color-text-muted: #6b7280;
            --color-border: #e5e7eb;
            --color-accent: #2563eb;
            --color-accent-hover: #1d4ed8;
            --color-success: #16a34a;
            --color-warning: #f59e0b;
            --color-error: #dc2626;
            --color-overlay: rgba(0, 0, 0, 0.6);
            
            --radius: 12px;
            --radius-sm: 6px;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.07), 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            
            --nav-height: 65px;
            --header-height: 60px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding-bottom: calc(var(--nav-height) + 20px); /* Platz f√ºr Bottom Nav */
            padding-top: var(--header-height);
        }

        /* --- Header --- */
        header {
            position: fixed; top: 0; left: 0; right: 0;
            height: var(--header-height);
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px;
            z-index: 50;
            box-shadow: var(--shadow);
        }

        .brand {
            display: flex; align-items: center; gap: 10px;
            font-weight: 700; font-size: 1.1rem; color: #1e3a8a; text-decoration: none;
        }
        .brand img { height: 32px; }

        /* --- Main Layout --- */
        main {
            max-width: 800px;
            margin: 0 auto;
            padding: 16px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Cards --- */
        .card {
            background: var(--color-surface);
            border-radius: var(--radius);
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 16px;
            position: relative;
        }
        
        h2 { margin-top: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; color: var(--color-text); }
        h3 { font-size: 0.95rem; margin-bottom: 8px; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- Buttons --- */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            padding: 10px 16px; border-radius: var(--radius-sm); border: none;
            font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: 0.2s;
            width: 100%; text-decoration: none;
        }
        .btn-primary { background: var(--color-accent); color: white; }
        .btn-primary:active { background: var(--color-accent-hover); transform: scale(0.98); }
        .btn-secondary { background: white; border: 1px solid var(--color-border); color: var(--color-text); }
        .btn-success { background: var(--color-success); color: white; }
        .btn-danger { background: #fee2e2; color: var(--color-error); }
        
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }

        /* --- Inputs --- */
        input, select, textarea {
            width: 100%; padding: 10px; border: 1px solid var(--color-border);
            border-radius: var(--radius-sm); font-size: 16px; background: white;
            margin-bottom: 10px; transition: border 0.2s;
        }
        input:focus, select:focus { outline: none; border-color: var(--color-accent); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        /* --- Table --- */
        .table-container {
            border: 1px solid var(--color-border); border-radius: var(--radius); overflow: hidden;
            background: white;
        }
        .schedule-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 16px; border-bottom: 1px solid var(--color-border);
            cursor: pointer; transition: background 0.1s;
        }
        .schedule-row:last-child { border-bottom: none; }
        .schedule-row:active { background: #f3f4f6; }
        
        .row-date { font-weight: 700; width: 60px; font-size: 0.9rem; }
        .row-time { font-size: 0.8rem; color: var(--color-text-muted); width: 90px; }
        .row-names { flex: 1; font-size: 0.95rem; display: flex; flex-wrap: wrap; gap: 4px; }
        
        .name-tag {
            background: #eff6ff; color: var(--color-accent); 
            padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; font-weight: 500;
        }

        /* --- Team List --- */
        .team-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px; border: 1px solid var(--color-border); border-radius: var(--radius-sm);
            margin-bottom: 8px; background: white;
        }
        .role-badge {
            font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; font-weight: 700;
            margin-left: 6px;
        }
        .role-fixed { background: #dbeafe; color: var(--color-accent); }
        .role-springer { background: #f3f4f6; color: var(--color-text-muted); }
        .role-notfall { background: #fee2e2; color: var(--color-error); }

        /* --- Bottom Nav (Mobile) --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: var(--nav-height); background: white;
            border-top: 1px solid var(--color-border);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 100; padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--color-text-muted); font-size: 0.75rem; gap: 4px;
            width: 100%; height: 100%; text-decoration: none; cursor: pointer;
        }
        .nav-item i { font-size: 1.2rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--color-accent); }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--color-overlay); z-index: 200;
            display: flex; align-items: flex-end; /* Bottom sheet on mobile */
            opacity: 0; pointer-events: none; transition: 0.2s;
            backdrop-filter: blur(2px);
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        
        .modal {
            background: white; width: 100%; max-width: 600px;
            margin: 0 auto;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding: 24px; box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            transform: translateY(100%); transition: 0.3s cubic-bezier(0.2, 0, 0, 1);
            max-height: 90vh; overflow-y: auto;
        }
        @media(min-width: 600px) {
            .modal-overlay { align-items: center; }
            .modal { border-radius: var(--radius); transform: translateY(20px); opacity: 0; }
            .modal-overlay.open .modal { transform: translateY(0); opacity: 1; }
        }
        .modal-overlay.open .modal { transform: translateY(0); }

        /* --- Stats Bar --- */
        .stat-bar-container { width: 100%; background: #f3f4f6; height: 8px; border-radius: 4px; margin-top: 5px; overflow: hidden;}
        .stat-bar { height: 100%; background: var(--color-accent); width: 0%; transition: width 0.5s; }

        /* --- Wizard Styles --- */
        .wizard-step { display: none; }
        .wizard-step.active { display: block; animation: fadeIn 0.3s; }

        /* --- Utils --- */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .fab {
            position: fixed; bottom: 80px; right: 20px;
            width: 56px; height: 56px; border-radius: 50%;
            background: var(--color-accent); color: white;
            display: flex; align-items: center; justify-content: center;
            box-shadow: var(--shadow-lg); cursor: pointer; z-index: 90;
            font-size: 1.2rem; transition: 0.2s;
        }
        .fab:active { transform: scale(0.9); }

    </style>
</head>
<body>

    <header>
        <a href="#" class="brand">
            <img src="https://www.loerrach.de/ceasy/resource/3714" alt="SCB Logo">
            SCB Planer
        </a>
        <div style="font-size: 0.8rem; color: #666; font-weight: 500;">
            Ultimate Edition
        </div>
    </header>

    <main>
        
        <div id="view-home" class="view-section">
            <div class="card">
                <h2><i class="fa-solid fa-chart-pie"></i> Fairness Check</h2>
                <div id="statsContainer" style="margin-top: 15px; display: flex; flex-direction: column; gap: 10px;">
                    </div>
            </div>

            <div class="card" style="padding: 0; overflow: hidden;">
                <div style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin:0;"><i class="fa-solid fa-calendar-days"></i> Aktueller Plan</h2>
                    <button class="btn btn-secondary" onclick="shareWhatsApp()" style="width: auto; padding: 5px 10px; font-size: 0.8rem;">
                        <i class="fa-brands fa-whatsapp"></i> Teilen
                    </button>
                </div>
                
                <div id="planList" style="min-height: 100px;">
                    </div>
                <div id="emptyState" class="text-center" style="padding: 40px; color: #999; display: none;">
                    <i class="fa-solid fa-clipboard-list" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.3;"></i>
                    <p>Kein Plan vorhanden.</p>
                </div>
            </div>
            
            <div style="height: 60px;"></div> </div>

        <div id="view-team" class="view-section hidden">
            <div class="card">
                <h2><i class="fa-solid fa-users"></i> Teilnehmer</h2>
                <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">
                    Verwalte Rollen und Vorlieben. Der Generator nutzt diese Daten.
                </p>
                <div id="teamListContainer"></div>
                <button class="btn btn-secondary" onclick="openMemberModal()" style="margin-top: 15px;">
                    <i class="fa-solid fa-user-plus"></i> Person hinzuf√ºgen
                </button>
            </div>
        </div>

        <div id="view-wizard" class="view-section hidden">
            <div class="card">
                <h2><i class="fa-solid fa-wand-magic-sparkles"></i> Plan Generator</h2>
                
                <div id="wizStep1" class="wizard-step active">
                    <label>Startdatum (Freitag)</label>
                    <input type="date" id="genDate">
                    
                    <label>Dauer</label>
                    <select id="genDuration">
                        <option value="4">4 Wochen</option>
                        <option value="8" selected>8 Wochen</option>
                        <option value="12">12 Wochen</option>
                    </select>

                    <div style="margin: 15px 0; padding: 10px; background: #eff6ff; border-radius: 8px; font-size: 0.9rem; color: #1e40af;">
                        <i class="fa-solid fa-info-circle"></i> <strong>Smarte Logik:</strong>
                        <ul style="margin: 5px 0 0 20px; padding:0;">
                            <li>Doppelschichten bleiben zusammen.</li>
                            <li>"Stammspieler" werden zuerst gesetzt.</li>
                            <li>"Springer" rotieren fair.</li>
                            <li>"Notfall" nur wenn leer.</li>
                        </ul>
                    </div>

                    <button class="btn btn-primary" onclick="runGeneratorWizard()">Plan Generieren</button>
                </div>
            </div>

            <div class="card">
                <h2><i class="fa-solid fa-file-import"></i> CSV Import "Smart"</h2>
                <textarea id="csvInputSmart" rows="4" placeholder="Einfach Text reinkopieren...&#10;09.01.; Kaspar, Uwe&#10;16.01.; Nico"></textarea>
                <button class="btn btn-secondary" onclick="processSmartCSV()">
                    <i class="fa-solid fa-brain"></i> Verschlaubisieren & Importieren
                </button>
            </div>
        </div>

        <div id="view-settings" class="view-section hidden">
            <div class="card">
                <h2><i class="fa-solid fa-download"></i> Export</h2>
                <div class="btn-group" style="flex-direction: column;">
                    <button class="btn btn-primary" onclick="generatePDF()">
                        <i class="fa-solid fa-file-pdf"></i> Als PDF speichern
                    </button>
                    <button class="btn btn-secondary" onclick="exportICal()">
                        <i class="fa-solid fa-calendar-plus"></i> F√ºr Kalender (iCal)
                    </button>
                    <button class="btn btn-secondary" onclick="exportBackup()">
                        <i class="fa-solid fa-floppy-disk"></i> Backup Datei (JSON)
                    </button>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fa-solid fa-upload"></i> Restore</h2>
                <input type="file" id="backupFile" onchange="importBackup(this)">
                <button class="btn btn-danger" onclick="hardReset()" style="margin-top: 20px;">
                    <i class="fa-solid fa-trash-can"></i> Alles l√∂schen
                </button>
            </div>
        </div>

    </main>

    <div class="fab" onclick="openEditModal(null)">
        <i class="fa-solid fa-plus"></i>
    </div>

    <nav class="bottom-nav">
        <a class="nav-item active" onclick="switchTab('home')">
            <i class="fa-solid fa-table-list"></i>
            <span>Plan</span>
        </a>
        <a class="nav-item" onclick="switchTab('team')">
            <i class="fa-solid fa-users-gear"></i>
            <span>Team</span>
        </a>
        <a class="nav-item" onclick="switchTab('wizard')">
            <i class="fa-solid fa-wand-magic"></i>
            <span>Wizard</span>
        </a>
        <a class="nav-item" onclick="switchTab('settings')">
            <i class="fa-solid fa-sliders"></i>
            <span>Tools</span>
        </a>
    </nav>

    <div id="modalEdit" class="modal-overlay">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; margin-bottom: 20px;">
                <h2 style="margin:0;">Eintrag bearbeiten</h2>
                <button onclick="closeModals()" style="background:none; border:none; font-size:1.5rem;">&times;</button>
            </div>
            
            <input type="hidden" id="editId">
            
            <label>Datum</label>
            <input type="text" id="editDate" placeholder="TT.MM.">
            
            <label>Uhrzeit</label>
            <select id="editTime">
                <option value="17:00 - 18:30">Fr√ºh (17:00 - 18:30)</option>
                <option value="18:15 - 19:45">Sp√§t (18:15 - 19:45)</option>
            </select>

            <label>Personal (Auswahl)</label>
            <div id="modalMemberSelect" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                </div>

            <div class="btn-group">
                <button class="btn btn-danger" onclick="deleteCurrentEntry()" id="btnDeleteEntry">L√∂schen</button>
                <button class="btn btn-primary" onclick="saveEntry()">Speichern</button>
            </div>
        </div>
    </div>

    <div id="modalMember" class="modal-overlay">
        <div class="modal">
            <h2 style="margin-top:0;">Mitglied verwalten</h2>
            <input type="hidden" id="memId">
            
            <label>Name</label>
            <input type="text" id="memName">
            
            <label>Rolle</label>
            <select id="memRole">
                <option value="fixed">Stammspieler (Immer dabei)</option>
                <option value="springer" selected>Springer (Rotation)</option>
                <option value="notfall">Notfall (Nur wenn n√∂tig)</option>
            </select>
            
            <label>Bevorzugte Zeit</label>
            <select id="memShift">
                <option value="both">Egal (Beides)</option>
                <option value="early">Nur Fr√ºh (17:00)</option>
                <option value="late">Nur Sp√§t (18:15)</option>
            </select>

            <button class="btn btn-primary" onclick="saveMember()" style="margin-top: 20px;">Speichern</button>
        </div>
    </div>

    <script>
        /* --- STATE MANAGEMENT --- */
        const APP_KEY = 'gittertier_ultimate_v1';
        let state = {
            schedule: [],
            team: [
                { id: 1, name: 'Kaspar', role: 'fixed', shift: 'both' },
                { id: 2, name: 'Uwe', role: 'springer', shift: 'late' },
                { id: 3, name: 'Nico', role: 'springer', shift: 'both' },
                { id: 4, name: 'Dmitry', role: 'springer', shift: 'both' },
                { id: 5, name: 'Gento', role: 'springer', shift: 'early' },
                { id: 6, name: 'Stephan', role: 'springer', shift: 'early' },
                { id: 7, name: 'Bastian', role: 'notfall', shift: 'both' }
            ]
        };

        // Load Data
        const stored = localStorage.getItem(APP_KEY);
        if(stored) state = JSON.parse(stored);

        /* --- INIT --- */
        document.addEventListener('DOMContentLoaded', () => {
            renderPlan();
            renderStats();
            renderTeam();
            // Set Default Generator Date to next Friday
            document.getElementById('genDate').valueAsDate = getNextDayOfWeek(new Date(), 5);
        });

        function saveState() {
            localStorage.setItem(APP_KEY, JSON.stringify(state));
            renderPlan();
            renderStats();
        }

        /* --- NAVIGATION --- */
        function switchTab(tabId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + tabId).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Toggle FAB visibility
            const fab = document.querySelector('.fab');
            if(tabId === 'home') fab.classList.remove('hidden');
            else fab.classList.add('hidden');
        }

        /* --- RENDERING --- */
        function renderPlan() {
            const container = document.getElementById('planList');
            container.innerHTML = '';
            
            if(state.schedule.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                return;
            }
            document.getElementById('emptyState').style.display = 'none';

            // Sort logic could go here
            
            state.schedule.forEach((entry, idx) => {
                const div = document.createElement('div');
                div.className = 'schedule-row';
                div.onclick = () => openEditModal(idx);
                
                // Alert icon if count < 2
                const namesCount = entry.names.length;
                const alertHtml = namesCount < 2 ? `<i class="fa-solid fa-triangle-exclamation" style="color:var(--color-warning); margin-right:5px;"></i>` : '';

                let namesHtml = entry.names.map(n => `<span class="name-tag">${n}</span>`).join('');

                div.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <div class="row-date">${entry.date}</div>
                        <div class="row-time">${entry.time.split(' ')[0]}</div>
                    </div>
                    <div class="row-names">
                        ${alertHtml}
                        ${namesHtml}
                    </div>
                    <i class="fa-solid fa-chevron-right" style="color:#ddd; font-size: 0.8rem;"></i>
                `;
                container.appendChild(div);
            });
        }

        function renderStats() {
            const container = document.getElementById('statsContainer');
            container.innerHTML = '';
            
            // Count assignments
            const counts = {};
            state.team.forEach(m => counts[m.name] = 0);
            
            let max = 0;
            state.schedule.forEach(row => {
                row.names.forEach(n => {
                    if(counts[n] !== undefined) counts[n]++;
                    else counts[n] = 1; // F√ºr manuelle Namen
                });
            });
            
            Object.values(counts).forEach(c => { if(c > max) max = c; });

            // Sort by count descending
            const sortedNames = Object.keys(counts).sort((a,b) => counts[b] - counts[a]);

            sortedNames.forEach(name => {
                if(counts[name] === 0 && !state.team.find(t=>t.name===name)) return; // Skip unused non-team members

                const percent = max > 0 ? (counts[name] / max) * 100 : 0;
                const row = document.createElement('div');
                row.innerHTML = `
                    <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:2px;">
                        <span>${name}</span>
                        <strong>${counts[name]}x</strong>
                    </div>
                    <div class="stat-bar-container">
                        <div class="stat-bar" style="width:${percent}%"></div>
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function renderTeam() {
            const container = document.getElementById('teamListContainer');
            container.innerHTML = '';
            
            state.team.forEach(m => {
                const div = document.createElement('div');
                div.className = 'team-item';
                
                let roleLabel = '';
                if(m.role === 'fixed') roleLabel = '<span class="role-badge role-fixed">Stamm</span>';
                if(m.role === 'springer') roleLabel = '<span class="role-badge role-springer">Springer</span>';
                if(m.role === 'notfall') roleLabel = '<span class="role-badge role-notfall">Notfall</span>';

                let shiftIcon = '';
                if(m.shift === 'early') shiftIcon = '<i class="fa-regular fa-sun" title="Fr√ºh"></i>';
                if(m.shift === 'late') shiftIcon = '<i class="fa-solid fa-moon" title="Sp√§t"></i>';
                if(m.shift === 'both') shiftIcon = '<i class="fa-solid fa-arrows-left-right" title="Beides"></i>';

                div.innerHTML = `
                    <div>
                        <strong>${m.name}</strong>
                        ${roleLabel}
                    </div>
                    <div style="color:#666; display:flex; gap:15px; align-items:center;">
                        ${shiftIcon}
                        <button onclick="editMember(${m.id})" style="border:none; background:none; color:var(--color-accent); font-size:1rem;"><i class="fa-solid fa-pen"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        /* --- MODALS --- */
        function closeModals() {
            document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('open'));
        }

        function openEditModal(index) {
            const modal = document.getElementById('modalEdit');
            const container = document.getElementById('modalMemberSelect');
            container.innerHTML = '';
            
            let currentNames = [];
            
            if(index !== null) {
                // Edit existing
                const entry = state.schedule[index];
                document.getElementById('editId').value = index;
                document.getElementById('editDate').value = entry.date;
                document.getElementById('editTime').value = entry.time;
                document.getElementById('btnDeleteEntry').style.display = 'block';
                currentNames = entry.names;
            } else {
                // New
                document.getElementById('editId').value = 'new';
                document.getElementById('editDate').value = '';
                document.getElementById('btnDeleteEntry').style.display = 'none';
            }

            // Create Checkboxes for Team
            state.team.forEach(m => {
                const isChecked = currentNames.includes(m.name) ? 'checked' : '';
                const label = document.createElement('label');
                label.style.display = 'flex'; label.style.alignItems = 'center'; label.style.gap = '8px';
                label.innerHTML = `<input type="checkbox" value="${m.name}" ${isChecked} class="chk-member"> ${m.name}`;
                container.appendChild(label);
            });

            modal.classList.add('open');
        }

        function saveEntry() {
            const index = document.getElementById('editId').value;
            const date = document.getElementById('editDate').value;
            const time = document.getElementById('editTime').value;
            
            // Get checked names
            const selected = [];
            document.querySelectorAll('.chk-member:checked').forEach(c => selected.push(c.value));

            if(!date) return alert("Datum fehlt");

            const entry = { date, time, names: selected };

            if(index === 'new') {
                state.schedule.push(entry);
            } else {
                state.schedule[parseInt(index)] = entry;
            }
            
            saveState();
            closeModals();
        }

        function deleteCurrentEntry() {
            const index = document.getElementById('editId').value;
            if(index !== 'new' && confirm("Eintrag l√∂schen?")) {
                state.schedule.splice(parseInt(index), 1);
                saveState();
                closeModals();
            }
        }

        /* --- MEMBER MANAGEMENT --- */
        function openMemberModal() {
            document.getElementById('memId').value = 'new';
            document.getElementById('memName').value = '';
            document.getElementById('modalMember').classList.add('open');
        }
        
        function editMember(id) {
            const m = state.team.find(x => x.id === id);
            document.getElementById('memId').value = id;
            document.getElementById('memName').value = m.name;
            document.getElementById('memRole').value = m.role;
            document.getElementById('memShift').value = m.shift;
            document.getElementById('modalMember').classList.add('open');
        }

        function saveMember() {
            const id = document.getElementById('memId').value;
            const name = document.getElementById('memName').value;
            const role = document.getElementById('memRole').value;
            const shift = document.getElementById('memShift').value;

            if(!name) return;

            if(id === 'new') {
                state.team.push({ id: Date.now(), name, role, shift });
            } else {
                const idx = state.team.findIndex(x => x.id == id);
                state.team[idx] = { ...state.team[idx], name, role, shift };
            }
            saveState();
            renderTeam();
            closeModals();
        }

        /* --- THE SMART GENERATOR v2 --- */
        function runGeneratorWizard() {
            const weeks = parseInt(document.getElementById('genDuration').value);
            let currentDate = document.getElementById('genDate').valueAsDate;
            if(!currentDate) return alert("Datum fehlt");

            if(state.schedule.length > 0 && !confirm("Bestehenden Plan √ºberschreiben?")) return;
            
            const newSchedule = [];
            
            // Stats tracker for fairness in this run
            let shiftCounts = {};
            state.team.forEach(t => shiftCounts[t.name] = 0);

            for(let i=0; i<weeks; i++) {
                const dateStr = formatDate(currentDate);
                
                // --- SLOT 1: EARLY (17:00) ---
                let earlyWorkers = getWorkersForSlot('early', [], shiftCounts);
                
                // Update counts
                earlyWorkers.forEach(w => shiftCounts[w]++);

                newSchedule.push({
                    date: dateStr,
                    time: "17:00 - 18:30",
                    names: earlyWorkers
                });

                // --- SLOT 2: LATE (18:15) ---
                // Doppelschicht-Logik: Check if any early worker WANTS to work late too
                let potentialDoubleShifters = earlyWorkers.filter(name => {
                    const member = state.team.find(t => t.name === name);
                    // If member exists and accepts 'late' or 'both'
                    return member && (member.shift === 'both' || member.shift === 'late');
                });
                
                let lateWorkers = getWorkersForSlot('late', potentialDoubleShifters, shiftCounts);
                lateWorkers.forEach(w => shiftCounts[w]++);

                newSchedule.push({
                    date: dateStr,
                    time: "18:15 - 19:45",
                    names: lateWorkers
                });

                // Next Week
                currentDate.setDate(currentDate.getDate() + 7);
            }

            state.schedule = newSchedule;
            saveState();
            switchTab('home');
            alert("Plan erfolgreich generiert!");
        }

        function getWorkersForSlot(slotType, preferredCandidates, currentCounts) {
            let assigned = [];
            
            // 1. Force preferred candidates (Doppelschichtler) if they fit the slot
            // Actually, we should treat them as "Fixed" for this moment logic
            
            // 2. Add FIXED roles valid for this slot
            const fixed = state.team.filter(m => m.role === 'fixed' && (m.shift === 'both' || m.shift === slotType));
            fixed.forEach(m => {
                if(!assigned.includes(m.name)) assigned.push(m.name);
            });

            // 3. If slot needs more people (Target: 3)
            // Priority: PreferredCandidates (Double shift) > Springer (Rotation) > Notfall
            
            // Add Preferred Candidates first (if not already Fixed)
            preferredCandidates.forEach(name => {
                if(assigned.length < 3 && !assigned.includes(name)) {
                    assigned.push(name);
                }
            });

            // Add Springers (Fair Rotation)
            const springers = state.team.filter(m => 
                m.role === 'springer' && 
                (m.shift === 'both' || m.shift === slotType) &&
                !assigned.includes(m.name)
            );

            // Sort by usage count (ascending) + Random
            springers.sort((a,b) => (currentCounts[a.name] - currentCounts[b.name]) || (0.5 - Math.random()));

            for(let s of springers) {
                if(assigned.length >= 3) break;
                assigned.push(s.name);
            }

            // 4. Emergency Fallback
            if(assigned.length < 2) {
                const notfall = state.team.filter(m => m.role === 'notfall');
                notfall.forEach(n => {
                    if(assigned.length < 3 && !assigned.includes(n.name)) assigned.push(n.name);
                });
            }

            return assigned;
        }

        /* --- SMART CSV IMPORT --- */
        function processSmartCSV() {
            const txt = document.getElementById('csvInputSmart').value;
            const lines = txt.split('\n');
            let addedCount = 0;

            lines.forEach(line => {
                // Heuristic Parsing: Search for Date pattern
                const dateMatch = line.match(/(\d{1,2}\.\d{2}\.?)/);
                if(dateMatch) {
                    const date = dateMatch[1];
                    // Remove date from line to find names
                    let rest = line.replace(date, '');
                    
                    // Simple name extraction: split by common separators
                    let potentialNames = rest.split(/[,;&+]/).map(s => s.trim()).filter(s => s.length > 2);
                    
                    // Filter names that look like time (e.g. 17:00)
                    potentialNames = potentialNames.filter(n => !n.match(/\d:\d/));

                    // Auto-Add unknown people to Team
                    potentialNames.forEach(name => {
                        const exists = state.team.find(t => t.name.toLowerCase() === name.toLowerCase());
                        if(!exists) {
                            state.team.push({ id: Date.now() + Math.random(), name: name, role: 'springer', shift: 'both' });
                        }
                    });

                    // Add to schedule
                    // Guess time based on line position or previous entry? 
                    // Fallback: Default to Early if not specified, user can edit.
                    // Or check if "Sp√§t" or "18" is in text.
                    let time = "17:00 - 18:30";
                    if(line.includes("18:15") || line.includes("Sp√§t")) time = "18:15 - 19:45";

                    state.schedule.push({ date, time, names: potentialNames });
                    addedCount++;
                }
            });

            saveState();
            document.getElementById('csvInputSmart').value = '';
            alert(`${addedCount} Eintr√§ge importiert & Team aktualisiert.`);
            switchTab('home');
        }

        /* --- EXPORT TOOLS --- */
        function shareWhatsApp() {
            let text = "*Einsatzplan SC Brombach*\n\n";
            state.schedule.forEach(e => {
                text += `üìÖ ${e.date} (${e.time})\nüë§ ${e.names.join(', ')}\n\n`;
            });
            const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        function exportICal() {
            let icsContent = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//SCB//Planer//DE\n";
            const year = new Date().getFullYear(); // Assumption
            
            state.schedule.forEach(e => {
                const [d, m] = e.date.split('.');
                const [hStart, mStart] = e.time.split(' - ')[0].split(':');
                const [hEnd, mEnd] = e.time.split(' - ')[1].split(':');
                
                // Simple ISO string creation (Requires correct Year handling in real app)
                const startStr = `${year}${m}${d}T${hStart}${mStart}00`;
                const endStr = `${year}${m}${d}T${hEnd}${mEnd}00`;
                
                icsContent += "BEGIN:VEVENT\n";
                icsContent += `SUMMARY:Jugendtraining (${e.names.join(', ')})\n`;
                icsContent += `DTSTART:${startStr}\n`;
                icsContent += `DTEND:${endStr}\n`;
                icsContent += "DESCRIPTION:Einsatz SC Brombach\n";
                icsContent += "END:VEVENT\n";
            });
            icsContent += "END:VCALENDAR";
            
            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "training.ics";
            link.click();
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.text("Einsatzplan Jugend", 14, 25);
            
            const body = state.schedule.map(r => [r.date, r.time, r.names.join(', ')]);
            
            doc.autoTable({
                startY: 50,
                head: [['Datum', 'Uhrzeit', 'Team']],
                body: body,
                theme: 'grid',
                styles: { fontSize: 11, cellPadding: 6 },
                headStyles: { fillColor: [30, 58, 138] }
            });
            
            doc.save("Plan_SCB.pdf");
        }

        function exportBackup() {
            const blob = new Blob([JSON.stringify(state)], {type: 'application/json'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `backup_scb_${Date.now()}.json`;
            link.click();
        }

        function importBackup(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    state = JSON.parse(e.target.result);
                    saveState();
                    alert("Backup wiederhergestellt!");
                    location.reload();
                } catch(err) { alert("Fehlerhafte Datei"); }
            };
            reader.readAsText(file);
        }

        function hardReset() {
            if(confirm("ACHTUNG: Alle Daten werden unwiderruflich gel√∂scht.")) {
                localStorage.removeItem(APP_KEY);
                location.reload();
            }
        }

        // Helper
        function getNextDayOfWeek(date, dayOfWeek) {
            const resultDate = new Date(date.getTime());
            resultDate.setDate(date.getDate() + (7 + dayOfWeek - date.getDay()) % 7);
            return resultDate;
        }
        function formatDate(date) {
            let d = date.getDate();
            let m = date.getMonth() + 1;
            return (d < 10 ? '0'+d : d) + '.' + (m < 10 ? '0'+m : m) + '.';
        }

    </script>
</body>
</html>
