<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Einsatzplaner Ultimate - SC Brombach</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <style>
        /* --- Gittertier Pro Design System --- */
        :root {
            --color-bg: #f9fafb;
            --color-surface: #ffffff;
            --color-text: #111827;
            --color-text-muted: #6b7280;
            --color-border: #e5e7eb;
            
            /* SC Brombach Branding */
            --color-primary: #1e3a8a; 
            --color-primary-hover: #1e40af;
            --color-accent: #2563eb;
            --color-accent-light: #eff6ff;
            
            --color-success: #059669;
            --color-warning: #d97706;
            --color-danger: #dc2626;
            --color-danger-bg: #fef2f2;
            
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --header-height: 64px;
            --bottom-nav-height: 0px; /* Nur Mobile */
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --color-bg: #111827;
                --color-surface: #1f2937;
                --color-text: #f9fafb;
                --color-text-muted: #9ca3af;
                --color-border: #374151;
                --color-accent-light: #1e3a8a;
            }
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 0;
            padding-bottom: var(--bottom-nav-height);
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        /* --- Header --- */
        header {
            height: var(--header-height);
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: var(--shadow-sm);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: var(--color-text);
            font-weight: 700;
            font-size: 1.25rem;
        }
        .brand img { height: 40px; width: auto; }
        .brand span { background: linear-gradient(135deg, var(--color-primary), var(--color-accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .header-actions { display: flex; gap: 1rem; }

        /* --- Main Layout --- */
        main {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
            display: grid;
            grid-template-columns: 280px 1fr; /* Sidebar + Content */
            gap: 2rem;
            min-height: calc(100vh - var(--header-height) - 4rem);
        }

        /* --- Sidebar Navigation --- */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            position: sticky;
            top: calc(var(--header-height) + 2rem);
            height: fit-content;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            color: var(--color-text-muted);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .nav-item:hover { background-color: var(--color-bg); color: var(--color-text); }
        .nav-item.active { background-color: var(--color-accent-light); color: var(--color-accent); font-weight: 600; }
        .nav-item i { width: 20px; text-align: center; }

        /* --- Content Area --- */
        .content-area {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .view-section { display: none; }
        .view-section.active { display: block; }

        /* --- Cards --- */
        .card {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover { box-shadow: var(--shadow-lg); }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .card-title { font-size: 1.25rem; font-weight: 700; color: var(--color-text); display: flex; align-items: center; gap: 10px; }
        .card-subtitle { font-size: 0.875rem; color: var(--color-text-muted); margin-top: 4px; }

        /* --- Table Modern --- */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
        }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        thead { background-color: var(--color-bg); border-bottom: 1px solid var(--color-border); }
        th { padding: 16px; text-align: left; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--color-text-muted); font-weight: 600; }
        td { padding: 16px; border-bottom: 1px solid var(--color-border); vertical-align: middle; font-size: 0.95rem; }
        tr:last-child td { border-bottom: none; }
        tbody tr { transition: background-color 0.1s; cursor: pointer; }
        tbody tr:hover { background-color: var(--color-bg); }

        /* --- Badges --- */
        .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 99px; font-size: 0.75rem; font-weight: 600; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-green { background: #d1fae5; color: #065f46; }
        .badge-yellow { background: #fef3c7; color: #92400e; }
        .badge-red { background: #fee2e2; color: #991b1b; }

        /* --- Buttons --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .btn-primary { background: var(--color-primary); color: white; box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3); }
        .btn-primary:hover { background: var(--color-primary-hover); transform: translateY(-1px); }
        .btn-secondary { background: var(--color-surface); border-color: var(--color-border); color: var(--color-text); }
        .btn-secondary:hover { background: var(--color-bg); border-color: var(--color-text-muted); }
        .btn-ghost { background: transparent; color: var(--color-text-muted); }
        .btn-ghost:hover { background: var(--color-bg); color: var(--color-text); }
        .btn-icon { padding: 8px; border-radius: 50%; width: 40px; height: 40px; }

        /* --- Floating Action Button (Mobile) --- */
        .fab {
            position: fixed; bottom: 20px; right: 20px;
            width: 56px; height: 56px;
            border-radius: 50%;
            background: var(--color-primary);
            color: white;
            display: none; /* Desktop hidden */
            align-items: center; justify-content: center;
            box-shadow: var(--shadow-xl);
            font-size: 1.5rem;
            z-index: 90;
            border: none;
        }

        /* --- Modals (The Core Interaction) --- */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        
        .modal {
            background: var(--color-surface);
            width: 90%; max-width: 600px;
            max-height: 90vh; overflow-y: auto;
            border-radius: var(--radius-lg);
            padding: 0;
            box-shadow: var(--shadow-xl);
            transform: scale(0.95); transition: transform 0.2s;
            display: flex; flex-direction: column;
        }
        .modal-overlay.open .modal { transform: scale(1); }
        
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 1.5rem; overflow-y: auto; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--color-border); background: var(--color-bg); display: flex; justify-content: flex-end; gap: 10px; }

        /* --- Form Elements --- */
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.9rem; color: var(--color-text-muted); }
        .form-control {
            width: 100%; padding: 12px;
            border: 1px solid var(--color-border); border-radius: var(--radius-sm);
            background: var(--color-surface); color: var(--color-text);
            font-size: 1rem; transition: border 0.2s;
        }
        .form-control:focus { outline: none; border-color: var(--color-accent); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); }

        /* --- Wizard Styles --- */
        .wizard-steps { display: flex; justify-content: space-between; margin-bottom: 2rem; position: relative; }
        .wizard-steps::before { content: ''; position: absolute; top: 15px; left: 0; right: 0; height: 2px; background: var(--color-border); z-index: 0; }
        .step { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; opacity: 0.6; }
        .step.active { opacity: 1; }
        .step-circle { width: 32px; height: 32px; border-radius: 50%; background: var(--color-surface); border: 2px solid var(--color-border); display: flex; align-items: center; justify-content: center; font-weight: bold; transition: 0.3s; }
        .step.active .step-circle { background: var(--color-primary); color: white; border-color: var(--color-primary); }
        .step.completed .step-circle { background: var(--color-success); border-color: var(--color-success); color: white; }

        /* --- Responsive Mobile --- */
        @media (max-width: 768px) {
            :root { --bottom-nav-height: 60px; }
            main { grid-template-columns: 1fr; margin: 1rem auto; gap: 1rem; }
            .sidebar { 
                position: fixed; bottom: 0; left: 0; right: 0; top: auto;
                background: var(--color-surface); height: var(--bottom-nav-height);
                flex-direction: row; justify-content: space-around; padding: 0;
                border-top: 1px solid var(--color-border); z-index: 99;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            }
            .nav-item { flex-direction: column; gap: 4px; font-size: 0.7rem; padding: 8px; flex: 1; justify-content: center; border-radius: 0; }
            .nav-item i { font-size: 1.2rem; }
            .nav-text { display: block; }
            header { padding: 0 1rem; }
            .fab { display: flex; }
            .hide-mobile { display: none; }
            .wizard-steps { font-size: 0.8rem; }
            .modal { width: 100%; height: 100%; max-height: 100%; border-radius: 0; }
        }
    </style>
</head>
<body>

    <header>
        <a href="#" class="brand">
            <img src="https://www.loerrach.de/ceasy/resource/3714" alt="SC Brombach">
            <span>Gittertier Pro</span>
        </a>
        <div class="header-actions">
            <button class="btn btn-ghost btn-icon" onclick="toggleTheme()"><i class="fa-solid fa-moon"></i></button>
            <button class="btn btn-primary hide-mobile" onclick="openWizard()"><i class="fa-solid fa-wand-magic-sparkles"></i> Neuer Plan</button>
        </div>
    </header>

    <main>
        <nav class="sidebar">
            <a onclick="switchView('dashboard')" class="nav-item active" id="nav-dashboard">
                <i class="fa-solid fa-chart-pie"></i> <span class="nav-text">√úbersicht</span>
            </a>
            <a onclick="switchView('plan')" class="nav-item" id="nav-plan">
                <i class="fa-solid fa-calendar-days"></i> <span class="nav-text">Einsatzplan</span>
            </a>
            <a onclick="switchView('team')" class="nav-item" id="nav-team">
                <i class="fa-solid fa-users"></i> <span class="nav-text">Team</span>
            </a>
            <a onclick="switchView('settings')" class="nav-item" id="nav-settings">
                <i class="fa-solid fa-gear"></i> <span class="nav-text">Optionen</span>
            </a>
        </nav>

        <div class="content-area">

            <div id="view-dashboard" class="view-section active">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Willkommen zur√ºck!</div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="background:var(--color-bg); padding:1rem; border-radius:var(--radius-sm);">
                            <div style="font-size:0.8rem; color:var(--color-text-muted);">Offene Termine</div>
                            <div style="font-size:2rem; font-weight:700;" id="stat-open">0</div>
                        </div>
                        <div style="background:var(--color-bg); padding:1rem; border-radius:var(--radius-sm);">
                            <div style="font-size:0.8rem; color:var(--color-text-muted);">Teamgr√∂√üe</div>
                            <div style="font-size:2rem; font-weight:700;" id="stat-team">0</div>
                        </div>
                        <div style="background:var(--color-bg); padding:1rem; border-radius:var(--radius-sm);">
                            <div style="font-size:0.8rem; color:var(--color-text-muted);">Eins√§tze diesen Monat</div>
                            <div style="font-size:2rem; font-weight:700; color:var(--color-primary);" id="stat-month">0</div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <div class="card-title"><i class="fa-solid fa-chart-simple"></i> Verteilung</div>
                    </div>
                    <div style="height: 250px;">
                        <canvas id="statsChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="view-plan" class="view-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><i class="fa-solid fa-calendar-check"></i> Aktueller Plan</div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary btn-icon" onclick="openPDFModal()"><i class="fa-solid fa-file-pdf"></i></button>
                            <button class="btn btn-secondary btn-icon" onclick="copyToWhatsApp()"><i class="fa-brands fa-whatsapp"></i></button>
                            <button class="btn btn-primary hide-mobile" onclick="openEditModal()"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem; display: flex; gap: 10px; flex-wrap: wrap;">
                        <input type="text" placeholder="Suchen..." class="form-control" style="width: auto; flex: 1;" onkeyup="filterTable(this.value)">
                        <button class="btn btn-secondary" onclick="openScanModal()"><i class="fa-solid fa-camera"></i> Foto-Scan</button>
                        <button class="btn btn-secondary" onclick="openCSVModal()"><i class="fa-solid fa-file-csv"></i> Import</button>
                    </div>

                    <div class="table-container">
                        <table id="planTable">
                            <thead>
                                <tr>
                                    <th>Datum</th>
                                    <th>Uhrzeit</th>
                                    <th>Team</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="planTableBody">
                                </tbody>
                        </table>
                    </div>
                    <div id="emptyPlan" style="text-align:center; padding:3rem; color:var(--color-text-muted); display:none;">
                        <i class="fa-solid fa-clipboard-list" style="font-size:3rem; opacity:0.3; margin-bottom:1rem;"></i>
                        <p>Noch keine Eintr√§ge vorhanden.</p>
                        <button class="btn btn-primary" style="margin-top:1rem;" onclick="openWizard()">Generator starten</button>
                    </div>
                </div>
            </div>

            <div id="view-team" class="view-section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title"><i class="fa-solid fa-users-gear"></i> Mannschaft</div>
                        <button class="btn btn-primary" onclick="openTeamModal()"><i class="fa-solid fa-user-plus"></i> Neu</button>
                    </div>
                    <div id="teamGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
                        </div>
                </div>
            </div>

            <div id="view-settings" class="view-section">
                <div class="card">
                    <div class="card-header"><div class="card-title">Einstellungen</div></div>
                    <div class="form-group">
                        <label>Vollst√§ndiger Reset</label>
                        <p style="font-size:0.8rem; color:var(--color-text-muted); margin-bottom:1rem;">L√∂scht alle Daten (Plan & Team).</p>
                        <button class="btn btn-danger" onclick="hardReset()">Alles L√∂schen</button>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <button class="fab" onclick="openEditModal()"><i class="fa-solid fa-plus"></i></button>

    <div id="modal-edit" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="card-title" id="modalTitle">Eintrag bearbeiten</h3>
                <button class="btn btn-ghost btn-icon" onclick="closeModal('modal-edit')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="inpId">
                <div class="form-group">
                    <label>Datum</label>
                    <input type="text" id="inpDate" class="form-control" placeholder="TT.MM.">
                </div>
                <div class="form-group">
                    <label>Schicht</label>
                    <select id="inpTime" class="form-control">
                        <option value="17:00 - 18:30">Fr√ºh (17:00 - 18:30)</option>
                        <option value="18:15 - 19:45">Sp√§t (18:15 - 19:45)</option>
                        <option value="custom">Benutzerdefiniert...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Personal</label>
                    <textarea id="inpNames" class="form-control" rows="3" placeholder="Namen eingeben..."></textarea>
                    <div style="margin-top:8px; display:flex; gap:5px; flex-wrap:wrap;" id="quickAddTags">
                        </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="btnDelete" onclick="deleteEntry()" style="margin-right:auto;">L√∂schen</button>
                <button class="btn btn-secondary" onclick="closeModal('modal-edit')">Abbrechen</button>
                <button class="btn btn-primary" onclick="saveEntry()">Speichern</button>
            </div>
        </div>
    </div>

    <div id="modal-wizard" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="card-title">ü§ñ Auto-Planer</h3>
                <button class="btn btn-ghost btn-icon" onclick="closeModal('modal-wizard')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <div class="wizard-steps">
                    <div class="step active" id="step1-indicator"><div class="step-circle">1</div><span>Zeit</span></div>
                    <div class="step" id="step2-indicator"><div class="step-circle">2</div><span>Team</span></div>
                    <div class="step" id="step3-indicator"><div class="step-circle">3</div><span>Fertig</span></div>
                </div>

                <div id="wiz-step1">
                    <div class="form-group">
                        <label>Startdatum (N√§chster Freitag)</label>
                        <input type="date" id="wizStart" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Zeitraum</label>
                        <select id="wizWeeks" class="form-control">
                            <option value="4">4 Wochen</option>
                            <option value="8" selected>8 Wochen</option>
                            <option value="12">12 Wochen</option>
                        </select>
                    </div>
                    <div style="background:var(--color-accent-light); padding:1rem; border-radius:8px; font-size:0.9rem;">
                        <i class="fa-solid fa-lightbulb" style="color:var(--color-accent);"></i> 
                        Der Algorithmus bevorzugt Personen, die "Immer" dabei sein wollen, f√ºllt mit "Rotation" auf und nutzt "Notfall" nur wenn n√∂tig. 
                        Doppelschichten werden erkannt!
                    </div>
                </div>

                <div id="wiz-step2" style="display:none;">
                    <p style="margin-bottom:10px;">Bitte Verf√ºgbarkeiten pr√ºfen:</p>
                    <div id="wizTeamList" style="max-height:300px; overflow-y:auto; border:1px solid var(--color-border); border-radius:8px;"></div>
                </div>

                <div id="wiz-step3" style="display:none; text-align:center; padding:2rem;">
                    <i class="fa-solid fa-check-circle" style="font-size:4rem; color:var(--color-success); margin-bottom:1rem;"></i>
                    <h3>Plan erfolgreich erstellt!</h3>
                    <p>Du kannst die Termine nun manuell feinjustieren.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="wiz-prev" onclick="wizPrev()" style="display:none;">Zur√ºck</button>
                <button class="btn btn-primary" id="wiz-next" onclick="wizNext()">Weiter</button>
            </div>
        </div>
    </div>

    <div id="modal-team" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Person verwalten</h3>
                <button class="btn btn-ghost btn-icon" onclick="closeModal('modal-team')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="tmId">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="tmName" class="form-control">
                </div>
                <div class="form-group">
                    <label>Rolle</label>
                    <select id="tmRole" class="form-control">
                        <option value="fixed">‚≠ê Stammspieler (Immer eingeplant)</option>
                        <option value="rotate">üîÑ Rotation (Regelm√§√üiger Wechsel)</option>
                        <option value="emergency">üö® Notfall (Nur wenn n√∂tig)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Bevorzugte Zeit</label>
                    <select id="tmPref" class="form-control">
                        <option value="both">Egal (Beides m√∂glich)</option>
                        <option value="early">Nur Fr√ºh (17:00)</option>
                        <option value="late">Nur Sp√§t (18:15)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteTeamMember()" id="btnTmDelete">L√∂schen</button>
                <button class="btn btn-primary" onclick="saveTeamMember()">Speichern</button>
            </div>
        </div>
    </div>

    <div id="modal-pdf" class="modal-overlay">
        <div class="modal">
            <div class="modal-header"><h3>PDF Export</h3><button class="btn btn-ghost btn-icon" onclick="closeModal('modal-pdf')">x</button></div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Design w√§hlen</label>
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
                        <div onclick="setPdfStyle('standard')" class="pdf-opt selected" style="border:2px solid var(--color-primary); padding:10px; border-radius:8px; cursor:pointer; text-align:center;">
                            <i class="fa-solid fa-table" style="font-size:1.5rem; color:var(--color-primary);"></i><br>Standard
                        </div>
                        <div onclick="setPdfStyle('chess')" class="pdf-opt" style="border:1px solid var(--color-border); padding:10px; border-radius:8px; cursor:pointer; text-align:center;">
                            <i class="fa-solid fa-chess-knight" style="font-size:1.5rem;"></i><br>Schach
                        </div>
                        <div onclick="setPdfStyle('minimal')" class="pdf-opt" style="border:1px solid var(--color-border); padding:10px; border-radius:8px; cursor:pointer; text-align:center;">
                            <i class="fa-solid fa-align-left" style="font-size:1.5rem;"></i><br>Minimal
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" style="width:100%" onclick="generatePDF()">Herunterladen</button>
            </div>
        </div>
    </div>

    <div id="modal-scan" class="modal-overlay">
        <div class="modal">
            <div class="modal-header"><h3>Bilderkennung (WhatsApp)</h3><button class="btn btn-ghost btn-icon" onclick="closeModal('modal-scan')">x</button></div>
            <div class="modal-body" style="text-align:center;">
                <input type="file" id="scanInput" accept="image/*" class="form-control" onchange="runOCR(this)">
                <div id="scanStatus" style="margin-top:1rem; color:var(--color-text-muted);">Lade Screenshot hoch...</div>
            </div>
        </div>
    </div>

    <div id="modal-csv" class="modal-overlay">
        <div class="modal">
            <div class="modal-header"><h3>CSV Import</h3><button class="btn btn-ghost btn-icon" onclick="closeModal('modal-csv')">x</button></div>
            <div class="modal-body">
                <textarea id="csvText" class="form-control" rows="5" placeholder="Datum; Zeit; Namen"></textarea>
                <div style="margin-top:5px; font-size:0.8rem; color:var(--color-success);">
                    <i class="fa-solid fa-magic"></i> Auto-Verschlaubisierung aktiv (Namen werden korrigiert)
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="runCSVImport()">Importieren</button></div>
        </div>
    </div>

    <script>
        /* --- 1. STATE MANAGEMENT --- */
        const Store = {
            plan: JSON.parse(localStorage.getItem('gp_plan')) || [],
            team: JSON.parse(localStorage.getItem('gp_team')) || [
                { id: 1, name: 'Kaspar', role: 'fixed', pref: 'both' },
                { id: 2, name: 'Uwe', role: 'rotate', pref: 'late' },
                { id: 3, name: 'Nico', role: 'rotate', pref: 'both' },
                { id: 4, name: 'Dmitry', role: 'rotate', pref: 'both' },
                { id: 5, name: 'Gento', role: 'rotate', pref: 'early' },
                { id: 6, name: 'Stephan', role: 'rotate', pref: 'early' },
                { id: 99, name: 'Springer', role: 'emergency', pref: 'both' }
            ],
            currentPdfStyle: 'standard',
            
            save() {
                localStorage.setItem('gp_plan', JSON.stringify(this.plan));
                localStorage.setItem('gp_team', JSON.stringify(this.team));
                updateUI();
            }
        };

        /* --- 2. UI UPDATE LOGIC --- */
        function init() {
            updateUI();
            updateStats();
            setupCharts();
            // Dark Mode check
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-theme'); // Simple toggle logic below
            }
        }

        function updateUI() {
            // Render Plan
            const tbody = document.getElementById('planTableBody');
            tbody.innerHTML = '';
            
            if(Store.plan.length === 0) {
                document.getElementById('emptyPlan').style.display = 'block';
                document.getElementById('planTable').style.display = 'none';
            } else {
                document.getElementById('emptyPlan').style.display = 'none';
                document.getElementById('planTable').style.display = 'table';
                
                // Sort date logic could be improved, currently string based
                Store.plan.forEach((entry, idx) => {
                    const tr = document.createElement('tr');
                    tr.onclick = () => openEditModal(idx);
                    
                    // Status Badge logic
                    let badgeClass = 'badge-blue';
                    let statusText = entry.names.split(',').length + ' Pers.';
                    if(entry.names.includes('Springer')) badgeClass = 'badge-red';
                    
                    tr.innerHTML = `
                        <td><strong>${entry.date}</strong></td>
                        <td>${entry.time}</td>
                        <td>${entry.names}</td>
                        <td><span class="badge ${badgeClass}">${statusText}</span></td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            // Render Team Grid
            const tGrid = document.getElementById('teamGrid');
            tGrid.innerHTML = '';
            Store.team.forEach((member) => {
                let icon = 'fa-user';
                let color = 'var(--color-text-muted)';
                if(member.role === 'fixed') { icon = 'fa-star'; color = '#d97706'; }
                if(member.role === 'emergency') { icon = 'fa-kit-medical'; color = '#dc2626'; }
                
                const card = document.createElement('div');
                card.className = 'card';
                card.style.padding = '1rem';
                card.style.cursor = 'pointer';
                card.onclick = () => openTeamModal(member.id);
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="font-weight:bold; font-size:1.1rem;">${member.name}</div>
                        <i class="fa-solid ${icon}" style="color:${color}"></i>
                    </div>
                    <div style="font-size:0.8rem; color:var(--color-text-muted); margin-top:5px;">
                        ${member.role === 'fixed' ? 'Stamm' : (member.role === 'rotate' ? 'Rotation' : 'Notfall')} | ${member.pref}
                    </div>
                `;
                tGrid.appendChild(card);
            });

            // Update Dashboard Counters
            document.getElementById('stat-open').innerText = Store.plan.length;
            document.getElementById('stat-team').innerText = Store.team.length;
            document.getElementById('stat-month').innerText = Store.plan.length * 3; // Fake calc
        }

        /* --- 3. WIZARD & SMART GENERATOR --- */
        let wizCurrentStep = 1;
        
        function openWizard() {
            wizCurrentStep = 1;
            updateWizUI();
            openModal('modal-wizard');
            // Set Default Date
            const d = new Date();
            d.setDate(d.getDate() + (5 + 7 - d.getDay()) % 7); // Next Friday
            document.getElementById('wizStart').valueAsDate = d;
        }

        function updateWizUI() {
            document.getElementById('wiz-step1').style.display = wizCurrentStep === 1 ? 'block' : 'none';
            document.getElementById('wiz-step2').style.display = wizCurrentStep === 2 ? 'block' : 'none';
            document.getElementById('wiz-step3').style.display = wizCurrentStep === 3 ? 'block' : 'none';
            
            document.getElementById('wiz-prev').style.display = wizCurrentStep > 1 ? 'inline-block' : 'none';
            document.getElementById('wiz-next').innerText = wizCurrentStep === 3 ? 'Schlie√üen' : (wizCurrentStep === 2 ? 'Generieren' : 'Weiter');
            
            document.querySelectorAll('.step').forEach((el, idx) => {
                el.classList.remove('active', 'completed');
                if(idx + 1 === wizCurrentStep) el.classList.add('active');
                if(idx + 1 < wizCurrentStep) el.classList.add('completed');
            });
        }

        function wizNext() {
            if(wizCurrentStep === 1) {
                // Render Team Preview
                const list = document.getElementById('wizTeamList');
                list.innerHTML = Store.team.map(m => `
                    <div style="padding:8px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                        <span>${m.name}</span>
                        <span class="badge ${m.role==='fixed'?'badge-yellow':'badge-blue'}">${m.role}</span>
                    </div>
                `).join('');
                wizCurrentStep = 2;
            } else if (wizCurrentStep === 2) {
                runSmartGenerator();
                wizCurrentStep = 3;
            } else {
                closeModal('modal-wizard');
                switchView('plan');
            }
            updateWizUI();
        }
        
        function wizPrev() {
            wizCurrentStep--;
            updateWizUI();
        }

        function runSmartGenerator() {
            const weeks = parseInt(document.getElementById('wizWeeks').value);
            let date = document.getElementById('wizStart').valueAsDate;
            if(!date) date = new Date();

            const newPlan = [];
            // Map team by ID for faster lookups
            const fixed = Store.team.filter(t => t.role === 'fixed');
            const rotate = Store.team.filter(t => t.role === 'rotate');
            const emergency = Store.team.filter(t => t.role === 'emergency');

            // Usage counters for fairness
            const usage = {};
            Store.team.forEach(t => usage[t.id] = 0);

            for(let i=0; i<weeks; i++) {
                const dateStr = date.toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit'});
                
                // Slots definitions
                const shifts = [
                    { time: "17:00 - 18:30", type: "early" },
                    { time: "18:15 - 19:45", type: "late" }
                ];

                let assignedToday = []; // Track IDs assigned today

                shifts.forEach(shift => {
                    let slotTeam = [];

                    // 1. Add Fixed Players capable of this shift
                    fixed.forEach(p => {
                        if(p.pref === 'both' || p.pref === shift.type) {
                            slotTeam.push(p);
                            usage[p.id]++;
                            assignedToday.push(p.id);
                        }
                    });

                    // 2. The "Sticky" Logic:
                    // If someone from "rotate" was assigned to early shift today, 
                    // and they are capable of 'late' (or 'both'), 
                    // PREFER them for late shift to save travel, IF needed.
                    // (Simplified implementation: Check assignedToday)
                    // ... 

                    // 3. Fill with Rotate players (Fairness sort)
                    let candidates = rotate.filter(p => 
                        (p.pref === 'both' || p.pref === shift.type) && 
                        !slotTeam.includes(p) &&
                        (!assignedToday.includes(p.id) || p.pref === 'both') // Allow double shift if both
                    );
                    
                    // Sort by least usage + random factor
                    candidates.sort((a,b) => (usage[a.id] - usage[b.id]) || (0.5 - Math.random()));

                    while(slotTeam.length < 3 && candidates.length > 0) {
                        const p = candidates.shift();
                        slotTeam.push(p);
                        usage[p.id]++;
                        assignedToday.push(p.id);
                    }

                    // 4. Emergency Fallback
                    if(slotTeam.length < 2 && emergency.length > 0) {
                        slotTeam.push(emergency[0]);
                    }

                    newPlan.push({
                        date: dateStr,
                        time: shift.time,
                        names: slotTeam.map(p => p.name).join(', ')
                    });
                });

                date.setDate(date.getDate() + 7);
            }

            // Append or Replace? Let's Append.
            Store.plan = [...Store.plan, ...newPlan];
            Store.save();
        }

        /* --- 4. CRUD OPERATIONS --- */
        let editingIndex = -1;

        function openEditModal(idx = -1) {
            editingIndex = idx;
            document.getElementById('modalTitle').innerText = idx === -1 ? 'Neuer Eintrag' : 'Bearbeiten';
            document.getElementById('btnDelete').style.display = idx === -1 ? 'none' : 'block';
            
            if(idx > -1) {
                const entry = Store.plan[idx];
                document.getElementById('inpDate').value = entry.date;
                document.getElementById('inpTime').value = entry.time; // Might need handling for custom values
                document.getElementById('inpNames').value = entry.names;
            } else {
                document.getElementById('inpDate').value = '';
                document.getElementById('inpNames').value = '';
            }
            
            // Generate Quick Tags
            const tags = document.getElementById('quickAddTags');
            tags.innerHTML = Store.team.map(t => 
                `<span class="badge badge-blue" style="cursor:pointer;" onclick="addNameToInput('${t.name}')">+ ${t.name}</span>`
            ).join('');

            openModal('modal-edit');
        }

        function addNameToInput(name) {
            const field = document.getElementById('inpNames');
            let val = field.value;
            if(val) val += ', ';
            field.value = val + name;
        }

        function saveEntry() {
            const entry = {
                date: document.getElementById('inpDate').value,
                time: document.getElementById('inpTime').value,
                names: document.getElementById('inpNames').value
            };
            
            if(editingIndex > -1) Store.plan[editingIndex] = entry;
            else Store.plan.push(entry);
            
            Store.save();
            closeModal('modal-edit');
        }

        function deleteEntry() {
            if(editingIndex > -1) {
                Store.plan.splice(editingIndex, 1);
                Store.save();
                closeModal('modal-edit');
            }
        }

        // Team CRUD
        function openTeamModal(id = null) {
            const modal = document.getElementById('modal-team');
            if(id) {
                const member = Store.team.find(t => t.id === id);
                document.getElementById('tmId').value = member.id;
                document.getElementById('tmName').value = member.name;
                document.getElementById('tmRole').value = member.role;
                document.getElementById('tmPref').value = member.pref;
                document.getElementById('btnTmDelete').style.display = 'block';
            } else {
                document.getElementById('tmId').value = '';
                document.getElementById('tmName').value = '';
                document.getElementById('btnTmDelete').style.display = 'none';
            }
            openModal('modal-team');
        }

        function saveTeamMember() {
            const id = document.getElementById('tmId').value;
            const data = {
                id: id ? parseInt(id) : Date.now(),
                name: document.getElementById('tmName').value,
                role: document.getElementById('tmRole').value,
                pref: document.getElementById('tmPref').value
            };
            
            if(id) {
                const idx = Store.team.findIndex(t => t.id == id);
                Store.team[idx] = data;
            } else {
                Store.team.push(data);
            }
            Store.save();
            closeModal('modal-team');
        }

        function deleteTeamMember() {
            const id = parseInt(document.getElementById('tmId').value);
            Store.team = Store.team.filter(t => t.id !== id);
            Store.save();
            closeModal('modal-team');
        }

        /* --- 5. EXTRAS: PDF, OCR, CSV, CHART --- */
        
        // PDF Generation
        function openPDFModal() { openModal('modal-pdf'); }
        function setPdfStyle(style) { 
            Store.currentPdfStyle = style;
            document.querySelectorAll('.pdf-opt').forEach(e => e.style.borderColor = 'var(--color-border)');
            event.currentTarget.style.borderColor = 'var(--color-primary)';
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const style = Store.currentPdfStyle;

            // Styles config
            let fillColor = [30, 58, 138]; // Blue
            let textColor = [255, 255, 255];
            
            if(style === 'chess') { fillColor = [0,0,0]; }
            if(style === 'minimal') { fillColor = [255,255,255]; textColor = [0,0,0]; }

            // Header
            if(style !== 'minimal') {
                doc.setFillColor(...fillColor);
                doc.rect(0, 0, 210, 40, 'F');
                doc.setTextColor(...textColor);
            } else {
                doc.setTextColor(0,0,0);
            }
            
            doc.setFontSize(22);
            doc.text("Einsatzplan Jugendtraining", 14, 20);
            doc.setFontSize(12);
            doc.text("SC Brombach", 14, 28);
            
            // Footer Info (Range)
            const dates = Store.plan.map(e => e.date);
            const range = dates.length > 0 ? `${dates[0]} - ${dates[dates.length-1]}` : 'Unbekannt';
            doc.setFontSize(10);
            doc.text(`Zeitraum: ${range}`, 14, 36);

            const body = Store.plan.map(e => [e.date, e.time, e.names]);

            doc.autoTable({
                startY: 45,
                head: [['Datum', 'Uhrzeit', 'Team']],
                body: body,
                theme: style === 'minimal' ? 'plain' : 'grid',
                headStyles: { 
                    fillColor: style === 'minimal' ? [255,255,255] : fillColor, 
                    textColor: style === 'minimal' ? [0,0,0] : textColor,
                    lineColor: [0,0,0],
                    lineWidth: style === 'chess' ? 0.1 : 0
                },
                styles: { fontSize: 10, cellPadding: 4 },
            });
            
            doc.save('einsatzplan.pdf');
            closeModal('modal-pdf');
        }

        // WhatsApp Export
        function copyToWhatsApp() {
            let text = "*üìÖ Einsatzplan SC Brombach*\n\n";
            Store.plan.forEach(e => {
                text += `*${e.date}* (${e.time})\nüëâ ${e.names}\n\n`;
            });
            navigator.clipboard.writeText(text).then(() => alert("In Zwischenablage kopiert!"));
        }

        // CSV Import with "Verschlaubisierung"
        function openCSVModal() { openModal('modal-csv'); }
        function runCSVImport() {
            const raw = document.getElementById('csvText').value;
            const lines = raw.split('\n');
            lines.forEach(l => {
                let parts = l.split(';');
                if(parts.length >= 3) {
                    let names = parts[2].trim();
                    // AI correction
                    names = names.replace(/Du/g, "Kaspar").replace(/Ich/g, "Kaspar").replace(/\+/g, ",");
                    Store.plan.push({ date: parts[0].trim(), time: parts[1].trim(), names: names });
                }
            });
            Store.save();
            closeModal('modal-csv');
        }

        // OCR Scan (WhatsApp Screenshot optimized)
        function openScanModal() { openModal('modal-scan'); }
        async function runOCR(input) {
            if(!input.files[0]) return;
            const status = document.getElementById('scanStatus');
            status.innerText = "‚è≥ Analysiere Bild...";
            
            const worker = await Tesseract.createWorker('deu');
            const ret = await worker.recognize(input.files[0]);
            
            // Custom Parse Logic for WhatsApp
            // WhatsApp dates often appear as headers, followed by text
            const text = ret.data.text;
            console.log(text);
            status.innerText = "‚úÖ Fertig! Daten werden verarbeitet.";
            
            // Regex for dates DD.MM.
            const lines = text.split('\n');
            let lastDate = '??.??.';
            
            lines.forEach(line => {
                const dateMatch = line.match(/(\d{2}\.\d{2}\.?)/);
                if(dateMatch) lastDate = dateMatch[1];
                
                // If line contains known names, add it
                const knownNames = Store.team.map(t => t.name);
                const hasName = knownNames.some(n => line.includes(n));
                
                if(hasName && line.length > 5) {
                    Store.plan.push({
                        date: lastDate,
                        time: "Scan",
                        names: line.replace(dateMatch ? dateMatch[0] : '', '').trim()
                    });
                }
            });

            await worker.terminate();
            Store.save();
            setTimeout(() => closeModal('modal-scan'), 1000);
        }

        // Charts
        function setupCharts() {
            const ctx = document.getElementById('statsChart');
            if(!ctx) return;
            
            // Calculate Stats
            const counts = {};
            Store.team.forEach(t => counts[t.name] = 0);
            Store.plan.forEach(e => {
                Store.team.forEach(t => {
                    if(e.names.includes(t.name)) counts[t.name]++;
                });
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{
                        label: 'Anzahl Eins√§tze',
                        data: Object.values(counts),
                        backgroundColor: '#2563eb',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                }
            });
        }
        function updateStats() {
            // Chart update logic would go here in a real reactive framework
            // For now, re-init or static load is fine
        }

        /* --- 6. UTILS --- */
        function switchView(id) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + id).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + id).classList.add('active');
            
            if(id === 'dashboard') location.reload(); // Quick dirty refresh for stats
        }
        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        
        function filterTable(query) {
            const rows = document.querySelectorAll('#planTableBody tr');
            rows.forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(query.toLowerCase()) ? '' : 'none';
            });
        }
        
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            // CSS Variables handled in media query, simpler to just invert colors manually if needed
            // But here we rely on CSS vars.
        }

        function hardReset() {
            if(confirm("Bist du sicher? Alles wird gel√∂scht.")) {
                localStorage.clear();
                location.reload();
            }
        }

        // Start
        init();

    </script>
</body>
</html>