<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gittertier Planer Enterprise</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- GITTERTIER DESIGN SYSTEM --- */
        :root {
            /* Palette aus 404.html */
            --color-bg: #ffffff;
            --color-bg-secondary: #f9fafb;
            --color-text: #111111;
            --color-text-muted: #6b7280;
            --color-border: #e5e7eb;
            --color-accent: #2563eb;
            --color-accent-hover: #1d4ed8;
            --color-success: #16a34a;
            --color-warning: #f59e0b;
            --color-error: #dc2626;
            --color-overlay: rgba(0, 0, 0, 0.6);
            
            /* Rollen-Farben */
            --role-fixed: #2563eb;
            --role-springer: #059669;
            --role-notfall: #d97706;

            /* UI Properties */
            --radius: 12px;
            --radius-sm: 8px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --header-height: 60px;
            --bottom-nav-height: 65px;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, Helvetica, Arial, sans-serif;
            --transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* Dark Mode Support (Feature 1) */
        [data-theme="dark"] {
            --color-bg: #111827;
            --color-bg-secondary: #1f2937;
            --color-text: #f9fafb;
            --color-text-muted: #9ca3af;
            --color-border: #374151;
            --color-overlay: rgba(0, 0, 0, 0.8);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-main);
            background-color: var(--color-bg-secondary);
            color: var(--color-text);
            margin: 0;
            padding: 0;
            padding-bottom: calc(var(--bottom-nav-height) + 20px);
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- HEADER --- */
        header {
            height: var(--header-height);
            background: var(--color-bg);
            border-bottom: 1px solid var(--color-border);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: var(--shadow-sm);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--color-text);
            text-decoration: none;
        }
        .brand img { height: 32px; width: auto; }
        
        .header-actions { display: flex; gap: 10px; }

        .icon-btn {
            background: none; border: none; font-size: 1.2rem; 
            color: var(--color-text-muted); cursor: pointer; padding: 8px;
            border-radius: 50%; transition: var(--transition);
        }
        .icon-btn:hover { background: var(--color-bg-secondary); color: var(--color-accent); }

        /* --- CONTAINER & GRID --- */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--color-border);
        }
        .card-header h3 { margin: 0; font-size: 1.1rem; color: var(--color-text); display: flex; align-items: center; gap: 8px; }

        /* --- BUTTONS & INPUTS --- */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            padding: 10px 16px; border-radius: var(--radius-sm); font-weight: 600; font-size: 0.95rem;
            border: none; cursor: pointer; transition: var(--transition); text-decoration: none;
        }
        .btn-primary { background: var(--color-accent); color: white; box-shadow: 0 2px 4px rgba(37,99,235,0.3); }
        .btn-primary:hover { background: var(--color-accent-hover); transform: translateY(-1px); }
        .btn-secondary { background: var(--color-bg); border: 1px solid var(--color-border); color: var(--color-text); }
        .btn-secondary:hover { background: var(--color-bg-secondary); border-color: var(--color-text-muted); }
        .btn-danger { background: #fee2e2; color: var(--color-error); }
        .btn-danger:hover { background: #fecaca; }
        .btn-full { width: 100%; }

        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; font-size: 0.85rem; color: var(--color-text-muted); margin-bottom: 6px; font-weight: 500; }
        input, select, textarea {
            width: 100%; padding: 10px 12px; border: 1px solid var(--color-border);
            border-radius: var(--radius-sm); background: var(--color-bg); color: var(--color-text);
            font-size: 1rem; transition: var(--transition);
        }
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--color-accent); box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }

        /* --- BOTTOM NAVIGATION (Mobile) --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: var(--bottom-nav-height);
            background: var(--color-bg);
            border-top: 1px solid var(--color-border);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 90; padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .nav-item {
            flex: 1; text-align: center; color: var(--color-text-muted);
            font-size: 0.75rem; padding: 8px 0; cursor: pointer; transition: var(--transition);
            display: flex; flex-direction: column; align-items: center; gap: 4px;
        }
        .nav-item i { font-size: 1.25rem; }
        .nav-item.active { color: var(--color-accent); }
        .nav-item.active i { transform: scale(1.1); }

        /* --- VIEWS --- */
        .view-section { display: none; padding-bottom: 20px; }
        .view-section.active { display: block; animation: fadeIn 0.3s ease; }

        /* --- TABLE --- */
        .table-wrapper {
            overflow-x: auto; -webkit-overflow-scrolling: touch;
            border: 1px solid var(--color-border); border-radius: var(--radius-sm);
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        th { background: var(--color-bg-secondary); padding: 12px; text-align: left; font-size: 0.8rem; text-transform: uppercase; color: var(--color-text-muted); font-weight: 600; border-bottom: 1px solid var(--color-border); }
        td { padding: 12px; border-bottom: 1px solid var(--color-border); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: rgba(0,0,0,0.02); }

        .status-badge {
            display: inline-block; padding: 2px 8px; border-radius: 99px;
            font-size: 0.75rem; font-weight: 700; background: var(--color-bg-secondary); color: var(--color-text);
        }

        /* --- TEAM MANAGER UI --- */
        .team-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;
        }
        .member-card {
            background: var(--color-bg); border: 1px solid var(--color-border);
            border-radius: var(--radius-sm); padding: 16px; position: relative;
            transition: var(--transition);
        }
        .member-card:hover { border-color: var(--color-accent); box-shadow: var(--shadow); }
        .member-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .member-name { font-weight: 700; font-size: 1.05rem; }
        .role-tag {
            font-size: 0.7rem; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; font-weight: 700; color: white;
        }
        .role-fixed { background: var(--role-fixed); }
        .role-springer { background: var(--role-springer); }
        .role-notfall { background: var(--role-notfall); }

        /* --- WIZARD --- */
        .wizard-steps { display: flex; gap: 8px; margin-bottom: 20px; }
        .step { flex: 1; height: 4px; background: var(--color-border); border-radius: 2px; position: relative; }
        .step.active { background: var(--color-accent); }
        .step.completed { background: var(--color-success); }
        
        .wizard-content { display: none; }
        .wizard-content.active { display: block; animation: slideLeft 0.3s ease; }
        @keyframes slideLeft { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

        /* --- MODAL --- */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--color-overlay); z-index: 200;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: var(--transition);
            backdrop-filter: blur(4px);
        }
        .modal-backdrop.open { opacity: 1; visibility: visible; }
        
        .modal {
            background: var(--color-bg); width: 90%; max-width: 500px;
            max-height: 85vh; overflow-y: auto; border-radius: var(--radius);
            padding: 24px; box-shadow: var(--shadow-lg);
            transform: scale(0.95); transition: var(--transition);
        }
        .modal-backdrop.open .modal { transform: scale(1); }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .conflict-row { background-color: #fef2f2 !important; border-left: 4px solid var(--color-error); }
        .conflict-msg { color: var(--color-error); font-size: 0.8rem; display: block; margin-top: 4px; }
        
        /* Upload Area */
        .drop-zone {
            border: 2px dashed var(--color-border); border-radius: var(--radius);
            padding: 30px; text-align: center; cursor: pointer; transition: var(--transition);
        }
        .drop-zone:hover { border-color: var(--color-accent); background: var(--color-bg-secondary); }

    </style>
</head>
<body data-theme="light">

    <header>
        <a href="#" class="brand">
            <img src="https://www.loerrach.de/ceasy/resource/3714" alt="SCB">
            Gittertier Pro
        </a>
        <div class="header-actions">
            <button class="icon-btn" onclick="toggleTheme()"><i class="fa-solid fa-moon"></i></button>
            <button class="icon-btn" onclick="openSettings()"><i class="fa-solid fa-gear"></i></button>
        </div>
    </header>

    <div class="container">
        
        <div id="view-dashboard" class="view-section active">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fa-solid fa-chart-pie"></i> √úbersicht</h3>
                    <span class="status-badge" id="lblTotalShifts">0 Schichten</span>
                </div>
                <div style="height: 200px; position: relative;">
                    <canvas id="statsChart"></canvas>
                </div>
                <div style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div style="background:var(--color-bg-secondary); padding:10px; border-radius:8px; text-align:center;">
                        <div style="font-size:0.8rem; color:var(--color-text-muted);">N√§chster Termin</div>
                        <strong id="lblNextDate">-</strong>
                    </div>
                    <div style="background:var(--color-bg-secondary); padding:10px; border-radius:8px; text-align:center;">
                        <div style="font-size:0.8rem; color:var(--color-text-muted);">Aktive Helfer</div>
                        <strong id="lblActiveHelpers">0</strong>
                    </div>
                </div>
            </div>

            <div class="card" onclick="startWizard()" style="cursor: pointer; border-color: var(--color-accent); background: linear-gradient(to right, rgba(37,99,235,0.05), transparent);">
                <div style="display:flex; align-items:center; gap:15px;">
                    <div style="background:var(--color-accent); color:white; width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.5rem;">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                    </div>
                    <div>
                        <h3 style="margin:0; color:var(--color-accent);">Smart Generator</h3>
                        <p style="margin:5px 0 0; font-size:0.9rem; color:var(--color-text-muted);">
                            Automatische Einteilung mit KI-Logik.
                        </p>
                    </div>
                    <i class="fa-solid fa-chevron-right" style="margin-left:auto; color:var(--color-text-muted);"></i>
                </div>
            </div>
        </div>

        <div id="view-plan" class="view-section">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fa-solid fa-calendar-days"></i> Einsatzplan</h3>
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-secondary" onclick="openPDFModal()" style="padding:6px 12px; font-size:0.8rem;"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                        <button class="btn btn-secondary" onclick="exportICal()" style="padding:6px 12px; font-size:0.8rem;"><i class="fa-solid fa-calendar-plus"></i> iCal</button>
                    </div>
                </div>
                
                <div class="input-group" style="margin-bottom:10px;">
                    <input type="text" id="searchPlan" placeholder="üîç Namen suchen..." onkeyup="renderPlanTable()">
                </div>

                <div class="table-wrapper">
                    <table id="planTable">
                        <thead>
                            <tr>
                                <th width="20%">Datum</th>
                                <th width="25%">Zeit</th>
                                <th>Team</th>
                                <th width="10%"></th>
                            </tr>
                        </thead>
                        <tbody id="planBody">
                            </tbody>
                    </table>
                </div>
                <div id="planEmpty" style="padding:30px; text-align:center; color:var(--color-text-muted); display:none;">
                    <i class="fa-solid fa-ghost" style="font-size:2rem; margin-bottom:10px; opacity:0.5;"></i>
                    <p>Keine Eintr√§ge gefunden.</p>
                </div>
            </div>
            
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                 <button class="btn btn-secondary btn-full" onclick="openCSVModal()">
                    <i class="fa-solid fa-file-csv"></i> CSV Tools (Smart Import)
                 </button>
            </div>
        </div>

        <div id="view-team" class="view-section">
            <div class="card-header" style="margin-bottom:20px;">
                <h3><i class="fa-solid fa-users"></i> Helfer-Verwaltung</h3>
                <button class="btn btn-primary" onclick="openMemberModal()">+ Neu</button>
            </div>

            <div id="teamGrid" class="team-grid">
                </div>
        </div>

        <div id="view-upload" class="view-section">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fa-solid fa-eye"></i> WhatsApp Scan (OCR)</h3>
                </div>
                <p style="color:var(--color-text-muted); font-size:0.9rem; margin-bottom:20px;">
                    Lade einen Screenshot aus WhatsApp hoch. Die KI erkennt Daten, Zeiten und Namen automatisch.
                </p>
                
                <div class="drop-zone" onclick="document.getElementById('ocrFile').click()">
                    <input type="file" id="ocrFile" accept="image/*" hidden onchange="processOCR(this)">
                    <i class="fa-solid fa-cloud-arrow-up" style="font-size:2.5rem; color:var(--color-accent); margin-bottom:10px;"></i>
                    <p><strong>Hier tippen</strong> um Bild hochzuladen</p>
                </div>
                
                <div id="ocrProgress" class="hidden" style="margin-top:20px;">
                    <div style="height:6px; background:var(--color-border); border-radius:3px; overflow:hidden;">
                        <div id="ocrBar" style="height:100%; width:0%; background:var(--color-accent); transition: width 0.3s;"></div>
                    </div>
                    <p id="ocrStatus" style="font-size:0.8rem; text-align:center; margin-top:5px;">Starte Engine...</p>
                </div>
            </div>
        </div>

    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchView('dashboard')">
            <i class="fa-solid fa-chart-simple"></i>
            <span>Dash</span>
        </div>
        <div class="nav-item" onclick="switchView('plan')">
            <i class="fa-solid fa-list-check"></i>
            <span>Plan</span>
        </div>
        <div class="nav-item" onclick="switchView('team')">
            <i class="fa-solid fa-users-gear"></i>
            <span>Team</span>
        </div>
        <div class="nav-item" onclick="switchView('upload')">
            <i class="fa-solid fa-camera"></i>
            <span>Scan</span>
        </div>
    </nav>


    <div id="modalMember" class="modal-backdrop">
        <div class="modal">
            <div class="card-header">
                <h3>Helfer bearbeiten</h3>
                <button class="icon-btn" onclick="closeModals()">&times;</button>
            </div>
            <input type="hidden" id="memId">
            
            <div class="input-group">
                <label>Name</label>
                <input type="text" id="memName" placeholder="Vorname">
            </div>
            
            <div class="input-group">
                <label>Rolle</label>
                <select id="memRole">
                    <option value="fixed">Stammspieler (Immer)</option>
                    <option value="springer">Springer (Rotation)</option>
                    <option value="notfall">Notfall (Nur wenn n√∂tig)</option>
                </select>
                <p style="font-size:0.75rem; color:var(--color-text-muted); margin-top:4px;">
                    *Notfall wird erst eingeteilt, wenn keine Springer verf√ºgbar sind.
                </p>
            </div>
            
            <div class="input-group">
                <label>Bevorzugte Schicht</label>
                <select id="memShift">
                    <option value="both">Egal (Beides)</option>
                    <option value="early">Fr√ºh (17:00 - 18:30)</option>
                    <option value="late">Sp√§t (18:15 - 19:45)</option>
                </select>
            </div>

            <div class="input-group">
                <label>Ausschluss-Tage (Kommasepariert)</label>
                <input type="text" id="memExclude" placeholder="z.B. 12.02., 19.02.">
            </div>

            <button class="btn btn-primary btn-full" onclick="saveMember()">Speichern</button>
            <button class="btn btn-danger btn-full" onclick="deleteMember()" style="margin-top:10px;">L√∂schen</button>
        </div>
    </div>

    <div id="modalWizard" class="modal-backdrop">
        <div class="modal">
            <div class="card-header">
                <h3><i class="fa-solid fa-robot"></i> Smart Generator</h3>
                <button class="icon-btn" onclick="closeModals()">&times;</button>
            </div>

            <div class="wizard-steps">
                <div class="step active" id="step1-ind"></div>
                <div class="step" id="step2-ind"></div>
                <div class="step" id="step3-ind"></div>
            </div>

            <div id="step1" class="wizard-content active">
                <h4>Zeitraum w√§hlen</h4>
                <div class="input-group">
                    <label>Startdatum (Erster Trainingstag)</label>
                    <input type="date" id="wizStart">
                </div>
                <div class="input-group">
                    <label>Anzahl Wochen</label>
                    <select id="wizWeeks">
                        <option value="4">4 Wochen</option>
                        <option value="8" selected>8 Wochen</option>
                        <option value="12">12 Wochen (Quartal)</option>
                    </select>
                </div>
                <button class="btn btn-primary btn-full" onclick="wizNext(2)">Weiter</button>
            </div>

            <div id="step2" class="wizard-content">
                <h4>Regeln definieren</h4>
                <div class="input-group">
                    <label>Min. Personen pro Schicht</label>
                    <input type="number" id="wizMinP" value="3" min="1">
                </div>
                <div class="input-group" style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="wizDouble" style="width:auto;" checked>
                    <label style="margin:0;">Doppelschichten erlauben</label>
                </div>
                <p style="font-size:0.8rem; color:var(--color-text-muted);">
                    Wenn aktiv: Wer "Egal" als Zeit hat und fr√ºh eingeteilt wird, bleibt oft auch sp√§t (Effizienz).
                </p>
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="btn btn-secondary" onclick="wizNext(1)">Zur√ºck</button>
                    <button class="btn btn-primary" style="flex:1;" onclick="wizNext(3)">Weiter</button>
                </div>
            </div>

            <div id="step3" class="wizard-content">
                <h4>Bereit zur Generierung</h4>
                <p>Der Algorithmus wird nun:</p>
                <ul style="font-size:0.9rem; color:var(--color-text-muted); padding-left:20px;">
                    <li>Stammspieler setzen</li>
                    <li>Springer fair rotieren</li>
                    <li>Notf√§lle nur bei Engpass nutzen</li>
                    <li>Konflikte pr√ºfen</li>
                </ul>
                
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="btn btn-secondary" onclick="wizNext(2)">Zur√ºck</button>
                    <button class="btn btn-primary" style="flex:1;" onclick="runGenerator()">
                        <i class="fa-solid fa-bolt"></i> Generieren
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="modalPDF" class="modal-backdrop">
        <div class="modal">
            <div class="card-header">
                <h3>PDF Design w√§hlen</h3>
                <button class="icon-btn" onclick="closeModals()">&times;</button>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:20px;">
                <div onclick="setPdfStyle('corporate')" class="member-card" style="text-align:center; cursor:pointer; padding:10px;">
                    <i class="fa-solid fa-building" style="font-size:1.5rem; color:var(--color-accent);"></i>
                    <div style="font-size:0.8rem; margin-top:5px;">Corporate</div>
                </div>
                <div onclick="setPdfStyle('print')" class="member-card" style="text-align:center; cursor:pointer; padding:10px;">
                    <i class="fa-solid fa-print" style="font-size:1.5rem; color:#333;"></i>
                    <div style="font-size:0.8rem; margin-top:5px;">S/W Druck</div>
                </div>
                <div onclick="setPdfStyle('app')" class="member-card" style="text-align:center; cursor:pointer; padding:10px;">
                    <i class="fa-solid fa-mobile-screen" style="font-size:1.5rem; color:var(--color-success);"></i>
                    <div style="font-size:0.8rem; margin-top:5px;">Modern</div>
                </div>
            </div>
            <input type="hidden" id="selectedPdfStyle" value="corporate">
            
            <div class="input-group">
                <label>Kopfzeile Text</label>
                <input type="text" id="pdfTitle" value="Einsatzplan Jugendtraining">
            </div>
            <div class="input-group">
                <label>Fu√üzeile Text</label>
                <input type="text" id="pdfFooter" value="SC Brombach e.V.">
            </div>
            
            <button class="btn btn-primary btn-full" onclick="generatePDF()">PDF Erstellen</button>
        </div>
    </div>
    
    <div id="modalCSV" class="modal-backdrop">
        <div class="modal">
            <div class="card-header">
                <h3>Smart CSV Tools</h3>
                <button class="icon-btn" onclick="closeModals()">&times;</button>
            </div>
            <p style="font-size:0.85rem; color:var(--color-text-muted);">
                F√ºge rohe Daten aus Excel ein. Das System erkennt automatisch Spalten wie "Datum", "Zeit" und Namen.
            </p>
            <textarea id="csvInput" rows="6" placeholder="Bsp: 12.02.2026; 17:00; Kaspar, Uwe"></textarea>
            
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn btn-primary btn-full" onclick="processSmartCSV()">Smart Import</button>
                <button class="btn btn-secondary btn-full" onclick="downloadCSV()">Export</button>
            </div>
        </div>
    </div>
    
    <div id="modalEditEntry" class="modal-backdrop">
        <div class="modal">
            <div class="card-header">
                <h3>Termin bearbeiten</h3>
                <button class="icon-btn" onclick="closeModals()">&times;</button>
            </div>
            <input type="hidden" id="editEntryId">
            <div class="input-group"><label>Datum</label><input type="text" id="edtDate"></div>
            <div class="input-group"><label>Zeit</label><input type="text" id="edtTime"></div>
            <div class="input-group"><label>Namen</label><input type="text" id="edtNames"></div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-danger" onclick="deleteEntry()">L√∂schen</button>
                <button class="btn btn-primary" style="flex:1;" onclick="saveEntry()">Speichern</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STORE ---
        const App = {
            data: {
                team: [],
                schedule: []
            },
            settings: {
                theme: 'light'
            },
            init() {
                // Load from LocalStorage
                const savedTeam = localStorage.getItem('gp_team');
                const savedSched = localStorage.getItem('gp_schedule');
                if(savedTeam) this.data.team = JSON.parse(savedTeam);
                else this.loadDefaultTeam();
                
                if(savedSched) this.data.schedule = JSON.parse(savedSched);
                
                this.renderAll();
                this.updateStats();
            },
            save() {
                localStorage.setItem('gp_team', JSON.stringify(this.data.team));
                localStorage.setItem('gp_schedule', JSON.stringify(this.data.schedule));
                this.updateStats();
            },
            loadDefaultTeam() {
                this.data.team = [
                    { id: 1, name: 'Kaspar', role: 'fixed', shift: 'both', exclude: [] },
                    { id: 2, name: 'Uwe', role: 'springer', shift: 'late', exclude: [] },
                    { id: 3, name: 'Nico', role: 'springer', shift: 'both', exclude: [] },
                    { id: 4, name: 'Dmitry', role: 'springer', shift: 'both', exclude: [] },
                    { id: 5, name: 'Gento', role: 'springer', shift: 'early', exclude: [] },
                    { id: 6, name: 'Stephan', role: 'notfall', shift: 'both', exclude: [] }
                ];
            },
            renderAll() {
                renderTeam();
                renderPlanTable();
            },
            updateStats() {
                // Calculation for Dashboard
                const totalShifts = this.data.schedule.length;
                document.getElementById('lblTotalShifts').innerText = totalShifts + " Schichten";
                
                // Active Helpers
                const helpers = new Set();
                this.data.schedule.forEach(s => {
                    s.names.split(',').forEach(n => helpers.add(n.trim()));
                });
                document.getElementById('lblActiveHelpers').innerText = helpers.size;
                
                // Next Date
                // Simple sort logic
                if(this.data.schedule.length > 0) {
                     // Assuming format DD.MM.
                    const now = new Date();
                    // Just take the first one assuming sorted or simple logic
                    document.getElementById('lblNextDate').innerText = this.data.schedule[0].date;
                }

                renderChart(this.data.team, this.data.schedule);
            }
        };

        // --- UI FUNCTIONS ---
        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById('view-' + viewId).classList.add('active');
            
            // Highlight Nav
            const navIndex = ['dashboard', 'plan', 'team', 'upload'].indexOf(viewId);
            if(navIndex >= 0) document.querySelectorAll('.nav-item')[navIndex].classList.add('active');
        }

        function closeModals() {
            document.querySelectorAll('.modal-backdrop').forEach(el => el.classList.remove('open'));
        }
        
        function toggleTheme() {
            const body = document.body;
            const newTheme = body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', newTheme);
        }

        // --- TEAM LOGIC ---
        function renderTeam() {
            const grid = document.getElementById('teamGrid');
            grid.innerHTML = '';
            
            App.data.team.forEach(member => {
                let roleLabel = 'Springer';
                let roleClass = 'role-springer';
                if(member.role === 'fixed') { roleLabel = 'Stamm'; roleClass = 'role-fixed'; }
                if(member.role === 'notfall') { roleLabel = 'Notfall'; roleClass = 'role-notfall'; }
                
                const card = document.createElement('div');
                card.className = 'member-card';
                card.onclick = () => openMemberModal(member.id);
                card.innerHTML = `
                    <div class="member-header">
                        <span class="member-name">${member.name}</span>
                        <span class="role-tag ${roleClass}">${roleLabel}</span>
                    </div>
                    <div style="font-size:0.85rem; color:var(--color-text-muted);">
                        <i class="fa-regular fa-clock"></i> ${getShiftLabel(member.shift)}
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        function getShiftLabel(s) {
            if(s === 'early') return 'Nur Fr√ºh (17-18:30)';
            if(s === 'late') return 'Nur Sp√§t (18-19:45)';
            return 'Flexibel (Beide)';
        }

        function openMemberModal(id = null) {
            const modal = document.getElementById('modalMember');
            modal.classList.add('open');
            
            if(id) {
                const m = App.data.team.find(x => x.id === id);
                document.getElementById('memId').value = m.id;
                document.getElementById('memName').value = m.name;
                document.getElementById('memRole').value = m.role;
                document.getElementById('memShift').value = m.shift;
                document.getElementById('memExclude').value = m.exclude.join(', ');
            } else {
                document.getElementById('memId').value = '';
                document.getElementById('memName').value = '';
                document.getElementById('memRole').value = 'springer';
            }
        }

        function saveMember() {
            const id = document.getElementById('memId').value;
            const name = document.getElementById('memName').value;
            const role = document.getElementById('memRole').value;
            const shift = document.getElementById('memShift').value;
            const exclRaw = document.getElementById('memExclude').value;
            const exclude = exclRaw.split(',').map(s => s.trim()).filter(s => s);

            if(!name) return alert("Name fehlt!");

            if(id) {
                const idx = App.data.team.findIndex(x => x.id == id);
                App.data.team[idx] = { id: parseInt(id), name, role, shift, exclude };
            } else {
                App.data.team.push({ id: Date.now(), name, role, shift, exclude });
            }
            App.save();
            renderTeam();
            closeModals();
        }

        function deleteMember() {
            const id = document.getElementById('memId').value;
            if(!id) return;
            if(confirm("Wirklich l√∂schen?")) {
                App.data.team = App.data.team.filter(x => x.id != id);
                App.save();
                renderTeam();
                closeModals();
            }
        }

        // --- PLAN LOGIC ---
        function renderPlanTable() {
            const tbody = document.getElementById('planBody');
            const search = document.getElementById('searchPlan').value.toLowerCase();
            tbody.innerHTML = '';
            
            let visibleCount = 0;
            
            App.data.schedule.forEach((entry, idx) => {
                if(search && !entry.names.toLowerCase().includes(search) && !entry.date.includes(search)) return;
                
                visibleCount++;
                const tr = document.createElement('tr');
                
                // Check Conflict (Smart Feature)
                const isConflict = checkConflict(entry);
                if(isConflict) tr.classList.add('conflict-row');

                tr.innerHTML = `
                    <td>
                        <strong>${entry.date}</strong>
                        ${isConflict ? '<span class="conflict-msg">‚ö† Engpass</span>' : ''}
                    </td>
                    <td>${entry.time}</td>
                    <td>${entry.names}</td>
                    <td>
                        <button class="icon-btn" onclick="editEntry(${idx})"><i class="fa-solid fa-pen"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('planEmpty').style.display = visibleCount === 0 ? 'block' : 'none';
            document.getElementById('planTable').style.display = visibleCount === 0 ? 'none' : 'table';
        }

        function checkConflict(entry) {
            // Logic: Less than 2 people is a conflict
            const count = entry.names.split(',').filter(x => x.trim()).length;
            return count < 2;
        }

        function editEntry(index) {
            const e = App.data.schedule[index];
            document.getElementById('editEntryId').value = index;
            document.getElementById('edtDate').value = e.date;
            document.getElementById('edtTime').value = e.time;
            document.getElementById('edtNames').value = e.names;
            document.getElementById('modalEditEntry').classList.add('open');
        }

        function saveEntry() {
            const idx = document.getElementById('editEntryId').value;
            App.data.schedule[idx] = {
                date: document.getElementById('edtDate').value,
                time: document.getElementById('edtTime').value,
                names: document.getElementById('edtNames').value
            };
            App.save();
            renderPlanTable();
            closeModals();
        }

        function deleteEntry() {
            const idx = document.getElementById('editEntryId').value;
            App.data.schedule.splice(idx, 1);
            App.save();
            renderPlanTable();
            closeModals();
        }

        // --- WIZARD / GENERATOR LOGIC ---
        function startWizard() {
            document.getElementById('modalWizard').classList.add('open');
            wizNext(1);
        }

        function wizNext(step) {
            document.querySelectorAll('.wizard-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active', 'completed'));
            
            document.getElementById('step' + step).classList.add('active');
            
            // Update indicators
            for(let i=1; i<=3; i++) {
                const el = document.getElementById('step' + i + '-ind');
                if(i < step) el.classList.add('completed');
                if(i === step) el.classList.add('active');
            }
        }

        function runGenerator() {
            const startDateRaw = document.getElementById('wizStart').value;
            if(!startDateRaw) return alert("Startdatum w√§hlen!");
            
            const weeks = parseInt(document.getElementById('wizWeeks').value);
            const allowDouble = document.getElementById('wizDouble').checked;
            
            // Logic setup
            let currentDate = new Date(startDateRaw);
            let newSchedule = [];
            
            // Fairness Tracker (Assignment count)
            const tracker = {};
            App.data.team.forEach(m => tracker[m.id] = 0);

            for(let i=0; i<weeks; i++) {
                const dateStr = formatDate(currentDate);
                
                // Slots
                const slotEarly = { time: '17:00 - 18:30', shift: 'early', assigned: [] };
                const slotLate = { time: '18:15 - 19:45', shift: 'late', assigned: [] };
                const slots = [slotEarly, slotLate];

                slots.forEach(slot => {
                    // 1. Fixed Players
                    const fixed = App.data.team.filter(m => m.role === 'fixed' && (m.shift === 'both' || m.shift === slot.shift));
                    fixed.forEach(p => {
                        if(!p.exclude.includes(dateStr)) {
                            slot.assigned.push(p);
                            tracker[p.id]++;
                        }
                    });
                });

                // 2. Double Shift Logic & Rotation
                // If someone is in Early and allows Both, put in Late too if "allowDouble" is true
                if(allowDouble) {
                    slotEarly.assigned.forEach(p => {
                        if(p.shift === 'both' && !slotLate.assigned.includes(p)) {
                             slotLate.assigned.push(p);
                             tracker[p.id]++;
                        }
                    });
                }

                // 3. Fill with Springers
                slots.forEach(slot => {
                    const needed = Math.max(0, 3 - slot.assigned.length);
                    if(needed > 0) {
                        let candidates = App.data.team.filter(m => 
                            m.role === 'springer' && 
                            (m.shift === 'both' || m.shift === slot.shift) &&
                            !slot.assigned.includes(m) &&
                            !m.exclude.includes(dateStr)
                        );
                        
                        // Sort by fairness (least assigned first)
                        candidates.sort((a,b) => tracker[a.id] - tracker[b.id]);
                        
                        // Take top N
                        for(let k=0; k<needed; k++) {
                            if(candidates[k]) {
                                slot.assigned.push(candidates[k]);
                                tracker[candidates[k].id]++;
                            }
                        }
                    }
                });

                // 4. Emergency Fallback
                slots.forEach(slot => {
                    if(slot.assigned.length < 2) {
                         let notfall = App.data.team.filter(m => m.role === 'notfall' && !slot.assigned.includes(m));
                         if(notfall.length > 0) {
                             slot.assigned.push(notfall[0]);
                             tracker[notfall[0].id]++;
                         }
                    }
                });

                // Push to schedule
                slots.forEach(slot => {
                    newSchedule.push({
                        date: dateStr,
                        time: slot.time,
                        names: slot.assigned.map(m => m.name).join(', ')
                    });
                });

                currentDate.setDate(currentDate.getDate() + 7); // Next week
            }

            App.data.schedule = newSchedule; // Replace (or could append)
            App.save();
            closeModals();
            switchView('plan');
            alert(`Erfolg! Plan f√ºr ${weeks} Wochen erstellt.`);
        }

        // --- PDF ENGINE ---
        function openPDFModal() { document.getElementById('modalPDF').classList.add('open'); }
        function setPdfStyle(style) {
            document.getElementById('selectedPdfStyle').value = style;
            document.querySelectorAll('#modalPDF .member-card').forEach(el => el.style.borderColor = 'var(--color-border)');
            event.currentTarget.style.borderColor = 'var(--color-accent)';
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const style = document.getElementById('selectedPdfStyle').value;
            const title = document.getElementById('pdfTitle').value;
            const footer = document.getElementById('pdfFooter').value;

            // Configs
            let headColor = [37, 99, 235];
            let theme = 'grid';
            
            if(style === 'print') { headColor = [40, 40, 40]; theme = 'plain'; }
            if(style === 'app') { headColor = [22, 163, 74]; theme = 'striped'; }

            // Header
            doc.setFillColor(...headColor);
            if(style !== 'print') doc.rect(0, 0, 210, 30, 'F');
            
            doc.setTextColor(style === 'print' ? 0 : 255);
            doc.setFontSize(18);
            doc.text(title, 14, 20);
            
            doc.setFontSize(10);
            doc.text(`Generiert am ${new Date().toLocaleDateString()}`, 14, 26);

            // Table
            const rows = App.data.schedule.map(s => [s.date, s.time, s.names]);
            doc.autoTable({
                startY: 40,
                head: [['Datum', 'Uhrzeit', 'Team']],
                body: rows,
                theme: theme,
                headStyles: { fillColor: headColor, textColor: 255 },
                styles: { fontSize: 10, cellPadding: 4 },
                didDrawPage: function (data) {
                    // Footer
                    doc.setFontSize(8);
                    doc.setTextColor(100);
                    doc.text(footer + ' - Seite ' + doc.internal.getNumberOfPages(), 14, doc.internal.pageSize.height - 10);
                }
            });

            doc.save('Einsatzplan.pdf');
            closeModals();
        }

        // --- OCR / IMAGE RECOGNITION ---
        async function processOCR(input) {
            const file = input.files[0];
            if(!file) return;

            const progress = document.getElementById('ocrProgress');
            const bar = document.getElementById('ocrBar');
            const status = document.getElementById('ocrStatus');
            progress.classList.remove('hidden');

            try {
                status.innerText = "Lade Tesseract...";
                bar.style.width = "20%";
                
                const worker = await Tesseract.createWorker('deu');
                bar.style.width = "50%";
                status.innerText = "Analysiere WhatsApp Bild...";
                
                const ret = await worker.recognize(file);
                bar.style.width = "80%";
                status.innerText = "Extrahiere Daten...";
                
                // Smart WhatsApp Parse Logic
                const lines = ret.data.text.split('\n');
                let found = 0;
                let lastDate = '??.??.';
                
                // Regex for Date (DD.MM.)
                const dateRgx = /(\d{1,2}\.\d{1,2}\.?)/;
                
                lines.forEach(line => {
                    const l = line.trim();
                    if(l.length < 5) return;
                    
                    // Date found?
                    const dMatch = l.match(dateRgx);
                    if(dMatch) lastDate = dMatch[1];
                    
                    // Names found? (Heuristic: Common names or commas)
                    if(l.includes(',') || l.toLowerCase().includes('kaspar') || l.toLowerCase().includes('nico')) {
                         // Clean junk
                         const names = l.replace(dateRgx, '').replace(/[\(\)\[\]]/g, '').trim();
                         // Guess Time based on list position or content (Fallback to default)
                         const time = l.includes('18:') ? '18:15 - 19:45' : '17:00 - 18:30';
                         
                         App.data.schedule.push({ date: lastDate, time, names });
                         found++;
                    }
                });

                bar.style.width = "100%";
                status.innerText = `Fertig! ${found} Eintr√§ge erkannt.`;
                await worker.terminate();
                
                setTimeout(() => {
                    App.save();
                    App.renderAll();
                    switchView('plan');
                    progress.classList.add('hidden');
                }, 1000);

            } catch (e) {
                console.error(e);
                status.innerText = "Fehler bei der Erkennung.";
                status.style.color = "var(--color-error)";
            }
        }

        // --- CSV SMART TOOLS ---
        function openCSVModal() { document.getElementById('modalCSV').classList.add('open'); }
        function processSmartCSV() {
            const txt = document.getElementById('csvInput').value;
            const lines = txt.split('\n');
            let added = 0;
            lines.forEach(line => {
                const parts = line.split(';');
                if(parts.length >= 2) {
                    App.data.schedule.push({
                        date: parts[0].trim(),
                        time: parts[1].trim(),
                        names: parts[2] ? parts[2].trim() : ''
                    });
                    added++;
                }
            });
            App.save();
            renderPlanTable();
            closeModals();
            alert(`${added} Zeilen importiert.`);
        }
        function downloadCSV() {
            let csv = "Datum;Uhrzeit;Namen\n";
            App.data.schedule.forEach(r => csv += `${r.date};${r.time};${r.names}\n`);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'plan.csv'; a.click();
        }
        
        function exportICal() {
            let ics = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//GittertierPro//DE\n";
            App.data.schedule.forEach(s => {
                // Parse date (DD.MM. -> YYYYMMDD) - Simple assumption: current/next year
                const [d, m] = s.date.split('.');
                const year = new Date().getFullYear(); // simplified
                const dateStr = `${year}${m.padStart(2,'0')}${d.padStart(2,'0')}`;
                // Start Time
                const startTime = s.time.substring(0,5).replace(':','') + "00";
                
                ics += "BEGIN:VEVENT\n";
                ics += `SUMMARY:Jugendtraining (${s.names})\n`;
                ics += `DTSTART:${dateStr}T${startTime}\n`;
                ics += `DESCRIPTION:Team: ${s.names}\n`;
                ics += "END:VEVENT\n";
            });
            ics += "END:VCALENDAR";
            
            const blob = new Blob([ics], { type: 'text/calendar' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'plan.ics'; a.click();
        }

        // --- STATS CHART (Chart.js) ---
        let chartInstance = null;
        function renderChart(team, schedule) {
            const ctx = document.getElementById('statsChart').getContext('2d');
            
            // Count assignments
            const labels = team.map(m => m.name);
            const data = team.map(m => {
                let count = 0;
                schedule.forEach(s => { if(s.names.includes(m.name)) count++; });
                return count;
            });

            if(chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Eins√§tze',
                        data: data,
                        backgroundColor: '#2563eb',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- HELPER UTILS ---
        function formatDate(d) {
            let day = d.getDate();
            let mon = d.getMonth() + 1;
            return (day < 10 ? '0'+day : day) + '.' + (mon < 10 ? '0'+mon : mon) + '.';
        }

        // Init App
        window.onload = () => App.init();
        
        // Expose settings for header
        function openSettings() { alert("Settings: Version 4.0 Enterprise \nTheme: " + App.settings.theme); }

    </script>
</body>
</html>