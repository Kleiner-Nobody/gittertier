<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Einsatzplaner Pro v4 - SC Brombach</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> <style>
        /* --- Gittertier Pro Design System --- */
        :root {
            --c-bg: #f3f4f6;
            --c-surface: #ffffff;
            --c-text: #111827;
            --c-text-muted: #6b7280;
            --c-primary: #2563eb;
            --c-primary-hover: #1d4ed8;
            --c-primary-light: #eff6ff;
            --c-success: #10b981;
            --c-warning: #f59e0b;
            --c-danger: #ef4444;
            --c-border: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --radius: 12px;
            --header-h: 64px;
            --nav-h: 70px; /* Mobile Nav Height */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--c-bg);
            color: var(--c-text);
            margin: 0;
            padding-bottom: calc(var(--nav-h) + 20px); /* Space for mobile nav */
        }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- Header --- */
        header {
            height: var(--header-h);
            background: var(--c-surface);
            border-bottom: 1px solid var(--c-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: var(--shadow-sm);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--c-text);
            text-decoration: none;
        }
        .brand img { height: 36px; width: auto; }
        .brand span { color: var(--c-primary); }

        /* --- Mobile Navigation (Bottom) --- */
        .mobile-nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: var(--c-surface);
            border-top: 1px solid var(--c-border);
            height: var(--nav-h);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.05);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--c-text-muted);
            font-size: 0.75rem;
            gap: 4px;
            background: none;
            border: none;
            height: 100%;
            cursor: pointer;
            transition: 0.2s;
        }

        .nav-item i { font-size: 1.25rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--c-primary); }
        .nav-item.active i { transform: scale(1.1); }

        /* --- Main Layout --- */
        main {
            max-width: 1000px;
            margin: 20px auto;
            padding: 0 16px;
        }

        .view { display: none; animation: fadeIn 0.3s ease-out; }
        .view.active { display: block; }

        /* --- Components: Cards --- */
        .card {
            background: var(--c-surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--c-border);
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--c-border);
        }
        .card-header h2 { font-size: 1.1rem; margin: 0; display: flex; align-items: center; gap: 8px; }
        .card-header h2 i { color: var(--c-primary); }

        /* --- Components: Forms --- */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        .full-width { grid-column: 1 / -1; }

        label { display: block; font-size: 0.85rem; color: var(--c-text-muted); margin-bottom: 6px; font-weight: 500; }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--c-border);
            border-radius: 8px;
            font-size: 1rem;
            background: #fff;
            transition: 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--c-primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
        }

        /* --- Components: Buttons --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            border: none;
            cursor: pointer;
            transition: 0.2s;
            width: 100%;
        }
        .btn-primary { background: var(--c-primary); color: white; }
        .btn-primary:hover { background: var(--c-primary-hover); }
        
        .btn-secondary { background: white; border: 1px solid var(--c-border); color: var(--c-text); }
        .btn-secondary:hover { background: var(--c-bg); }
        
        .btn-danger { background: #fee2e2; color: var(--c-danger); }
        
        .btn-ghost { background: transparent; color: var(--c-text-muted); padding: 8px; width: auto; }
        .btn-ghost:hover { color: var(--c-primary); background: var(--c-primary-light); }

        /* --- Wizard Styles --- */
        .wizard-step { display: none; }
        .wizard-step.active { display: block; animation: slideIn 0.3s ease; }
        .step-indicators { display: flex; gap: 4px; margin-bottom: 20px; }
        .step-dot { flex: 1; height: 4px; background: var(--c-border); border-radius: 2px; }
        .step-dot.active { background: var(--c-primary); }
        .step-dot.completed { background: var(--c-success); }

        /* --- Team List --- */
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 12px;
        }
        .member-card {
            background: #f9fafb;
            border: 1px solid var(--c-border);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .role-badge {
            font-size: 0.7rem; padding: 2px 8px; border-radius: 99px; font-weight: 700; text-transform: uppercase;
        }
        .role-fixed { background: #dbeafe; color: #1e40af; }
        .role-rotate { background: #e0e7ff; color: #4338ca; }
        .role-emergency { background: #fee2e2; color: #991b1b; }

        /* --- Table --- */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--c-border);
        }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #f9fafb; text-align: left; padding: 12px 16px; font-size: 0.8rem; text-transform: uppercase; color: var(--c-text-muted); border-bottom: 1px solid var(--c-border); }
        td { padding: 12px 16px; border-bottom: 1px solid var(--c-border); vertical-align: middle; }
        tr:hover td { background: #f9fafb; }
        
        .conflict-row { background-color: #fef2f2 !important; border-left: 4px solid var(--c-danger); }
        .smart-badge { background: linear-gradient(135deg, #6366f1, #a855f7); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 5px; }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200;
            display: flex; align-items: flex-end; /* Mobile bottom sheet style */
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        
        .modal {
            background: var(--c-surface);
            width: 100%; max-width: 600px;
            margin: 0 auto;
            border-radius: 20px 20px 0 0;
            padding: 24px;
            transform: translateY(100%); transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 90vh; overflow-y: auto;
        }
        .modal-overlay.open .modal { transform: translateY(0); }
        
        @media(min-width: 640px) {
            .modal-overlay { align-items: center; }
            .modal { border-radius: var(--radius); transform: scale(0.95); width: 90%; }
            .modal-overlay.open .modal { transform: scale(1); }
            .mobile-nav { display: none; }
            body { padding-bottom: 0; }
            .desktop-nav { display: flex; gap: 20px; }
            .desktop-nav a { text-decoration: none; color: var(--c-text-muted); font-weight: 500; transition: 0.2s; cursor: pointer; }
            .desktop-nav a:hover, .desktop-nav a.active { color: var(--c-primary); }
            .desktop-nav a.active { border-bottom: 2px solid var(--c-primary); }
        }
        @media(max-width: 639px) {
            .desktop-nav { display: none; }
            .form-grid { grid-template-columns: 1fr; }
        }

        /* --- Drag & Drop Zone --- */
        .drop-zone {
            border: 2px dashed var(--c-border); border-radius: var(--radius);
            padding: 30px; text-align: center; color: var(--c-text-muted); cursor: pointer; transition: 0.2s;
        }
        .drop-zone:hover, .drop-zone.dragover { border-color: var(--c-primary); background: var(--c-primary-light); }

        /* --- Loader --- */
        .loader-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 300;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .loader-spinner {
            width: 50px; height: 50px; border: 4px solid #e5e7eb; border-top: 4px solid var(--c-primary);
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px;
        }

    </style>
</head>
<body>

    <div id="loader" class="loader-overlay">
        <div class="loader-spinner"></div>
        <h3 id="loader-text">Arbeite...</h3>
    </div>

    <header>
        <a href="#" class="brand">
            <img src="https://www.loerrach.de/ceasy/resource/3714" alt="Logo">
            <div>SC Brombach <span style="font-weight:400; font-size:0.9em;">Planer v4</span></div>
        </a>
        <nav class="desktop-nav">
            <a onclick="App.nav('dashboard')" class="active">√úbersicht</a>
            <a onclick="App.nav('team')">Team</a>
            <a onclick="App.nav('wizard')">Generator</a>
            <a onclick="App.nav('stats')">Statistik</a>
        </nav>
        <button class="btn btn-primary" onclick="App.Modals.open('export')" style="width: auto; padding: 8px 16px; font-size: 0.8rem;">
            <i class="fa-solid fa-download"></i> Export
        </button>
    </header>

    <main>
        
        <div id="view-dashboard" class="view active">
            <div class="form-grid" style="margin-bottom: 20px;">
                <div class="card" style="margin:0; padding: 15px; background: linear-gradient(135deg, #2563eb, #1e40af); color: white; border:none;">
                    <div style="font-size: 0.9rem; opacity: 0.9;">N√§chster Termin</div>
                    <div id="next-shift-display" style="font-size: 1.5rem; font-weight: 700; margin-top: 5px;">--.--.</div>
                    <div id="next-shift-team" style="font-size: 0.9rem; margin-top: 5px; opacity: 0.9;">Keine Daten</div>
                </div>
                <div class="card" style="margin:0; padding: 15px; display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <div style="font-size: 0.9rem; color: var(--c-text-muted);">Offene Schichten</div>
                        <div id="open-shifts-count" style="font-size: 1.8rem; font-weight: 700; color: var(--c-danger);">0</div>
                    </div>
                    <i class="fa-solid fa-triangle-exclamation" style="font-size: 2rem; color: #fee2e2;"></i>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2><i class="fa-solid fa-calendar-days"></i> Einsatzplan</h2>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-ghost" onclick="App.Modals.open('ocr')"><i class="fa-solid fa-camera"></i> Scan</button>
                        <button class="btn btn-ghost" onclick="App.Modals.open('addEntry')"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>

                <div class="table-container">
                    <table id="main-table">
                        <thead>
                            <tr>
                                <th width="15%">Datum</th>
                                <th width="20%">Zeit</th>
                                <th>Team</th>
                                <th width="10%"></th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            </tbody>
                    </table>
                </div>
                <div id="empty-state" style="padding: 40px; text-align: center; color: var(--c-text-muted); display: none;">
                    <i class="fa-solid fa-clipboard-list" style="font-size: 3rem; margin-bottom: 16px; opacity: 0.3;"></i>
                    <p>Keine Eintr√§ge vorhanden.</p>
                    <button class="btn btn-secondary" onclick="App.nav('wizard')" style="width:auto; margin-top:10px;">Generator starten</button>
                </div>
            </div>
        </div>

        <div id="view-team" class="view">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fa-solid fa-users"></i> Teilnehmer</h2>
                    <button class="btn btn-primary" onclick="App.Modals.open('addMember')" style="width: auto;">+ Neu</button>
                </div>
                <p style="color: var(--c-text-muted); font-size: 0.9rem; margin-bottom: 20px;">
                    Verwalte hier Rollen und Verf√ºgbarkeiten. 
                    <br><strong>Stamm:</strong> Immer geplant. <strong>Springer:</strong> Rotiert. <strong>Notfall:</strong> Nur manuell.
                </p>
                <div id="team-grid" class="team-grid">
                    </div>
            </div>
        </div>

        <div id="view-wizard" class="view">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fa-solid fa-wand-magic-sparkles"></i> KI-Planer Wizard</h2>
                </div>

                <div class="step-indicators">
                    <div class="step-dot active" id="dot-1"></div>
                    <div class="step-dot" id="dot-2"></div>
                    <div class="step-dot" id="dot-3"></div>
                </div>

                <div id="step-1" class="wizard-step active">
                    <h3>Zeitraum & Umfang</h3>
                    <div class="form-grid">
                        <div>
                            <label>Startdatum (Freitag)</label>
                            <input type="date" id="gen-start-date">
                        </div>
                        <div>
                            <label>Dauer</label>
                            <select id="gen-duration">
                                <option value="4">4 Wochen</option>
                                <option value="8" selected>8 Wochen</option>
                                <option value="12">12 Wochen</option>
                            </select>
                        </div>
                        <div class="full-width">
                            <label>Modus</label>
                            <div class="member-card" style="margin-bottom:10px;">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <input type="checkbox" id="gen-pref-doubles" checked style="width:20px; height:20px;">
                                    <span><strong>Doppelschichten bevorzugen</strong><br><small style="color:#666;">Wer 17:00 kommt, macht auch 18:15 (falls verf√ºgbar)</small></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="App.Wizard.next(2)" style="margin-top:20px;">Weiter</button>
                </div>

                <div id="step-2" class="wizard-step">
                    <h3>Verf√ºgbarkeiten pr√ºfen</h3>
                    <p style="font-size:0.9rem; color:#666; margin-bottom:15px;">W√§hle Personen ab, die im gew√§hlten Zeitraum <strong>Urlaub</strong> haben (pauschal).</p>
                    <div id="gen-availability-list" class="team-grid"></div>
                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button class="btn btn-secondary" onclick="App.Wizard.next(1)">Zur√ºck</button>
                        <button class="btn btn-primary" onclick="App.Wizard.generate()">üöÄ Plan Generieren</button>
                    </div>
                </div>

                <div id="step-3" class="wizard-step">
                    <div style="text-align:center; padding:30px;">
                        <i class="fa-solid fa-check-circle" style="font-size:4rem; color:var(--c-success); margin-bottom:20px;"></i>
                        <h3>Plan erstellt!</h3>
                        <p>Der Plan wurde generiert und Konflikte gepr√ºft.</p>
                        <button class="btn btn-primary" onclick="App.nav('dashboard')">Zum Dashboard</button>
                    </div>
                </div>

            </div>
        </div>

        <div id="view-stats" class="view">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fa-solid fa-chart-pie"></i> Auswertung</h2>
                </div>
                <div style="height: 300px;">
                    <canvas id="statsChart"></canvas>
                </div>
                <div style="margin-top: 20px;">
                    <h3>Fairness-Score</h3>
                    <p style="font-size:0.9rem; color:#666;">Standardabweichung der Eins√§tze (niedriger ist fairer): <strong id="fairness-score">0</strong></p>
                </div>
            </div>
        </div>

    </main>

    <nav class="mobile-nav">
        <button class="nav-item active" onclick="App.nav('dashboard')">
            <i class="fa-solid fa-house"></i>
            <span>Home</span>
        </button>
        <button class="nav-item" onclick="App.nav('team')">
            <i class="fa-solid fa-users"></i>
            <span>Team</span>
        </button>
        <button class="nav-item" onclick="App.nav('wizard')">
            <i class="fa-solid fa-wand-magic-sparkles"></i>
            <span>Planen</span>
        </button>
        <button class="nav-item" onclick="App.nav('stats')">
            <i class="fa-solid fa-chart-simple"></i>
            <span>Stats</span>
        </button>
    </nav>

    <div id="modal-entry" class="modal-overlay">
        <div class="modal">
            <div class="card-header" style="border:none; padding:0; margin-bottom:20px;">
                <h3>Eintrag bearbeiten</h3>
                <button class="btn-ghost" onclick="App.Modals.close('entry')">&times;</button>
            </div>
            <input type="hidden" id="entry-id">
            <div class="form-grid" style="grid-template-columns: 1fr;">
                <div>
                    <label>Datum</label>
                    <input type="text" id="entry-date" placeholder="DD.MM.">
                </div>
                <div>
                    <label>Uhrzeit</label>
                    <select id="entry-time">
                        <option value="17:00 - 18:30">Fr√ºh (17:00 - 18:30)</option>
                        <option value="18:15 - 19:45">Sp√§t (18:15 - 19:45)</option>
                        <option value="custom">Benutzerdefiniert</option>
                    </select>
                    <input type="text" id="entry-time-custom" style="display:none; margin-top:5px;" placeholder="HH:MM - HH:MM">
                </div>
                <div>
                    <label>Team (Mehrfachauswahl m√∂glich)</label>
                    <div id="entry-team-select" style="display:flex; flex-wrap:wrap; gap:5px; max-height:150px; overflow-y:auto; padding:10px; border:1px solid #ddd; border-radius:8px;">
                        </div>
                </div>
                <button class="btn btn-primary" onclick="App.Actions.saveEntry()">Speichern</button>
                <button class="btn btn-danger" onclick="App.Actions.deleteEntryFromModal()" id="btn-delete-entry" style="display:none;">L√∂schen</button>
            </div>
        </div>
    </div>

    <div id="modal-export" class="modal-overlay">
        <div class="modal">
            <h3>Exportieren</h3>
            <div class="form-grid" style="grid-template-columns: 1fr;">
                <button class="btn btn-secondary" onclick="App.Export.pdf('standard')">
                    <i class="fa-solid fa-file-pdf"></i> PDF Standard (Blau)
                </button>
                <button class="btn btn-secondary" onclick="App.Export.pdf('chess')">
                    <i class="fa-solid fa-chess-knight"></i> PDF Schachclub (S/W)
                </button>
                <button class="btn btn-secondary" onclick="App.Export.pdf('list')">
                    <i class="fa-solid fa-list"></i> PDF Kompakte Liste
                </button>
                <button class="btn btn-secondary" onclick="App.Export.csv()">
                    <i class="fa-solid fa-file-csv"></i> CSV (Excel)
                </button>
                <button class="btn btn-secondary" onclick="App.Export.whatsapp()">
                    <i class="fa-brands fa-whatsapp"></i> WhatsApp Text
                </button>
            </div>
            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-ghost" onclick="App.Modals.close('export')">Schlie√üen</button>
            </div>
        </div>
    </div>

    <div id="modal-ocr" class="modal-overlay">
        <div class="modal">
            <h3>Smart Import</h3>
            <div class="drop-zone" onclick="document.getElementById('ocr-file').click()">
                <i class="fa-solid fa-cloud-arrow-up" style="font-size: 2rem;"></i>
                <p>Klicke hier oder ziehe ein Bild/CSV rein.<br>Erkennt WhatsApp Screenshots & Excel.</p>
                <input type="file" id="ocr-file" hidden onchange="App.OCR.process(this)">
            </div>
            <div id="ocr-preview" style="margin-top:15px; font-size:0.9rem; max-height:150px; overflow-y:auto;"></div>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn btn-ghost" onclick="App.Modals.close('ocr')">Abbrechen</button>
                <button class="btn btn-primary" id="ocr-confirm" disabled onclick="App.OCR.confirm()">Daten √ºbernehmen</button>
            </div>
        </div>
    </div>

    <div id="modal-member" class="modal-overlay">
        <div class="modal">
            <h3>Mitglied verwalten</h3>
            <input type="hidden" id="mem-id">
            <div class="form-grid" style="grid-template-columns: 1fr;">
                <input type="text" id="mem-name" placeholder="Name (z.B. Kaspar)">
                <select id="mem-role">
                    <option value="fixed">Stamm (Immer)</option>
                    <option value="rotate">Springer (Rotation)</option>
                    <option value="emergency">Notfall (Nur Manuell)</option>
                </select>
                <select id="mem-shift">
                    <option value="both">Beide Schichten</option>
                    <option value="early">Nur Fr√ºh (17:00)</option>
                    <option value="late">Nur Sp√§t (18:15)</option>
                </select>
                <button class="btn btn-primary" onclick="App.Team.save()">Speichern</button>
            </div>
            <button class="btn btn-ghost" onclick="App.Modals.close('member')" style="margin-top:10px; width:100%;">Abbrechen</button>
        </div>
    </div>

    <script>
        /**
         * Einsatzplaner Pro v4 Core Logic
         * Modular Architecture: Store, UI, Generator, Export, OCR
         */

        const Utils = {
            uid: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
            formatDate: (d) => {
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                return `${day}.${month}.`;
            },
            parseDateDE: (str) => {
                // Accepts DD.MM. or DD.MM.YYYY
                const parts = str.split('.');
                const d = new Date();
                d.setDate(parseInt(parts[0]));
                d.setMonth(parseInt(parts[1]) - 1);
                if (parts[2]) d.setFullYear(parseInt(parts[2]));
                return d;
            },
            getNextFriday: (date) => {
                const resultDate = new Date(date.getTime());
                resultDate.setDate(date.getDate() + (7 + 5 - date.getDay()) % 7);
                return resultDate;
            }
        };

        const Store = {
            data: {
                schedule: [],
                team: [
                    { id: '1', name: 'Kaspar', role: 'fixed', shift: 'both' },
                    { id: '2', name: 'Uwe', role: 'rotate', shift: 'late' },
                    { id: '3', name: 'Nico', role: 'rotate', shift: 'both' },
                    { id: '4', name: 'Dmitry', role: 'rotate', shift: 'both' },
                    { id: '5', name: 'Gento', role: 'rotate', shift: 'early' },
                    { id: '6', name: 'Stephan', role: 'rotate', shift: 'early' },
                    { id: '7', name: 'Markus', role: 'emergency', shift: 'both' }
                ]
            },
            load() {
                const stored = localStorage.getItem('scb_v4_data');
                if (stored) this.data = JSON.parse(stored);
            },
            save() {
                localStorage.setItem('scb_v4_data', JSON.stringify(this.data));
                App.UI.renderAll();
            },
            getMember(name) {
                return this.data.team.find(m => m.name.toLowerCase() === name.toLowerCase());
            },
            addMember(name) {
                const newM = { id: Utils.uid(), name: name, role: 'rotate', shift: 'both' };
                this.data.team.push(newM);
                this.save();
                return newM;
            }
        };

        const App = {
            init() {
                Store.load();
                this.UI.renderAll();
                
                // Set Defaults
                document.getElementById('gen-start-date').valueAsDate = Utils.getNextFriday(new Date());

                // Time Select Logic
                document.getElementById('entry-time').addEventListener('change', (e) => {
                    document.getElementById('entry-time-custom').style.display = e.target.value === 'custom' ? 'block' : 'none';
                });
                
                // Loader check
                setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
            },

            nav(view) {
                document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
                document.getElementById('view-' + view).classList.add('active');
                
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                // Highlight logic simple
                if(view === 'dashboard') document.querySelectorAll('.nav-item')[0].classList.add('active');
                if(view === 'team') document.querySelectorAll('.nav-item')[1].classList.add('active');
                
                if (window.innerWidth >= 640) {
                     document.querySelectorAll('.desktop-nav a').forEach(el => el.classList.remove('active'));
                     // simple index mapping
                     const map = {'dashboard':0, 'team':1, 'wizard':2, 'stats':3};
                     if(map[view] !== undefined) document.querySelectorAll('.desktop-nav a')[map[view]].classList.add('active');
                }

                if(view === 'stats') this.Stats.render();
            },

            UI: {
                renderAll() {
                    this.renderSchedule();
                    this.renderTeam();
                    this.updateDashboardStats();
                },

                renderSchedule() {
                    const tbody = document.getElementById('table-body');
                    tbody.innerHTML = '';
                    
                    if (Store.data.schedule.length === 0) {
                        document.getElementById('empty-state').style.display = 'block';
                        document.getElementById('main-table').style.display = 'none';
                        return;
                    }
                    
                    document.getElementById('empty-state').style.display = 'none';
                    document.getElementById('main-table').style.display = 'table';

                    // Sort: Date, then Time
                    const sorted = [...Store.data.schedule].sort((a, b) => {
                        // Simple string comparison for DD.MM. works if same year context.
                        // Better: Parse properly. 
                        const dateA = a.date.split('.').reverse().join('');
                        const dateB = b.date.split('.').reverse().join('');
                        return dateA.localeCompare(dateB) || a.time.localeCompare(b.time);
                    });

                    let lastDate = '';

                    sorted.forEach(entry => {
                        const tr = document.createElement('tr');
                        
                        // Smart Check: Duplicate on same day for same person?
                        // Conflict Detection logic visualization
                        const isConflict = false; // Placeholder for complex logic

                        if(isConflict) tr.classList.add('conflict-row');

                        // Tags for names
                        const namesHtml = entry.names.map(n => {
                            const mem = Store.getMember(n);
                            let color = '#e5e7eb'; // default
                            if(mem) {
                                if(mem.role === 'fixed') color = '#dbeafe';
                                if(mem.role === 'emergency') color = '#fee2e2';
                            }
                            return `<span style="display:inline-block; background:${color}; padding:2px 8px; border-radius:12px; font-size:0.85rem; margin-right:4px; margin-bottom:2px;">${n}</span>`;
                        }).join('');

                        const dateDisplay = entry.date === lastDate ? '<span style="opacity:0.2">"</span>' : `<strong>${entry.date}</strong>`;
                        lastDate = entry.date;

                        tr.innerHTML = `
                            <td>${dateDisplay}</td>
                            <td>${entry.time.split(' ')[0]}</td>
                            <td>${namesHtml} ${entry.aiGenerated ? '<i class="fa-solid fa-robot" style="color:#a855f7; font-size:0.7rem;" title="AI Auto-Gen"></i>' : ''}</td>
                            <td style="text-align:right;">
                                <button class="btn-ghost" onclick="App.Modals.openEntry('${entry.id}')"><i class="fa-solid fa-pen"></i></button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                },

                renderTeam() {
                    const grid = document.getElementById('team-grid');
                    grid.innerHTML = '';
                    
                    Store.data.team.forEach(m => {
                        const div = document.createElement('div');
                        div.className = 'member-card';
                        
                        let badgeClass = 'role-rotate';
                        let roleLabel = 'Springer';
                        if (m.role === 'fixed') { badgeClass = 'role-fixed'; roleLabel = 'Stamm'; }
                        if (m.role === 'emergency') { badgeClass = 'role-emergency'; roleLabel = 'Notfall'; }

                        div.innerHTML = `
                            <div>
                                <div style="font-weight:600;">${m.name}</div>
                                <div style="font-size:0.8rem; color:#666;">
                                    ${m.shift === 'both' ? 'Beide' : (m.shift==='early'?'Nur 17h':'Nur 18h')}
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <span class="role-badge ${badgeClass}">${roleLabel}</span>
                                <button class="btn-ghost" onclick="App.Modals.openMember('${m.id}')" style="margin-left:5px;"><i class="fa-solid fa-gear"></i></button>
                            </div>
                        `;
                        grid.appendChild(div);
                    });
                },
                
                updateDashboardStats() {
                    const count = Store.data.schedule.length;
                    // Logic for open shifts could be calculated here
                    const needed = 0; // Placeholder
                    document.getElementById('open-shifts-count').innerText = count;
                    
                    if(Store.data.schedule.length > 0) {
                        const next = Store.data.schedule[0]; // Assuming sorted
                        document.getElementById('next-shift-display').innerText = next.date;
                        document.getElementById('next-shift-team').innerText = next.names.join(', ');
                    }
                }
            },

            Wizard: {
                tempAvailability: [], // IDs of available members
                
                next(step) {
                    document.querySelectorAll('.wizard-step').forEach(el => el.classList.remove('active'));
                    document.querySelectorAll('.step-dot').forEach(el => el.classList.remove('active'));
                    
                    document.getElementById('step-' + step).classList.add('active');
                    document.getElementById('dot-' + step).classList.add('active');
                    
                    if(step === 2) this.renderAvailabilityCheck();
                },

                renderAvailabilityCheck() {
                    const container = document.getElementById('gen-availability-list');
                    container.innerHTML = '';
                    this.tempAvailability = Store.data.team.map(m => m.id); // Default all available

                    Store.data.team.forEach(m => {
                        const div = document.createElement('div');
                        div.className = 'member-card';
                        div.style.cursor = 'pointer';
                        div.onclick = () => {
                            const cb = div.querySelector('input');
                            cb.checked = !cb.checked;
                            if(cb.checked) App.Wizard.tempAvailability.push(m.id);
                            else App.Wizard.tempAvailability = App.Wizard.tempAvailability.filter(id => id !== m.id);
                            div.style.opacity = cb.checked ? '1' : '0.5';
                        };

                        div.innerHTML = `
                            <span style="font-weight:600;">${m.name}</span>
                            <input type="checkbox" checked style="width:20px; height:20px; pointer-events:none;">
                        `;
                        container.appendChild(div);
                    });
                },

                generate() {
                    const loader = document.getElementById('loader');
                    loader.style.display = 'flex';
                    document.getElementById('loader-text').innerText = "KI optimiert Plan...";

                    setTimeout(() => {
                        const startDate = document.getElementById('gen-start-date').valueAsDate;
                        const weeks = parseInt(document.getElementById('gen-duration').value);
                        const preferDoubles = document.getElementById('gen-pref-doubles').checked;

                        // ALGORITHM
                        let currentDate = new Date(startDate);
                        let newEntries = [];
                        
                        // History tracker for fairness
                        let history = {};
                        Store.data.team.forEach(m => history[m.id] = 0);

                        for(let i=0; i<weeks; i++) {
                            const dateStr = Utils.formatDate(currentDate);
                            
                            // Slots
                            const shifts = [
                                { time: "17:00 - 18:30", type: "early", assigned: [] },
                                { time: "18:15 - 19:45", type: "late", assigned: [] }
                            ];

                            // 1. Assign Fixed
                            shifts.forEach(shift => {
                                const fixed = Store.data.team.filter(m => 
                                    m.role === 'fixed' && 
                                    App.Wizard.tempAvailability.includes(m.id) &&
                                    (m.shift === 'both' || m.shift === shift.type)
                                );
                                fixed.forEach(m => {
                                    shift.assigned.push(m);
                                    history[m.id]++;
                                });
                            });

                            // 2. Fill Rotators
                            shifts.forEach((shift, sIdx) => {
                                const needed = 3; // Target per shift
                                let currentCount = shift.assigned.length;
                                
                                if(currentCount < needed) {
                                    // Candidates: Rotate role, Available, shift matches
                                    let candidates = Store.data.team.filter(m => 
                                        m.role === 'rotate' && 
                                        App.Wizard.tempAvailability.includes(m.id) &&
                                        (m.shift === 'both' || m.shift === shift.type) &&
                                        !shift.assigned.includes(m)
                                    );

                                    // WEIGHTING LOGIC
                                    candidates.sort((a, b) => {
                                        let scoreA = history[a.id];
                                        let scoreB = history[b.id];
                                        
                                        // Bonus: Prefer Doubles?
                                        if(preferDoubles && sIdx === 1) {
                                            // If A was in early shift (shifts[0]), give massive priority (negative score)
                                            if(shifts[0].assigned.includes(a)) scoreA -= 50;
                                            if(shifts[0].assigned.includes(b)) scoreB -= 50;
                                        }

                                        // Random noise for variation
                                        return (scoreA - scoreB) + (Math.random() - 0.5);
                                    });

                                    // Pick
                                    for(let k=0; k < (needed - currentCount); k++) {
                                        if(candidates[k]) {
                                            shift.assigned.push(candidates[k]);
                                            history[candidates[k].id]++;
                                        }
                                    }
                                }
                            });

                            // Push to result
                            shifts.forEach(s => {
                                newEntries.push({
                                    id: Utils.uid(),
                                    date: dateStr,
                                    time: s.time,
                                    names: s.assigned.map(m => m.name),
                                    aiGenerated: true
                                });
                            });

                            currentDate.setDate(currentDate.getDate() + 7);
                        }

                        // Merge logic: Append or Replace? Let's Append for safety but warn in real app.
                        Store.data.schedule = [...Store.data.schedule, ...newEntries];
                        Store.save();
                        
                        loader.style.display = 'none';
                        App.Wizard.next(3);
                    }, 800);
                }
            },

            Modals: {
                open(id) {
                    document.getElementById('modal-' + id).classList.add('open');
                    // Reset fields if needed
                    if(id === 'addEntry') {
                        this.openEntry(null); // Create new
                    }
                },
                close(id) {
                    document.getElementById('modal-' + id).classList.remove('open');
                },
                openEntry(entryId) {
                    const modal = document.getElementById('modal-entry');
                    modal.classList.add('open');
                    
                    const selectContainer = document.getElementById('entry-team-select');
                    selectContainer.innerHTML = '';
                    
                    // Render Chips for Selection
                    Store.data.team.forEach(m => {
                        const chip = document.createElement('div');
                        chip.style.padding = '5px 10px';
                        chip.style.borderRadius = '15px';
                        chip.style.border = '1px solid #ddd';
                        chip.style.cursor = 'pointer';
                        chip.innerText = m.name;
                        chip.onclick = () => {
                            chip.classList.toggle('selected');
                            chip.style.background = chip.classList.contains('selected') ? 'var(--c-primary-light)' : 'white';
                            chip.style.borderColor = chip.classList.contains('selected') ? 'var(--c-primary)' : '#ddd';
                        };
                        chip.dataset.name = m.name;
                        selectContainer.appendChild(chip);
                    });

                    if (entryId) {
                        const entry = Store.data.schedule.find(e => e.id === entryId);
                        document.getElementById('entry-id').value = entryId;
                        document.getElementById('entry-date').value = entry.date;
                        
                        const timeSelect = document.getElementById('entry-time');
                        if (entry.time.startsWith('17:00')) timeSelect.value = '17:00 - 18:30';
                        else if (entry.time.startsWith('18:15')) timeSelect.value = '18:15 - 19:45';
                        else {
                            timeSelect.value = 'custom';
                            document.getElementById('entry-time-custom').style.display = 'block';
                            document.getElementById('entry-time-custom').value = entry.time;
                        }

                        // Preselect names
                        const chips = selectContainer.querySelectorAll('div');
                        entry.names.forEach(n => {
                            chips.forEach(c => {
                                if(c.dataset.name === n) c.click(); // toggle on
                            });
                        });

                        document.getElementById('btn-delete-entry').style.display = 'inline-block';
                    } else {
                        // New Entry
                        document.getElementById('entry-id').value = '';
                        document.getElementById('entry-date').value = '';
                        document.getElementById('btn-delete-entry').style.display = 'none';
                    }
                },
                openMember(id) {
                    // Similar logic for member editing
                    const mem = Store.data.team.find(m => m.id === id);
                    if(mem) {
                        document.getElementById('mem-id').value = mem.id;
                        document.getElementById('mem-name').value = mem.name;
                        document.getElementById('mem-role').value = mem.role;
                        document.getElementById('mem-shift').value = mem.shift;
                        this.open('member');
                    }
                }
            },

            Actions: {
                saveEntry() {
                    const id = document.getElementById('entry-id').value;
                    const date = document.getElementById('entry-date').value;
                    let time = document.getElementById('entry-time').value;
                    if(time === 'custom') time = document.getElementById('entry-time-custom').value;
                    
                    const chips = document.querySelectorAll('#entry-team-select div.selected');
                    const names = Array.from(chips).map(c => c.dataset.name);
                    
                    if(!date || names.length === 0) return alert('Datum und Team fehlen.');

                    if(id) {
                        const idx = Store.data.schedule.findIndex(e => e.id === id);
                        Store.data.schedule[idx] = { ...Store.data.schedule[idx], date, time, names };
                    } else {
                        Store.data.schedule.push({ id: Utils.uid(), date, time, names, aiGenerated: false });
                    }
                    
                    Store.save();
                    App.Modals.close('entry');
                },
                deleteEntryFromModal() {
                    const id = document.getElementById('entry-id').value;
                    if(confirm('L√∂schen?')) {
                        Store.data.schedule = Store.data.schedule.filter(e => e.id !== id);
                        Store.save();
                        App.Modals.close('entry');
                    }
                }
            },

            Team: {
                save() {
                    const id = document.getElementById('mem-id').value;
                    const name = document.getElementById('mem-name').value;
                    const role = document.getElementById('mem-role').value;
                    const shift = document.getElementById('mem-shift').value;
                    
                    if(id) {
                        const idx = Store.data.team.findIndex(m => m.id === id);
                        Store.data.team[idx] = { id, name, role, shift };
                    } else {
                        Store.data.team.push({ id: Utils.uid(), name, role, shift });
                    }
                    Store.save();
                    App.Modals.close('member');
                }
            },

            OCR: {
                async process(input) {
                    if (!input.files[0]) return;
                    
                    const preview = document.getElementById('ocr-preview');
                    preview.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Analysiere...';
                    
                    const file = input.files[0];
                    // Check if CSV
                    if(file.name.endsWith('.csv')) {
                         const reader = new FileReader();
                         reader.onload = (e) => this.parseCSV(e.target.result);
                         reader.readAsText(file);
                         return;
                    }

                    // Image (Tesseract)
                    const worker = await Tesseract.createWorker('deu');
                    const ret = await worker.recognize(file);
                    await worker.terminate();

                    this.parseText(ret.data.text);
                },

                parseText(text) {
                    // Complex Regex for user's screenshot format
                    // Looking for lines like "09.01.", names, times
                    const lines = text.split('\n');
                    let found = [];
                    let lastDate = '??.??.';

                    lines.forEach(line => {
                        const dateMatch = line.match(/(\d{2}\.\d{2}\.?)/);
                        if(dateMatch) lastDate = dateMatch[1];
                        
                        // Heuristic: If line contains names from our team list
                        let foundNames = [];
                        Store.data.team.forEach(m => {
                            if(line.toLowerCase().includes(m.name.toLowerCase())) foundNames.push(m.name);
                        });
                        
                        // Also check common aliases "Du" -> Kaspar
                        if(line.includes("Du") || line.includes("Ich")) foundNames.push("Kaspar");

                        if(foundNames.length > 0) {
                            found.push({
                                date: lastDate,
                                time: line.includes('18:15') || line.includes('18:00') ? '18:15 - 19:45' : '17:00 - 18:30',
                                names: [...new Set(foundNames)] // unique
                            });
                        }
                    });
                    
                    this.renderPreview(found);
                },

                parseCSV(text) {
                    // Simple semicolon parser
                    const lines = text.split('\n');
                    let found = [];
                    lines.forEach(l => {
                        const p = l.split(';');
                        if(p.length >= 3) {
                            found.push({
                                date: p[0], time: p[1], names: p[2].split(',').map(n=>n.trim())
                            });
                        }
                    });
                    this.renderPreview(found);
                },

                renderPreview(data) {
                    const prev = document.getElementById('ocr-preview');
                    prev.innerHTML = '';
                    if(data.length === 0) {
                        prev.innerText = "Nichts erkannt."; 
                        return;
                    }
                    
                    window.tempOCRData = data;
                    
                    data.forEach(row => {
                        const d = document.createElement('div');
                        d.style.borderBottom = '1px solid #eee';
                        d.style.padding = '5px';
                        d.innerText = `${row.date} | ${row.time} | ${row.names.join(', ')}`;
                        prev.appendChild(d);
                    });
                    
                    document.getElementById('ocr-confirm').disabled = false;
                },

                confirm() {
                    if(window.tempOCRData) {
                        window.tempOCRData.forEach(row => {
                            Store.data.schedule.push({
                                id: Utils.uid(),
                                date: row.date,
                                time: row.time,
                                names: row.names,
                                aiGenerated: false
                            });
                        });
                        Store.save();
                        App.Modals.close('ocr');
                    }
                }
            },

            Stats: {
                chartInstance: null,
                render() {
                    const ctx = document.getElementById('statsChart').getContext('2d');
                    
                    // Aggregate Data
                    const counts = {};
                    Store.data.team.forEach(m => counts[m.name] = 0);
                    Store.data.schedule.forEach(e => {
                        e.names.forEach(n => {
                            if(counts[n] !== undefined) counts[n]++;
                            // Handle unknown names
                            else counts[n] = 1; 
                        });
                    });

                    // Calculate Fairness (Std Dev)
                    const values = Object.values(counts);
                    const mean = values.reduce((a,b)=>a+b,0) / values.length;
                    const variance = values.reduce((a,b)=>a + Math.pow(b-mean,2), 0) / values.length;
                    document.getElementById('fairness-score').innerText = Math.sqrt(variance).toFixed(2);

                    if(this.chartInstance) this.chartInstance.destroy();
                    
                    this.chartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(counts),
                            datasets: [{
                                label: 'Eins√§tze',
                                data: Object.values(counts),
                                backgroundColor: '#2563eb',
                                borderRadius: 5
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                        }
                    });
                }
            },

            Export: {
                pdf(design) {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Configs
                    const configs = {
                        standard: { headColor: [37, 99, 235], theme: 'grid' },
                        chess: { headColor: [0,0,0], theme: 'grid', lineColor: [0,0,0], lineWidth: 0.1 },
                        list: { headColor: [255,255,255], textColor: [0,0,0], theme: 'plain' }
                    };
                    const cfg = configs[design];

                    // Header
                    doc.setFontSize(18);
                    if(design === 'chess') doc.setFont('helvetica', 'bold');
                    doc.text("SC Brombach - Einsatzplan", 14, 20);
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    const range = Store.data.schedule.length > 0 
                        ? `${Store.data.schedule[0].date} - ${Store.data.schedule[Store.data.schedule.length-1].date}` 
                        : 'Leer';
                    doc.text(`Zeitraum: ${range}`, 14, 28);

                    // Table
                    doc.autoTable({
                        startY: 35,
                        head: [['Datum', 'Uhrzeit', 'Team']],
                        body: Store.data.schedule.map(s => [s.date, s.time, s.names.join(', ')]),
                        theme: cfg.theme,
                        headStyles: { 
                            fillColor: cfg.headColor || [255,255,255], 
                            textColor: design==='list'?[0,0,0]:[255,255,255] 
                        },
                        styles: { fontSize: 10, cellPadding: 4 },
                        columnStyles: { 0: { fontStyle: 'bold', cellWidth: 25 }, 1: { cellWidth: 35 } }
                    });

                    // Footer
                    const pageCount = doc.internal.getNumberOfPages();
                    for(let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.setFontSize(8);
                        doc.text('Erstellt mit Einsatzplaner Pro v4', 14, doc.internal.pageSize.height - 10);
                    }

                    doc.save(`plan_${design}.pdf`);
                },
                csv() {
                    // Using SheetJS if available, else simple
                    let csv = "Datum;Uhrzeit;Namen\n";
                    Store.data.schedule.forEach(r => {
                        csv += `${r.date};${r.time};${r.names.join(',')}\n`;
                    });
                    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = "plan.csv";
                    link.click();
                },
                whatsapp() {
                    let text = "*Einsatzplan SC Brombach*\n\n";
                    Store.data.schedule.forEach(r => {
                        text += `üìÖ ${r.date} (${r.time})\nüë• ${r.names.join(', ')}\n\n`;
                    });
                    // Copy to clipboard fallback
                    navigator.clipboard.writeText(text).then(() => alert("Text in Zwischenablage kopiert!"));
                }
            }
        };

        // Start
        window.onload = () => App.init();

    </script>
</body>
</html>