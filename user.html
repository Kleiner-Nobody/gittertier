<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Benutzereinstellungen - Gittertier Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    /* ==================== APPLE LIQUID GLAS DESIGN ==================== */
    :root {
        /* Light Mode - Apple Design System */
        --color-primary: #007AFF;
        --color-primary-dark: #0056CC;
        --color-accent: #5856D6;
        --color-accent-light: #AF52DE;
        --color-success: #34C759;
        --color-warning: #FF9500;
        --color-error: #FF3B30;
        --color-dark: #000000;
        --color-light: #F2F2F7;
        --color-white: #FFFFFF;
        --color-gray: #8E8E93;
        --color-gray-light: #C7C7CC;
        --color-gray-dark: #48484A;
        --color-bg: #F2F2F7;
        --color-text: #000000;
        --color-text-muted: #8E8E93;
        --color-card-bg: #FFFFFF;
        --color-card-bg-glass: rgba(255, 255, 255, 0.7);
        --color-sidebar-bg: rgba(255, 255, 255, 0.8);
        --color-modal-bg: rgba(255, 255, 255, 0.95);
        --color-overlay: rgba(0, 0, 0, 0.5);
        --color-hover-gray: rgba(142, 142, 147, 0.08);
        --color-hover-gray-medium: rgba(142, 142, 147, 0.12);
        
        /* Premium Club Specific Colors */
        --color-premium: #FFD700;
        --color-premium-dark: #FFC107;
        --color-premium-gradient: linear-gradient(135deg, #FFD700 0%, #FF9500 100%);
        --color-silver: #C0C0C0;
        --color-gold: #FFD700;
        --color-platinum: #E5E4E2;
        --color-diamond: #B9F2FF;
        --color-premium-accent: linear-gradient(135deg, #FFD700 0%, #FF9F0A 100%);
        
        /* Apple Liquid Glas Effects */
        --glass-blur: blur(20px);
        --glass-border: 1px solid rgba(255, 255, 255, 0.2);
        --glass-border-dark: 1px solid rgba(0, 0, 0, 0.1);
        --glass-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        --glass-shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.12);
        --glass-shadow-xl: 0 12px 60px rgba(0, 0, 0, 0.16);
        
        --radius: 16px;
        --radius-sm: 8px;
        --radius-lg: 24px;
        --radius-xl: 28px;
        
        --transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
        --transition-slow: all 0.5s cubic-bezier(0.2, 0, 0, 1);
        
        /* Gradients */
        --gradient-primary: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
        --gradient-accent: linear-gradient(135deg, #5856D6 0%, #AF52DE 100%);
        --gradient-success: linear-gradient(135deg, #34C759 0%, #30D158 100%);
        --gradient-warning: linear-gradient(135deg, #FF9500 0%, #FF9F0A 100%);
        --gradient-error: linear-gradient(135deg, #FF3B30 0%, #FF453A 100%);
        --gradient-glass: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.4));
        --gradient-glass-dark: linear-gradient(135deg, rgba(28, 28, 30, 0.8), rgba(28, 28, 30, 0.4));
        --gradient-gray-hover: linear-gradient(135deg, rgba(142, 142, 147, 0.08), rgba(142, 142, 147, 0.12));
        --gradient-premium: linear-gradient(135deg, #FFD700 0%, #FF9F0A 100%);
        --gradient-silver: linear-gradient(135deg, #C0C0C0 0%, #A0A0A0 100%);
        --gradient-gold: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        --gradient-platinum: linear-gradient(135deg, #E5E4E2 0%, #C0C0C0 100%);
        --gradient-diamond: linear-gradient(135deg, #B9F2FF 0%, #66A6FF 100%);
        
        /* Font Sizes */
        --text-xs: 0.75rem;
        --text-sm: 0.875rem;
        --text-base: 1rem;
        --text-lg: 1.125rem;
        --text-xl: 1.25rem;
        --text-2xl: 1.5rem;
        --text-3xl: 1.875rem;
        --text-4xl: 2.25rem;
        
        /* Spacing */
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;
        --spacing-xxl: 48px;
        
        /* Layout */
        --header-height: 64px;
        --sidebar-width: 280px;
        --sidebar-width-collapsed: 80px;
        --touch-target: 44px;
        
        /* Depth */
        --depth-1: 0 1px 3px rgba(0, 0, 0, 0.07);
        --depth-2: 0 4px 12px rgba(0, 0, 0, 0.1);
        --depth-3: 0 10px 30px rgba(0, 0, 0, 0.15);
        --depth-4: 0 20px 50px rgba(0, 0, 0, 0.2);
        
        /* Apple System Font Stack */
        --font-system: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    /* Auto Dark Mode based on system preference */
    @media (prefers-color-scheme: dark) {
        :root {
            --color-bg: #000000;
            --color-text: #FFFFFF;
            --color-text-muted: #8E8E93;
            --color-card-bg: #1C1C1E;
            --color-card-bg-glass: rgba(28, 28, 30, 0.7);
            --color-sidebar-bg: rgba(28, 28, 30, 0.8);
            --color-modal-bg: rgba(28, 28, 30, 0.95);
            --color-overlay: rgba(0, 0, 0, 0.7);
            --color-light: #2C2C2E;
            --color-gray: #8E8E93;
            --color-gray-light: #48484A;
            --color-gray-dark: #C7C7CC;
            --color-white: #1C1C1E;
            --color-hover-gray: rgba(174, 174, 178, 0.08);
            --color-hover-gray-medium: rgba(174, 174, 178, 0.12);
            
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --glass-border-dark: 1px solid rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            --glass-shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.4);
            --glass-shadow-xl: 0 12px 60px rgba(0, 0, 0, 0.5);
            
            --gradient-gray-hover: linear-gradient(135deg, rgba(174, 174, 178, 0.08), rgba(174, 174, 178, 0.12));
            --gradient-glass: linear-gradient(135deg, rgba(28, 28, 30, 0.8), rgba(28, 28, 30, 0.4));
            
            --depth-1: 0 1px 3px rgba(0, 0, 0, 0.3);
            --depth-2: 0 4px 12px rgba(0, 0, 0, 0.4);
            --depth-3: 0 10px 30px rgba(0, 0, 0, 0.5);
            --depth-4: 0 20px 50px rgba(0, 0, 0, 0.6);
            
            --gradient-premium: linear-gradient(135deg, #FFC107 0%, #FF8F00 100%);
        }
    }

    /* Manual Dark Mode Class */
    .dark-mode {
        --color-bg: #000000;
        --color-text: #FFFFFF;
        --color-text-muted: #8E8E93;
        --color-card-bg: #1C1C1E;
        --color-card-bg-glass: rgba(28, 28, 30, 0.7);
        --color-sidebar-bg: rgba(28, 28, 30, 0.8);
        --color-modal-bg: rgba(28, 28, 30, 0.95);
        --color-overlay: rgba(0, 0, 0, 0.7);
        --color-light: #2C2C2E;
        --color-gray: #8E8E93;
        --color-gray-light: #48484A;
        --color-gray-dark: #C7C7CC;
        --color-white: #1C1C1E;
        --color-hover-gray: rgba(174, 174, 178, 0.08);
        --color-hover-gray-medium: rgba(174, 174, 178, 0.12);
        
        --glass-border: 1px solid rgba(255, 255, 255, 0.1);
        --glass-border-dark: 1px solid rgba(255, 255, 255, 0.1);
        --glass-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        --glass-shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.4);
        --glass-shadow-xl: 0 12px 60px rgba(0, 0, 0, 0.5);
        
        --gradient-gray-hover: linear-gradient(135deg, rgba(174, 174, 178, 0.08), rgba(174, 174, 178, 0.12));
        --gradient-glass: linear-gradient(135deg, rgba(28, 28, 30, 0.8), rgba(28, 28, 30, 0.4));
        
        --depth-1: 0 1px 3px rgba(0, 0, 0, 0.3);
        --depth-2: 0 4px 12px rgba(0, 0, 0, 0.4);
        --depth-3: 0 10px 30px rgba(0, 0, 0, 0.5);
        --depth-4: 0 20px 50px rgba(0, 0, 0, 0.6);
        
        --gradient-premium: linear-gradient(135deg, #FFC107 0%, #FF8F00 100%);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
    }

    body {
        font-family: var(--font-system);
        background: var(--color-bg);
        color: var(--color-text);
        line-height: 1.6;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow-x: hidden;
        transition: var(--transition-slow);
    }

    /* ==================== HEADER - APPLE STYLE ==================== */
    .admin-header {
        height: var(--header-height);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 var(--spacing-lg);
        position: sticky;
        top: 0;
        z-index: 100;
        background: var(--color-card-bg-glass);
        backdrop-filter: var(--glass-blur);
        -webkit-backdrop-filter: var(--glass-blur);
        border-bottom: var(--glass-border);
        min-height: var(--touch-target);
    }

    @media (max-width: 480px) {
        .admin-header {
            padding: 0 var(--spacing-sm);
        }
    }

    .logo {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        font-weight: 700;
        font-size: var(--text-xl);
        color: var(--color-primary);
        min-height: var(--touch-target);
    }

    .logo i {
        font-size: var(--text-xl);
        color: var(--color-primary);
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .header-controls {
        display: flex;
        gap: var(--spacing-sm);
        align-items: center;
    }

    .time-display {
        background: var(--gradient-glass);
        backdrop-filter: var(--glass-blur);
        -webkit-backdrop-filter: var(--glass-blur);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius);
        font-size: var(--text-sm);
        color: var(--color-text);
        min-height: var(--touch-target);
        display: flex;
        align-items: center;
        border: var(--glass-border);
        box-shadow: var(--glass-shadow);
    }

    .logout-btn, .admin-btn {
        background: var(--gradient-glass);
        backdrop-filter: var(--glass-blur);
        -webkit-backdrop-filter: var(--glass-blur);
        color: var(--color-text);
        border: var(--glass-border);
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        min-height: var(--touch-target);
        min-width: var(--touch-target);
        box-shadow: var(--glass-shadow);
        text-decoration: none;
    }

    .logout-btn:hover, .logout-btn:active, .logout-btn:focus,
    .admin-btn:hover, .admin-btn:active, .admin-btn:focus {
        background: var(--gradient-gray-hover);
        transform: translateY(-1px);
        box-shadow: var(--glass-shadow-lg);
    }

    /* ==================== MAIN CONTENT ==================== */
    .admin-content {
        flex: 1;
        padding: var(--spacing-lg);
        transition: margin-left 0.4s cubic-bezier(0.2, 0, 0, 1);
        overflow-x: hidden;
        background: var(--color-bg);
    }

    @media (max-width: 768px) {
        .admin-content {
            padding: var(--spacing-md);
        }
    }

    /* ==================== PAGE HEADER ==================== */
    .page-header {
        margin-bottom: var(--spacing-xl);
    }

    .page-title {
        font-size: var(--text-2xl);
        font-weight: 700;
        margin-bottom: var(--spacing-sm);
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        line-height: 1.2;
    }

    .page-subtitle {
        color: var(--color-text-muted);
        max-width: 600px;
        line-height: 1.4;
    }

    /* ==================== USER PROFILE SECTION ==================== */
    .user-profile-section {
        margin-bottom: var(--spacing-xl);
    }

    .profile-card {
        background: var(--color-card-bg-glass);
        backdrop-filter: var(--glass-blur);
        -webkit-backdrop-filter: var(--glass-blur);
        border-radius: var(--radius-lg);
        border: var(--glass-border);
        padding: var(--spacing-xl);
        display: flex;
        align-items: center;
        gap: var(--spacing-xl);
        box-shadow: var(--glass-shadow);
        transition: var(--transition);
    }

    .profile-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--glass-shadow-lg);
    }

    .profile-avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: var(--gradient-premium);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-3xl);
        color: #000000;
        box-shadow: var(--glass-shadow);
        flex-shrink: 0;
    }

    .profile-info {
        flex: 1;
    }

    .profile-name {
        font-size: var(--text-xl);
        font-weight: 700;
        margin-bottom: var(--spacing-xs);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .profile-role {
        color: var(--color-text-muted);
        margin-bottom: var(--spacing-md);
        font-size: var(--text-sm);
    }

    .profile-stats {
        display: flex;
        gap: var(--spacing-xl);
        flex-wrap: wrap;
    }

    .profile-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--gradient-glass);
        border-radius: var(--radius);
        border: var(--glass-border);
        min-width: 100px;
    }

    .profile-stat-value {
        font-size: var(--text-xl);
        font-weight: 700;
        margin-bottom: var(--spacing-xs);
    }

    .profile-stat-label {
        font-size: var(--text-xs);
        color: var(--color-text-muted);
        text-align: center;
    }

    /* ==================== LOYALTY STATUS SECTION ==================== */
    .loyalty-status-section {
        margin-bottom: var(--spacing-xl);
    }

    .loyalty-status-card {
        background: var(--color-card-bg-glass);
        backdrop-filter: var(--glass-blur);
        -webkit-backdrop-filter: var(--glass-blur);
        border-radius: var(--radius-lg);
        border: var(--glass-border);
        padding: var(--spacing-xl);
        box-shadow: var(--glass-shadow);
        transition: var(--transition);
    }

    .loyalty-status-card.premium {
        background: linear-gradient(135deg, var(--color-card-bg-glass) 0%, rgba(255, 215, 0, 0.1) 100%);
        border-color: var(--color-premium);
    }

    .status-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-xl);
        flex-wrap: wrap;
        gap: var(--spacing-lg);
    }

    .points-display {
        display: flex;
        align-items: center;
        gap: var(--spacing-xl);
    }

    .points-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-2xl);
        background: var(--gradient-premium);
        color: #000000;
        box-shadow: var(--glass-shadow);
    }

    .points-info h3 {
        font-size: var(--text-lg);
        font-weight: 700;
        margin-bottom: var(--spacing-sm);
    }

    .points-amount {
        font-size: var(--text-3xl);
        font-weight: 900;
        color: var(--color-premium);
        line-height: 1;
        margin-bottom: var(--spacing-xs);
    }

    .points-label {
        color: var(--color-text-muted);
        font-size: var(--text-sm);
    }

    .tier-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-lg);
        border-radius: 50px;
        font-weight: 700;
        background: var(--gradient-premium);
        color: #000000;
        box-shadow: var(--glass-shadow);
        font-size: var(--text-lg);
    }

    .tier-badge i {
        font-size: var(--text-xl);
    }

    .progress-container {
        margin-top: var(--spacing-lg);
    }

    .progress-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: var(--spacing-sm);
        font-weight: 600;
        color: var(--color-text);
    }

    .progress-bar {
        height: 12px;
        background: var(--color-light);
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: var(--spacing-md);
    }

    .progress-fill {
        height: 100%;
        border-radius: 6px;
        background: var(--gradient-premium);
        transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .progress-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        animation: shimmer 2s infinite;
    }

    /* ==================== SETTINGS SECTIONS ==================== */
    .settings-section {
        margin-bottom: var(--spacing-xl);
    }

    .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: var(--spacing-lg);
        margin-top: var(--spacing-lg);
    }

    @media (max-width: 768px) {
        .settings-grid {
            grid-template-columns: 1fr;
        }
    }

    .settings-card {
        background: var(--color-card-bg-glass);
        backdrop-filter: var(--glass-blur);
        -webkit-backdrop-filter: var(--glass-blur);
        border-radius: var(--radius-lg);
        border: var(--glass-border);
        padding: var(--spacing-xl);
        box-shadow: var(--glass-shadow);
        transition: var(--transition);
    }

    .settings-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--glass-shadow-lg);
    }

    .settings-card.premium {
        border: 2px solid transparent;
        background: linear-gradient(var(--color-card-bg-glass), var(--color-card-bg-glass)) padding-box,
                    var(--gradient-premium) border-box;
    }

    .settings-card-header {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
        padding-bottom: var(--spacing-md);
        border-bottom: 1px solid var(--color-hover-gray);
    }

    .settings-card-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: var(--text-lg);
        background: var(--gradient-glass);
        color: var(--color-text);
        border: var(--glass-border);
    }

    .settings-card-title {
        font-size: var(--text-lg);
        font-weight: 700;
        flex: 1;
    }

    .premium-badge {
        background: var(--gradient-premium);
        color: #000000;
        font-size: var(--text-xs);
        padding: 4px 8px;
        border-radius: 10px;
        font-weight: 700;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .settings-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
    }

    .setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md);
        border-radius: var(--radius);
        background: var(--gradient-glass);
        border: var(--glass-border);
        transition: var(--transition);
    }

    .setting-item:hover {
        background: var(--color-hover-gray);
    }

    .setting-info {
        flex: 1;
    }

    .setting-label {
        font-weight: 600;
        margin-bottom: var(--spacing-xs);
        color: var(--color-text);
    }

    .setting-description {
        font-size: var(--text-sm);
        color: var(--color-text-muted);
        line-height: 1.4;
    }

    .setting-control {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 52px;
        height: 28px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--color-gray-light);
        transition: var(--transition);
        border-radius: 34px;
        border: var(--glass-border);
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 4px;
        bottom: 3px;
        background-color: white;
        transition: var(--transition);
        border-radius: 50%;
        box-shadow: var(--glass-shadow);
    }

    input:checked + .toggle-slider {
        background: var(--gradient-primary);
    }

    input:checked + .toggle-slider:before {
        transform: translateX(24px);
    }

    .select-control {
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius);
        background: var(--color-card-bg);
        border: var(--glass-border);
        color: var(--color-text);
        font-family: var(--font-system);
        font-size: var(--text-sm);
        min-width: 120px;
        cursor: pointer;
        transition: var(--transition);
    }

    .select-control:hover {
        background: var(--color-hover-gray);
    }

    .select-control:focus {
        outline: none;
        border-color: var(--color-primary);
    }

    .button-control {
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius);
        background: var(--gradient-primary);
        color: white;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        font-size: var(--text-sm);
    }

    .button-control:hover {
        transform: translateY(-1px);
        box-shadow: var(--glass-shadow);
    }

    .button-control.premium {
        background: var(--gradient-premium);
        color: #000000;
    }

    .button-control:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .setting-cost {
        background: var(--gradient-premium);
        color: #000000;
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius);
        font-weight: 700;
        font-size: var(--text-sm);
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
    }

    .setting-cost i {
        font-size: var(--text-xs);
    }

    .setting-status {
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--radius);
        font-size: var(--text-xs);
        font-weight: 600;
    }

    .status-active {
        background: rgba(52, 199, 89, 0.15);
        color: var(--color-success);
    }

    .status-inactive {
        background: rgba(142, 142, 147, 0.15);
        color: var(--color-gray);
    }

    .status-locked {
        background: rgba(255, 149, 0, 0.15);
        color: var(--color-warning);
    }

    /* ==================== MODAL SYSTEM ==================== */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--color-overlay);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        display: none;
        padding: var(--spacing-md);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }

    .modal-overlay.active {
        display: flex;
        animation: fadeIn 0.3s ease;
    }

    .modal {
        background: var(--color-modal-bg);
        backdrop-filter: var(--glass-blur);
        -webkit-backdrop-filter: var(--glass-blur);
        border-radius: var(--radius-xl);
        padding: var(--spacing-xl);
        width: 100%;
        max-width: 500px;
        box-shadow: var(--glass-shadow-xl);
        border: var(--glass-border);
        animation: scaleIn 0.3s cubic-bezier(0.2, 0, 0, 1);
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal.premium {
        background: var(--gradient-premium);
        color: #000000;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
    }

    .modal-title {
        font-size: var(--text-xl);
        font-weight: 600;
        line-height: 1.2;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }

    .close-modal {
        background: var(--gradient-glass);
        border: var(--glass-border);
        font-size: var(--text-xl);
        color: var(--color-text);
        cursor: pointer;
        width: var(--touch-target);
        height: var(--touch-target);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: var(--transition);
    }

    .close-modal:hover, .close-modal:active, .close-modal:focus {
        background: var(--color-hover-gray);
        transform: rotate(90deg);
    }

    .modal-content {
        margin-bottom: var(--spacing-lg);
    }

    .modal-message {
        margin-bottom: var(--spacing-lg);
        line-height: 1.5;
        color: var(--color-text);
    }

    .modal-input {
        width: 100%;
        padding: var(--spacing-md);
        border-radius: var(--radius);
        border: var(--glass-border);
        background: var(--color-card-bg);
        color: var(--color-text);
        font-family: var(--font-system);
        font-size: var(--text-base);
        margin-bottom: var(--spacing-md);
        transition: var(--transition);
    }

    .modal-input:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    .modal-footer {
        display: flex;
        gap: var(--spacing-md);
        margin-top: var(--spacing-lg);
    }

    .modal-btn {
        flex: 1;
        padding: var(--spacing-md);
        border-radius: var(--radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        border: none;
        font-size: var(--text-base);
        text-align: center;
    }

    .modal-btn.primary {
        background: var(--gradient-primary);
        color: white;
    }

    .modal-btn.secondary {
        background: var(--gradient-glass);
        color: var(--color-text);
        border: var(--glass-border);
    }

    .modal-btn.premium {
        background: var(--gradient-premium);
        color: #000000;
    }

    .modal-btn:hover {
        transform: translateY(-1px);
        box-shadow: var(--glass-shadow);
    }

    .modal-btn:active {
        transform: translateY(0);
    }

    .modal-icon {
        font-size: 3rem;
        text-align: center;
        margin-bottom: var(--spacing-lg);
        color: var(--color-primary);
    }

    .modal-icon.premium {
        color: #000000;
    }

    .modal-cost {
        background: rgba(255, 215, 0, 0.2);
        border: 1px solid rgba(255, 215, 0, 0.3);
        border-radius: var(--radius);
        padding: var(--spacing-md);
        text-align: center;
        margin-bottom: var(--spacing-lg);
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
    }

    .modal-cost i {
        color: var(--color-premium);
    }

    /* ==================== TUTORIAL SYSTEM ==================== */
    .tutorial-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 3000;
        display: none;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }

    .tutorial-overlay.active {
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
    }

    .tutorial-container {
        background: var(--color-modal-bg);
        backdrop-filter: var(--glass-blur);
        -webkit-backdrop-filter: var(--glass-blur);
        border-radius: var(--radius-xl);
        padding: var(--spacing-xl);
        width: 90%;
        max-width: 500px;
        box-shadow: var(--glass-shadow-xl);
        border: var(--glass-border);
        animation: scaleIn 0.3s cubic-bezier(0.2, 0, 0, 1);
    }

    .tutorial-slide {
        display: none;
    }

    .tutorial-slide.active {
        display: block;
    }

    .tutorial-icon {
        font-size: 3rem;
        color: var(--color-primary);
        text-align: center;
        margin-bottom: var(--spacing-lg);
    }

    .tutorial-title {
        font-size: var(--text-xl);
        font-weight: 700;
        margin-bottom: var(--spacing-md);
        text-align: center;
    }

    .tutorial-content {
        color: var(--color-text-muted);
        margin-bottom: var(--spacing-xl);
        text-align: center;
        line-height: 1.5;
    }

    .tutorial-indicators {
        display: flex;
        justify-content: center;
        gap: var(--spacing-sm);
        margin: var(--spacing-lg) 0;
    }

    .tutorial-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--color-gray-light);
        cursor: pointer;
        transition: var(--transition);
    }

    .tutorial-indicator.active {
        background: var(--color-primary);
        transform: scale(1.2);
    }

    .tutorial-navigation {
        display: flex;
        justify-content: space-between;
        gap: var(--spacing-md);
        margin-top: var(--spacing-xl);
    }

    .tutorial-btn {
        padding: var(--spacing-md) var(--spacing-lg);
        border: none;
        border-radius: var(--radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        flex: 1;
        text-align: center;
    }

    .tutorial-btn.prev {
        background: var(--gradient-glass);
        color: var(--color-text);
        border: var(--glass-border);
    }

    .tutorial-btn.next {
        background: var(--gradient-primary);
        color: white;
    }

    .tutorial-btn:hover {
        transform: translateY(-1px);
        box-shadow: var(--glass-shadow);
    }

    /* ==================== CONFETTI EFFECT ==================== */
    .confetti-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1000;
        display: none;
    }

    .confetti {
        position: absolute;
        width: 10px;
        height: 10px;
        opacity: 0.8;
        animation: confetti 2s ease-out forwards;
    }

    /* ==================== NOTIFICATION ==================== */
    .notification {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: var(--color-card-bg);
        backdrop-filter: var(--glass-blur);
        -webkit-backdrop-filter: var(--glass-blur);
        border-radius: var(--radius);
        padding: var(--spacing-md) var(--spacing-lg);
        box-shadow: var(--glass-shadow-xl);
        border: var(--glass-border);
        z-index: 4000;
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        max-width: 90%;
        transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1);
    }

    .notification.show {
        transform: translateX(-50%) translateY(0);
    }

    .notification.success {
        background: linear-gradient(135deg, rgba(52, 199, 89, 0.9), rgba(52, 199, 89, 0.7));
        color: white;
        border-color: rgba(52, 199, 89, 0.3);
    }

    .notification.error {
        background: linear-gradient(135deg, rgba(255, 59, 48, 0.9), rgba(255, 59, 48, 0.7));
        color: white;
        border-color: rgba(255, 59, 48, 0.3);
    }

    .notification.warning {
        background: linear-gradient(135deg, rgba(255, 149, 0, 0.9), rgba(255, 149, 0, 0.7));
        color: white;
        border-color: rgba(255, 149, 0, 0.3);
    }

    .notification.info {
        background: linear-gradient(135deg, rgba(0, 122, 255, 0.9), rgba(0, 122, 255, 0.7));
        color: white;
        border-color: rgba(0, 122, 255, 0.3);
    }

    .notification-icon {
        font-size: var(--text-lg);
    }

    .notification-message {
        flex: 1;
        font-weight: 500;
    }

    /* ==================== ANIMATIONS ==================== */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes scaleIn {
        from { transform: scale(0.95); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    @keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
    }

    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    @keyframes confetti {
        0% {
            transform: translateY(0) rotate(0deg);
            opacity: 1;
        }
        100% {
            transform: translateY(100vh) rotate(720deg);
            opacity: 0;
        }
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* ==================== RESPONSIVE DESIGN ==================== */
    @media (max-width: 768px) {
        .admin-header {
            padding: 0 var(--spacing-sm);
        }
        
        .admin-content {
            padding: var(--spacing-md);
        }
        
        .status-header {
            flex-direction: column;
            align-items: flex-start;
            gap: var(--spacing-md);
        }
        
        .points-display {
            flex-direction: column;
            align-items: flex-start;
            gap: var(--spacing-md);
        }
        
        .points-icon {
            width: 60px;
            height: 60px;
            font-size: var(--text-xl);
        }
        
        .profile-card {
            flex-direction: column;
            text-align: center;
            gap: var(--spacing-lg);
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            font-size: var(--text-2xl);
        }
        
        .profile-stats {
            justify-content: center;
        }
        
        .profile-stat {
            min-width: 80px;
        }
        
        .settings-grid {
            grid-template-columns: 1fr;
        }
        
        .modal {
            padding: var(--spacing-lg);
        }
        
        .modal-footer {
            flex-direction: column;
        }
        
        .time-display {
            display: none;
        }
        
        .logout-btn span, .admin-btn span {
            display: none;
        }
        
        .logout-btn, .admin-btn {
            width: var(--touch-target);
            padding: var(--spacing-sm);
            justify-content: center;
        }
        
        .page-title {
            font-size: var(--text-xl);
        }
        
        .page-subtitle {
            font-size: var(--text-sm);
        }
        
        .tutorial-container {
            padding: var(--spacing-lg);
        }
        
        .tutorial-navigation {
            flex-direction: column;
        }
        
        .setting-item {
            flex-direction: column;
            align-items: flex-start;
            gap: var(--spacing-md);
        }
        
        .setting-control {
            width: 100%;
            justify-content: flex-end;
        }
    }

    @media (max-width: 480px) {
        .tutorial-container {
            padding: var(--spacing-md);
        }
        
        .profile-stat {
            min-width: 70px;
            padding: var(--spacing-xs) var(--spacing-sm);
        }
        
        .profile-stat-value {
            font-size: var(--text-lg);
        }
        
        .modal {
            padding: var(--spacing-md);
        }
        
        .modal-btn {
            padding: var(--spacing-sm);
        }
        
        .notification {
            padding: var(--spacing-sm) var(--spacing-md);
        }
    }

    /* Landscape orientation */
    @media (max-height: 600px) and (orientation: landscape) {
        .modal {
            max-height: 85vh;
        }
        
        .tutorial-container {
            max-height: 80vh;
            overflow-y: auto;
        }
    }

    /* High-resolution displays */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
        .settings-card,
        .loyalty-status-card,
        .profile-card {
            border-width: 0.5px;
        }
    }

    /* Reduced motion preference */
    @media (prefers-reduced-motion: reduce) {
        * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
        
        .points-icon {
            animation: none;
        }
    }

    /* iOS specific styles */
    @supports (-webkit-touch-callout: none) {
        .modal {
            padding-bottom: calc(var(--spacing-xl) + env(safe-area-inset-bottom));
        }
    }

    /* Enhanced mobile accessibility */
    @media (hover: none) and (pointer: coarse) {
        .setting-item,
        .modal-btn,
        .tutorial-btn,
        .logout-btn,
        .admin-btn,
        .close-modal,
        .button-control {
            min-height: 48px;
        }
        
        .toggle-switch {
            width: 60px;
            height: 32px;
        }
        
        .toggle-slider:before {
            width: 24px;
            height: 24px;
            left: 4px;
            bottom: 4px;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(28px);
        }
    }

    /* Improved touch feedback */
    .touch-feedback:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
    }

    /* Better focus styles for accessibility */
    *:focus-visible {
        outline: 2px solid var(--color-primary);
        outline-offset: 2px;
    }

    /* Loading states */
    .loading {
        opacity: 0.7;
        pointer-events: none;
        position: relative;
    }

    .loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 24px;
        height: 24px;
        border: 2px solid var(--glass-border);
        border-top-color: var(--color-primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-top: -12px;
        margin-left: -12px;
    }

    /* Improved scrollbars */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--color-light);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: var(--color-gray-light);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--color-gray);
    }

    /* Empty states */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: var(--spacing-xl);
        text-align: center;
        color: var(--color-text-muted);
        grid-column: 1 / -1;
    }

    .empty-state i {
        font-size: var(--text-3xl);
        margin-bottom: var(--spacing-md);
        opacity: 0.5;
    }

    .empty-state p {
        font-size: var(--text-sm);
        line-height: 1.4;
    }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="logo">
            <i class="fas fa-user-cog"></i>
            <span>Einstellungen</span>
        </div>
        <div class="header-controls">
            <div class="time-display" id="timeDisplay"></div>
            <a href="admin" class="admin-btn" id="adminBtn" aria-label="Admin Login">
                <i class="fas fa-lock"></i>
                <span>Admin</span>
            </a>
            <button class="logout-btn" id="logoutBtn" aria-label="Zurück zum Scanner">
                <i class="fas fa-arrow-left"></i>
                <span>Zurück</span>
            </button>
        </div>
    </div>

    <main class="admin-content" id="main-content">
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-user-cog"></i>
                Benutzereinstellungen
            </h1>
            <p class="page-subtitle" id="page-subtitle">
                Personalisieren Sie Ihre Erfahrung und verwalten Sie Ihre Premium-Club-Vorteile.
            </p>
            <button class="button-control" id="tutorial-btn" style="margin-top: var(--spacing-md);">
                <i class="fas fa-graduation-cap"></i>
                Tutorial starten
            </button>
        </div>

        <!-- User Profile Section -->
        <section class="user-profile-section">
            <div class="profile-card">
                <div class="profile-avatar" id="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="profile-info">
                    <div class="profile-name">
                        <span id="user-name">Benutzer</span>
                        <button class="button-control premium" id="change-name-btn" style="padding: var(--spacing-xs) var(--spacing-sm);">
                            <i class="fas fa-edit"></i>
                            Ändern
                        </button>
                    </div>
                    <div class="profile-role" id="user-role">Standard Benutzer</div>
                    <div class="profile-stats">
                        <div class="profile-stat">
                            <div class="profile-stat-value" id="total-scans">0</div>
                            <div class="profile-stat-label">Gescannte Artikel</div>
                        </div>
                        <div class="profile-stat">
                            <div class="profile-stat-value" id="total-sales">0</div>
                            <div class="profile-stat-label">Verkäufe</div>
                        </div>
                        <div class="profile-stat">
                            <div class="profile-stat-value" id="session-time">0h</div>
                            <div class="profile-stat-label">Sitzungszeit</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Loyalty Status Section -->
        <section class="loyalty-status-section">
            <h2 class="section-title">Premium Club Status</h2>
            <div class="loyalty-status-card" id="loyalty-status-card">
                <div class="status-header">
                    <div class="points-display">
                        <div class="points-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="points-info">
                            <h3>Ihre Premium Punkte</h3>
                            <div class="points-amount" id="user-points">0</div>
                            <div class="points-label">Gesammelte Punkte</div>
                        </div>
                    </div>
                    <div class="tier-badge" id="user-tier-badge">
                        <i class="fas fa-medal"></i>
                        <span id="user-tier">Bronze</span>
                    </div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Fortschritt zum nächsten Level</span>
                        <span id="progress-text">0/500</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                </div>
                
                <div style="display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-lg);">
                    <button class="button-control premium" id="join-premium-btn" style="flex: 1;">
                        <i class="fas fa-crown"></i>
                        Premium beitreten
                    </button>
                    <button class="button-control" id="view-premium-btn" style="flex: 1;">
                        <i class="fas fa-gem"></i>
                        Club ansehen
                    </button>
                </div>
            </div>
        </section>

        <!-- Scanner Settings Section -->
        <section class="settings-section">
            <h2 class="section-title">Scanner Einstellungen</h2>
            <div class="settings-grid">
                <div class="settings-card">
                    <div class="settings-card-header">
                        <div class="settings-card-icon">
                            <i class="fas fa-camera"></i>
                        </div>
                        <h3 class="settings-card-title">Scanner Verhalten</h3>
                    </div>
                    <div class="settings-list">
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Kontinuierliches Scannen</div>
                                <div class="setting-description">Scanner automatisch nach jedem Scan neu starten</div>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="continuous-scan">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Auto-Zum-Warenkorb</div>
                                <div class="setting-description">Gescannte Artikel automatisch hinzufügen</div>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="auto-add-cart">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="setting-item premium-setting" data-cost="50">
                            <div class="setting-info">
                                <div class="setting-label">Scanner Animation</div>
                                <div class="setting-description">Spezielle Puls-Animation für den Scanner</div>
                                <div class="premium-badge">
                                    <i class="fas fa-crown"></i>
                                    PREMIUM
                                </div>
                            </div>
                            <div class="setting-control">
                                <div class="setting-status status-locked" id="scanner-animation-status">
                                    <i class="fas fa-lock"></i> Gesperrt
                                </div>
                                <button class="button-control premium" onclick="showPurchaseModal('scanner_animation', 'Scanner Animation', 50)">
                                    Freischalten
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="settings-card-header">
                        <div class="settings-card-icon">
                            <i class="fas fa-volume-up"></i>
                        </div>
                        <h3 class="settings-card-title">Ton Einstellungen</h3>
                    </div>
                    <div class="settings-list">
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Scan-Ton</div>
                                <div class="setting-description">Ton bei erfolgreichem Scan abspielen</div>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="scan-sound">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Erfolgs-Ton</div>
                                <div class="setting-description">Ton bei erfolgreicher Aktion abspielen</div>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="success-sound">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="setting-item premium-setting" data-cost="75">
                            <div class="setting-info">
                                <div class="setting-label">Premium Sounds</div>
                                <div class="setting-description">Exklusive Soundeffekte für Premium-Mitglieder</div>
                                <div class="premium-badge">
                                    <i class="fas fa-crown"></i>
                                    PREMIUM
                                </div>
                            </div>
                            <div class="setting-control">
                                <div class="setting-status status-locked" id="premium-sounds-status">
                                    <i class="fas fa-lock"></i> Gesperrt
                                </div>
                                <button class="button-control premium" onclick="showPurchaseModal('premium_sounds', 'Premium Sounds', 75)">
                                    Freischalten
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Appearance Settings Section -->
        <section class="settings-section">
            <h2 class="section-title">Darstellung</h2>
            <div class="settings-grid">
                <div class="settings-card">
                    <div class="settings-card-header">
                        <div class="settings-card-icon">
                            <i class="fas fa-palette"></i>
                        </div>
                        <h3 class="settings-card-title">Thema & Farben</h3>
                    </div>
                    <div class="settings-list">
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Automatischer Dark Mode</div>
                                <div class="setting-description">Theme basierend auf Systemeinstellung</div>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="auto-dark-mode" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="setting-item premium-setting" data-cost="100">
                            <div class="setting-info">
                                <div class="setting-label">Dark Mode Plus</div>
                                <div class="setting-description">Erweiterter Dark Mode mit mehr Optionen</div>
                                <div class="premium-badge">
                                    <i class="fas fa-crown"></i>
                                    PREMIUM
                                </div>
                            </div>
                            <div class="setting-control">
                                <div class="setting-status status-locked" id="dark-mode-plus-status">
                                    <i class="fas fa-lock"></i> Gesperrt
                                </div>
                                <button class="button-control premium" onclick="showPurchaseModal('dark_mode_plus', 'Dark Mode Plus', 100)">
                                    Freischalten
                                </button>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Schriftgröße</div>
                                <div class="setting-description">Anpassung der Textgröße</div>
                            </div>
                            <div class="setting-control">
                                <select class="select-control" id="font-size">
                                    <option value="small">Klein</option>
                                    <option value="medium" selected>Mittel</option>
                                    <option value="large">Groß</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="settings-card-header">
                        <div class="settings-card-icon">
                            <i class="fas fa-eye"></i>
                        </div>
                        <h3 class="settings-card-title">Sichtbarkeit</h3>
                    </div>
                    <div class="settings-list">
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Animierte Übergänge</div>
                                <div class="setting-description">Glatte Animationen zwischen Seiten</div>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="animations">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="setting-item premium-setting" data-cost="150">
                            <div class="setting-info">
                                <div class="setting-label">Transaktions-Effekte</div>
                                <div class="setting-description">Spezielle Animationen bei Verkäufen</div>
                                <div class="premium-badge">
                                    <i class="fas fa-crown"></i>
                                    PREMIUM
                                </div>
                            </div>
                            <div class="setting-control">
                                <div class="setting-status status-locked" id="transaction-effects-status">
                                    <i class="fas fa-lock"></i> Gesperrt
                                </div>
                                <button class="button-control premium" onclick="showPurchaseModal('transaction_effects', 'Transaktions-Effekte', 150)">
                                    Freischalten
                                </button>
                            </div>
                        </div>
                        <div class="setting-item premium-setting" data-cost="80">
                            <div class="setting-info">
                                <div class="setting-label">Profil-Abzeichen</div>
                                <div class="setting-description">Exklusive Abzeichen im Profil</div>
                                <div class="premium-badge">
                                    <i class="fas fa-crown"></i>
                                    PREMIUM
                                </div>
                            </div>
                            <div class="setting-control">
                                <div class="setting-status status-locked" id="profile-badges-status">
                                    <i class="fas fa-lock"></i> Gesperrt
                                </div>
                                <button class="button-control premium" onclick="showPurchaseModal('profile_badges', 'Profil-Abzeichen', 80)">
                                    Freischalten
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Performance Settings Section -->
        <section class="settings-section">
            <h2 class="section-title">Leistung & Features</h2>
            <div class="settings-grid">
                <div class="settings-card">
                    <div class="settings-card-header">
                        <div class="settings-card-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <h3 class="settings-card-title">Leistungsoptimierung</h3>
                    </div>
                    <div class="settings-list">
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Cache automatisch leeren</div>
                                <div class="setting-description">Alte Daten regelmäßig entfernen</div>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="auto-clear-cache">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="setting-item premium-setting" data-cost="200">
                            <div class="setting-info">
                                <div class="setting-label">Prioritäts-Verarbeitung</div>
                                <div class="setting-description">Schnellere Bestätigung von Zahlungen</div>
                                <div class="premium-badge">
                                    <i class="fas fa-crown"></i>
                                    PREMIUM
                                </div>
                            </div>
                            <div class="setting-control">
                                <div class="setting-status status-locked" id="priority-processing-status">
                                    <i class="fas fa-lock"></i> Gesperrt
                                </div>
                                <button class="button-control premium" onclick="showPurchaseModal('priority_processing', 'Prioritäts-Verarbeitung', 200)">
                                    Freischalten
                                </button>
                            </div>
                        </div>
                        <div class="setting-item premium-setting" data-cost="300">
                            <div class="setting-info">
                                <div class="setting-label">Schnellbezahlung</div>
                                <div class="setting-description">Reduzierte Ladezeiten beim Bezahlen</div>
                                <div class="premium-badge">
                                    <i class="fas fa-crown"></i>
                                    PREMIUM
                                </div>
                            </div>
                            <div class="setting-control">
                                <div class="setting-status status-locked" id="fast-checkout-status">
                                    <i class="fas fa-lock"></i> Gesperrt
                                </div>
                                <button class="button-control premium" onclick="showPurchaseModal('fast_checkout', 'Schnellbezahlung', 300)">
                                    Freischalten
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="settings-card-header">
                        <div class="settings-card-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h3 class="settings-card-title">Daten & Analyse</h3>
                    </div>
                    <div class="settings-list">
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Nutzungsstatistiken</div>
                                <div class="setting-description">Anonyme Nutzungsdaten sammeln</div>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="usage-stats">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="setting-item premium-setting" data-cost="250">
                            <div class="setting-info">
                                <div class="setting-label">Erweiterte Analysen</div>
                                <div class="setting-description">Detaillierte Verkaufsstatistiken</div>
                                <div class="premium-badge">
                                    <i class="fas fa-crown"></i>
                                    PREMIUM
                                </div>
                            </div>
                            <div class="setting-control">
                                <div class="setting-status status-locked" id="advanced-analytics-status">
                                    <i class="fas fa-lock"></i> Gesperrt
                                </div>
                                <button class="button-control premium" onclick="showPurchaseModal('advanced_analytics', 'Erweiterte Analysen', 250)">
                                    Freischalten
                                </button>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Automatische Sicherung</div>
                                <div class="setting-description">Einstellungen automatisch speichern</div>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="auto-backup" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Purchased Features Section -->
        <section class="settings-section">
            <h2 class="section-title">Ihre Premium Features</h2>
            <div class="settings-grid" id="purchased-features-grid">
                <!-- Will be populated by JavaScript -->
                <div class="empty-state">
                    <i class="fas fa-gem"></i>
                    <p>Noch keine Premium Features freigeschaltet</p>
                    <p>Schalten Sie Features frei, um sie hier zu verwalten.</p>
                </div>
            </div>
        </section>

        <!-- Reset Section -->
        <section class="settings-section">
            <h2 class="section-title">Zurücksetzen & Info</h2>
            <div class="settings-grid">
                <div class="settings-card">
                    <div class="settings-card-header">
                        <div class="settings-card-icon">
                            <i class="fas fa-redo"></i>
                        </div>
                        <h3 class="settings-card-title">Zurücksetzen</h3>
                    </div>
                    <div class="settings-list">
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Einstellungen zurücksetzen</div>
                                <div class="setting-description">Auf Standardwerte zurücksetzen</div>
                            </div>
                            <div class="setting-control">
                                <button class="button-control" onclick="showResetModal('settings')">
                                    <i class="fas fa-redo"></i>
                                    Zurücksetzen
                                </button>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Cache leeren</div>
                                <div class="setting-description">Gespeicherte temporäre Daten löschen</div>
                            </div>
                            <div class="setting-control">
                                <button class="button-control" onclick="showResetModal('cache')">
                                    <i class="fas fa-trash"></i>
                                    Leeren
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="settings-card-header">
                        <div class="settings-card-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <h3 class="settings-card-title">Informationen</h3>
                    </div>
                    <div class="settings-list">
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">App Version</div>
                                <div class="setting-description">Aktuelle Version der Anwendung</div>
                            </div>
                            <div class="setting-control">
                                <span class="setting-status status-active" id="app-version">2.1.0</span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Letzte Aktualisierung</div>
                                <div class="setting-description">Datum der letzten Aktualisierung</div>
                            </div>
                            <div class="setting-control">
                                <span class="setting-status status-active" id="last-update">Heute</span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-label">Support & Hilfe</div>
                                <div class="setting-description">Hilfe und Dokumentation</div>
                            </div>
                            <div class="setting-control">
                                <button class="button-control" onclick="window.location.href='support'">
                                    <i class="fas fa-question-circle"></i>
                                    Hilfe
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- ==================== MODALS ==================== -->
    
    <!-- Change Name Modal -->
    <div class="modal-overlay" id="change-name-modal">
        <div class="modal premium">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-edit"></i>
                    Benutzername ändern
                </h2>
                <button class="close-modal" onclick="closeModal('change-name-modal')">&times;</button>
            </div>
            <div class="modal-content">
                <div class="modal-icon premium">
                    <i class="fas fa-user-edit"></i>
                </div>
                <div class="modal-cost">
                    <i class="fas fa-coins"></i>
                    Kosten: 10 Premium Punkte
                </div>
                <p class="modal-message">
                    Geben Sie einen neuen Benutzernamen ein. Diese Änderung kostet 10 Premium Punkte.
                </p>
                <input type="text" class="modal-input" id="new-name-input" placeholder="Neuer Benutzername" maxlength="30">
                <div class="modal-footer">
                    <button class="modal-btn secondary" onclick="closeModal('change-name-modal')">
                        Abbrechen
                    </button>
                    <button class="modal-btn premium" onclick="changeUserName()">
                        <i class="fas fa-check"></i>
                        Ändern (10 Punkte)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Join Premium Modal -->
    <div class="modal-overlay" id="join-premium-modal">
        <div class="modal premium">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-crown"></i>
                    Premium Club beitreten
                </h2>
                <button class="close-modal" onclick="closeModal('join-premium-modal')">&times;</button>
            </div>
            <div class="modal-content">
                <div class="modal-icon premium">
                    <i class="fas fa-gem"></i>
                </div>
                <p class="modal-message">
                    Treten Sie dem Premium Club bei und genießen Sie exklusive Vorteile:
                </p>
                <ul style="margin: var(--spacing-md) 0; padding-left: var(--spacing-lg); color: #000000;">
                    <li style="margin-bottom: var(--spacing-sm);">🎁 100 Willkommenspunkte</li>
                    <li style="margin-bottom: var(--spacing-sm);">⭐ Exklusive Features freischalten</li>
                    <li style="margin-bottom: var(--spacing-sm);">🚀 Doppelte Punkte bei Einkäufen</li>
                    <li style="margin-bottom: var(--spacing-sm);">🏆 Höhere Statuslevel erreichen</li>
                    <li>🎨 Premium Designs und Animationen</li>
                </ul>
                <div class="modal-footer">
                    <button class="modal-btn secondary" onclick="closeModal('join-premium-modal')">
                        Später
                    </button>
                    <button class="modal-btn premium" onclick="joinPremiumClub()">
                        <i class="fas fa-crown"></i>
                        Jetzt beitreten
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Purchase Feature Modal -->
    <div class="modal-overlay" id="purchase-feature-modal">
        <div class="modal premium">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-unlock"></i>
                    Feature freischalten
                </h2>
                <button class="close-modal" onclick="closeModal('purchase-feature-modal')">&times;</button>
            </div>
            <div class="modal-content">
                <div class="modal-icon premium">
                    <i class="fas fa-gem"></i>
                </div>
                <div class="modal-cost" id="feature-cost-display">
                    <i class="fas fa-coins"></i>
                    Kosten: <span id="feature-cost">0</span> Premium Punkte
                </div>
                <p class="modal-message" id="feature-description">
                    Möchten Sie dieses Feature freischalten?
                </p>
                <div class="modal-footer">
                    <button class="modal-btn secondary" onclick="closeModal('purchase-feature-modal')">
                        Abbrechen
                    </button>
                    <button class="modal-btn premium" onclick="purchaseFeature()" id="purchase-feature-btn">
                        <i class="fas fa-check"></i>
                        Freischalten
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Settings Modal -->
    <div class="modal-overlay" id="reset-settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    Einstellungen zurücksetzen
                </h2>
                <button class="close-modal" onclick="closeModal('reset-settings-modal')">&times;</button>
            </div>
            <div class="modal-content">
                <div class="modal-icon">
                    <i class="fas fa-redo"></i>
                </div>
                <p class="modal-message" id="reset-message">
                    Sind Sie sicher, dass Sie die Einstellungen zurücksetzen möchten?
                </p>
                <div class="modal-footer">
                    <button class="modal-btn secondary" onclick="closeModal('reset-settings-modal')">
                        Abbrechen
                    </button>
                    <button class="modal-btn primary" onclick="confirmReset()" id="reset-confirm-btn">
                        <i class="fas fa-check"></i>
                        Zurücksetzen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div class="tutorial-overlay" id="tutorial-overlay">
        <div class="tutorial-container">
            <div class="tutorial-slide active" id="tutorial-slide-1">
                <div class="tutorial-icon">
                    <i class="fas fa-user-cog"></i>
                </div>
                <h3 class="tutorial-title">Willkommen zu den Einstellungen</h3>
                <div class="tutorial-content">
                    Hier können Sie Ihre Benutzererfahrung personalisieren, Premium-Features freischalten und Ihre Loyalitätsstatus verwalten.
                </div>
            </div>
            
            <div class="tutorial-slide" id="tutorial-slide-2">
                <div class="tutorial-icon">
                    <i class="fas fa-user"></i>
                </div>
                <h3 class="tutorial-title">Ihr Profil</h3>
                <div class="tutorial-content">
                    Passen Sie Ihren Benutzernamen an (kostet 10 Punkte) und sehen Sie Ihre Statistiken wie gescannte Artikel und Verkäufe.
                </div>
            </div>
            
            <div class="tutorial-slide" id="tutorial-slide-3">
                <div class="tutorial-icon">
                    <i class="fas fa-crown"></i>
                </div>
                <h3 class="tutorial-title">Premium Club Status</h3>
                <div class="tutorial-content">
                    Verfolgen Sie Ihre Punkte, sehen Sie Ihren aktuellen Status und treten Sie dem Premium Club bei, um exklusive Vorteile zu erhalten.
                </div>
            </div>
            
            <div class="tutorial-slide" id="tutorial-slide-4">
                <div class="tutorial-icon">
                    <i class="fas fa-sliders-h"></i>
                </div>
                <h3 class="tutorial-title">Einstellungen anpassen</h3>
                <div class="tutorial-content">
                    Passen Sie Scanner-Verhalten, Ton-Einstellungen, Darstellung und Leistung nach Ihren Vorlieben an.
                </div>
            </div>
            
            <div class="tutorial-slide" id="tutorial-slide-5">
                <div class="tutorial-icon">
                    <i class="fas fa-gem"></i>
                </div>
                <h3 class="tutorial-title">Premium Features</h3>
                <div class="tutorial-content">
                    Schalten Sie exklusive Features mit Ihren Punkten frei. Premium-Features sind mit einem Kronen-Symbol gekennzeichnet.
                </div>
            </div>
            
            <div class="tutorial-slide" id="tutorial-slide-6">
                <div class="tutorial-icon">
                    <i class="fas fa-redo"></i>
                </div>
                <h3 class="tutorial-title">Zurücksetzen & Hilfe</h3>
                <div class="tutorial-content">
                    Setzen Sie Einstellungen zurück oder löschen Sie den Cache. Bei Fragen nutzen Sie die Hilfe-Funktion.
                </div>
            </div>
            
            <div class="tutorial-indicators">
                <div class="tutorial-indicator active" data-slide="1"></div>
                <div class="tutorial-indicator" data-slide="2"></div>
                <div class="tutorial-indicator" data-slide="3"></div>
                <div class="tutorial-indicator" data-slide="4"></div>
                <div class="tutorial-indicator" data-slide="5"></div>
                <div class="tutorial-indicator" data-slide="6"></div>
            </div>
            
            <div class="tutorial-navigation">
                <button class="tutorial-btn prev touch-feedback" id="tutorial-prev">Zurück</button>
                <button class="tutorial-btn next touch-feedback" id="tutorial-next">Weiter</button>
                <button class="tutorial-btn next touch-feedback" id="tutorial-finish" style="display: none;">Fertig</button>
            </div>
        </div>
    </div>

    <!-- Confetti Container -->
    <div class="confetti-container" id="confetti-container"></div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-icon"></div>
        <div class="notification-message"></div>
    </div>

    <script>
        // ==================== USER SETTINGS MANAGER ====================
        class UserSettingsManager {
            constructor() {
                this.settingsKey = 'userSettings';
                this.statsKey = 'userStatistics';
                this.profileKey = 'userProfile';
                this.tutorialKey = 'user_settings_tutorial';
                this.currentTutorialSlide = 1;
                this.totalTutorialSlides = 6;
                this.init();
            }

            init() {
                this.settings = this.loadSettings();
                this.stats = this.loadStats();
                this.profile = this.loadProfile();
                this.applySettings();
                this.updateUI();
                this.checkTutorial();
            }

            loadSettings() {
                const saved = localStorage.getItem(this.settingsKey);
                if (saved) {
                    return JSON.parse(saved);
                }
                
                // Default settings
                return {
                    // Scanner settings
                    continuousScan: false,
                    autoAddCart: false,
                    scanSound: true,
                    successSound: true,
                    
                    // Appearance settings
                    autoDarkMode: true,
                    fontSize: 'medium',
                    animations: true,
                    
                    // Performance settings
                    autoClearCache: false,
                    usageStats: true,
                    autoBackup: true,
                    
                    // Premium features (will be synced from loyalty system)
                    purchasedFeatures: {},
                    
                    // Last updated timestamp
                    lastUpdated: new Date().toISOString()
                };
            }

            loadStats() {
                const saved = localStorage.getItem(this.statsKey);
                if (saved) {
                    return JSON.parse(saved);
                }
                
                return {
                    totalScans: 0,
                    totalSales: 0,
                    sessionStart: new Date().toISOString(),
                    totalSessionTime: 0, // in minutes
                    lastReset: new Date().toISOString()
                };
            }

            loadProfile() {
                const saved = localStorage.getItem(this.profileKey);
                if (saved) {
                    return JSON.parse(saved);
                }
                
                return {
                    name: 'Benutzer',
                    role: 'Standard Benutzer',
                    joinDate: new Date().toISOString(),
                    lastActive: new Date().toISOString(),
                    nameChanged: false
                };
            }

            saveSettings() {
                this.settings.lastUpdated = new Date().toISOString();
                localStorage.setItem(this.settingsKey, JSON.stringify(this.settings));
                localStorage.setItem(this.statsKey, JSON.stringify(this.stats));
                localStorage.setItem(this.profileKey, JSON.stringify(this.profile));
                return true;
            }

            applySettings() {
                // Apply dark mode
                this.applyDarkMode();
                
                // Apply font size
                this.applyFontSize();
                
                // Apply animations
                this.applyAnimations();
                
                // Apply sound settings to global scope for other pages
                this.applySoundSettings();
                
                // Update session time
                this.updateSessionTime();
                
                // Set up auto backup if enabled
                if (this.settings.autoBackup) {
                    this.setupAutoBackup();
                }
            }

            applyDarkMode() {
                if (!this.settings.autoDarkMode) {
                    // If auto dark mode is off, use light mode
                    document.body.classList.remove('dark-mode');
                    return;
                }
                
                // Auto detect from system
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
            }

            applyFontSize() {
                const sizes = {
                    small: '14px',
                    medium: '16px',
                    large: '18px'
                };
                
                document.documentElement.style.fontSize = sizes[this.settings.fontSize] || sizes.medium;
            }

            applyAnimations() {
                if (!this.settings.animations) {
                    document.documentElement.style.setProperty('--transition', 'none');
                    document.documentElement.style.setProperty('--transition-slow', 'none');
                } else {
                    document.documentElement.style.setProperty('--transition', 'all 0.3s cubic-bezier(0.2, 0, 0, 1)');
                    document.documentElement.style.setProperty('--transition-slow', 'all 0.5s cubic-bezier(0.2, 0, 0, 1)');
                }
            }

            applySoundSettings() {
                // Store sound settings for other pages
                const soundSettings = {
                    scanSound: this.settings.scanSound,
                    successSound: this.settings.successSound
                };
                localStorage.setItem('soundSettings', JSON.stringify(soundSettings));
            }

            updateSessionTime() {
                const now = new Date();
                const start = new Date(this.stats.sessionStart);
                const diffMinutes = Math.floor((now - start) / (1000 * 60));
                this.stats.totalSessionTime += diffMinutes;
                this.stats.sessionStart = now.toISOString();
                this.saveSettings();
            }

            setupAutoBackup() {
                // Auto save every 5 minutes
                setInterval(() => {
                    this.saveSettings();
                }, 5 * 60 * 1000);
            }

            updateUI() {
                // Update profile
                document.getElementById('user-name').textContent = this.profile.name;
                document.getElementById('user-role').textContent = this.profile.role;
                document.getElementById('total-scans').textContent = this.stats.totalScans;
                document.getElementById('total-sales').textContent = this.stats.totalSales;
                document.getElementById('session-time').textContent = `${Math.floor(this.stats.totalSessionTime / 60)}h`;
                
                // Update settings controls
                document.getElementById('continuous-scan').checked = this.settings.continuousScan;
                document.getElementById('auto-add-cart').checked = this.settings.autoAddCart;
                document.getElementById('scan-sound').checked = this.settings.scanSound;
                document.getElementById('success-sound').checked = this.settings.successSound;
                document.getElementById('auto-dark-mode').checked = this.settings.autoDarkMode;
                document.getElementById('font-size').value = this.settings.fontSize;
                document.getElementById('animations').checked = this.settings.animations;
                document.getElementById('auto-clear-cache').checked = this.settings.autoClearCache;
                document.getElementById('usage-stats').checked = this.settings.usageStats;
                document.getElementById('auto-backup').checked = this.settings.autoBackup;
                
                // Update last update time
                const lastUpdate = new Date(this.settings.lastUpdated);
                document.getElementById('last-update').textContent = 
                    lastUpdate.toLocaleDateString('de-DE', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: 'numeric' 
                    });
                
                // Sync with loyalty system
                this.syncWithLoyalty();
            }

            syncWithLoyalty() {
                // Load loyalty data
                const loyaltyData = JSON.parse(localStorage.getItem('gittertier_loyalty_data') || '{}');
                const paymentPrefs = JSON.parse(localStorage.getItem('gittertier_payment_preferences') || '{}');
                const unlockedFeatures = JSON.parse(localStorage.getItem('gittertier_unlocked_features') || '{}');
                
                // Update loyalty display
                const points = loyaltyData.currentPoints || paymentPrefs.loyaltyPoints || 0;
                const tier = loyaltyData.currentTier || 'bronze';
                const isPremium = loyaltyData.isPremiumMember || paymentPrefs.isLoyaltyMember || false;
                
                document.getElementById('user-points').textContent = points;
                document.getElementById('user-tier').textContent = this.getTierName(tier);
                
                // Update tier badge color
                const tierBadge = document.getElementById('user-tier-badge');
                tierBadge.style.background = this.getTierGradient(tier);
                
                // Update loyalty card
                const loyaltyCard = document.getElementById('loyalty-status-card');
                if (isPremium) {
                    loyaltyCard.classList.add('premium');
                    document.getElementById('join-premium-btn').style.display = 'none';
                } else {
                    loyaltyCard.classList.remove('premium');
                    document.getElementById('join-premium-btn').style.display = 'flex';
                }
                
                // Update progress bar
                this.updateProgressBar(points, tier);
                
                // Update purchased features
                this.updatePurchasedFeatures(unlockedFeatures);
                
                // Update premium feature statuses
                this.updatePremiumFeatureStatuses(unlockedFeatures);
                
                return { points, tier, isPremium };
            }

            getTierName(tier) {
                const tiers = {
                    bronze: 'Bronze',
                    silver: 'Silber',
                    gold: 'Gold',
                    platinum: 'Platin',
                    diamond: 'Diamant'
                };
                return tiers[tier] || 'Bronze';
            }

            getTierGradient(tier) {
                const gradients = {
                    bronze: 'linear-gradient(135deg, #CD7F32, #A0522D)',
                    silver: 'linear-gradient(135deg, #C0C0C0, #A0A0A0)',
                    gold: 'linear-gradient(135deg, #FFD700, #FFA500)',
                    platinum: 'linear-gradient(135deg, #E5E4E2, #C0C0C0)',
                    diamond: 'linear-gradient(135deg, #B9F2FF, #66A6FF)'
                };
                return gradients[tier] || gradients.bronze;
            }

            updateProgressBar(points, tier) {
                const tierRequirements = {
                    bronze: { min: 0, next: 500 },
                    silver: { min: 500, next: 1500 },
                    gold: { min: 1500, next: 3000 },
                    platinum: { min: 3000, next: 5000 },
                    diamond: { min: 5000, next: null }
                };
                
                const currentTier = tierRequirements[tier] || tierRequirements.bronze;
                
                if (currentTier.next) {
                    const progress = ((points - currentTier.min) / (currentTier.next - currentTier.min)) * 100;
                    document.getElementById('progress-fill').style.width = `${Math.min(progress, 100)}%`;
                    document.getElementById('progress-text').textContent = 
                        `${points - currentTier.min}/${currentTier.next - currentTier.min}`;
                } else {
                    document.getElementById('progress-fill').style.width = '100%';
                    document.getElementById('progress-text').textContent = 'Maximales Level erreicht!';
                }
            }

            updatePurchasedFeatures(unlockedFeatures) {
                const container = document.getElementById('purchased-features-grid');
                const activeFeatures = [];
                
                // Check all possible features
                const allFeatures = {
                    scanner_animation: {
                        title: 'Scanner Animation',
                        icon: 'fas fa-sparkles',
                        description: 'Spezielle Puls-Animation für den Scanner',
                        cost: 200
                    },
                    priority_processing: {
                        title: 'Prioritäts-Verarbeitung',
                        icon: 'fas fa-bolt',
                        description: 'Schnellere Bestätigung von Zahlungen',
                        cost: 300
                    },
                    point_multiplier: {
                        title: 'Punkt-Multiplikator',
                        icon: 'fas fa-rocket',
                        description: 'Erhalten Sie 2x Punkte auf alle Einkäufe',
                        cost: 500
                    },
                    transaction_effects: {
                        title: 'Transaktions-Effekte',
                        icon: 'fas fa-fire',
                        description: 'Spezielle Animationen bei erfolgreichen Zahlungen',
                        cost: 120
                    },
                    profile_badges: {
                        title: 'Profil-Abzeichen',
                        icon: 'fas fa-shield-alt',
                        description: 'Exklusive Abzeichen in Ihrem Profil',
                        cost: 80
                    },
                    scanner_effects: {
                        title: 'Scanner-Effekte',
                        icon: 'fas fa-magic',
                        description: 'Verbesserte visuelle Effekte beim Scannen',
                        cost: 220
                    },
                    fast_checkout: {
                        title: 'Schnellbezahlung',
                        icon: 'fas fa-bolt',
                        description: 'Reduzierte Ladezeiten beim Bezahlen',
                        cost: 300
                    },
                    advanced_analytics: {
                        title: 'Erweiterte Analysen',
                        icon: 'fas fa-chart-line',
                        description: 'Detaillierte Verkaufsstatistiken',
                        cost: 250
                    },
                    dark_mode_plus: {
                        title: 'Dark Mode Plus',
                        icon: 'fas fa-moon',
                        description: 'Erweiterter Dark Mode mit mehr Optionen',
                        cost: 100
                    },
                    premium_sounds: {
                        title: 'Premium Sounds',
                        icon: 'fas fa-volume-up',
                        description: 'Exklusive Soundeffekte für Premium-Mitglieder',
                        cost: 75
                    }
                };
                
                // Find active features
                for (const [id, feature] of Object.entries(allFeatures)) {
                    if (unlockedFeatures[id]?.unlocked && unlockedFeatures[id]?.active) {
                        activeFeatures.push({
                            id,
                            ...feature
                        });
                    }
                }
                
                if (activeFeatures.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-gem"></i>
                            <p>Noch keine Premium Features freigeschaltet</p>
                            <p>Schalten Sie Features frei, um sie hier zu verwalten.</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = activeFeatures.map(feature => `
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <div class="settings-card-icon" style="background: var(--gradient-premium); color: #000000;">
                                <i class="${feature.icon}"></i>
                            </div>
                            <h3 class="settings-card-title">${feature.title}</h3>
                            <div class="premium-badge">
                                <i class="fas fa-check"></i>
                                AKTIV
                            </div>
                        </div>
                        <div class="settings-list">
                            <div class="setting-item">
                                <div class="setting-info">
                                    <div class="setting-label">Beschreibung</div>
                                    <div class="setting-description">${feature.description}</div>
                                </div>
                            </div>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <div class="setting-label">Status</div>
                                    <div class="setting-description">Aktuell aktiviert</div>
                                </div>
                                <div class="setting-control">
                                    <div class="setting-status status-active">
                                        <i class="fas fa-check"></i> Aktiv
                                    </div>
                                </div>
                            </div>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <div class="setting-label">Kosten</div>
                                    <div class="setting-description">Ursprünglicher Preis</div>
                                </div>
                                <div class="setting-control">
                                    <div class="setting-cost">
                                        <i class="fas fa-coins"></i>
                                        ${feature.cost}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            updatePremiumFeatureStatuses(unlockedFeatures) {
                // Update all premium feature status displays
                const features = {
                    'scanner_animation': 'scanner-animation-status',
                    'priority_processing': 'priority-processing-status',
                    'transaction_effects': 'transaction-effects-status',
                    'profile_badges': 'profile-badges-status',
                    'fast_checkout': 'fast-checkout-status',
                    'advanced_analytics': 'advanced-analytics-status',
                    'dark_mode_plus': 'dark-mode-plus-status',
                    'premium_sounds': 'premium-sounds-status'
                };
                
                for (const [featureId, elementId] of Object.entries(features)) {
                    const element = document.getElementById(elementId);
                    if (!element) continue;
                    
                    if (unlockedFeatures[featureId]?.unlocked) {
                        if (unlockedFeatures[featureId]?.active) {
                            element.innerHTML = '<i class="fas fa-check"></i> Aktiv';
                            element.className = 'setting-status status-active';
                            // Hide purchase button
                            const button = element.nextElementSibling;
                            if (button) button.style.display = 'none';
                        } else {
                            element.innerHTML = '<i class="fas fa-toggle-off"></i> Inaktiv';
                            element.className = 'setting-status status-inactive';
                        }
                    } else {
                        element.innerHTML = '<i class="fas fa-lock"></i> Gesperrt';
                        element.className = 'setting-status status-locked';
                        // Show purchase button
                        const button = element.nextElementSibling;
                        if (button) button.style.display = 'flex';
                    }
                }
            }

            // Tutorial System
            checkTutorial() {
                const tutorialCompleted = localStorage.getItem(this.tutorialKey);
                if (!tutorialCompleted) {
                    setTimeout(() => {
                        this.showTutorial();
                    }, 1500);
                }
            }

            showTutorial() {
                const overlay = document.getElementById('tutorial-overlay');
                if (overlay) {
                    overlay.classList.add('active');
                    this.currentTutorialSlide = 1;
                    this.updateTutorialSlide();
                }
            }

            hideTutorial() {
                const overlay = document.getElementById('tutorial-overlay');
                if (overlay) {
                    overlay.classList.remove('active');
                    localStorage.setItem(this.tutorialKey, 'completed');
                }
            }

            updateTutorialSlide() {
                // Hide all slides
                document.querySelectorAll('.tutorial-slide').forEach(slide => {
                    slide.classList.remove('active');
                });
                
                // Show current slide
                const currentSlide = document.getElementById(`tutorial-slide-${this.currentTutorialSlide}`);
                if (currentSlide) {
                    currentSlide.classList.add('active');
                }
                
                // Update indicators
                document.querySelectorAll('.tutorial-indicator').forEach((indicator, index) => {
                    if (index + 1 === this.currentTutorialSlide) {
                        indicator.classList.add('active');
                    } else {
                        indicator.classList.remove('active');
                    }
                });
                
                // Update navigation buttons
                const prevBtn = document.getElementById('tutorial-prev');
                const nextBtn = document.getElementById('tutorial-next');
                const finishBtn = document.getElementById('tutorial-finish');
                
                if (prevBtn) {
                    prevBtn.style.display = this.currentTutorialSlide === 1 ? 'none' : 'flex';
                }
                
                if (nextBtn && finishBtn) {
                    if (this.currentTutorialSlide === this.totalTutorialSlides) {
                        nextBtn.style.display = 'none';
                        finishBtn.style.display = 'flex';
                    } else {
                        nextBtn.style.display = 'flex';
                        finishBtn.style.display = 'none';
                    }
                }
            }

            nextTutorialSlide() {
                if (this.currentTutorialSlide < this.totalTutorialSlides) {
                    this.currentTutorialSlide++;
                    this.updateTutorialSlide();
                }
            }

            prevTutorialSlide() {
                if (this.currentTutorialSlide > 1) {
                    this.currentTutorialSlide--;
                    this.updateTutorialSlide();
                }
            }

            // Feature Management
            purchaseFeature(featureId, featureName, cost) {
                // Check loyalty points
                const loyaltyData = JSON.parse(localStorage.getItem('gittertier_loyalty_data') || '{}');
                const points = loyaltyData.currentPoints || 0;
                
                if (points < cost) {
                    this.showNotification(`Nicht genug Punkte! Sie benötigen ${cost} Punkte, haben aber nur ${points}.`, 'error');
                    return false;
                }
                
                // Deduct points
                loyaltyData.currentPoints -= cost;
                localStorage.setItem('gittertier_loyalty_data', JSON.stringify(loyaltyData));
                
                // Unlock feature
                const unlockedFeatures = JSON.parse(localStorage.getItem('gittertier_unlocked_features') || '{}');
                unlockedFeatures[featureId] = {
                    unlocked: true,
                    unlockedDate: new Date().toISOString(),
                    active: true
                };
                localStorage.setItem('gittertier_unlocked_features', JSON.stringify(unlockedFeatures));
                
                // Apply feature
                this.applyFeature(featureId);
                
                // Update UI
                this.syncWithLoyalty();
                
                // Show success
                this.showNotification(`🎉 ${featureName} erfolgreich für ${cost} Punkte freigeschaltet!`, 'success');
                this.createConfetti();
                
                return true;
            }

            applyFeature(featureId) {
                switch(featureId) {
                    case 'scanner_animation':
                        localStorage.setItem('gittertier_scanner_animation', 'true');
                        break;
                    case 'priority_processing':
                        localStorage.setItem('gittertier_priority_processing', 'true');
                        break;
                    case 'transaction_effects':
                        localStorage.setItem('gittertier_transaction_effects', 'true');
                        break;
                    case 'profile_badges':
                        localStorage.setItem('gittertier_profile_badges', 'true');
                        break;
                    case 'fast_checkout':
                        localStorage.setItem('gittertier_fast_checkout', 'true');
                        break;
                    case 'advanced_analytics':
                        localStorage.setItem('gittertier_advanced_analytics', 'true');
                        break;
                    case 'dark_mode_plus':
                        localStorage.setItem('gittertier_dark_mode_plus', 'true');
                        break;
                    case 'premium_sounds':
                        localStorage.setItem('gittertier_premium_sounds', 'true');
                        break;
                }
            }

            // User Profile Management
            changeUserName(newName) {
                // Check loyalty points
                const loyaltyData = JSON.parse(localStorage.getItem('gittertier_loyalty_data') || '{}');
                const points = loyaltyData.currentPoints || 0;
                
                if (points < 10) {
                    this.showNotification(`Nicht genug Punkte! Namensänderung kostet 10 Punkte.`, 'error');
                    return false;
                }
                
                if (!newName || newName.trim().length < 2 || newName.trim().length > 30) {
                    this.showNotification('Name muss zwischen 2 und 30 Zeichen lang sein.', 'error');
                    return false;
                }
                
                // Deduct points
                loyaltyData.currentPoints -= 10;
                localStorage.setItem('gittertier_loyalty_data', JSON.stringify(loyaltyData));
                
                // Update profile
                this.profile.name = newName.trim();
                this.profile.nameChanged = true;
                this.profile.lastActive = new Date().toISOString();
                this.saveSettings();
                
                // Update UI
                this.updateUI();
                
                // Show success
                this.showNotification(`👤 Name erfolgreich zu "${newName}" geändert! (10 Punkte)`, 'success');
                this.createConfetti();
                
                return true;
            }

            joinPremiumClub() {
                const loyaltyData = JSON.parse(localStorage.getItem('gittertier_loyalty_data') || '{}');
                const paymentPrefs = JSON.parse(localStorage.getItem('gittertier_payment_preferences') || '{}');
                
                if (loyaltyData.isPremiumMember || paymentPrefs.isLoyaltyMember) {
                    this.showNotification('Sie sind bereits Premium-Mitglied!', 'info');
                    return false;
                }
                
                // Join premium
                loyaltyData.isPremiumMember = true;
                loyaltyData.joinDate = new Date().toISOString();
                loyaltyData.currentPoints = (loyaltyData.currentPoints || 0) + 100; // Welcome bonus
                loyaltyData.lifetimePoints = (loyaltyData.lifetimePoints || 0) + 100;
                
                paymentPrefs.isLoyaltyMember = true;
                paymentPrefs.loyaltyPoints = loyaltyData.currentPoints;
                
                // Save
                localStorage.setItem('gittertier_loyalty_data', JSON.stringify(loyaltyData));
                localStorage.setItem('gittertier_payment_preferences', JSON.stringify(paymentPrefs));
                
                // Update UI
                this.syncWithLoyalty();
                
                // Show success
                this.showNotification('🎉 Herzlich willkommen im Premium Club! Sie erhalten 100 Willkommenspunkte!', 'success');
                this.createConfetti();
                
                return true;
            }

            // Reset Functions
            resetSettings() {
                // Keep purchased features
                const unlockedFeatures = JSON.parse(localStorage.getItem('gittertier_unlocked_features') || '{}');
                
                // Reset to defaults but keep some user data
                this.settings = {
                    // Scanner settings
                    continuousScan: false,
                    autoAddCart: false,
                    scanSound: true,
                    successSound: true,
                    
                    // Appearance settings
                    autoDarkMode: true,
                    fontSize: 'medium',
                    animations: true,
                    
                    // Performance settings
                    autoClearCache: false,
                    usageStats: true,
                    autoBackup: true,
                    
                    // Keep purchased features
                    purchasedFeatures: unlockedFeatures,
                    
                    lastUpdated: new Date().toISOString()
                };
                
                this.saveSettings();
                this.applySettings();
                this.updateUI();
                
                this.showNotification('✅ Einstellungen erfolgreich zurückgesetzt', 'success');
                return true;
            }

            clearCache() {
                try {
                    // Clear all temporary data
                    const keysToKeep = [
                        'userSettings',
                        'userStatistics',
                        'userProfile',
                        'gittertier_loyalty_data',
                        'gittertier_payment_preferences',
                        'gittertier_unlocked_features',
                        'appSettings',
                        'products',
                        'soundSettings'
                    ];
                    
                    const allKeys = Object.keys(localStorage);
                    for (const key of allKeys) {
                        if (!keysToKeep.includes(key) && 
                            !key.startsWith('product_') && 
                            !key.startsWith('customer_') &&
                            key !== 'offlineQueue' &&
                            key !== 'auditLog') {
                            localStorage.removeItem(key);
                        }
                    }
                    
                    // Clear session storage
                    sessionStorage.clear();
                    
                    this.showNotification('✅ Cache erfolgreich geleert', 'success');
                    return true;
                } catch (error) {
                    this.showNotification('❌ Fehler beim Leeren des Caches', 'error');
                    return false;
                }
            }

            // Notification System
            showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                const icon = notification.querySelector('.notification-icon');
                const messageEl = notification.querySelector('.notification-message');
                
                // Set icon based on type
                const icons = {
                    success: 'fas fa-check-circle',
                    error: 'fas fa-exclamation-circle',
                    warning: 'fas fa-exclamation-triangle',
                    info: 'fas fa-info-circle'
                };
                
                icon.className = `notification-icon ${icons[type] || icons.info}`;
                messageEl.textContent = message;
                
                // Set type class
                notification.className = `notification ${type} show`;
                
                // Auto hide after 3 seconds
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }

            createConfetti() {
                const container = document.getElementById('confetti-container');
                if (!container) return;
                
                container.style.display = 'block';
                container.innerHTML = '';
                
                const colors = ['#FFD700', '#FF9F0A', '#FF375F', '#5856D6', '#34C759'];
                
                for (let i = 0; i < 100; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.width = Math.random() * 10 + 5 + 'px';
                    confetti.style.height = Math.random() * 10 + 5 + 'px';
                    confetti.style.animationDuration = Math.random() * 2 + 1 + 's';
                    confetti.style.animationDelay = Math.random() * 1 + 's';
                    container.appendChild(confetti);
                }
                
                setTimeout(() => {
                    container.style.display = 'none';
                    container.innerHTML = '';
                }, 3000);
            }

            // Event Handlers
            handleSettingChange(settingId, value) {
                this.settings[settingId] = value;
                this.saveSettings();
                this.applySettings();
                
                // Show feedback for important changes
                const importantSettings = ['autoDarkMode', 'fontSize', 'animations'];
                if (importantSettings.includes(settingId)) {
                    this.showNotification(`Einstellung "${this.getSettingLabel(settingId)}" aktualisiert`, 'success');
                }
            }

            getSettingLabel(settingId) {
                const labels = {
                    continuousScan: 'Kontinuierliches Scannen',
                    autoAddCart: 'Auto-Zum-Warenkorb',
                    scanSound: 'Scan-Ton',
                    successSound: 'Erfolgs-Ton',
                    autoDarkMode: 'Automatischer Dark Mode',
                    fontSize: 'Schriftgröße',
                    animations: 'Animierte Übergänge',
                    autoClearCache: 'Cache automatisch leeren',
                    usageStats: 'Nutzungsstatistiken',
                    autoBackup: 'Automatische Sicherung'
                };
                return labels[settingId] || settingId;
            }
        }

        // ==================== GLOBAL VARIABLES ====================
        let userSettingsManager;
        let currentPurchaseFeature = null;

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize manager
            userSettingsManager = new UserSettingsManager();
            
            // Setup event listeners
            setupEventListeners();
            
            // Update time display
            updateTime();
            setInterval(updateTime, 1000);
            
            // Setup auto dark mode listener
            if (window.matchMedia) {
                const darkModeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                darkModeMediaQuery.addListener((e) => {
                    if (userSettingsManager.settings.autoDarkMode) {
                        userSettingsManager.applyDarkMode();
                    }
                });
            }
        });

        function setupEventListeners() {
            // Back button
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    window.history.back();
                });
            }
            
            // Tutorial button
            const tutorialBtn = document.getElementById('tutorial-btn');
            if (tutorialBtn) {
                tutorialBtn.addEventListener('click', () => {
                    userSettingsManager.showTutorial();
                });
            }
            
            // Change name button
            const changeNameBtn = document.getElementById('change-name-btn');
            if (changeNameBtn) {
                changeNameBtn.addEventListener('click', () => {
                    showModal('change-name-modal');
                });
            }
            
            // Join premium button
            const joinPremiumBtn = document.getElementById('join-premium-btn');
            if (joinPremiumBtn) {
                joinPremiumBtn.addEventListener('click', () => {
                    showModal('join-premium-modal');
                });
            }
            
            // View premium button
            const viewPremiumBtn = document.getElementById('view-premium-btn');
            if (viewPremiumBtn) {
                viewPremiumBtn.addEventListener('click', () => {
                    window.location.href = 'loyalty';
                });
            }
            
            // Setting change listeners
            document.getElementById('continuous-scan').addEventListener('change', function() {
                userSettingsManager.handleSettingChange('continuousScan', this.checked);
            });
            
            document.getElementById('auto-add-cart').addEventListener('change', function() {
                userSettingsManager.handleSettingChange('autoAddCart', this.checked);
            });
            
            document.getElementById('scan-sound').addEventListener('change', function() {
                userSettingsManager.handleSettingChange('scanSound', this.checked);
            });
            
            document.getElementById('success-sound').addEventListener('change', function() {
                userSettingsManager.handleSettingChange('successSound', this.checked);
            });
            
            document.getElementById('auto-dark-mode').addEventListener('change', function() {
                userSettingsManager.handleSettingChange('autoDarkMode', this.checked);
                userSettingsManager.applyDarkMode();
            });
            
            document.getElementById('font-size').addEventListener('change', function() {
                userSettingsManager.handleSettingChange('fontSize', this.value);
                userSettingsManager.applyFontSize();
            });
            
            document.getElementById('animations').addEventListener('change', function() {
                userSettingsManager.handleSettingChange('animations', this.checked);
                userSettingsManager.applyAnimations();
            });
            
            document.getElementById('auto-clear-cache').addEventListener('change', function() {
                userSettingsManager.handleSettingChange('autoClearCache', this.checked);
            });
            
            document.getElementById('usage-stats').addEventListener('change', function() {
                userSettingsManager.handleSettingChange('usageStats', this.checked);
            });
            
            document.getElementById('auto-backup').addEventListener('change', function() {
                userSettingsManager.handleSettingChange('autoBackup', this.checked);
                if (this.checked) {
                    userSettingsManager.setupAutoBackup();
                }
            });
            
            // Tutorial navigation
            const tutorialNext = document.getElementById('tutorial-next');
            const tutorialPrev = document.getElementById('tutorial-prev');
            const tutorialFinish = document.getElementById('tutorial-finish');
            const tutorialIndicators = document.querySelectorAll('.tutorial-indicator');
            
            if (tutorialNext) {
                tutorialNext.addEventListener('click', function() {
                    userSettingsManager.nextTutorialSlide();
                });
            }
            
            if (tutorialPrev) {
                tutorialPrev.addEventListener('click', function() {
                    userSettingsManager.prevTutorialSlide();
                });
            }
            
            if (tutorialFinish) {
                tutorialFinish.addEventListener('click', function() {
                    userSettingsManager.hideTutorial();
                });
            }
            
            tutorialIndicators.forEach(indicator => {
                indicator.addEventListener('click', function() {
                    const slide = parseInt(this.dataset.slide);
                    userSettingsManager.currentTutorialSlide = slide;
                    userSettingsManager.updateTutorialSlide();
                });
            });
            
            // Close modals on overlay click
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-overlay')) {
                    e.target.classList.remove('active');
                }
            });
            
            // Escape key to close modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                        modal.classList.remove('active');
                    });
                    
                    const tutorialOverlay = document.getElementById('tutorial-overlay');
                    if (tutorialOverlay && tutorialOverlay.classList.contains('active')) {
                        userSettingsManager.hideTutorial();
                    }
                }
            });
            
            // Enter key in name input
            document.getElementById('new-name-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    changeUserName();
                }
            });
        }

        // ==================== MODAL FUNCTIONS ====================
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function showPurchaseModal(featureId, featureName, cost) {
            currentPurchaseFeature = { id: featureId, name: featureName, cost: cost };
            
            // Update modal content
            document.getElementById('feature-cost').textContent = cost;
            document.getElementById('feature-description').textContent = 
                `Möchten Sie "${featureName}" für ${cost} Premium Punkte freischalten?`;
            
            // Check if user has enough points
            const loyaltyData = JSON.parse(localStorage.getItem('gittertier_loyalty_data') || '{}');
            const points = loyaltyData.currentPoints || 0;
            const purchaseBtn = document.getElementById('purchase-feature-btn');
            
            if (points < cost) {
                purchaseBtn.disabled = true;
                purchaseBtn.innerHTML = `<i class="fas fa-times"></i> Nicht genug Punkte (${points}/${cost})`;
            } else {
                purchaseBtn.disabled = false;
                purchaseBtn.innerHTML = `<i class="fas fa-check"></i> Für ${cost} Punkte freischalten`;
            }
            
            showModal('purchase-feature-modal');
        }

        function purchaseFeature() {
            if (!currentPurchaseFeature) return;
            
            const success = userSettingsManager.purchaseFeature(
                currentPurchaseFeature.id,
                currentPurchaseFeature.name,
                currentPurchaseFeature.cost
            );
            
            if (success) {
                closeModal('purchase-feature-modal');
                currentPurchaseFeature = null;
            }
        }

        function changeUserName() {
            const newName = document.getElementById('new-name-input').value.trim();
            if (!newName) {
                userSettingsManager.showNotification('Bitte geben Sie einen Namen ein.', 'error');
                return;
            }
            
            const success = userSettingsManager.changeUserName(newName);
            if (success) {
                closeModal('change-name-modal');
                document.getElementById('new-name-input').value = '';
            }
        }

        function joinPremiumClub() {
            const success = userSettingsManager.joinPremiumClub();
            if (success) {
                closeModal('join-premium-modal');
            }
        }

        function showResetModal(type) {
            const modal = document.getElementById('reset-settings-modal');
            const message = document.getElementById('reset-message');
            const confirmBtn = document.getElementById('reset-confirm-btn');
            
            if (type === 'settings') {
                message.textContent = 'Sind Sie sicher, dass Sie alle Einstellungen auf Standardwerte zurücksetzen möchten? Diese Aktion kann nicht rückgängig gemacht werden.';
                confirmBtn.onclick = function() {
                    userSettingsManager.resetSettings();
                    closeModal('reset-settings-modal');
                };
            } else if (type === 'cache') {
                message.textContent = 'Sind Sie sicher, dass Sie den Cache leeren möchten? Temporäre Daten werden gelöscht, aber Ihre Einstellungen und Produkte bleiben erhalten.';
                confirmBtn.onclick = function() {
                    userSettingsManager.clearCache();
                    closeModal('reset-settings-modal');
                };
            }
            
            showModal('reset-settings-modal');
        }

        function confirmReset() {
            // Handled in showResetModal
        }

        // ==================== UTILITY FUNCTIONS ====================
        function updateTime() {
            try {
                const now = new Date();
                const timeDisplay = document.getElementById('timeDisplay');
                
                if (timeDisplay) {
                    const timeString = now.toLocaleTimeString('de-DE', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: window.innerWidth <= 768 ? undefined : '2-digit'
                    });
                    const dateString = now.toLocaleDateString('de-DE', {
                        weekday: window.innerWidth <= 768 ? 'short' : 'long',
                        day: '2-digit',
                        month: window.innerWidth <= 768 ? 'short' : 'long',
                        year: window.innerWidth <= 768 ? undefined : 'numeric'
                    });
                    timeDisplay.textContent = window.innerWidth <= 768 ? 
                        `${dateString}, ${timeString}` : 
                        `${dateString}, ${timeString}`;
                }
            } catch (error) {
                console.error('Error updating time:', error);
            }
        }

        // Expose to global scope
        window.userSettingsManager = userSettingsManager;
        window.showPurchaseModal = showPurchaseModal;
        window.purchaseFeature = purchaseFeature;
        window.showResetModal = showResetModal;
        window.confirmReset = confirmReset;
        window.closeModal = closeModal;
        window.changeUserName = changeUserName;
        window.joinPremiumClub = joinPremiumClub;
    </script>
</body>
</html>