<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gittertier Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
<<<<<<< HEAD
=======
    :root {
        --color-bg: #ffffff;
        --color-text: #111111;
        --color-text-muted: #6b7280;
        --color-border: #e5e7eb;
        --color-accent: #2563eb;
        --color-accent-hover: #1d4ed8;
        --color-success: #16a34a;
        --color-error: #dc2626;
        --color-overlay: rgba(0, 0, 0, 0.5);
        --color-tutorial: #FF9900;
        --color-tutorial-light: #FFF3CD;
        
        --radius: 12px;
        --radius-sm: 6px;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.07), 0 1px 2px rgba(0, 0, 0, 0.04);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --focus-ring: 0 0 0 3px rgba(37, 99, 235, 0.35);
        
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;
        --spacing-xxl: 48px;
        
        --transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
        --transition-slow: all 0.3s cubic-bezier(0.2, 0, 0, 1);
        
        --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, "Helvetica Neue", Arial, sans-serif;
        --text-xs: 0.75rem;
        --text-sm: 0.875rem;
        --text-base: 1rem;
        --text-lg: 1.125rem;
        --text-xl: 1.25rem;
        --text-2xl: 1.5rem;
        --text-3xl: 1.875rem;
        
        --header-height: 64px;
        --footer-height: 80px;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: var(--font-family);
        background-color: var(--color-bg);
        color: var(--color-text);
        line-height: 1.5;
        min-height: 100vh;
        padding-bottom: var(--footer-height);
    }

    /* Header Styles */
    header {
        height: var(--header-height);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 var(--spacing-lg);
        border-bottom: 1px solid var(--color-border);
        background-color: var(--color-bg);
        position: sticky;
        top: 0;
        z-index: 50;
    }

    .logo {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        font-weight: 700;
        font-size: var(--text-xl);
    }

    .logo i {
        font-size: var(--text-xl);
        color: var(--color-accent);
    }

    .header-controls {
        display: flex;
        gap: var(--spacing-md);
    }

    /* Main Content */
    main {
        max-width: 880px;
        margin: 0 auto;
        padding: var(--spacing-xl) var(--spacing-lg);
    }

    .section {
        margin-bottom: var(--spacing-xl);
    }

    .section-title {
        font-size: var(--text-lg);
        font-weight: 600;
        margin-bottom: var(--spacing-md);
        color: var(--color-text);
    }

    /* Scanner Card */
    .scanner-card {
        background: var(--color-bg);
        border-radius: var(--radius);
        border: 1px solid var(--color-border);
        box-shadow: var(--shadow);
        overflow: hidden;
        margin-bottom: var(--spacing-xl);
        animation: fadeIn 0.4s ease-out;
    }

    #scanner-container {
        position: relative;
        width: 100%;
        aspect-ratio: 16/9;
        background-color: #f9fafb;
        overflow: hidden;
    }

    #scanner-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    #barcode-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10;
    }

    #barcode-box {
        position: absolute;
        border: 2px solid var(--color-success);
        box-shadow: 0 0 0 2px rgba(22, 163, 74, 0.2);
        display: none;
        z-index: 10;
        transition: all 0.2s ease;
        border-radius: var(--radius-sm);
    }

    .scanner-status {
        position: absolute;
        bottom: var(--spacing-md);
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--color-overlay);
        color: white;
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: 20px;
        font-size: var(--text-sm);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        z-index: 20;
    }

    .scanner-status .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: var(--color-success);
    }

    .scanner-status.inactive .dot {
        background-color: var(--color-error);
    }

    /* Scanner Controls */
    .scanner-controls {
        display: flex;
        padding: var(--spacing-md);
        gap: var(--spacing-md);
        border-top: 1px solid var(--color-border);
        flex-wrap: wrap;
    }

    .control-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--spacing-xs);
        background: none;
        border: none;
        padding: var(--spacing-sm);
        border-radius: var(--radius-sm);
        color: var(--color-text-muted);
        font-size: var(--text-xs);
        cursor: pointer;
        transition: var(--transition);
        flex: 1;
        min-width: 60px;
    }

    .control-btn:hover {
        background-color: #f9fafb;
        color: var(--color-text);
    }

    .control-btn:focus {
        outline: none;
        box-shadow: var(--focus-ring);
    }

    .control-btn i {
        font-size: var(--text-lg);
    }

    .scan-btn {
        background-color: var(--color-accent);
        color: white;
        border: none;
        border-radius: var(--radius);
        padding: var(--spacing-md) var(--spacing-lg);
        font-size: var(--text-base);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        flex: 2;
        min-width: 140px;
    }

    .scan-btn:hover {
        background-color: var(--color-accent-hover);
    }

    .scan-btn:focus {
        outline: none;
        box-shadow: var(--focus-ring);
    }

    /* Additional Controls */
    .additional-controls {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-md);
        margin-top: var(--spacing-md);
    }

    .action-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-md);
        border: 1px solid var(--color-border);
        border-radius: var(--radius);
        background-color: var(--color-bg);
        color: var(--color-text);
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition);
    }
<<<<<<< HEAD
=======
    
    /* Passcode Modal Specific Styles */
#passcode-modal .modal-content {
    max-width: 400px;
}

#passcode-input {
    letter-spacing: 2px;
    font-size: var(--text-lg);
    text-align: center;
    font-weight: 600;
}
>>>>>>> parent of 32ed076 (index.html aktualisieren)

    .action-btn:hover {
        background-color: #f9fafb;
        border-color: var(--color-accent);
    }

        .action-btn:focus {
            outline: none;
            box-shadow: var(--focus-ring);
        }

        .action-btn i {
            font-size: var(--text-lg);
        }

        .support-btn {
            color: var(--color-success);
            border-color: #16a34a33;
        }

        .support-btn:hover {
            background-color: rgba(22, 163, 74, 0.05);
            border-color: var(--color-success);
        }

        .admin-btn {
            color: var(--color-error);
            border-color: rgba(220, 38, 38, 0.2);
        }

        .admin-btn:hover {
            background-color: rgba(220, 38, 38, 0.05);
            border-color: var(--color-error);
        }

        /* Product Card */
        .product-card {
            background: var(--color-bg);
            border-radius: var(--radius);
            border: 1px solid var(--color-border);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            display: none;
        }

        .product-card.visible {
            display: flex;
            animation: slideUp 0.3s ease-out;
        }

        .product-image {
            width: 80px;
            height: 80px;
            background-color: #f3f4f6;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: var(--spacing-lg);
            flex-shrink: 0;
        }

        .product-image i {
            font-size: var(--text-2xl);
            color: var(--color-text-muted);
        }

        .product-info {
            flex-grow: 1;
        }

        .product-name {
            font-weight: 600;
            font-size: var(--text-base);
            margin-bottom: var(--spacing-xs);
        }

        .product-price {
            font-weight: 700;
            font-size: var(--text-lg);
            color: var(--color-text);
            margin-bottom: var(--spacing-md);
        }

        .product-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            background-color: #f9fafb;
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--color-border);
        }

        .quantity-btn {
            background: none;
            border: none;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--color-text-muted);
            transition: var(--transition);
        }

        .quantity-btn:hover {
            background-color: #f3f4f6;
            color: var(--color-text);
        }

        .quantity-btn:focus {
            outline: none;
            box-shadow: var(--focus-ring);
        }

        .quantity-value {
            width: 36px;
            text-align: center;
            font-weight: 600;
        }

        .add-to-cart-btn {
            background-color: var(--color-accent);
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: var(--spacing-sm) var(--spacing-md);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .add-to-cart-btn:hover {
            background-color: var(--color-accent-hover);
        }

        .add-to-cart-btn:focus {
            outline: none;
            box-shadow: var(--focus-ring);
        }

        .replace-scan {
            color: var(--color-accent);
            font-size: var(--text-sm);
            text-decoration: underline;
            cursor: pointer;
            margin-left: auto;
        }

        .replace-scan:hover {
            color: var(--color-accent-hover);
        }

        /* Cart Section */
        .cart-section {
            background: var(--color-bg);
            border-radius: var(--radius);
            border: 1px solid var(--color-border);
            overflow: hidden;
        }

        .cart-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-title {
            font-weight: 600;
            font-size: var(--text-lg);
        }

        .cart-count {
            color: var(--color-text-muted);
            font-size: var(--text-sm);
        }

        #cart-items {
            max-height: 300px;
            overflow-y: auto;
        }

        .cart-item {
            display: flex;
            align-items: center;
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--color-border);
            transition: var(--transition);
        }

        .cart-item:hover {
            background-color: #f9fafb;
        }

        .cart-item-image {
            width: 50px;
            height: 50px;
            background-color: #f3f4f6;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: var(--spacing-md);
            flex-shrink: 0;
        }

        .cart-item-image i {
            font-size: var(--text-lg);
            color: var(--color-text-muted);
        }

        .cart-item-info {
            flex-grow: 1;
        }

        .cart-item-name {
            font-weight: 500;
            font-size: var(--text-base);
            margin-bottom: var(--spacing-xs);
        }

        .cart-item-price {
            color: var(--color-text-muted);
            font-size: var(--text-sm);
        }

        .cart-item-quantity {
            display: flex;
            align-items: center;
            margin-right: var(--spacing-md);
        }

        .cart-item-remove {
            background: none;
            border: none;
            color: var(--color-error);
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .cart-item-remove:hover {
            background-color: #fef2f2;
        }

        .cart-item-remove:focus {
            outline: none;
            box-shadow: var(--focus-ring);
        }

        .cart-total {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            font-size: var(--text-lg);
        }

        /* Payment Footer */
        .payment-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--footer-height);
            background-color: var(--color-bg);
            border-top: 1px solid var(--color-border);
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 40;
        }

        .total-amount {
            font-weight: 700;
            font-size: var(--text-xl);
        }

        .pay-btn {
            background-color: var(--color-accent);
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: var(--spacing-md) var(--spacing-xl);
            font-weight: 700;
            font-size: var(--text-base);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .pay-btn:hover {
            background-color: var(--color-accent-hover);
            transform: translateY(-2px);
        }

        .pay-btn:active {
            transform: translateY(0);
        }

        .pay-btn:focus {
            outline: none;
            box-shadow: var(--focus-ring);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--color-overlay);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-lg);
        }

        .modal-content {
            background-color: var(--color-bg);
            border-radius: var(--radius);
            padding: var(--spacing-xl);
            width: 100%;
            max-width: 500px;
            box-shadow: var(--shadow-md);
            animation: scaleIn 0.3s cubic-bezier(0.2, 0, 0, 1);
        }

        .modal-header {
            margin-bottom: var(--spacing-lg);
        }

        .modal-title {
            font-weight: 600;
            font-size: var(--text-xl);
            margin-bottom: var(--spacing-xs);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .modal-input {
            width: 100%;
            padding: var(--spacing-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-md);
            font-size: var(--text-base);
            transition: var(--transition);
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: var(--focus-ring);
        }

        .modal-actions {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }

        .modal-btn {
            flex: 1;
            padding: var(--spacing-md);
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .modal-btn.primary {
            background-color: var(--color-accent);
            color: white;
            border: none;
        }

        .modal-btn.primary:hover {
            background-color: var(--color-accent-hover);
        }

        .modal-btn.secondary {
            background-color: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text-muted);
        }

        .modal-btn.secondary:hover {
            background-color: #f9fafb;
            color: var(--color-text);
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: calc(var(--footer-height) + var(--spacing-md));
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--color-text);
            color: white;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius);
            z-index: 60;
            display: none;
            animation: slideUp 0.3s ease-out;
            font-weight: 500;
        }

        .notification.success {
            background-color: var(--color-success);
        }

        .notification.error {
            background-color: var(--color-error);
        }

        .notification.info {
            background-color: var(--color-info);
        }

        .notification.warning {
            background-color: var(--color-warning);
        }

        /* Utility Classes */
        .text-muted {
            color: var(--color-text-muted);
        }

        .text-sm {
            font-size: var(--text-sm);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px) translateX(-50%);
                opacity: 0;
            }
            to {
                transform: translateY(0) translateX(-50%);
                opacity: 1;
            }
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.95);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .instagram-banner {
            background: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584, #e1306c, #fd1d1d);
            color: white;
            padding: var(--spacing-md);
            border-radius: var(--radius);
            margin-top: var(--spacing-md);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-sm);
            box-shadow: var(--shadow);
        }

        .instagram-banner a {
            color: white;
            font-weight: 600;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: 30px;
            transition: var(--transition);
        }

        .instagram-banner a:hover {
            transform: translateY(-2px);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            :root {
                --spacing-lg: 20px;
                --spacing-xl: 24px;
            }

            main {
                padding: var(--spacing-lg) var(--spacing-md);
            }

            .scanner-controls {
                flex-direction: column;
            }

            .control-btn {
                flex-direction: row;
                justify-content: center;
            }

            .additional-controls {
                grid-template-columns: 1fr;
            }

            .product-card.visible {
                flex-direction: column;
            }

            .product-image {
                margin-right: 0;
                margin-bottom: var(--spacing-md);
                align-self: center;
            }

            .product-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .replace-scan {
                margin-left: 0;
                text-align: center;
            }

            .cart-item {
                flex-wrap: wrap;
            }

            .cart-item-quantity {
                margin-top: var(--spacing-md);
                margin-right: 0;
                width: 100%;
                justify-content: center;
            }

            .cart-item-remove {
                margin-top: var(--spacing-md);
                width: 100%;
                text-align: center;
            }

            .payment-footer {
                flex-direction: column;
                height: auto;
                padding: var(--spacing-md);
                gap: var(--spacing-md);
            }

            .total-amount {
                font-size: var(--text-lg);
            }

            .pay-btn {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            header {
                padding: 0 var(--spacing-md);
            }

            .logo {
                font-size: var(--text-lg);
            }

            .modal-content {
                padding: var(--spacing-lg);
            }

            .modal-actions {
                flex-direction: column;
            }
        }

        /* Maintenance and Closed Screens */
        #maintenance-modal, #closed-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--color-bg);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: var(--spacing-lg);
            text-align: center;
        }

        .maintenance-content, .closed-content {
            max-width: 500px;
        }

        .maintenance-icon, .closed-icon {
            font-size: 4rem;
            color: var(--color-error);
            margin-bottom: var(--spacing-lg);
        }

        .maintenance-title, .closed-title {
            font-size: var(--text-2xl);
            font-weight: 700;
            margin-bottom: var(--spacing-md);
        }

        .maintenance-message, .closed-message {
            color: var(--color-text-muted);
            margin-bottom: var(--spacing-xl);
        }

        /* Dark mode support for system preference */
        @media (prefers-color-scheme: dark) {
            :root {
                --color-bg: #111827;
                --color-text: #f3f4f6;
                --color-text-muted: #9ca3af;
                --color-border: #374151;
                --color-tutorial-light: #cc5c00;
            }

            body {
                background-color: var(--color-bg);
            }

            .scanner-card, .product-card, .cart-section {
                background-color: #1f2937;
                border-color: var(--color-border);
            }

            .control-btn:hover, .action-btn:hover {
                background-color: #374151;
            }

            .product-image, .cart-item-image {
                background-color: #374151;
            }

            .cart-item:hover {
                background-color: #374151;
            }

            .payment-footer {
                background-color: #1f2937;
                border-color: var(--color-border);
            }
        }

        /* NEW: Tutorial Elements */
        .tutorial-welcome-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-lg);
        }

        .tutorial-welcome-content {
            background-color: var(--color-bg);
            border-radius: var(--radius);
            padding: var(--spacing-xl);
            max-width: 500px;
            width: 100%;
            box-shadow: var(--shadow-md);
            text-align: center;
        }

        .tutorial-welcome-icon {
            font-size: 3rem;
            color: var(--color-tutorial);
            margin-bottom: var(--spacing-md);
            display: none;
        }

        .tutorial-welcome-title {
            font-size: var(--text-xl);
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--color-tutorial);
        }

        .tutorial-welcome-message {
            margin-bottom: var(--spacing-lg);
            line-height: 1.6;
        }

        .tutorial-welcome-actions {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .tutorial-welcome-btn {
            padding: var(--spacing-md);
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            border: none;
        }

        .tutorial-welcome-btn.primary {
            background-color: var(--color-tutorial);
            color: white;
        }

        .tutorial-welcome-btn.secondary {
            background-color: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text-muted);
        }

        .tutorial-welcome-checkbox {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-lg);
            font-size: var(--text-sm);
        }

        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10001;
            display: none;
        }

        .tutorial-cutout {
            position: absolute;
            border-radius: var(--radius);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.8), 0 0 15px 5px rgba(255, 153, 0, 0.5);
            z-index: 10002;
            transition: all 0.4s cubic-bezier(0.2, 0, 0, 1);
        }

        .tutorial-bubble {
            position: fixed;
            background-color: white;
            border-radius: var(--radius);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-md);
            z-index: 10003;
            max-width: 90%;
            min-width: 280px;
            border: 2px solid var(--color-tutorial);
            animation: fadeIn 0.3s ease-out;
            font-size: var(--text-base);
        }

        .tutorial-bubble:after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border: 12px solid transparent;
        }

        .tutorial-bubble.top:after {
            bottom: -24px;
            left: 50%;
            transform: translateX(-50%);
            border-top-color: var(--color-tutorial);
        }

        .tutorial-bubble.bottom:after {
            top: -24px;
            left: 50%;
            transform: translateX(-50%);
            border-bottom-color: var(--color-tutorial);
        }

        .tutorial-bubble.left:after {
            right: -24px;
            top: 50%;
            transform: translateY(-50%);
            border-left-color: var(--color-tutorial);
        }

        .tutorial-bubble.right:after {
            left: -24px;
            top: 50%;
            transform: translateY(-50%);
            border-right-color: var(--color-tutorial);
        }

        .tutorial-bubble-title {
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--color-tutorial);
            font-size: var(--text-lg);
        }

        .tutorial-bubble-content {
            margin-bottom: var(--spacing-md);
            line-height: 1.5;
        }

        .tutorial-bubble-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
        }

        .tutorial-bubble-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-sm);
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: var(--transition);
        }

        .tutorial-bubble-btn.primary {
            background-color: var(--color-tutorial);
            color: white;
        }

        .tutorial-bubble-btn.secondary {
            background-color: transparent;
            color: var(--color-text-muted);
        }

        .tutorial-step-indicator {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--color-tutorial);
            color: white;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: 20px;
            z-index: 10004;
            display: none;
            font-weight: 500;
        }

        .tutorial-continue-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--color-tutorial);
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: var(--spacing-md) var(--spacing-lg);
            font-weight: 600;
            cursor: pointer;
            z-index: 10004;
            display: none;
            box-shadow: var(--shadow-md);
        }

        .tutorial-completion-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-lg);
        }

        .tutorial-completion-content {
            background-color: var(--color-bg);
            border-radius: var(--radius);
            padding: var(--spacing-xl);
            max-width: 500px;
            width: 100%;
            box-shadow: var(--shadow-md);
            text-align: center;
        }

        .tutorial-completion-icon {
            font-size: 3rem;
            color: var(--color-tutorial);
            margin-bottom: var(--spacing-md);
        }

        .tutorial-completion-title {
            font-size: var(--text-xl);
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--color-tutorial);
        }

        .tutorial-completion-message {
            margin-bottom: var(--spacing-lg);
            line-height: 1.6;
        }

        .tutorial-completion-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: center;
        }

        .tutorial-disabled {
            position: relative;
            cursor: not-allowed !important;
        }

        .tutorial-disabled::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.5);
            z-index: 9999;
            border-radius: inherit;
        }

        .tutorial-disabled:hover::before {
            content: 'Im Tutorial-Modus - dieser Button ist deaktiviert';
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--color-tutorial);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 10000;
        }

        @keyframes highlight-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 153, 0, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(255, 153, 0, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 153, 0, 0);
            }
        }

        .tutorial-highlight {
            animation: highlight-pulse 2s infinite;
            position: relative;
            z-index: 10005 !important;
        }

        .tutorial-error-banner {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--color-error);
            color: white;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius);
            z-index: 10006;
            display: none;
            max-width: 90%;
            text-align: center;
        }

        /* Passcode Modal Styles */
        .passcode-modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-bg);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-lg);
        }

        .passcode-content {
            background-color: var(--color-bg);
            border-radius: var(--radius);
            padding: var(--spacing-xl);
            width: 100%;
            max-width: 450px;
            box-shadow: var(--shadow-md);
            text-align: center;
            border: 1px solid var(--color-border);
        }

        .passcode-icon {
            font-size: 2.5rem;
            color: var(--color-accent);
            margin-bottom: var(--spacing-md);
        }

        .passcode-title {
            font-size: var(--text-xl);
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--color-text);
        }

        .passcode-subtitle {
            color: var(--color-text-muted);
            margin-bottom: var(--spacing-lg);
        }

        .passcode-input {
            width: 100%;
            padding: var(--spacing-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-md);
            font-size: var(--text-base);
            text-align: center;
            letter-spacing: 2px;
            transition: var(--transition);
        }

        .passcode-input:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: var(--focus-ring);
        }

        .passcode-error {
            color: var(--color-error);
            font-size: var(--text-sm);
            margin-bottom: var(--spacing-md);
            display: none;
        }

        .passcode-info {
            background-color: #f9fafb;
            border-radius: var(--radius-sm);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            font-size: var(--text-sm);
            color: var(--color-text-muted);
            text-align: left;
        }

        .passcode-info h4 {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-xs);
            color: var(--color-text);
        }

        .trial-expired-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-bg);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-lg);
        }

        .trial-expired-content {
            background-color: var(--color-bg);
            border-radius: var(--radius);
            padding: var(--spacing-xl);
            width: 100%;
            max-width: 500px;
            box-shadow: var(--shadow-md);
            text-align: center;
            border: 1px solid var(--color-border);
        }

        .trial-expired-icon {
            font-size: 3rem;
            color: var(--color-error);
            margin-bottom: var(--spacing-md);
        }

        .trial-expired-title {
            font-size: var(--text-xl);
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--color-error);
        }

        .trial-expired-message {
            color: var(--color-text-muted);
            margin-bottom: var(--spacing-lg);
            line-height: 1.5;
        }

        /* Extension Code Input Styles */
        .extension-code-container {
            margin: var(--spacing-lg) 0;
            text-align: center;
        }

        .extension-code-input {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px solid var(--color-border);
            border-radius: var(--radius);
            font-size: var(--text-base);
            text-align: center;
            letter-spacing: 1px;
            transition: var(--transition);
            margin-bottom: var(--spacing-md);
        }

        .extension-code-input:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: var(--focus-ring);
        }

        .extension-code-btn {
            background-color: var(--color-accent);
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: var(--spacing-md) var(--spacing-lg);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .extension-code-btn:hover {
            background-color: var(--color-accent-hover);
        }

        .extension-code-error {
            color: var(--color-error);
            font-size: var(--text-sm);
            margin-top: var(--spacing-sm);
            display: none;
        }

        .extension-code-success {
            color: var(--color-success);
            font-size: var(--text-sm);
            margin-top: var(--spacing-sm);
            display: none;
        }

        .time-remaining-banner {
            position: fixed;
            top: calc(var(--header-height) + var(--spacing-md));
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--color-info);
            color: white;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: 20px;
            z-index: 45;
            display: none;
            animation: slideUp 0.3s ease-out;
            font-weight: 500;
            box-shadow: var(--shadow);
        }

        @media (max-width: 420px) {
            .GP {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .tutorial-bubble {
                max-width: 85%;
                left: 50% !important;
                transform: translateX(-50%);
                margin: 0 var(--spacing-md);
                font-size: var(--text-sm);
            }

            .tutorial-bubble-title {
                font-size: var(--text-base);
            }

            .tutorial-bubble:after {
                display: none;
            }

            .tutorial-bubble.top {
                top: var(--spacing-xl);
            }

            .tutorial-bubble.bottom {
                bottom: var(--spacing-xl);
            }

            .passcode-content, .trial-expired-content {
                padding: var(--spacing-lg);
            }

            .time-remaining-banner {
                width: 90%;
                text-align: center;
                font-size: var(--text-sm);
            }
        }

        @media (prefers-color-scheme: dark) {
            .tutorial-bubble {
                background-color: #1f2937;
                color: var(--color-text);
            }

            .tutorial-welcome-content,
            .tutorial-completion-content {
                background-color: #1f2937;
                border-color: var(--color-border);
            }

            .passcode-info {
                background-color: #1f2937;
            }

            .extension-code-input {
                background-color: #1f2937;
                color: var(--color-text);
                border-color: var(--color-border);
            }
        }
    </style>
</head>
<body>
    <!-- Passcode Modal -->
    <div id="passcode-modal" class="passcode-modal">
        <div class="passcode-content">
            <div class="passcode-icon">
                <i class="fas fa-lock"></i>
            </div>
            <h2 class="passcode-title">Zugangskontrolle</h2>
            <p class="passcode-subtitle">
                Bitte geben Sie den Passcode ein, um auf Gittertier Pro zuzugreifen
            </p>

            <div class="passcode-info">
                <h4><i class="fas fa-info-circle"></i> 7-Tage Testversion</h4>
                <p>
                    Nach der Eingabe des korrekten Passcodes haben Sie 7 Tage lang Zugriff auf die Anwendung. Nach Ablauf dieser Testversion wird der Zugang automatisch deaktiviert.
                </p>
            </div>

            <input type="password" id="passcode-input" class="passcode-input" placeholder="Passcode eingeben" maxlength="20">
            <div id="passcode-error" class="passcode-error">
                <i class="fas fa-exclamation-circle"></i> Ungültiger Passcode
            </div>

            <div class="modal-actions">
                <button class="modal-btn primary" onclick="checkPasscode()">
                    <i class="fas fa-unlock"></i> Zugang freischalten
                </button>
            </div>
        </div>
    </div>

    <!-- Trial Expired Modal -->
    <div id="trial-expired-modal" class="trial-expired-modal">
        <div class="trial-expired-content">
            <div class="trial-expired-icon">
                <i class="fas fa-calendar-times"></i>
            </div>
            <h2 class="trial-expired-title">Testversion abgelaufen</h2>
            <p class="trial-expired-message">
                Ihre 7-tägige Testversion ist abgelaufen. Der Zugang zur Anwendung wurde deaktiviert.<br>
                Bei Fragen wenden Sie sich bitte an den Support.
            </p>
            
            <div class="extension-code-container">
                <input type="text" id="extension-code-input" class="extension-code-input" placeholder="Erweiterungscode eingeben">
                <button class="extension-code-btn" onclick="applyExtensionCode()">
                    <i class="fas fa-key"></i> Code einlösen
                </button>
                <div id="extension-code-error" class="extension-code-error">
                    <i class="fas fa-exclamation-circle"></i> Ungültiger Code
                </div>
                <div id="extension-code-success" class="extension-code-success">
                    <i class="fas fa-check-circle"></i> Code erfolgreich angewendet!
                </div>
            </div>
            
            <div class="contact-banner">
                <a href="mailto:kaspar.niederberger@outlook.com?subject='Gittertier Pro - Support Anfrage'&body='Hallo liebes Gittertier Pro Team,'">
                    <i class="fas fa-envelope"></i> Support kontaktieren
                </a>
            </div>
        </div>
    </div>

    <!-- Time Remaining Banner -->
    <div id="time-remaining-banner" class="time-remaining-banner">
        <i class="fas fa-clock"></i> <span id="time-remaining-text"></span>
    </div>

    <header>
        <div class="logo">
            <i class="fas fa-shopping-cart"></i>
            <div class="GP">
                <span>Gittertier Pro</span>
            </div>
        </div>
        <div class="header-controls">
            <button class="control-btn" onclick="window.location.href='admin'">
                <i class="fas fa-cog"></i>
            </button>
            <button class="control-btn" onclick="showWelcomeModal()">
                <i class="fas fa-question-circle"></i>
            </button>
            <button class="control-btn" onclick="window.location.href='support'">
                <i class="fas fa-headset"></i>
            </button>
            <button class="control-btn" onclick="window.location.href='about'">
                <i class="fas fa-info-circle"></i>
            </button>
        </div>
    </header>

    <main>
        <section class="section">
            <h2 class="section-title">Produktscanner</h2>
            <div class="scanner-card">
                <div id="scanner-container">
                    <video id="scanner-video" playsinline></video>
                    <div id="barcode-overlay">
                        <div id="barcode-box"></div>
                    </div>
                    <div class="scanner-status inactive" id="scanner-status">
                        <span class="dot"></span>
                        <span>Scanner pausiert</span>
                    </div>
                </div>
                <div class="scanner-controls">
                    <button id="toggle-scanner" class="scan-btn">
                        <i class="fas fa-camera"></i>
                        Scanner starten
                    </button>
                    <button class="control-btn" id="manual-add">
                        <i class="fas fa-pencil-alt"></i>
                        <span>Manuell</span>
                    </button>
                </div>

                <!-- Additional action buttons -->
                <div class="additional-controls">
                </div>
            </div>
        </section>

        <section class="section">
            <div class="product-card" id="product-card">
                <div class="product-image">
                    <i class="fas fa-cube"></i>
                </div>
                <div class="product-info">
                    <div class="product-name" id="product-name">
                        Produktname
                    </div>
                    <div class="product-price" id="product-price">
                        0,00€
                    </div>
                    <div class="product-actions">
                        <div class="quantity-controls">
                            <button class="quantity-btn" onclick="adjustProductQuantity(-1)">−</button>
                            <span class="quantity-value" id="product-quantity">1</span>
                            <button class="quantity-btn" onclick="adjustProductQuantity(1)">+</button>
                        </div>
                        <button class="add-to-cart-btn" onclick="addCurrentProductToCart()">
                            <i class="fas fa-cart-plus"></i>
                            In Warenkorb
                        </button>
                        <span class="replace-scan" onclick="resetScanner()">Erneut scannen</span>
                    </div>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="cart-section">
                <div class="cart-header">
                    <h3 class="cart-title">Warenkorb</h3>
                    <button class="action-btn" id="clear-cart">
                        <i class="fas fa-trash-alt"></i>
                        Warenkorb leeren
                    </button>
                    <div class="cart-count" id="cart-count">
                        0 Artikel
                    </div>
                </div>
                <div id="cart-items"></div>
                <div class="cart-total">
                    <span>Gesamt</span>
                    <span id="cart-total-amount">0,00€</span>
                </div>
            </div>
        </section>
    </main>

    <div class="payment-footer">
        <div class="total-amount" id="payment-total">
            0,00€
        </div>
        <button class="pay-btn" onclick="generateQR()">
            <i class="fas fa-qrcode"></i>
            Bezahlen
        </button>
    </div>

    <!-- Product Modal -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-plus-circle"></i>
                    Produkt erfassen
                </h3>
                <p class="text-muted">
                    Bitte geben Sie die Produktdetails ein
                </p>
            </div>
            <input type="text" id="product-name-input" class="modal-input" placeholder="Produktname">
            <input type="number" id="product-price-input" class="modal-input" placeholder="Preis (€)" step="0.01">
            <input type="text" id="product-barcode-input" class="modal-input" placeholder="Barcode" readonly>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeModal()">Abbrechen</button>
                <button class="modal-btn primary" onclick="saveProduct()">Speichern</button>
            </div>
        </div>
    </div>

    <!-- QR Modal -->
    <div id="qr-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-qrcode"></i>
                    Bezahlung initiieren
                </h3>
                <p class="text-muted">
                    Generieren Sie einen QR-Code zur Zahlung
                </p>
            </div>
            <div style="text-align: center; margin: var(--spacing-xl) 0;">
                <button class="scan-btn" onclick="generateQR()" style="margin: 0 auto;">
                    <i class="fas fa-sync-alt"></i>
                    QR-Code generieren
                </button>
            </div>
            <p class="text-muted text-sm" style="text-align: center;">
                Scannen Sie den generierten Code beim Kunden
            </p>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <div id="maintenance-modal">
        <div class="maintenance-content">
            <div class="maintenance-icon">
                <i class="fas fa-tools"></i>
            </div>
            <h2 class="maintenance-title">Wartungsarbeiten</h2>
            <p class="maintenance-message">
                Der Shop ist derzeit wegen Wartungsarbeiten geschlossen. Bitte versuchen Sie es später erneut.
            </p>
            <button class="pay-btn" onclick="location.href='settings'">
                <i class="fas fa-cog"></i>
                Einstellungen
            </button>
        </div>
    </div>

    <div id="closed-screen">
        <div class="closed-content">
            <div class="closed-icon">
                <i class="fas fa-moon"></i>
            </div>
            <h2 class="closed-title">Geschlossen</h2>
            <p class="closed-message">
                Wir haben derzeit geschlossen.
            </p>
            <p id="opening-hours-display" class="text-muted"></p>
        </div>
    </div>

    <!-- New Tutorial Elements -->
    <div class="tutorial-welcome-modal" id="tutorial-welcome-modal">
        <div class="tutorial-welcome-content">
            <div class="tutorial-welcome-icon">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h2 class="tutorial-welcome-title">Willkommen bei Gittertier Pro</h2>
            <p class="tutorial-welcome-message">
                Möchten Sie eine geführte Tour durch die App starten?
                Das Tutorial zeigt Ihnen Schritt für Schritt, wie Sie Produkte scannen,
                Ihren Warenkorb verwalten und Bezahlvorgänge durchführen.
            </p>
            <div class="tutorial-welcome-actions">
                <button class="tutorial-welcome-btn primary" onclick="startTutorial()">Tutorial starten</button>
                <button class="tutorial-welcome-btn secondary" onclick="closeWelcomeModal()">Jetzt nicht</button>
            </div>
            <div class="tutorial-welcome-checkbox">
                <input type="checkbox" id="tutorial-dont-show-again">
                <label for="tutorial-dont-show-again">Dieses Fenster nicht mehr anzeigen</label>
            </div>
        </div>
    </div>

    <div class="tutorial-overlay" id="tutorial-overlay"></div>
    <div class="tutorial-cutout" id="tutorial-cutout"></div>
    <div class="tutorial-bubble" id="tutorial-bubble"></div>
    <div class="tutorial-step-indicator" id="tutorial-step-indicator"></div>
    <button class="tutorial-continue-btn" id="tutorial-continue-btn">Weiter</button>

    <div class="tutorial-completion-modal" id="tutorial-completion-modal">
        <div class="tutorial-completion-content">
            <div class="tutorial-completion-icon">
                <i class="fas fa-trophy"></i>
            </div>
            <h2 class="tutorial-completion-title">Tutorial abgeschlossen!</h2>
            <p class="tutorial-completion-message">
                Sie haben erfolgreicht alle Funktionen von Gittertier Pro kennengelernt.
                Sie können jetzt mit der App arbeiten oder das Tutorial jederzeit erneut starten.
            </p>
            <div class="tutorial-completion-actions">
                <button class="tutorial-welcome-btn secondary" onclick="restartTutorial()">Tutorial wiederholen</button>
                <button class="tutorial-welcome-btn primary" onclick="closeCompletionModal()">Zur App</button>
            </div>
        </div>
    </div>

    <div class="tutorial-error-banner" id="tutorial-error-banner"></div>

    <script>
        // Passcode Protection System
        const ACCESS_DURATION = 7 * 24 * 60 * 60 * 1000; // 1 week in milliseconds

        // Obfuscated passcode validation
        function validatePasscode(input) {
            // Simple obfuscation to prevent casual viewing of the passcode
            const encoded = [73,
                78,
                83,
                84,
                65,
                71,
                82,
                65,
                77];
            let decoded = "";
            for (let i = 0; i < encoded.length; i++) {
                decoded += String.fromCharCode(encoded[i]);
            }
            return input === decoded;
        }

        // Check if access is already granted and not expired
        function checkAccessStatus() {
            const expiration = localStorage.getItem('passcode_access_expiration');
            const granted = localStorage.getItem('passcode_granted');
            
            // Check if access was previously granted and hasn't expired
            if (granted === 'true' && expiration) {
                const expirationTime = parseInt(expiration);
                if (Date.now() < expirationTime) {
                    return {
                        granted: true,
                        expired: false
                    };
                } else {
                    return {
                        granted: true,
                        expired: true
                    };
                }
            }

            return {
                granted: false,
                expired: false
            };
        }

        // Validate passcode and grant access
        function checkPasscode() {
            const input = document.getElementById('passcode-input').value.trim();
            const errorElement = document.getElementById('passcode-error');

            if (validatePasscode(input)) {
                // Set access expiration (current time + 1 week)
                const expirationTime = Date.now() + ACCESS_DURATION;
                localStorage.setItem('passcode_access_expiration', expirationTime);
                localStorage.setItem('passcode_granted', 'true');
                setTimeout(showWelcomeModal, 1000);
                
                // Hide the modal and show the app
                document.getElementById('passcode-modal').style.display = 'none';
                document.body.classList.remove('passcode-required');
                
                // Show time remaining notification
                showTimeRemainingNotification();
            } else {
                // Show error
                errorElement.style.display = 'block';
                document.getElementById('passcode-input').value = '';
                setTimeout(() => {
                    errorElement.style.display = 'none';
                }, 3000);
            }
        }

        // Show trial expired modal
        function showTrialExpired() {
            document.getElementById('trial-expired-modal').style.display = 'flex';
            document.getElementById('passcode-modal').style.display = 'none';
        }

        // Initialize passcode protection
        function initPasscodeProtection() {
            const accessStatus = checkAccessStatus();

            if (accessStatus.granted && !accessStatus.expired) {
                // Already authenticated and not expired - show the app
                document.getElementById('passcode-modal').style.display = 'none';
                
                // Show time remaining notification
                showTimeRemainingNotification();
            } else if (accessStatus.granted && accessStatus.expired) {
                // Trial has expired
                showTrialExpired();
            } else {
                // Show passcode input
                document.getElementById('passcode-modal').style.display = 'flex';
                document.body.classList.add('passcode-required');
                document.getElementById('tutorial-cutout').style.display = 'none';
            }
        }

        // Add event listener for Enter key in passcode input
        document.getElementById('passcode-input')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPasscode();
            }
        });

        // Extension Code System
        const extensionCodes = {
            "GITTER-INFINITY-TIME-420": {
                duration: 10 * 365 * 24 * 60 * 60 * 1000, // 10 years (practically infinite)
                name: "Unendlicher Zugang",
                encrypted: "R0lUVEVSLUlORklOSVRZLlRJTUUuNDIw" // Base64 encoded
            },
            "GITTER_ONE_WEEK": {
                duration: 7 * 24 * 60 * 60 * 1000, // 1 week
                name: "Eine Woche Verlängerung",
                encrypted: "R0lUVEVSX09ORV9XRUVL" // Base64 encoded
            },
            "ONLY-ONE-MORE-DAY": {
                duration: 24 * 60 * 60 * 1000, // 1 day
                name: "Ein Tag Verlängerung",
                encrypted: "T05MWS1PTkUtTU9SRS1EQVk=" // Base64 encoded
            },
            "I-WANT-A-MONTH-OF-ACCESS": {
                duration: 30 * 24 * 60 * 60 * 1000, // 1 month (30 days)
                name: "Ein Monat Zugang",
                encrypted: "SS1XQU5ULUEtTU9OVEgtT0YtQUNDRVNT" // Base64 encoded
            }
        };

        // Function to validate extension code
        function validateExtensionCode(input) {
            const normalizedInput = input.trim().toUpperCase();
            
            // Check if the code exists in our list
            if (extensionCodes[normalizedInput]) {
                // Check if this code has already been used
                const usedCodes = JSON.parse(localStorage.getItem('used_extension_codes') || '[]');
                if (usedCodes.includes(extensionCodes[normalizedInput].encrypted)) {
                    return { valid: false, reason: 'already_used' };
                }
                return { valid: true, code: normalizedInput };
            }
            
            return { valid: false, reason: 'invalid' };
        }

        // Function to apply extension code
        function applyExtensionCode() {
            const input = document.getElementById('extension-code-input').value;
            const errorElement = document.getElementById('extension-code-error');
            const successElement = document.getElementById('extension-code-success');
            
            // Hide previous messages
            errorElement.style.display = 'none';
            successElement.style.display = 'none';
            
            // Validate the code
            const validation = validateExtensionCode(input);
            
            if (validation.valid) {
                const codeData = extensionCodes[validation.code];
                
                // Mark code as used
                const usedCodes = JSON.parse(localStorage.getItem('used_extension_codes') || '[]');
                usedCodes.push(codeData.encrypted);
                localStorage.setItem('used_extension_codes', JSON.stringify(usedCodes));
                
                // Extend access
                const currentExpiration = parseInt(localStorage.getItem('passcode_access_expiration') || Date.now());
                const newExpiration = currentExpiration + codeData.duration;
                localStorage.setItem('passcode_access_expiration', newExpiration);
                localStorage.setItem('passcode_granted', 'true');
                
                // Show success message
                successElement.innerHTML = `<i class="fas fa-check-circle"></i> ${codeData.name} aktiviert!`;
                successElement.style.display = 'block';
                
                // Close modal after delay and show main app
                setTimeout(() => {
                    document.getElementById('trial-expired-modal').style.display = 'none';
                    showNotification(`${codeData.name} erfolgreich aktiviert!`, 'success');
                    showTimeRemainingNotification();
                }, 2000);
            } else {
                // Show error message
                if (validation.reason === 'already_used') {
                    errorElement.innerHTML = '<i class="fas fa-exclamation-circle"></i> Dieser Code wurde bereits verwendet';
                } else {
                    errorElement.innerHTML = '<i class="fas fa-exclamation-circle"></i> Ungültiger Code';
                }
                errorElement.style.display = 'block';
            }
        }

        // Function to show time remaining notification
        function showTimeRemainingNotification() {
            const expiration = localStorage.getItem('passcode_access_expiration');
            if (!expiration) return;
            
            const expirationTime = parseInt(expiration);
            const now = Date.now();
            const timeRemaining = expirationTime - now;
            
            if (timeRemaining <= 0) {
                // Access expired
                showTrialExpired();
                return;
            }
            
            // Calculate days, hours, minutes remaining
            const days = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
            
            let message = '';
            if (days > 30) {
                const months = Math.floor(days / 30);
                message = `Zugang aktiv für noch ${months} Monat${months !== 1 ? 'e' : ''}`;
            } else if (days > 0) {
                message = `Zugang aktiv für noch ${days} Tag${days !== 1 ? 'e' : ''} ${hours} Stunde${hours !== 1 ? 'n' : ''}`;
            } else if (hours > 0) {
                message = `Zugang aktiv für noch ${hours} Stunde${hours !== 1 ? 'n' : ''} ${minutes} Minute${minutes !== 1 ? 'n' : ''}`;
            } else {
                message = `Zugang aktiv für noch ${minutes} Minute${minutes !== 1 ? 'n' : ''}`;
            }
            
            // Update and show banner
            document.getElementById('time-remaining-text').textContent = message;
            document.getElementById('time-remaining-banner').style.display = 'block';
            
            // Hide banner after 5 seconds
            setTimeout(() => {
                document.getElementById('time-remaining-banner').style.display = 'none';
            }, 5000);
        }

        // Add event listener for Enter key in extension code input
        document.getElementById('extension-code-input')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyExtensionCode();
            }
        });

        // Tutorial State Management
        let tutorialActive = false;
        let tutorialCurrentStep = 0;
        let tutorialSteps = [];
        let tutorialObservers = [];
        let tutorialStorageAvailable = true;

        // Tutorial Steps Configuration
        function initializeTutorialSteps() {
            tutorialSteps = [{
                title: "Header-Bedienelemente",
                content: "Oben rechts finden Sie verschiedene Bedienelemente: Einstellungen (nur für Administratoren), Hilfe (öffnet dieses Tutorial), Support (Fragen & Anliegen) und Info (Über diese App).",
                element: ".header-controls",
                position: "bottom",
                action: null
            },
                {
                    title: "Scanner-Bereich",
                    content: "Dies ist der Scanner-Bereich. Hier scannen Sie Barcodes von Produkten, um sie zum Warenkorb hinzuzufügen.",
                    element: "#scanner-container",
                    position: "top",
                    action: null
                },
                {
                    title: "Scanner starten",
                    content: "Klicken Sie auf 'Scanner starten', um die Kamera zu aktivieren und Barcodes zu erkennen.",
                    element: "#toggle-scanner",
                    position: "top",
                    action: "click",
                    simulate: function() {
                        // If camera access fails, provide fallback
                        try {
                            document.getElementById('toggle-scanner').click();
                        } catch (error) {
                            showTutorialError("Kamera konnte nicht gestartet werden. Bitte erlauben Sie Kamera-Zugriff in Ihren Browsereinstellungen.");
                            document.getElementById('tutorial-bubble').innerHTML += `
                            <div class="tutorial-bubble-actions" style="margin-top: 10px;">
                            <button class="tutorial-bubble-btn primary" onclick="simulateBarcodeScan()">Scan simulieren</button>
                            </div>
                            `;
                        }
                    }
                },
                {
                    title: "Manuelle Eingabe",
                    content: "Falls ein Produkt nicht in unserem Register ist, können Sie hier Name und Preis eingeben. Achtung: Wir achten auf Betrug!",
                    element: "#manual-add",
                    position: "top",
                    action: "none",
                },
                {
                    title: "Produktinformationen",
                    content: "Hier werden die Details des gescannten Produkts angezeigt. Sie können die Menge anpassen und das Produkt zum Warenkorb hinzufügen.",
                    element: "#product-card",
                    position: "bottom",
                    action: null,
                    prepare: function() {
                        // Ensure product card is visible
                        if (!document.getElementById('product-card').classList.contains('visible')) {
                            showProduct({
                                name: 'Beispielprodukt',
                                price: 9.99,
                                barcode: '123456789'
                            });
                        }
                    }
                },
                {
                    title: "Mengensteuerung",
                    content: "Passen Sie hier die Menge des Produkts an, bevor Sie es zum Warenkorb hinzufügen.",
                    element: ".quantity-controls",
                    position: "bottom",
                    action: "click",
                    simulate: function() {
                        document.getElementById('product-quantity').textContent = '2';
                    }
                },
                {
                    title: "Zum Warenkorb hinzufügen",
                    content: "Klicken Sie auf 'In Warenkorb', um das Produkt mit der eingestellten Menge zum Warenkorb hinzuzufügen.",
                    element: ".add-to-cart-btn",
                    position: "bottom",
                    action: "click",
                    simulate: function() {
                        addToCart({
                            name: 'Beispielprodukt',
                            price: 9.99,
                            barcode: '123456789'
                        });
                    }
                },
                {
                    title: "Warenkorb",
                    content: "Hier sehen Sie alle Artikel in Ihren Warenkorb. Sie können Mengen anpassen oder Artikel entfernen.",
                    element: ".cart-section",
                    position: "bottom",
                    action: null
                },
                {
                    title: "Warenkorb leeren",
                    content: "Mit diesem Button können Sie den gesamten Warenkorb auf einmal leeren.",
                    element: "#clear-cart",
                    position: "bottom",
                    action: "click",
                    simulate: function() {
                        // Clear the cart but keep the tutorial item
                        const exampleItem = cart.find(item => item.name === 'Beispielprodukt');
                        cart = exampleItem ? [exampleItem]: [];
                        updateCartDisplay();
                    }
                },
                {
                    title: "Bezahlvorgang",
                    content: "Klicken Sie auf 'Bezahlen', um einen QR-Code zu generieren und den Bezahlvorgang abzuschließen.",
                    element: ".pay-btn",
                    position: "top",
                    // Changed from "bottom" to "top"
                    action: "click",
                    prepare: function() {
                        // Ensure there's at least one item in the cart
                        if (cart.length === 0) {
                            addToCart({
                                name: 'Beispielprodukt',
                                price: 9.99,
                                barcode: '123456789'
                            });
                        }
                        // Make sure the pay button is accessible during tutorial
                        document.querySelector('.payment-footer').style.zIndex = '10005';
                    },
                    simulate: function() {
                        document.getElementById('qr-modal').style.display = 'flex';
                    }
                }];
        }

        // Check if tutorial should be shown
        function checkTutorialStatus() {
            const expiration = localStorage.getItem('passcode_access_expiration');
            const granted = localStorage.getItem('passcode_granted');
            try {
                const tutorialSeen = localStorage.getItem('gittertier_tutorial_seen');
                if (tutorialSeen === null && granted === 'true' && expiration) {
                    // Check if we can use localStorage
                    localStorage.setItem('gittertier_test', 'test');
                    localStorage.removeItem('gittertier_test');

                    // Show welcome modal after a short delay
                    setTimeout(showWelcomeModal, 1000);
                }
            } catch (e) {
                tutorialStorageAvailable = false;
                // Fallback to sessionStorage
                try {
                    const sessionTutorialSeen = sessionStorage.getItem('gittertier_tutorial_seen');
                    if (sessionTutorialSeen === null && granted === 'true' && expiration) {
                        showWelcomeModal();
                        showTutorialError("Ihre Einstellungen können nicht dauerhaft gespeichert werden. Das Tutorial wird bei Ihrem nächsten Besuch erneut angezeigt.");
                    }
                } catch (e) {
                    // Both storage methods failed
                    if (granted === 'true' && expiration) {
                        showTutorialError("Ihre Browsereinstellungen erlauben das Speichern von Präferenzen nicht.");
                    }
                    
                }
            }
        }

        function showWelcomeModal() {
            const accessStatus = checkAccessStatus();
            if(accessStatus.granted && !accessStatus.expired) {
            document.getElementById('tutorial-welcome-modal').style.display = 'flex';
            }
            document.getElementById('tutorial-cutout').style.display = 'none';
            document.getElementById('tutorial-bubble').style.display = 'none';
        }

        function closeWelcomeModal() {
            document.getElementById('tutorial-welcome-modal').style.display = 'none';

            // Save preference if "don't show again" is checked
            const dontShowAgain = document.getElementById('tutorial-dont-show-again').checked;
            if (dontShowAgain) {
                try {
                    if (tutorialStorageAvailable) {
                        localStorage.setItem('gittertier_tutorial_seen', 'true');
                    } else {
                        sessionStorage.setItem('gittertier_tutorial_seen', 'true');
                    }
                } catch (e) {
                    console.error('Failed to save tutorial preference:', e);
                }
            }
        }

        function startTutorial() {
            document.getElementById('tutorial-welcome-modal').style.display = 'none';
            tutorialActive = true;
            tutorialCurrentStep = 0;

            // Save tutorial progress
            saveTutorialProgress();

            // Initialize tutorial steps
            initializeTutorialSteps();

            // Start the first step
            showTutorialStep(tutorialCurrentStep);
        }

        function showTutorialStep(stepIndex) {
            if (stepIndex >= tutorialSteps.length) {
                completeTutorial();
                return;
            }

            const step = tutorialSteps[stepIndex];

            // Update step indicator
            document.getElementById('tutorial-step-indicator').textContent = `${stepIndex + 1}/${tutorialSteps.length}`;
            document.getElementById('tutorial-step-indicator').style.display = 'none';

            // Prepare the step if needed
            if (step.prepare) {
                step.prepare();
            }

            // Show overlay and cutout
            document.getElementById('tutorial-overlay').style.display = 'block';

            // Position cutout around the target element
            positionCutout(step.element);

            // Create and position tutorial bubble
            positionBubble(step);

            // Add highlight animation to the element
            const targetElement = document.querySelector(step.element);
            if (targetElement) {
                targetElement.classList.add('tutorial-highlight');

                // Scroll to element if needed
                targetElement.scrollIntoView({
                    behavior: 'smooth', block: 'center'
                });

                // If the step has an action, set up the event listener
                if (step.action === 'click') {
                    const clickHandler = function() {
                        targetElement.removeEventListener('click', clickHandler);
                        targetElement.classList.remove('tutorial-highlight');

                        if (step.simulate) {
                            step.simulate();
                        }

                        // Auto-proceed to next step after interaction
                        setTimeout(() => {
                            nextTutorialStep();
                        }, 500);
                    };

                    targetElement.addEventListener('click', clickHandler);
                } else {
                    // For steps without action, show continue button
                    document.getElementById('tutorial-continue-btn').style.display = 'block';
                }
            }

            // For steps with simulation but no user action
            if (step.simulate && !step.action) {
                step.simulate();
                document.getElementById('tutorial-continue-btn').style.display = 'block';
            }

            // Set up observers to keep elements positioned correctly
            setupObservers(step.element);
        }

        function positionCutout(elementSelector) {
            const element = document.querySelector(elementSelector);
            if (!element) return;

            const rect = element.getBoundingClientRect();
            const cutout = document.getElementById('tutorial-cutout');

            cutout.style.display = 'block';
            cutout.style.width = `${rect.width + 20}px`;
            cutout.style.height = `${rect.height + 20}px`;
            cutout.style.top = `${rect.top - 10 + window.scrollY}px`;
            cutout.style.left = `${rect.left - 10 + window.scrollX}px`;
        }

        function positionBubble(step) {
            const element = document.querySelector(step.element);
            if (!element) return;

            const rect = element.getBoundingClientRect();
            const bubble = document.getElementById('tutorial-bubble');

            // Determine bubble position based on element position
            const viewportCenter = window.innerHeight / 2;
            const elementCenter = rect.top + (rect.height / 2);

            let positionClass = elementCenter < viewportCenter ? 'bottom': 'top';

            // Create bubble content
            bubble.innerHTML = `
            <div class="tutorial-bubble-title">${step.title}</div>
            <div class="tutorial-bubble-content">${step.content}</div>
            `;

            // Add simulation button if needed
            if (step.simulate && !step.action) {
                bubble.innerHTML += `
                <div class="tutorial-bubble-actions">
                <button class="tutorial-bubble-btn primary" onclick="tutorialSteps[${tutorialCurrentStep}].simulate(); document.getElementById('tutorial-continue-btn').style.display = 'block';">Simulieren</button>
                </div>
                `;
            }

            // Position the bubble
            bubble.className = `tutorial-bubble ${positionClass}`;

            if (positionClass === 'bottom') {
                bubble.style.top = `${rect.bottom + 20 + window.scrollY}px`;
                bubble.style.bottom = 'auto';
            } else {
                bubble.style.top = 'auto';
                bubble.style.bottom = `${window.innerHeight - rect.top + 20}px`;
            }

            // Center horizontally
            const bubbleWidth = bubble.offsetWidth;
            bubble.style.left = `${rect.left + (rect.width / 2) - (bubbleWidth / 2)}px`;

            // Ensure bubble stays within viewport
            const bubbleRect = bubble.getBoundingClientRect();

            if (bubbleRect.left < 10) {
                bubble.style.left = '10px';
            }

            if (bubbleRect.right > window.innerWidth - 10) {
                bubble.style.left = `${window.innerWidth - bubbleRect.width - 10}px`;
            }

            bubble.style.display = 'block';
        }

        function setupObservers(elementSelector) {
            // Clean up previous observers
            tutorialObservers.forEach(observer => {
                observer.disconnect();
            });
            tutorialObservers = [];

            const element = document.querySelector(elementSelector);
            if (!element) return;

            // MutationObserver for DOM changes
            const mutationObserver = new MutationObserver(() => {
                positionCutout(elementSelector);
                positionBubble(tutorialSteps[tutorialCurrentStep]);
            });

            mutationObserver.observe(element, {
                attributes: true,
                childList: true,
                subtree: true
            });

            tutorialObservers.push(mutationObserver);

            // ResizeObserver for size changes
            if (typeof ResizeObserver !== 'undefined') {
                const resizeObserver = new ResizeObserver(() => {
                    positionCutout(elementSelector);
                    positionBubble(tutorialSteps[tutorialCurrentStep]);
                });

                resizeObserver.observe(element);
                tutorialObservers.push(resizeObserver);
            }

            // Listen for window resize and scroll events
            const resizeHandler = () => {
                positionCutout(elementSelector);
                positionBubble(tutorialSteps[tutorialCurrentStep]);
            };

            const scrollHandler = () => {
                positionCutout(elementSelector);
                positionBubble(tutorialSteps[tutorialCurrentStep]);
            };

            window.addEventListener('resize', resizeHandler);
            window.addEventListener('scroll', scrollHandler);

            tutorialObservers.push({
                disconnect: () => {
                    window.removeEventListener('resize', resizeHandler);
                    window.removeEventListener('scroll', scrollHandler);
                }
            });
        }

        function nextTutorialStep() {
            // Remove any highlight from current step
            const currentElement = document.querySelector(tutorialSteps[tutorialCurrentStep].element);
            if (currentElement) {
                currentElement.classList.remove('tutorial-highlight');
            }

            // Clean up observers
            tutorialObservers.forEach(observer => {
                observer.disconnect();
            });
            tutorialObservers = [];

            // Hide continue button
            document.getElementById('tutorial-continue-btn').style.display = 'none';

            // Reset payment footer z-index if it was changed
            document.querySelector('.payment-footer').style.zIndex = '';

            // Move to next step
            tutorialCurrentStep++;

            // Save progress
            saveTutorialProgress();

            // Show next step
            showTutorialStep(tutorialCurrentStep);
        }

        function completeTutorial() {
            // Clean up tutorial elements
            document.getElementById('tutorial-overlay').style.display = 'none';
            document.getElementById('tutorial-cutout').style.display = 'none';
            document.getElementById('tutorial-bubble').style.display = 'none';
            document.getElementById('tutorial-step-indicator').style.display = 'none';
            document.getElementById('tutorial-continue-btn').style.display = 'none';

            // Remove any highlight classes
            document.querySelectorAll('.tutorial-highlight').forEach(el => {
                el.classList.remove('tutorial-highlight');
<<<<<<< HEAD
=======
            });
            
            // Clean up observers
            tutorialObservers.forEach(observer => {
                observer.disconnect();
            });
            tutorialObservers = [];
            
            // Reset payment footer z-index
            document.querySelector('.payment-footer').style.zIndex = '';
            
            // Show completion modal
            document.getElementById('tutorial-completion-modal').style.display = 'flex';
            
            // Save that tutorial has been completed
            try {
                if (tutorialStorageAvailable) {
                    localStorage.setItem('gittertier_tutorial_seen', 'true');
                    localStorage.removeItem('gittertier_tutorial_progress');
                } else {
                    sessionStorage.setItem('gittertier_tutorial_seen', 'true');
                    sessionStorage.removeItem('gittertier_tutorial_progress');
                }
            } catch (e) {
                console.error('Failed to save tutorial completion:', e);
            }
            
            tutorialActive = false;
        }

        function closeCompletionModal() {
            document.getElementById('tutorial-completion-modal').style.display = 'none';
        }

        function restartTutorial() {
            document.getElementById('tutorial-completion-modal').style.display = 'none';
            startTutorial();
        }

        function saveTutorialProgress() {
            try {
                const progress = {
                    step: tutorialCurrentStep,
                    timestamp: Date.now()
                };
                
                if (tutorialStorageAvailable) {
                    localStorage.setItem('gittertier_tutorial_progress', JSON.stringify(progress));
                } else {
                    sessionStorage.setItem('gittertier_tutorial_progress', JSON.stringify(progress));
                }
            } catch (e) {
                console.error('Failed to save tutorial progress:', e);
            }
        }

        function loadTutorialProgress() {
            try {
                let progress = null;
                
                if (tutorialStorageAvailable) {
                    progress = localStorage.getItem('gittertier_tutorial_progress');
                } else {
                    progress = sessionStorage.getItem('gittertier_tutorial_progress');
                }
                
                if (progress) {
                    progress = JSON.parse(progress);
                    
                    // Check if progress is recent (within 30 minutes)
                    const isRecent = (Date.now() - progress.timestamp) < (30 * 60 * 1000);
                    
                    if (isRecent) {
                        return progress.step;
                    }
                }
            } catch (e) {
                console.error('Failed to load tutorial progress:', e);
            }
            
            return 0;
        }

        function simulateBarcodeScan() {
            // Simulate a barcode scan
            handleBarcode('123456789');
            
            // Add the product to our products list if not already there
            if (!products['123456789']) {
                products['123456789'] = {
                    name: 'Beispielprodukt',
                    price: 9.99,
                    barcode: '123456789'
                };
                localStorage.setItem('products', JSON.stringify(products));
            }
            
            // Show the product card
            showProduct(products['123456789']);
            
            // Hide error banner if shown
            document.getElementById('tutorial-error-banner').style.display = 'none';
            
            // Proceed to next step
            nextTutorialStep();
        }

        function showTutorialError(message) {
            const errorBanner = document.getElementById('tutorial-error-banner');
            errorBanner.textContent = message;
            errorBanner.style.display = 'block';
            
            setTimeout(() => {
                errorBanner.style.display = 'none';
            }, 5000);
        }

        // Show tutorial from help button
        function showTutorial() {
            startTutorial();
        }

        // Initialize tutorial on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set up continue button handler
            document.getElementById('tutorial-continue-btn').addEventListener('click', nextTutorialStep);
            
            // Check if we should show the tutorial
            checkTutorialStatus();
            document.getElementById('tutorial-cutout').style.display = 'none';
            document.getElementById('tutorial-bubble').style.display = 'none';
            
            // Check if we need to resume a tutorial in progress
            try {
                const tutorialInProgress = localStorage.getItem('gittertier_tutorial_progress') || 
                                          sessionStorage.getItem('gittertier_tutorial_progress');
                
                if (tutorialInProgress) {
                    const progress = JSON.parse(tutorialInProgress);
                    const isRecent = (Date.now() - progress.timestamp) < 0;
                    
                    if (isRecent) {
                        if (confirm('Möchten Sie das Tutorial fortsetzen, wo Sie aufgehört haben?')) {
                            tutorialCurrentStep = progress.step;
                            startTutorial();
                        }
                    }
                }
            } catch (e) {
                console.error('Failed to check for tutorial progress:', e);
            }
        });

            // All the original JavaScript functionality remains exactly the same
            let cart = [];
            let products = JSON.parse(localStorage.getItem('products')) || {};
            let scannerActive = false;
            let mediaStream = null;
            let currentBarcode = null;
            let scannedBarcodes = new Set();
            let qrCode = null;
            let lastBoxPosition = null;
            let currencySymbol = '€';
            let currentProduct = null;

            // Barcode Scanner Configuration
            const scannerConfig = {
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner-video'),
                    constraints: {
                        width: 1280,
                        height: 720,
                        facingMode: "environment"
                    }
                },
                decoder: {
                    readers: [
                        'ean_reader',
                        'ean_8_reader'
                    ],
                    multiple: false
                },
                locate: true,
                frequency: 10
            };

            // Scanner Initialization
            async function initScanner() {
                return new Promise((resolve, reject) => {
                    Quagga.init(scannerConfig, err => {
                        if (err) return reject(err);

                        // Add processed event for visual feedback
                        Quagga.onProcessed(onProcessed);

                        Quagga.onDetected(handleDetection);
                        Quagga.start();
                        resolve();
                    });
                });
            }

            function timeToMinutes(timeStr) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            }

            function isShopOpen() {
                const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
                const shopHours = settings.shopHours || {};

                if (!shopHours.enabled) return true;

                const now = new Date();
                const currentMinutes = now.getHours() * 60 + now.getMinutes();
                const openingMinutes = timeToMinutes(shopHours.openingTime);
                const closingMinutes = timeToMinutes(shopHours.closingTime);

                // Handle cases where closing time is after midnight
                if (closingMinutes < openingMinutes) {
                    return currentMinutes >= openingMinutes || currentMinutes < closingMinutes;
                }

                return currentMinutes >= openingMinutes && currentMinutes < closingMinutes;
            }

            function checkShopStatus() {
                const open = isShopOpen();
                const closedScreen = document.getElementById('closed-screen');
                const mainContent = document.querySelector('main');
                const maintenanceModal = document.getElementById('maintenance-modal');

                if (!open && maintenanceModal.style.display !== 'flex') {
                    closedScreen.style.display = 'flex';
                    mainContent.style.display = 'none';

                    // Show opening hours
                    const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
                    const shopHours = settings.shopHours || {};
                    if (shopHours.enabled) {
                        document.getElementById('opening-hours-display').textContent =
                        `Öffnet um ${shopHours.openingTime} Uhr`;
                    }

                    // Stop scanner if active
                    if (scannerActive) {
                        toggleScanner();
                    }
                } else {
                    closedScreen.style.display = 'none';
                    mainContent.style.display = 'block';
                }
            }

            // Visual feedback for barcode detection
            function onProcessed(result) {
                const box = document.getElementById('barcode-box');

                if (!result || !result.boxes) {
                    box.style.display = 'none';
                    lastBoxPosition = null;
                    return;
                }

                const boxes = result.boxes;
                const video = document.getElementById('scanner-video');
                const container = document.getElementById('scanner-container');

                // Skip if video hasn't loaded dimensions yet
                if (!video.videoWidth || !video.videoHeight) {
                    box.style.display = 'none';
                    return;
                }

                // Find the first valid box
                let validBox = null;
                for (let i = 0; i < Math.min(boxes.length, 1); i++) {
                    if (boxes[i] && boxes[i].length === 4) {
                        validBox = boxes[i];
                        break;
                    }
                }

                if (!validBox) {
                    box.style.display = 'none';
                    lastBoxPosition = null;
                    return;
                }

                // Calculate video aspect ratio and scaling
                const videoWidth = video.videoWidth;
                const videoHeight = video.videoHeight;
                const containerWidth = container.offsetWidth;
                const containerHeight = container.offsetHeight;

                const videoAspect = videoWidth / videoHeight;
                const containerAspect = containerWidth / containerHeight;

                let scale,
                offsetX,
                offsetY;

                // Calculate scaling and offsets based on object-fit: cover
                if (videoAspect > containerAspect) {
                    // Video is wider than container
                    scale = containerHeight / videoHeight;
                    offsetX = (containerWidth - videoWidth * scale) / 2;
                    offsetY = 0;
                } else {
                    // Video is taller than container
                    scale = containerWidth / videoWidth;
                    offsetX = 0;
                    offsetY = (containerHeight - videoHeight * scale) / 2;
                }

                // Calculate box coordinates
                let minX = Infinity,
                minY = Infinity,
                maxX = -Infinity,
                maxY = -Infinity;

                for (const point of validBox) {
                    if (point.x < minX) minX = point.x;
                    if (point.x > maxX) maxX = point.x;
                    if (point.y < minY) minY = point.y;
                    if (point.y > maxY) maxY = point.y;
                }

                const x = offsetX + minX * scale;
                const y = offsetY + minY * scale;
                const width = (maxX - minX) * scale;
                const height = (maxY - minY) * scale;

                // Update box position with smooth transition
                box.style.display = 'block';
                box.style.left = `${x}px`;
                box.style.top = `${y}px`;
                box.style.width = `${width}px`;
                box.style.height = `${height}px`;

                lastBoxPosition = {
                    x,
                    y,
                    width,
                    height
                };
            }

            function handleDetection(result) {
                const code = result.codeResult.code;
                if (!scannedBarcodes.has(code)) {
                    scannedBarcodes.add(code);
                    setTimeout(() => scannedBarcodes.delete(code), 2000);
                    handleBarcode(code);
                }
            }

            // Barcode Handling
            function handleBarcode(barcode) {
                currentBarcode = barcode;
                playSound('scan');

                if (products[barcode]) {
                    showProduct(products[barcode]);
                    showNotification(`${products[barcode].name} erkannt`);
                } else {
                    const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
                    if (settings.manualAdd === false) {
                        showNotification('Nicht erlaubt!', 'error');
                    } else {
                        showProductModal(barcode);
                    }
                }
            }

            function showProduct(product) {
                currentProduct = product;
                document.getElementById('product-name').textContent = product.name;
                document.getElementById('product-price').textContent = product.price.toFixed(2) + currencySymbol;
                document.getElementById('product-quantity').textContent = '1';
                document.getElementById('product-card').classList.add('visible');
            }

            function adjustProductQuantity(delta) {
                if (!currentProduct) return;

                const quantityElement = document.getElementById('product-quantity');
                let quantity = parseInt(quantityElement.textContent);
                quantity = Math.max(1, quantity + delta);
                quantityElement.textContent = quantity;
            }

            function addCurrentProductToCart() {
                if (!currentProduct) return;

                const quantity = parseInt(document.getElementById('product-quantity').textContent);
                const existing = cart.find(item => item.barcode === currentProduct.barcode);

                if (existing) {
                    existing.quantity += quantity;
                } else {
                    cart.push({
                        ...currentProduct,
                        quantity: quantity
                    });
                }

                updateCartDisplay();
                showNotification(`${currentProduct.name} hinzugefügt`);
            }

            function resetScanner() {
                document.getElementById('product-card').classList.remove('visible');
                currentProduct = null;
            }

            // Cart Management
            function addToCart(product) {
                const existing = cart.find(item => item.barcode === product.barcode);
                if (existing) {
                    existing.quantity++;
                } else {
                    cart.push({
                        ...product, quantity: 1
                    });
                }
                updateCartDisplay();
            }
<<<<<<< HEAD

            function updateCartDisplay() {
                const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const cartItems = document.getElementById('cart-items');
                const cartCount = document.getElementById('cart-count');
                const cartTotal = document.getElementById('cart-total-amount');
                const paymentTotal = document.getElementById('payment-total');

                cartItems.innerHTML = cart.map(item => `
                    <div class="cart-item" data-barcode="${item.barcode}">
                    <div class="cart-item-image">
                    <i class="fas fa-cube"></i>
                    </div>
                    <div class="cart-item-info">
                    <div class="cart-item-name">${item.name}</div>
                    <div class="cart-item-price">${item.price.toFixed(2)}${currencySymbol} × ${item.quantity}</div>
                    </div>
                    <div class="cart-item-quantity">
                    <button class="quantity-btn" onclick="adjustCartItemQuantity('${item.barcode}', -1)">−</button>
                    <span class="quantity-value">${item.quantity}</span>
                    <button class="quantity-btn" onclick="adjustCartItemQuantity('${item.barcode}', 1)">+</button>
                    </div>
                    <button class="cart-item-remove" onclick="removeCartItem('${item.barcode}')">
                    <i class="fas fa-trash"></i>
                    </button>
                    </div>
                    `).join('');

                cartTotal.textContent = total.toFixed(2) + currencySymbol;
                paymentTotal.textContent = total.toFixed(2) + currencySymbol;
                cartCount.textContent = `${cart.reduce((sum, item) => sum + item.quantity, 0)} Artikel`;
=======
        }
        
        function adjustCartItemQuantity(barcode, delta) {
            const item = cart.find(item => item.barcode === barcode);
            if (item) {
                item.quantity = Math.max(0, item.quantity + delta);
                if (item.quantity === 0) {
                    cart = cart.filter(i => i.barcode !== barcode);
                }
                updateCartDisplay();
            }
        }
        
        function removeCartItem(barcode) {
            cart = cart.filter(item => item.barcode !== barcode);
            updateCartDisplay();
            showNotification('Artikel entfernt');
        }

            // Product Management
            function showProductModal(barcode) {
                document.getElementById('product-barcode-input').value = barcode;
                document.getElementById('product-modal').style.display = 'flex';
            }

            function saveProduct() {
                const name = document.getElementById('product-name-input').value.trim();
                const price = parseFloat(document.getElementById('product-price-input').value);
                const barcode = document.getElementById('product-barcode-input').value;
                playSound('success');

                if (!name || isNaN(price) || !barcode) {
                    showNotification('Ungültige Eingabe', 'error');
                    return;
                }

                if (price <= 0) {
                    showNotification('Preis muss größer als 0 sein', 'error');
                    return;
                }

                products[barcode] = {
                    name,
                    price,
                    barcode
                };
                localStorage.setItem('products', JSON.stringify(products));
                showProduct(products[barcode]);
                closeModal();
                showNotification('Produkt gespeichert');
            }

            // QR Generation
            function generateQR() {
                if (cart.length === 0) {
                    showNotification('Warenkorb ist leer', 'error');
                    return;
                }

                const paymentId = 'PAY-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5);
                const paymentData = {
                    paymentId,
                    items: cart.map(item => ({
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity,
                        barcode: item.barcode
                    })),
                    total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0)
                };

                try {
                    const compressedData = LZString.compressToBase64(JSON.stringify(paymentData));
                    window.location.href = `customer?id=${encodeURIComponent(compressedData)}`;
                } catch(e) {
                    console.error('Compression error:', e);
                    showNotification('Fehler beim Generieren des QR-Codes', 'error');
                }
            }

            // Apply all settings from localStorage
            function applySettings() {
                const settings = JSON.parse(localStorage.getItem('appSettings')) || {};

                // Apply currency setting
                currencySymbol = settings.currency || '€';
                updateCartDisplay();

                // Apply auto scanner setting
                if (settings.autoScanner) {
                    // Start scanner after short delay to allow page to load
                    setTimeout(() => {
                        if (!scannerActive) {
                            toggleScanner();
                        }
                    },
                        500);
                }

                // Apply notification duration
                notificationDuration = settings.notificationDuration || 3;

                // Apply manual add setting
                const manualAddBtn = document.getElementById('manual-add');
                if (settings.manualAdd === false) {
                    if (manualAddBtn) {
                        manualAddBtn.disabled = true;
                        manualAddBtn.style.opacity = '0.5';
                    }
                } else {
                    if (manualAddBtn) {
                        manualAddBtn.disabled = false;
                        manualAddBtn.style.opacity = '1';
                    }
                }

                // Check shop status after applying settings
                checkShopStatus();
            }

            // Scanner Control
            async function toggleScanner() {
                const video = document.getElementById('scanner-video');
                const status = document.getElementById('scanner-status');
                const box = document.getElementById('barcode-box');
                const container = document.getElementById('scanner-container');
                const toggleBtn = document.getElementById('toggle-scanner');

                try {
                    if (!scannerActive) {
                        mediaStream = await navigator.mediaDevices.getUserMedia({
                            video: {
                                facingMode: "environment",
                                width: {
                                    ideal: 1280
                                },
                                height: {
                                    ideal: 720
                                }
                            }
                        });

                        video.srcObject = mediaStream;
                        await video.play();

                        status.innerHTML = '<span class="dot"></span><span>Scannt...</span>';
                        status.classList.remove('inactive');
                        scannerActive = true;
                        container.classList.add('active');
                        toggleBtn.innerHTML = '<i class="fas fa-stop"></i> Scanner stoppen';
                        await initScanner();
                    } else {
                        mediaStream.getTracks().forEach(track => track.stop());
                        video.srcObject = null;
                        status.innerHTML = '<span class="dot"></span><span>Scanner pausiert</span>';
                        status.classList.add('inactive');
                        scannerActive = false;
                        container.classList.remove('active');
                        toggleBtn.innerHTML = '<i class="fas fa-camera"></i> Scanner starten';
                        box.style.display = 'none';
                        Quagga.stop();
                    }
                } catch (error) {
                    scannerActive = false;
                    showNotification(`Kamerafehler: ${error.message}`, 'error');
                }
            }
<<<<<<< HEAD

            // UI Helpers
            function showNotification(message, type = 'success') {
                playSound(type);
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = 'notification';
                notification.classList.add(type);
                notification.style.display = 'block';

                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }

            function closeModal() {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
                document.getElementById('product-name-input').value = '';
                document.getElementById('product-price-input').value = '';
            }

            // Event Listeners
            document.getElementById('toggle-scanner').addEventListener('click', toggleScanner);
            document.getElementById('manual-add').addEventListener('click', () => {
                const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
                if (settings.manualAdd === false) {
                    showNotification('Manuelle Eingabe ist deaktiviert', 'error');
                    return;
                }
                currentBarcode = null;
                document.getElementById('product-modal').style.display = 'flex';
            });

            document.getElementById('clear-cart').addEventListener('click',
                () => {
                    cart = [];
                    updateCartDisplay();
                    showNotification('Warenkorb geleert');
                });

            // Initialize products from localStorage
            window.addEventListener('DOMContentLoaded',
                () => {
                    products = JSON.parse(localStorage.getItem('products')) || {};

                    // Apply settings
                    applySettings();
                    checkShopStatus();
                    setInterval(checkShopStatus, 60000);

                    // Initialize currency symbol
                    currencySymbol = '€';
                    window.addEventListener('focus', checkShopStatus);
                });

            window.addEventListener('storage',
                function(e) {
                    if (e.key === 'appSettings') {
                        applySettings();
                        checkShopStatus();
                    }
                });

        function playSound(type) {
            const settings = JSON.parse(localStorage.getItem('appSettings')) || {};
            if (!settings.soundEffects) return;
            
            const audio = new Audio();
            audio.volume = 0.3;
            
            switch(type) {
                case 'success':
                    audio.src = 'https://cdn.pixabay.com/download/audio/2022/03/10/audio_f96ec71310.mp3';
                    break;
                case 'error':
                    audio.src = 'https://cdn.pixabay.com/download/audio/2022/01/18/audio_b805049288.mp3';
                    break;
                case 'scan':
                    audio.src = 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAAAA';
                    break;
            }
            
            audio.play().catch(e => console.log('Sound playback error:', e));
        }
    </script>
</body>
</html>